(()=>{var e={};e.id=25,e.ids=[25],e.modules={5890:e=>{"use strict";e.exports=require("better-sqlite3")},2934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},5315:e=>{"use strict";e.exports=require("path")},1271:(e,t,a)=>{"use strict";a.r(t),a.d(t,{GlobalError:()=>l.a,__next_app__:()=>u,originalPathname:()=>m,pages:()=>c,routeModule:()=>x,tree:()=>d}),a(4426),a(9454),a(5866);var n=a(3191),s=a(8716),r=a(7922),l=a.n(r),o=a(5231),i={};for(let e in o)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(i[e]=()=>o[e]);a.d(t,i);let d=["",{children:["tools",{children:["debugger",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(a.bind(a,4426)),"/Users/paulsomers/Dev/payfriends-mvp/admin/src/app/tools/debugger/page.tsx"]}]},{}]},{}]},{layout:[()=>Promise.resolve().then(a.bind(a,9454)),"/Users/paulsomers/Dev/payfriends-mvp/admin/src/app/layout.tsx"],"not-found":[()=>Promise.resolve().then(a.t.bind(a,5866,23)),"next/dist/client/components/not-found-error"]}],c=["/Users/paulsomers/Dev/payfriends-mvp/admin/src/app/tools/debugger/page.tsx"],m="/tools/debugger/page",u={require:a,loadChunk:()=>Promise.resolve()},x=new n.AppPageRouteModule({definition:{kind:s.x.APP_PAGE,page:"/tools/debugger/page",pathname:"/tools/debugger",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:d}})},4471:(e,t,a)=>{Promise.resolve().then(a.t.bind(a,9404,23))},7371:(e,t,a)=>{"use strict";a.d(t,{default:()=>s.a});var n=a(1812),s=a.n(n)},1812:(e,t,a)=>{"use strict";let{createProxy:n}=a(8570);e.exports=n("/Users/paulsomers/Dev/payfriends-mvp/admin/node_modules/next/dist/client/link.js")},4426:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>d,dynamic:()=>i});var n=a(9510),s=a(7371),r=a(5748),l=a(8342),o=a(644);let i="force-dynamic";async function d({searchParams:e}){let t=(await e).loan_id||"",a=null,i=null,d=null,c=null,m=(0,l.gn)();if(t&&m){if(a=(0,r.hW)(t)){let e={principal:a.amount_cents,annualInterestRate:a.interest_rate||0,repaymentType:"one_time"===a.repayment_type?"one_time":"installments",numInstallments:a.installment_count||1,paymentFrequency:a.payment_frequency||"monthly",loanStartMode:a.loan_start_mode||"upon_acceptance",loanStartDate:a.money_sent_date||a.money_transfer_date||null,firstPaymentOffsetDays:a.first_payment_offset_days||30};(i=(0,l.CP)(e))&&a.planned_total_cents&&(d=(0,l.pB)({totalInterest:(a.planned_total_cents||0)-a.amount_cents,totalToRepay:a.planned_total_cents||0},i))}else c=`Loan not found: ${t}`}return(0,n.jsxs)("div",{className:"max-w-5xl",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between mb-6",children:[n.jsx("h1",{className:"text-2xl font-bold",children:"Calculation Debugger"}),n.jsx("span",{className:"text-sm text-gray-500",children:"Admin Tool - Read-only"})]}),(0,n.jsxs)("div",{className:`admin-card p-4 mb-6 ${m?"border-green-800":"border-red-800"}`,children:[(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[n.jsx("div",{className:`w-3 h-3 rounded-full ${m?"bg-green-500":"bg-red-500"}`}),(0,n.jsxs)("span",{className:"text-sm",children:["Production Engine: ",m?"Connected":"Not Available"]})]}),(0,n.jsxs)("p",{className:"text-xs text-gray-500 mt-2",children:["Using: ",n.jsx("code",{className:"bg-gray-800 px-1 rounded",children:"admin/src/lib/calculations/repaymentSchedule.ts"})]})]}),n.jsx("div",{className:"admin-card p-4 mb-6",children:(0,n.jsxs)("form",{method:"get",className:"flex gap-4",children:[(0,n.jsxs)("div",{className:"flex-1",children:[n.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:"Loan ID"}),n.jsx("input",{type:"text",name:"loan_id",placeholder:"Enter loan_id to debug...",defaultValue:t,className:"admin-input"})]}),n.jsx("div",{className:"flex items-end",children:n.jsx("button",{type:"submit",className:"admin-btn admin-btn-primary",disabled:!m,children:"Run Debugger"})})]})}),c&&n.jsx("div",{className:"admin-card p-4 mb-6 border-red-800 bg-red-900/20",children:n.jsx("p",{className:"text-red-400",children:c})}),a&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{className:"admin-card p-4 mb-6",children:[n.jsx("h2",{className:"text-sm font-semibold text-gray-400 uppercase mb-3",children:"Loan Overview"}),(0,n.jsxs)("dl",{className:"grid grid-cols-4 gap-4 text-sm",children:[(0,n.jsxs)("div",{children:[n.jsx("dt",{className:"text-gray-500",children:"Loan ID"}),n.jsx("dd",{className:"font-mono",children:a.id})]}),(0,n.jsxs)("div",{children:[n.jsx("dt",{className:"text-gray-500",children:"Principal"}),n.jsx("dd",{className:"font-mono",children:(0,o.xG)(a.amount_cents)})]}),(0,n.jsxs)("div",{children:[n.jsx("dt",{className:"text-gray-500",children:"Interest Rate"}),(0,n.jsxs)("dd",{children:[a.interest_rate||0,"%"]})]}),(0,n.jsxs)("div",{children:[n.jsx("dt",{className:"text-gray-500",children:"Calc Version"}),n.jsx("dd",{className:"font-mono text-xs",children:a.calc_version||"—"})]})]})]}),d&&(0,n.jsxs)("div",{className:`admin-card p-4 mb-6 ${d.matches?"border-green-800":"border-yellow-800"}`,children:[n.jsx("h2",{className:"text-sm font-semibold text-gray-400 uppercase mb-3",children:"Verification Result"}),(0,n.jsxs)("div",{className:"flex items-center gap-2 mb-4",children:[n.jsx("div",{className:`w-4 h-4 rounded-full ${d.matches?"bg-green-500":"bg-yellow-500"}`}),n.jsx("span",{className:d.matches?"text-green-400":"text-yellow-400",children:d.matches?"Calculations Match":"Calculations Differ"})]}),!d.matches&&(0,n.jsxs)("div",{className:"text-sm text-gray-400",children:[(0,n.jsxs)("p",{children:["Interest difference: ",d.interestDiff," cents"]}),(0,n.jsxs)("p",{children:["Total difference: ",d.totalDiff," cents"]})]})]}),(0,n.jsxs)("div",{className:"grid grid-cols-2 gap-6 mb-6",children:[(0,n.jsxs)("div",{className:"admin-card p-4",children:[n.jsx("h2",{className:"text-sm font-semibold text-gray-400 uppercase mb-3",children:"Stored Outputs"}),(0,n.jsxs)("dl",{className:"space-y-2 text-sm",children:[(0,n.jsxs)("div",{children:[n.jsx("dt",{className:"text-gray-500",children:"Planned Total"}),n.jsx("dd",{className:"font-mono text-lg",children:(0,o.xG)(a.planned_total_cents||0)})]}),(0,n.jsxs)("div",{children:[n.jsx("dt",{className:"text-gray-500",children:"Stored Interest"}),n.jsx("dd",{className:"font-mono",children:(0,o.xG)((a.planned_total_cents||0)-a.amount_cents)})]})]})]}),(0,n.jsxs)("div",{className:"admin-card p-4",children:[n.jsx("h2",{className:"text-sm font-semibold text-gray-400 uppercase mb-3",children:"Recomputed Outputs"}),i?(0,n.jsxs)("dl",{className:"space-y-2 text-sm",children:[(0,n.jsxs)("div",{children:[n.jsx("dt",{className:"text-gray-500",children:"Total to Repay"}),n.jsx("dd",{className:"font-mono text-lg",children:(0,o.xG)(i.totalToRepay)})]}),(0,n.jsxs)("div",{children:[n.jsx("dt",{className:"text-gray-500",children:"Total Interest"}),n.jsx("dd",{className:"font-mono",children:(0,o.xG)(i.totalInterest)})]})]}):n.jsx("p",{className:"text-sm text-gray-500",children:"Calculation failed or not available."})]})]}),(0,n.jsxs)("div",{className:"admin-card p-4 mb-6",children:[n.jsx("h2",{className:"text-sm font-semibold text-gray-400 uppercase mb-3",children:"Stored Inputs"}),n.jsx("div",{className:"bg-gray-900 rounded p-3 font-mono text-xs overflow-x-auto",children:n.jsx("pre",{className:"text-green-400",children:JSON.stringify({principal_cents:a.amount_cents,interest_rate:a.interest_rate,repayment_type:a.repayment_type,installment_count:a.installment_count,payment_frequency:a.payment_frequency,loan_start_mode:a.loan_start_mode,money_sent_date:a.money_sent_date,first_payment_offset_days:a.first_payment_offset_days,calc_version:a.calc_version},null,2)})})]}),i&&i.rows&&i.rows.length>0&&(0,n.jsxs)("div",{className:"admin-card p-4 mb-6",children:[n.jsx("h2",{className:"text-sm font-semibold text-gray-400 uppercase mb-3",children:"Recomputed Schedule"}),(0,n.jsxs)("table",{className:"admin-table",children:[n.jsx("thead",{children:(0,n.jsxs)("tr",{children:[n.jsx("th",{children:"#"}),n.jsx("th",{children:"Due Date"}),n.jsx("th",{children:"Principal"}),n.jsx("th",{children:"Interest"}),n.jsx("th",{children:"Total"}),n.jsx("th",{children:"Balance"})]})}),n.jsx("tbody",{children:i.rows.map(e=>(0,n.jsxs)("tr",{children:[n.jsx("td",{children:e.index}),n.jsx("td",{children:e.dateLabel||(0,o.p6)(e.date)}),n.jsx("td",{className:"font-mono",children:(0,o.xG)(e.principal)}),n.jsx("td",{className:"font-mono",children:(0,o.xG)(e.interest)}),n.jsx("td",{className:"font-mono",children:(0,o.xG)(e.totalPayment)}),n.jsx("td",{className:"font-mono",children:(0,o.xG)(e.remainingBalance)})]},e.index))})]})]}),(0,n.jsxs)("div",{className:"admin-card p-4",children:[n.jsx("h2",{className:"text-sm font-semibold text-gray-400 uppercase mb-3",children:"Export"}),(0,n.jsxs)("div",{className:"flex gap-4",children:[n.jsx("a",{href:`/api/debugger/export?loan_id=${a.id}`,className:"admin-btn admin-btn-secondary",download:`debug-${a.id}.json`,children:"Download JSON"}),n.jsx(s.default,{href:`/loans/${a.id}`,className:"admin-btn admin-btn-secondary",children:"View Loan Detail"})]})]})]}),!a&&!c&&!t&&(0,n.jsxs)("div",{className:"admin-card p-8 text-center",children:[n.jsx("p",{className:"text-gray-400 mb-4",children:"Enter a loan ID above to debug its calculations."}),n.jsx("p",{className:"text-xs text-gray-500",children:"The debugger will recompute the loan schedule using the production calculation engine and compare it with the stored values in the database."})]})]})}},8342:(e,t,a)=>{"use strict";function n(e,t){let a=new Date(e),n=a.getMonth()+t,s=a.getFullYear()+Math.floor(n/12),r=(n%12+12)%12,l=a.getDate();a.setFullYear(s,r,1);let o=new Date(s,r+1,0).getDate();return a.setDate(Math.min(l,o)),a}function s(e,t){let a=new Date(e);switch(a.setHours(0,0,0,0),t){case"weekly":return new Date(a.getTime()+6048e5);case"biweekly":return new Date(a.getTime()+12096e5);case"every_4_weeks":return new Date(a.getTime()+24192e5);case"monthly":case"every-month":return n(a,1);case"quarterly":return n(a,3);case"yearly":return n(a,12);default:return console.warn(`Unknown frequency "${t}", defaulting to monthly`),n(a,1)}}function r(e){try{let t={principal:e.principal,annualInterestRate:e.annualInterestRate,repaymentType:e.repaymentType,numInstallments:e.numInstallments,paymentFrequency:e.paymentFrequency,loanStartMode:e.loanStartMode,loanStartDate:e.loanStartDate?new Date(e.loanStartDate):null,firstPaymentOffsetDays:e.firstPaymentOffsetDays,context:{preview:!e.loanStartDate,agreementStatus:"active",hasRealStartDate:!!e.loanStartDate}},a=function(e){let{repaymentType:t,numInstallments:a=1,loanStartMode:n,loanStartDate:r,context:l}=e,o="one_time"===t?1:a;if(!(l.hasRealStartDate&&r)&&"upon_acceptance"===n)return function(e,t){let a;let{principal:n,annualInterestRate:s,paymentFrequency:r,firstPaymentOffsetDays:l}=e,o=[],i=n,d=n/t;switch(r){case"every-3-days":a=3;break;case"every-week":case"weekly":a=7;break;case"every-month":case"monthly":default:a=30;break;case"every-year":case"yearly":a=365;break;case"once":a=l;break;case"biweekly":a=14;break;case"every_4_weeks":a=28;break;case"quarterly":a=91}let c=s/100/365,m=0;for(let e=1;e<=t;e++){let t=Math.round(i*c*(1===e?l:a)),n=Math.round(d)+t;(i-=d)<1&&(i=0),m+=t,o.push({index:e,date:null,dateLabel:function(e,t,a){let n=1===e;if("every-month"===t)return 1===e?"1 month after loan start":`${e} months after loan start`;if("every-year"===t)return 1===e?"1 year after loan start":`${e} years after loan start`;if("every-week"===t){let t=n?a:a+(e-1)*7;return 0===t?"On loan start":`${t} days after loan start`}if("every-3-days"===t){let t=n?a:a+(e-1)*3;return 0===t?"On loan start":`${t} days after loan start`}if("once"===t)return 0===a?"On loan start":`${a} days after loan start`;if("monthly"===t){let t=Math.round(a/30),s=n?t:t+(e-1);return 0===s?"On loan start":1===s?"1 month after loan start":`${s} months after loan start`}if("weekly"===t){let t=Math.round(a/7),s=n?t:t+(e-1);return 0===s?"On loan start":1===s?"1 week after loan start":`${s} weeks after loan start`}if("biweekly"===t){let t=Math.round(a/14),s=2*(n?t:t+(e-1));return 0===s?"On loan start":2===s?"2 weeks after loan start":`${s} weeks after loan start`}if("every_4_weeks"===t){let t=Math.round(a/28),s=4*(n?t:t+(e-1));return 0===s?"On loan start":4===s?"4 weeks after loan start":`${s} weeks after loan start`}if("quarterly"===t){let t=Math.round(a/90),s=3*(n?t:t+(e-1));return 0===s?"On loan start":3===s?"3 months after loan start":`${s} months after loan start`}if("yearly"===t){let t=Math.round(a/365),s=n?t:t+(e-1);return 0===s?"On loan start":1===s?"1 year after loan start":`${s} years after loan start`}if("custom_days"===t){let t=e*a;return 0===t?"On loan start":1===t?"1 day after loan start":`${t} days after loan start`}return n&&0===a?"On loan start":`Payment ${e}`}(e,r,l),principal:Math.round(d),interest:t,totalPayment:n,remainingBalance:Math.round(i)})}return{rows:o,totalInterest:Math.round(m),totalToRepay:Math.round(n+m)}}(e,o);if(!r)throw Error("loanStartDate is required when hasRealStartDate is true");return function(e,t,a){let{principal:n,annualInterestRate:r,paymentFrequency:l,firstPaymentOffsetDays:o}=e,i=new Date(a);i.setHours(0,0,0,0);let d=new Date(i);d.setDate(d.getDate()+o);let{paymentDates:c,normalizedFirstDueDate:m}=function(e){let{transferDate:t,firstDueDate:a,frequency:n,count:r}=e,l=function(e,t,a){let n=new Date(e),r=new Date(t);return(n.setHours(0,0,0,0),r.setHours(0,0,0,0),r<=n)?s(n,a):r}(t,a,n),o=[],i=new Date(l);for(let e=0;e<r;e++)o.push(new Date(i)),e<r-1&&(i=s(i,n));return{paymentDates:o,normalizedFirstDueDate:l}}({transferDate:i,firstDueDate:d,frequency:l,count:t}),u=function(e){let{principalCents:t,aprPercent:a,count:n,paymentDates:s,startDate:r}=e,l=t/100,o=a/100/365,i=l/n,d=0,c=[],m=new Date(r);m.setHours(0,0,0,0);for(let e=1;e<=n;e++){let t=l-i*(e-1),a=s[e-1],n=new Date(a);n.setHours(0,0,0,0);let r=t*o*Math.round((n.getTime()-m.getTime())/864e5),u=i+r,x=t-i;d+=r,c.push({dateISO:n.toISOString(),paymentCents:Math.round(100*u),principalCents:Math.round(100*i),interestCents:Math.round(100*r),remainingCents:x>.01?Math.round(100*x):0}),m=n}let u=Math.round(100*d);return{rows:c,totalInterestCents:u,totalToRepayCents:t+u}}({principalCents:n,aprPercent:r,count:t,paymentDates:c,startDate:i});return{rows:u.rows.map((e,t)=>({index:t+1,date:new Date(e.dateISO),dateLabel:function(e){if(!e)return"—";let t="string"==typeof e?new Date(e):e,a=t.getDate(),n=t.toLocaleDateString("en-GB",{month:"short"}),s=t.getFullYear();return`${a} ${n} ${s}`}(e.dateISO),principal:e.principalCents,interest:e.interestCents,totalPayment:e.paymentCents,remainingBalance:e.remainingCents})),totalInterest:u.totalInterestCents,totalToRepay:u.totalToRepayCents}}(e,o,r)}(t);return{rows:a.rows,totalInterest:a.totalInterest,totalToRepay:a.totalToRepay}}catch(e){return console.error("[Calculator] Calculation error:",e),null}}function l(e,t){let a=Math.abs(e.totalInterest-t.totalInterest),n=Math.abs(e.totalToRepay-t.totalToRepay);return{matches:a<=1&&n<=1,interestDiff:a,totalDiff:n}}function o(){return!0}a.d(t,{pB:()=>l,gn:()=>o,CP:()=>r})}};var t=require("../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),n=t.X(0,[276,898,86,485],()=>a(1271));module.exports=n})();