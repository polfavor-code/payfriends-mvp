(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[777],{2046:function(e,t,a){Promise.resolve().then(a.bind(a,3080))},3080:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return m}});var n=a(7437),s=a(2265);function r(e,t){let a=new Date(e),n=a.getMonth()+t,s=a.getFullYear()+Math.floor(n/12),r=(n%12+12)%12,l=a.getDate();a.setFullYear(s,r,1);let c=new Date(s,r+1,0).getDate();return a.setDate(Math.min(l,c)),a}function l(e,t){let a=new Date(e);switch(a.setHours(0,0,0,0),t){case"weekly":return new Date(a.getTime()+6048e5);case"biweekly":return new Date(a.getTime()+12096e5);case"every_4_weeks":return new Date(a.getTime()+24192e5);case"monthly":case"every-month":return r(a,1);case"quarterly":return r(a,3);case"yearly":return r(a,12);default:return console.warn('Unknown frequency "'.concat(t,'", defaulting to monthly')),r(a,1)}}let c={principal:1e5,annualInterestRate:5,repaymentType:"installments",numInstallments:12,paymentFrequency:"monthly",loanStartMode:"fixed_date",loanStartDate:new Date().toISOString().split("T")[0],firstPaymentOffsetDays:30},o=[{value:"weekly",label:"Weekly"},{value:"biweekly",label:"Every 2 Weeks"},{value:"every_4_weeks",label:"Every 4 Weeks"},{value:"monthly",label:"Monthly"},{value:"quarterly",label:"Quarterly"},{value:"yearly",label:"Yearly"}];function i(e){return new Intl.NumberFormat("en-EU",{style:"currency",currency:"EUR"}).format(e/100)}function d(e){return e?e.toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"}):"—"}function m(){let[e,t]=(0,s.useState)(c),[a,r]=(0,s.useState)(null),[m,u]=(0,s.useState)(null),[x,y]=(0,s.useState)(!1),[h,p]=(0,s.useState)(!1),f=(0,s.useCallback)(()=>{u(null);try{let t="fixed_date"===e.loanStartMode&&e.loanStartDate,a={principal:e.principal,annualInterestRate:e.annualInterestRate,repaymentType:e.repaymentType,numInstallments:e.numInstallments,paymentFrequency:e.paymentFrequency,loanStartMode:e.loanStartMode,loanStartDate:t?e.loanStartDate:null,firstPaymentOffsetDays:e.firstPaymentOffsetDays,context:{preview:!t,agreementStatus:"active",hasRealStartDate:!!t}};y(!t);let n=function(e){let{repaymentType:t,numInstallments:a=1,loanStartMode:n,loanStartDate:s,context:r}=e,c="one_time"===t?1:a;if(!(r.hasRealStartDate&&s)&&"upon_acceptance"===n)return function(e,t){let a;let{principal:n,annualInterestRate:s,paymentFrequency:r,firstPaymentOffsetDays:l}=e,c=[],o=n,i=n/t;switch(r){case"every-3-days":a=3;break;case"every-week":case"weekly":a=7;break;case"every-month":case"monthly":default:a=30;break;case"every-year":case"yearly":a=365;break;case"once":a=l;break;case"biweekly":a=14;break;case"every_4_weeks":a=28;break;case"quarterly":a=91}let d=s/100/365,m=0;for(let e=1;e<=t;e++){let t=Math.round(o*d*(1===e?l:a)),n=Math.round(i)+t;(o-=i)<1&&(o=0),m+=t,c.push({index:e,date:null,dateLabel:function(e,t,a){let n=1===e;if("every-month"===t)return 1===e?"1 month after loan start":"".concat(e," months after loan start");if("every-year"===t)return 1===e?"1 year after loan start":"".concat(e," years after loan start");if("every-week"===t){let t=n?a:a+(e-1)*7;return 0===t?"On loan start":"".concat(t," days after loan start")}if("every-3-days"===t){let t=n?a:a+(e-1)*3;return 0===t?"On loan start":"".concat(t," days after loan start")}if("once"===t)return 0===a?"On loan start":"".concat(a," days after loan start");if("monthly"===t){let t=Math.round(a/30),s=n?t:t+(e-1);return 0===s?"On loan start":1===s?"1 month after loan start":"".concat(s," months after loan start")}if("weekly"===t){let t=Math.round(a/7),s=n?t:t+(e-1);return 0===s?"On loan start":1===s?"1 week after loan start":"".concat(s," weeks after loan start")}if("biweekly"===t){let t=Math.round(a/14),s=2*(n?t:t+(e-1));return 0===s?"On loan start":2===s?"2 weeks after loan start":"".concat(s," weeks after loan start")}if("every_4_weeks"===t){let t=Math.round(a/28),s=4*(n?t:t+(e-1));return 0===s?"On loan start":4===s?"4 weeks after loan start":"".concat(s," weeks after loan start")}if("quarterly"===t){let t=Math.round(a/90),s=3*(n?t:t+(e-1));return 0===s?"On loan start":3===s?"3 months after loan start":"".concat(s," months after loan start")}if("yearly"===t){let t=Math.round(a/365),s=n?t:t+(e-1);return 0===s?"On loan start":1===s?"1 year after loan start":"".concat(s," years after loan start")}if("custom_days"===t){let t=e*a;return 0===t?"On loan start":1===t?"1 day after loan start":"".concat(t," days after loan start")}return n&&0===a?"On loan start":"Payment ".concat(e)}(e,r,l),principal:Math.round(i),interest:t,totalPayment:n,remainingBalance:Math.round(o)})}return{rows:c,totalInterest:Math.round(m),totalToRepay:Math.round(n+m)}}(e,c);if(!s)throw Error("loanStartDate is required when hasRealStartDate is true");return function(e,t,a){let{principal:n,annualInterestRate:s,paymentFrequency:r,firstPaymentOffsetDays:c}=e,o=new Date(a);o.setHours(0,0,0,0);let i=new Date(o);i.setDate(i.getDate()+c);let{paymentDates:d,normalizedFirstDueDate:m}=function(e){let{transferDate:t,firstDueDate:a,frequency:n,count:s}=e,r=function(e,t,a){let n=new Date(e),s=new Date(t);return(n.setHours(0,0,0,0),s.setHours(0,0,0,0),s<=n)?l(n,a):s}(t,a,n),c=[],o=new Date(r);for(let e=0;e<s;e++)c.push(new Date(o)),e<s-1&&(o=l(o,n));return{paymentDates:c,normalizedFirstDueDate:r}}({transferDate:o,firstDueDate:i,frequency:r,count:t}),u=function(e){let{principalCents:t,aprPercent:a,count:n,paymentDates:s,startDate:r}=e,l=t/100,c=a/100/365,o=l/n,i=0,d=[],m=new Date(r);m.setHours(0,0,0,0);for(let e=1;e<=n;e++){let t=l-o*(e-1),a=s[e-1],n=new Date(a);n.setHours(0,0,0,0);let r=t*c*Math.round((n.getTime()-m.getTime())/864e5),u=o+r,x=t-o;i+=r,d.push({dateISO:n.toISOString(),paymentCents:Math.round(100*u),principalCents:Math.round(100*o),interestCents:Math.round(100*r),remainingCents:x>.01?Math.round(100*x):0}),m=n}let u=Math.round(100*i);return{rows:d,totalInterestCents:u,totalToRepayCents:t+u}}({principalCents:n,aprPercent:s,count:t,paymentDates:d,startDate:o});return{rows:u.rows.map((e,t)=>({index:t+1,date:new Date(e.dateISO),dateLabel:function(e){if(!e)return"—";let t="string"==typeof e?new Date(e):e,a=t.getDate(),n=t.toLocaleDateString("en-GB",{month:"short"}),s=t.getFullYear();return"".concat(a," ").concat(n," ").concat(s)}(e.dateISO),principal:e.principalCents,interest:e.interestCents,totalPayment:e.paymentCents,remainingBalance:e.remainingCents})),totalInterest:u.totalInterestCents,totalToRepay:u.totalToRepayCents}}(e,c,s)}(a);r(n)}catch(e){u(e.message||"Calculation failed"),r(null)}},[e]);(0,s.useEffect)(()=>{f()},[f]);let g=(e,a)=>{t(t=>({...t,[e]:a}))};return(0,n.jsxs)("div",{className:"max-w-6xl",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between mb-6",children:[(0,n.jsx)("h1",{className:"text-2xl font-bold",children:"Repayment Calculator"}),(0,n.jsxs)("div",{className:"flex items-center gap-3",children:[x&&(0,n.jsx)("span",{className:"text-xs bg-yellow-600 text-white px-2 py-1 rounded",children:"Preview Mode"}),(0,n.jsx)("span",{className:"text-sm text-gray-500",children:"Source of Truth Calculator"})]})]}),(0,n.jsxs)("div",{className:"admin-card p-4 mb-6 border-green-800",children:[(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)("div",{className:"w-3 h-3 rounded-full bg-green-500"}),(0,n.jsx)("span",{className:"text-sm",children:"Calculation Engine: Active"})]}),(0,n.jsxs)("p",{className:"text-xs text-gray-500 mt-2",children:["Using: ",(0,n.jsx)("code",{className:"bg-gray-800 px-1 rounded",children:"admin/src/lib/calculations/repaymentSchedule.ts"})]})]}),(0,n.jsxs)("div",{className:"grid grid-cols-12 gap-6",children:[(0,n.jsx)("div",{className:"col-span-4",children:(0,n.jsxs)("div",{className:"admin-card p-4 space-y-4",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,n.jsx)("h2",{className:"text-sm font-semibold text-gray-400 uppercase",children:"Configuration"}),(0,n.jsx)("button",{onClick:()=>{t(c)},className:"text-xs text-gray-400 hover:text-white",children:"Reset"})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("label",{className:"block text-xs text-gray-400 mb-1",children:"Loan Amount (EUR)"}),(0,n.jsx)("input",{type:"number",value:e.principal/100,onChange:e=>g("principal",Math.round(100*parseFloat(e.target.value||"0"))),className:"admin-input",step:"0.01",min:"0"})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("label",{className:"block text-xs text-gray-400 mb-1",children:"Annual Interest Rate (%)"}),(0,n.jsx)("input",{type:"number",value:e.annualInterestRate,onChange:e=>g("annualInterestRate",parseFloat(e.target.value||"0")),className:"admin-input",step:"0.1",min:"0",max:"100"})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("label",{className:"block text-xs text-gray-400 mb-1",children:"Repayment Type"}),(0,n.jsxs)("select",{value:e.repaymentType,onChange:e=>g("repaymentType",e.target.value),className:"admin-input",children:[(0,n.jsx)("option",{value:"one_time",children:"One-Time Payment"}),(0,n.jsx)("option",{value:"installments",children:"Installments"})]})]}),"installments"===e.repaymentType&&(0,n.jsxs)("div",{children:[(0,n.jsx)("label",{className:"block text-xs text-gray-400 mb-1",children:"Number of Installments"}),(0,n.jsx)("input",{type:"number",value:e.numInstallments,onChange:e=>g("numInstallments",parseInt(e.target.value||"1",10)),className:"admin-input",min:"1",max:"120"})]}),"installments"===e.repaymentType&&(0,n.jsxs)("div",{children:[(0,n.jsx)("label",{className:"block text-xs text-gray-400 mb-1",children:"Payment Frequency"}),(0,n.jsx)("select",{value:e.paymentFrequency,onChange:e=>g("paymentFrequency",e.target.value),className:"admin-input",children:o.map(e=>(0,n.jsx)("option",{value:e.value,children:e.label},e.value))})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("label",{className:"block text-xs text-gray-400 mb-1",children:"Loan Start Mode"}),(0,n.jsxs)("select",{value:e.loanStartMode,onChange:e=>g("loanStartMode",e.target.value),className:"admin-input",children:[(0,n.jsx)("option",{value:"fixed_date",children:"Fixed Date"}),(0,n.jsx)("option",{value:"upon_acceptance",children:"Upon Acceptance (Preview)"})]})]}),"fixed_date"===e.loanStartMode&&(0,n.jsxs)("div",{children:[(0,n.jsx)("label",{className:"block text-xs text-gray-400 mb-1",children:"Loan Start Date"}),(0,n.jsx)("input",{type:"date",value:e.loanStartDate,onChange:e=>g("loanStartDate",e.target.value),className:"admin-input"})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("label",{className:"block text-xs text-gray-400 mb-1",children:"First Payment Offset (Days)"}),(0,n.jsx)("input",{type:"number",value:e.firstPaymentOffsetDays,onChange:e=>g("firstPaymentOffsetDays",parseInt(e.target.value||"0",10)),className:"admin-input",min:"0"})]}),(0,n.jsx)("div",{className:"pt-4 border-t border-gray-700",children:(0,n.jsxs)("label",{className:"flex items-center gap-2 cursor-pointer",children:[(0,n.jsx)("input",{type:"checkbox",checked:h,onChange:e=>p(e.target.checked),className:"rounded bg-gray-800 border-gray-600"}),(0,n.jsx)("span",{className:"text-xs text-gray-400",children:"Show Debug Output"})]})})]})}),(0,n.jsxs)("div",{className:"col-span-8 space-y-6",children:[m&&(0,n.jsx)("div",{className:"admin-card p-4 border-red-800 bg-red-900/20",children:(0,n.jsx)("p",{className:"text-red-400",children:m})}),a&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{className:"admin-card p-4",children:[(0,n.jsx)("h2",{className:"text-sm font-semibold text-gray-400 uppercase mb-4",children:"Summary"}),(0,n.jsxs)("div",{className:"grid grid-cols-3 gap-6",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("dt",{className:"text-gray-500 text-sm",children:"Principal"}),(0,n.jsx)("dd",{className:"text-2xl font-mono",children:i(e.principal)})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("dt",{className:"text-gray-500 text-sm",children:"Total Interest"}),(0,n.jsx)("dd",{className:"text-2xl font-mono text-yellow-400",children:i(a.totalInterest)})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("dt",{className:"text-gray-500 text-sm",children:"Total to Repay"}),(0,n.jsx)("dd",{className:"text-2xl font-mono text-green-400",children:i(a.totalToRepay)})]})]})]}),(0,n.jsxs)("div",{className:"admin-card p-4",children:[(0,n.jsxs)("h2",{className:"text-sm font-semibold text-gray-400 uppercase mb-4",children:["Repayment Schedule",a.rows.length>0&&(0,n.jsxs)("span",{className:"ml-2 text-gray-600",children:["(",a.rows.length," payments)"]})]}),(0,n.jsx)("div",{className:"max-h-96 overflow-y-auto",children:(0,n.jsxs)("table",{className:"admin-table",children:[(0,n.jsx)("thead",{className:"sticky top-0 bg-gray-900",children:(0,n.jsxs)("tr",{children:[(0,n.jsx)("th",{children:"#"}),(0,n.jsx)("th",{children:"Due Date"}),(0,n.jsx)("th",{children:"Principal"}),(0,n.jsx)("th",{children:"Interest"}),(0,n.jsx)("th",{children:"Payment"}),(0,n.jsx)("th",{children:"Balance"})]})}),(0,n.jsx)("tbody",{children:a.rows.map(e=>(0,n.jsxs)("tr",{children:[(0,n.jsx)("td",{children:e.index}),(0,n.jsx)("td",{children:e.dateLabel||d(e.date)}),(0,n.jsx)("td",{className:"font-mono",children:i(e.principal)}),(0,n.jsx)("td",{className:"font-mono text-yellow-400",children:i(e.interest)}),(0,n.jsx)("td",{className:"font-mono font-medium",children:i(e.totalPayment)}),(0,n.jsx)("td",{className:"font-mono text-gray-400",children:i(e.remainingBalance)})]},e.index))})]})})]}),a.rows.length>0&&"fixed_date"===e.loanStartMode&&a.rows[a.rows.length-1].date&&(0,n.jsxs)("div",{className:"admin-card p-4",children:[(0,n.jsx)("h2",{className:"text-sm font-semibold text-gray-400 uppercase mb-2",children:"Loan Duration"}),(0,n.jsxs)("p",{className:"text-sm text-gray-300",children:["From ",(0,n.jsx)("span",{className:"font-mono",children:e.loanStartDate})," to"," ",(0,n.jsx)("span",{className:"font-mono",children:d(a.rows[a.rows.length-1].date)})]})]}),h&&(0,n.jsxs)("div",{className:"admin-card p-4",children:[(0,n.jsx)("h2",{className:"text-sm font-semibold text-gray-400 uppercase mb-3",children:"Debug Output"}),(0,n.jsx)("div",{className:"bg-gray-900 rounded p-3 font-mono text-xs overflow-x-auto",children:(0,n.jsx)("pre",{className:"text-green-400",children:JSON.stringify({config:{principal:e.principal,annualInterestRate:e.annualInterestRate,repaymentType:e.repaymentType,numInstallments:e.numInstallments,paymentFrequency:e.paymentFrequency,loanStartMode:e.loanStartMode,loanStartDate:e.loanStartDate,firstPaymentOffsetDays:e.firstPaymentOffsetDays},result:{totalInterest:a.totalInterest,totalToRepay:a.totalToRepay,rowCount:a.rows.length},isPreview:x},null,2)})})]})]})]})]})]})}}},function(e){e.O(0,[971,117,744],function(){return e(e.s=2046)}),_N_E=e.O()}]);