<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <title>PayFriends ‚Äî Create GroupTab</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  
  <!-- Shared control styles -->
  <link rel="stylesheet" href="/css/shared-controls.css" />
  <link rel="stylesheet" href="/css/app.css" />
  
  <!-- Chat Theme -->
  <link rel="stylesheet" href="/css/chat-theme.css" />

  <script src="/js/header.js"></script>
  <script src="/js/footer.js"></script>
  <script src="/js/formatters.js"></script>
  
  <style>
    /* Standard page layout - matches dashboard, friends, agreements */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 16px;
    }
    
    /* Wizard uses narrower content area but same header width */
    .chat-container {
      max-width: 1000px;
      margin: 0 auto;
    }

    /* Extra styles specific to the Wizard */
    .chat-input {
      font-size: 18px;
    }
    
    /* Typing indicator animation */
    .typing-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 12px 16px;
      background: var(--message-bot-bg);
      border-radius: 18px;
      border-bottom-left-radius: 4px;
      margin-bottom: 8px;
      align-self: flex-start;
    }
    
    .typing-dot {
      width: 6px;
      height: 6px;
      background: var(--muted);
      border-radius: 50%;
      animation: typing 1.4s infinite ease-in-out both;
    }
    
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes typing {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
    
    /* Hide input bar when card is active */
    .input-container.hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header will be loaded dynamically by header.js -->
  
  <div class="chat-container">
    
    <div class="chat-header">
      <div class="chat-title-row">
        <div class="chat-avatar assistant-icon">
          <!-- Playful Sparkle Icon -->
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2L14.5 9.5L22 12L14.5 14.5L12 22L9.5 14.5L2 12L9.5 9.5L12 2Z" fill="white"/>
          </svg>
        </div>
        <div class="chat-title-text">
          <div class="chat-title-main">GroupTab Wizard</div>
          <div class="chat-title-sub">Let's get this sorted! üöÄ</div>
        </div>
      </div>
      <!-- Controls Group -->
      <div style="display: flex; align-items: center; gap: 8px;">
        <!-- Undo Button (Moved here) -->
        <button id="undo-btn" class="undo-btn-header" title="Go back one step" disabled>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 14L4 9l5-5"/>
            <path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/>
          </svg>
        </button>
        
        <!-- Close Button -->
        <a href="/grouptabs" class="close-icon-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </a>
      </div>
    </div>

    <div id="chat-scroll-area" class="chat-scroll-area">
      <!-- Chat history injected here -->
    </div>

    <div id="input-container" class="input-container">
      <div id="quick-replies" class="quick-replies">
        <!-- Quick replies / suggestions injected here -->
      </div>
      
      <div class="input-bar">
        <input type="text" id="chat-input" class="chat-input" placeholder="Type a message..." autocomplete="off">
        <button id="send-btn" class="send-btn" disabled>‚û§</button>
      </div>
    </div>

  </div>

  <script>
    // ===========================================
    // STATE MACHINE (6-Step Hybrid Wizard)
    // ===========================================
    // Steps: INTENT -> NAME -> AMOUNT -> PEOPLE -> SPLIT -> CREATING
    
    const state = {
      step: 'INTENT',
      data: {
        template: '',      // 'restaurant', 'trip', 'gift'
        type: '',          // 'one_bill' or 'multi_bill'
        name: '',          // Tab name (e.g., "Dinner at Vapiano")
        restaurantName: '',// Raw restaurant name
        totalCents: 0,     // Bill total in cents
        tipCents: 0,       // Tip amount in cents
        people: 4,         // Number of people
        splitMode: 'equal', // 'equal', 'tiered', 'open'
        receiptFile: null  // Optional receipt image file
      }
    };

    // DOM References
    const chatHistory = document.getElementById('chat-scroll-area');
    const inputContainer = document.getElementById('input-container');
    const inputField = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const undoBtn = document.getElementById('undo-btn'); // New Undo Button
    const quickReplies = document.getElementById('quick-replies');

    // History State
    let historyStack = [];
    let historyIndex = 0;

    // History Helper: Save current state before moving forward
    function pushHistory() {
      historyStack.push({
        state: JSON.parse(JSON.stringify(state)),
        index: historyIndex
      });
      historyIndex++;
      updateUndoButton();
    }

    // History Helper: Update button visibility
    function updateUndoButton() {
      undoBtn.disabled = historyStack.length === 0;
    }

    // Undo Logic
    function undoStep() {
      if (historyStack.length === 0) return;

      const lastState = historyStack.pop();
      
      // 1. Restore Data State
      Object.assign(state, lastState.state);
      
      // 2. Cleanup DOM - Remove elements added AFTER this state was saved
      // Elements with historyIndex > lastState.index are from future steps
      // We also remove user messages (msg-user) with historyIndex == lastState.index
      // because those are the answers that triggered the next step
      const elements = document.querySelectorAll(`[data-history-index]`);
      elements.forEach(el => {
        const elIndex = parseInt(el.dataset.historyIndex);
        if (elIndex > lastState.index) {
          // Future step elements - always remove
          el.remove();
        } else if (elIndex === lastState.index && el.classList.contains('msg-user')) {
          // User's answer that triggered this transition - remove it
          el.remove();
        }
      });
      
      // Restore index
      historyIndex = lastState.index;
      updateUndoButton();
      
      // 3. Restore UI for the current step
      restoreUIForStep();
    }

    // Re-render interactive elements for the restored step
    function restoreUIForStep() {
      // Ensure input container is shown (unless card hides it immediately)
      showInputContainer();
      inputField.value = ''; // Clear input
      
      switch (state.step) {
        case 'INTENT':
          // Restore Intent Blocks
          addSelectionBlocks(INTENT_OPTIONS);
          break;
          
        case 'NAME':
          // Just focus input, question is persistent
          inputField.focus();
          break;
          
        case 'AMOUNT':
          // Restore Amount Card
          addAmountCard();
          break;
          
        case 'PEOPLE':
          // Restore People Card
          addPeopleCard();
          break;
          
        case 'SPLIT':
          // Restore Split Blocks
          addSplitBlocks();
          break;
      }
    }

    // Extract Intent Options to Constant for reuse
    const INTENT_OPTIONS = [
      { 
        id: 'restaurant', 
        icon: 'üçΩÔ∏è', 
        title: 'Restaurant Bill', 
        desc: 'Split a dinner bill easily' 
      },
      { 
        id: 'trip', 
        icon: '‚úàÔ∏è', 
        title: 'Trip / Holiday', 
        desc: 'Track shared travel expenses' 
      },
      { 
        id: 'gift', 
        icon: 'üéÅ', 
        title: 'Group Gift', 
        desc: 'Collect money for a present' 
      }
    ];

    // ===========================================
    // INITIALIZATION
    // ===========================================
    setTimeout(() => {
      // Show typing indicator first
      showTyping();
      
      // After a moment, remove typing and show the question
      setTimeout(() => {
        removeTyping();
        addBotMessage("What is this GroupTab for?");
        
        // Then show the selection blocks with a slight delay
        setTimeout(() => {
          addSelectionBlocks(INTENT_OPTIONS);
        }, 400);
        
      }, 700);
      
    }, 300);

    // ===========================================
    // EVENT LISTENERS
    // ===========================================
    undoBtn.addEventListener('click', undoStep); // Undo Listener
    inputField.addEventListener('input', () => {
      sendBtn.disabled = inputField.value.trim() === '';
    });

    inputField.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !sendBtn.disabled) {
        handleUserInput(inputField.value.trim());
      }
    });

    sendBtn.addEventListener('click', () => {
      handleUserInput(inputField.value.trim());
    });

    // ===========================================
    // MAIN INPUT HANDLER
    // ===========================================
    function handleUserInput(text) {
      if (!text) return;
      
      addUserMessage(text);
      inputField.value = '';
      sendBtn.disabled = true;
      clearQuickReplies();
      
      showTyping();
      
      setTimeout(() => {
        removeTyping();
        processStep(text);
      }, 400 + Math.random() * 300);
    }

    // ===========================================
    // STATE MACHINE PROCESSOR
    // ===========================================
    function processStep(input) {
      switch (state.step) {
        
        // -----------------------------------------
        // STEP 1: INTENT (handled via block clicks)
        // -----------------------------------------
        case 'INTENT':
          handleIntent(input);
          break;

        // -----------------------------------------
        // STEP 2: NAME
        // -----------------------------------------
        case 'NAME':
          handleName(input);
          break;

        // -----------------------------------------
        // STEP 3: AMOUNT (handled via card)
        // -----------------------------------------
        case 'AMOUNT':
          // Amount is handled by the card's confirm button
          break;

        // -----------------------------------------
        // STEP 4: PEOPLE (handled via card)
        // -----------------------------------------
        case 'PEOPLE':
          // People is handled by the card's confirm button
          break;

        // -----------------------------------------
        // STEP 5: SPLIT (handled via block clicks)
        // -----------------------------------------
        case 'SPLIT':
          handleSplit(input);
          break;
      }
    }

    // ===========================================
    // STEP HANDLERS
    // ===========================================
    
    function handleIntent(input) {
      pushHistory(); // Save state before transition
      
      const id = input.toLowerCase();
      
      // Match various inputs for restaurant
      if (id === 'restaurant' || id === 'restaurant bill' || id.includes('dinner') || id.includes('lunch')) {
        state.data.template = 'restaurant';
        state.data.type = 'one_bill';
        
        addBotMessage("How shall we name this GroupTab?");
        setSuggestions([
          { icon: 'üåô', text: 'Dinner at', isPrefix: true },
          { icon: '‚òÄÔ∏è', text: 'Lunch at', isPrefix: true },
          { icon: 'üç∫', text: 'Drinks at', isPrefix: true }
        ]);
        state.step = 'NAME';
        
      } else if (id === 'trip' || id === 'trip / holiday' || id.includes('holiday') || id.includes('travel')) {
        state.data.template = 'trip';
        state.data.type = 'multi_bill';
        
        addBotMessage("What should we call this trip?");
        setSuggestions([
          { icon: 'üöó', text: 'Road Trip', hint: '' },
          { icon: 'üèîÔ∏è', text: 'Weekend Away', hint: '' },
          { icon: '‚úàÔ∏è', text: 'Holiday', hint: '' }
        ]);
        state.step = 'NAME';
        
      } else if (id === 'gift' || id === 'group gift' || id.includes('present')) {
        state.data.template = 'gift';
        state.data.type = 'one_bill';
        
        addBotMessage("Who is the gift for?");
        state.step = 'NAME';
        
      } else {
        addBotMessage("Please select one of the options above.");
      }
    }
    
    function handleName(input) {
      pushHistory(); // Save state before transition
      
      const trimmedInput = input.trim();
      state.data.restaurantName = trimmedInput;
      
      // Smart naming based on template
      if (state.data.template === 'restaurant') {
        // User now types the full name (e.g., "Dinner at Mario's")
        // Just use what they typed, capitalizing the first letter
        state.data.name = trimmedInput.charAt(0).toUpperCase() + trimmedInput.slice(1);
      } else if (state.data.template === 'gift') {
        state.data.name = `Gift for ${trimmedInput}`;
      } else {
        state.data.name = trimmedInput;
      }
      
      addBotMessage(`"${state.data.name}" ‚Äî got it!`);
      
      // For restaurant bills, proceed to amount
      if (state.data.type === 'one_bill') {
        setTimeout(() => {
          addBotMessage("How much was the bill?");
          addAmountCard();
          state.step = 'AMOUNT';
        }, 500);
      } else {
        // For trips, skip directly to creation (no upfront amount)
        setTimeout(() => {
          createTab();
        }, 500);
      }
    }
    
    function handleAmountConfirm(totalCents, tipCents) {
      pushHistory(); // Save state before transition
      
      state.data.totalCents = totalCents;
      state.data.tipCents = tipCents;
      
      const displayTotal = formatCurrency2(totalCents + tipCents);
      addUserMessage(displayTotal);
      
      // Remove the card
      removeActiveCard();
      showInputContainer();
      
      setTimeout(() => {
        addBotMessage("How many people?");
        addPeopleCard();
        state.step = 'PEOPLE';
      }, 400);
    }
    
    function handlePeopleConfirm(count) {
      pushHistory(); // Save state before transition
      
      state.data.people = count;
      
      addUserMessage(`${count} people`);
      
      // Remove the card
      removeActiveCard();
      showInputContainer();
      
      setTimeout(() => {
        const totalCents = state.data.totalCents + state.data.tipCents;
        const displayTotal = formatCurrency2(totalCents);
        addBotMessage(`How should we split the ${displayTotal}?`);
        addSplitBlocks();
        state.step = 'SPLIT';
      }, 400);
    }
    
    function handleSplit(input) {
      const id = input.toLowerCase();
      
      // Map various inputs to split mode IDs
      let splitMode = null;
      if (id === 'equal' || id === 'equal split' || id.includes('equal')) {
        splitMode = 'equal';
      } else if (id === 'tiered' || id === 'price groups' || id.includes('price') || id.includes('tier')) {
        splitMode = 'tiered';
      } else if (id === 'open' || id === 'go dutch' || id.includes('dutch') || id.includes('open')) {
        splitMode = 'open';
      }
      
      if (splitMode) {
        pushHistory(); // Save state before transitioning to CREATING
        state.data.splitMode = splitMode;
        
        // Note: User message is already added by handleBlockClick, so we don't add it here
        
        // Create the tab
        setTimeout(() => {
          createTab();
        }, 400);
        
      } else {
        addBotMessage("Please select one of the split options.");
      }
    }

    // ===========================================
    // UI HELPER: Selection Blocks (Sticker Slap Style)
    // ===========================================
    function addSelectionBlocks(options) {
      const container = document.createElement('div');
      container.className = 'selection-scroller';
      container.id = 'active-selection-blocks';
      container.dataset.historyIndex = historyIndex; // Tag with history index
      
      options.forEach(opt => {
        const card = document.createElement('div');
        card.className = 'selection-card';
        card.onclick = () => handleBlockClick(opt.id, opt.title);
        
        // Build icon display: Check for dual icons (e.g. Lobster vs Carrot)
        let iconHtml;
        if (opt.iconAlt) {
          iconHtml = `<div class="sc-icon-dual">
            <span>${opt.icon}</span>
            <span class="sc-icon-vs">vs</span>
            <span>${opt.iconAlt}</span>
          </div>`;
        } else {
          iconHtml = `<div class="sc-icon">${opt.icon}</div>`;
        }
        
        // Build badge/stamp - prefer stamp (SVG) over badge (text)
        let badgeHtml = '';
        if (opt.stamp) {
          badgeHtml = `<div class="stamp-badge">${opt.stamp}</div>`;
        } else if (opt.badge) {
          badgeHtml = `<div class="selection-badge">${opt.badge}</div>`;
        }
        
        card.innerHTML = `
          ${badgeHtml}
          ${iconHtml}
          <div class="sc-title">${opt.title}</div>
          ${opt.subtext ? `<div class="sc-subtext">${opt.subtext}</div>` : ''}
          <div class="sc-desc">${opt.desc}</div>
        `;
        
        container.appendChild(card);
      });
      
      chatHistory.appendChild(container);
      scrollToBottom();
    }
    
    function handleBlockClick(id, label) {
      // Remove the selection blocks
      const blocks = document.getElementById('active-selection-blocks');
      if (blocks) blocks.remove();
      
      // Show user's choice as a message
      addUserMessage(label);
      
      // Process
      showTyping();
      setTimeout(() => {
        removeTyping();
        processStep(id);
      }, 400);
    }
    
    // ===========================================
    // UI HELPER: Suggestions (Below Input Bar)
    // ===========================================
    function setSuggestions(items) {
      quickReplies.innerHTML = '';
      
      items.forEach(item => {
        const chip = document.createElement('div');
        chip.className = 'reply-chip';
        // Show "..." suffix for prefix suggestions
        const displayText = item.isPrefix ? `${item.icon} ${item.text}...` : `${item.icon} ${item.text}`;
        chip.innerHTML = displayText;
        
        chip.onclick = () => {
          if (item.isPrefix) {
            // Fill input with prefix and focus (do NOT submit)
            inputField.value = item.text + ' ';
            inputField.focus();
            // Move cursor to end
            inputField.setSelectionRange(inputField.value.length, inputField.value.length);
            sendBtn.disabled = false;
            // Clear suggestions after selection
            clearQuickReplies();
          } else {
            // Submit immediately
            handleUserInput(item.text);
          }
        };
        
        quickReplies.appendChild(chip);
      });
    }
    
    function clearQuickReplies() {
      quickReplies.innerHTML = '';
    }

    // ===========================================
    // UI HELPER: Amount Card
    // ===========================================
    function addAmountCard() {
      hideInputContainer();
      
      const cardId = 'amount-card-' + Date.now();
      
      const cardHtml = `
        <div id="${cardId}" class="chat-card">
          <div class="form-card">
            <div class="amount-input-wrapper">
              <span class="amount-currency">‚Ç¨</span>
              <input type="text" 
                     id="${cardId}-input" 
                     class="amount-input" 
                     placeholder="0.00" 
                     inputmode="decimal"
                     autocomplete="off"
                     autofocus>
            </div>
            
            <!-- Preview only shows when amount/tip exists -->
            <div id="${cardId}-preview" class="amount-preview"></div>
            
            <button id="${cardId}-tip-btn" class="tip-toggle-btn" onclick="toggleTip('${cardId}')">
              + Add Separate Tip
            </button>
            
            <div id="${cardId}-tip-row" class="tip-input-row">
              <span class="tip-label">Tip ‚Ç¨</span>
              <input type="text" 
                     id="${cardId}-tip-input" 
                     class="tip-input" 
                     placeholder="0.00"
                     inputmode="decimal"
                     autocomplete="off"
                     oninput="updateAmountPreview('${cardId}')">
            </div>
            
            <!-- Hidden File Input -->
            <input type="file" 
                   id="${cardId}-receipt-input" 
                   style="display: none" 
                   accept="image/*"
                   onchange="handleReceiptSelect('${cardId}', this)">

            <!-- Direct Upload Button (Visible initially) -->
            <button id="${cardId}-receipt-btn" class="receipt-simple-btn" onclick="document.getElementById('${cardId}-receipt-input').click()">
              <span>üì∑</span> Upload Receipt (Optional)
            </button>

            <!-- Preview Container (Hidden initially) -->
            <div id="${cardId}-receipt-preview-box" class="receipt-preview-mini" style="display: none;">
              <img id="${cardId}-receipt-thumb" src="" alt="Receipt">
              <span id="${cardId}-receipt-filename" class="receipt-preview-mini-text"></span>
              <button class="receipt-remove-x" onclick="removeReceipt('${cardId}')">√ó</button>
            </div>
            
            <button class="card-confirm-btn" onclick="submitAmount('${cardId}')">
              Confirm
            </button>
          </div>
        </div>
      `;
      
      const wrapper = document.createElement('div');
      wrapper.innerHTML = cardHtml;
      const cardElement = wrapper.firstElementChild;
      cardElement.dataset.historyIndex = historyIndex; // Tag with history index
      chatHistory.appendChild(cardElement);
      scrollToBottom();
      
      // Setup input formatting and focus
      setTimeout(() => {
        const input = document.getElementById(`${cardId}-input`);
        input.focus();
        
        // Format on input for smooth typing
        input.addEventListener('input', () => {
          formatAmountInput(input);
          updateAmountPreview(cardId);
        });
        
        // Format on blur to ensure proper decimals
        input.addEventListener('blur', () => {
          formatAmountOnBlur(input);
          updateAmountPreview(cardId);
        });
      }, 100);
    }
    
    // Format amount while typing (allow only valid decimal input)
    function formatAmountInput(input) {
      let value = input.value;
      // Remove anything that's not a digit, comma, or dot
      value = value.replace(/[^\d.,]/g, '');
      // Replace comma with dot for consistency
      value = value.replace(',', '.');
      // Ensure only one decimal point
      const parts = value.split('.');
      if (parts.length > 2) {
        value = parts[0] + '.' + parts.slice(1).join('');
      }
      // Limit to 2 decimal places
      if (parts.length === 2 && parts[1].length > 2) {
        value = parts[0] + '.' + parts[1].substring(0, 2);
      }
      input.value = value;
    }
    
    // Format on blur to add .00 if needed
    function formatAmountOnBlur(input) {
      let value = input.value.trim();
      if (!value) return;
      
      // Parse and format
      const num = parseFloat(value);
      if (!isNaN(num) && num > 0) {
        input.value = num.toFixed(2);
      }
    }
    
    // Parse amount from input (handles both comma and dot)
    function parseAmountValue(value) {
      if (!value) return 0;
      const cleaned = value.replace(',', '.').replace(/[^\d.]/g, '');
      return parseFloat(cleaned) || 0;
    }
    
    // Update the live preview showing total with tip
    window.updateAmountPreview = function(cardId) {
      const previewEl = document.getElementById(`${cardId}-preview`);
      const amountInput = document.getElementById(`${cardId}-input`);
      const tipInput = document.getElementById(`${cardId}-tip-input`);
      const tipRow = document.getElementById(`${cardId}-tip-row`);
      
      const amount = parseAmountValue(amountInput.value);
      const tip = tipRow.classList.contains('visible') ? parseAmountValue(tipInput.value) : 0;
      
      if (tip > 0) {
        const total = amount + tip;
        previewEl.innerHTML = `Total with tip: <span class="total-value">${formatCurrency2(Math.round(total * 100))}</span>`;
        previewEl.classList.add('visible');
      } else {
        previewEl.innerHTML = '';
        previewEl.classList.remove('visible'); // Collapses height
      }
    };
    
    window.toggleTip = function(cardId) {
      const btn = document.getElementById(`${cardId}-tip-btn`);
      const row = document.getElementById(`${cardId}-tip-row`);
      
      if (row.classList.contains('visible')) {
        row.classList.remove('visible');
        btn.classList.remove('active');
        btn.textContent = '+ Add Separate Tip';
        // Clear tip and update preview
        document.getElementById(`${cardId}-tip-input`).value = '';
        updateAmountPreview(cardId);
      } else {
        row.classList.add('visible');
        btn.classList.add('active');
        btn.textContent = '‚àí Remove Tip';
        const tipInput = document.getElementById(`${cardId}-tip-input`);
        tipInput.focus();
        // Setup tip input formatting
        tipInput.addEventListener('input', () => {
          formatAmountInput(tipInput);
          updateAmountPreview(cardId);
        });
        tipInput.addEventListener('blur', () => {
          formatAmountOnBlur(tipInput);
          updateAmountPreview(cardId);
        });
      }
    };
    
    window.handleReceiptSelect = function(cardId, input) {
      const file = input.files[0];
      if (!file) return;
      
      state.data.receiptFile = file;
      
      // Hide upload button, show preview
      document.getElementById(`${cardId}-receipt-btn`).style.display = 'none';
      const previewBox = document.getElementById(`${cardId}-receipt-preview-box`);
      previewBox.style.display = 'flex';
      
      document.getElementById(`${cardId}-receipt-filename`).textContent = file.name;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById(`${cardId}-receipt-thumb`).src = e.target.result;
      };
      reader.readAsDataURL(file);
    };

    window.removeReceipt = function(cardId) {
      state.data.receiptFile = null;
      document.getElementById(`${cardId}-receipt-input`).value = '';
      
      // Hide preview, show upload button
      document.getElementById(`${cardId}-receipt-preview-box`).style.display = 'none';
      document.getElementById(`${cardId}-receipt-btn`).style.display = 'flex';
    };
    
    window.submitAmount = function(cardId) {
      const amountInput = document.getElementById(`${cardId}-input`);
      const tipInput = document.getElementById(`${cardId}-tip-input`);
      const tipRow = document.getElementById(`${cardId}-tip-row`);
      
      const amount = parseAmountValue(amountInput.value);
      const tip = tipRow.classList.contains('visible') ? parseAmountValue(tipInput.value) : 0;
      
      if (amount <= 0) {
        // Highlight the wrapper instead of the input border
        const wrapper = amountInput.closest('.amount-input-wrapper');
        wrapper.style.borderColor = '#f87171';
        amountInput.focus();
        setTimeout(() => {
          wrapper.style.borderColor = '';
        }, 2000);
        return;
      }
      
      const totalCents = Math.round(amount * 100);
      const tipCents = Math.round(tip * 100);
      
      handleAmountConfirm(totalCents, tipCents);
    };

    // ===========================================
    // UI HELPER: People Step (Selector + Summary Card)
    // ===========================================
    function addPeopleCard() {
      hideInputContainer();
      
      const cardId = 'people-card-' + Date.now();
      const initialCount = 4;
      const totalCents = state.data.totalCents + state.data.tipCents;
      const perPersonAmount = formatCurrency2(totalCents / initialCount);
      const totalAmount = formatCurrency2(totalCents);
      
      const cardHtml = `
        <div id="${cardId}" class="chat-card people-step-wrapper">
          <!-- People Selector (no card background) -->
          <div class="people-selector-inline">
            <div class="people-selector-controls">
              <button class="counter-btn" onclick="adjustPeople('${cardId}', -1)">‚àí</button>
              <input type="number" 
                     id="${cardId}-value" 
                     class="people-count-value" 
                     value="${initialCount}" 
                     min="1" 
                     max="99"
                     inputmode="numeric"
                     onchange="updatePeopleSummary('${cardId}')">
              <button class="counter-btn" onclick="adjustPeople('${cardId}', 1)">+</button>
            </div>
          </div>
          
          <!-- Price Summary Card -->
          <div class="price-summary-card">
            <div class="price-summary-line-main">
              <span id="${cardId}-per-person" class="price-amount">${perPersonAmount}</span>
              <span class="price-label">per person</span>
            </div>
            <div class="price-summary-line-total">
              Total: <span id="${cardId}-total">${totalAmount}</span>
            </div>
            <div class="price-summary-line-hint">Auto-updates when people change</div>
          </div>
          
          <!-- Confirm Button -->
          <button class="card-confirm-btn people-confirm-btn" onclick="submitPeople('${cardId}')">
            Confirm
          </button>
        </div>
      `;
      
      const wrapper = document.createElement('div');
      wrapper.innerHTML = cardHtml;
      const cardElement = wrapper.firstElementChild;
      cardElement.dataset.historyIndex = historyIndex; // Tag with history index
      chatHistory.appendChild(cardElement);
      scrollToBottom();
    }
    
    function calculatePerPerson(count) {
      const totalCents = state.data.totalCents + state.data.tipCents;
      if (count <= 0) return formatCurrency2(0);
      return formatCurrency2(totalCents / count);
    }
    
    function calculateTotal() {
      return formatCurrency2(state.data.totalCents + state.data.tipCents);
    }
    
    window.updatePeopleSummary = function(cardId) {
      const valueEl = document.getElementById(`${cardId}-value`);
      const perPersonEl = document.getElementById(`${cardId}-per-person`);
      const totalEl = document.getElementById(`${cardId}-total`);
      
      let current = parseInt(valueEl.value) || 1;
      current = Math.max(1, Math.min(99, current));
      valueEl.value = current;
      
      perPersonEl.textContent = calculatePerPerson(current);
      totalEl.textContent = calculateTotal();
    };
    
    window.adjustPeople = function(cardId, delta) {
      const valueEl = document.getElementById(`${cardId}-value`);
      
      let current = parseInt(valueEl.value) || 2;
      current = Math.max(1, Math.min(99, current + delta));
      valueEl.value = current;
      
      updatePeopleSummary(cardId);
    };
    
    window.submitPeople = function(cardId) {
      const valueEl = document.getElementById(`${cardId}-value`);
      const count = parseInt(valueEl.value) || 2;
      
      handlePeopleConfirm(count);
    };

    // ===========================================
    // SVG ASSETS: Stamps for Split Options
    // ===========================================
    const SPLIT_STAMPS = {
      SUPER_EASY: `<svg viewBox="0 0 100 100" fill="none">
        <path d="M50 0L60 15L75 10L80 25L95 30L90 45L100 55L85 65L90 80L75 80L65 95L50 85L35 95L25 80L10 80L15 65L0 55L10 45L5 30L20 25L25 10L40 15L50 0Z" fill="#3ddc97"/>
        <circle cx="50" cy="50" r="38" stroke="#0e1116" stroke-width="2" fill="none" opacity="0.15"/>
        <text x="50" y="44" text-anchor="middle" fill="#0e1116" font-size="14" font-weight="900" font-family="Arial, sans-serif">SUPER</text>
        <text x="50" y="60" text-anchor="middle" fill="#0e1116" font-size="14" font-weight="900" font-family="Arial, sans-serif">EASY</text>
      </svg>`,
      FAIR: `<svg viewBox="0 0 100 100" fill="none">
        <circle cx="50" cy="50" r="46" fill="#6366f1" stroke="white" stroke-width="3" stroke-dasharray="6 4"/>
        <text x="50" y="56" text-anchor="middle" fill="white" font-size="20" font-weight="800" font-family="Arial, sans-serif">FAIR!</text>
      </svg>`,
      PRO: `<svg viewBox="0 0 100 100" fill="none">
        <rect x="8" y="8" width="84" height="84" rx="12" fill="#f59e0b" transform="rotate(8 50 50)"/>
        <text x="50" y="48" text-anchor="middle" fill="#0e1116" font-size="13" font-weight="900" font-family="Arial, sans-serif" transform="rotate(8 50 50)">YOU</text>
        <text x="50" y="64" text-anchor="middle" fill="#0e1116" font-size="13" font-weight="900" font-family="Arial, sans-serif" transform="rotate(8 50 50)">CHOOSE</text>
      </svg>`
    };

    // ===========================================
    // UI HELPER: Split Mode Blocks
    // ===========================================
    function addSplitBlocks() {
      const totalCents = state.data.totalCents + state.data.tipCents;
      const people = state.data.people;
      const perPerson = formatCurrency2(totalCents / people);
      
      // Build tip reminder for Go Dutch
      let tipReminder = '';
      if (state.data.tipCents > 0) {
        tipReminder = `<br><em style="color:var(--accent)">We'll remind everyone about the ${formatCurrency2(state.data.tipCents)} tip.</em>`;
      }
      
      addSelectionBlocks([
        {
          id: 'equal',
          icon: 'üçï',
          title: 'Equal Split',
          subtext: `~${perPerson} each`,
          desc: 'Fastest way. Everyone pays exactly the same.',
          stamp: SPLIT_STAMPS.SUPER_EASY
        },
        {
          id: 'tiered',
          icon: 'ü¶û',
          iconAlt: 'ü•ï',
          title: 'Split into Price Groups',
          subtext: 'Fair when big differences',
          desc: 'Alcohol vs Non-alcohol<br>Meat vs Vegan<br>Adults vs Kids',
          stamp: SPLIT_STAMPS.FAIR
        },
        {
          id: 'open',
          icon: 'üá≥üá±',
          title: 'Go Dutch!',
          subtext: 'Everyone picks their own items.',
          desc: `<em>Note: Risk of underpayment.</em>${tipReminder}`,
          stamp: SPLIT_STAMPS.PRO
        }
      ]);
    }

    // ===========================================
    // UI HELPER: Remove Active Card
    // ===========================================
    function removeActiveCard() {
      const cards = chatHistory.querySelectorAll('.chat-card');
      cards.forEach(card => card.remove());
    }
    
    function hideInputContainer() {
      inputContainer.classList.add('hidden');
    }

    function showInputContainer() {
      inputContainer.classList.remove('hidden');
    }

    // ===========================================
    // CREATE TAB (API Call)
    // ===========================================
    async function createTab() {
      state.step = 'CREATING';
      addBotMessage("Creating your tab...");
      
      try {
        // Use FormData to support file upload
        const formData = new FormData();
        formData.append('name', state.data.name);
        formData.append('tabType', state.data.type);
        formData.append('template', state.data.template);
        formData.append('proofRequired', 'optional');
        
        if (state.data.type === 'one_bill') {
          formData.append('totalAmountCents', state.data.totalCents + state.data.tipCents);
          formData.append('splitMode', state.data.splitMode);
          formData.append('expectedPayRate', 100);
          formData.append('peopleCount', state.data.people);
        }
        
        // Add receipt file if present
        if (state.data.receiptFile) {
          formData.append('receipt', state.data.receiptFile);
        }
        
        const response = await fetch('/api/grouptabs', {
          method: 'POST',
          body: formData
        });
        
        // Check if response is JSON before parsing
        const contentType = response.headers.get('content-type');
        let data;
        
        if (contentType && contentType.includes('application/json')) {
          data = await response.json();
        } else {
          // Response is not JSON (likely HTML error page)
          console.error('Server returned non-JSON response:', await response.text());
          throw new Error('Server error. Please try again.');
        }
        
        if (!response.ok) {
          throw new Error(data.error || 'Failed to create tab');
        }
        
        // Show success with share card
        showLaunchCard(data.tab);
        
      } catch (error) {
        console.error('Error creating tab:', error);
        // Show friendly error message to user
        const friendlyMessage = error.message.includes('Unexpected token') 
          ? 'Something went wrong while creating your GroupTab. Please try again.'
          : error.message;
        addBotMessage(`Oops! ${friendlyMessage}`);
        showInputContainer();
      }
    }
    
    function showLaunchCard(tab) {
      hideInputContainer();
      
      const shareUrl = `${window.location.origin}/grouptabs/${tab.id}`;
      const totalCents = state.data.totalCents + state.data.tipCents;
      const perPerson = formatCurrency2(totalCents / state.data.people);
      
      // Build receipt preview if uploaded
      let receiptHtml = '';
      if (tab.receipt_file_path) {
        receiptHtml = `
          <div class="launch-card-receipt">
            <img src="${tab.receipt_file_path}" alt="Receipt" onclick="showReceiptModal('${tab.receipt_file_path}')">
            <span class="launch-card-receipt-label">üìÑ Receipt attached</span>
          </div>
        `;
      }
      
      addBotMessage("Tab created! üöÄ");
      
      const cardHtml = `
        <div class="chat-card">
          <div class="form-card launch-card">
            ${receiptHtml}
            <div class="launch-card-title">${escapeHtml(state.data.name)}</div>
            <div class="launch-card-amount">${formatCurrency2(totalCents)}</div>
            <div class="launch-card-detail">
              ${state.data.people} people ¬∑ ${perPerson} each
            </div>
            
            <button class="share-btn" onclick="copyShareLink('${shareUrl}')">
              üìã Copy Share Link
            </button>
            
            <button class="share-btn" style="background:transparent; border:1px solid var(--accent); color:var(--accent); margin-top:8px;" onclick="window.location.href='/grouptabs/${tab.id}'">
              üëÄ View GroupTab
            </button>
          </div>
        </div>
      `;
      
      const wrapper = document.createElement('div');
      wrapper.innerHTML = cardHtml;
      const cardElement = wrapper.firstElementChild;
      cardElement.dataset.historyIndex = historyIndex; // Tag with history index
      chatHistory.appendChild(cardElement);
      scrollToBottom();
    }
    
    window.showReceiptModal = function(src) {
      // Simple lightbox for receipt
      const overlay = document.createElement('div');
      overlay.className = 'receipt-lightbox';
      overlay.onclick = () => overlay.remove();
      overlay.innerHTML = `<img src="${src}" alt="Receipt">`;
      document.body.appendChild(overlay);
    };
    
    window.copyShareLink = async function(url) {
      try {
        await navigator.clipboard.writeText(url);
        // Visual feedback
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '‚úì Copied!';
        btn.style.background = '#22c55e';
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.style.background = '';
        }, 2000);
      } catch (err) {
        // Fallback: show URL in prompt
        prompt('Copy this link:', url);
      }
    };

    // ===========================================
    // BASIC UI HELPERS
    // ===========================================
    function addBotMessage(html) {
      const div = document.createElement('div');
      div.className = 'msg msg-bot';
      div.innerHTML = html;
      div.dataset.historyIndex = historyIndex; // Tag with history index
      chatHistory.appendChild(div);
      scrollToBottom();
    }

    function addUserMessage(text) {
      const div = document.createElement('div');
      div.className = 'msg msg-user';
      div.textContent = text;
      div.dataset.historyIndex = historyIndex; // Tag with history index
      chatHistory.appendChild(div);
      scrollToBottom();
    }
    
    function showTyping() {
      const div = document.createElement('div');
      div.className = 'typing-indicator';
      div.id = 'typing-indicator';
      div.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
      chatHistory.appendChild(div);
      scrollToBottom();
    }
    
    function removeTyping() {
      const indicator = document.getElementById('typing-indicator');
      if (indicator) indicator.remove();
    }

    function scrollToBottom() {
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initialize header
    if (window.PayFriendsHeader) window.PayFriendsHeader.initialize({ hasActivitySection: false });
  </script>
  </div>
</body>
</html>
