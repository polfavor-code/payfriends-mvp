<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <title>PayFriends â€” Create GroupTab</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  
  <!-- Shared control styles -->
  <link rel="stylesheet" href="/css/shared-controls.css" />
  <link rel="stylesheet" href="/css/app.css" />
  
  <!-- Chat Theme -->
  <link rel="stylesheet" href="/css/chat-theme.css" />

  <script src="/js/header.js"></script>
  <script src="/js/footer.js"></script>
  <script src="/js/formatters.js"></script>
  
  <style>
    /* Standard page layout - matches dashboard, friends, agreements */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 16px;
    }
    
    /* Wizard uses narrower content area but same header width */
    .chat-container {
      max-width: 1000px;
      margin: 0 auto;
    }
    
    /* Make chat-header full width like the main header */
    .chat-header {
      width: 100vw;
      margin-left: calc(-50vw + 50%);
      padding-left: max(20px, calc(50vw - 500px + 20px));
      padding-right: max(20px, calc(50vw - 500px + 20px));
      box-sizing: border-box;
    }

    /* Extra styles specific to the Wizard */
    .chat-input {
      font-size: 18px;
    }
    
    /* Typing indicator animation */
    .typing-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 12px 16px;
      background: var(--message-bot-bg);
      border-radius: 18px;
      border-bottom-left-radius: 4px;
      margin-bottom: 8px;
      align-self: flex-start;
    }
    
    .typing-dot {
      width: 6px;
      height: 6px;
      background: var(--muted);
      border-radius: 50%;
      animation: typing 1.4s infinite ease-in-out both;
    }
    
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes typing {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
    
    /* Hide input bar when card is active */
    .input-container.hidden {
      display: none;
    }
    
    /* =============================================
       PRICE GROUPS CARD STYLES - "Presets First" Design
       ============================================= */
    
    /* Force full width for the price groups card container */
    .chat-card.price-groups-card {
      max-width: 100% !important;
      width: 100% !important;
      background: transparent !important;
      border: none !important;
      padding: 0 !important;
      align-self: stretch !important;
    }

    .price-groups-card .form-card {
      max-width: 480px;
      background: var(--card-bg, #1e2329);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 16px;
    }
    
    /* ===== PRESETS VIEW (Option 4: List Style) ===== */
    .pg-presets-view {
      width: 100%;
      padding: 0;
    }
    
    .pg-preset-list {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      width: 100%;
    }
    
    @media (max-width: 480px) {
      .pg-preset-list {
        grid-template-columns: 1fr;
      }
    }
    
    .pg-preset-chip {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
      padding: 12px 14px;
      background: #161b24;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      min-height: 100%; /* Ensure equal height in grid */
    }
    
    .pg-preset-chip:hover {
      background: #1c212b;
      border-color: var(--accent);
      transform: translateX(2px);
    }
    
    .pg-preset-chip-icon {
      font-size: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .pg-preset-chip-info {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }
    
    .pg-preset-chip-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 2px;
    }
    
    .pg-preset-chip-desc {
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .pg-preset-chip-arrow {
      color: var(--muted);
      opacity: 0.4;
      font-size: 16px;
    }
    
    /* More... dropdown wrapper */
    .pg-preset-more-wrapper {
      position: relative;
      width: 100%;
    }
    
    .pg-more-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 8px;
      background: #1e2329;
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 16px;
      padding: 8px;
      z-index: 10;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }
    
    .pg-more-option {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
      padding: 12px 14px;
      background: transparent;
      border: none;
      border-radius: 12px;
      color: var(--text);
      cursor: pointer;
      transition: all 0.15s ease;
      text-align: left;
    }
    
    .pg-more-option:hover {
      background: rgba(61, 220, 151, 0.1);
    }
    
    .pg-more-option-icon {
      font-size: 20px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
    }
    
    .pg-more-option-info {
      flex: 1;
    }
    
    .pg-more-option-title {
      font-size: 14px;
      font-weight: 600;
    }
    
    .pg-more-option-desc {
      font-size: 11px;
      color: var(--muted);
    }
    
    /* ===== CONFIG VIEW ===== */
    .pg-config-view {
      /* Shown after preset selection */
      display: block;
    }
    
    .pg-config-header {
      font-size: 15px;
      color: var(--muted);
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .pg-preset-name {
      color: var(--text);
      font-weight: 600;
    }
    
    /* ===== NEW GRID LAYOUT ===== */
    .pg-groups-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr); /* 3 columns */
      gap: 12px;
      margin-bottom: 20px;
      width: 100%;
    }

    /* Individual Group Card */
    .pg-group-card {
      position: relative;
      background: #161b24;
      border: 2px solid #2a303c;
      border-radius: 20px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .pg-group-card:hover {
      border-color: rgba(61, 220, 151, 0.3);
    }
    
    /* Selected host group card */
    .pg-group-card.host-selected {
      border-color: var(--accent);
      background: linear-gradient(145deg, rgba(61, 220, 151, 0.08), rgba(61, 220, 151, 0.02));
      box-shadow: 0 4px 20px rgba(61, 220, 151, 0.15);
    }
    
    /* "Your group âœ“" pill badge */
    .pg-host-badge {
      position: absolute;
      top: -10px;
      right: 12px;
      background: var(--accent);
      color: #0e1116;
      font-size: 11px;
      font-weight: 700;
      padding: 4px 10px;
      border-radius: 12px;
      display: none;
      white-space: nowrap;
    }
    
    .pg-group-card.host-selected .pg-host-badge {
      display: block;
    }
    
    /* Host selection status text */
    .pg-host-selection-status {
      grid-column: 1 / -1;
      margin-top: 8px;
      font-size: 13px;
      color: var(--muted);
      text-align: center;
    }
    
    .pg-host-selection-status.selected {
      color: var(--accent);
    }
    
    .pg-host-selection-error {
      grid-column: 1 / -1;
      color: #f87171;
      font-size: 13px;
      margin-top: 8px;
      display: none;
      text-align: center;
    }

    .pg-card-header {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pg-card-emoji {
      font-size: 24px;
      flex-shrink: 0;
    }

    .pg-card-name-input {
      flex: 1;
      background: transparent;
      border: none;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text);
      font-size: 14px;
      font-weight: 600;
      padding: 4px 0;
      min-width: 0;
      border-radius: 0;
    }
    
    .pg-card-name-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .pg-card-body {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .pg-card-label {
      font-size: 11px;
      color: var(--muted);
    }

    .pg-card-price-wrapper {
      display: flex;
      align-items: center;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 10px 12px;
      border: 1px solid transparent;
    }
    
    .pg-card-price-wrapper:focus-within {
      border-color: var(--accent);
    }

    .pg-card-currency {
      color: var(--muted);
      font-size: 14px;
      margin-right: 4px;
    }
    
    .pg-card-price-input {
      flex: 1;
      border: none;
      background: transparent;
      color: var(--text);
      font-size: 16px;
      font-weight: 600;
      min-width: 0;
    }
    
    .pg-card-price-input:focus {
      outline: none;
    }

    .pg-card-remove-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: rgba(255, 255, 255, 0.05);
      color: var(--muted);
      border-radius: 50%;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .pg-card-remove-btn:hover {
      background: rgba(248, 113, 113, 0.2);
      color: #f87171;
    }

    /* Add Group Card (Button) */
    .pg-add-group-card {
      background: transparent;
      border: 2px dashed #2a303c;
      border-radius: 20px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      color: var(--muted);
      transition: all 0.2s;
      min-height: 130px; /* Match approx height of other cards */
    }
    
    .pg-add-group-card:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(61, 220, 151, 0.05);
    }
    
    .pg-add-icon {
      font-size: 24px;
      font-weight: 300;
    }
    
    .pg-add-label {
      font-size: 13px;
      font-weight: 500;
    }
    
    /* Bill Summary Compact */
    .pg-bill-summary-compact {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-size: 16px;
      color: var(--muted);
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      width: 100%;
    }
    
    .pg-summary-dot { opacity: 0.4; }
    .pg-avg-highlight b { color: var(--accent); }
    
    /* Price Comparison Hint */
    .pg-price-comparison {
      min-height: 16px;
      margin-top: 4px;
    }
    
    .pg-price-hint {
      font-size: 11px;
      display: block;
    }
    
    .pg-price-hint.neutral { color: var(--muted); opacity: 0.7; }
    .pg-price-hint.positive { color: #fbbf24; } /* Yellow/Orange for paying more */
    .pg-price-hint.negative { color: #4ade80; } /* Green for paying less */
    
    /* Group Type Dropdown Select */
    .pg-card-type-select {
      flex: 1;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 8px;
      color: var(--text);
      font-size: 14px;
      font-weight: 500;
      padding: 10px 12px;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 32px;
      min-width: 0;
    }
    
    .pg-card-type-select:hover {
      border-color: var(--accent);
    }
    
    .pg-card-type-select:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .pg-card-type-select option {
      background: #1e2329;
      color: var(--text);
      padding: 8px;
    }
    
    /* Warning Footer - Subtle Version */
    .pg-warning-footer {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      margin-bottom: 16px;
    }
    
    .pg-warning-icon {
      font-size: 14px;
      flex-shrink: 0;
      line-height: 1.5;
      color: var(--muted);
      opacity: 0.8;
    }
    
    .pg-warning-text {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
    }
    
    /* Error Message */
    .pg-error-message {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 14px;
      background: rgba(248, 113, 113, 0.1);
      border: 1px solid rgba(248, 113, 113, 0.3);
      border-radius: 10px;
      margin-bottom: 16px;
    }
    
    .pg-error-text {
      font-size: 13px;
      color: #f87171;
    }
    
    /* Create Button */
    .pg-create-btn {
      width: 100%;
      padding: 16px;
      border-radius: 12px;
      border: none;
      background: var(--accent);
      color: #0e1116;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .pg-create-btn:hover {
      background: #4ade80;
      transform: translateY(-1px);
    }
    
    .pg-create-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Launch Card Price Groups Display */
    .launch-card-groups {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin: 8px 0 24px 0; /* More space below before buttons */
    }
    
    .launch-group-chip {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--card);
      border: 1px solid rgba(61, 220, 151, 0.4);
      border-radius: 24px;
      cursor: pointer;
      transition: all 0.2s;
      color: rgba(61, 220, 151, 0.7);
    }
    .launch-group-chip:hover {
      background: rgba(61, 220, 151, 0.08);
      border-color: rgba(61, 220, 151, 0.6);
    }
    .launch-group-chip.selected {
      background: #2a9d6a; /* Darker, less saturated green */
      border-color: #2a9d6a;
      color: #fff;
    }
    .launch-group-chip.selected .lg-name,
    .launch-group-chip.selected .lg-price {
      color: #fff;
    }
    .launch-group-chip.selected .lg-check {
      display: inline;
    }
    
    .lg-emoji {
      font-size: 16px;
    }
    
    .lg-name {
      font-size: 13px;
      font-weight: 600;
      color: inherit;
      transition: color 0.2s;
    }
    
    .lg-price {
      font-size: 13px;
      font-weight: 600;
      color: inherit;
      transition: color 0.2s;
    }
    
    .lg-check {
      display: none;
      font-size: 12px;
      margin-left: 2px;
    }
    
    /* Choose your group instruction */
    .choose-group-instruction {
      font-size: 13px;
      color: var(--muted);
      text-align: center;
      margin-top: 16px;
      margin-bottom: 10px;
    }
    
    /* Extra spacing above the launch card when it has groups */
    .chat-card.launch-card-wrapper {
      margin-top: 24px;
    }
    
    /* Launch card action buttons */
    .launch-card-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 8px;
    }
    
    .share-btn-primary {
      background: #2a9d6a !important; /* Slightly less bright green */
    }
    
    .share-btn-secondary {
      background: transparent !important;
      border: 1px solid var(--accent) !important;
      color: var(--accent) !important;
    }
    .share-btn-secondary:hover {
      background: rgba(61, 220, 151, 0.1) !important;
    }
    
    /* =============================================
       GROUP GIFT SPECIFIC STYLES
       ============================================= */
    
    .gift-about-section {
      margin-bottom: 16px;
    }
    
    .gift-form-label {
      display: block;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .gift-about-textarea,
    .gift-about-input {
      width: 100%;
      box-sizing: border-box;
      padding: 14px 16px;
      background: #1a1f2a;
      border: 2px solid #2a303c;
      border-radius: 12px;
      color: var(--text);
      font-size: 15px;
      line-height: 1.5;
      resize: none;
      font-family: inherit;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    .gift-about-textarea {
      min-height: 70px;
    }
    
    .gift-about-textarea:focus,
    .gift-about-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(0, 214, 143, 0.1);
    }
    
    .gift-about-textarea::placeholder,
    .gift-about-input::placeholder {
      color: #6b7280;
    }
    
    .gift-media-section {
      margin-bottom: 16px;
    }
    
    .gift-media-options {
      display: flex;
      gap: 10px;
    }
    
    .gift-media-btn {
      flex: 1;
      padding: 10px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 10px;
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .gift-media-btn:hover {
      border-color: var(--accent);
      background: rgba(61, 220, 151, 0.1);
    }
    
    .gift-image-preview {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      margin-top: 10px;
    }
    
    .gift-image-preview img {
      width: 48px;
      height: 48px;
      object-fit: cover;
      border-radius: 8px;
    }
    
    .gift-media-remove {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(248, 113, 113, 0.2);
      border: none;
      border-radius: 50%;
      color: #f87171;
      font-size: 16px;
      cursor: pointer;
      margin-left: auto;
    }
    
    .gift-media-remove:hover {
      background: rgba(248, 113, 113, 0.4);
    }
    
    .gift-link-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    
    .gift-link-input {
      flex: 1;
      padding: 10px 14px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 10px;
      color: var(--text);
      font-size: 14px;
    }
    
    .gift-link-input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .gift-link-clear {
      width: 38px;
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 10px;
      color: var(--muted);
      font-size: 18px;
      cursor: pointer;
    }
    
    .gift-link-clear:hover {
      background: rgba(248, 113, 113, 0.2);
      color: #f87171;
    }
    
    .gift-toggle-section {
      margin-bottom: 20px;
      padding: 12px 14px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 10px;
    }
    
    .gift-toggle-option {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
    }
    
    .gift-toggle-checkbox {
      display: none;
    }
    
    .gift-toggle-switch {
      width: 44px;
      height: 24px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      position: relative;
      transition: background 0.2s ease;
      flex-shrink: 0;
    }
    
    .gift-toggle-switch::after {
      content: '';
      position: absolute;
      width: 18px;
      height: 18px;
      background: var(--text);
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: transform 0.2s ease;
    }
    
    .gift-toggle-checkbox:checked + .gift-toggle-switch {
      background: var(--accent);
    }
    
    .gift-toggle-checkbox:checked + .gift-toggle-switch::after {
      transform: translateX(20px);
    }
    
    .gift-toggle-label {
      font-size: 14px;
      color: var(--text);
    }
    
    .gift-card-actions {
      display: flex;
      gap: 10px;
      margin-top: 8px;
    }
    
    .card-skip-btn {
      flex: 1;
      padding: 14px;
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      color: var(--muted);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .card-skip-btn:hover {
      border-color: rgba(255, 255, 255, 0.3);
      color: var(--text);
    }
    
    .gift-contributor-preview {
      text-align: center;
      font-size: 15px;
      color: var(--muted);
      padding: 16px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 10px;
      margin: 16px 0;
    }
    
    .gift-contributor-preview b {
      color: var(--accent);
    }
    
    .gift-open-pot-section {
      margin: 16px 0 20px 0;
      padding: 12px 14px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 10px;
    }
    
    .people-label {
      font-size: 16px;
      color: var(--muted);
      margin-left: 10px;
    }
    
    /* Go Dutch Coming Soon Card */
    .coming-soon-card {
      background: linear-gradient(135deg, rgba(255, 107, 53, 0.1) 0%, rgba(255, 165, 0, 0.08) 100%);
      border: 2px dashed rgba(255, 165, 0, 0.4);
      border-radius: 20px;
      padding: 32px 24px;
      text-align: center;
      max-width: 340px;
      margin: 16px 0;
      animation: cardPop 0.3s ease-out;
    }
    
    @keyframes cardPop {
      0% { opacity: 0; transform: scale(0.9); }
      100% { opacity: 1; transform: scale(1); }
    }
    
    .coming-soon-flag {
      font-size: 56px;
      margin-bottom: 12px;
      animation: flagWave 2s ease-in-out infinite;
    }
    
    @keyframes flagWave {
      0%, 100% { transform: rotate(-5deg); }
      50% { transform: rotate(5deg); }
    }
    
    .coming-soon-title {
      font-size: 22px;
      font-weight: 700;
      color: #ffa500;
      margin-bottom: 12px;
    }
    
    .coming-soon-text {
      font-size: 15px;
      color: rgba(255, 255, 255, 0.7);
      line-height: 1.5;
      margin-bottom: 24px;
    }
    
    .coming-soon-back-btn {
      background: transparent;
      border: 2px solid var(--accent);
      color: var(--accent);
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .coming-soon-back-btn:hover {
      background: var(--accent);
      color: #0e1116;
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header will be loaded dynamically by header.js -->
  
  <div class="chat-container">
    
    <div class="chat-header">
      <div class="chat-title-row">
        <div class="chat-avatar assistant-icon">
          <!-- Playful Sparkle Icon -->
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2L14.5 9.5L22 12L14.5 14.5L12 22L9.5 14.5L2 12L9.5 9.5L12 2Z" fill="white"/>
          </svg>
        </div>
        <div class="chat-title-text">
          <div class="chat-title-main">GroupTab Wizard</div>
          <div class="chat-title-sub">Let's get this sorted! ðŸš€</div>
        </div>
      </div>
      <!-- Controls Group -->
      <div style="display: flex; align-items: center; gap: 8px;">
        <!-- Undo Button (Moved here) -->
        <button id="undo-btn" class="undo-btn-header" title="Go back one step" disabled>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 14L4 9l5-5"/>
            <path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/>
          </svg>
        </button>
        
        <!-- Close Button -->
        <a href="/grouptabs" class="close-icon-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </a>
      </div>
    </div>

    <div id="chat-scroll-area" class="chat-scroll-area">
      <!-- Chat history injected here -->
    </div>

    <div id="input-container" class="input-container">
      <div id="quick-replies" class="quick-replies">
        <!-- Quick replies / suggestions injected here -->
      </div>
      
      <div class="input-bar">
        <input type="text" id="chat-input" class="chat-input" placeholder="Type a message..." autocomplete="off">
        <button id="send-btn" class="send-btn" disabled>âž¤</button>
      </div>
    </div>

  </div>

  <script>
    // ===========================================
    // STATE MACHINE (7-Step Hybrid Wizard)
    // ===========================================
    // Steps: INTENT -> NAME -> AMOUNT -> PEOPLE -> SPLIT -> [PRICE_GROUPS] -> CREATING
    
    const state = {
      step: 'INTENT',
      data: {
        template: '',      // 'restaurant', 'trip', 'gift'
        type: '',          // 'one_bill' or 'multi_bill'
        name: '',          // Tab name (e.g., "Dinner at Vapiano")
        restaurantName: '',// Raw restaurant name
        totalCents: 0,     // Bill total in cents
        tipCents: 0,       // Tip amount in cents
        people: 4,         // Number of people
        splitMode: 'equal', // 'equal', 'price_groups', 'open'
        receiptFile: null, // Optional receipt image file
        // Price Groups configuration (for price_groups split mode)
        priceGroups: [],   // Array of { id, name, emoji, amountCents }
        hostGroupId: null, // The price group ID that the host belongs to
        
        // ===== GROUP GIFT SPECIFIC FIELDS =====
        giftMode: null,           // 'gift_debt' | 'gift_pot_target' | 'gift_pot_open'
        recipientName: null,      // Q1_gift: Who is this gift for?
        groupGiftMode: null,      // NEW: 'gift' | 'fundraiser' - Step 2 choice
        aboutText: null,          // Gift description (for 'gift' mode)
        aboutImage: null,         // Optional gift image file
        aboutLink: null,          // Optional link
        isRaisingMoneyOnly: false,// Legacy flag - now derived from groupGiftMode
        giftPlan: null,           // 'already_bought' | 'planning_to_buy'
        amountTarget: 0,          // For pot modes: target amount in cents
        contributorCount: null,   // Number of contributors
        raisingForText: null,     // Q3_raise: What are you raising money for?
        raisingForImage: null,    // Q3_raise: Optional image
        raisingForLink: null,     // Q3_raise: Optional link
        isOpenPot: false,         // No target (open pot)
        
        // ===== PAYMENT METHODS =====
        paymentMethods: [],       // Array of { type, label, details }
        
        // ===== CREATED TAB (to prevent duplicates) =====
        createdTab: null          // Stores the created tab to prevent duplicate creation
      }
    };
    
    // Default emoji options for price groups (for custom groups)
    const GROUP_EMOJI_OPTIONS = ['ðŸ·', 'ðŸ’§', 'ðŸ¥©', 'ðŸ¥—', 'ðŸ½', 'ðŸ‘¶', 'ðŸ­', 'ðŸº', 'â˜•', 'ðŸ”'];
    
    // Price Group Presets - matches the Horizontal Chips (List Style) Design
    const PRICE_GROUP_PRESETS = {
      alcohol: {
        title: 'Alcohol vs Non-Alcohol',
        desc: 'Split by drinking preference',
        icon: 'ðŸ·',
        groups: [
          { name: 'Alcohol Drinkers', emoji: 'ðŸ·', subtext: 'Wine, cocktails, and heavy hitters.' },
          { name: 'Non-Alcohol', emoji: 'ðŸ’§', subtext: 'Soft drinks, water, and designated drivers.' }
        ]
      },
      meat: {
        title: 'Meat vs Vegetarian',
        desc: 'Split by dietary preference',
        icon: 'ðŸ¥©',
        groups: [
          { name: 'Meat Eaters', emoji: 'ðŸ¥©', subtext: 'Steak, burgers, and carnivore delights.' },
          { name: 'Vegetarians', emoji: 'ðŸ¥—', subtext: 'Plant-based dishes and veggie options.' }
        ]
      },
      portion: {
        title: 'Heavy vs Light Eaters',
        desc: 'Split by portion size',
        icon: 'ðŸ½',
        groups: [
          { name: 'Heavy Eaters', emoji: 'ðŸ½', subtext: 'Big appetites and second helpings.' },
          { name: 'Light Eaters', emoji: 'ðŸ¥—', subtext: 'Smaller portions and lighter fare.' }
        ]
      },
      age: {
        title: 'Adults vs Kids',
        desc: 'Split by age group',
        icon: 'ðŸ‘¨â€ðŸ‘©â€ðŸ‘§',
        groups: [
          { name: 'Adults', emoji: 'ðŸ‘¨', subtext: 'Full-price adult portions.' },
          { name: 'Kids', emoji: 'ðŸ‘§', subtext: 'Kids menu and smaller plates.' }
        ]
      },
      drinks_only: {
        title: 'Full Dinner vs Drinks',
        desc: 'Split by meal participation',
        icon: 'ðŸ»',
        groups: [
          { name: 'Full Dinner', emoji: 'ðŸ½', subtext: 'Food and drinks, the full experience.' },
          { name: 'Drinks Only', emoji: 'ðŸ»', subtext: 'Just here for the beverages.' }
        ]
      },
      custom: {
        title: 'Custom Groups',
        desc: 'Create your own groups',
        icon: 'âš™ï¸',
        groups: [
          { name: 'Group 1', emoji: 'âš™ï¸', subtext: '' },
          { name: 'Group 2', emoji: 'âš™ï¸', subtext: '' }
        ]
      }
    };
    
    // Main presets shown as buttons (first 6)
    const MAIN_PRESET_KEYS = ['alcohol', 'meat', 'portion', 'age', 'drinks_only', 'custom'];
    
    // Track selected preset for the Price Groups step
    let selectedPresetKey = null;

    // DOM References
    const chatHistory = document.getElementById('chat-scroll-area');
    const inputContainer = document.getElementById('input-container');
    const inputField = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const undoBtn = document.getElementById('undo-btn'); // New Undo Button
    const quickReplies = document.getElementById('quick-replies');

    // History State
    let historyStack = [];
    let historyIndex = 0;

    // History Helper: Save current state before moving forward
    function pushHistory() {
      historyStack.push({
        state: JSON.parse(JSON.stringify(state)),
        index: historyIndex
      });
      historyIndex++;
      updateUndoButton();
    }

    // History Helper: Update button visibility
    function updateUndoButton() {
      undoBtn.disabled = historyStack.length === 0;
    }

    // Undo Logic
    function undoStep() {
      if (historyStack.length === 0) return;

      const lastState = historyStack.pop();
      
      // 1. Restore Data State
      Object.assign(state, lastState.state);
      
      // 2. Cleanup DOM - Remove elements added AFTER this state was saved
      // Elements with historyIndex > lastState.index are from future steps
      // We also remove user messages (msg-user) with historyIndex == lastState.index
      // because those are the answers that triggered the next step
      const elements = document.querySelectorAll(`[data-history-index]`);
      elements.forEach(el => {
        const elIndex = parseInt(el.dataset.historyIndex);
        if (elIndex > lastState.index) {
          // Future step elements - always remove
          el.remove();
        } else if (elIndex === lastState.index && el.classList.contains('msg-user')) {
          // User's answer that triggered this transition - remove it
          el.remove();
        }
      });
      
      // Restore index
      historyIndex = lastState.index;
      updateUndoButton();
      
      // 3. Restore UI for the current step
      restoreUIForStep();
    }
    
    // Undo to a specific history index (for clicking on user messages)
    // This restores the state to show the question that was asked at that step
    function undoToIndex(targetIndex) {
      if (historyStack.length === 0 || targetIndex < 0) return;
      
      // Find the state in history that matches this index
      let targetStateIndex = -1;
      for (let i = historyStack.length - 1; i >= 0; i--) {
        if (historyStack[i].index === targetIndex) {
          targetStateIndex = i;
          break;
        }
      }
      
      // If exact match not found, find the closest state at or before target
      if (targetStateIndex === -1) {
        for (let i = historyStack.length - 1; i >= 0; i--) {
          if (historyStack[i].index <= targetIndex) {
            targetStateIndex = i;
            targetIndex = historyStack[i].index;
            break;
          }
        }
      }
      
      if (targetStateIndex === -1) return;
      
      // Get the target state and remove all states after it
      const targetState = historyStack[targetStateIndex];
      historyStack = historyStack.slice(0, targetStateIndex);
      
      // 1. Restore Data State
      Object.assign(state, targetState.state);
      
      // 2. Cleanup DOM - Remove elements after target index AND user messages at target index
      // Keep bot messages at targetIndex (the question), remove user answers and later steps
      const elements = document.querySelectorAll(`[data-history-index]`);
      elements.forEach(el => {
        const elIndex = parseInt(el.dataset.historyIndex);
        if (elIndex > targetIndex) {
          // Remove all elements after target index
          el.remove();
        } else if (elIndex === targetIndex && el.classList.contains('msg-user')) {
          // Also remove user messages at target index (the answer we want to re-enter)
          el.remove();
        }
      });
      
      // Restore index
      historyIndex = targetIndex;
      updateUndoButton();
      
      // 3. Restore UI for the current step
      restoreUIForStep();
    }

    // Re-render interactive elements for the restored step
    function restoreUIForStep() {
      // Ensure input container is shown (unless card hides it immediately)
      showInputContainer();
      inputField.value = ''; // Clear input
      
      switch (state.step) {
        case 'INTENT':
          // Restore Intent Blocks
          addSelectionBlocks(INTENT_OPTIONS);
          break;
          
        case 'NAME':
          // Just focus input, question is persistent
          inputField.focus();
          break;
          
        case 'AMOUNT':
          // Restore Amount Card
          addAmountCard();
          break;
          
        case 'PEOPLE':
          // Restore People Card
          addPeopleCard();
          break;
          
        case 'SPLIT':
          // Restore Split Blocks
          addSplitBlocks();
          break;
          
        case 'PRICE_GROUPS':
          // Restore Price Groups Configuration Card
          addPriceGroupsCard();
          break;
          
        // Group Gift flow steps
        case 'GIFT_RECIPIENT':
          inputField.focus();
          break;
        
        case 'GIFT_TYPE_CHOICE':
          addGiftTypeChoiceBlocks();
          break;
          
        case 'GIFT_ABOUT':
          addGiftAboutCard();
          break;
          
        case 'GIFT_PLAN':
          addGiftPlanBlocks();
          break;
          
        case 'GIFT_AMOUNT':
          addGiftAmountCard(state.data.giftPlan === 'already_bought' ? 'price' : 'target');
          break;
          
        case 'GIFT_CONTRIBUTORS':
          addGiftContributorsCard();
          break;
          
        case 'GIFT_RAISING_FOR':
          addGiftRaisingForCard();
          break;
          
        case 'GIFT_RAISE_TARGET':
          addGiftRaiseTargetCard();
          break;
        
        // Fundraiser minimal flow steps
        case 'FUNDRAISER_NAME':
          addFundraiserNameCard();
          break;
          
        case 'FUNDRAISER_TARGET':
          addFundraiserTargetCard();
          break;
          
        case 'FUNDRAISER_CONTRIBUTORS':
          addFundraiserContributorsCard();
          break;
          
        case 'PAYMENT_DETAILS':
          addPaymentDetailsCard();
          break;
      }
    }

    // Extract Intent Options to Constant for reuse
    const INTENT_OPTIONS = [
      { 
        id: 'restaurant', 
        icon: 'ðŸ½ï¸', 
        title: 'Restaurant Bill', 
        desc: 'Split a dinner bill easily' 
      },
      { 
        id: 'trip', 
        icon: 'âœˆï¸', 
        title: 'Trip / Holiday', 
        desc: 'Track shared travel expenses' 
      },
      { 
        id: 'gift', 
        icon: 'ðŸŽ', 
        title: 'Group Gift', 
        desc: 'Collect money for a present' 
      }
    ];

    // ===========================================
    // INITIALIZATION
    // ===========================================
    setTimeout(() => {
      // Show typing indicator first
      showTyping();
      
      // After a moment, remove typing and show the question
      setTimeout(() => {
        removeTyping();
        addBotMessage("What is this GroupTab for?");
        
        // Then show the selection blocks with a slight delay
        setTimeout(() => {
          addSelectionBlocks(INTENT_OPTIONS);
        }, 400);
        
      }, 700);
      
    }, 300);

    // ===========================================
    // EVENT LISTENERS
    // ===========================================
    undoBtn.addEventListener('click', undoStep); // Undo Listener
    inputField.addEventListener('input', () => {
      sendBtn.disabled = inputField.value.trim() === '';
    });

    inputField.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !sendBtn.disabled) {
        handleUserInput(inputField.value.trim());
      }
    });

    sendBtn.addEventListener('click', () => {
      handleUserInput(inputField.value.trim());
    });

    // ===========================================
    // MAIN INPUT HANDLER
    // ===========================================
    function handleUserInput(text) {
      if (!text) return;
      
      addUserMessage(text);
      inputField.value = '';
      sendBtn.disabled = true;
      clearQuickReplies();
      
      showTyping();
      
      setTimeout(() => {
        removeTyping();
        processStep(text);
      }, 400 + Math.random() * 300);
    }

    // ===========================================
    // STATE MACHINE PROCESSOR
    // ===========================================
    function processStep(input) {
      switch (state.step) {
        
        // -----------------------------------------
        // STEP 1: INTENT (handled via block clicks)
        // -----------------------------------------
        case 'INTENT':
          handleIntent(input);
          break;

        // -----------------------------------------
        // STEP 2: NAME
        // -----------------------------------------
        case 'NAME':
          handleName(input);
          break;

        // -----------------------------------------
        // STEP 3: AMOUNT (handled via card)
        // -----------------------------------------
        case 'AMOUNT':
          // Amount is handled by the card's confirm button
          break;

        // -----------------------------------------
        // STEP 4: PEOPLE (handled via card)
        // -----------------------------------------
        case 'PEOPLE':
          // People is handled by the card's confirm button
          break;

        // -----------------------------------------
        // STEP 5: SPLIT (handled via block clicks)
        // -----------------------------------------
        case 'SPLIT':
          handleSplit(input);
          break;
          
        // =========================================
        // GROUP GIFT FLOW STEPS
        // =========================================
        
        case 'GIFT_RECIPIENT':
          handleGiftRecipient(input);
          break;
        
        case 'GIFT_TYPE_CHOICE':
          handleGiftTypeChoice(input);
          break;
        
        // Gift type selection from blocks
        case 'gift_type_gift':
          selectGiftTypeOption('gift');
          break;
          
        case 'gift_type_fundraiser':
          selectGiftTypeOption('fundraiser');
          break;
          
        case 'GIFT_ABOUT':
          // Handled by card confirm
          break;
          
        case 'GIFT_PLAN':
          handleGiftPlan(input);
          break;
          
        case 'GIFT_AMOUNT':
          // Handled by card confirm
          break;
          
        case 'GIFT_CONTRIBUTORS':
          // Handled by card confirm
          break;
          
        case 'GIFT_RAISING_FOR':
          // Handled by card confirm
          break;
          
        case 'GIFT_RAISE_TARGET':
          // Handled by card confirm
          break;
        
        // Fundraiser minimal flow steps
        case 'FUNDRAISER_NAME':
          // Handled by card confirm
          break;
          
        case 'FUNDRAISER_TARGET':
          // Handled by card confirm
          break;
          
        case 'FUNDRAISER_CONTRIBUTORS':
          // Handled by card confirm
          break;
          
        case 'PAYMENT_METHODS':
          // Handled by card confirm
          break;
      }
    }

    // ===========================================
    // STEP HANDLERS
    // ===========================================
    
    function handleIntent(input) {
      pushHistory(); // Save state before transition
      
      const id = input.toLowerCase();
      
      // Match various inputs for restaurant
      if (id === 'restaurant' || id === 'restaurant bill' || id.includes('dinner') || id.includes('lunch')) {
        state.data.template = 'restaurant';
            state.data.type = 'one_bill';
        
        addBotMessage("How shall we name this GroupTab?");
        setSuggestions([
          { icon: 'ðŸŒ™', text: 'Dinner at', isPrefix: true },
          { icon: 'â˜€ï¸', text: 'Lunch at', isPrefix: true },
          { icon: 'ðŸŒ…', text: 'Breakfast at', isPrefix: true },
          { icon: 'ðŸº', text: 'Drinks at', isPrefix: true }
        ]);
        state.step = 'NAME';
        
      } else if (id === 'trip' || id === 'trip / holiday' || id.includes('holiday') || id.includes('travel')) {
        state.data.template = 'trip';
        state.data.type = 'multi_bill';
        
        addBotMessage("What should we call this trip?");
        setSuggestions([
          { icon: 'ðŸš—', text: 'Road Trip', hint: '' },
          { icon: 'ðŸ”ï¸', text: 'Weekend Away', hint: '' },
          { icon: 'âœˆï¸', text: 'Holiday', hint: '' }
        ]);
        state.step = 'NAME';
        
      } else if (id === 'gift' || id === 'group gift' || id.includes('present')) {
        state.data.template = 'gift';
        state.data.type = 'one_bill';
        
        // === NEW GROUP GIFT FLOW ===
        addBotMessage("Who is this gift for?");
        // Show Skip as a subtle secondary option - user types name directly in input
        setSuggestions([
          { icon: 'â†’', text: 'Skip', isSkip: true }
        ]);
        // Set placeholder for the input field
        inputField.placeholder = "Enter name...";
        state.step = 'GIFT_RECIPIENT';
        
      } else {
        addBotMessage("Please select one of the options above.");
      }
    }
    
    function handleName(input) {
      pushHistory(); // Save state before transition
      
      const trimmedInput = input.trim();
      state.data.restaurantName = trimmedInput;
      
      // Smart naming based on template
      if (state.data.template === 'restaurant') {
        // User now types the full name (e.g., "Dinner at Mario's")
        // Just use what they typed, capitalizing the first letter
        state.data.name = trimmedInput.charAt(0).toUpperCase() + trimmedInput.slice(1);
      } else if (state.data.template === 'gift') {
        state.data.name = `Gift for ${trimmedInput}`;
      } else {
        state.data.name = trimmedInput;
      }
      
      addBotMessage(`"${state.data.name}" â€” got it!`);
      
      // For restaurant bills, proceed to amount
      if (state.data.type === 'one_bill') {
            setTimeout(() => {
          addBotMessage("How much was the bill?");
          addAmountCard();
          state.step = 'AMOUNT';
        }, 500);
          } else {
        // For trips, go to payment details
            setTimeout(() => {
          goToPaymentDetails();
        }, 500);
      }
    }
    
    function handleAmountConfirm(totalCents, tipCents) {
      pushHistory(); // Save state before transition
      
      state.data.totalCents = totalCents;
      state.data.tipCents = tipCents;
      
      const displayTotal = formatCurrency2(totalCents + tipCents);
      addUserMessage(displayTotal);
      
      // Remove the card
      removeActiveCard();
      showInputContainer();
      
          setTimeout(() => {
        addBotMessage("How many people?");
        addPeopleCard();
            state.step = 'PEOPLE';
      }, 400);
    }
    
    function handlePeopleConfirm(count) {
      pushHistory(); // Save state before transition
      
      state.data.people = count;
      
      addUserMessage(`${count} people`);
      
      // Remove the card
      removeActiveCard();
      showInputContainer();
      
      setTimeout(() => {
        const totalCents = state.data.totalCents + state.data.tipCents;
        const displayTotal = formatCurrency2(totalCents);
        addBotMessage(`How should we split the ${displayTotal}?`);
        addSplitBlocks();
        state.step = 'SPLIT';
      }, 400);
    }
    
    function handleSplit(input) {
      const id = input.toLowerCase();
      
      // Map various inputs to split mode IDs
      let splitMode = null;
      if (id === 'equal' || id === 'equal split' || id.includes('equal')) {
        splitMode = 'equal';
      } else if (id === 'tiered' || id === 'price groups' || id.includes('price') || id.includes('tier')) {
        splitMode = 'price_groups';
      } else if (id === 'open' || id === 'go dutch' || id.includes('dutch') || id.includes('open')) {
        splitMode = 'open';
      }
      
      if (splitMode) {
        pushHistory(); // Save state before transitioning
        state.data.splitMode = splitMode;
        
        // Note: User message is already added by handleBlockClick, so we don't add it here
        
        if (splitMode === 'price_groups') {
          // Show Price Groups configuration step
          setTimeout(() => {
            addBotMessage("Please select price groups or create your own custom groups.");
            addPriceGroupsCard();
            state.step = 'PRICE_GROUPS';
          }, 400);
        } else if (splitMode === 'open') {
          // Go Dutch - Coming Soon!
          setTimeout(() => {
            showGoDutchComingSoon();
            state.step = 'GO_DUTCH_SOON';
          }, 400);
        } else {
          // Go to payment details for equal split
          setTimeout(() => {
            goToPaymentDetails();
          }, 400);
        }
        
          } else {
        addBotMessage("Please select one of the split options.");
      }
    }
    
    // =========================================
    // GROUP GIFT FLOW HANDLERS
    // =========================================
    
    function handleGiftRecipient(input) {
      pushHistory();
      
      const trimmed = input.trim();
      
      // Handle skip
      if (trimmed.toLowerCase() === 'skip' || trimmed.toLowerCase().includes('skip')) {
        state.data.recipientName = null;
        addBotMessage("No problem! Let's continue.");
      } else {
        state.data.recipientName = trimmed;
        state.data.name = `Gift for ${trimmed}`;
        addBotMessage(`Lucky ${trimmed}! ðŸŽ`);
      }
      
      clearQuickReplies();
      
      // NEW Step 2: Ask what type of group gift
      setTimeout(() => {
        addBotMessage("So what is the plan?");
        addGiftTypeChoiceBlocks();
        state.step = 'GIFT_TYPE_CHOICE';
      }, 500);
    }
    
    function handleGiftTypeChoice(input) {
      // Handled by selection blocks - this is a fallback
      if (input.toLowerCase().includes('gift') || input.toLowerCase().includes('buying')) {
        selectGiftTypeOption('gift');
      } else if (input.toLowerCase().includes('raising') || input.toLowerCase().includes('money') || input.toLowerCase().includes('fund')) {
        selectGiftTypeOption('fundraiser');
      }
    }
    
    function selectGiftTypeOption(type) {
      pushHistory();
      state.data.groupGiftMode = type;
      
      // Also set legacy flag for compatibility
      state.data.isRaisingMoneyOnly = (type === 'fundraiser');
      
      // Remove selection blocks if they exist
      // Note: When coming from handleBlockClick, blocks are already removed.
      // When coming from text input via handleGiftTypeChoice, blocks still exist.
      // The user message is already added by handleUserInput (for text) or handleBlockClick (for clicks),
      // so we don't add it here.
      const blocks = document.getElementById('active-selection-blocks');
      if (blocks) {
        blocks.remove();
      }
      
      if (type === 'gift') {
        // Gift flow - ask for gift description
        addBotMessage("Add some details about the gift.");
        addGiftAboutCard();
        state.step = 'GIFT_ABOUT';
      } else {
        // Fundraiser mode - minimal flow, skip gift-specific questions
        addBotMessage("What's this collection for? Give it a name.");
        addFundraiserNameCard();
        state.step = 'FUNDRAISER_NAME';
      }
    }
    
    function handleGiftAboutConfirm(aboutText, aboutImage, aboutLink, isRaisingMoneyOnly) {
      pushHistory();
      
      state.data.aboutText = aboutText || null;
      state.data.aboutImage = aboutImage || null;
      state.data.aboutLink = aboutLink || null;
      // isRaisingMoneyOnly is now determined by groupGiftMode, but keep for backward compat
      state.data.isRaisingMoneyOnly = isRaisingMoneyOnly;
      
      // Build display message with optional image thumbnail
      let displayMsg = '';
      if (aboutText) {
        displayMsg = aboutText.substring(0, 50) + (aboutText.length > 50 ? '...' : '');
      } else {
        displayMsg = '(Skipped)';
      }
      
      // Create custom user message with image if present
      if (aboutImage) {
        const div = document.createElement('div');
        div.className = 'msg msg-user msg-with-image msg-clickable';
        div.dataset.historyIndex = historyIndex;
        div.title = 'Click to edit';
        div.onclick = function() {
          const idx = parseInt(this.dataset.historyIndex);
          // Go back to the step where this answer was given (user message and bot question share same historyIndex)
          undoToIndex(idx);
        };
        
        // Create image preview from file
        const reader = new FileReader();
        reader.onload = function(e) {
          div.innerHTML = `
            <img src="${e.target.result}" alt="Gift" class="msg-user-image">
            <span>${displayMsg}</span>
          `;
        };
        reader.readAsDataURL(aboutImage);
        
        // Add placeholder text while image loads
        div.innerHTML = `<span>${displayMsg}</span>`;
        chatHistory.appendChild(div);
        scrollToBottom();
      } else {
        addUserMessage(displayMsg);
      }
      
      removeActiveCard();
      showInputContainer();
      
      // In gift mode, always go to the plan choice (Already bought / Planning to buy)
      setTimeout(() => {
        addBotMessage("Has the gift already been bought?");
        addGiftPlanBlocks();
        state.step = 'GIFT_PLAN';
      }, 400);
    }
    
    function handleGiftPlan(input) {
      const id = input.toLowerCase();
      
      let plan = null;
      if (id === 'already_bought' || id.includes('already bought')) {
        plan = 'already_bought';
      } else if (id === 'planning_to_buy' || id.includes('planning to buy') || id.includes('planning')) {
        plan = 'planning_to_buy';
      }
      
      if (plan) {
        pushHistory();
        state.data.giftPlan = plan;
        
        setTimeout(() => {
          if (plan === 'already_bought') {
            // Scenario 1: Already bought - ask for price
            state.data.giftMode = 'gift_debt';
            addBotMessage("What was the price?");
            addGiftAmountCard('price');
            state.step = 'GIFT_AMOUNT';
          } else {
            // Scenario 2: Planning to buy - ask for target
            state.data.giftMode = 'gift_pot_target';
            addBotMessage("How much are we aiming to collect?");
            addGiftAmountCard('target');
            state.step = 'GIFT_AMOUNT';
          }
        }, 400);
      } else {
        addBotMessage("Please select one of the options.");
      }
    }
    
    function handleGiftAmountConfirm(amountCents, receiptFile, amountType) {
      pushHistory();
      
      if (amountType === 'price') {
        state.data.totalCents = amountCents;
        state.data.receiptFile = receiptFile;
      } else {
        state.data.amountTarget = amountCents;
      }
      
      addUserMessage(formatCurrency2(amountCents));
      removeActiveCard();
      showInputContainer();
      
      setTimeout(() => {
        addBotMessage("How many people are contributing?");
        addGiftContributorsCard();
        state.step = 'GIFT_CONTRIBUTORS';
      }, 400);
    }
    
    function handleGiftContributorsConfirm(count) {
      pushHistory();
      
      state.data.contributorCount = count;
      state.data.people = count;
      
      addUserMessage(`${count} people`);
      removeActiveCard();
      showInputContainer();
      
      // Calculate and show summary
      let summary = '';
      if (state.data.giftMode === 'gift_debt') {
        const shareAmount = Math.floor(state.data.totalCents / count);
        summary = `Ok, that means each person should pay up ${formatCurrency2(shareAmount)}`;
        state.data.splitMode = 'equal'; // Use equal split for debt mode
      } else {
        const suggestedAmount = Math.floor(state.data.amountTarget / count);
        summary = `Suggested contribution: ${formatCurrency2(suggestedAmount)} per person`;
      }
      
      setTimeout(() => {
        addBotMessage(summary);
        // Finalize name if not set
        if (!state.data.name) {
          state.data.name = state.data.aboutText 
            ? `Group Gift: ${state.data.aboutText.substring(0, 30)}` 
            : 'Group Gift';
        }
        
        setTimeout(() => {
          goToPaymentDetails();
        }, 500);
      }, 400);
    }
    
    function handleGiftRaisingForConfirm(raisingForText, raisingForImage, raisingForLink) {
      pushHistory();
      
      state.data.raisingForText = raisingForText || null;
      state.data.raisingForImage = raisingForImage || null;
      state.data.raisingForLink = raisingForLink || null;
      
      // Build display
      let displayMsg = raisingForText 
        ? raisingForText.substring(0, 50) + (raisingForText.length > 50 ? '...' : '')
        : '(Skipped)';
      
      addUserMessage(displayMsg);
      removeActiveCard();
      showInputContainer();
      
      setTimeout(() => {
        addBotMessage("How much do you want to raise?");
        addGiftRaiseTargetCard();
        state.step = 'GIFT_RAISE_TARGET';
      }, 400);
    }
    
    function handleGiftRaiseTargetConfirm(amountCents, isOpenPot) {
      pushHistory();
      
      state.data.isOpenPot = isOpenPot;
      
      if (isOpenPot) {
        state.data.giftMode = 'gift_pot_open';
        state.data.amountTarget = null;
        addUserMessage('Open pot (no target)');
      } else {
        state.data.giftMode = 'gift_pot_target';
        state.data.amountTarget = amountCents;
        addUserMessage(formatCurrency2(amountCents));
      }
      
      removeActiveCard();
      showInputContainer();
      
      // Finalize name if not set
      if (!state.data.name) {
        state.data.name = state.data.raisingForText 
          ? `Fundraiser: ${state.data.raisingForText.substring(0, 30)}` 
          : (state.data.recipientName ? `Gift for ${state.data.recipientName}` : 'Group Fundraiser');
      }
      
      setTimeout(() => {
        // Go to payment details (required for raising money)
        goToPaymentDetails();
      }, 400);
    }

    // ===========================================
    // UI HELPER: Selection Blocks (Sticker Slap Style)
    // ===========================================
    function addSelectionBlocks(options) {
      const container = document.createElement('div');
      container.className = 'selection-scroller';
      container.id = 'active-selection-blocks';
      container.dataset.historyIndex = historyIndex; // Tag with history index
      
      options.forEach(opt => {
        const card = document.createElement('div');
        card.className = 'selection-card';
        card.onclick = () => handleBlockClick(opt.id, opt.title);
        
        // Build icon display: Check for dual icons (e.g. Lobster vs Carrot)
        let iconHtml;
        if (opt.iconAlt) {
          iconHtml = `<div class="sc-icon-dual">
            <span>${opt.icon}</span>
            <span class="sc-icon-vs">vs</span>
            <span>${opt.iconAlt}</span>
          </div>`;
        } else {
          iconHtml = `<div class="sc-icon">${opt.icon}</div>`;
        }
        
        // Build badge/stamp - prefer stamp (SVG) over badge (text)
        let badgeHtml = '';
        if (opt.stamp) {
          badgeHtml = `<div class="stamp-badge">${opt.stamp}</div>`;
        } else if (opt.badge) {
          badgeHtml = `<div class="selection-badge">${opt.badge}</div>`;
        }
        
        card.innerHTML = `
          ${badgeHtml}
          ${iconHtml}
          <div class="sc-title">${opt.title}</div>
          ${opt.subtext ? `<div class="sc-subtext">${opt.subtext}</div>` : ''}
          <div class="sc-desc">${opt.desc}</div>
        `;
        
        container.appendChild(card);
      });
      
      chatHistory.appendChild(container);
      scrollToBottom();
    }
    
    function handleBlockClick(id, label) {
      // Remove the selection blocks
      const blocks = document.getElementById('active-selection-blocks');
      if (blocks) blocks.remove();
      
      // Show user's choice as a message
      addUserMessage(label);
      
      // Process
      showTyping();
      setTimeout(() => {
        removeTyping();
        processStep(id);
      }, 400);
    }
    
    // ===========================================
    // UI HELPER: Suggestions (Below Input Bar)
    // ===========================================
    function setSuggestions(items) {
      quickReplies.innerHTML = '';
      
      items.forEach(item => {
        const chip = document.createElement('div');
        // Add special styling for skip buttons
        chip.className = item.isSkip ? 'reply-chip skip-chip' : 'reply-chip';
        // Show "..." suffix for prefix suggestions
        const displayText = item.isPrefix ? `${item.icon} ${item.text}...` : `${item.icon} ${item.text}`;
        chip.innerHTML = displayText;
        
        chip.onclick = () => {
          if (item.isPrefix) {
            // Fill input with prefix and focus (do NOT submit)
            inputField.value = item.text + ' ';
            inputField.focus();
            // Move cursor to end
            inputField.setSelectionRange(inputField.value.length, inputField.value.length);
            sendBtn.disabled = false;
            // Clear suggestions after selection
            clearQuickReplies();
          } else {
            // Submit immediately
            handleUserInput(item.text);
          }
        };
        
        quickReplies.appendChild(chip);
      });
    }
    
    function clearQuickReplies() {
      quickReplies.innerHTML = '';
    }

    // ===========================================
    // UI HELPER: Amount Card
    // ===========================================
    function addAmountCard() {
      hideInputContainer();
      
      const cardId = 'amount-card-' + Date.now();
      
      const cardHtml = `
        <div id="${cardId}" class="chat-card">
          <div class="form-card">
            <div class="amount-input-wrapper">
              <span class="amount-currency">â‚¬</span>
              <input type="text" 
                     id="${cardId}-input" 
                     class="amount-input" 
                     placeholder="0.00" 
                     inputmode="decimal"
                     autocomplete="off"
                     autofocus>
            </div>
            
            <!-- Preview only shows when amount/tip exists -->
            <div id="${cardId}-preview" class="amount-preview"></div>
            
            <button id="${cardId}-tip-btn" class="tip-toggle-btn" onclick="toggleTip('${cardId}')">
              Separate tip? Add it here.
            </button>
            
            <div id="${cardId}-tip-row" class="tip-input-row">
              <span class="tip-label">Tip â‚¬</span>
              <input type="text" 
                     id="${cardId}-tip-input" 
                     class="tip-input" 
                     placeholder="0.00"
                     inputmode="decimal"
                     autocomplete="off"
                     oninput="updateAmountPreview('${cardId}')">
            </div>
            
            <!-- Hidden File Input -->
            <input type="file" 
                   id="${cardId}-receipt-input" 
                   style="display: none" 
                   accept="image/*,.pdf,application/pdf"
                   onchange="handleReceiptSelect('${cardId}', this)">

            <!-- Direct Upload Button (Visible initially) -->
            <button id="${cardId}-receipt-btn" class="receipt-simple-btn" onclick="document.getElementById('${cardId}-receipt-input').click()">
              <span>ðŸ“·</span> Upload Receipt (Optional)
            </button>

            <!-- Preview Container (Hidden initially) -->
            <div id="${cardId}-receipt-preview-box" class="receipt-preview-mini" style="display: none;">
              <img id="${cardId}-receipt-thumb" src="" alt="Receipt">
              <span id="${cardId}-receipt-filename" class="receipt-preview-mini-text"></span>
              <button class="receipt-remove-x" onclick="removeReceipt('${cardId}')">Ã—</button>
            </div>
            
            <button class="card-confirm-btn" onclick="submitAmount('${cardId}')">
              Confirm
            </button>
          </div>
        </div>
      `;
      
      const wrapper = document.createElement('div');
      wrapper.innerHTML = cardHtml;
      const cardElement = wrapper.firstElementChild;
      cardElement.dataset.historyIndex = historyIndex; // Tag with history index
      chatHistory.appendChild(cardElement);
      scrollToBottom();
      
      // Setup input formatting and focus
      setTimeout(() => {
        const input = document.getElementById(`${cardId}-input`);
        input.focus();
        
        // Format on input for smooth typing
        input.addEventListener('input', () => {
          formatAmountInput(input);
          updateAmountPreview(cardId);
        });
        
        // Format on blur to ensure proper decimals
        input.addEventListener('blur', () => {
          formatAmountOnBlur(input);
          updateAmountPreview(cardId);
        });
      }, 100);
    }
    
    // Format amount while typing (allow only valid decimal input)
    function formatAmountInput(input) {
      let value = input.value;
      // Remove anything that's not a digit, comma, or dot
      value = value.replace(/[^\d.,]/g, '');
      // Replace comma with dot for consistency
      value = value.replace(',', '.');
      // Ensure only one decimal point
      const parts = value.split('.');
      if (parts.length > 2) {
        value = parts[0] + '.' + parts.slice(1).join('');
      }
      // Limit to 2 decimal places
      if (parts.length === 2 && parts[1].length > 2) {
        value = parts[0] + '.' + parts[1].substring(0, 2);
      }
      input.value = value;
    }
    
    // Format on blur to add .00 if needed
    function formatAmountOnBlur(input) {
      let value = input.value.trim();
      if (!value) return;
      
      // Parse and format
      const num = parseFloat(value);
      if (!isNaN(num) && num > 0) {
        input.value = num.toFixed(2);
      }
    }
    
    // Parse amount from input (handles both comma and dot)
    function parseAmountValue(value) {
      if (!value) return 0;
      const cleaned = value.replace(',', '.').replace(/[^\d.]/g, '');
      return parseFloat(cleaned) || 0;
    }
    
    // Update the live preview showing total with tip
    window.updateAmountPreview = function(cardId) {
      const previewEl = document.getElementById(`${cardId}-preview`);
      const amountInput = document.getElementById(`${cardId}-input`);
      const tipInput = document.getElementById(`${cardId}-tip-input`);
      const tipRow = document.getElementById(`${cardId}-tip-row`);
      
      const amount = parseAmountValue(amountInput.value);
      const tip = tipRow.classList.contains('visible') ? parseAmountValue(tipInput.value) : 0;
      
      if (tip > 0) {
        const total = amount + tip;
        previewEl.innerHTML = `Total with tip: <span class="total-value">${formatCurrency2(Math.round(total * 100))}</span>`;
        previewEl.classList.add('visible');
      } else {
        previewEl.innerHTML = '';
        previewEl.classList.remove('visible'); // Collapses height
      }
    };
    
    window.toggleTip = function(cardId) {
      const btn = document.getElementById(`${cardId}-tip-btn`);
      const row = document.getElementById(`${cardId}-tip-row`);
      
      if (row.classList.contains('visible')) {
        row.classList.remove('visible');
        btn.classList.remove('active');
        btn.textContent = 'Separate tip? Add it here.';
        // Clear tip and update preview
        document.getElementById(`${cardId}-tip-input`).value = '';
        updateAmountPreview(cardId);
      } else {
        row.classList.add('visible');
        btn.classList.add('active');
        btn.textContent = 'âˆ’ Remove Tip';
        const tipInput = document.getElementById(`${cardId}-tip-input`);
        tipInput.focus();
        // Setup tip input formatting
        tipInput.addEventListener('input', () => {
          formatAmountInput(tipInput);
          updateAmountPreview(cardId);
        });
        tipInput.addEventListener('blur', () => {
          formatAmountOnBlur(tipInput);
          updateAmountPreview(cardId);
        });
      }
    };
    
    window.handleReceiptSelect = function(cardId, input) {
      const file = input.files[0];
      if (!file) return;
      
      // Check file size (10MB limit)
      const maxSize = 10 * 1024 * 1024;
      if (file.size > maxSize) {
        alert('File is over 10MB. Please choose a smaller file.');
        input.value = '';
        return;
      }
      
      state.data.receiptFile = file;
      
      // Hide upload button, show preview
      document.getElementById(`${cardId}-receipt-btn`).style.display = 'none';
      const previewBox = document.getElementById(`${cardId}-receipt-preview-box`);
      previewBox.style.display = 'flex';
      
      document.getElementById(`${cardId}-receipt-filename`).textContent = file.name;
      
      const thumb = document.getElementById(`${cardId}-receipt-thumb`);
      
      // Handle PDF files differently - show PDF icon instead of preview
      if (file.type === 'application/pdf') {
        thumb.src = 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%2300D68F"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 2l5 5h-5V4zM8.5 13H10v4H8.5v-4zm3.5 0h1.5v4H12v-4zm3.5 0H17v4h-1.5v-4z"/></svg>');
        thumb.alt = 'PDF';
      } else {
      const reader = new FileReader();
      reader.onload = function(e) {
          thumb.src = e.target.result;
      };
      reader.readAsDataURL(file);
      }
    };

    window.removeReceipt = function(cardId) {
      state.data.receiptFile = null;
      document.getElementById(`${cardId}-receipt-input`).value = '';
      
      // Hide preview, show upload button
      document.getElementById(`${cardId}-receipt-preview-box`).style.display = 'none';
      document.getElementById(`${cardId}-receipt-btn`).style.display = 'flex';
    };
    
    window.submitAmount = function(cardId) {
      const amountInput = document.getElementById(`${cardId}-input`);
      const tipInput = document.getElementById(`${cardId}-tip-input`);
      const tipRow = document.getElementById(`${cardId}-tip-row`);
      
      const amount = parseAmountValue(amountInput.value);
      const tip = tipRow.classList.contains('visible') ? parseAmountValue(tipInput.value) : 0;
      
      if (amount <= 0) {
        // Highlight the wrapper instead of the input border
        const wrapper = amountInput.closest('.amount-input-wrapper');
        wrapper.style.borderColor = '#f87171';
        amountInput.focus();
        setTimeout(() => {
          wrapper.style.borderColor = '';
        }, 2000);
        return;
      }
      
      const totalCents = Math.round(amount * 100);
      const tipCents = Math.round(tip * 100);
      
      handleAmountConfirm(totalCents, tipCents);
    };

    // ===========================================
    // UI HELPER: People Step (Selector + Summary Card)
    // ===========================================
    function addPeopleCard() {
      hideInputContainer();
      
      const cardId = 'people-card-' + Date.now();
      const initialCount = 4;
      const totalCents = state.data.totalCents + state.data.tipCents;
      const perPersonAmount = formatCurrency2(totalCents / initialCount);
      const totalAmount = formatCurrency2(totalCents);
      
      const cardHtml = `
        <div id="${cardId}" class="chat-card people-step-wrapper">
          <!-- People Selector (no card background) -->
          <div class="people-selector-inline">
            <div class="people-selector-controls">
              <button class="counter-btn" onclick="adjustPeople('${cardId}', -1)">âˆ’</button>
              <input type="number" 
                     id="${cardId}-value" 
                     class="people-count-value" 
                     value="${initialCount}" 
                     min="1" 
                     max="99"
                     inputmode="numeric"
                     onchange="updatePeopleSummary('${cardId}')">
              <button class="counter-btn" onclick="adjustPeople('${cardId}', 1)">+</button>
            </div>
          </div>
          
          <!-- Price Summary Card -->
          <div class="price-summary-card">
            <div class="price-summary-line-main">
              <span id="${cardId}-per-person" class="price-amount">${perPersonAmount}</span>
              <span class="price-label">per person</span>
            </div>
          </div>
          
          <!-- Confirm Button -->
          <button class="card-confirm-btn people-confirm-btn" onclick="submitPeople('${cardId}')">
            Confirm
          </button>
        </div>
      `;
      
      const wrapper = document.createElement('div');
      wrapper.innerHTML = cardHtml;
      const cardElement = wrapper.firstElementChild;
      cardElement.dataset.historyIndex = historyIndex; // Tag with history index
      chatHistory.appendChild(cardElement);
      scrollToBottom();
    }
    
    function calculatePerPerson(count) {
      const totalCents = state.data.totalCents + state.data.tipCents;
      if (count <= 0) return formatCurrency2(0);
      return formatCurrency2(totalCents / count);
    }
    
    function calculateTotal() {
      return formatCurrency2(state.data.totalCents + state.data.tipCents);
    }
    
    window.updatePeopleSummary = function(cardId) {
      const valueEl = document.getElementById(`${cardId}-value`);
      const perPersonEl = document.getElementById(`${cardId}-per-person`);
      
      let current = parseInt(valueEl.value) || 1;
      current = Math.max(1, Math.min(99, current));
      valueEl.value = current;
      
      perPersonEl.textContent = calculatePerPerson(current);
    };
    
    window.adjustPeople = function(cardId, delta) {
      const valueEl = document.getElementById(`${cardId}-value`);
      
      let current = parseInt(valueEl.value) || 2;
      current = Math.max(1, Math.min(99, current + delta));
      valueEl.value = current;
      
      updatePeopleSummary(cardId);
    };
    
    window.submitPeople = function(cardId) {
      const valueEl = document.getElementById(`${cardId}-value`);
      const count = parseInt(valueEl.value) || 2;
      
      handlePeopleConfirm(count);
    };

    // ===========================================
    // SVG ASSETS: Stamps for Split Options
    // ===========================================
    const SPLIT_STAMPS = {
      SUPER_EASY: `<svg viewBox="0 0 100 100" fill="none">
        <path d="M50 0L60 15L75 10L80 25L95 30L90 45L100 55L85 65L90 80L75 80L65 95L50 85L35 95L25 80L10 80L15 65L0 55L10 45L5 30L20 25L25 10L40 15L50 0Z" fill="#3ddc97"/>
        <circle cx="50" cy="50" r="38" stroke="#0e1116" stroke-width="2" fill="none" opacity="0.15"/>
        <text x="50" y="44" text-anchor="middle" fill="#0e1116" font-size="14" font-weight="900" font-family="Arial, sans-serif">SUPER</text>
        <text x="50" y="60" text-anchor="middle" fill="#0e1116" font-size="14" font-weight="900" font-family="Arial, sans-serif">EASY</text>
      </svg>`,
      FAIR: `<svg viewBox="0 0 100 100" fill="none">
        <circle cx="50" cy="50" r="46" fill="#6366f1" stroke="white" stroke-width="3" stroke-dasharray="6 4"/>
        <text x="50" y="56" text-anchor="middle" fill="white" font-size="20" font-weight="800" font-family="Arial, sans-serif">FAIR!</text>
      </svg>`,
      PRO: `<svg viewBox="0 0 100 100" fill="none">
        <rect x="8" y="8" width="84" height="84" rx="12" fill="#f59e0b" transform="rotate(8 50 50)"/>
        <text x="50" y="48" text-anchor="middle" fill="#0e1116" font-size="13" font-weight="900" font-family="Arial, sans-serif" transform="rotate(8 50 50)">YOU</text>
        <text x="50" y="64" text-anchor="middle" fill="#0e1116" font-size="13" font-weight="900" font-family="Arial, sans-serif" transform="rotate(8 50 50)">CHOOSE</text>
      </svg>`
    };

    // ===========================================
    // UI HELPER: Split Mode Blocks
    // ===========================================
    function addSplitBlocks() {
      const totalCents = state.data.totalCents + state.data.tipCents;
      const people = state.data.people;
      const perPerson = formatCurrency2(totalCents / people);
      
      // Build tip reminder for Go Dutch
      let tipReminder = '';
      if (state.data.tipCents > 0) {
        tipReminder = `<br><em style="color:var(--accent)">We'll remind everyone about the ${formatCurrency2(state.data.tipCents)} tip.</em>`;
      }
      
      addSelectionBlocks([
        {
          id: 'equal',
          icon: 'ðŸ•',
          title: 'Equal Split',
          subtext: `~${perPerson} each`,
          desc: 'Fastest way. Everyone pays exactly the same.',
          stamp: SPLIT_STAMPS.SUPER_EASY
        },
        {
          id: 'tiered',
          icon: 'ðŸ¦ž',
          iconAlt: 'ðŸ¥•',
          title: 'Split into Price Groups',
          subtext: 'Fair when big differences',
          desc: 'Alcohol vs Non-alcohol<br>Meat vs Vegan<br>Adults vs Kids',
          stamp: SPLIT_STAMPS.FAIR
        },
        {
          id: 'open',
          icon: '<span class="flag-wave">ðŸ‡³ðŸ‡±</span>',
          title: 'Go Dutch!',
          subtext: 'Everyone picks their own items.',
          desc: `<em>Note: Risk of underpayment.</em>${tipReminder}`,
          stamp: SPLIT_STAMPS.PRO
        }
      ]);
    }

    // ===========================================
    // UI HELPER: Price Groups Configuration Card
    // ===========================================
    // "Presets First" Design - User must select a preset before configuring groups
    
    function addPriceGroupsCard() {
      hideInputContainer();
      
      const cardId = 'price-groups-card-' + Date.now();
      const totalCents = state.data.totalCents + state.data.tipCents;
      const people = state.data.people;
      const avgPerPerson = Math.round(totalCents / people);
      
      // Reset state for fresh start
      state.data.priceGroups = [];
      selectedPresetKey = null;
      
      const cardHtml = `
        <div id="${cardId}" class="chat-card price-groups-card">
          <!-- PHASE 1: Presets Selection - List Style (Option 4) -->
          <div id="${cardId}-presets-view" class="pg-presets-view">
            <div class="pg-preset-list">
              ${renderPresetsGrid(cardId)}
            </div>
          </div>
          
          <!-- PHASE 2: Groups Configuration (Hidden initially) -->
          <div id="${cardId}-config-view" class="pg-config-view" style="display:none; width: 100%;">
            
            <!-- Bill Summary Header (NEW) -->
            <div class="pg-bill-summary-compact">
              <span>Bill: <b>${formatCurrency2(totalCents)}</b></span>
              <span class="pg-summary-dot">â€¢</span>
              <span>People: <b>${people}</b></span>
              <span class="pg-summary-dot">â€¢</span>
              <span class="pg-avg-highlight">Equal split per person: <b>${formatCurrency2(avgPerPerson)}</b></span>
            </div>
            
            <!-- Grid of Groups + Add Button -->
            <div id="${cardId}-groups" class="pg-groups-grid">
              <!-- Rendered dynamically -->
            </div>
            
            <!-- Warning Footer (Always visible) -->
            <div class="pg-warning-footer">
              <span class="pg-warning-icon">âš ï¸</span>
              <span class="pg-warning-text">Guests choose their own group. Total collected may differ from the bill if chosen incorrectly.</span>
            </div>
            
            <!-- Validation Error (Hidden by default) -->
            <div id="${cardId}-error" class="pg-error-message" style="display:none">
              <span class="pg-error-text"></span>
            </div>
            
            <!-- Create Button -->
            <button id="${cardId}-submit-btn" class="pg-create-btn" onclick="submitPriceGroups('${cardId}')">
              Create Tab
            </button>
          </div>
        </div>
      `;
      
      const wrapper = document.createElement('div');
      wrapper.innerHTML = cardHtml;
      const cardElement = wrapper.firstElementChild;
      cardElement.dataset.historyIndex = historyIndex;
      chatHistory.appendChild(cardElement);
      scrollToBottom();
    }
    
    // Render the presets list (Horizontal Chips Style)
    function renderPresetsGrid(cardId) {
      // Render main preset chips
      return MAIN_PRESET_KEYS.map(key => {
        const preset = PRICE_GROUP_PRESETS[key];
        return `
          <button class="pg-preset-chip" onclick="selectPreset('${cardId}', '${key}')">
            <div class="pg-preset-chip-icon">${preset.icon}</div>
            <div class="pg-preset-chip-info">
              <div class="pg-preset-chip-title">${preset.title}</div>
              <div class="pg-preset-chip-desc">${preset.desc}</div>
            </div>
            <div class="pg-preset-chip-arrow">â†’</div>
          </button>
        `;
      }).join('');
    }
    
    // Handle preset selection - transition from presets view to config view
    window.selectPreset = function(cardId, presetKey) {
      const preset = PRICE_GROUP_PRESETS[presetKey];
      if (!preset) return;
      
      selectedPresetKey = presetKey;
      
      // Populate groups from preset (no auto-calculated amounts)
      state.data.priceGroups = preset.groups.map((g, i) => ({
        id: i + 1,
        name: g.name,
        emoji: g.emoji,
        amountCents: 0 // User must enter amount
      }));
      
      // Hide presets view, show config view
      document.getElementById(`${cardId}-presets-view`).style.display = 'none';
      document.getElementById(`${cardId}-config-view`).style.display = 'block';
      
      // Render groups
      renderGroupConfigForm(cardId);
      scrollToBottom();
    };
    
    // Render the grid layout for groups
    function renderGroupConfigForm(cardId) {
      const container = document.getElementById(`${cardId}-groups`);
      if (!container) return;
      
      try {
        // Calculate average for comparison
        const totalCents = (state.data.totalCents || 0) + (state.data.tipCents || 0);
        const people = state.data.people || 1;
        const avgPerPerson = Math.round(totalCents / people);
        
        // Safe formatter
        const safeFormat = (amount) => {
            try { return typeof formatCurrency2 === 'function' ? formatCurrency2(amount) : (amount/100).toFixed(2); }
            catch (e) { return (amount/100).toFixed(2); }
        };
        
        const avgFormatted = safeFormat(avgPerPerson);

        // Generate HTML for existing groups
        const groups = state.data.priceGroups || [];
        const groupsHtml = groups.map((group, index) => {
          // Calculate comparison text
          let comparisonHtml = `<span class="pg-price-hint neutral">Equal split = ${avgFormatted}</span>`;
          
          if (group.amountCents > 0) {
            const diff = group.amountCents - avgPerPerson;
            if (diff > 50) { // > 0.50 diff
              comparisonHtml = `<span class="pg-price-hint positive">${safeFormat(diff)} above equal split</span>`;
            } else if (diff < -50) {
              comparisonHtml = `<span class="pg-price-hint negative">${safeFormat(Math.abs(diff))} below equal split</span>`;
            }
          }

          // Check if this is a new group that needs type selection
          if (group.isNew) {
            // Get names of groups already in use (excluding this new one)
            const usedNames = groups
              .filter(g => !g.isNew && g.name)
              .map(g => g.name.toLowerCase());
            
            // Filter out already-used group types (but always show Custom)
            const availableOptions = NEW_GROUP_OPTIONS.filter(opt => 
              opt.key === 'custom' || !usedNames.includes(opt.name.toLowerCase())
            );
            
            return `
            <div class="pg-group-card" data-group-id="${group.id}">
              <button class="pg-card-remove-btn" onclick="removePriceGroup('${cardId}', ${group.id})">Ã—</button>
              
              <div class="pg-card-header">
                <span class="pg-card-emoji">ðŸ½</span>
                <select class="pg-card-type-select" onchange="selectGroupType('${cardId}', ${group.id}, this.value)">
                  <option value="" disabled selected>Select group type...</option>
                  ${availableOptions.map(opt => `
                    <option value="${opt.key}" data-emoji="${opt.emoji}">${opt.emoji} ${opt.name}</option>
                  `).join('')}
                </select>
              </div>
              
              <div class="pg-card-body">
                <label class="pg-card-label">Price per person</label>
                <div class="pg-card-price-wrapper">
                  <span class="pg-card-currency">â‚¬</span>
                  <input type="text" 
                         class="pg-card-price-input" 
                         value=""
                         placeholder="0.00"
                         inputmode="decimal"
                         data-group-id="${group.id}">
                </div>
                <div class="pg-price-comparison" id="pg-comp-${cardId}-${group.id}">
                  <span class="pg-price-hint neutral">Equal split = ${avgFormatted}</span>
                </div>
              </div>
            </div>
          `;
          }

          const isHostSelected = state.data.hostGroupId === group.id;
          return `
          <div class="pg-group-card ${isHostSelected ? 'host-selected' : ''}" 
               data-group-id="${group.id}"
               onclick="selectHostGroup('${cardId}', ${group.id}, event)">
            <span class="pg-host-badge">Your group âœ“</span>
            ${groups.length > 2 ? `
              <button class="pg-card-remove-btn" onclick="removePriceGroup('${cardId}', ${group.id}); event.stopPropagation();">Ã—</button>
            ` : ''}
            
            <div class="pg-card-header">
              <span class="pg-card-emoji">${group.emoji}</span>
              <input type="text" 
                     class="pg-card-name-input" 
                     value="${escapeHtml(group.name || '')}" 
                     placeholder="Group name"
                     maxlength="25"
                     data-group-id="${group.id}"
                     onclick="event.stopPropagation()"
                     onchange="updateGroupName('${cardId}', ${group.id}, this.value)">
            </div>
            
            <div class="pg-card-body">
              <label class="pg-card-label">Price per person</label>
              <div class="pg-card-price-wrapper" onclick="event.stopPropagation()">
                <span class="pg-card-currency">â‚¬</span>
                <input type="text" 
                       class="pg-card-price-input" 
                       value="${group.amountCents > 0 ? (group.amountCents / 100).toFixed(2) : ''}"
                       placeholder="0.00"
                       inputmode="decimal"
                       data-group-id="${group.id}">
              </div>
              <div class="pg-price-comparison" id="pg-comp-${cardId}-${group.id}">
                ${comparisonHtml}
              </div>
            </div>
          </div>
        `;
        }).join('');

        // Add the "Add Group" button as the last card in the grid
        const addBtnHtml = `
          <button class="pg-add-group-card" onclick="addPriceGroup('${cardId}')" ${groups.length >= 5 ? 'disabled' : ''}>
            <span class="pg-add-icon">+</span>
            <span class="pg-add-label">Add another group</span>
          </button>
        `;

        // Add host selection status text
        const selectedGroup = groups.find(g => g.id === state.data.hostGroupId);
        const hostStatusHtml = `
          <div class="pg-host-selection-status ${selectedGroup ? 'selected' : ''}" id="${cardId}-host-status">
            ${selectedGroup ? `Selected: <strong>${escapeHtml(selectedGroup.name)}</strong>` : 'Tap a group to select your own.'}
          </div>
          <div class="pg-host-selection-error" id="${cardId}-host-error">
            Please select which group applies to you.
          </div>
        `;

        container.innerHTML = groupsHtml + addBtnHtml + hostStatusHtml;
        
        // Update warning text
        const warningText = document.querySelector(`#${cardId}-config-view .pg-warning-text`);
        if (warningText) {
          warningText.textContent = "Guests choose their own group. Total collected may differ from the bill if chosen incorrectly.";
        }

        // Update submit button text
        const submitBtn = document.getElementById(`${cardId}-submit-btn`);
        if (submitBtn) {
          submitBtn.textContent = "Create Tab";
        }
        
        // Setup input handlers
        setupPriceGroupInputs(cardId);
        
      } catch (e) {
        console.error("Error rendering group config form:", e);
        container.innerHTML = `<div style="color:#f87171; padding:20px; grid-column:1/-1;">
          Error rendering options: ${e.message}<br>
          Please try selecting the preset again.
        </div>`;
      }
    }
    
    function setupPriceGroupInputs(cardId) {
      const container = document.getElementById(`${cardId}-groups`);
      if (!container) return;
      
      container.querySelectorAll('.pg-card-price-input').forEach(input => {
        input.addEventListener('input', () => {
          formatAmountInput(input);
          clearError(cardId);
          // Update comparison text in real-time
          const groupId = parseInt(input.dataset.groupId);
          updateComparisonText(cardId, groupId, input.value);
        });
        input.addEventListener('blur', () => {
          formatAmountOnBlur(input);
          const groupId = parseInt(input.dataset.groupId);
          updateGroupAmount(cardId, groupId, input.value);
        });
      });
      
      container.querySelectorAll('.pg-card-name-input').forEach(input => {
        input.addEventListener('input', () => {
          clearError(cardId);
        });
      });
    }
    
    // Update comparison text in real-time while typing
    function updateComparisonText(cardId, groupId, value) {
      const totalCents = (state.data.totalCents || 0) + (state.data.tipCents || 0);
      const avgPerPerson = Math.round(totalCents / (state.data.people || 1));
      const compEl = document.getElementById(`pg-comp-${cardId}-${groupId}`);
      
      if (!compEl) return;
      
      // Parse the current input value
      const amount = parseAmountValue(value);
      const amountCents = Math.round(amount * 100);
      
      if (amountCents <= 0) {
        compEl.innerHTML = `<span class="pg-price-hint neutral">Equal split = ${formatCurrency2(avgPerPerson)}</span>`;
      } else {
        const diff = amountCents - avgPerPerson;
        if (diff > 50) {
          compEl.innerHTML = `<span class="pg-price-hint positive">${formatCurrency2(diff)} above equal split</span>`;
        } else if (diff < -50) {
          compEl.innerHTML = `<span class="pg-price-hint negative">${formatCurrency2(Math.abs(diff))} below equal split</span>`;
        } else {
          compEl.innerHTML = `<span class="pg-price-hint neutral">Equal split = ${formatCurrency2(avgPerPerson)}</span>`;
        }
      }
    }
    
    window.updateGroupName = function(cardId, groupId, value) {
      const group = state.data.priceGroups.find(g => g.id === groupId);
      if (group) {
        group.name = value.trim();
        // Update host status text if this is the selected group
        updateHostSelectionStatus(cardId);
      }
    };
    
    // Select which group the host belongs to
    window.selectHostGroup = function(cardId, groupId, event) {
      // Don't select if clicking on input fields
      if (event && event.target.tagName === 'INPUT') {
        return;
      }
      
      // Update state
      state.data.hostGroupId = groupId;
      
      // Update visual selection
      const container = document.getElementById(`${cardId}-groups`);
      if (container) {
        container.querySelectorAll('.pg-group-card').forEach(card => {
          const cardGroupId = parseInt(card.dataset.groupId);
          if (cardGroupId === groupId) {
            card.classList.add('host-selected');
          } else {
            card.classList.remove('host-selected');
          }
        });
      }
      
      // Update status text
      updateHostSelectionStatus(cardId);
      
      // Clear any error
      const errorEl = document.getElementById(`${cardId}-host-error`);
      if (errorEl) errorEl.style.display = 'none';
    };
    
    function updateHostSelectionStatus(cardId) {
      const statusEl = document.getElementById(`${cardId}-host-status`);
      if (!statusEl) return;
      
      const selectedGroup = state.data.priceGroups.find(g => g.id === state.data.hostGroupId);
      if (selectedGroup) {
        statusEl.className = 'pg-host-selection-status selected';
        statusEl.innerHTML = `Selected: <strong>${escapeHtml(selectedGroup.name || 'Unnamed group')}</strong>`;
      } else {
        statusEl.className = 'pg-host-selection-status';
        statusEl.innerHTML = 'Tap a group to select your own.';
      }
    }
    
    window.updateGroupAmount = function(cardId, groupId, value) {
      const group = state.data.priceGroups.find(g => g.id === groupId);
      if (group) {
        const amount = parseAmountValue(value);
        group.amountCents = Math.round(amount * 100);
        
        // Update comparison text immediately
        const totalCents = state.data.totalCents + state.data.tipCents;
        const avgPerPerson = Math.round(totalCents / state.data.people);
        const compEl = document.getElementById(`pg-comp-${cardId}-${groupId}`);
        
        if (compEl) {
          if (group.amountCents <= 0) {
            compEl.innerHTML = `<span class="pg-price-hint neutral">Equal split = ${formatCurrency2(avgPerPerson)}</span>`;
          } else {
            const diff = group.amountCents - avgPerPerson;
            if (diff > 50) {
              compEl.innerHTML = `<span class="pg-price-hint positive">${formatCurrency2(diff)} above equal split</span>`;
            } else if (diff < -50) {
              compEl.innerHTML = `<span class="pg-price-hint negative">${formatCurrency2(Math.abs(diff))} below equal split</span>`;
            } else {
              compEl.innerHTML = `<span class="pg-price-hint neutral">Equal split = ${formatCurrency2(avgPerPerson)}</span>`;
            }
          }
        }
      }
    };
    
    // Preset options for new group dropdown
    const NEW_GROUP_OPTIONS = [
      { key: 'adults', name: 'Adults', emoji: 'ðŸ‘¨' },
      { key: 'kids', name: 'Kids', emoji: 'ðŸ‘§' },
      { key: 'alcohol', name: 'Alcohol Drinkers', emoji: 'ðŸ·' },
      { key: 'non_alcohol', name: 'Non-Alcohol', emoji: 'ðŸ’§' },
      { key: 'drinks_only', name: 'Drinks Only', emoji: 'ðŸ»' },
      { key: 'full_dinner', name: 'Full Dinner', emoji: 'ðŸ½' },
      { key: 'meat', name: 'Meat Eaters', emoji: 'ðŸ¥©' },
      { key: 'veggie', name: 'Vegetarians', emoji: 'ðŸ¥—' },
      { key: 'heavy', name: 'Heavy Eaters', emoji: 'ðŸ½' },
      { key: 'light', name: 'Light Eaters', emoji: 'ðŸ¥—' },
      { key: 'custom', name: 'Custom...', emoji: 'âœï¸' }
    ];

    window.addPriceGroup = function(cardId) {
      if (state.data.priceGroups.length >= 5) return; // Allow up to 5 groups
      
      const newId = Math.max(...state.data.priceGroups.map(g => g.id)) + 1;
      state.data.priceGroups.push({
        id: newId,
        name: '', // Empty name triggers dropdown selector
        emoji: 'ðŸ½',
        amountCents: 0,
        isNew: true // Flag to show dropdown
      });
      
      // Re-render groups
      renderGroupConfigForm(cardId);
      scrollToBottom();
    };
    
    window.selectGroupType = function(cardId, groupId, optionKey) {
      const group = state.data.priceGroups.find(g => g.id === groupId);
      if (!group || !optionKey) return;
      
      if (optionKey === 'custom') {
        // Show custom input - keep as regular card but with empty name for user to type
        group.isNew = false;
        group.name = '';
        group.emoji = 'ðŸ­';
        renderGroupConfigForm(cardId);
        // Focus the name input
        setTimeout(() => {
          const input = document.querySelector(`.pg-group-card[data-group-id="${groupId}"] .pg-card-name-input`);
          if (input) input.focus();
        }, 50);
      } else {
        const option = NEW_GROUP_OPTIONS.find(o => o.key === optionKey);
        if (option) {
          group.name = option.name;
          group.emoji = option.emoji;
          group.isNew = false;
          renderGroupConfigForm(cardId);
        }
      }
    };
    
    window.removePriceGroup = function(cardId, groupId) {
      if (state.data.priceGroups.length <= 2) return;
      
      state.data.priceGroups = state.data.priceGroups.filter(g => g.id !== groupId);
      
      // Re-render groups
      renderGroupConfigForm(cardId);
    };
    
    function showError(cardId, message) {
      const errorEl = document.getElementById(`${cardId}-error`);
      if (errorEl) {
        errorEl.style.display = 'flex';
        errorEl.querySelector('.pg-error-text').textContent = message;
      }
    }
    
    function clearError(cardId) {
      const errorEl = document.getElementById(`${cardId}-error`);
      if (errorEl) {
        errorEl.style.display = 'none';
      }
    }
    
    window.submitPriceGroups = function(cardId) {
      // Validate all groups have names and amounts
      const emptyName = state.data.priceGroups.some(g => !g.name.trim());
      const emptyPrice = state.data.priceGroups.some(g => g.amountCents <= 0);
      
      if (emptyName) {
        showError(cardId, 'Please enter a name for all groups.');
        // Highlight empty name inputs
        document.querySelectorAll('.pg-card-name-input').forEach(input => {
          if (!input.value.trim()) {
            input.style.borderColor = '#f87171';
          }
        });
        return;
      }
      
      if (emptyPrice) {
        showError(cardId, 'Please enter a price for all groups.');
        // Highlight empty price inputs
        document.querySelectorAll('.pg-card-price-input').forEach(input => {
          const groupId = parseInt(input.dataset.groupId);
          const group = state.data.priceGroups.find(g => g.id === groupId);
          if (group && group.amountCents <= 0) {
            input.closest('.pg-card-price-wrapper').style.borderColor = '#f87171';
          }
        });
        return;
      }
      
      // Validate host group is selected
      if (!state.data.hostGroupId) {
        showError(cardId, 'Please select which group applies to you.');
        const hostErrorEl = document.getElementById(`${cardId}-host-error`);
        if (hostErrorEl) hostErrorEl.style.display = 'block';
        return;
      }
      
      pushHistory();
      
      // Build summary message
      const groupSummary = state.data.priceGroups
        .map(g => `${g.emoji} ${g.name}: ${formatCurrency2(g.amountCents)}`)
        .join(' Â· ');
      
      addUserMessage(groupSummary);
      
      // Remove the card
      removeActiveCard();
      showInputContainer();
      
      // Go to payment details
      setTimeout(() => {
        goToPaymentDetails();
      }, 400);
    };

    // =========================================
    // GROUP GIFT UI CARDS
    // =========================================
    
    function addGiftAboutCard() {
      // Ensure selection blocks are removed (for text input flow)
      const blocks = document.getElementById('active-selection-blocks');
      if (blocks) blocks.remove();
      
      hideInputContainer();
      
      const cardId = 'gift-about-card-' + Date.now();
      
      const cardHtml = `
        <div id="${cardId}" class="chat-card">
          <div class="form-card">
            <div class="gift-about-section">
              <label class="gift-form-label">Gift name / description</label>
              <input type="text" id="${cardId}-text" 
                     class="gift-about-input" 
                     placeholder="e.g., Marshall speaker, AirPods Pro, etc."
                     maxlength="200">
            </div>
            
            <div class="gift-media-section">
              <div class="gift-media-options">
                <!-- Hidden File Input -->
                <input type="file" 
                       id="${cardId}-image-input" 
                       style="display: none" 
                       accept="image/*"
                       onchange="handleGiftImageSelect('${cardId}', this)">
                
                <button id="${cardId}-image-btn" class="gift-media-btn" onclick="document.getElementById('${cardId}-image-input').click()">
                  ðŸ“· Add Image
                </button>
                
                <button id="${cardId}-link-btn" class="gift-media-btn" onclick="toggleGiftLinkInput('${cardId}')">
                  ðŸ”— Add Link
                </button>
              </div>
              
              <!-- Image Preview (hidden initially) -->
              <div id="${cardId}-image-preview" class="gift-image-preview" style="display: none;">
                <img id="${cardId}-image-thumb" src="" alt="Gift image">
                <button class="gift-media-remove" onclick="removeGiftImage('${cardId}')">Ã—</button>
              </div>
              
              <!-- Link Input (hidden initially) -->
              <div id="${cardId}-link-row" class="gift-link-row" style="display: none;">
                <input type="url" 
                       id="${cardId}-link-input" 
                       class="gift-link-input" 
                       placeholder="https://..."
                       autocomplete="off">
                <button class="gift-link-clear" onclick="clearGiftLink('${cardId}')">Ã—</button>
              </div>
            </div>
            
            <!-- Hidden raising-only checkbox for compatibility (always false in gift mode) -->
            <input type="checkbox" id="${cardId}-raising-only" style="display:none;">
            
            <div class="gift-card-actions">
              <button class="card-skip-btn" onclick="submitGiftAbout('${cardId}', true)">
                Skip
              </button>
              <button class="card-confirm-btn" onclick="submitGiftAbout('${cardId}', false)">
                Continue
              </button>
            </div>
          </div>
        </div>
      `;
      
      const wrapper = document.createElement('div');
      wrapper.innerHTML = cardHtml;
      const cardElement = wrapper.firstElementChild;
      cardElement.dataset.historyIndex = historyIndex;
      chatHistory.appendChild(cardElement);
      scrollToBottom();
      
      setTimeout(() => {
        document.getElementById(`${cardId}-text`).focus();
      }, 100);
    }
    
    window.handleGiftImageSelect = function(cardId, input) {
      const file = input.files[0];
      if (!file) return;
      
      // Check file size (10MB limit)
      const maxSize = 10 * 1024 * 1024;
      if (file.size > maxSize) {
        alert('File is over 10MB. Please choose a smaller file.');
        input.value = '';
        return;
      }
      
      // Store temporarily
      window.giftImageFile = file;
      
      // Hide button, show preview
      document.getElementById(`${cardId}-image-btn`).style.display = 'none';
      const preview = document.getElementById(`${cardId}-image-preview`);
      preview.style.display = 'flex';
      
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById(`${cardId}-image-thumb`).src = e.target.result;
      };
      reader.readAsDataURL(file);
    };
    
    window.removeGiftImage = function(cardId) {
      window.giftImageFile = null;
      document.getElementById(`${cardId}-image-input`).value = '';
      document.getElementById(`${cardId}-image-preview`).style.display = 'none';
      document.getElementById(`${cardId}-image-btn`).style.display = 'flex';
    };
    
    window.toggleGiftLinkInput = function(cardId) {
      const row = document.getElementById(`${cardId}-link-row`);
      const btn = document.getElementById(`${cardId}-link-btn`);
      
      if (row.style.display === 'none') {
        row.style.display = 'flex';
        btn.style.display = 'none';
        document.getElementById(`${cardId}-link-input`).focus();
      }
    };
    
    window.clearGiftLink = function(cardId) {
      document.getElementById(`${cardId}-link-input`).value = '';
      document.getElementById(`${cardId}-link-row`).style.display = 'none';
      document.getElementById(`${cardId}-link-btn`).style.display = 'flex';
    };
    
    window.toggleRaisingMoneyOnly = function(cardId) {
      const checkbox = document.getElementById(`${cardId}-raising-only`);
      // Toggle is handled by the checkbox itself
    };
    
    window.submitGiftAbout = function(cardId, isSkip) {
      const textEl = document.getElementById(`${cardId}-text`);
      const linkEl = document.getElementById(`${cardId}-link-input`);
      const raisingOnlyEl = document.getElementById(`${cardId}-raising-only`);
      
      const aboutText = isSkip ? '' : (textEl.value.trim() || '');
      const aboutLink = isSkip ? '' : (linkEl.value.trim() || '');
      const aboutImage = isSkip ? null : (window.giftImageFile || null);
      const isRaisingMoneyOnly = raisingOnlyEl.checked;
      
      // Clear temp storage
      window.giftImageFile = null;
      
      handleGiftAboutConfirm(aboutText, aboutImage, aboutLink, isRaisingMoneyOnly);
    };
    
    // NEW Step 2: Gift Type Choice (Buying a gift vs Raising money)
    function addGiftTypeChoiceBlocks() {
      addSelectionBlocks([
        {
          id: 'gift_type_gift',
          icon: 'ðŸŽ',
          title: 'Buying a gift',
          desc: 'Collecting money to buy something specific'
        },
        {
          id: 'gift_type_fundraiser',
          icon: 'ðŸ’°',
          title: 'Raising money',
          desc: 'General collection, no specific item'
        }
      ]);
    }
    
    // Fundraiser minimal flow cards
    function addFundraiserNameCard() {
      // Ensure selection blocks are removed (for text input flow)
      const blocks = document.getElementById('active-selection-blocks');
      if (blocks) blocks.remove();
      
      hideInputContainer();
      
      const cardId = 'fundraiser-name-' + Date.now();
      const recipientName = state.data.recipientName;
      const placeholder = recipientName 
        ? `e.g., ${recipientName}'s birthday fund`
        : 'e.g., Birthday collection, Farewell fund';
      
      const cardHtml = `
        <div class="chat-card form-card" id="${cardId}">
          <div class="form-card-title">Collection Name</div>
          <input type="text" 
                 id="${cardId}-input" 
                 class="gift-input" 
                 placeholder="${placeholder}"
                 maxlength="100">
          <button class="form-btn" onclick="confirmFundraiserName('${cardId}')">Continue</button>
        </div>
      `;
      
      const wrapper = document.createElement('div');
      wrapper.innerHTML = cardHtml;
      const card = wrapper.firstElementChild;
      card.dataset.historyIndex = historyIndex;
      chatHistory.appendChild(card);
      scrollToBottom();
      
      document.getElementById(`${cardId}-input`).focus();
    }
    
    window.confirmFundraiserName = function(cardId) {
      const input = document.getElementById(`${cardId}-input`);
      const name = input.value.trim();
      
      if (!name) {
        input.style.borderColor = 'var(--pending)';
        return;
      }
      
      pushHistory();
      state.data.name = name;
      state.data.aboutText = name; // Use same field for consistency
      
      addUserMessage(name);
      removeActiveCard();
      showInputContainer();
      
      setTimeout(() => {
        addBotMessage("Do you have a target amount in mind?");
        addFundraiserTargetCard();
        state.step = 'FUNDRAISER_TARGET';
      }, 400);
    };
    
    function addFundraiserTargetCard() {
      hideInputContainer();
      
      const cardId = 'fundraiser-target-' + Date.now();
      
      const cardHtml = `
        <div class="chat-card form-card" id="${cardId}">
          <div class="form-card-title">Target Amount (optional)</div>
          <div class="gift-amount-input-row">
            <span class="gift-amount-currency">â‚¬</span>
            <input type="number" 
                   id="${cardId}-amount" 
                   class="gift-amount-input" 
                   placeholder="0"
                   min="0"
                   step="0.01">
          </div>
          <p style="font-size: 13px; color: var(--muted); margin: 8px 0 16px;">Leave empty for an open-ended collection</p>
          <div style="display: flex; gap: 10px;">
            <button class="form-btn-secondary" onclick="confirmFundraiserTarget('${cardId}', true)" style="flex:1;">No target</button>
            <button class="form-btn" onclick="confirmFundraiserTarget('${cardId}', false)" style="flex:1;">Continue</button>
          </div>
        </div>
      `;
      
      const wrapper = document.createElement('div');
      wrapper.innerHTML = cardHtml;
      const card = wrapper.firstElementChild;
      card.dataset.historyIndex = historyIndex;
      chatHistory.appendChild(card);
      scrollToBottom();
      
      document.getElementById(`${cardId}-amount`).focus();
    }
    
    window.confirmFundraiserTarget = function(cardId, noTarget) {
      pushHistory();
      
      const amountInput = document.getElementById(`${cardId}-amount`);
      const amountValue = parseFloat(amountInput.value) || 0;
      const amountCents = Math.round(amountValue * 100);
      
      if (noTarget || amountCents === 0) {
        state.data.amountTarget = 0;
        state.data.isOpenPot = true;
        state.data.giftMode = 'gift_pot_open';
        addUserMessage("No target (open collection)");
      } else {
        state.data.amountTarget = amountCents;
        state.data.isOpenPot = false;
        state.data.giftMode = 'gift_pot_target';
        addUserMessage(formatCurrency2(amountCents));
      }
      
      removeActiveCard();
      showInputContainer();
      
      setTimeout(() => {
        addBotMessage("How many people will contribute?");
        addFundraiserContributorsCard();
        state.step = 'FUNDRAISER_CONTRIBUTORS';
      }, 400);
    };
    
    function addFundraiserContributorsCard() {
      hideInputContainer();
      
      const cardId = 'fundraiser-contributors-' + Date.now();
      
      const cardHtml = `
        <div class="chat-card form-card" id="${cardId}">
          <div class="form-card-title">Number of Contributors</div>
          <input type="number" 
                 id="${cardId}-count" 
                 class="gift-input" 
                 placeholder="e.g., 5"
                 min="1"
                 max="100">
          <p style="font-size: 13px; color: var(--muted); margin: 8px 0 16px;">Including yourself</p>
          <button class="form-btn" onclick="confirmFundraiserContributors('${cardId}')">Create GroupTab</button>
        </div>
      `;
      
      const wrapper = document.createElement('div');
      wrapper.innerHTML = cardHtml;
      const card = wrapper.firstElementChild;
      card.dataset.historyIndex = historyIndex;
      chatHistory.appendChild(card);
      scrollToBottom();
      
      document.getElementById(`${cardId}-count`).focus();
    }
    
    window.confirmFundraiserContributors = function(cardId) {
      const countInput = document.getElementById(`${cardId}-count`);
      const count = parseInt(countInput.value) || 0;
      
      if (count < 1) {
        countInput.style.borderColor = 'var(--pending)';
        return;
      }
      
      pushHistory();
      state.data.contributorCount = count;
      state.data.people = count;
      
      addUserMessage(`${count} people`);
      removeActiveCard();
      showInputContainer();
      
      // Go to payment details
      setTimeout(() => {
        goToPaymentDetails();
      }, 400);
    };
    
    // =========================================
    // PAYMENT DETAILS STEP (Multi-method)
    // =========================================
    
    const PAYMENT_METHOD_TYPES = {
      bank: {
        label: 'Bank Transfer',
        icon: 'ðŸ¦',
        fields: [
          { key: 'accountHolder', label: 'Account holder', placeholder: 'Your name', required: true },
          { key: 'iban', label: 'IBAN', placeholder: 'NL00 BANK 0000 0000 00', required: true },
          { key: 'bic', label: 'BIC (optional)', placeholder: 'BANKCODE', required: false },
          { key: 'reference', label: 'Reference', placeholder: 'Payment for...', required: false, prefill: true }
        ]
      },
      paypal: {
        label: 'PayPal',
        icon: 'ðŸ’³',
        fields: [
          { key: 'paypalId', label: 'PayPal username or link', placeholder: 'paypal.me/yourname or email', required: true }
        ]
      },
      revolut: {
        label: 'Revolut',
        icon: 'ðŸ“±',
        fields: [
          { key: 'revolutId', label: 'Revolut username, phone, or link', placeholder: '@username or +31...', required: true }
        ]
      },
      cash: {
        label: 'Cash',
        icon: 'ðŸ’µ',
        fields: [] // No form needed - added directly
      },
      other: {
        label: 'Other',
        icon: 'ðŸ“',
        fields: [
          { key: 'instructions', label: 'Instructions', placeholder: 'How to pay...', required: true },
          { key: 'link', label: 'Link (optional)', placeholder: 'https://...', required: false }
        ]
      }
    };
    
    function isPaymentDetailsRequired() {
      // Fundraiser/Raising money = always required
      if (state.data.groupGiftMode === 'fundraiser' || state.data.isRaisingMoneyOnly) {
        return true;
      }
      // Restaurant bill = required (they already paid, now collecting)
      if (state.data.template === 'restaurant') {
        return true;
      }
      // Gift debt mode (already bought) = required
      if (state.data.giftMode === 'gift_debt') {
        return true;
      }
      // Trip, gift pot modes = optional
      return false;
    }
    
    function goToPaymentDetails() {
      pushHistory();
      
      const isRequired = isPaymentDetailsRequired();
      
      addBotMessage(isRequired 
        ? "How should people pay you?" 
        : "How should people pay you? (optional)");
      
      setTimeout(() => {
        addPaymentDetailsCard();
        state.step = 'PAYMENT_DETAILS';
      }, 400);
    }
    
    function addPaymentDetailsCard() {
      hideInputContainer();
      
      const cardId = 'payment-details-' + Date.now();
      const isRequired = isPaymentDetailsRequired();
      const methods = state.data.paymentMethods || [];
      
      const cardHtml = `
        <div class="chat-card payment-details-card" id="${cardId}">
          <div class="payment-methods-list" id="${cardId}-list">
            ${methods.length === 0 ? `
              <div class="payment-methods-empty">
                <span style="font-size: 32px; display: block; margin-bottom: 8px;">ðŸ’³</span>
                <span style="color: var(--muted);">No payment methods added yet</span>
              </div>
            ` : methods.map((m, idx) => renderPaymentMethodItem(m, idx, cardId)).join('')}
          </div>
          
          <button class="payment-add-btn" onclick="showAddPaymentMethodModal('${cardId}')">
            <span style="font-size: 18px;">+</span> Add payment method
          </button>
          
          <div style="display: flex; gap: 10px; margin-top: 16px;">
            ${!isRequired ? `
              <button class="form-btn-secondary" onclick="skipPaymentDetails('${cardId}')" style="flex:1;">Skip</button>
            ` : ''}
            <button class="form-btn" id="${cardId}-create-btn" onclick="confirmPaymentDetails('${cardId}')" style="flex:1;" ${isRequired && methods.length === 0 ? 'disabled' : ''}>
              Create GroupTab
            </button>
          </div>
        </div>
        
        <!-- Add Payment Method Modal -->
        <div class="payment-method-modal" id="${cardId}-modal" style="display: none;">
          <div class="payment-method-modal-content">
            <div class="payment-modal-header">
              <span id="${cardId}-modal-title">Add Payment Method</span>
              <button class="payment-modal-close" onclick="closePaymentMethodModal('${cardId}')">&times;</button>
            </div>
            
            <div id="${cardId}-modal-body">
              <!-- Step 1: Type selection -->
              <div id="${cardId}-type-select" class="payment-type-select">
                ${Object.entries(PAYMENT_METHOD_TYPES).map(([key, val]) => `
                  <button class="payment-type-btn" onclick="selectPaymentType('${cardId}', '${key}')">
                    <span class="payment-type-icon">${val.icon}</span>
                    <span class="payment-type-label">${val.label}</span>
                  </button>
                `).join('')}
              </div>
              
              <!-- Step 2: Fields (hidden initially) -->
              <div id="${cardId}-fields" style="display: none;">
                <div id="${cardId}-fields-content"></div>
                <button class="form-btn" onclick="savePaymentMethod('${cardId}')" style="width: 100%; margin-top: 16px;">
                  Add
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      const wrapper = document.createElement('div');
      wrapper.innerHTML = cardHtml;
      const card = wrapper.firstElementChild;
      const modal = wrapper.children[1];
      card.dataset.historyIndex = historyIndex;
      modal.dataset.historyIndex = historyIndex;
      chatHistory.appendChild(card);
      chatHistory.appendChild(modal);
      scrollToBottom();
    }
    
    function renderPaymentMethodItem(method, index, cardId) {
      const typeInfo = PAYMENT_METHOD_TYPES[method.type];
      const summary = getPaymentMethodSummary(method);
      
      return `
        <div class="payment-method-item">
          <div class="payment-method-item-icon">${typeInfo.icon}</div>
          <div class="payment-method-item-info">
            <div class="payment-method-item-type">${typeInfo.label}</div>
            <div class="payment-method-item-summary">${escapeHtml(summary)}</div>
          </div>
          <button class="payment-method-remove-btn" onclick="removePaymentMethod('${cardId}', ${index})">Ã—</button>
        </div>
      `;
    }
    
    function getPaymentMethodSummary(method) {
      const d = method.details || {};
      switch (method.type) {
        case 'bank':
          return d.iban || 'Bank transfer';
        case 'paypal':
          return d.paypalId || 'PayPal';
        case 'revolut':
          return d.revolutId || 'Revolut';
        case 'cash':
          return 'Pay in cash';
        case 'other':
          return d.instructions?.substring(0, 30) || 'Other method';
        default:
          return method.type;
      }
    }
    
    // Track current modal editing state
    let currentPaymentMethodType = null;
    let editingPaymentMethodIndex = null;
    
    window.showAddPaymentMethodModal = function(cardId) {
      currentPaymentMethodType = null;
      editingPaymentMethodIndex = null;
      
      const modal = document.getElementById(`${cardId}-modal`);
      const typeSelect = document.getElementById(`${cardId}-type-select`);
      const fields = document.getElementById(`${cardId}-fields`);
      const title = document.getElementById(`${cardId}-modal-title`);
      
      title.textContent = 'Add Payment Method';
      typeSelect.style.display = 'grid';
      fields.style.display = 'none';
      modal.style.display = 'flex';
    };
    
    window.closePaymentMethodModal = function(cardId) {
      const modal = document.getElementById(`${cardId}-modal`);
      modal.style.display = 'none';
    };
    
    window.selectPaymentType = function(cardId, type) {
      currentPaymentMethodType = type;
      const typeInfo = PAYMENT_METHOD_TYPES[type];
      
      // Cash is simple - no form needed, add directly
      if (type === 'cash') {
        if (!state.data.paymentMethods) {
          state.data.paymentMethods = [];
        }
        state.data.paymentMethods.push({
          type: 'cash',
          details: {}
        });
        closePaymentMethodModal(cardId);
        refreshPaymentMethodsList(cardId);
        return;
      }
      
      const typeSelect = document.getElementById(`${cardId}-type-select`);
      const fields = document.getElementById(`${cardId}-fields`);
      const fieldsContent = document.getElementById(`${cardId}-fields-content`);
      const title = document.getElementById(`${cardId}-modal-title`);
      
      title.textContent = `${typeInfo.icon} ${typeInfo.label}`;
      typeSelect.style.display = 'none';
      fields.style.display = 'block';
      
      // Generate field inputs
      fieldsContent.innerHTML = typeInfo.fields.map(field => {
        // Pre-fill reference with GroupTab name
        let defaultValue = '';
        if (field.prefill && field.key === 'reference') {
          defaultValue = state.data.name || '';
        }
        
        return `
          <div class="payment-field-group">
            <label class="payment-field-label">${field.label}</label>
            <input type="text" 
                   id="${cardId}-field-${field.key}" 
                   class="payment-field-input" 
                   placeholder="${field.placeholder}"
                   value="${escapeHtml(defaultValue)}"
                   ${field.required ? 'required' : ''}>
          </div>
        `;
      }).join('');
      
      // Focus first field
      const firstInput = fieldsContent.querySelector('input');
      if (firstInput) firstInput.focus();
    };
    
    window.savePaymentMethod = function(cardId) {
      if (!currentPaymentMethodType) return;
      
      const typeInfo = PAYMENT_METHOD_TYPES[currentPaymentMethodType];
      const details = {};
      let isValid = true;
      
      // Collect field values
      typeInfo.fields.forEach(field => {
        const input = document.getElementById(`${cardId}-field-${field.key}`);
        const value = input ? input.value.trim() : '';
        details[field.key] = value;
        
        if (field.required && !value) {
          input.style.borderColor = 'var(--pending)';
          isValid = false;
        } else if (input) {
          input.style.borderColor = '';
        }
      });
      
      if (!isValid) return;
      
      // Add to state
      if (!state.data.paymentMethods) {
        state.data.paymentMethods = [];
      }
      
      if (editingPaymentMethodIndex !== null) {
        state.data.paymentMethods[editingPaymentMethodIndex] = {
          type: currentPaymentMethodType,
          details: details
        };
      } else {
        state.data.paymentMethods.push({
          type: currentPaymentMethodType,
          details: details
        });
      }
      
      // Close modal and refresh list
      closePaymentMethodModal(cardId);
      refreshPaymentMethodsList(cardId);
    };
    
    window.removePaymentMethod = function(cardId, index) {
      if (state.data.paymentMethods && state.data.paymentMethods[index]) {
        state.data.paymentMethods.splice(index, 1);
        refreshPaymentMethodsList(cardId);
      }
    };
    
    function refreshPaymentMethodsList(cardId) {
      const listEl = document.getElementById(`${cardId}-list`);
      const createBtn = document.getElementById(`${cardId}-create-btn`);
      const methods = state.data.paymentMethods || [];
      const isRequired = isPaymentDetailsRequired();
      
      if (methods.length === 0) {
        listEl.innerHTML = `
          <div class="payment-methods-empty">
            <span style="font-size: 32px; display: block; margin-bottom: 8px;">ðŸ’³</span>
            <span style="color: var(--muted);">No payment methods added yet</span>
          </div>
        `;
        if (isRequired) {
          createBtn.disabled = true;
        }
      } else {
        listEl.innerHTML = methods.map((m, idx) => renderPaymentMethodItem(m, idx, cardId)).join('');
        createBtn.disabled = false;
      }
    }
    
    window.skipPaymentDetails = function(cardId) {
      pushHistory();
      state.data.paymentMethods = [];
      addUserMessage("Skipped");
      removeActiveCard();
      
      // Also remove modal
      const modal = document.getElementById(`${cardId}-modal`);
      if (modal) modal.remove();
      
      showInputContainer();
      
      setTimeout(() => {
        createTab();
      }, 400);
    };
    
    window.confirmPaymentDetails = function(cardId) {
      const methods = state.data.paymentMethods || [];
      const isRequired = isPaymentDetailsRequired();
      
      if (isRequired && methods.length === 0) {
        return; // Button should be disabled anyway
      }
      
      pushHistory();
      
      // Summarize for user message
      if (methods.length > 0) {
        const summary = methods.map(m => PAYMENT_METHOD_TYPES[m.type].label).join(', ');
        addUserMessage(summary);
      } else {
        addUserMessage("No payment methods");
      }
      
      removeActiveCard();
      
      // Also remove modal
      const modal = document.getElementById(`${cardId}-modal`);
      if (modal) modal.remove();
      
      showInputContainer();
      
      setTimeout(() => {
        createTab();
      }, 400);
    };
    
    function addGiftPlanBlocks() {
      addSelectionBlocks([
        {
          id: 'already_bought',
          icon: 'âœ…',
          title: 'Yes, already bought',
          desc: 'I already paid, now collecting from others',
          subtext: 'Debt mode'
        },
        {
          id: 'planning_to_buy',
          icon: 'ðŸ›’',
          title: 'No, not yet',
          desc: 'We\'re collecting first, buying later',
          subtext: 'Target mode'
        }
      ]);
    }
    
    function addGiftAmountCard(amountType) {
      hideInputContainer();
      
      const cardId = 'gift-amount-card-' + Date.now();
      const isPrice = amountType === 'price';
      const title = isPrice ? 'Gift Price' : 'Target Amount';
      const placeholder = isPrice ? 'What did it cost?' : 'How much to collect?';
      
      const receiptSection = isPrice ? `
        <!-- Hidden Receipt Input -->
        <input type="file" 
               id="${cardId}-receipt-input" 
               style="display: none" 
               accept="image/*,.pdf,application/pdf"
               onchange="handleGiftReceiptSelect('${cardId}', this)">
        
        <button id="${cardId}-receipt-btn" class="receipt-simple-btn" onclick="document.getElementById('${cardId}-receipt-input').click()">
          <span>ðŸ§¾</span> Add Receipt (Optional)
        </button>
        
        <div id="${cardId}-receipt-preview" class="receipt-preview-mini" style="display: none;">
          <img id="${cardId}-receipt-thumb" src="" alt="Receipt">
          <span id="${cardId}-receipt-filename" class="receipt-preview-mini-text"></span>
          <button class="receipt-remove-x" onclick="removeGiftReceipt('${cardId}')">Ã—</button>
        </div>
      ` : '';
      
      const cardHtml = `
        <div id="${cardId}" class="chat-card">
          <div class="form-card">
            <div class="amount-input-wrapper">
              <span class="amount-currency">â‚¬</span>
              <input type="text" 
                     id="${cardId}-input" 
                     class="amount-input" 
                     placeholder="0.00" 
                     inputmode="decimal"
                     autocomplete="off"
                     autofocus>
            </div>
            
            ${receiptSection}
            
            <button class="card-confirm-btn" onclick="submitGiftAmount('${cardId}', '${amountType}')">
              Continue
            </button>
          </div>
        </div>
      `;
      
      const wrapper = document.createElement('div');
      wrapper.innerHTML = cardHtml;
      const cardElement = wrapper.firstElementChild;
      cardElement.dataset.historyIndex = historyIndex;
      chatHistory.appendChild(cardElement);
      scrollToBottom();
      
      // Setup input formatting
      setTimeout(() => {
        const input = document.getElementById(`${cardId}-input`);
        input.focus();
        
        input.addEventListener('input', () => {
          formatAmountInput(input);
        });
        
        input.addEventListener('blur', () => {
          formatAmountOnBlur(input);
        });
      }, 100);
    }
    
    window.handleGiftReceiptSelect = function(cardId, input) {
      const file = input.files[0];
      if (!file) return;
      
      // Check file size (10MB limit)
      const maxSize = 10 * 1024 * 1024;
      if (file.size > maxSize) {
        alert('File is over 10MB. Please choose a smaller file.');
        input.value = '';
        return;
      }
      
      window.giftReceiptFile = file;
      
      document.getElementById(`${cardId}-receipt-btn`).style.display = 'none';
      const preview = document.getElementById(`${cardId}-receipt-preview`);
      preview.style.display = 'flex';
      
      document.getElementById(`${cardId}-receipt-filename`).textContent = file.name;
      
      const thumb = document.getElementById(`${cardId}-receipt-thumb`);
      
      // Handle PDF files differently - show PDF icon instead of preview
      if (file.type === 'application/pdf') {
        thumb.src = 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%2300D68F"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 2l5 5h-5V4zM8.5 13H10v4H8.5v-4zm3.5 0h1.5v4H12v-4zm3.5 0H17v4h-1.5v-4z"/></svg>');
        thumb.alt = 'PDF';
      } else {
        const reader = new FileReader();
        reader.onload = function(e) {
          thumb.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    };
    
    window.removeGiftReceipt = function(cardId) {
      window.giftReceiptFile = null;
      document.getElementById(`${cardId}-receipt-input`).value = '';
      document.getElementById(`${cardId}-receipt-preview`).style.display = 'none';
      document.getElementById(`${cardId}-receipt-btn`).style.display = 'flex';
    };
    
    window.submitGiftAmount = function(cardId, amountType) {
      const input = document.getElementById(`${cardId}-input`);
      const amount = parseAmountValue(input.value);
      
      if (amount <= 0) {
        const wrapper = input.closest('.amount-input-wrapper');
        wrapper.style.borderColor = '#f87171';
        input.focus();
        setTimeout(() => {
          wrapper.style.borderColor = '';
        }, 2000);
        return;
      }
      
      const amountCents = Math.round(amount * 100);
      const receiptFile = amountType === 'price' ? (window.giftReceiptFile || null) : null;
      
      window.giftReceiptFile = null;
      
      handleGiftAmountConfirm(amountCents, receiptFile, amountType);
    };
    
    function addGiftContributorsCard() {
      hideInputContainer();
      
      const cardId = 'gift-contributors-card-' + Date.now();
      const initialCount = 4;
      
      // Calculate preview based on mode
      let preview = '';
      if (state.data.giftMode === 'gift_debt') {
        const shareAmount = Math.floor(state.data.totalCents / initialCount);
        preview = `Ok, that means each person should pay up <b>${formatCurrency2(shareAmount)}</b>`;
      } else {
        const suggestedAmount = Math.floor(state.data.amountTarget / initialCount);
        preview = `Suggested contribution: <b>${formatCurrency2(suggestedAmount)}</b> per person`;
      }
      
      const cardHtml = `
        <div id="${cardId}" class="chat-card">
          <div class="form-card">
            <div class="people-selector-inline">
              <div class="people-selector-controls">
                <button class="counter-btn" onclick="adjustGiftContributors('${cardId}', -1)">âˆ’</button>
                <input type="number" 
                       id="${cardId}-value" 
                       class="people-count-value" 
                       value="${initialCount}" 
                       min="2" 
                       max="99"
                       inputmode="numeric"
                       onchange="updateGiftContributorPreview('${cardId}')">
                <button class="counter-btn" onclick="adjustGiftContributors('${cardId}', 1)">+</button>
              </div>
              <span class="people-label">people</span>
            </div>
            
            <div id="${cardId}-preview" class="gift-contributor-preview">
              ${preview}
            </div>
            
            <button class="card-confirm-btn" onclick="submitGiftContributors('${cardId}')">
              Continue
            </button>
          </div>
        </div>
      `;
      
      const wrapper = document.createElement('div');
      wrapper.innerHTML = cardHtml;
      const cardElement = wrapper.firstElementChild;
      cardElement.dataset.historyIndex = historyIndex;
      chatHistory.appendChild(cardElement);
      scrollToBottom();
    }
    
    window.adjustGiftContributors = function(cardId, delta) {
      const valueEl = document.getElementById(`${cardId}-value`);
      let current = parseInt(valueEl.value) || 2;
      current = Math.max(2, Math.min(99, current + delta));
      valueEl.value = current;
      updateGiftContributorPreview(cardId);
    };
    
    window.updateGiftContributorPreview = function(cardId) {
      const valueEl = document.getElementById(`${cardId}-value`);
      const previewEl = document.getElementById(`${cardId}-preview`);
      const count = parseInt(valueEl.value) || 2;
      
      if (state.data.giftMode === 'gift_debt') {
        const shareAmount = Math.floor(state.data.totalCents / count);
        previewEl.innerHTML = `Ok, that means each person should pay up <b>${formatCurrency2(shareAmount)}</b>`;
      } else {
        const suggestedAmount = Math.floor(state.data.amountTarget / count);
        previewEl.innerHTML = `Suggested contribution: <b>${formatCurrency2(suggestedAmount)}</b> per person`;
      }
    };
    
    window.submitGiftContributors = function(cardId) {
      const valueEl = document.getElementById(`${cardId}-value`);
      const count = parseInt(valueEl.value) || 2;
      handleGiftContributorsConfirm(count);
    };
    
    function addGiftRaisingForCard() {
      hideInputContainer();
      
      const cardId = 'gift-raising-for-card-' + Date.now();
      
      const cardHtml = `
        <div id="${cardId}" class="chat-card">
          <div class="form-card">
            <div class="gift-about-section">
              <label class="gift-form-label">What are you raising money for?</label>
              <input type="text" id="${cardId}-text" 
                     class="gift-about-input" 
                     placeholder="e.g., Medical expenses, charity, travel fund..."
                     maxlength="200">
            </div>
            
            <div class="gift-media-section">
              <div class="gift-media-options">
                <input type="file" 
                       id="${cardId}-image-input" 
                       style="display: none" 
                       accept="image/*"
                       onchange="handleRaisingForImageSelect('${cardId}', this)">
                
                <button id="${cardId}-image-btn" class="gift-media-btn" onclick="document.getElementById('${cardId}-image-input').click()">
                  ðŸ“· Add Image
                </button>
                
                <button id="${cardId}-link-btn" class="gift-media-btn" onclick="toggleRaisingForLinkInput('${cardId}')">
                  ðŸ”— Add Link
                </button>
              </div>
              
              <div id="${cardId}-image-preview" class="gift-image-preview" style="display: none;">
                <img id="${cardId}-image-thumb" src="" alt="Image">
                <button class="gift-media-remove" onclick="removeRaisingForImage('${cardId}')">Ã—</button>
              </div>
              
              <div id="${cardId}-link-row" class="gift-link-row" style="display: none;">
                <input type="url" 
                       id="${cardId}-link-input" 
                       class="gift-link-input" 
                       placeholder="https://..."
                       autocomplete="off">
                <button class="gift-link-clear" onclick="clearRaisingForLink('${cardId}')">Ã—</button>
              </div>
            </div>
            
            <div class="gift-card-actions">
              <button class="card-skip-btn" onclick="submitRaisingFor('${cardId}', true)">
                Skip
              </button>
              <button class="card-confirm-btn" onclick="submitRaisingFor('${cardId}', false)">
                Continue
              </button>
            </div>
          </div>
        </div>
      `;
      
      const wrapper = document.createElement('div');
      wrapper.innerHTML = cardHtml;
      const cardElement = wrapper.firstElementChild;
      cardElement.dataset.historyIndex = historyIndex;
      chatHistory.appendChild(cardElement);
      scrollToBottom();
      
      setTimeout(() => {
        document.getElementById(`${cardId}-text`).focus();
      }, 100);
    }
    
    window.handleRaisingForImageSelect = function(cardId, input) {
      const file = input.files[0];
      if (!file) return;
      
      // Check file size (10MB limit)
      const maxSize = 10 * 1024 * 1024;
      if (file.size > maxSize) {
        alert('File is over 10MB. Please choose a smaller file.');
        input.value = '';
        return;
      }
      
      window.raisingForImageFile = file;
      
      document.getElementById(`${cardId}-image-btn`).style.display = 'none';
      const preview = document.getElementById(`${cardId}-image-preview`);
      preview.style.display = 'flex';
      
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById(`${cardId}-image-thumb`).src = e.target.result;
      };
      reader.readAsDataURL(file);
    };
    
    window.removeRaisingForImage = function(cardId) {
      window.raisingForImageFile = null;
      document.getElementById(`${cardId}-image-input`).value = '';
      document.getElementById(`${cardId}-image-preview`).style.display = 'none';
      document.getElementById(`${cardId}-image-btn`).style.display = 'flex';
    };
    
    window.toggleRaisingForLinkInput = function(cardId) {
      const row = document.getElementById(`${cardId}-link-row`);
      const btn = document.getElementById(`${cardId}-link-btn`);
      
      if (row.style.display === 'none') {
        row.style.display = 'flex';
        btn.style.display = 'none';
        document.getElementById(`${cardId}-link-input`).focus();
      }
    };
    
    window.clearRaisingForLink = function(cardId) {
      document.getElementById(`${cardId}-link-input`).value = '';
      document.getElementById(`${cardId}-link-row`).style.display = 'none';
      document.getElementById(`${cardId}-link-btn`).style.display = 'flex';
    };
    
    window.submitRaisingFor = function(cardId, isSkip) {
      const textEl = document.getElementById(`${cardId}-text`);
      const linkEl = document.getElementById(`${cardId}-link-input`);
      
      const raisingForText = isSkip ? '' : (textEl.value.trim() || '');
      const raisingForLink = isSkip ? '' : (linkEl.value.trim() || '');
      const raisingForImage = isSkip ? null : (window.raisingForImageFile || null);
      
      window.raisingForImageFile = null;
      
      handleGiftRaisingForConfirm(raisingForText, raisingForImage, raisingForLink);
    };
    
    function addGiftRaiseTargetCard() {
      hideInputContainer();
      
      const cardId = 'gift-raise-target-card-' + Date.now();
      
      const cardHtml = `
        <div id="${cardId}" class="chat-card">
          <div class="form-card">
            <div class="amount-input-wrapper">
              <span class="amount-currency">â‚¬</span>
              <input type="text" 
                     id="${cardId}-input" 
                     class="amount-input" 
                     placeholder="0.00" 
                     inputmode="decimal"
                     autocomplete="off"
                     autofocus>
            </div>
            
            <div class="gift-open-pot-section">
              <label class="gift-toggle-option" onclick="toggleOpenPot('${cardId}')">
                <input type="checkbox" id="${cardId}-open-pot" class="gift-toggle-checkbox">
                <span class="gift-toggle-switch"></span>
                <span class="gift-toggle-label">No target (open pot)</span>
              </label>
            </div>
            
            <button class="card-confirm-btn" onclick="submitRaiseTarget('${cardId}')">
              Continue
            </button>
          </div>
        </div>
      `;
      
      const wrapper = document.createElement('div');
      wrapper.innerHTML = cardHtml;
      const cardElement = wrapper.firstElementChild;
      cardElement.dataset.historyIndex = historyIndex;
      chatHistory.appendChild(cardElement);
      scrollToBottom();
      
      setTimeout(() => {
        const input = document.getElementById(`${cardId}-input`);
        input.focus();
        
        input.addEventListener('input', () => {
          formatAmountInput(input);
        });
        
        input.addEventListener('blur', () => {
          formatAmountOnBlur(input);
        });
      }, 100);
    }
    
    window.toggleOpenPot = function(cardId) {
      const checkbox = document.getElementById(`${cardId}-open-pot`);
      const input = document.getElementById(`${cardId}-input`);
      
      if (checkbox.checked) {
        input.disabled = true;
        input.value = '';
        input.placeholder = 'No target';
      } else {
        input.disabled = false;
        input.placeholder = '0.00';
        input.focus();
      }
    };
    
    window.submitRaiseTarget = function(cardId) {
      const input = document.getElementById(`${cardId}-input`);
      const openPotCheckbox = document.getElementById(`${cardId}-open-pot`);
      const isOpenPot = openPotCheckbox.checked;
      
      if (!isOpenPot) {
        const amount = parseAmountValue(input.value);
        if (amount <= 0) {
          const wrapper = input.closest('.amount-input-wrapper');
          wrapper.style.borderColor = '#f87171';
          input.focus();
          setTimeout(() => {
            wrapper.style.borderColor = '';
          }, 2000);
          return;
        }
        
        const amountCents = Math.round(amount * 100);
        handleGiftRaiseTargetConfirm(amountCents, false);
      } else {
        handleGiftRaiseTargetConfirm(0, true);
      }
    };

    // ===========================================
    // UI HELPER: Remove Active Card
    // ===========================================
    function removeActiveCard() {
      const cards = chatHistory.querySelectorAll('.chat-card');
      cards.forEach(card => card.remove());
    }
    
    function hideInputContainer() {
      inputContainer.classList.add('hidden');
    }

    function showInputContainer() {
      inputContainer.classList.remove('hidden');
    }

    // ===========================================
    // CREATE TAB (API Call)
    // ===========================================
    async function createTab() {
      // Check if we already created a tab in this session
      // (user went back and came forward again)
      if (state.data.createdTab) {
        showLaunchCard(state.data.createdTab);
        return;
      }
      
      state.step = 'CREATING';
      addBotMessage("Creating your tab...");
      
      try {
        // Use FormData to support file upload
        const formData = new FormData();
        formData.append('name', state.data.name);
        formData.append('tabType', state.data.type);
        formData.append('template', state.data.template);
        formData.append('proofRequired', 'optional');
        
        if (state.data.type === 'one_bill') {
          // For gift modes, handle amounts differently
          if (state.data.template === 'gift' && state.data.giftMode) {
            formData.append('giftMode', state.data.giftMode);
            formData.append('groupGiftMode', state.data.groupGiftMode || 'gift'); // 'gift' or 'fundraiser'
            formData.append('splitMode', 'equal'); // Gifts use equal split
            formData.append('expectedPayRate', 100);
            
            // Gift-specific fields
            if (state.data.recipientName) {
              formData.append('recipientName', state.data.recipientName);
            }
            if (state.data.aboutText) {
              formData.append('aboutText', state.data.aboutText);
            }
            if (state.data.aboutLink) {
              formData.append('aboutLink', state.data.aboutLink);
            }
            if (state.data.raisingForText) {
              formData.append('raisingForText', state.data.raisingForText);
            }
            if (state.data.raisingForLink) {
              formData.append('raisingForLink', state.data.raisingForLink);
            }
            formData.append('isRaisingMoneyOnly', state.data.isRaisingMoneyOnly);
            formData.append('isOpenPot', state.data.isOpenPot);
            
            if (state.data.giftMode === 'gift_debt') {
              // Already bought: use totalCents as the debt amount
              formData.append('totalAmountCents', state.data.totalCents);
              formData.append('peopleCount', state.data.contributorCount || state.data.people);
              formData.append('contributorCount', state.data.contributorCount || state.data.people);
            } else if (state.data.giftMode === 'gift_pot_target') {
              // Pot with target
              formData.append('amountTarget', state.data.amountTarget);
              formData.append('totalAmountCents', 0); // No debt
              if (state.data.contributorCount) {
                formData.append('peopleCount', state.data.contributorCount);
                formData.append('contributorCount', state.data.contributorCount);
              } else {
                formData.append('peopleCount', 1); // Will be updated as people join
              }
            } else if (state.data.giftMode === 'gift_pot_open') {
              // Open pot (no target)
              formData.append('amountTarget', 0);
              formData.append('totalAmountCents', 0); // No debt
              formData.append('peopleCount', 1); // Will be updated as people join
            }
            
            // Add about image if present
            if (state.data.aboutImage) {
              formData.append('aboutImage', state.data.aboutImage);
            }
            // Add raising for image if present
            if (state.data.raisingForImage) {
              formData.append('raisingForImage', state.data.raisingForImage);
            }
          } else {
            // Regular restaurant bill flow
          formData.append('totalAmountCents', state.data.totalCents + state.data.tipCents);
          formData.append('splitMode', state.data.splitMode);
          formData.append('expectedPayRate', 100);
          formData.append('peopleCount', state.data.people);
          
          // Include price groups if using price_groups split mode
          if (state.data.splitMode === 'price_groups' && state.data.priceGroups.length > 0) {
            formData.append('priceGroups', JSON.stringify(state.data.priceGroups));
            // Include which group the host belongs to
            if (state.data.hostGroupId) {
              formData.append('hostGroupId', state.data.hostGroupId);
              }
            }
          }
        }
        
        // Add receipt file if present
        if (state.data.receiptFile) {
          formData.append('receipt', state.data.receiptFile);
        }
        
        // Add payment methods if present
        if (state.data.paymentMethods && state.data.paymentMethods.length > 0) {
          formData.append('paymentMethodsJson', JSON.stringify(state.data.paymentMethods));
        }
        
        const response = await fetch('/api/grouptabs', {
          method: 'POST',
          body: formData
        });
        
        // Check if response is JSON before parsing
        const contentType = response.headers.get('content-type');
        let data;
        
        if (contentType && contentType.includes('application/json')) {
          data = await response.json();
        } else {
          // Response is not JSON (likely HTML error page)
          console.error('Server returned non-JSON response:', await response.text());
          throw new Error('Server error. Please try again.');
        }
        
        if (!response.ok) {
          throw new Error(data.error || 'Failed to create tab');
        }
        
        // Store the created tab so we don't create duplicates if user goes back
        state.data.createdTab = data.tab;
        
        // Show success with share card
        showLaunchCard(data.tab);
        
      } catch (error) {
        console.error('Error creating tab:', error);
        // Show friendly error message to user
        const friendlyMessage = error.message.includes('Unexpected token') 
          ? 'Something went wrong while creating your GroupTab. Please try again.'
          : error.message;
        addBotMessage(`Oops! ${friendlyMessage}`);
        showInputContainer();
      }
    }
    
    function showGoDutchComingSoon() {
      hideInputContainer();
      
      const card = document.createElement('div');
      card.className = 'coming-soon-card';
      card.id = 'go-dutch-coming-soon';
      card.dataset.historyIndex = historyIndex;
      
      card.innerHTML = `
        <div class="coming-soon-flag">ðŸ‡³ðŸ‡±</div>
        <div class="coming-soon-title">Going Dutch? Not Yet!</div>
        <div class="coming-soon-text">This one's still in the oven.<br>Try Equal Split or Price Groups instead!</div>
        <button class="coming-soon-back-btn" onclick="goBackFromComingSoon()">â† Back to Options</button>
      `;
      
      chatHistory.appendChild(card);
      scrollToBottom();
    }
    
    function goBackFromComingSoon() {
      // Remove the coming soon card
      const card = document.getElementById('go-dutch-coming-soon');
      if (card) card.remove();
      
      // Use the undo functionality to go back to split selection
      undoStep();
    }
    
    function goBackFromLaunchCard() {
      // Remove the launch card and any "Creating your tab..." messages
      const cards = document.querySelectorAll('.chat-card');
      cards.forEach(card => {
        if (card.querySelector('.launch-card')) {
          card.remove();
        }
      });
      
      // Remove "Creating your tab..." bot message
      const messages = document.querySelectorAll('.msg-bot');
      messages.forEach(msg => {
        if (msg.textContent.includes('Creating your tab')) {
          msg.remove();
        }
      });
      
      // Go back to the previous step using undo
      undoStep();
    }
    
    function showLaunchCard(tab) {
      hideInputContainer();
      
      // Use short tab link for sharing (user-friendly)
      const code = tab.inviteCode || tab.magicToken;
      const shareUrl = tab.tabLink || `${window.location.origin}/tab/${code}`;
      const viewUrl = `${window.location.origin}/tab/${code}`;
      const totalCents = state.data.totalCents + state.data.tipCents;
      const perPerson = formatCurrency2(totalCents / state.data.people);
      
      // Build price groups display if applicable
      let detailHtml = `${state.data.people} people Â· ${perPerson} each`;
      let hasPriceGroups = false;
      
      // Store tab info for group selection
      window.createdTab = tab;
      
      if (state.data.splitMode === 'price_groups' && state.data.priceGroups.length > 0) {
        hasPriceGroups = true;
        detailHtml = `${state.data.people} people Â· Price Groups`;
      }
      
      // Show success message
      addBotMessage("Tab created! ðŸš€");
      
      // Generate QR code URL
      const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=140x140&bgcolor=0e1116&color=00D68F&data=${encodeURIComponent(shareUrl)}`;
      
      const cardHtml = `
        <div class="chat-card">
          <div class="form-card launch-card" style="position: relative;">
            <button class="launch-card-back" onclick="goBackFromLaunchCard()" title="Go back">â†</button>
            <div class="launch-card-title">${escapeHtml(state.data.name)}</div>
            <div class="launch-card-amount">${formatCurrency2(totalCents)}</div>
            <div class="launch-card-detail">${detailHtml}</div>
            
            <div class="launch-card-qr">
              <img src="${qrCodeUrl}" alt="QR Code" class="qr-code-img">
            </div>
            
            <div class="launch-card-actions">
              <button class="share-btn share-btn-primary" onclick="copyShareLink('${shareUrl}')">
                ðŸ“‹ Copy Share Link
              </button>
              
              <button class="share-btn share-btn-secondary" onclick="window.location.href='${viewUrl}'">
                ðŸ‘€ View GroupTab
              </button>
            </div>
          </div>
        </div>
      `;
      
      const wrapper = document.createElement('div');
      wrapper.innerHTML = cardHtml;
      const cardElement = wrapper.firstElementChild;
      cardElement.dataset.historyIndex = historyIndex; // Tag with history index
      chatHistory.appendChild(cardElement);
      scrollToBottom();
    }
    
    window.showReceiptModal = function(src) {
      // Simple lightbox for receipt
      const overlay = document.createElement('div');
      overlay.className = 'receipt-lightbox';
      overlay.onclick = () => overlay.remove();
      overlay.innerHTML = `<img src="${src}" alt="Receipt">`;
      document.body.appendChild(overlay);
    };
    
    window.copyShareLink = async function(url) {
      try {
        await navigator.clipboard.writeText(url);
        // Visual feedback
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = 'âœ“ Copied!';
        btn.style.background = '#22c55e';
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.style.background = '';
        }, 2000);
      } catch (err) {
        // Fallback: show URL in prompt
        prompt('Copy this link:', url);
      }
    };

    // ===========================================
    // BASIC UI HELPERS
    // ===========================================
    function addBotMessage(html) {
      const div = document.createElement('div');
      div.className = 'msg msg-bot';
      div.innerHTML = html;
      div.dataset.historyIndex = historyIndex; // Tag with history index
      chatHistory.appendChild(div);
      scrollToBottom();
    }

    function addUserMessage(text) {
      const div = document.createElement('div');
      div.className = 'msg msg-user msg-clickable';
      div.textContent = text;
      div.dataset.historyIndex = historyIndex; // Tag with history index
      div.title = 'Click to edit';
      div.onclick = function() {
        const idx = parseInt(this.dataset.historyIndex);
        // Go back to the step where this answer was given (user message and bot question share same historyIndex)
        undoToIndex(idx);
      };
      chatHistory.appendChild(div);
      scrollToBottom();
    }
    
    function showTyping() {
      const div = document.createElement('div');
      div.className = 'typing-indicator';
      div.id = 'typing-indicator';
      div.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
      chatHistory.appendChild(div);
      scrollToBottom();
    }
    
    function removeTyping() {
      const indicator = document.getElementById('typing-indicator');
      if (indicator) indicator.remove();
    }

    function scrollToBottom() {
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initialize header
    if (window.PayFriendsHeader) window.PayFriendsHeader.initialize({ hasActivitySection: false });
  </script>
  </div>
</body>
</html>
