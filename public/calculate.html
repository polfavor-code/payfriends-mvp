<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Repayment Calculator Playground - PayFriends</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #0c1015 0%, #1a1f2e 100%);
      color: #e5e7eb;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: rgba(31, 41, 55, 0.6);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 8px;
      color: #fff;
    }

    .subtitle {
      color: #9ca3af;
      font-size: 14px;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }

    @media (max-width: 1024px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: rgba(31, 41, 55, 0.6);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 24px;
    }

    .card h2 {
      font-size: 18px;
      margin-bottom: 20px;
      color: #fff;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 8px;
      color: #d1d5db;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      background: rgba(12, 16, 21, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 10px 12px;
      color: #e5e7eb;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: rgba(59, 130, 246, 0.5);
    }

    .form-group input:disabled,
    .form-group select:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .form-group input[type="number"] {
      font-variant-numeric: tabular-nums;
    }

    .form-hint {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 6px;
      font-style: italic;
    }

    .btn {
      width: 100%;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.2s;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .btn:active {
      transform: translateY(0);
    }

    .totals {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .total-card {
      background: rgba(12, 16, 21, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      padding: 16px;
    }

    .total-label {
      font-size: 12px;
      text-transform: uppercase;
      color: #9ca3af;
      margin-bottom: 8px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .total-value {
      font-size: 24px;
      font-weight: 700;
      color: #fff;
      font-variant-numeric: tabular-nums;
    }

    .schedule-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .schedule-subtitle {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 16px;
    }

    .schedule-table {
      overflow-x: auto;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      background: rgba(12, 16, 21, 0.8);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead th {
      background: rgba(31, 41, 55, 0.98);
      padding: 12px;
      text-align: left;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      color: #9ca3af;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    thead th.align-right {
      text-align: right;
    }

    tbody td {
      padding: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      color: #d1d5db;
    }

    tbody td.align-right {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    tbody tr:nth-child(even) {
      background: rgba(10, 13, 17, 0.6);
    }

    tbody tr:hover {
      background: rgba(55, 65, 81, 0.3);
    }

    tfoot td {
      padding: 16px 12px;
      border-top: 2px solid rgba(59, 130, 246, 0.5);
      background: rgba(59, 130, 246, 0.1);
      font-weight: 700;
      color: #fff;
      font-size: 14px;
    }

    tfoot td.align-right {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    tfoot td:first-child {
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #60a5fa;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge-preview {
      background: rgba(59, 130, 246, 0.2);
      color: #60a5fa;
    }

    .badge-actual {
      background: rgba(16, 185, 129, 0.2);
      color: #34d399;
    }

    .info-box {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 8px;
      padding: 12px;
      margin-top: 16px;
      font-size: 13px;
      color: #93c5fd;
      line-height: 1.5;
    }

    .debug-console {
      background: rgba(12, 16, 21, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      padding: 16px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      color: #a5f3fc;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .error-message {
      color: #ef4444;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ðŸ§® Repayment Calculator Playground</h1>
      <p class="subtitle">Internal testing tool for the new repayment schedule generator â€¢ Single source of truth validation</p>
    </div>

    <div class="main-grid">
      <!-- Left sidebar: Form inputs -->
      <div class="card">
        <h2>Configuration</h2>

        <div class="form-group">
          <label for="principal">Loan amount (â‚¬)</label>
          <input type="number" id="principal" value="6000" min="100" step="100">
        </div>

        <div class="form-group">
          <label for="interest">Annual interest rate (%)</label>
          <input type="number" id="interest" value="5" min="0" max="100" step="0.1">
        </div>

        <div class="form-group">
          <label for="repaymentType">Repayment type</label>
          <select id="repaymentType">
            <option value="installments" selected>Installments</option>
            <option value="one_time">1-time payment</option>
          </select>
        </div>

        <div class="form-group" id="installmentsGroup">
          <label for="numInstallments">Number of installments</label>
          <input type="number" id="numInstallments" value="12" min="1" max="120" step="1">
          <div class="form-hint" id="installmentsHint" style="display: none;">
            For 1-time payments the loan is repaid in a single payment.
          </div>
        </div>

        <div class="form-group" id="frequencyGroup">
          <label for="frequency">Payment frequency</label>
          <select id="frequency">
            <optgroup label="Day-based">
              <option value="every-3-days">Every 3 days</option>
              <option value="every-7-days">Every 7 days (weekly)</option>
              <option value="every-14-days">Every 14 days</option>
              <option value="every-30-days">Every 30 days</option>
              <option value="every-60-days">Every 60 days</option>
            </optgroup>
            <optgroup label="Month-based">
              <option value="every-month" selected>Every month (same day of month)</option>
              <option value="every-2-months">Every 2 months</option>
              <option value="every-3-months">Every 3 months</option>
              <option value="every-6-months">Every 6 months</option>
              <option value="every-12-months">Every 12 months</option>
            </optgroup>
            <optgroup label="Weekday-based">
              <option value="every-week">Every week (same weekday)</option>
              <option value="every-2-weeks">Every 2 weeks</option>
              <option value="every-4-weeks">Every 4 weeks</option>
            </optgroup>
            <optgroup label="Year-based">
              <option value="every-year">Every year (same date)</option>
            </optgroup>
          </select>
        </div>

        <div class="form-group" id="firstPaymentGroup">
          <label for="firstPaymentDue">
            <span id="paymentTimingLabel">First payment due</span>
          </label>
          <select id="firstPaymentDue">
            <option value="3-days">In 3 days after loan start</option>
            <option value="7-days">In 7 days after loan start</option>
            <option value="1-month" selected>In 1 month after loan start</option>
            <option value="2-months">In 2 months after loan start</option>
            <option value="3-months">In 3 months after loan start</option>
            <option value="6-months">In 6 months after loan start</option>
            <option value="12-months">In 12 months after loan start</option>
            <option value="pick-date">Pick a dateâ€¦</option>
          </select>
          <div class="form-hint">Select when the repayment is due after the loan starts.</div>
        </div>

        <div class="form-group" id="firstPaymentDateGroup" style="display: none;">
          <label for="firstPaymentDate">First payment date</label>
          <input type="date" id="firstPaymentDate">
        </div>

        <div class="form-group">
          <label for="loanStartMode">Loan start date (when borrower receives the money)</label>
          <select id="loanStartMode">
            <option value="upon_acceptance" selected>When agreement is accepted</option>
            <option value="today">Today</option>
            <option value="tomorrow">Tomorrow</option>
            <option value="in-3-days">In 3 days</option>
            <option value="in-7-days">In 7 days</option>
            <option value="pick-date">Pick a dateâ€¦</option>
          </select>
          <div class="form-hint">This marks the date the loan officially begins for interest and repayment calculations.</div>
        </div>

        <div class="form-group" id="loanStartDateGroup" style="display: none;">
          <label for="loanStartDate">Loan start date</label>
          <input type="date" id="loanStartDate">
        </div>

        <div class="form-group">
          <label for="contextMode">Context mode</label>
          <select id="contextMode">
            <option value="preview" selected>Preview mode (no real date)</option>
            <option value="actual">Actual mode (known loan start)</option>
          </select>
        </div>

        <div class="form-group">
          <button class="btn" onclick="calculateSchedule()">Calculate schedule</button>
        </div>

        <div class="info-box">
          <strong>Preview mode (no real date):</strong> Shows relative labels like "1 month after loan start". Use when loan start is "When agreement is accepted".<br>
          <strong>Actual mode (known loan start):</strong> Shows real calendar dates when loan start date is known or simulated (e.g., today).<br>
          <strong>Note:</strong> When loan start has a specific date, actual mode is used automatically regardless of context setting.
        </div>
      </div>

      <!-- Right side: Results -->
      <div>
        <!-- Schedule table -->
        <div class="card">
          <div class="schedule-header">
            <h2>Repayment Schedule</h2>
            <span id="modeBadge"></span>
          </div>
          <div class="schedule-subtitle" id="loanStartLabel">
            Loan start: Click "Calculate schedule" to generate...
          </div>
          <div class="schedule-table">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Due date</th>
                  <th class="align-right">Principal</th>
                  <th class="align-right">Interest</th>
                  <th class="align-right">Total payment</th>
                  <th class="align-right">Balance</th>
                </tr>
              </thead>
              <tbody id="scheduleBody">
                <tr>
                  <td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">
                    Click "Calculate schedule" to generate repayment schedule...
                  </td>
                </tr>
              </tbody>
              <tfoot id="scheduleTotals" style="display: none;">
                <tr>
                  <td colspan="2" style="text-align: left;">Loan totals</td>
                  <td class="align-right" id="footerPrincipal">â‚¬ 0,00</td>
                  <td class="align-right" id="footerInterest">â‚¬ 0,00</td>
                  <td class="align-right" id="footerTotal">â‚¬ 0,00</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <!-- Debug console -->
        <div class="card" style="margin-top: 24px;">
          <h2>Debug Console</h2>
          <div class="debug-console" id="debugConsole">
Click "Calculate schedule" to see calculation details...
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/formatters.js"></script>
  <script>
    // Calculator Playground Logic - Single Source of Truth
    // This generateRepaymentSchedule function can be reused across wizard, manage, and review pages

    // Get formatting functions from window
    const formatMoney = window.formatCurrency2;

    /**
     * Add days to a date
     */
    function addDays(date, days) {
      const result = new Date(date);
      result.setDate(result.getDate() + days);
      return result;
    }

    /**
     * Add months to a date, handling month-end edge cases
     */
    function addMonths(date, months) {
      const result = new Date(date);
      const targetMonth = result.getMonth() + months;
      const targetYear = result.getFullYear() + Math.floor(targetMonth / 12);
      const normalizedMonth = ((targetMonth % 12) + 12) % 12;

      const originalDay = result.getDate();
      result.setFullYear(targetYear, normalizedMonth, 1);
      const daysInTargetMonth = new Date(targetYear, normalizedMonth + 1, 0).getDate();
      const clampedDay = Math.min(originalDay, daysInTargetMonth);
      result.setDate(clampedDay);

      return result;
    }

    /**
     * Add years to a date, handling Feb 29 edge case
     */
    function addYears(date, years) {
      const result = new Date(date);
      const targetYear = result.getFullYear() + years;
      const originalMonth = result.getMonth();
      const originalDay = result.getDate();

      // Handle Feb 29 in leap year -> non-leap year
      if (originalMonth === 1 && originalDay === 29) {
        const isLeapYear = (targetYear % 4 === 0 && targetYear % 100 !== 0) || (targetYear % 400 === 0);
        if (!isLeapYear) {
          result.setFullYear(targetYear, 1, 28);
          return result;
        }
      }

      result.setFullYear(targetYear, originalMonth, originalDay);
      return result;
    }

    /**
     * Format date for display
     */
    function formatDateDisplay(dateInput) {
      const date = typeof dateInput === 'string' ? new Date(dateInput) : dateInput;
      const day = date.getDate();
      const month = date.toLocaleDateString('en-GB', { month: 'short' });
      const year = date.getFullYear();
      return `${day} ${month} ${year}`;
    }

    /**
     * SINGLE SOURCE OF TRUTH: Generate complete repayment schedule
     * This function is reusable across wizard, manage, and review pages
     *
     * @param {Object} config - Configuration object
     * @returns {Object} - Complete schedule data with rows, totals, and labels
     */
    function generateRepaymentSchedule({
      loanAmount,
      annualInterestRate,
      repaymentType,
      numberOfInstallments,
      paymentFrequency,
      firstPaymentDays,
      firstPaymentMonths = 1,
      loanStartMode,
      contextMode,
      explicitLoanStartDate
    }) {
      const debugMessages = [];

      // STEP 1: Determine effective mode
      // Rule: If loan start has a real date (not upon_acceptance), ALWAYS use actual mode
      let effectiveMode = contextMode;
      if (loanStartMode !== 'upon_acceptance') {
        effectiveMode = 'actual';
        debugMessages.push('Loan start has real date, forcing actual mode');
      }

      // STEP 2: Determine loan start date
      let loanStartDate = explicitLoanStartDate;
      if (!loanStartDate && loanStartMode === 'upon_acceptance' && effectiveMode === 'actual') {
        // Upon acceptance + actual mode: use today
        loanStartDate = new Date();
        loanStartDate.setHours(0, 0, 0, 0);
      }

      // STEP 3: Determine loan start label
      let loanStartLabel;
      if (loanStartDate) {
        loanStartLabel = `Loan start: ${formatDateDisplay(loanStartDate)}`;
      } else {
        // Preview mode with unknown date
        loanStartLabel = 'Loan start: When agreement is accepted';
      }

      // STEP 4: Setup interest calculation
      const annualRate = annualInterestRate / 100;
      const dailyRate = annualRate / 365;

      // Determine period configuration
      let periodDays;
      let periodType; // 'days', 'months', 'weeks', or 'years'
      let periodMultiplier; // for "every 2 months", "every 3 months", etc.
      let periodLabel;

      switch (paymentFrequency) {
        // Day-based frequencies
        case 'every-3-days':
          periodDays = 3;
          periodType = 'days';
          periodMultiplier = 1;
          periodLabel = 'Every 3 days';
          break;
        case 'every-7-days':
          periodDays = 7;
          periodType = 'days';
          periodMultiplier = 1;
          periodLabel = 'Every 7 days (weekly)';
          break;
        case 'every-14-days':
          periodDays = 14;
          periodType = 'days';
          periodMultiplier = 1;
          periodLabel = 'Every 14 days';
          break;
        case 'every-30-days':
          periodDays = 30;
          periodType = 'days';
          periodMultiplier = 1;
          periodLabel = 'Every 30 days';
          break;
        case 'every-60-days':
          periodDays = 60;
          periodType = 'days';
          periodMultiplier = 1;
          periodLabel = 'Every 60 days';
          break;

        // Month-based frequencies
        case 'every-month':
          periodDays = 30; // approximate for interest
          periodType = 'months';
          periodMultiplier = 1;
          periodLabel = 'Every month (same day of month)';
          break;
        case 'every-2-months':
          periodDays = 60;
          periodType = 'months';
          periodMultiplier = 2;
          periodLabel = 'Every 2 months';
          break;
        case 'every-3-months':
          periodDays = 91;
          periodType = 'months';
          periodMultiplier = 3;
          periodLabel = 'Every 3 months';
          break;
        case 'every-6-months':
          periodDays = 182;
          periodType = 'months';
          periodMultiplier = 6;
          periodLabel = 'Every 6 months';
          break;
        case 'every-12-months':
          periodDays = 365;
          periodType = 'months';
          periodMultiplier = 12;
          periodLabel = 'Every 12 months';
          break;

        // Weekday-based frequencies
        case 'every-week':
          periodDays = 7;
          periodType = 'weeks';
          periodMultiplier = 1;
          periodLabel = 'Every week (same weekday)';
          break;
        case 'every-2-weeks':
          periodDays = 14;
          periodType = 'weeks';
          periodMultiplier = 2;
          periodLabel = 'Every 2 weeks';
          break;
        case 'every-4-weeks':
          periodDays = 28;
          periodType = 'weeks';
          periodMultiplier = 4;
          periodLabel = 'Every 4 weeks';
          break;

        // Year-based frequency
        case 'every-year':
          periodDays = 365; // approximate for interest
          periodType = 'years';
          periodMultiplier = 1;
          periodLabel = 'Every year (same date)';
          break;

        default:
          periodDays = 30;
          periodType = 'months';
          periodMultiplier = 1;
          periodLabel = 'Every month';
      }

      debugMessages.push(`Annual interest rate: ${annualInterestRate}%`);
      debugMessages.push(`Repayment type: ${repaymentType === 'one_time' ? '1-time payment' : 'Installments'}`);
      debugMessages.push(`Number of installments: ${numberOfInstallments}`);
      debugMessages.push(`Payment frequency: ${periodLabel}`);
      debugMessages.push(`First payment timing: ${firstPaymentDays} days after loan start`);
      debugMessages.push(`Loan start mode: ${loanStartMode === 'fixed_date' ? 'Fixed date' : 'Upon agreement acceptance'}`);
      debugMessages.push(`Effective mode: ${effectiveMode === 'actual' ? 'Actual (real dates)' : 'Preview (relative labels)'}`);

      // STEP 5: Generate schedule rows
      const rows = [];
      const principalPerPayment = loanAmount / numberOfInstallments;
      let remainingBalance = loanAmount;
      let totalInterest = 0;

      for (let i = 0; i < numberOfInstallments; i++) {
        const paymentIndex = i + 1;

        // Calculate interest for this period
        let daysForThisPeriod;
        if (i === 0) {
          // First payment: use firstPaymentDays
          daysForThisPeriod = firstPaymentDays;
        } else {
          // Subsequent payments: use period length
          daysForThisPeriod = periodDays;
        }

        const interestForPeriod = remainingBalance * dailyRate * daysForThisPeriod;
        const principalPayment = principalPerPayment;
        const totalPayment = principalPayment + interestForPeriod;

        totalInterest += interestForPeriod;
        remainingBalance -= principalPayment;
        if (remainingBalance < 0.01) remainingBalance = 0;

        // Generate due date label
        let dueDateLabel;
        let dueDate = null;

        if (effectiveMode === 'preview') {
          // PREVIEW MODE: Use relative labels, no real dates
          if (periodType === 'years') {
            // Yearly frequency
            const yearsAfterStart = i + 1;
            if (yearsAfterStart === 1) {
              dueDateLabel = '1 year after loan start';
            } else {
              dueDateLabel = `${yearsAfterStart} years after loan start`;
            }
          } else if (periodType === 'months') {
            // Monthly frequency - show months after start
            let monthsAfterStart;
            if (i === 0) {
              // First payment: use firstPaymentMonths
              monthsAfterStart = firstPaymentMonths;
            } else {
              // Subsequent payments: add period multiplier
              monthsAfterStart = firstPaymentMonths + (i * periodMultiplier);
            }

            if (monthsAfterStart === 0) {
              dueDateLabel = 'On loan start';
            } else if (monthsAfterStart === 1) {
              dueDateLabel = '1 month after loan start';
            } else {
              dueDateLabel = `${monthsAfterStart} months after loan start`;
            }
          } else if (periodType === 'weeks') {
            // Week-based frequency (weekday-based)
            const totalDays = (i === 0) ? firstPaymentDays : (firstPaymentDays + i * periodDays);
            if (totalDays === 0) {
              dueDateLabel = 'On loan start';
            } else {
              dueDateLabel = `${totalDays} days after loan start`;
            }
          } else {
            // Day-based frequency
            const totalDays = (i === 0) ? firstPaymentDays : (firstPaymentDays + i * periodDays);
            if (totalDays === 0) {
              dueDateLabel = 'On loan start';
            } else {
              dueDateLabel = `${totalDays} days after loan start`;
            }
          }
        } else {
          // ACTUAL MODE: Calculate real calendar dates
          if (loanStartDate) {
            if (periodType === 'years') {
              // Yearly: add years properly
              dueDate = addYears(loanStartDate, i + 1);
            } else if (periodType === 'months') {
              // Monthly: add months properly (with multiplier)
              let monthsToAdd;
              if (i === 0) {
                monthsToAdd = firstPaymentMonths;
              } else {
                monthsToAdd = firstPaymentMonths + (i * periodMultiplier);
              }
              dueDate = addMonths(loanStartDate, monthsToAdd);
            } else if (periodType === 'weeks') {
              // Week-based: add days (preserves weekday)
              const daysToAdd = (i === 0) ? firstPaymentDays : (firstPaymentDays + i * periodDays);
              dueDate = addDays(loanStartDate, daysToAdd);
            } else {
              // Day-based: add days
              const daysToAdd = (i === 0) ? firstPaymentDays : (firstPaymentDays + i * periodDays);
              dueDate = addDays(loanStartDate, daysToAdd);
            }
            dueDateLabel = formatDateDisplay(dueDate);
          } else {
            dueDateLabel = 'Date not available';
          }
        }

        rows.push({
          index: paymentIndex,
          label: dueDateLabel,
          dueDate: dueDate,
          principal: Math.round(principalPayment * 100), // cents
          interest: Math.round(interestForPeriod * 100), // cents
          totalPayment: Math.round(totalPayment * 100), // cents
          balance: Math.round(remainingBalance * 100) // cents
        });
      }

      // STEP 6: Calculate totals
      const totals = {
        principal: Math.round(loanAmount * 100), // should equal sum of all principal
        interest: Math.round(totalInterest * 100),
        totalRepayment: Math.round((loanAmount + totalInterest) * 100)
      };

      debugMessages.push(`Generated ${rows.length} payment(s)`);

      return {
        rows,
        totals,
        loanStartLabel,
        effectiveMode,
        debugMessages
      };
    }

    // Export for potential reuse in other pages
    window.PayFriendsRepayment = {
      generateRepaymentSchedule
    };

    /**
     * Update UI based on repayment type
     */
    function updateRepaymentTypeUI() {
      const repaymentType = document.getElementById('repaymentType').value;
      const isOneTime = repaymentType === 'one_time';

      const numInstallmentsGroup = document.getElementById('numInstallments').closest('.form-group');
      const frequencyGroup = document.getElementById('frequencyGroup');
      const installmentsHint = document.getElementById('installmentsHint');
      const paymentTimingLabel = document.getElementById('paymentTimingLabel');

      if (isOneTime) {
        // 1-time payment mode

        // 1) Change label to "Repayment due date"
        paymentTimingLabel.textContent = 'Repayment due date';

        // 2) Lock installments to 1 and hide
        document.getElementById('numInstallments').value = 1;
        numInstallmentsGroup.style.display = 'none';

        // 3) Hide frequency (not applicable for 1-time)
        frequencyGroup.style.display = 'none';

        // 4) Show hint about 1-time payment
        installmentsHint.style.display = 'block';
      } else {
        // Installments mode

        // 1) Change label to "First payment due"
        paymentTimingLabel.textContent = 'First payment due';

        // 2) Show and enable installments
        numInstallmentsGroup.style.display = 'block';

        // 3) Show frequency
        frequencyGroup.style.display = 'block';

        // 4) Hide hint
        installmentsHint.style.display = 'none';
      }
    }

    // Show/hide conditional fields based on repayment type
    document.getElementById('repaymentType').addEventListener('change', updateRepaymentTypeUI);

    // Show/hide loan start date picker
    document.getElementById('loanStartMode').addEventListener('change', function() {
      const loanStartDateGroup = document.getElementById('loanStartDateGroup');
      loanStartDateGroup.style.display = this.value === 'pick-date' ? 'block' : 'none';
    });

    // Show/hide first payment date picker
    document.getElementById('firstPaymentDue').addEventListener('change', function() {
      const firstPaymentDateGroup = document.getElementById('firstPaymentDateGroup');
      firstPaymentDateGroup.style.display = this.value === 'pick-date' ? 'block' : 'none';
    });

    /**
     * Helper function to calculate loan start date from dropdown
     */
    function calculateLoanStartDate(loanStartMode, explicitLoanStartDate) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      switch (loanStartMode) {
        case 'upon_acceptance':
          return null; // Unknown date (will be determined by context mode)
        case 'today':
          return today;
        case 'tomorrow':
          return addDays(today, 1);
        case 'in-3-days':
          return addDays(today, 3);
        case 'in-7-days':
          return addDays(today, 7);
        case 'pick-date':
          return explicitLoanStartDate ? new Date(explicitLoanStartDate) : null;
        default:
          return null;
      }
    }

    /**
     * Helper function to calculate first payment timing
     * Returns {days, months, isMonthBased}
     */
    function calculateFirstPaymentTiming(firstPaymentDue, firstPaymentDate, loanStartDate) {
      switch (firstPaymentDue) {
        case '3-days':
          return { days: 3, months: 0, isMonthBased: false };
        case '7-days':
          return { days: 7, months: 0, isMonthBased: false };
        case '1-month':
          return { days: 30, months: 1, isMonthBased: true };
        case '2-months':
          return { days: 60, months: 2, isMonthBased: true };
        case '3-months':
          return { days: 91, months: 3, isMonthBased: true };
        case '6-months':
          return { days: 182, months: 6, isMonthBased: true };
        case '12-months':
          return { days: 365, months: 12, isMonthBased: true };
        case 'pick-date':
          if (firstPaymentDate && loanStartDate) {
            const start = new Date(loanStartDate);
            const payment = new Date(firstPaymentDate);
            const daysDiff = Math.round((payment - start) / (1000 * 60 * 60 * 24));
            return { days: daysDiff, months: 0, isMonthBased: false };
          }
          // If loan start is unknown, just use 30 days as default
          return { days: 30, months: 1, isMonthBased: true };
        default:
          return { days: 30, months: 1, isMonthBased: true };
      }
    }

    /**
     * Main calculation function triggered by button click
     */
    function calculateSchedule() {
      try {
        // Gather form data
        const loanAmount = parseFloat(document.getElementById('principal').value);
        const annualInterestRate = parseFloat(document.getElementById('interest').value);
        const repaymentType = document.getElementById('repaymentType').value;
        const numberOfInstallments = parseInt(document.getElementById('numInstallments').value);
        const paymentFrequency = document.getElementById('frequency').value;
        const firstPaymentDueOption = document.getElementById('firstPaymentDue').value;
        const firstPaymentDate = document.getElementById('firstPaymentDate').value;
        const loanStartMode = document.getElementById('loanStartMode').value;
        const contextMode = document.getElementById('contextMode').value;
        const explicitLoanStartDate = document.getElementById('loanStartDate').value;

        // Validation
        const errors = [];
        if (!loanAmount || loanAmount <= 0 || isNaN(loanAmount)) {
          errors.push('Please enter a positive loan amount.');
        }
        if (isNaN(annualInterestRate) || annualInterestRate < 0) {
          errors.push('Interest rate cannot be negative.');
        }
        if (repaymentType === 'installments' && (!numberOfInstallments || numberOfInstallments < 1 || isNaN(numberOfInstallments))) {
          errors.push('Number of installments must be at least 1.');
        }
        if (loanStartMode === 'pick-date' && !explicitLoanStartDate) {
          errors.push('Please select a loan start date when using "Pick a dateâ€¦"');
        }
        if (firstPaymentDueOption === 'pick-date' && !firstPaymentDate) {
          errors.push('Please select a first payment date when using "Pick a dateâ€¦"');
        }

        if (errors.length > 0) {
          document.getElementById('debugConsole').innerHTML =
            '<span class="error-message">âš  Validation errors:</span>\n' +
            errors.map(e => `  â€¢ ${e}`).join('\n');
          return;
        }

        // Calculate actual loan start date (or null if unknown)
        let calculatedLoanStartDate = calculateLoanStartDate(loanStartMode, explicitLoanStartDate);

        // Calculate first payment timing
        const firstPaymentTiming = calculateFirstPaymentTiming(
          firstPaymentDueOption,
          firstPaymentDate,
          calculatedLoanStartDate
        );
        const firstPaymentDays = firstPaymentTiming.days;
        const firstPaymentMonths = firstPaymentTiming.months;

        // Determine effective mode and loan start date
        // Rule: If loan start is known (not upon_acceptance), always use actual mode
        let effectiveLoanStartMode = loanStartMode;
        let effectiveContextMode = contextMode;

        if (loanStartMode !== 'upon_acceptance') {
          // We have a real date, force actual mode
          effectiveContextMode = 'actual';
        } else if (contextMode === 'actual') {
          // upon_acceptance + actual mode = treat as today
          calculatedLoanStartDate = new Date();
          calculatedLoanStartDate.setHours(0, 0, 0, 0);
        }

        // Generate schedule using single source of truth
        const result = generateRepaymentSchedule({
          loanAmount,
          annualInterestRate,
          repaymentType,
          numberOfInstallments,
          paymentFrequency,
          firstPaymentDays,
          firstPaymentMonths,
          loanStartMode: effectiveLoanStartMode,
          contextMode: effectiveContextMode,
          explicitLoanStartDate: calculatedLoanStartDate
        });

        // Update UI - Schedule header
        const badge = result.effectiveMode === 'preview'
          ? '<span class="badge badge-preview">Preview</span>'
          : '<span class="badge badge-actual">Actual</span>';
        document.getElementById('modeBadge').innerHTML = badge;
        document.getElementById('loanStartLabel').textContent = `Loan start: ${result.loanStartLabel}`;

        // Update UI - Schedule table body
        const tbody = document.getElementById('scheduleBody');
        tbody.innerHTML = '';

        result.rows.forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${row.index}</td>
            <td>${row.label}</td>
            <td class="align-right">${formatMoney(row.principal)}</td>
            <td class="align-right">${formatMoney(row.interest)}</td>
            <td class="align-right" style="font-weight: 600;">${formatMoney(row.totalPayment)}</td>
            <td class="align-right">${formatMoney(row.balance)}</td>
          `;
          tbody.appendChild(tr);
        });

        // Update UI - Schedule table footer (totals row)
        document.getElementById('scheduleTotals').style.display = 'table-footer-group';
        document.getElementById('footerPrincipal').textContent = formatMoney(result.totals.principal);
        document.getElementById('footerInterest').textContent = formatMoney(result.totals.interest);
        document.getElementById('footerTotal').textContent = formatMoney(result.totals.totalRepayment);

        // Update UI - Debug console
        const frequencyLabel = document.getElementById('frequency').selectedOptions[0].text;
        const loanStartModeLabel = document.getElementById('loanStartMode').selectedOptions[0].text;
        const firstPaymentDueLabel = document.getElementById('firstPaymentDue').selectedOptions[0].text;

        const debugLines = [
          'âœ” Calculation completed',
          '',
          '=== PARAMETERS ===',
          `Loan amount: ${formatMoney(loanAmount * 100)}`,
          `Annual interest rate: ${annualInterestRate.toFixed(2)}%`,
          `Repayment type: ${repaymentType === 'one_time' ? '1-time payment' : 'Installments'}`,
          `Number of installments: ${numberOfInstallments}`,
          `Payment frequency: ${frequencyLabel}`,
          `First payment due: ${firstPaymentDueLabel}`,
          `  â†’ Days: ${firstPaymentDays}, Months: ${firstPaymentMonths}`,
          `Loan start: ${loanStartModeLabel}`,
          `  â†’ Real date: ${calculatedLoanStartDate ? formatDateDisplay(calculatedLoanStartDate) : 'Unknown (preview mode)'}`,
          `Context mode: ${contextMode === 'actual' ? 'Actual (known loan start)' : 'Preview (no real date)'}`,
          `Effective mode: ${result.effectiveMode === 'actual' ? 'Actual (real calendar dates)' : 'Preview (relative labels)'}`,
          '',
          '=== TOTALS ===',
          `Total principal: ${formatMoney(result.totals.principal)}`,
          `Total interest: ${formatMoney(result.totals.interest)}`,
          `Total repayment: ${formatMoney(result.totals.totalRepayment)}`,
          '',
          '=== SCHEDULE ===',
          `Generated ${result.rows.length} payment(s)`
        ];

        // Add table of payments for internal validation
        if (result.rows.length <= 12) {
          debugLines.push('');
          result.rows.forEach(row => {
            debugLines.push(
              `Payment ${row.index}: ${row.label} | ` +
              `Principal: ${formatMoney(row.principal)} | ` +
              `Interest: ${formatMoney(row.interest)} | ` +
              `Total: ${formatMoney(row.totalPayment)}`
            );
          });
        }

        document.getElementById('debugConsole').textContent = debugLines.join('\n');

      } catch (error) {
        console.error('Calculation error:', error);
        document.getElementById('debugConsole').innerHTML =
          '<span class="error-message">ERROR:</span>\n' +
          error.message + '\n\n' +
          (error.stack || '');
      }
    }

    // Initialize: set initial UI state based on repayment type
    updateRepaymentTypeUI();
  </script>
</body>
</html>
