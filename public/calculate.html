<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Repayment Calculator Playground - PayFriends</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #0c1015 0%, #1a1f2e 100%);
      color: #e5e7eb;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: rgba(31, 41, 55, 0.6);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 8px;
      color: #fff;
    }

    .subtitle {
      color: #9ca3af;
      font-size: 14px;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }

    @media (max-width: 1024px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: rgba(31, 41, 55, 0.6);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 24px;
    }

    .card h2 {
      font-size: 18px;
      margin-bottom: 20px;
      color: #fff;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 8px;
      color: #d1d5db;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      background: rgba(12, 16, 21, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 10px 12px;
      color: #e5e7eb;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: rgba(59, 130, 246, 0.5);
    }

    .form-group input:disabled,
    .form-group select:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .form-group input[type="number"] {
      font-variant-numeric: tabular-nums;
    }

    .form-hint {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 6px;
      font-style: italic;
    }

    .btn {
      width: 100%;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.2s;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .btn:active {
      transform: translateY(0);
    }

    .totals {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .total-card {
      background: rgba(12, 16, 21, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      padding: 16px;
    }

    .total-label {
      font-size: 12px;
      text-transform: uppercase;
      color: #9ca3af;
      margin-bottom: 8px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .total-value {
      font-size: 24px;
      font-weight: 700;
      color: #fff;
      font-variant-numeric: tabular-nums;
    }

    .schedule-table {
      overflow-x: auto;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      background: rgba(12, 16, 21, 0.8);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead th {
      background: rgba(31, 41, 55, 0.98);
      padding: 12px;
      text-align: left;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      color: #9ca3af;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    thead th.align-right {
      text-align: right;
    }

    tbody td {
      padding: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      color: #d1d5db;
    }

    tbody td.align-right {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    tbody tr:nth-child(even) {
      background: rgba(10, 13, 17, 0.6);
    }

    tbody tr:hover {
      background: rgba(55, 65, 81, 0.3);
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge-preview {
      background: rgba(59, 130, 246, 0.2);
      color: #60a5fa;
    }

    .badge-actual {
      background: rgba(16, 185, 129, 0.2);
      color: #34d399;
    }

    .info-box {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 8px;
      padding: 12px;
      margin-top: 16px;
      font-size: 13px;
      color: #93c5fd;
      line-height: 1.5;
    }

    .debug-console {
      background: rgba(12, 16, 21, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      padding: 16px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      color: #a5f3fc;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .error-message {
      color: #ef4444;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ðŸ§® Repayment Calculator Playground</h1>
      <p class="subtitle">Internal testing tool for the new repayment schedule generator â€¢ Single source of truth validation</p>
    </div>

    <div class="main-grid">
      <!-- Left sidebar: Form inputs -->
      <div class="card">
        <h2>Configuration</h2>

        <div class="form-group">
          <label for="principal">Loan amount (â‚¬)</label>
          <input type="number" id="principal" value="6000" min="100" step="100">
        </div>

        <div class="form-group">
          <label for="interest">Annual interest rate (%)</label>
          <input type="number" id="interest" value="5" min="0" max="100" step="0.1">
        </div>

        <div class="form-group">
          <label for="repaymentType">Repayment type</label>
          <select id="repaymentType">
            <option value="installments" selected>Installments</option>
            <option value="one_time">1-time payment</option>
          </select>
        </div>

        <div class="form-group" id="installmentsGroup">
          <label for="numInstallments">Number of installments</label>
          <input type="number" id="numInstallments" value="12" min="1" max="120" step="1">
          <div class="form-hint" id="installmentsHint" style="display: none;">
            For 1-time payments the loan is repaid in a single payment.
          </div>
        </div>

        <div class="form-group">
          <label for="frequency">Payment frequency</label>
          <select id="frequency">
            <option value="monthly" selected>Every month</option>
            <option value="every_4_weeks">Every 4 weeks</option>
            <option value="biweekly">Every 2 weeks</option>
            <option value="weekly">Every week</option>
            <option value="every_3_days">Every 3 days</option>
            <option value="once_only" style="display: none;">Once only</option>
          </select>
        </div>

        <div class="form-group">
          <label for="firstPaymentOffset">First payment timing (days after loan start)</label>
          <input type="number" id="firstPaymentOffset" value="30" min="0" max="365" step="1">
        </div>

        <div class="form-group">
          <label for="loanStartMode">Loan start mode</label>
          <select id="loanStartMode">
            <option value="upon_acceptance" selected>Upon agreement acceptance</option>
            <option value="fixed_date">On a specific date</option>
          </select>
        </div>

        <div class="form-group" id="loanStartDateGroup" style="display: none;">
          <label for="loanStartDate">Loan start date</label>
          <input type="date" id="loanStartDate" value="2025-01-01">
        </div>

        <div class="form-group">
          <label for="contextMode">Context mode</label>
          <select id="contextMode">
            <option value="preview" selected>Preview (no real date)</option>
            <option value="actual">Actual mode</option>
          </select>
        </div>

        <div class="form-group">
          <button class="btn" onclick="calculateSchedule()">Calculate schedule</button>
        </div>

        <div class="info-box">
          <strong>Preview mode:</strong> Shows relative labels like "1 month after loan start"<br>
          <strong>Actual mode:</strong> Shows real calendar dates when loan start date is known
        </div>
      </div>

      <!-- Right side: Results -->
      <div>
        <!-- Totals -->
        <div class="totals">
          <div class="total-card">
            <div class="total-label">Total Interest</div>
            <div class="total-value" id="totalInterest">â‚¬ 0,00</div>
          </div>
          <div class="total-card">
            <div class="total-label">Total to Repay</div>
            <div class="total-value" id="totalToRepay">â‚¬ 0,00</div>
          </div>
          <div class="total-card">
            <div class="total-label">Loan Start</div>
            <div class="total-value" id="loanStartLabel" style="font-size: 16px;">â€”</div>
          </div>
        </div>

        <!-- Schedule table -->
        <div class="card">
          <h2>Repayment Schedule <span id="contextBadge"></span></h2>
          <div class="schedule-table">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Due date</th>
                  <th class="align-right">Principal</th>
                  <th class="align-right">Interest</th>
                  <th class="align-right">Total payment</th>
                  <th class="align-right">Balance</th>
                </tr>
              </thead>
              <tbody id="scheduleBody">
                <tr>
                  <td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">
                    Click "Calculate schedule" to generate repayment schedule...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Debug console -->
        <div class="card" style="margin-top: 24px;">
          <h2>Debug Console</h2>
          <div class="debug-console" id="debugConsole">
Click "Calculate schedule" to see calculation details...
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/formatters.js"></script>
  <script>
    // Calculator Playground Logic
    // Uses the formatCurrency functions from the global window object loaded by formatters.js

    // Get formatting functions from window
    const formatMoney = window.formatCurrency2;
    const formatMoneyRound = window.formatCurrency0;

    // Show/hide conditional fields based on repayment type
    document.getElementById('repaymentType').addEventListener('change', function() {
      const isOneTime = this.value === 'one_time';
      const numInstallmentsInput = document.getElementById('numInstallments');
      const frequencySelect = document.getElementById('frequency');
      const installmentsHint = document.getElementById('installmentsHint');

      if (isOneTime) {
        // 1-time payment: force 1 installment and "once only" frequency
        numInstallmentsInput.value = 1;
        numInstallmentsInput.disabled = true;
        installmentsHint.style.display = 'block';

        // Show and select "once only" option
        const onceOnlyOption = frequencySelect.querySelector('option[value="once_only"]');
        onceOnlyOption.style.display = 'block';
        frequencySelect.value = 'once_only';
        frequencySelect.disabled = true;
      } else {
        // Installments: enable fields
        numInstallmentsInput.disabled = false;
        installmentsHint.style.display = 'none';

        // Hide "once only" and select monthly
        const onceOnlyOption = frequencySelect.querySelector('option[value="once_only"]');
        onceOnlyOption.style.display = 'none';
        if (frequencySelect.value === 'once_only') {
          frequencySelect.value = 'monthly';
        }
        frequencySelect.disabled = false;
      }
    });

    // Show/hide loan start date field
    document.getElementById('loanStartMode').addEventListener('change', function() {
      const loanStartDateGroup = document.getElementById('loanStartDateGroup');
      loanStartDateGroup.style.display = this.value === 'fixed_date' ? 'block' : 'none';
    });

    /**
     * Main calculator function - generates complete repayment schedule
     * @param {Object} config - Configuration object
     * @returns {Object} - Result with schedule rows, totals, and debug messages
     */
    function generateRepaymentSchedule(config) {
      const {
        loanAmount,
        annualInterestRate,
        repaymentType,
        numberOfInstallments,
        paymentFrequency,
        firstPaymentDaysAfterStart,
        loanStartMode,
        contextMode,
        fixedLoanStartDate
      } = config;

      const debugMessages = [];

      // Interest calculation setup
      const annualRate = annualInterestRate / 100;
      debugMessages.push(`Using annual interest rate: ${annualInterestRate}%`);

      // Determine period rate based on frequency
      // For simplicity, we use approximate day-based calculations
      let periodDays;
      let periodLabel;

      switch (paymentFrequency) {
        case 'monthly':
          periodDays = 30;
          periodLabel = 'month';
          break;
        case 'every_4_weeks':
          periodDays = 28;
          periodLabel = '4 weeks';
          break;
        case 'biweekly':
          periodDays = 14;
          periodLabel = '2 weeks';
          break;
        case 'weekly':
          periodDays = 7;
          periodLabel = 'week';
          break;
        case 'every_3_days':
          periodDays = 3;
          periodLabel = '3 days';
          break;
        case 'once_only':
          // For one-time, we'll calculate based on first payment offset
          periodDays = firstPaymentDaysAfterStart;
          periodLabel = 'one-time';
          break;
        default:
          periodDays = 30;
          periodLabel = 'month';
      }

      // Daily interest rate for accurate calculation
      const dailyRate = annualRate / 365;
      debugMessages.push(`Payment frequency: Every ${periodLabel}`);
      debugMessages.push(`Period days: ${periodDays}`);
      debugMessages.push(`Daily interest rate: ${(dailyRate * 100).toFixed(6)}%`);

      // Generate schedule rows
      const scheduleRows = [];
      const principalPerPayment = loanAmount / numberOfInstallments;
      let remainingBalance = loanAmount;
      let totalInterest = 0;

      // First payment is offset by firstPaymentDaysAfterStart
      let currentDayOffset = firstPaymentDaysAfterStart;

      for (let i = 1; i <= numberOfInstallments; i++) {
        // Calculate interest for this period based on actual days
        const daysForThisPeriod = (i === 1) ? firstPaymentDaysAfterStart : periodDays;
        const interestForPeriod = remainingBalance * dailyRate * daysForThisPeriod;
        const principalPayment = principalPerPayment;
        const totalPayment = principalPayment + interestForPeriod;

        totalInterest += interestForPeriod;
        remainingBalance -= principalPayment;
        if (remainingBalance < 0.01) remainingBalance = 0;

        // Generate due date label
        let dueDateLabel;
        if (contextMode === 'preview' || (loanStartMode === 'upon_acceptance' && !fixedLoanStartDate)) {
          // Preview mode: use relative labels
          dueDateLabel = getRelativeDateLabel(i, paymentFrequency, firstPaymentDaysAfterStart, periodDays);
        } else {
          // Actual mode with fixed date: calculate real calendar date
          dueDateLabel = calculateActualDate(fixedLoanStartDate, currentDayOffset);
        }

        scheduleRows.push({
          index: i,
          dueDateLabel,
          principal: Math.round(principalPayment * 100), // cents
          interest: Math.round(interestForPeriod * 100), // cents
          totalPayment: Math.round(totalPayment * 100), // cents
          balance: Math.round(remainingBalance * 100) // cents
        });

        // Update offset for next payment
        if (i > 1) {
          currentDayOffset += periodDays;
        }
      }

      debugMessages.push(`Generated ${scheduleRows.length} payment(s)`);
      debugMessages.push(`Total interest: ${formatMoney(Math.round(totalInterest * 100))}`);
      debugMessages.push(`Total to repay: ${formatMoney(Math.round((loanAmount + totalInterest) * 100))}`);

      // Determine loan start display
      let loanStartDisplayValue;
      if (loanStartMode === 'upon_acceptance') {
        loanStartDisplayValue = 'When agreement is accepted';
        if (contextMode === 'preview') {
          debugMessages.push('Loan start date not fixed. Showing relative dates.');
        }
      } else if (fixedLoanStartDate) {
        loanStartDisplayValue = formatDate(fixedLoanStartDate);
      } else {
        loanStartDisplayValue = 'To be confirmed';
      }

      return {
        scheduleRows,
        totalInterest: Math.round(totalInterest * 100), // cents
        totalToRepay: Math.round((loanAmount + totalInterest) * 100), // cents
        loanStartDisplayValue,
        debugMessages
      };
    }

    /**
     * Generate relative date label for preview mode
     */
    function getRelativeDateLabel(paymentIndex, frequency, firstOffset, periodDays) {
      let totalDays = firstOffset + (paymentIndex - 1) * periodDays;

      if (totalDays === 0) {
        return 'On loan start';
      }

      switch (frequency) {
        case 'monthly':
          const months = Math.round(totalDays / 30);
          return months === 1 ? '1 month after loan start' : `${months} months after loan start`;
        case 'every_4_weeks':
          const fourWeekPeriods = Math.round(totalDays / 28);
          const weeks = fourWeekPeriods * 4;
          return weeks === 4 ? '4 weeks after loan start' : `${weeks} weeks after loan start`;
        case 'biweekly':
          const biweekPeriods = Math.round(totalDays / 14);
          const biWeeks = biweekPeriods * 2;
          return biWeeks === 2 ? '2 weeks after loan start' : `${biWeeks} weeks after loan start`;
        case 'weekly':
          const weekCount = Math.round(totalDays / 7);
          return weekCount === 1 ? '1 week after loan start' : `${weekCount} weeks after loan start`;
        case 'every_3_days':
          return totalDays === 3 ? '3 days after loan start' : `${totalDays} days after loan start`;
        case 'once_only':
          if (totalDays === 365) return '1 year after loan start';
          if (totalDays === 30) return '1 month after loan start';
          return `${totalDays} days after loan start`;
        default:
          return `${totalDays} days after loan start`;
      }
    }

    /**
     * Calculate actual calendar date
     */
    function calculateActualDate(startDateStr, offsetDays) {
      const startDate = new Date(startDateStr);
      const dueDate = new Date(startDate.getTime() + offsetDays * 24 * 60 * 60 * 1000);
      return formatDate(dueDate);
    }

    /**
     * Format date for display
     */
    function formatDate(dateInput) {
      const date = typeof dateInput === 'string' ? new Date(dateInput) : dateInput;
      const day = date.getDate();
      const month = date.toLocaleDateString('en-GB', { month: 'short' });
      const year = date.getFullYear();
      return `${day} ${month} ${year}`;
    }

    /**
     * Main calculation function triggered by button click
     */
    function calculateSchedule() {
      try {
        // Gather form data
        const loanAmount = parseFloat(document.getElementById('principal').value);
        const annualInterestRate = parseFloat(document.getElementById('interest').value);
        const repaymentType = document.getElementById('repaymentType').value;
        const numberOfInstallments = parseInt(document.getElementById('numInstallments').value);
        const paymentFrequency = document.getElementById('frequency').value;
        const firstPaymentDaysAfterStart = parseInt(document.getElementById('firstPaymentOffset').value);
        const loanStartMode = document.getElementById('loanStartMode').value;
        const contextMode = document.getElementById('contextMode').value;
        const fixedLoanStartDate = document.getElementById('loanStartDate').value;

        // Validation
        const errors = [];
        if (!loanAmount || loanAmount <= 0 || isNaN(loanAmount)) {
          errors.push('Please enter a positive loan amount.');
        }
        if (isNaN(annualInterestRate) || annualInterestRate < 0) {
          errors.push('Interest rate cannot be negative.');
        }
        if (!numberOfInstallments || numberOfInstallments < 1 || isNaN(numberOfInstallments)) {
          errors.push('Number of installments must be at least 1.');
        }
        if (isNaN(firstPaymentDaysAfterStart) || firstPaymentDaysAfterStart < 0) {
          errors.push('First payment timing cannot be negative.');
        }
        if (contextMode === 'actual' && loanStartMode === 'fixed_date' && !fixedLoanStartDate) {
          errors.push('Please select a loan start date for actual mode with fixed date.');
        }

        if (errors.length > 0) {
          // Show validation errors
          document.getElementById('debugConsole').innerHTML =
            '<span class="error-message">âš  Validation errors:</span>\n' +
            errors.map(e => `  â€¢ ${e}`).join('\n');
          return;
        }

        // Build configuration
        const config = {
          loanAmount,
          annualInterestRate,
          repaymentType,
          numberOfInstallments,
          paymentFrequency,
          firstPaymentDaysAfterStart,
          loanStartMode,
          contextMode,
          fixedLoanStartDate: (contextMode === 'actual' && fixedLoanStartDate) ? fixedLoanStartDate : null
        };

        // Generate schedule
        const result = generateRepaymentSchedule(config);

        // Update UI - Totals
        document.getElementById('totalInterest').textContent = formatMoney(result.totalInterest);
        document.getElementById('totalToRepay').textContent = formatMoney(result.totalToRepay);
        document.getElementById('loanStartLabel').textContent = result.loanStartDisplayValue;

        // Update UI - Context badge
        const badge = contextMode === 'preview'
          ? '<span class="badge badge-preview">Preview</span>'
          : '<span class="badge badge-actual">Actual</span>';
        document.getElementById('contextBadge').innerHTML = badge;

        // Update UI - Schedule table
        const tbody = document.getElementById('scheduleBody');
        tbody.innerHTML = '';

        result.scheduleRows.forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${row.index}</td>
            <td>${row.dueDateLabel}</td>
            <td class="align-right">${formatMoney(row.principal)}</td>
            <td class="align-right">${formatMoney(row.interest)}</td>
            <td class="align-right" style="font-weight: 600;">${formatMoney(row.totalPayment)}</td>
            <td class="align-right">${formatMoney(row.balance)}</td>
          `;
          tbody.appendChild(tr);
        });

        // Update UI - Debug console
        const debugOutput = 'âœ” Calculation completed successfully\n\n' +
          result.debugMessages.join('\n') + '\n\n' +
          `Configuration:\n` +
          `  â€¢ Repayment type: ${repaymentType === 'one_time' ? '1-time payment' : 'Installments'}\n` +
          `  â€¢ Number of payments: ${numberOfInstallments}\n` +
          `  â€¢ Context mode: ${contextMode}`;

        document.getElementById('debugConsole').textContent = debugOutput;

      } catch (error) {
        console.error('Calculation error:', error);
        document.getElementById('debugConsole').innerHTML =
          '<span class="error-message">ERROR:</span>\n' +
          error.message + '\n\n' +
          (error.stack || '');
      }
    }

    // Initialize: trigger repayment type change to set initial state
    document.getElementById('repaymentType').dispatchEvent(new Event('change'));
  </script>
</body>
</html>
