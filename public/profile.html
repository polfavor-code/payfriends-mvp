<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PayFriends â€” My Profile</title>
  <style>
    :root{
      --bg:#0e1116; --card:#151a21; --text:#e6eef6; --muted:#a7b0bd; --accent:#3ddc97;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif; background:var(--bg); color:var(--text);}
    .container{max-width:1200px;margin:0 auto;padding:32px 16px;}
    .card{background:var(--card);border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:24px;margin:16px 0}
    .row{margin:20px 0}
    .row label{display:block; margin-bottom:8px; color:var(--muted); font-size:14px; font-weight:500}
    .row input{width:100%; padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text); font-size:15px}
    .row input:disabled{opacity:0.6; cursor:not-allowed}
    button{width:100%; padding:12px;border-radius:10px;border:0;background:var(--accent);color:#0d130f;font-weight:700; cursor:pointer; font-size:15px; margin-top:8px}
    button:hover{filter:brightness(1.06)}
    .status{color:var(--muted); margin-top:12px; min-height:1.2em; font-size:14px; text-align:center}
    .error{color:#ff6b6b}
    .success{color:var(--accent)}
    .top-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid rgba(255,255,255,0.08)}
    .top-header-left{display:flex; align-items:center; gap:12px}
    .top-header-right{display:flex; flex-direction:column; align-items:flex-end; gap:8px}
    .logo-coin{height:54px; width:auto}
    .top-header-text{display:flex; flex-direction:column; gap:2px}
    .app-name{font-size:24px; font-weight:600; line-height:1.2; margin:0}
    .user-meta{color:var(--muted); font-size:14px; line-height:1.2}
    .app-slogan{color:var(--muted); font-size:14px; line-height:1.2; margin-top:2px}
    .top-header-user-info{color:var(--text); font-size:14px; text-align:right}
    .top-header-actions{display:flex; gap:12px; align-items:center}
    .logout-btn{padding:8px 16px;border-radius:8px;border:1px solid rgba(255,255,255,0.15);background:transparent;color:var(--text);font-weight:500; cursor:pointer; font-size:14px; width:auto}
    .logout-btn:hover{background:rgba(255,255,255,0.05)}
    .inbox-widget{padding:8px 16px;border-radius:8px;border:1px solid rgba(255,255,255,0.15);background:transparent;color:var(--text);font-weight:500;font-size:14px;text-decoration:none;display:inline-block;transition:all 0.2s ease}
    .inbox-widget:hover{background:rgba(255,255,255,0.05)}
    .inbox-widget.inbox-widget-has-unread{background:var(--card);border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:10px 18px;font-size:15px}
    .inbox-widget.inbox-widget-has-unread:hover{background:#1a2028}
    .inbox-count{color:var(--accent);font-weight:700}

    /* Avatar styles */
    .user-avatar{display:inline-flex;align-items:center;justify-content:center;border-radius:50%;overflow:hidden;flex-shrink:0;vertical-align:middle}
    .user-avatar.size-small{width:22px;height:22px;font-size:10px;margin-right:8px}
    .user-avatar.size-medium{width:48px;height:48px;font-size:18px}
    .user-avatar.size-large{width:120px;height:120px;font-size:40px;font-weight:600;cursor:pointer;transition:opacity 0.2s}
    .user-avatar.size-large:hover{opacity:0.85}
    .user-avatar-image{width:100%;height:100%;object-fit:cover}
    .user-avatar-initials{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-weight:600}
    .user-avatar-initials.color-1{background:#6366f1;color:#fff}
    .user-avatar-initials.color-2{background:#ec4899;color:#fff}
    .user-avatar-initials.color-3{background:#f59e0b;color:#fff}
    .user-avatar-initials.color-4{background:#10b981;color:#fff}
    .user-avatar-initials.color-5{background:#3b82f6;color:#fff}
    .user-avatar-initials.color-6{background:#8b5cf6;color:#fff}
    .user-avatar-initials.color-7{background:#14b8a6;color:#fff}

    /* Custom phone input component */
    .phone-input-wrapper{position:relative}
    .phone-input-container{display:flex;gap:8px;align-items:stretch}
    .phone-country-button{
      display:flex;align-items:center;gap:6px;padding:12px;
      border-radius:10px;border:1px solid rgba(255,255,255,0.08);
      background:#10151d;color:var(--text);cursor:pointer;
      font-size:15px;min-width:100px;transition:all 0.2s ease
    }
    .phone-country-button:hover{background:#151a21;border-color:rgba(255,255,255,0.12)}
    .phone-country-button:focus{outline:none;border-color:rgba(61,220,151,0.4)}
    .phone-flag{font-size:20px;line-height:1}
    .phone-dial-code{color:var(--text);font-weight:500}
    .phone-chevron{color:var(--muted);font-size:12px;margin-left:auto}
    .phone-input-field{
      flex:1;padding:12px;border-radius:10px;
      border:1px solid rgba(255,255,255,0.08);background:#10151d;
      color:var(--text);font-size:15px
    }
    .phone-input-field:focus{outline:none;border-color:rgba(61,220,151,0.4)}
    .phone-input-field::placeholder{color:var(--muted)}

    /* Dropdown */
    .phone-country-dropdown{
      position:absolute;top:calc(100% + 4px);left:0;right:0;
      background:#111;border:1px solid rgba(255,255,255,0.1);
      border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,0.6);
      max-height:280px;overflow-y:auto;z-index:1000;display:none
    }
    .phone-country-dropdown.active{display:block}

    /* Search box */
    .phone-search-box{
      padding:8px 10px;border-bottom:1px solid rgba(255,255,255,0.08);
      position:sticky;top:0;background:#111;z-index:1
    }
    .phone-search-input{
      width:100%;padding:8px 12px;border-radius:6px;
      background:#1a1a1a;border:1px solid rgba(255,255,255,0.15);
      color:#fff;font-size:14px
    }
    .phone-search-input:focus{outline:none;border-color:rgba(61,220,151,0.4)}
    .phone-search-input::placeholder{color:rgba(255,255,255,0.5)}

    /* Country list */
    .phone-country-list{padding:4px 0}
    .phone-country-item{
      display:flex;align-items:center;gap:10px;padding:8px 12px;
      cursor:pointer;transition:all 0.1s ease;
      border-left:3px solid transparent;font-size:14px
    }
    .phone-country-item:hover,.phone-country-item.highlighted{
      background:rgba(61,220,151,0.08);border-left-color:#3ddc97
    }
    .phone-country-item.selected{background:rgba(61,220,151,0.06)}
    .phone-country-flag{font-size:20px;line-height:1}
    .phone-country-name{color:#f3f3f3;flex:1}
    .phone-country-dial{color:rgba(255,255,255,0.6);font-size:13px}

    /* Scrollbar */
    .phone-country-dropdown::-webkit-scrollbar{width:6px}
    .phone-country-dropdown::-webkit-scrollbar-thumb{background:#333;border-radius:4px}

    /* Error message */
    .phone-error{color:#ff6b6b;font-size:13px;margin-top:4px;display:none}

    /* Profile header with avatar */
    .profile-header{display:flex;flex-direction:column;align-items:center;gap:12px;margin-top:24px;margin-bottom:12px}
    .profile-info{display:flex;flex-direction:column;gap:6px}
    .profile-name{font-size:20px;font-weight:600;color:var(--text)}
    .profile-detail{font-size:14px;color:var(--muted)}
    .avatar-upload-text{color:var(--muted);font-size:14px;cursor:pointer;text-decoration:underline;margin-top:4px}
    .avatar-upload-text:hover{color:var(--text)}
  </style>
</head>
<body>
  <main class="container">
    <header class="top-header">
      <div class="top-header-left">
        <a href="/app" style="text-decoration:none; display:flex; align-items:center; gap:12px">
          <img src="/images/payfriends-logov2.png" class="logo-coin" alt="PayFriends logo" />
          <div class="top-header-text">
            <div class="app-name" style="color:var(--text)">PayFriends.app</div>
            <div class="app-slogan">Pay friends, stay friends</div>
          </div>
        </a>
      </div>
      <div class="top-header-right">
        <div class="top-header-user-info" id="user-info-display">Loading...</div>
        <div class="top-header-actions">
          <a href="/app" class="inbox-widget" id="activity-link">Activity</a>
          <a href="/profile" style="color:var(--text); text-decoration:none; padding:8px 16px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background:transparent; font-weight:500; font-size:14px; display:inline-block; white-space:nowrap">My Profile</a>
          <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
      </div>
    </header>

    <section class="card">
      <h2 style="margin-top:0; margin-bottom:24px">Profile Information</h2>

      <!-- Profile Header with Avatar -->
      <div class="profile-header">
        <div id="profile-avatar-container" onclick="document.getElementById('picture-input').click()" oncontextmenu="handleAvatarContextMenu(event)"></div>
        <div class="avatar-upload-text" onclick="document.getElementById('picture-input').click()">Change photo</div>
        <input type="file" id="picture-input" accept="image/jpeg,image/png,image/webp" style="display:none" />
        <p id="picture-status" class="status" style="margin:0"></p>
      </div>

      <form id="profile-form">
        <div class="row">
          <label>Full legal name (as on passport)</label>
          <input id="full-name" type="text" placeholder="Jane Smith" required />
        </div>
        <div class="row">
          <label>Email</label>
          <input id="email" type="email" disabled />
        </div>
        <div class="row">
          <label>Phone number</label>
          <div class="phone-input-wrapper">
            <div class="phone-input-container" id="profile-phone-container">
              <button type="button" class="phone-country-button" id="profile-phone-country-btn">
                <span class="phone-flag" id="profile-phone-flag">ðŸ‡³ðŸ‡±</span>
                <span class="phone-dial-code" id="profile-phone-dial">+31</span>
                <span class="phone-chevron">â–¾</span>
              </button>
              <input
                type="tel"
                class="phone-input-field"
                id="phone-number"
                name="phoneNumber"
                autocomplete="tel"
                placeholder="612 345 678"
                required
              />
              <div class="phone-country-dropdown" id="profile-phone-dropdown">
                <div class="phone-search-box">
                  <input
                    type="text"
                    class="phone-search-input"
                    id="profile-phone-search"
                    placeholder="Search countries..."
                  />
                </div>
                <div class="phone-country-list" id="profile-phone-list"></div>
              </div>
            </div>
            <div id="phone-error" class="phone-error">Please enter a valid phone number.</div>
          </div>
        </div>
        <button type="submit">Save Changes</button>
        <p id="profile-status" class="status"></p>
      </form>
    </section>
  </main>

  <script>
    let currentUser = null;
    let phoneInput = null;

    // Avatar helper functions
    function getInitials(name) {
      if (!name) return '?';
      const words = name.trim().split(/\s+/);
      if (words.length === 1) return words[0].charAt(0).toUpperCase();
      return (words[0].charAt(0) + words[words.length - 1].charAt(0)).toUpperCase();
    }

    function getColorClass(name) {
      if (!name) return 'color-1';
      let hash = 0;
      for (let i = 0; i < name.length; i++) {
        hash = name.charCodeAt(i) + ((hash << 5) - hash);
      }
      return 'color-' + ((Math.abs(hash) % 7) + 1);
    }

    function generateAvatarHTML(user, size = 'small') {
      const name = user.full_name || user.email || '';
      const initials = getInitials(name);
      const colorClass = getColorClass(name);

      if (user.profile_picture) {
        return `
          <div class="user-avatar size-${size}">
            <img src="/api/profile/picture/${user.id}" class="user-avatar-image" alt="${name}" />
          </div>
        `;
      } else {
        return `
          <div class="user-avatar size-${size}">
            <div class="user-avatar-initials ${colorClass}">${initials}</div>
          </div>
        `;
      }
    }

    // Custom Phone Input Component
    class PhoneInput {
      constructor(containerId) {
        this.containerId = containerId;
        this.container = document.getElementById(containerId);
        if (!this.container) return;

        this.button = this.container.querySelector('.phone-country-button');
        this.input = this.container.querySelector('.phone-input-field');
        this.dropdown = this.container.querySelector('.phone-country-dropdown');
        this.searchInput = this.container.querySelector('.phone-search-input');
        this.list = this.container.querySelector('.phone-country-list');
        this.flagEl = this.container.querySelector('.phone-flag');
        this.dialEl = this.container.querySelector('.phone-dial-code');

        this.selectedCountry = { code: 'nl', dial: '+31', flag: 'ðŸ‡³ðŸ‡±', name: 'Netherlands' };
        this.countries = this.getCountries();
        this.highlightedIndex = -1;

        this.init();
      }

      getCountries() {
        return [
          { code: 'nl', dial: '+31', flag: 'ðŸ‡³ðŸ‡±', name: 'Netherlands' },
          { code: 'es', dial: '+34', flag: 'ðŸ‡ªðŸ‡¸', name: 'Spain' },
          { code: 'de', dial: '+49', flag: 'ðŸ‡©ðŸ‡ª', name: 'Germany' },
          { code: 'fr', dial: '+33', flag: 'ðŸ‡«ðŸ‡·', name: 'France' },
          { code: 'gb', dial: '+44', flag: 'ðŸ‡¬ðŸ‡§', name: 'United Kingdom' },
          { code: 'it', dial: '+39', flag: 'ðŸ‡®ðŸ‡¹', name: 'Italy' },
          { code: 'be', dial: '+32', flag: 'ðŸ‡§ðŸ‡ª', name: 'Belgium' },
          { code: 'pt', dial: '+351', flag: 'ðŸ‡µðŸ‡¹', name: 'Portugal' },
          { code: 'us', dial: '+1', flag: 'ðŸ‡ºðŸ‡¸', name: 'United States' },
          { code: 'ca', dial: '+1', flag: 'ðŸ‡¨ðŸ‡¦', name: 'Canada' },
          { code: 'pl', dial: '+48', flag: 'ðŸ‡µðŸ‡±', name: 'Poland' },
          { code: 'ro', dial: '+40', flag: 'ðŸ‡·ðŸ‡´', name: 'Romania' },
          { code: 'se', dial: '+46', flag: 'ðŸ‡¸ðŸ‡ª', name: 'Sweden' },
          { code: 'dk', dial: '+45', flag: 'ðŸ‡©ðŸ‡°', name: 'Denmark' },
          { code: 'no', dial: '+47', flag: 'ðŸ‡³ðŸ‡´', name: 'Norway' },
          { code: 'fi', dial: '+358', flag: 'ðŸ‡«ðŸ‡®', name: 'Finland' },
          { code: 'at', dial: '+43', flag: 'ðŸ‡¦ðŸ‡¹', name: 'Austria' },
          { code: 'ch', dial: '+41', flag: 'ðŸ‡¨ðŸ‡­', name: 'Switzerland' },
          { code: 'ie', dial: '+353', flag: 'ðŸ‡®ðŸ‡ª', name: 'Ireland' },
          { code: 'gr', dial: '+30', flag: 'ðŸ‡¬ðŸ‡·', name: 'Greece' }
        ];
      }

      init() {
        this.renderCountryList();
        this.attachEvents();
      }

      renderCountryList(filter = '') {
        const filtered = this.countries.filter(c =>
          c.name.toLowerCase().includes(filter.toLowerCase()) ||
          c.dial.includes(filter)
        );

        this.list.innerHTML = filtered.map((country, idx) => `
          <div class="phone-country-item${country.code === this.selectedCountry.code ? ' selected' : ''}"
               data-code="${country.code}" data-index="${idx}">
            <span class="phone-country-flag">${country.flag}</span>
            <span class="phone-country-name">${country.name}</span>
            <span class="phone-country-dial">${country.dial}</span>
          </div>
        `).join('');

        // Attach click handlers
        this.list.querySelectorAll('.phone-country-item').forEach(item => {
          item.addEventListener('click', () => {
            const code = item.dataset.code;
            const country = this.countries.find(c => c.code === code);
            if (country) {
              this.selectCountry(country);
              this.closeDropdown();
            }
          });
        });
      }

      selectCountry(country) {
        this.selectedCountry = country;
        this.flagEl.textContent = country.flag;
        this.dialEl.textContent = country.dial;
        this.renderCountryList(this.searchInput.value);
      }

      attachEvents() {
        // Toggle dropdown
        this.button.addEventListener('click', (e) => {
          e.preventDefault();
          this.toggleDropdown();
        });

        // Search
        this.searchInput.addEventListener('input', (e) => {
          this.renderCountryList(e.target.value);
          this.highlightedIndex = -1;
        });

        // Keyboard navigation in search
        this.searchInput.addEventListener('keydown', (e) => {
          const items = this.list.querySelectorAll('.phone-country-item');
          if (e.key === 'ArrowDown') {
            e.preventDefault();
            this.highlightedIndex = Math.min(this.highlightedIndex + 1, items.length - 1);
            this.updateHighlight(items);
          } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            this.highlightedIndex = Math.max(this.highlightedIndex - 1, 0);
            this.updateHighlight(items);
          } else if (e.key === 'Enter' && this.highlightedIndex >= 0) {
            e.preventDefault();
            items[this.highlightedIndex].click();
          } else if (e.key === 'Escape') {
            this.closeDropdown();
          }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
          if (!this.container.contains(e.target)) {
            this.closeDropdown();
          }
        });
      }

      updateHighlight(items) {
        items.forEach((item, idx) => {
          item.classList.toggle('highlighted', idx === this.highlightedIndex);
        });
        if (items[this.highlightedIndex]) {
          items[this.highlightedIndex].scrollIntoView({ block: 'nearest' });
        }
      }

      toggleDropdown() {
        const isOpen = this.dropdown.classList.contains('active');
        if (isOpen) {
          this.closeDropdown();
        } else {
          this.openDropdown();
        }
      }

      openDropdown() {
        this.dropdown.classList.add('active');
        this.searchInput.value = '';
        this.searchInput.focus();
        this.renderCountryList();
        this.highlightedIndex = -1;
      }

      closeDropdown() {
        this.dropdown.classList.remove('active');
        this.highlightedIndex = -1;
      }

      getNumber() {
        const national = this.input.value.trim().replace(/\s+/g, '');
        if (!national) return '';
        return this.selectedCountry.dial + national;
      }

      setNumber(e164Number) {
        if (!e164Number) return;
        // Find matching country by dial code
        const country = this.countries.find(c => e164Number.startsWith(c.dial));
        if (country) {
          this.selectCountry(country);
          this.input.value = e164Number.slice(country.dial.length);
        } else {
          this.input.value = e164Number;
        }
      }

      isValid() {
        const number = this.getNumber();
        if (!number) return true; // Empty is valid (optional field)
        // Basic validation: must be at least 8 characters and contain only +, digits, and spaces
        return number.length >= 8 && /^\+\d+$/.test(number.replace(/\s+/g, ''));
      }
    }

    // Load user profile
    async function loadProfile() {
      try {
        const res = await fetch('/api/user');
        if (!res.ok) {
          window.location.href = '/';
          return;
        }
        const data = await res.json();
        currentUser = data.user;

        // Populate header user info
        const userName = currentUser.full_name || currentUser.email;
        document.getElementById('user-info-display').textContent = `${userName} | ${currentUser.email}`;

        // Render large avatar in profile header
        const avatarContainer = document.getElementById('profile-avatar-container');
        avatarContainer.innerHTML = generateAvatarHTML(currentUser, 'large');

        // Populate form fields
        document.getElementById('full-name').value = currentUser.full_name || '';
        document.getElementById('email').value = currentUser.email;

        // Initialize custom phone input
        phoneInput = new PhoneInput('profile-phone-container');

        // Set phone number after initializing phone input
        if (currentUser.phone_number) {
          phoneInput.setNumber(currentUser.phone_number);
        }

        // Load unread count for Activity button
        loadActivityCount();
      } catch (err) {
        console.error('Error loading profile:', err);
        window.location.href = '/';
      }
    }

    // Load activity count for header
    async function loadActivityCount() {
      try {
        const res = await fetch('/api/activity');
        if (res.ok) {
          const data = await res.json();
          const unreadCount = data.messages.filter(m => !m.read_at).length;
          updateActivityButton(unreadCount);
        }
      } catch (err) {
        console.error('Error loading activity count:', err);
      }
    }

    // Update Activity button with unread count
    function updateActivityButton(unreadCount) {
      const activityLink = document.getElementById('activity-link');
      if (unreadCount > 0) {
        activityLink.innerHTML = `Activity (<span class="inbox-count">${unreadCount}</span>)`;
        activityLink.classList.add('inbox-widget-has-unread');
      } else {
        activityLink.textContent = 'Activity';
        activityLink.classList.remove('inbox-widget-has-unread');
      }
    }

    // Display profile picture - refresh avatar
    function displayProfilePicture(picturePath) {
      const avatarContainer = document.getElementById('profile-avatar-container');
      // Refresh the avatar to show the new picture
      avatarContainer.innerHTML = generateAvatarHTML(currentUser, 'large');
    }

    // Hide profile picture - refresh avatar to show initials
    function hideProfilePicture() {
      const avatarContainer = document.getElementById('profile-avatar-container');
      // Refresh the avatar to show initials instead of picture
      avatarContainer.innerHTML = generateAvatarHTML(currentUser, 'large');
    }

    // Handle profile picture upload
    document.getElementById('picture-input').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const pictureStatus = document.getElementById('picture-status');
      pictureStatus.textContent = 'Uploading...';
      pictureStatus.className = 'status';

      try {
        const formData = new FormData();
        formData.append('picture', file);

        const res = await fetch('/api/profile/picture', {
          method: 'POST',
          body: formData
        });

        // Check if response is JSON
        const contentType = res.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          throw new Error('Server returned an invalid response. Please try again.');
        }

        const data = await res.json();

        if (!data.success) {
          pictureStatus.textContent = data.error || 'There was a problem uploading your photo. Please try another image.';
          pictureStatus.className = 'status error';
          // Reset file input
          e.target.value = '';
          return;
        }

        currentUser.profile_picture = data.profilePictureUrl;
        displayProfilePicture(data.profilePictureUrl);

        pictureStatus.textContent = 'âœ“ Profile picture updated';
        pictureStatus.className = 'status success';

        setTimeout(() => {
          pictureStatus.textContent = '';
        }, 3000);
      } catch (err) {
        console.error('Profile picture upload error:', err);
        pictureStatus.textContent = 'There was a problem uploading your photo. Please try another image.';
        pictureStatus.className = 'status error';
      }

      // Reset file input
      e.target.value = '';
    });

    // Handle avatar context menu (right-click)
    function handleAvatarContextMenu(event) {
      // Only show context menu if user has a profile picture
      if (currentUser && currentUser.profile_picture) {
        event.preventDefault();
        if (confirm('Remove profile picture?')) {
          removeProfilePicture();
        }
      }
    }

    // Remove profile picture
    async function removeProfilePicture() {
      const pictureStatus = document.getElementById('picture-status');
      pictureStatus.textContent = 'Removing...';
      pictureStatus.className = 'status';

      try {
        const res = await fetch('/api/profile/picture', {
          method: 'DELETE'
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'Failed to remove picture');
        }

        currentUser.profile_picture = null;
        hideProfilePicture();

        pictureStatus.textContent = 'âœ“ Profile picture removed';
        pictureStatus.className = 'status success';

        setTimeout(() => {
          pictureStatus.textContent = '';
        }, 3000);
      } catch (err) {
        pictureStatus.textContent = err.message;
        pictureStatus.className = 'status error';
      }
    }

    // Save profile changes
    document.getElementById('profile-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fullName = document.getElementById('full-name').value.trim();
      const status = document.getElementById('profile-status');
      const phoneError = document.getElementById('phone-error');

      // Hide phone error initially
      phoneError.style.display = 'none';

      if (!fullName) {
        status.textContent = 'Full name is required';
        status.className = 'status error';
        return;
      }

      // Validate phone number using custom phone input
      if (!phoneInput || !phoneInput.isValid()) {
        phoneError.style.display = 'block';
        status.textContent = 'Please fix the errors above';
        status.className = 'status error';
        return;
      }

      // Get phone number in E.164 format
      const phoneNumber = phoneInput.getNumber();

      status.textContent = 'Saving...';
      status.className = 'status';

      try {
        const res = await fetch('/api/profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ fullName, phoneNumber })
        });
        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'Failed to update profile');
        }

        // Update current user data
        currentUser.full_name = fullName;
        currentUser.phone_number = phoneNumber;

        // Refresh avatar (in case name changed, initials might change)
        const avatarContainer = document.getElementById('profile-avatar-container');
        avatarContainer.innerHTML = generateAvatarHTML(currentUser, 'large');

        // Update top header
        document.getElementById('user-info-display').textContent = `${fullName} | ${currentUser.email}`;

        status.textContent = 'âœ“ Profile updated successfully';
        status.className = 'status success';

        setTimeout(() => {
          status.textContent = '';
        }, 3000);
      } catch (err) {
        status.textContent = err.message;
        status.className = 'status error';
      }
    });

    // Logout
    async function logout() {
      try {
        await fetch('/auth/logout', { method: 'POST' });
        window.location.href = '/';
      } catch (err) {
        console.error('Logout error:', err);
        window.location.href = '/';
      }
    }

    // Initialize
    loadProfile();
  </script>
</body>
</html>
