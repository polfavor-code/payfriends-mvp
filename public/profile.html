<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PayFriends â€” My Profile</title>
  <style>
    :root{
      --bg:#0e1116; --card:#151a21; --text:#e6eef6; --muted:#a7b0bd; --accent:#3ddc97;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif; background:var(--bg); color:var(--text);}
    .container{max-width:600px;margin:0 auto;padding:32px 16px;}
    .card{background:var(--card);border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:24px;margin:16px 0}
    .row{margin:20px 0}
    .row label{display:block; margin-bottom:8px; color:var(--muted); font-size:14px; font-weight:500}
    .row input{width:100%; padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text); font-size:15px}
    .row input:disabled{opacity:0.6; cursor:not-allowed}
    button{width:100%; padding:12px;border-radius:10px;border:0;background:var(--accent);color:#0d130f;font-weight:700; cursor:pointer; font-size:15px; margin-top:8px}
    button:hover{filter:brightness(1.06)}
    .status{color:var(--muted); margin-top:12px; min-height:1.2em; font-size:14px; text-align:center}
    .error{color:#ff6b6b}
    .success{color:var(--accent)}
    .top-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid rgba(255,255,255,0.08)}
    .top-header-left{display:flex; align-items:center; gap:12px}
    .top-header-right{display:flex; flex-direction:column; align-items:flex-end; gap:8px}
    .logo-coin{height:54px; width:auto}
    .top-header-text{display:flex; flex-direction:column; gap:2px}
    .app-name{font-size:24px; font-weight:600; line-height:1.2; margin:0}
    .user-meta{color:var(--muted); font-size:14px; line-height:1.2}
    .app-slogan{color:var(--muted); font-size:14px; line-height:1.2; margin-top:2px}
    .top-header-user-info{color:var(--text); font-size:14px; text-align:right}
    .top-header-actions{display:flex; gap:12px; align-items:center}
    .logout-btn{padding:8px 16px;border-radius:8px;border:1px solid rgba(255,255,255,0.15);background:transparent;color:var(--text);font-weight:500; cursor:pointer; font-size:14px; width:auto}
    .logout-btn:hover{background:rgba(255,255,255,0.05)}
  </style>
</head>
<body>
  <main class="container">
    <header class="top-header">
      <div class="top-header-left">
        <a href="/app" style="text-decoration:none; display:flex; align-items:center; gap:12px">
          <img src="/images/payfriends-logov2.png" class="logo-coin" alt="PayFriends logo" />
          <div class="top-header-text">
            <div class="app-name" style="color:var(--text)">PayFriends.app</div>
            <div class="app-slogan">Pay friends, stay friends</div>
          </div>
        </a>
      </div>
      <div class="top-header-right">
        <div class="top-header-user-info" id="user-info-display">Loading...</div>
        <div class="top-header-actions">
          <a href="/app" style="color:var(--text); text-decoration:none; padding:8px 16px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background:transparent; font-weight:500; font-size:14px; display:inline-block">Activity</a>
          <a href="/profile" style="color:var(--text); text-decoration:none; padding:8px 16px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background:transparent; font-weight:500; font-size:14px; display:inline-block; white-space:nowrap">My Profile</a>
          <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
      </div>
    </header>

    <section class="card">
      <h2 style="margin-top:0; margin-bottom:24px">Profile Information</h2>

      <!-- Profile Picture Section -->
      <div style="margin-bottom:32px; text-align:center">
        <label style="display:block; color:var(--muted); font-weight:500; margin-bottom:12px; font-size:14px">Profile Picture</label>
        <div id="profile-picture-preview" style="width:120px; height:120px; margin:0 auto 16px; border-radius:50%; overflow:hidden; border:3px solid rgba(255,255,255,0.1); background:#10151d; display:flex; align-items:center; justify-content:center">
          <span id="no-picture-placeholder" style="font-size:48px; color:var(--muted)">ðŸ‘¤</span>
          <img id="profile-picture-img" style="width:100%; height:100%; object-fit:cover; display:none" />
        </div>
        <input type="file" id="picture-input" accept="image/jpeg,image/png,image/webp" style="display:none" />
        <button type="button" onclick="document.getElementById('picture-input').click()" style="width:auto; padding:8px 16px; font-size:14px; margin-right:8px">
          <span id="upload-btn-text">Upload Photo</span>
        </button>
        <button type="button" id="remove-picture-btn" onclick="removeProfilePicture()" style="width:auto; padding:8px 16px; font-size:14px; background:transparent; border:1px solid rgba(255,255,255,0.15); color:var(--text); display:none">
          Remove Photo
        </button>
        <p id="picture-status" class="status"></p>
      </div>

      <form id="profile-form">
        <div class="row">
          <label>Full legal name (as on passport)</label>
          <input id="full-name" type="text" placeholder="Jane Smith" required />
        </div>
        <div class="row">
          <label>Email</label>
          <input id="email" type="email" disabled />
        </div>
        <button type="submit">Save Changes</button>
        <p id="profile-status" class="status"></p>
      </form>
    </section>
  </main>

  <script>
    let currentUser = null;

    // Load user profile
    async function loadProfile() {
      try {
        const res = await fetch('/api/user');
        if (!res.ok) {
          window.location.href = '/';
          return;
        }
        const data = await res.json();
        currentUser = data.user;

        // Populate header user info
        const userName = currentUser.full_name || currentUser.email;
        document.getElementById('user-info-display').textContent = `${userName} | ${currentUser.email}`;

        document.getElementById('full-name').value = currentUser.full_name || '';
        document.getElementById('email').value = currentUser.email;

        // Load profile picture if available
        if (currentUser.profile_picture) {
          displayProfilePicture(currentUser.profile_picture);
        }
      } catch (err) {
        console.error('Error loading profile:', err);
        window.location.href = '/';
      }
    }

    // Display profile picture
    function displayProfilePicture(picturePath) {
      const img = document.getElementById('profile-picture-img');
      const placeholder = document.getElementById('no-picture-placeholder');
      const removeBtn = document.getElementById('remove-picture-btn');
      const uploadBtnText = document.getElementById('upload-btn-text');

      img.src = `/api/profile/picture/${currentUser.id}`;
      img.style.display = 'block';
      placeholder.style.display = 'none';
      removeBtn.style.display = 'inline-block';
      uploadBtnText.textContent = 'Change Photo';
    }

    // Hide profile picture
    function hideProfilePicture() {
      const img = document.getElementById('profile-picture-img');
      const placeholder = document.getElementById('no-picture-placeholder');
      const removeBtn = document.getElementById('remove-picture-btn');
      const uploadBtnText = document.getElementById('upload-btn-text');

      img.style.display = 'none';
      placeholder.style.display = 'block';
      removeBtn.style.display = 'none';
      uploadBtnText.textContent = 'Upload Photo';
    }

    // Handle profile picture upload
    document.getElementById('picture-input').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const pictureStatus = document.getElementById('picture-status');
      pictureStatus.textContent = 'Uploading...';
      pictureStatus.className = 'status';

      try {
        const formData = new FormData();
        formData.append('picture', file);

        const res = await fetch('/api/profile/picture', {
          method: 'POST',
          body: formData
        });

        // Check if response is JSON
        const contentType = res.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          throw new Error('Server returned an invalid response. Please try again.');
        }

        const data = await res.json();

        if (!data.success) {
          pictureStatus.textContent = data.error || 'There was a problem uploading your photo. Please try another image.';
          pictureStatus.className = 'status error';
          // Reset file input
          e.target.value = '';
          return;
        }

        currentUser.profile_picture = data.profilePictureUrl;
        displayProfilePicture(data.profilePictureUrl);

        pictureStatus.textContent = 'âœ“ Profile picture updated';
        pictureStatus.className = 'status success';

        setTimeout(() => {
          pictureStatus.textContent = '';
        }, 3000);
      } catch (err) {
        console.error('Profile picture upload error:', err);
        pictureStatus.textContent = 'There was a problem uploading your photo. Please try another image.';
        pictureStatus.className = 'status error';
      }

      // Reset file input
      e.target.value = '';
    });

    // Remove profile picture
    async function removeProfilePicture() {
      if (!confirm('Are you sure you want to remove your profile picture?')) {
        return;
      }

      const pictureStatus = document.getElementById('picture-status');
      pictureStatus.textContent = 'Removing...';
      pictureStatus.className = 'status';

      try {
        const res = await fetch('/api/profile/picture', {
          method: 'DELETE'
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'Failed to remove picture');
        }

        currentUser.profile_picture = null;
        hideProfilePicture();

        pictureStatus.textContent = 'âœ“ Profile picture removed';
        pictureStatus.className = 'status success';

        setTimeout(() => {
          pictureStatus.textContent = '';
        }, 3000);
      } catch (err) {
        pictureStatus.textContent = err.message;
        pictureStatus.className = 'status error';
      }
    }

    // Save profile changes
    document.getElementById('profile-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fullName = document.getElementById('full-name').value.trim();
      const status = document.getElementById('profile-status');

      if (!fullName) {
        status.textContent = 'Full name is required';
        status.className = 'status error';
        return;
      }

      status.textContent = 'Saving...';
      status.className = 'status';

      try {
        const res = await fetch('/api/profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ fullName })
        });
        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'Failed to update profile');
        }

        status.textContent = 'âœ“ Profile updated successfully';
        status.className = 'status success';

        setTimeout(() => {
          status.textContent = '';
        }, 3000);
      } catch (err) {
        status.textContent = err.message;
        status.className = 'status error';
      }
    });

    // Logout
    async function logout() {
      try {
        await fetch('/auth/logout', { method: 'POST' });
        window.location.href = '/';
      } catch (err) {
        console.error('Logout error:', err);
        window.location.href = '/';
      }
    }

    // Initialize
    loadProfile();
  </script>
</body>
</html>
