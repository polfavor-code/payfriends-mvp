<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GroupTab — PayFriends</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <script src="/js/formatters.js"></script>
  <style>
    :root{--bg:#0e1116; --card:#151a21; --text:#e6eef6; --muted:#a7b0bd; --accent:#3ddc97; --danger:#ef4444; --warning:#f97316;}
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif; background:var(--bg); color:var(--text);}
    .header{background:var(--card);border-bottom:1px solid rgba(255,255,255,0.08);padding:20px;text-align:center}
    .header h1{margin:0;font-size:28px;font-weight:700;color:var(--accent)}
    .header .tagline{color:var(--muted);font-size:14px;margin-top:4px}
    .container{max-width:900px;margin:0 auto;padding:24px 16px;padding-bottom:80px}
    .page-header{text-align:center;margin-bottom:32px}
    .page-header h2{margin:0 0 8px 0;font-size:24px;font-weight:700}
    .page-header .meta{color:var(--muted);font-size:14px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:24px;margin:16px 0}
    .summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:16px;margin-bottom:24px}
    .summary-item{background:#10151d;padding:16px;border-radius:12px;text-align:center}
    .summary-label{color:var(--muted);font-size:12px;margin-bottom:4px;text-transform:uppercase;font-weight:600}
    .summary-value{font-size:20px;font-weight:700}
    .summary-value.positive{color:var(--accent)}
    .summary-value.warning{color:var(--warning)}
    .fair-share-notice{text-align:center;color:var(--muted);font-size:14px;margin-top:12px}
    .fair-share-notice strong{color:var(--text)}
    .bill-image{max-width:100%;max-height:300px;border-radius:12px;margin:16px 0;cursor:pointer;display:block;margin-left:auto;margin-right:auto}
    .bill-image:hover{opacity:0.9}
    .section-title{font-size:18px;font-weight:600;margin:24px 0 12px 0}
    .payment-methods{background:#10151d;padding:16px;border-radius:12px;margin:16px 0}
    .payment-method{margin:12px 0;font-size:14px;line-height:1.6}
    .payment-method strong{color:var(--text);display:block;margin-bottom:4px}
    .payment-method-value{color:var(--muted);white-space:pre-wrap}
    .contributors-list{margin-top:16px}
    .contributor-item{background:#10151d;padding:12px 16px;border-radius:8px;margin:8px 0;display:flex;justify-content:space-between;align-items:center}
    .contributor-name{font-weight:600}
    .contributor-amounts{font-size:14px;text-align:right}
    .amount-confirmed{color:var(--accent);font-weight:600}
    .amount-pending{color:var(--warning);font-weight:600}
    .amount-badge{display:inline-block;padding:4px 8px;border-radius:6px;font-size:11px;font-weight:600;margin-left:8px}
    .amount-badge.overpaid{background:rgba(61,220,151,0.15);color:var(--accent);border:1px solid rgba(61,220,151,0.3)}
    .amount-badge.partial{background:rgba(249,115,22,0.15);color:var(--warning);border:1px solid rgba(249,115,22,0.3)}
    .amount-badge.pending-only{background:rgba(250,204,21,0.15);color:#facc15;border:1px solid rgba(250,204,21,0.3)}
    .people-summary{text-align:center;color:var(--muted);font-size:14px;margin:16px 0;padding:12px;background:#10151d;border-radius:8px}
    .people-summary strong{color:var(--text)}
    .your-contribution-section{background:linear-gradient(135deg,rgba(61,220,151,0.08) 0%,rgba(61,220,151,0.02) 100%);border:2px solid rgba(61,220,151,0.2);padding:24px;border-radius:16px;margin:24px 0}
    .your-contribution-section h3{margin:0 0 16px 0;color:var(--accent)}
    .name-input-group{margin-bottom:20px}
    .name-input-group label{display:block;margin-bottom:8px;font-weight:600;font-size:14px}
    .name-input-group input{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background:#10151d;color:var(--text);font-size:14px}
    .name-input-group input:focus{outline:none;border-color:var(--accent)}
    .circles-container{display:flex;justify-content:center;gap:40px;margin:24px 0;flex-wrap:wrap}
    .circle-wrapper{text-align:center}
    .circle{width:120px;height:120px;border-radius:50%;position:relative;display:flex;align-items:center;justify-content:center;flex-direction:column;background:#10151d;border:4px solid rgba(255,255,255,0.1)}
    .circle-label{font-size:11px;text-transform:uppercase;color:var(--muted);margin-bottom:4px;font-weight:600}
    .circle-value{font-size:18px;font-weight:700}
    .circle-secondary{font-size:11px;color:var(--muted);margin-top:2px}
    .circle.you-paid{border-color:var(--accent);background:rgba(61,220,151,0.05)}
    .circle.you-paid .circle-value{color:var(--accent)}
    .circle.fair-share{border-color:rgba(255,255,255,0.2)}
    .circle-status{text-align:center;margin-top:12px;font-size:14px;font-weight:600}
    .circle-status.overpaid{color:var(--accent)}
    .circle-status.underpaid{color:var(--warning)}
    .circle-status.paid{color:var(--accent)}
    .contribution-form{margin-top:24px}
    .form-group{margin-bottom:16px}
    .form-group label{display:block;margin-bottom:8px;font-weight:600;font-size:14px}
    .form-group input,.form-group select,.form-group textarea{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background:#10151d;color:var(--text);font-size:14px;font-family:inherit}
    .form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--accent)}
    .form-group .hint{font-size:12px;color:var(--muted);margin-top:4px}
    .form-row{display:grid;grid-template-columns:2fr 1fr;gap:12px}
    .btn-submit{width:100%;padding:14px;border-radius:10px;border:0;background:var(--accent);color:#0d130f;font-weight:700;cursor:pointer;font-size:16px;margin-top:8px}
    .btn-submit:hover{filter:brightness(1.06)}
    .btn-submit:disabled{opacity:0.5;cursor:not-allowed}
    .success-message{background:rgba(61,220,151,0.1);border:1px solid rgba(61,220,151,0.3);color:var(--accent);padding:16px;border-radius:8px;margin:16px 0;text-align:center}
    .error-message{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#fca5a5;padding:16px;border-radius:8px;margin:16px 0}
    .empty-state{text-align:center;padding:40px;color:var(--muted)}
    .closed-notice{background:rgba(156,163,175,0.1);border:1px solid rgba(156,163,175,0.3);color:#9ca3af;padding:16px;border-radius:8px;margin:16px 0;text-align:center;font-weight:600}
  </style>
</head>
<body>
  <div class="header">
    <h1>GroupTab</h1>
    <div class="tagline">Keep it fair in your group</div>
  </div>

  <div class="container" id="content"></div>

  <script>
    const slug = window.location.pathname.split('/').pop();
    let grouptabData = null;
    let yourName = localStorage.getItem(`gt_${slug}_name`) || '';

    async function loadGrouptab() {
      try {
        const response = await fetch(`/api/public/grouptabs/${slug}`);
        if (!response.ok) throw new Error('GroupTab not found');

        const data = await response.json();
        grouptabData = data;
        renderGrouptab(data);
      } catch (err) {
        console.error('Error loading grouptab:', err);
        document.getElementById('content').innerHTML = `
          <div class="empty-state">
            <h2>GroupTab Not Found</h2>
            <p>This GroupTab doesn't exist or has been deleted.</p>
          </div>
        `;
      }
    }

    function renderGrouptab(data) {
      const gt = data.grouptab;
      const guests = data.guests || [];

      const totalAmount = formatCurrency0(gt.total_amount_cents);
      const confirmedAmount = formatCurrency0(gt.confirmed_cents);
      const remainingAmount = formatCurrency0(gt.remaining_confirmed_cents);
      const eventDate = gt.event_date ? new Date(gt.event_date).toLocaleDateString() : '';
      const fairSharePerPerson = gt.people_count && gt.people_count > 0 ? Math.round(gt.total_amount_cents / gt.people_count) : null;

      // Count unique people who have reported
      const peopleWhoReported = guests.length;
      const peopleWhoHaventReported = gt.people_count ? Math.max(0, gt.people_count - peopleWhoReported) : null;

      let html = `
        <div class="page-header">
          <h2>${escapeHtml(gt.title)}</h2>
          <div class="meta">Hosted by ${escapeHtml(gt.owner_name)}${eventDate ? ` • ${eventDate}` : ''}</div>
          ${gt.description ? `<div class="meta" style="margin-top:8px">${escapeHtml(gt.description)}</div>` : ''}
        </div>

        <div class="card">
          <div class="summary-grid">
            <div class="summary-item">
              <div class="summary-label">Total Bill</div>
              <div class="summary-value">${totalAmount}</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Confirmed Paid</div>
              <div class="summary-value positive">${confirmedAmount}</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Still Missing</div>
              <div class="summary-value ${gt.remaining_confirmed_cents > 0 ? 'warning' : 'positive'}">${remainingAmount}</div>
            </div>
          </div>

          ${fairSharePerPerson ? `
            <div class="fair-share-notice">
              Suggested fair share: <strong>${formatCurrency0(fairSharePerPerson)}</strong> per person
            </div>
          ` : ''}

          ${gt.people_count ? `
            <div class="people-summary">
              ${gt.people_count} ${gt.people_count === 1 ? 'person' : 'people'} in total.
              ${peopleWhoReported > 0 ? `<strong>${peopleWhoReported}</strong> ${peopleWhoReported === 1 ? 'has' : 'have'} reported payments.` : 'No one has reported payments yet.'}
              ${peopleWhoHaventReported > 0 ? ` <strong>${peopleWhoHaventReported}</strong> ${peopleWhoHaventReported === 1 ? 'has' : 'have'} not reported yet.` : ''}
            </div>
          ` : ''}

          ${gt.bill_image_url ? `
            <img src="/${gt.bill_image_url}" alt="Bill" class="bill-image" onclick="window.open('/${gt.bill_image_url}', '_blank')" />
          ` : ''}
        </div>

        ${(gt.bank_details || gt.paypal_details || gt.other_payment_details) ? `
          <div class="section-title">How to Pay ${escapeHtml(gt.owner_name)}</div>
          <div class="payment-methods">
            ${gt.bank_details ? `
              <div class="payment-method">
                <strong>Bank Transfer:</strong>
                <div class="payment-method-value">${escapeHtml(gt.bank_details)}</div>
              </div>
            ` : ''}
            ${gt.paypal_details ? `
              <div class="payment-method">
                <strong>PayPal:</strong>
                <div class="payment-method-value">${escapeHtml(gt.paypal_details)}</div>
              </div>
            ` : ''}
            ${gt.other_payment_details ? `
              <div class="payment-method">
                <strong>Other Options:</strong>
                <div class="payment-method-value">${escapeHtml(gt.other_payment_details)}</div>
              </div>
            ` : ''}
          </div>
        ` : ''}

        ${guests.length > 0 ? `
          <div class="section-title">Who's Paid (${guests.length} ${guests.length === 1 ? 'person' : 'people'})</div>
          <div class="contributors-list">
            ${guests.map(g => {
              const confirmedAmt = formatCurrency0(g.confirmed_cents);
              const pendingAmt = formatCurrency0(g.pending_cents);
              let statusBadge = '';

              if (fairSharePerPerson) {
                if (g.confirmed_cents > 0 && g.pending_cents === 0) {
                  if (g.confirmed_cents >= fairSharePerPerson) {
                    statusBadge = g.confirmed_cents > fairSharePerPerson
                      ? '<span class="amount-badge overpaid">Overpaid</span>'
                      : '<span class="amount-badge overpaid">Paid</span>';
                  } else {
                    statusBadge = '<span class="amount-badge partial">Partially paid</span>';
                  }
                } else if (g.confirmed_cents === 0 && g.pending_cents > 0) {
                  statusBadge = '<span class="amount-badge pending-only">Pending</span>';
                }
              }

              return `
                <div class="contributor-item">
                  <div class="contributor-name">${escapeHtml(g.guest_name)}</div>
                  <div class="contributor-amounts">
                    ${g.confirmed_cents > 0 ? `<span class="amount-confirmed">✓ ${confirmedAmt}</span>` : ''}
                    ${g.pending_cents > 0 ? `<span class="amount-pending">⏱ ${pendingAmt}</span>` : ''}
                    ${statusBadge}
                  </div>
                </div>
              `;
            }).join('')}
          </div>

          ${peopleWhoHaventReported > 0 ? `
            <div class="people-summary" style="margin-top:16px">
              ${peopleWhoHaventReported} ${peopleWhoHaventReported === 1 ? 'person has' : 'people have'} not reported any payment yet.
            </div>
          ` : ''}
        ` : gt.people_count ? `
          <div class="people-summary" style="margin-top:24px">
            ${gt.people_count} ${gt.people_count === 1 ? 'person' : 'people'} in total. No one has reported payments yet.
          </div>
        ` : ''}

        <div class="your-contribution-section">
          <h3>Report Your Payment</h3>

          ${gt.status === 'closed' ? `
            <div class="closed-notice">This GroupTab has been closed by the host. You can no longer report payments.</div>
          ` : ''}

          <div class="name-input-group">
            <label for="your-name">Your Name</label>
            <input type="text" id="your-name" placeholder="Enter your name" value="${escapeHtml(yourName)}" ${gt.status === 'closed' ? 'disabled' : ''} />
          </div>

          <div id="circles-section"></div>

          ${gt.status === 'open' ? `
            <form id="contribution-form" class="contribution-form">
              <div class="form-row">
                <div class="form-group">
                  <label for="amount">Amount You're Paying</label>
                  <input type="number" id="amount" name="amount" step="0.01" min="0.01" placeholder="${fairSharePerPerson ? (fairSharePerPerson / 100).toFixed(2) : '20.00'}" required />
                  ${fairSharePerPerson ? `<div class="hint">Fair share: ${formatCurrency0(fairSharePerPerson)}</div>` : ''}
                </div>

                <div class="form-group">
                  <label for="method">Payment Method</label>
                  <select id="method" name="method" required>
                    <option value="">Select...</option>
                    <option value="Bank transfer">Bank transfer</option>
                    <option value="PayPal">PayPal</option>
                    <option value="Cash">Cash</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
              </div>

              <div class="form-group">
                <label for="comment">Comment (optional)</label>
                <textarea id="comment" name="comment" placeholder="e.g., Paid yesterday via Revolut" rows="2"></textarea>
              </div>

              <div id="form-messages"></div>

              <button type="submit" class="btn-submit" id="submit-btn">I Have Paid This</button>
            </form>
          ` : ''}
        </div>
      `;

      document.getElementById('content').innerHTML = html;

      // Set up name input listener
      const nameInput = document.getElementById('your-name');
      if (nameInput) {
        nameInput.addEventListener('input', (e) => {
          yourName = e.target.value.trim();
          if (yourName) {
            localStorage.setItem(`gt_${slug}_name`, yourName);
          } else {
            localStorage.removeItem(`gt_${slug}_name`);
          }
          updateCircles();
        });

        // Update circles on initial load if name is set
        if (yourName) {
          updateCircles();
        }
      }

      // Set up form submission
      const form = document.getElementById('contribution-form');
      if (form) {
        form.addEventListener('submit', handleSubmit);
      }
    }

    function updateCircles() {
      const circlesSection = document.getElementById('circles-section');
      if (!circlesSection || !grouptabData) return;

      const gt = grouptabData.grouptab;
      const fairSharePerPerson = gt.people_count && gt.people_count > 0 ? Math.round(gt.total_amount_cents / gt.people_count) : null;

      // Only show circles if name is entered AND fair share is defined
      if (!yourName || !fairSharePerPerson) {
        circlesSection.innerHTML = '';
        return;
      }

      // Find current guest's data
      const currentGuest = grouptabData.guests.find(g => g.guest_name.toLowerCase() === yourName.toLowerCase());
      const yourConfirmed = currentGuest ? currentGuest.confirmed_cents : 0;
      const yourPending = currentGuest ? currentGuest.pending_cents : 0;

      const confirmedFormatted = formatCurrency0(yourConfirmed);
      const fairShareFormatted = formatCurrency0(fairSharePerPerson);

      let statusMessage = '';
      if (yourConfirmed > fairSharePerPerson) {
        const overpaidAmount = formatCurrency0(yourConfirmed - fairSharePerPerson);
        statusMessage = `<div class="circle-status overpaid">You've overpaid by ${overpaidAmount} - thank you for helping cover others!</div>`;
      } else if (yourConfirmed >= fairSharePerPerson) {
        statusMessage = `<div class="circle-status paid">You've covered your fair share!</div>`;
      } else if (yourConfirmed > 0) {
        const stillOwedAmount = formatCurrency0(fairSharePerPerson - yourConfirmed);
        statusMessage = `<div class="circle-status underpaid">You still need to pay ${stillOwedAmount} to cover your full share</div>`;
      } else if (yourPending > 0) {
        statusMessage = `<div class="circle-status underpaid">Your payment of ${formatCurrency0(yourPending)} is pending host confirmation</div>`;
      } else {
        statusMessage = `<div class="circle-status underpaid">You haven't reported any payment yet</div>`;
      }

      circlesSection.innerHTML = `
        <div class="circles-container">
          <div class="circle-wrapper">
            <div class="circle you-paid">
              <div class="circle-label">You Paid</div>
              <div class="circle-value">${confirmedFormatted}</div>
              ${yourPending > 0 ? `<div class="circle-secondary">+${formatCurrency0(yourPending)} pending</div>` : ''}
            </div>
          </div>

          <div class="circle-wrapper">
            <div class="circle fair-share">
              <div class="circle-label">Your Share</div>
              <div class="circle-value">${fairShareFormatted}</div>
            </div>
          </div>
        </div>

        ${statusMessage}
      `;
    }

    async function handleSubmit(e) {
      e.preventDefault();

      if (!yourName || !yourName.trim()) {
        alert('Please enter your name first');
        document.getElementById('your-name').focus();
        return;
      }

      const formData = new FormData(e.target);
      formData.append('guestName', yourName.trim());

      const submitBtn = document.getElementById('submit-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';

      try {
        const response = await fetch(`/api/public/grouptabs/${slug}/contributions`, {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to submit contribution');
        }

        const amount = document.getElementById('amount').value;
        const method = document.getElementById('method').value;

        // Show success message
        document.getElementById('form-messages').innerHTML = `
          <div class="success-message">
            Thank you! Your payment of ${amount} EUR via ${method} has been reported and is waiting for host confirmation.
          </div>
        `;

        // Reset form
        e.target.reset();

        // Reload grouptab data
        await loadGrouptab();

        // Scroll to circles
        setTimeout(() => {
          document.getElementById('circles-section')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 500);
      } catch (err) {
        console.error('Error submitting contribution:', err);
        document.getElementById('form-messages').innerHTML = `
          <div class="error-message">${err.message}</div>
        `;
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'I Have Paid This';
      }
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    loadGrouptab();
  </script>
</body>
</html>
