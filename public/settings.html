<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PayFriends â€” Settings</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <!-- Shared control styles -->
  <link rel="stylesheet" href="/css/shared-controls.css" />
  <!-- Shared header component -->
  <script src="/js/header.js"></script>
  <style>
    :root{
      --bg:#0e1116; --card:#151a21; --text:#e6eef6; --muted:#a7b0bd; --accent:#3ddc97;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif; background:var(--bg); color:var(--text);}
    .container{max-width:1200px;margin:0 auto;padding:32px 16px;}
    .card{background:var(--card);border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:24px;margin:16px 0}
    .section-title{font-size:18px; font-weight:600; margin:0 0 16px 0; color:var(--text)}
    .section-description{color:var(--muted); font-size:14px; margin-bottom:20px; line-height:1.5}
    .row{margin:20px 0}
    .row label{display:block; margin-bottom:8px; color:var(--muted); font-size:14px; font-weight:500}
    .row input, .row select{width:100%; padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text); font-size:15px}
    .row input:focus, .row select:focus{outline:none; border-color:var(--accent); background:#10151d}
    .row input:hover, .row select:hover{background:#10151d}
    .row input:disabled{opacity:0.6; cursor:not-allowed}
    .row select{cursor:pointer; appearance:none; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23a7b0bd' d='M6 9L1 4h10z'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 12px center}
    .helper-text{color:var(--muted); font-size:13px; margin-top:6px; line-height:1.4}
    button{width:100%; padding:12px;border-radius:10px;border:0;background:var(--accent);color:#0d130f;font-weight:700; cursor:pointer; font-size:15px; margin-top:8px}
    button:hover{filter:brightness(1.06)}
    button:disabled{opacity:0.6; cursor:not-allowed; filter:none}
    .status{color:var(--muted); margin-top:12px; min-height:1.2em; font-size:14px; text-align:center}
    .error{color:#ff6b6b}
    .success{color:var(--accent)}

    /* Phone input widget */
    .phone-input-wrapper{position:relative}
    .phone-country-flag{font-size:18px}
    .phone-country-name{flex:1;white-space:nowrap}
    .phone-caret{font-size:10px;color:var(--muted);flex-shrink:0}
    .phone-number-full{display:none}
    .phone-dropdown{display:none;position:absolute;top:100%;left:0;right:0;margin-top:4px;background:#151a21;border:1px solid rgba(255,255,255,0.15);border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,0.4);z-index:1000;max-height:320px;overflow:hidden}
    .phone-dropdown-search{width:calc(100% - 24px);margin:12px;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:#10151d;color:var(--text);font-size:14px}
    .phone-dropdown-list{max-height:240px;overflow-y:auto}
    .phone-dropdown-item{padding:12px 16px;cursor:pointer;display:flex;gap:12px;align-items:center;color:var(--text);font-size:14px;border-bottom:1px solid rgba(255,255,255,0.04)}
    .phone-dropdown-item:last-child{border-bottom:none}
    .phone-dropdown-item:hover{background:rgba(255,255,255,0.04)}
    .phone-dropdown-item.selected{background:rgba(61,220,151,0.1)}
    .phone-number-input{padding-left:12px;flex:1;background:transparent;border:none;color:var(--text);font-size:15px;outline:none;width:100%}
    .phone-input-display{display:flex;align-items:center;gap:8px;width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background:#10151d;cursor:pointer}
    .phone-input-display:hover{background:#10151d}

    .page-title{font-size:28px; font-weight:600; margin:0 0 24px 0}
    .divider{height:1px; background:rgba(255,255,255,0.08); margin:32px 0}
    .link-style{color:var(--accent); text-decoration:none; cursor:pointer}
    .link-style:hover{text-decoration:underline}
    .link-button{background:none; border:0; padding:0; margin-left:4px; color:var(--accent); cursor:pointer; font:inherit; text-decoration:underline}
  </style>
</head>
<body>
  <div class="container">
    <h1 class="page-title">Settings</h1>

    <!-- App Preferences -->
    <div class="card">
      <h2 class="section-title">App Preferences</h2>
      <p class="section-description">Customize your app experience and display settings</p>

      <div class="row">
        <label for="timezone">Timezone</label>
        <select id="timezone"></select>
        <div class="helper-text">
          This timezone is used to show history and activity timestamps in your local time.<br>
          Financial dates like due dates are calendar days and do not depend on timezone.
        </div>
        <div class="helper-text" id="timezoneHint"></div>
      </div>

      <button id="savePreferencesBtn">Save Preferences</button>
      <div class="status" id="preferencesStatus"></div>
    </div>
  </div>

  <script>
    // Common IANA timezones list
    const TIMEZONES = [
      'Europe/Amsterdam',
      'Europe/London',
      'Europe/Paris',
      'Europe/Berlin',
      'Europe/Madrid',
      'Europe/Rome',
      'Europe/Brussels',
      'Europe/Vienna',
      'Europe/Stockholm',
      'Europe/Copenhagen',
      'Europe/Oslo',
      'Europe/Helsinki',
      'Europe/Dublin',
      'Europe/Lisbon',
      'Europe/Warsaw',
      'Europe/Prague',
      'Europe/Budapest',
      'Europe/Athens',
      'Europe/Bucharest',
      'Europe/Moscow',
      'America/New_York',
      'America/Chicago',
      'America/Denver',
      'America/Los_Angeles',
      'America/Toronto',
      'America/Vancouver',
      'America/Mexico_City',
      'America/Sao_Paulo',
      'America/Buenos_Aires',
      'America/Lima',
      'America/Bogota',
      'America/Santiago',
      'Asia/Dubai',
      'Asia/Tokyo',
      'Asia/Hong_Kong',
      'Asia/Shanghai',
      'Asia/Singapore',
      'Asia/Seoul',
      'Asia/Bangkok',
      'Asia/Jakarta',
      'Asia/Manila',
      'Asia/Kolkata',
      'Asia/Karachi',
      'Asia/Taipei',
      'Asia/Istanbul',
      'Australia/Sydney',
      'Australia/Melbourne',
      'Australia/Brisbane',
      'Australia/Perth',
      'Pacific/Auckland',
      'Pacific/Fiji',
      'Pacific/Honolulu',
      'Africa/Cairo',
      'Africa/Johannesburg',
      'Africa/Nairobi',
      'Africa/Lagos',
      'UTC'
    ].sort();

    let currentUser = null;
    let detectedTimezoneGlobal = null;

    /**
     * Initialize timezone dropdown with user timezone or browser-detected timezone
     * @param {string|null} savedTimezone - User's stored timezone
     * @param {string|null} detectedTimezone - Browser-detected timezone
     */
    function initializeTimezoneSelect(savedTimezone, detectedTimezone) {
      const timezoneSelect = document.getElementById('timezone');
      const hintEl = document.getElementById('timezoneHint');

      timezoneSelect.innerHTML = '';
      if (hintEl) hintEl.innerHTML = '';

      detectedTimezoneGlobal = detectedTimezone || null;

      const currentTimezone = savedTimezone || detectedTimezone || 'Europe/Amsterdam';

      TIMEZONES.forEach(tz => {
        const opt = document.createElement('option');
        opt.value = tz;
        opt.textContent = tz.replace(/_/g, ' ');
        if (tz === currentTimezone) opt.selected = true;
        timezoneSelect.appendChild(opt);
      });

      // Show mismatch hint
      if (savedTimezone && detectedTimezone && savedTimezone !== detectedTimezone && hintEl) {
        hintEl.innerHTML = `
          Your current browser timezone is <strong>${detectedTimezone.replace(/_/g, ' ')}</strong>.
          <button type="button" class="link-button" id="useBrowserTimezoneBtn">Use current timezone</button>
        `;

        const btn = document.getElementById('useBrowserTimezoneBtn');
        btn.addEventListener('click', () => {
          if (!detectedTimezoneGlobal) return;
          timezoneSelect.value = detectedTimezoneGlobal;
          savePreferences();
        });
      }
    }

    /**
     * Load current user timezone from backend
     */
    async function loadCurrentUserTimezone() {
      let detectedTimezone = null;
      try {
        detectedTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
      } catch (e) {
        console.warn('Could not detect browser timezone:', e);
      }

      try {
        const res = await fetch('/api/user');
        if (!res.ok) throw new Error('Failed to load user');

        const data = await res.json();
        currentUser = data.user;

        const savedTimezone = currentUser.timezone || null;
        initializeTimezoneSelect(savedTimezone, detectedTimezone);
      } catch (err) {
        console.error(err);
        initializeTimezoneSelect(null, detectedTimezone);
      }
    }

    async function savePreferences() {
      const timezone = document.getElementById('timezone').value;

      if (!timezone) {
        showStatus('preferencesStatus', 'Please select a timezone', 'error');
        return;
      }

      try {
        const payload = {
          timezone: timezone
        };

        // If backend requires fullName and phoneNumber in the same call, include them
        if (currentUser) {
          if (currentUser.full_name) {
            payload.fullName = currentUser.full_name;
          }
          if (currentUser.phone_number) {
            payload.phoneNumber = currentUser.phone_number;
          }
        }

        const res = await fetch('/api/profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.error || 'Failed to save preferences');
        }

        // Update local copy so later saves use the new value
        if (!currentUser) currentUser = {};
        currentUser.timezone = timezone;

        showStatus('preferencesStatus', 'Preferences updated successfully', 'success');
      } catch (err) {
        console.error('Error saving preferences:', err);
        showStatus('preferencesStatus', 'Failed to save preferences. Please try again.', 'error');
      }
    }

    function showStatus(elementId, message, type) {
      const el = document.getElementById(elementId);
      el.textContent = message;
      el.className = 'status ' + type;
      if (type === 'success') {
        setTimeout(() => {
          el.textContent = '';
          el.className = 'status';
        }, 3000);
      }
    }

    // Event listeners
    document.getElementById('savePreferencesBtn').addEventListener('click', savePreferences);

    // Load user timezone on page load
    loadCurrentUserTimezone();

    // Initialize header
    PayFriendsHeader.initialize();
  </script>
</body>
</html>
