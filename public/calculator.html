<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Loan Calculator - PayFriends</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #0c1015 0%, #1a1f2e 100%);
      color: #e5e7eb;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: rgba(31, 41, 55, 0.6);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 8px;
      color: #fff;
    }

    .subtitle {
      color: #9ca3af;
      font-size: 14px;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }

    @media (max-width: 1024px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: rgba(31, 41, 55, 0.6);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 24px;
    }

    .card h2 {
      font-size: 18px;
      margin-bottom: 20px;
      color: #fff;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 8px;
      color: #d1d5db;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      background: rgba(12, 16, 21, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 10px 12px;
      color: #e5e7eb;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: rgba(59, 130, 246, 0.5);
    }

    .form-group input:disabled,
    .form-group select:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .form-group input[type="number"] {
      font-variant-numeric: tabular-nums;
    }

    /* Highlight for empty loan amount input */
    .loan-amount-empty {
      border-color: #34d399 !important;
      box-shadow: 0 0 0 1px #34d399;
    }

    .form-hint {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 6px;
      font-style: italic;
    }

    .hidden {
      display: none;
    }

    .btn {
      width: 100%;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.2s;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .btn:active {
      transform: translateY(0);
    }

    .totals {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .total-card {
      background: rgba(12, 16, 21, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      padding: 16px;
    }

    .total-label {
      font-size: 12px;
      text-transform: uppercase;
      color: #9ca3af;
      margin-bottom: 8px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .total-value {
      font-size: 24px;
      font-weight: 700;
      color: #fff;
      font-variant-numeric: tabular-nums;
    }

    .schedule-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .loan-meta {
      margin-bottom: 16px;
    }

    .loan-meta-primary {
      font-size: 15px;
      font-weight: 500;
      color: #e5e7eb;
    }

    .loan-meta-secondary {
      margin-top: 4px;
      font-size: 14px;
      font-weight: 500;
      color: #34d399;
    }

    .schedule-subtitle {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 16px;
    }

    .schedule-table {
      overflow-x: auto;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      background: rgba(12, 16, 21, 0.8);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead th {
      background: rgba(31, 41, 55, 0.98);
      padding: 12px;
      text-align: left;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      color: #9ca3af;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    thead th.align-right {
      text-align: right;
    }

    tbody td {
      padding: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      color: #d1d5db;
    }

    tbody td.align-right {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    tbody tr:nth-child(even) {
      background: rgba(10, 13, 17, 0.6);
    }

    tbody tr:hover {
      background: rgba(55, 65, 81, 0.3);
    }

    tfoot td {
      padding: 16px 12px;
      border-top: 2px solid rgba(16, 185, 129, 0.6);
      background: rgba(16, 185, 129, 0.1);
      font-weight: 700;
      color: #34d399;
      font-size: 14px;
    }

    tfoot td.align-right {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    tfoot td:first-child {
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge-preview {
      background: rgba(59, 130, 246, 0.2);
      color: #60a5fa;
    }

    .badge-actual {
      background: rgba(16, 185, 129, 0.2);
      color: #34d399;
    }

    .info-box {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 8px;
      padding: 12px;
      margin-top: 16px;
      font-size: 13px;
      color: #93c5fd;
      line-height: 1.5;
    }

    .debug-console {
      background: rgba(12, 16, 21, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      padding: 16px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      color: #a5f3fc;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .error-message {
      color: #ef4444;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="main-grid">
      <!-- Left sidebar: Form inputs -->
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="margin-bottom: 0;">Configuration</h2>
          <button type="button" id="calculator-reset-link" style="background: none; border: none; color: #34d399; cursor: pointer; font-size: 14px; padding: 0;">Reset</button>
        </div>

        <!-- 1. Loan amount -->
        <div class="form-group">
          <label for="principal">Loan amount (€)</label>
          <input type="text" id="principal" placeholder="e.g. 6,000">
          <div id="principalError" class="form-hint" style="display: none; color: #ef4444; font-style: normal; margin-top: 6px;"></div>
        </div>

        <!-- 2. Loan start date -->
        <div class="form-group">
          <label for="loanStartMode">Loan start date (when borrower receives the money)</label>
          <select id="loanStartMode">
            <option value="upon_acceptance" selected>When agreement is accepted</option>
            <option value="today">Today</option>
            <option value="tomorrow">Tomorrow</option>
            <option value="in-1-week">In 1 week</option>
            <option value="in-1-month">In 1 month</option>
            <option value="pick-date">Pick a date…</option>
          </select>
          <div class="form-hint">Date used for interest and repayment calculations.</div>
        </div>

        <div id="loanStartDateGroup" class="form-group hidden">
          <label for="loanStartDate">Pick a date</label>
          <input type="date" id="loanStartDate">
        </div>

        <!-- 4. Repayment type -->
        <div class="form-group">
          <label for="repaymentType">Repayment type</label>
          <select id="repaymentType">
            <option value="one_time" selected>One-time payment</option>
            <option value="installments">Installments</option>
          </select>
        </div>

        <!-- 5. First payment due -->
        <div class="form-group" id="firstPaymentGroup">
          <label for="firstPaymentDue">
            <span id="paymentTimingLabel">First payment due (after loan start)</span>
          </label>
          <select id="firstPaymentDue">
            <option value="1-week">In 1 week</option>
            <option value="1-month">In 1 month</option>
            <option value="6-months">In 6 months</option>
            <option value="1-year" selected>In 1 year</option>
            <option value="2-years">In 2 years</option>
            <option value="3-years">In 3 years</option>
            <option value="pick-date">Pick a date…</option>
          </select>
          <div class="form-hint" id="paymentTimingHint">When full repayment is due.</div>
        </div>

        <div id="firstPaymentDateGroup" class="form-group hidden">
          <label for="firstPaymentDate">Pick a date</label>
          <input type="date" id="firstPaymentDate">
        </div>

        <!-- 6. Payment frequency -->
        <div class="form-group" id="frequencyGroup">
          <label for="frequency">Payment frequency</label>
          <select id="frequency">
            <optgroup label="Day-based">
              <option value="every-7-days">Every 7 days</option>
              <option value="every-14-days">Every 14 days</option>
              <option value="every-30-days">Every 30 days</option>
            </optgroup>
            <optgroup label="Month-based (same day of month)">
              <option value="every-month" selected>Every month</option>
              <option value="every-3-months">Every 3 months</option>
              <option value="every-6-months">Every 6 months</option>
            </optgroup>
            <optgroup label="Weekday-based (same weekday)">
              <option value="every-week">Every week</option>
              <option value="every-2-weeks">Every 2 weeks</option>
              <option value="every-4-weeks">Every 4 weeks</option>
            </optgroup>
            <optgroup label="Year-based (same date)">
              <option value="every-year">Every year</option>
              <option value="every-2-years">Every 2 years</option>
              <option value="every-3-years">Every 3 years</option>
            </optgroup>
          </select>
        </div>

        <!-- 7. Number of installments -->
        <div class="form-group" id="installmentsGroup">
          <label for="numInstallments">Number of installments</label>
          <input type="number" id="numInstallments" value="12" min="1" max="120" step="1">
          <div class="form-hint" id="installmentsHint" style="display: none;">
            For one-time payments the loan is repaid in a single payment.
          </div>
        </div>

        <!-- 8. Interest Section -->
        <div class="form-group" style="margin-top: 32px; padding-top: 24px; border-top: 1px solid rgba(255, 255, 255, 0.06);">
          <label style="display: block; margin-bottom: 12px;">Interest</label>

          <!-- Interest / No interest toggle -->
          <div id="interest-mode-toggle" style="display: inline-flex; background: #10151d; border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 10px; padding: 4px; gap: 4px; margin-bottom: 16px;">
            <button id="mode-interest" type="button" style="padding: 10px 20px; border-radius: 8px; border: none; background: #6ee7b7; color: #000; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s ease; flex: 1; white-space: nowrap;">
              Interest
            </button>
            <button id="mode-no-interest" type="button" style="padding: 10px 20px; border-radius: 8px; border: none; background: transparent; color: #e5e7eb; font-weight: 500; font-size: 14px; cursor: pointer; transition: all 0.2s ease; flex: 1; white-space: nowrap;">
              No interest
            </button>
          </div>

          <!-- Interest input row with Fair range pill -->
          <div id="interest-input-row" style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <input type="number" id="interest" value="5" min="0" max="100" step="0.1" style="width: 80px; height: 44px; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.08); background: #10151d; color: var(--text); font-size: 16px; text-align: center;">
              <span style="color: var(--text); font-size: 16px; font-weight: 500;">% per year</span>
            </div>
            <button id="fair-range-pill" type="button" aria-expanded="false" aria-controls="fair-range-explanation" style="display: inline-flex; align-items: center; gap: 6px; height: 44px; padding: 0 16px; border-radius: 22px; font-size: 13px; font-weight: 600; white-space: nowrap; border: none; cursor: pointer; transition: all 0.2s ease; background: rgba(52, 211, 153, 0.15); color: #34d399;">
              <span id="fair-range-text">Fair range (4–7%)</span>
              <svg style="width: 14px; height: 14px; opacity: 0.8;" viewBox="0 0 16 16" fill="none" stroke="currentColor">
                <circle cx="8" cy="8" r="6.5" stroke-width="1.5"/>
                <path d="M8 7.5v4M8 5v0.5" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
          </div>

          <!-- Expandable "Why this rate?" explanation -->
          <div id="fair-range-explanation" class="hidden" style="margin-top: 12px; background: rgba(61, 220, 151, 0.08); border: 1px solid rgba(61, 220, 151, 0.2); border-radius: 10px; padding: 16px; transition: all 0.2s ease;">
            <p style="margin: 0 0 12px 0; font-size: 13px; font-weight: 600; color: var(--text);">Why this rate?</p>
            <ul style="margin: 0 0 12px 0; padding-left: 20px; font-size: 13px; line-height: 1.6; color: var(--text);">
              <li style="margin-bottom: 6px;">Larger loan amounts increase risk ↑</li>
              <li style="margin-bottom: 6px;">Longer durations increase uncertainty ↑</li>
              <li style="margin-bottom: 6px;">More installments reduce repayment risk ↓</li>
            </ul>
            <p style="margin: 0; font-size: 13px; color: var(--muted); line-height: 1.6;">
              Together, these factors suggest a fair interest range for this loan. Your chosen rate should normally stay inside this range for balanced, respectful lending between friends.
            </p>
          </div>
        </div>

      </div>

      <!-- Right side: Results -->
      <div>
        <!-- Schedule table -->
        <div class="card">
          <div class="schedule-header">
            <h2>Repayment schedule & interest calculation</h2>
            <span id="modeBadge"><span class="badge badge-preview">Preview</span></span>
          </div>
          <div class="loan-meta">
            <div class="loan-meta-primary" id="loanStartLabel">Enter loan amount and details to see the repayment schedule...</div>
            <div class="loan-meta-secondary" id="loanDurationLabel" style="display: none;"></div>
          </div>
          <div class="schedule-table">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Due date</th>
                  <th class="align-right">Principal</th>
                  <th class="align-right">Interest</th>
                  <th class="align-right">Total payment</th>
                  <th class="align-right">Balance</th>
                </tr>
              </thead>
              <tbody id="scheduleBody">
                <tr>
                  <td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">
                    Enter loan amount and details to see the repayment schedule...
                  </td>
                </tr>
              </tbody>
              <tfoot id="scheduleTotals" style="display: none;">
                <tr style="color: #34d399;">
                  <td colspan="2" style="text-align: left;">Loan totals</td>
                  <td class="align-right" id="footerPrincipal">€ 0,00</td>
                  <td class="align-right" id="footerInterest">€ 0,00</td>
                  <td class="align-right" id="footerTotal">€ 0,00</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <!-- Loan summary -->
        <div class="card" style="margin-top: 24px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3);">
          <h2 style="color: #34d399; margin-bottom: 16px;">Loan summary</h2>
          <div id="loanSummaryContent" style="font-size: 15px; line-height: 1.8; color: #d1d5db;">
            Configure parameters to see loan summary...
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/formatters.js"></script>
  <script src="/components/fairness-icon.js"></script>
  <script>
    // Calculator Playground Logic - Single Source of Truth
    // This generateRepaymentSchedule function can be reused across wizard, manage, and review pages

    // Get formatting functions from window
    const formatMoney = window.formatCurrency2;

    // Safe DOM references for principal input and error elements
    let principalInput = null;
    let principalError = null;

    function getPrincipalInputElement() {
      if (!principalInput) {
        principalInput = document.getElementById('principal');
      }
      return principalInput;
    }

    function getPrincipalErrorElement() {
      if (!principalError) {
        principalError = document.getElementById('principalError');
      }
      return principalError;
    }

    /**
     * Add days to a date
     */
    function addDays(date, days) {
      const result = new Date(date);
      result.setDate(result.getDate() + days);
      return result;
    }

    /**
     * Add months to a date, handling month-end edge cases
     */
    function addMonths(date, months) {
      const result = new Date(date);
      const targetMonth = result.getMonth() + months;
      const targetYear = result.getFullYear() + Math.floor(targetMonth / 12);
      const normalizedMonth = ((targetMonth % 12) + 12) % 12;

      const originalDay = result.getDate();
      result.setFullYear(targetYear, normalizedMonth, 1);
      const daysInTargetMonth = new Date(targetYear, normalizedMonth + 1, 0).getDate();
      const clampedDay = Math.min(originalDay, daysInTargetMonth);
      result.setDate(clampedDay);

      return result;
    }

    /**
     * Add years to a date, handling Feb 29 edge case
     */
    function addYears(date, years) {
      const result = new Date(date);
      const targetYear = result.getFullYear() + years;
      const originalMonth = result.getMonth();
      const originalDay = result.getDate();

      // Handle Feb 29 in leap year -> non-leap year
      if (originalMonth === 1 && originalDay === 29) {
        const isLeapYear = (targetYear % 4 === 0 && targetYear % 100 !== 0) || (targetYear % 400 === 0);
        if (!isLeapYear) {
          result.setFullYear(targetYear, 1, 28);
          return result;
        }
      }

      result.setFullYear(targetYear, originalMonth, originalDay);
      return result;
    }

    /**
     * Format date for display
     */
    function formatDateDisplay(dateInput) {
      const date = typeof dateInput === 'string' ? new Date(dateInput) : dateInput;
      const day = date.getDate();
      const month = date.toLocaleDateString('en-GB', { month: 'short' });
      const year = date.getFullYear();
      return `${day} ${month} ${year}`;
    }

    /**
     * Format due date with optional weekday prefix for weekday-based frequencies
     */
    function formatDueDateWithWeekday(dateInput, includeWeekday) {
      const date = typeof dateInput === 'string' ? new Date(dateInput) : dateInput;

      if (includeWeekday) {
        // Format as "Tue, 3 Aug 2027" for weekday-based frequencies
        return date.toLocaleDateString('en-GB', {
          weekday: 'short',
          day: 'numeric',
          month: 'short',
          year: 'numeric'
        }).replace(/^(\w+)\s/, '$1, ');
      }

      return formatDateDisplay(date);
    }

    /**
     * SINGLE SOURCE OF TRUTH: Generate complete repayment schedule
     * This function is reusable across wizard, manage, and review pages
     *
     * @param {Object} config - Configuration object
     * @returns {Object} - Complete schedule data with rows, totals, and labels
     */
    function generateRepaymentSchedule({
      loanAmount,
      annualInterestRate,
      repaymentType,
      numberOfInstallments,
      paymentFrequency,
      firstPaymentDays,
      firstPaymentMonths = 1,
      firstPaymentYears = 0,
      firstPaymentIsMonthBased = false,
      firstPaymentIsYearBased = false,
      firstPaymentExactDate = null,
      loanStartMode,
      contextMode,
      explicitLoanStartDate
    }) {
      const debugMessages = [];

      // STEP 1: Determine effective mode
      // Rule: If loan start has a real date (not upon_acceptance), ALWAYS use actual mode
      let effectiveMode = contextMode;
      if (loanStartMode !== 'upon_acceptance') {
        effectiveMode = 'actual';
        debugMessages.push('Loan start has real date, forcing actual mode');
      }

      // STEP 2: Determine loan start date
      let loanStartDate = explicitLoanStartDate;
      if (!loanStartDate && loanStartMode === 'upon_acceptance' && effectiveMode === 'actual') {
        // Upon acceptance + actual mode: use today
        loanStartDate = new Date();
        loanStartDate.setHours(0, 0, 0, 0);
      }

      // STEP 3: Determine loan start label
      let loanStartLabel;
      if (loanStartDate) {
        loanStartLabel = `Loan start: ${formatDateDisplay(loanStartDate)}`;
      } else {
        // Preview mode with unknown date
        loanStartLabel = 'Loan start: When agreement is accepted';
      }

      // STEP 4: Setup interest calculation
      const annualRate = annualInterestRate / 100;
      const dailyRate = annualRate / 365;

      // Determine period configuration
      let periodDays;
      let periodType; // 'days', 'months', 'weeks', or 'years'
      let periodMultiplier; // for "every 2 months", "every 3 months", etc.
      let periodLabel;

      switch (paymentFrequency) {
        // Day-based frequencies
        case 'every-7-days':
          periodDays = 7;
          periodType = 'days';
          periodMultiplier = 1;
          periodLabel = 'Every 7 days (weekly)';
          break;
        case 'every-14-days':
          periodDays = 14;
          periodType = 'days';
          periodMultiplier = 1;
          periodLabel = 'Every 14 days';
          break;
        case 'every-30-days':
          periodDays = 30;
          periodType = 'days';
          periodMultiplier = 1;
          periodLabel = 'Every 30 days';
          break;
        // Month-based frequencies
        case 'every-month':
          periodDays = 30; // approximate for interest
          periodType = 'months';
          periodMultiplier = 1;
          periodLabel = 'Every month';
          break;
        case 'every-3-months':
          periodDays = 91;
          periodType = 'months';
          periodMultiplier = 3;
          periodLabel = 'Every 3 months';
          break;
        case 'every-6-months':
          periodDays = 182;
          periodType = 'months';
          periodMultiplier = 6;
          periodLabel = 'Every 6 months';
          break;

        // Weekday-based frequencies
        case 'every-week':
          periodDays = 7;
          periodType = 'weeks';
          periodMultiplier = 1;
          periodLabel = 'Every week (same weekday)';
          break;
        case 'every-2-weeks':
          periodDays = 14;
          periodType = 'weeks';
          periodMultiplier = 2;
          periodLabel = 'Every 2 weeks';
          break;
        case 'every-4-weeks':
          periodDays = 28;
          periodType = 'weeks';
          periodMultiplier = 4;
          periodLabel = 'Every 4 weeks';
          break;

        // Year-based frequencies
        case 'every-year':
          periodDays = 365; // approximate for interest
          periodType = 'years';
          periodMultiplier = 1;
          periodLabel = 'Every year';
          break;
        case 'every-2-years':
          periodDays = 730; // approximate for interest (2 years)
          periodType = 'years';
          periodMultiplier = 2;
          periodLabel = 'Every 2 years';
          break;
        case 'every-3-years':
          periodDays = 1095; // approximate for interest (3 years)
          periodType = 'years';
          periodMultiplier = 3;
          periodLabel = 'Every 3 years';
          break;

        default:
          periodDays = 30;
          periodType = 'months';
          periodMultiplier = 1;
          periodLabel = 'Every month';
      }

      debugMessages.push(`Annual interest rate: ${annualInterestRate}%`);
      debugMessages.push(`Repayment type: ${repaymentType === 'one_time' ? 'One-time payment' : 'Installments'}`);
      debugMessages.push(`Number of installments: ${numberOfInstallments}`);
      debugMessages.push(`Payment frequency: ${periodLabel}`);
      debugMessages.push(`First payment timing: ${firstPaymentDays} days after loan start`);
      debugMessages.push(`Loan start mode: ${loanStartMode === 'fixed_date' ? 'Fixed date' : 'Upon agreement acceptance'}`);
      debugMessages.push(`Effective mode: ${effectiveMode === 'actual' ? 'Actual (real dates)' : 'Preview (relative labels)'}`);

      // STEP 5: Generate schedule rows
      const rows = [];
      const principalPerPayment = loanAmount / numberOfInstallments;
      let remainingBalance = loanAmount;
      let totalInterest = 0;

      for (let i = 0; i < numberOfInstallments; i++) {
        const paymentIndex = i + 1;

        // Calculate interest for this period
        let daysForThisPeriod;
        if (i === 0) {
          // First payment: use firstPaymentDays
          daysForThisPeriod = firstPaymentDays;
        } else {
          // Subsequent payments: use period length
          daysForThisPeriod = periodDays;
        }

        const interestForPeriod = remainingBalance * dailyRate * daysForThisPeriod;
        const principalPayment = principalPerPayment;
        const totalPayment = principalPayment + interestForPeriod;

        totalInterest += interestForPeriod;
        remainingBalance -= principalPayment;
        if (remainingBalance < 0.01) remainingBalance = 0;

        // Generate due date label
        let dueDateLabel;
        let dueDate = null;

        if (effectiveMode === 'preview') {
          // PREVIEW MODE: Use relative labels, no real dates

          // EXCEPTION: If user explicitly picked a first payment date, we know the real calendar dates
          // Show them even in preview mode
          if (firstPaymentExactDate) {
            if (i === 0) {
              // First payment: use the exact picked date
              dueDate = new Date(firstPaymentExactDate);
              dueDate.setHours(0, 0, 0, 0);
            } else {
              // Subsequent payments: calculate from first payment date
              const baseDate = new Date(firstPaymentExactDate);
              baseDate.setHours(0, 0, 0, 0);

              if (periodType === 'years') {
                dueDate = addYears(baseDate, i * periodMultiplier);
              } else if (periodType === 'months') {
                dueDate = addMonths(baseDate, i * periodMultiplier);
              } else if (periodType === 'weeks') {
                dueDate = addDays(baseDate, i * periodDays);
              } else {
                // Day-based
                dueDate = addDays(baseDate, i * periodDays);
              }
            }
            dueDateLabel = formatDueDateWithWeekday(dueDate, periodType === 'weeks');
          } else if (i === 0) {
            // FIRST PAYMENT in preview mode: use first payment timing properties
            if (firstPaymentIsYearBased) {
              // Year-based (e.g., "In 1 year", "In 2 years")
              if (firstPaymentYears === 1) {
                dueDateLabel = '1 year after loan start';
              } else {
                dueDateLabel = `${firstPaymentYears} years after loan start`;
              }
            } else if (firstPaymentIsMonthBased) {
              // Month-based (e.g., "In 1 month", "In 6 months")
              if (firstPaymentMonths === 0) {
                dueDateLabel = 'On loan start';
              } else if (firstPaymentMonths === 1) {
                dueDateLabel = '1 month after loan start';
              } else {
                dueDateLabel = `${firstPaymentMonths} months after loan start`;
              }
            } else {
              // Day-based (e.g., "In 1 week" = 7 days)
              if (firstPaymentDays === 0) {
                dueDateLabel = 'On loan start';
              } else if (firstPaymentDays === 7) {
                dueDateLabel = '1 week after loan start';
              } else {
                dueDateLabel = `${firstPaymentDays} days after loan start`;
              }
            }
          } else if (periodType === 'years') {
            // SUBSEQUENT PAYMENTS with yearly frequency
            // Calculate offset from first payment
            const totalYears = firstPaymentYears + (i * periodMultiplier);
            if (totalYears === 1) {
              dueDateLabel = '1 year after loan start';
            } else {
              dueDateLabel = `${totalYears} years after loan start`;
            }
          } else if (periodType === 'months') {
            // SUBSEQUENT PAYMENTS with monthly frequency
            // Calculate offset from first payment
            const totalMonths = firstPaymentMonths + (i * periodMultiplier);
            if (totalMonths === 0) {
              dueDateLabel = 'On loan start';
            } else if (totalMonths === 1) {
              dueDateLabel = '1 month after loan start';
            } else {
              dueDateLabel = `${totalMonths} months after loan start`;
            }
          } else if (periodType === 'weeks') {
            // SUBSEQUENT PAYMENTS with week-based frequency
            // Calculate offset from first payment in days
            const totalDays = firstPaymentDays + (i * periodDays);
            if (totalDays === 0) {
              dueDateLabel = 'On loan start';
            } else if (totalDays === 7) {
              dueDateLabel = '1 week after loan start';
            } else {
              dueDateLabel = `${totalDays} days after loan start`;
            }
          } else {
            // SUBSEQUENT PAYMENTS with day-based frequency
            // Calculate offset from first payment in days
            const totalDays = firstPaymentDays + (i * periodDays);
            if (totalDays === 0) {
              dueDateLabel = 'On loan start';
            } else if (totalDays === 7) {
              dueDateLabel = '1 week after loan start';
            } else {
              dueDateLabel = `${totalDays} days after loan start`;
            }
          }
        } else {
          // ACTUAL MODE: Calculate real calendar dates
          if (loanStartDate) {
            // Calculate first payment date (will be used as base for all subsequent payments)
            let firstDueDate;
            if (firstPaymentExactDate) {
              // User explicitly picked a date - use it directly
              firstDueDate = new Date(firstPaymentExactDate);
              firstDueDate.setHours(0, 0, 0, 0);
            } else if (firstPaymentIsYearBased) {
              // First payment is year-based (e.g., "In 1 year", "In 2 years")
              firstDueDate = addYears(loanStartDate, firstPaymentYears);
            } else if (firstPaymentIsMonthBased) {
              // First payment is month-based (e.g., "In 1 month", "In 6 months")
              firstDueDate = addMonths(loanStartDate, firstPaymentMonths);
            } else {
              // First payment is day-based (e.g., "In 1 week" = 7 days)
              firstDueDate = addDays(loanStartDate, firstPaymentDays);
            }

            // Now calculate the due date for this payment
            if (i === 0) {
              // First payment: use the calculated first due date
              dueDate = firstDueDate;
            } else if (periodType === 'years') {
              // Yearly: calculate from first payment date
              dueDate = addYears(firstDueDate, i * periodMultiplier);
            } else if (periodType === 'months') {
              // Monthly: calculate from first payment date
              dueDate = addMonths(firstDueDate, i * periodMultiplier);
            } else if (periodType === 'weeks') {
              // Week-based: calculate from first payment date (preserves weekday)
              dueDate = addDays(firstDueDate, i * periodDays);
            } else {
              // Day-based: calculate from first payment date
              dueDate = addDays(firstDueDate, i * periodDays);
            }
            dueDateLabel = formatDueDateWithWeekday(dueDate, periodType === 'weeks');
          } else {
            dueDateLabel = 'Date not available';
          }
        }

        rows.push({
          index: paymentIndex,
          label: dueDateLabel,
          dueDate: dueDate,
          principal: Math.round(principalPayment * 100), // cents
          interest: Math.round(interestForPeriod * 100), // cents
          totalPayment: Math.round(totalPayment * 100), // cents
          balance: Math.round(remainingBalance * 100) // cents
        });
      }

      // STEP 6: Calculate totals
      const totals = {
        principal: Math.round(loanAmount * 100), // should equal sum of all principal
        interest: Math.round(totalInterest * 100),
        totalRepayment: Math.round((loanAmount + totalInterest) * 100)
      };

      debugMessages.push(`Generated ${rows.length} payment(s)`);

      return {
        rows,
        totals,
        loanStartLabel,
        effectiveMode,
        debugMessages
      };
    }

    // Export for potential reuse in other pages
    window.PayFriendsRepayment = {
      generateRepaymentSchedule
    };

    /**
     * Calculate loan duration from schedule (loan start to last payment)
     */
    /**
     * Format duration in months to "X years Y months" format
     */
    function formatDurationMonths(totalMonths) {
      const years = Math.floor(totalMonths / 12);
      const months = totalMonths % 12;
      const parts = [];
      if (years > 0) parts.push(`${years} year${years === 1 ? "" : "s"}`);
      if (months > 0) parts.push(`${months} month${months === 1 ? "" : "s"}`);
      return parts.join(" ");
    }

    function calculateLoanDuration(rows, loanStartDate, effectiveMode) {
      if (!rows || rows.length === 0) {
        return null;
      }

      const lastPayment = rows[rows.length - 1];

      if (effectiveMode === 'actual' && loanStartDate && lastPayment.dueDate) {
        // Actual mode: calculate from loan start to last payment date
        const startDate = new Date(loanStartDate);
        const endDate = new Date(lastPayment.dueDate);

        // Calculate months difference
        const yearsDiff = endDate.getFullYear() - startDate.getFullYear();
        const monthsDiff = endDate.getMonth() - startDate.getMonth();
        const totalMonths = Math.max(0, yearsDiff * 12 + monthsDiff);

        const startStr = formatDateDisplay(startDate);
        const endStr = formatDateDisplay(endDate);

        if (totalMonths === 0) {
          // Less than a month, show days
          const daysDiff = Math.max(0, Math.round((endDate - startDate) / (1000 * 60 * 60 * 24)));
          if (daysDiff === 0) {
            return `0 days (${startStr} to ${endStr})`;
          } else if (daysDiff === 1) {
            return `1 day (${startStr} to ${endStr})`;
          } else {
            return `${daysDiff} days (${startStr} to ${endStr})`;
          }
        } else {
          return `${formatDurationMonths(totalMonths)} (${startStr} to ${endStr})`;
        }
      } else {
        // Preview mode: describe duration relative to agreement acceptance
        // Calculate the offset from loan start to last payment
        const lastPaymentLabel = lastPayment.label;

        // Extract months/days from the label (e.g., "12 months after loan start")
        const monthsMatch = lastPaymentLabel.match(/(\d+)\s+months?\s+after/);
        const daysMatch = lastPaymentLabel.match(/(\d+)\s+days?\s+after/);
        const yearsMatch = lastPaymentLabel.match(/(\d+)\s+years?\s+after/);

        if (yearsMatch) {
          const years = parseInt(yearsMatch[1]);
          const totalMonths = years * 12;
          return `${formatDurationMonths(totalMonths)} after agreement is accepted`;
        } else if (monthsMatch) {
          const months = parseInt(monthsMatch[1]);
          return `${formatDurationMonths(months)} after agreement is accepted`;
        } else if (daysMatch) {
          const days = parseInt(daysMatch[1]);
          return days === 1
            ? `1 day after agreement is accepted`
            : `${days} days after agreement is accepted`;
        }

        // Fallback
        return `${rows.length} payments after agreement is accepted`;
      }
    }

    /**
     * Get loan start label with context
     */
    function getLoanStartLabelWithContext(loanStartDate, effectiveMode, loanStartMode) {
      if (!loanStartDate && loanStartMode === 'upon_acceptance') {
        return 'When agreement is accepted';
      }

      if (loanStartDate) {
        const dateStr = formatDateDisplay(loanStartDate);
        return dateStr;
      }

      return 'Unknown';
    }

    /**
     * Update UI based on repayment type
     */
    function updateRepaymentTypeUI() {
      const repaymentType = document.getElementById('repaymentType').value;
      const isOneTime = repaymentType === 'one_time';

      const numInstallmentsGroup = document.getElementById('numInstallments').closest('.form-group');
      const frequencyGroup = document.getElementById('frequencyGroup');
      const installmentsHint = document.getElementById('installmentsHint');
      const paymentTimingLabel = document.getElementById('paymentTimingLabel');
      const paymentTimingHint = document.getElementById('paymentTimingHint');
      const firstPaymentDue = document.getElementById('firstPaymentDue');
      const numInstallments = document.getElementById('numInstallments');

      if (isOneTime) {
        // 1-time payment mode

        // 1) Change label to "Full repayment due (after loan start)"
        paymentTimingLabel.textContent = 'Full repayment due (after loan start)';
        paymentTimingHint.textContent = 'When full repayment is due.';

        // 2) Lock installments to 1 and hide
        numInstallments.value = 1;
        numInstallmentsGroup.style.display = 'none';

        // 3) Hide frequency (not applicable for 1-time)
        frequencyGroup.style.display = 'none';

        // 4) Show hint about 1-time payment
        installmentsHint.style.display = 'block';

        // 5) If no value or transitioning back, default to "In 1 year"
        if (!firstPaymentDue.value || firstPaymentDue.value === '') {
          firstPaymentDue.value = '1-year';
        }
      } else {
        // Installments mode

        // 1) Change label to "First payment due (after loan start)"
        paymentTimingLabel.textContent = 'First payment due (after loan start)';
        paymentTimingHint.textContent = 'When the first repayment is due.';

        // 2) Show and enable installments, auto-set to 12 when switching
        numInstallmentsGroup.style.display = 'block';
        numInstallments.value = 12;

        // 3) Show frequency
        frequencyGroup.style.display = 'block';

        // 4) Hide hint
        installmentsHint.style.display = 'none';

        // 5) Auto-set to "In 1 year" when switching to installments
        firstPaymentDue.value = '1-year';
      }

      // Trigger recalculation after UI update to ensure schedule matches new mode
      runRepaymentCalculation();

      // Update fair range pill since repayment type affects the calculation
      updateFairRangePill();
    }

    // ============================================================================
    // INTEREST MODE TOGGLE
    // ============================================================================

    let interestMode = 'interest'; // 'interest' or 'no-interest'

    /**
     * Set interest mode (Interest or No interest)
     */
    function setInterestMode(mode) {
      interestMode = mode;
      const modeInterestBtn = document.getElementById('mode-interest');
      const modeNoInterestBtn = document.getElementById('mode-no-interest');
      const interestInputRow = document.getElementById('interest-input-row');
      const fairRangeExplanation = document.getElementById('fair-range-explanation');

      if (mode === 'interest') {
        // Interest mode: show input and fair range
        modeInterestBtn.style.background = '#6ee7b7';
        modeInterestBtn.style.color = '#000';
        modeNoInterestBtn.style.background = 'transparent';
        modeNoInterestBtn.style.color = '#e5e7eb';
        interestInputRow.style.display = 'flex';
      } else {
        // No interest mode: hide input and fair range
        modeInterestBtn.style.background = 'transparent';
        modeInterestBtn.style.color = '#e5e7eb';
        modeNoInterestBtn.style.background = '#6ee7b7';
        modeNoInterestBtn.style.color = '#000';
        interestInputRow.style.display = 'none';
        // Also hide explanation if it was open
        fairRangeExplanation.classList.add('hidden');
        document.getElementById('fair-range-pill').setAttribute('aria-expanded', 'false');
      }

      // Trigger recalculation
      runRepaymentCalculation();
    }

    /**
     * Toggle fair range explanation visibility
     */
    function toggleFairRangeExplanation() {
      const explanation = document.getElementById('fair-range-explanation');
      const pill = document.getElementById('fair-range-pill');
      const isExpanded = pill.getAttribute('aria-expanded') === 'true';

      if (isExpanded) {
        explanation.classList.add('hidden');
        pill.setAttribute('aria-expanded', 'false');
      } else {
        explanation.classList.remove('hidden');
        pill.setAttribute('aria-expanded', 'true');
      }
    }

    /**
     * Calculate fair interest range based on loan parameters
     * Returns {min, max} percentage values
     */
    function calculateFairRange() {
      // Get loan parameters
      const principalValue = document.getElementById('principal').value.trim();
      const loanAmount = parseMoney(principalValue);
      const repaymentType = document.getElementById('repaymentType').value;
      const numberOfInstallments = parseInt(document.getElementById('numInstallments').value);
      const firstPaymentDueOption = document.getElementById('firstPaymentDue').value;

      // Base range
      let minRate = 4;
      let maxRate = 7;

      // Adjust based on loan amount (higher amounts = higher risk)
      if (loanAmount > 0) {
        if (loanAmount > 10000 * 100) { // > €10,000
          minRate += 1;
          maxRate += 1;
        } else if (loanAmount < 2000 * 100) { // < €2,000
          minRate = Math.max(3, minRate - 1);
          maxRate = Math.max(5, maxRate - 1);
        }
      }

      // Adjust based on duration (longer = more uncertainty)
      const durationMonths = estimateLoanDurationMonths(firstPaymentDueOption, numberOfInstallments);
      if (durationMonths > 24) { // > 2 years
        minRate += 1;
        maxRate += 1;
      } else if (durationMonths < 6) { // < 6 months
        minRate = Math.max(3, minRate - 1);
        maxRate = Math.max(5, maxRate - 1);
      }

      // Adjust based on installments (more installments = lower risk)
      if (repaymentType === 'installments' && numberOfInstallments >= 12) {
        maxRate = Math.max(5, maxRate - 1);
      }

      return { min: minRate, max: maxRate };
    }

    /**
     * Estimate loan duration in months for fair range calculation
     */
    function estimateLoanDurationMonths(firstPaymentOption, installments) {
      let months = 12; // default 1 year

      // Estimate from first payment option
      if (firstPaymentOption === '1-week') months = 0.25;
      else if (firstPaymentOption === '1-month') months = 1;
      else if (firstPaymentOption === '6-months') months = 6;
      else if (firstPaymentOption === '1-year') months = 12;
      else if (firstPaymentOption === '2-years') months = 24;
      else if (firstPaymentOption === '3-years') months = 36;

      // For installments, approximate total duration
      if (installments > 1) {
        months = months * installments;
      }

      return months;
    }

    /**
     * Update fair range pill text
     */
    function updateFairRangePill() {
      const range = calculateFairRange();
      document.getElementById('fair-range-text').textContent = `Fair range (${range.min}–${range.max}%)`;
    }

    /**
     * Reset calculator to defaults
     */
    function resetCalculator() {
      // Reset form fields to defaults
      document.getElementById('principal').value = '';
      document.getElementById('interest').value = 5;
      document.getElementById('repaymentType').value = 'one_time';
      document.getElementById('numInstallments').value = 1;
      document.getElementById('frequency').value = 'every-month';
      document.getElementById('firstPaymentDue').value = '1-year';
      document.getElementById('loanStartMode').value = 'upon_acceptance';

      // Reset interest mode to "Interest" with 5%
      setInterestMode('interest');

      // Clear loan amount error and update highlight
      clearPrincipalError();
      updateLoanAmountHighlight();

      // Context mode dropdown was removed on calculator.html, but keep this safe
      const contextModeSelect = document.getElementById('contextMode');
      if (contextModeSelect) {
        contextModeSelect.value = 'preview';
      }

      // Hide and clear date pickers
      document.getElementById('loanStartDateGroup').classList.add('hidden');
      document.getElementById('firstPaymentDateGroup').classList.add('hidden');
      document.getElementById('loanStartDate').value = '';
      document.getElementById('firstPaymentDate').value = '';

      // Update UI based on repayment type
      updateRepaymentTypeUI();

      // Show waiting message instead of auto-calculating
      document.getElementById('scheduleBody').innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">Waiting for calculation...</td></tr>';
      document.getElementById('scheduleTotals').style.display = 'none';
      document.getElementById('loanSummaryContent').innerHTML = 'Configure parameters to see loan summary...';
      document.getElementById('loanStartLabel').innerHTML = 'Configure parameters to see loan details...';
      document.getElementById('loanDurationLabel').style.display = 'none';
    }

    /**
     * Debounce utility for input events
     * Delays execution until user stops typing for specified milliseconds
     */
    function debounce(func, delay) {
      let timeoutId;
      return function(...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(this, args), delay);
      };
    }

    /**
     * Main calculation function wrapper for auto-updates
     * This is the single entry point for all recalculations
     */
    function runRepaymentCalculation() {
      calculateSchedule();
    }

    // Create debounced version for input events (text/number fields)
    const debouncedCalculation = debounce(runRepaymentCalculation, 300);

    // ============================================================================
    // AUTO-UPDATE: Event listeners for all configuration inputs
    // ============================================================================

    // Loan amount - use debounced for smooth typing and update fair range
    document.getElementById('principal').addEventListener('input', () => {
      updateLoanAmountHighlight();
      debouncedCalculation();
      updateFairRangePill();
    });

    // Annual interest rate - use debounced for smooth typing and update fair range
    document.getElementById('interest').addEventListener('input', () => {
      debouncedCalculation();
      updateFairRangePill();
    });

    // Interest mode toggle buttons
    document.getElementById('mode-interest').addEventListener('click', () => setInterestMode('interest'));
    document.getElementById('mode-no-interest').addEventListener('click', () => setInterestMode('no-interest'));

    // Fair range pill toggle
    document.getElementById('fair-range-pill').addEventListener('click', toggleFairRangeExplanation);

    // Loan start date mode - immediate update
    document.getElementById('loanStartMode').addEventListener('change', runRepaymentCalculation);

    // Loan start date picker - handled by native date input change event (see below)

    // Repayment type - handled by updateRepaymentTypeUI which calls runRepaymentCalculation
    // (see event listener below in UI-only section)

    // First payment due - immediate update and update fair range
    document.getElementById('firstPaymentDue').addEventListener('change', () => {
      runRepaymentCalculation();
      updateFairRangePill();
    });

    // First payment date picker - handled by native date input change event (see below)

    // Payment frequency - immediate update
    document.getElementById('frequency').addEventListener('change', runRepaymentCalculation);

    // Number of installments - use debounced for smooth typing and update fair range
    document.getElementById('numInstallments').addEventListener('input', () => {
      debouncedCalculation();
      updateFairRangePill();
    });

    // Context mode - immediate update (only exists on calculate.html)
    const contextModeSelect = document.getElementById('contextMode');
    if (contextModeSelect) {
      contextModeSelect.addEventListener('change', runRepaymentCalculation);
    }

    // Calculator reset link - only exists on calculator.html
    const calculatorResetLink = document.getElementById('calculator-reset-link');
    if (calculatorResetLink) {
      calculatorResetLink.addEventListener('click', function(event) {
        event.preventDefault();
        resetCalculator();
      });
    }

    // ============================================================================
    // UI-only event listeners (these also trigger recalculation via events above)
    // ============================================================================

    // Show/hide conditional fields based on repayment type
    document.getElementById('repaymentType').addEventListener('change', updateRepaymentTypeUI);

    // Show/hide loan start date picker
    document.getElementById('loanStartMode').addEventListener('change', function() {
      const loanStartDateGroup = document.getElementById('loanStartDateGroup');
      const loanStartDateInput = document.getElementById('loanStartDate');
      if (this.value === 'pick-date') {
        loanStartDateGroup.classList.remove('hidden');
      } else {
        loanStartDateGroup.classList.add('hidden');
        loanStartDateInput.value = ''; // Clear when hiding
      }
    });

    // Show/hide first payment date picker
    document.getElementById('firstPaymentDue').addEventListener('change', function() {
      const firstPaymentDateGroup = document.getElementById('firstPaymentDateGroup');
      const firstPaymentDateInput = document.getElementById('firstPaymentDate');
      if (this.value === 'pick-date') {
        firstPaymentDateGroup.classList.remove('hidden');
      } else {
        firstPaymentDateGroup.classList.add('hidden');
        firstPaymentDateInput.value = ''; // Clear when hiding
      }
    });

    /**
     * Helper function to calculate loan start date from dropdown
     * Uses parseIsoDate to safely parse dates from native date input (YYYY-MM-DD)
     */
    function calculateLoanStartDate(loanStartMode, explicitLoanStartDate) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      switch (loanStartMode) {
        case 'upon_acceptance':
          return null; // Unknown date (will be determined by context mode)
        case 'today':
          return today;
        case 'tomorrow':
          return addDays(today, 1);
        case 'in-1-week':
          return addDays(today, 7);
        case 'in-1-month':
          return addMonths(today, 1);
        case 'pick-date':
          // Parse the date from YYYY-MM-DD format (native date input)
          return explicitLoanStartDate ? parseIsoDate(explicitLoanStartDate) : null;
        default:
          return null;
      }
    }

    /**
     * Parse money string to number
     * Accepts both comma and dot as thousand separators
     * Returns parsed number or 0 if invalid
     */
    function parseMoney(value) {
      if (typeof value !== 'string') {
        value = String(value);
      }
      // Remove all dots and commas (thousand separators)
      const cleaned = value.replace(/[.,\s]/g, '');
      const num = parseFloat(cleaned);
      return isNaN(num) ? 0 : num;
    }

    /**
     * Format number as money with thousand separator
     * Uses comma as default separator
     */
    function formatMoneyInput(value) {
      const num = parseFloat(value);
      if (isNaN(num)) return '';
      // Use comma for thousand separator (e.g., 6,000)
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    /**
     * Legacy alias for backward compatibility
     */
    function parseLoanAmount(value) {
      return parseMoney(value);
    }

    /**
     * Legacy alias for backward compatibility
     */
    function formatLoanAmount(value) {
      return formatMoneyInput(value);
    }

    /**
     * Helper function to calculate first payment timing
     * Returns {days, months, years, isMonthBased, isYearBased, exactDate}
     * Uses parseIsoDate to safely parse dates from native date input (YYYY-MM-DD)
     */
    function calculateFirstPaymentTiming(firstPaymentDue, firstPaymentDate, loanStartDate) {
      switch (firstPaymentDue) {
        case '1-week':
          return { days: 7, months: 0, years: 0, isMonthBased: false, isYearBased: false, exactDate: null };
        case '1-month':
          return { days: 30, months: 1, years: 0, isMonthBased: true, isYearBased: false, exactDate: null };
        case '6-months':
          return { days: 182, months: 6, years: 0, isMonthBased: true, isYearBased: false, exactDate: null };
        case '1-year':
          return { days: 365, months: 12, years: 1, isMonthBased: false, isYearBased: true, exactDate: null };
        case '2-years':
          return { days: 730, months: 24, years: 2, isMonthBased: false, isYearBased: true, exactDate: null };
        case '3-years':
          return { days: 1095, months: 36, years: 3, isMonthBased: false, isYearBased: true, exactDate: null };
        case 'pick-date':
          if (firstPaymentDate) {
            // Parse the date string from YYYY-MM-DD format (native date input)
            const pickedDate = parseIsoDate(firstPaymentDate);

            if (!pickedDate) {
              // Invalid date - return default
              return { days: 30, months: 1, years: 0, isMonthBased: true, isYearBased: false, exactDate: null };
            }

            // Calculate days for interest calculation (if loan start is known)
            let daysDiff = 30; // default
            if (loanStartDate instanceof Date) {
              const start = new Date(loanStartDate);
              start.setHours(0, 0, 0, 0);
              const diffMs = pickedDate - start;
              daysDiff = Math.round(diffMs / (1000 * 60 * 60 * 24));
            }

            // Return with exact date - this will be used directly in schedule
            return {
              days: daysDiff,
              months: 0,
              years: 0,
              isMonthBased: false,
              isYearBased: false,
              exactDate: pickedDate
            };
          }
          // If no date picked, use default
          return { days: 30, months: 1, years: 0, isMonthBased: true, isYearBased: false, exactDate: null };
        default:
          return { days: 30, months: 1, years: 0, isMonthBased: true, isYearBased: false, exactDate: null };
      }
    }

    /**
     * Render loan summary for calculator.html
     */
    function renderLoanSummary(summary) {
      const container = document.getElementById('loanSummaryContent');
      if (!container) return;

      const lines = [];

      // Loan amount
      lines.push(`<p><strong>Loan amount:</strong> ${formatMoney(summary.loanAmount)}</p>`);

      // Repayment type
      const repaymentTypeLabel = summary.repaymentType === 'one_time' ? 'One-time payment' : 'Installments';
      lines.push(`<p><strong>Repayment type:</strong> ${repaymentTypeLabel}</p>`);

      // Loan duration
      if (summary.loanDuration) {
        lines.push(`<p><strong>Loan duration:</strong> ${summary.loanDuration}</p>`);
      }

      // Interest rate
      if (summary.annualInterestRate === 0) {
        lines.push(`<p><strong>Annual interest rate:</strong> No interest (0%)</p>`);
      } else {
        lines.push(`<p><strong>Annual interest rate:</strong> ${summary.annualInterestRate.toFixed(2)}% per year</p>`);
      }

      // Total interest (with Fairness icon)
      const fairnessIcon = fairnessIconSVG('', {width: '16px', height: '16px', display: 'inline-block', verticalAlign: 'middle', marginLeft: '4px'});
      lines.push(`<p><strong>Total interest:</strong> ${formatMoney(summary.totalInterest)} <span class="pf-fairness-icon" title="Fairness Between Friends" style="display: inline-flex; align-items: center; vertical-align: middle;">${fairnessIcon}</span></p>`);

      // Total to repay (with Fairness icon)
      lines.push(`<p><strong>Total to repay:</strong> ${formatMoney(summary.totalRepayment)} <span class="pf-fairness-icon" title="Fairness Between Friends" style="display: inline-flex; align-items: center; vertical-align: middle;">${fairnessIcon}</span></p>`);

      // Additional details based on repayment type
      if (summary.repaymentType === 'installments' && summary.numberOfInstallments > 1) {
        const principalPerInstallment = Math.round(summary.loanAmount / summary.numberOfInstallments);
        lines.push(`<p><strong>Principal per installment:</strong> ~${formatMoney(principalPerInstallment)} (excluding interest)</p>`);
      }

      // First payment due
      if (summary.firstDueDate) {
        const label = summary.repaymentType === 'one_time' ? 'Full repayment due' : 'First payment due';
        lines.push(`<p><strong>${label}:</strong> ${summary.firstDueDate}</p>`);
      }

      // Fairness Between Friends summary note
      lines.push(`
        <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.08); font-size: 13px; color: #9ca3af;">
          <p style="margin-bottom: 8px;">
            Amounts marked with <span class="pf-fairness-icon-inline" title="Fairness Between Friends" style="display: inline-flex; align-items: center; vertical-align: middle; margin: 0 2px;">${fairnessIcon}</span> are calculated using the Fairness Between Friends rules.
            <a href="#" id="fairnessToggle" style="color: #34d399; text-decoration: none; border-bottom: 1px solid transparent; transition: border-color 0.2s;" onmouseover="this.style.borderBottomColor='#34d399'" onmouseout="this.style.borderBottomColor='transparent'">How it works</a>
          </p>
          <div id="fairnessExplanation" style="display: none; margin-top: 12px; padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 6px; font-size: 12px; line-height: 1.6; color: #d1d5db;">
            Fairness Between Friends adjusts interest dynamically based on the outstanding balance and the time that has passed. This means paying earlier or more reduces total interest, while paying later or less increases it. Both sides always see the current, fair value of the loan in real time.
          </div>
        </div>
      `);

      container.innerHTML = lines.join('');

      // Toggle Fairness "How it works" explanation
      const fairnessToggle = document.getElementById('fairnessToggle');
      const fairnessExplanation = document.getElementById('fairnessExplanation');

      if (fairnessToggle && fairnessExplanation) {
        fairnessToggle.addEventListener('click', function(e) {
          e.preventDefault();
          if (fairnessExplanation.style.display === 'none') {
            fairnessExplanation.style.display = 'block';
          } else {
            fairnessExplanation.style.display = 'none';
          }
        });
      }
    }

    /**
     * Main calculation function triggered by button click
     */
    function calculateSchedule() {
      try {
        // Gather form data
        const principalValue = document.getElementById('principal').value.trim();
        const loanAmount = parseMoney(principalValue);
        // Use 0% interest if "No interest" mode is active, otherwise use input value
        const annualInterestRate = interestMode === 'no-interest' ? 0 : parseFloat(document.getElementById('interest').value);
        const repaymentType = document.getElementById('repaymentType').value;

        // Force installments to 1 for one-time payment, regardless of field value
        let numberOfInstallments;
        if (repaymentType === 'one_time') {
          numberOfInstallments = 1;
        } else {
          numberOfInstallments = parseInt(document.getElementById('numInstallments').value);
        }

        const paymentFrequency = document.getElementById('frequency').value;
        const firstPaymentDueOption = document.getElementById('firstPaymentDue').value;
        const firstPaymentDate = document.getElementById('firstPaymentDate').value;
        const loanStartMode = document.getElementById('loanStartMode').value;
        const contextModeElement = document.getElementById('contextMode');
        const contextMode = contextModeElement ? contextModeElement.value : 'preview';
        const explicitLoanStartDate = document.getElementById('loanStartDate').value;

        // Validation - graceful handling for auto-updates
        // Check loan amount first - show error and focus if invalid
        if (principalValue === '') {
          showPrincipalError('Please enter a loan amount.');
          const input = getPrincipalInputElement();
          if (input) input.focus();
          return;
        }
        if (!loanAmount || loanAmount <= 0 || isNaN(loanAmount)) {
          showPrincipalError('Loan amount must be more than €0.');
          const input = getPrincipalInputElement();
          if (input) input.focus();
          return;
        }
        // Loan amount is valid - clear any errors
        clearPrincipalError();

        // Skip calculation silently if other inputs are empty (user might be typing)
        if (isNaN(annualInterestRate)) {
          // Silently skip - user might be clearing the field
          return;
        }
        if (repaymentType === 'installments' && (!numberOfInstallments || numberOfInstallments < 1 || isNaN(numberOfInstallments))) {
          // Silently skip - user might be typing
          return;
        }

        // Show errors only for invalid values (not empty)
        const errors = [];
        if (annualInterestRate < 0) {
          errors.push('Interest rate cannot be negative.');
        }

        // Validate loan start date if pick-date is selected
        if (loanStartMode === 'pick-date') {
          if (!explicitLoanStartDate) {
            errors.push('Loan start date is required when "Pick a date…" is selected.');
          } else {
            const parsedLoanStart = parseIsoDate(explicitLoanStartDate);
            if (!parsedLoanStart) {
              errors.push('Invalid loan start date. Please select a valid date.');
            }
          }
        }

        // Validate first payment / full repayment date if pick-date is selected
        if (firstPaymentDueOption === 'pick-date') {
          const fieldName = repaymentType === 'one_time' ? 'Full repayment date' : 'First payment date';
          if (!firstPaymentDate) {
            errors.push(`${fieldName} is required when "Pick a date…" is selected.`);
          } else {
            const parsedRepaymentDate = parseIsoDate(firstPaymentDate);
            if (!parsedRepaymentDate) {
              errors.push(`Invalid ${fieldName.toLowerCase()}. Please select a valid date.`);
            } else {
              // Check if repayment date is not in the past
              const today = getTodayMidnight();
              if (parsedRepaymentDate < today) {
                errors.push(`${fieldName} cannot be in the past. Please select today or a future date.`);
              }
            }
          }
        }

        if (errors.length > 0) {
          const debugConsole = document.getElementById('debugConsole');
          if (debugConsole) {
            debugConsole.innerHTML =
              '<span class="error-message">⚠ Validation errors:</span>\n' +
              errors.map(e => `  • ${e}`).join('\n');
          }
          // Also clear the schedule to avoid showing stale data
          document.getElementById('scheduleBody').innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #ef4444;">Please fix validation errors above</td></tr>';
          document.getElementById('scheduleTotals').style.display = 'none';
          return;
        }

        // Calculate actual loan start date (or null if unknown)
        let calculatedLoanStartDate = calculateLoanStartDate(loanStartMode, explicitLoanStartDate);

        // Calculate first payment timing
        const firstPaymentTiming = calculateFirstPaymentTiming(
          firstPaymentDueOption,
          firstPaymentDate,
          calculatedLoanStartDate
        );
        const firstPaymentDays = firstPaymentTiming.days;
        const firstPaymentMonths = firstPaymentTiming.months;
        const firstPaymentYears = firstPaymentTiming.years || 0;
        const firstPaymentIsMonthBased = firstPaymentTiming.isMonthBased || false;
        const firstPaymentIsYearBased = firstPaymentTiming.isYearBased || false;
        const firstPaymentExactDate = firstPaymentTiming.exactDate || null;

        // Determine effective mode and loan start date
        // Rule: If loan start is known (not upon_acceptance), always use actual mode
        let effectiveLoanStartMode = loanStartMode;
        let effectiveContextMode = contextMode;

        if (loanStartMode !== 'upon_acceptance') {
          // We have a real date, force actual mode
          effectiveContextMode = 'actual';
        } else if (contextMode === 'actual') {
          // upon_acceptance + actual mode = treat as today
          calculatedLoanStartDate = new Date();
          calculatedLoanStartDate.setHours(0, 0, 0, 0);
        }

        // Generate schedule using single source of truth
        const result = generateRepaymentSchedule({
          loanAmount,
          annualInterestRate,
          repaymentType,
          numberOfInstallments,
          paymentFrequency,
          firstPaymentDays,
          firstPaymentMonths,
          firstPaymentYears,
          firstPaymentIsMonthBased,
          firstPaymentIsYearBased,
          firstPaymentExactDate,
          loanStartMode: effectiveLoanStartMode,
          contextMode: effectiveContextMode,
          explicitLoanStartDate: calculatedLoanStartDate
        });

        // Update UI - Schedule header
        const badge = result.effectiveMode === 'preview'
          ? '<span class="badge badge-preview">Preview</span>'
          : '<span class="badge badge-actual">Actual</span>';
        document.getElementById('modeBadge').innerHTML = badge;

        // Build loan start label with duration
        const loanStartText = getLoanStartLabelWithContext(
          calculatedLoanStartDate,
          result.effectiveMode,
          loanStartMode
        );

        const loanDuration = calculateLoanDuration(result.rows, calculatedLoanStartDate, result.effectiveMode);

        // Update loan start label (line 1)
        document.getElementById('loanStartLabel').innerHTML = `Loan start: ${loanStartText}`;

        // Update loan duration label (line 2)
        const loanDurationLabel = document.getElementById('loanDurationLabel');
        if (loanDuration) {
          loanDurationLabel.innerHTML = `Loan duration: ${loanDuration}`;
          loanDurationLabel.style.display = 'block';
        } else {
          loanDurationLabel.style.display = 'none';
        }

        // Update UI - Schedule table body
        const tbody = document.getElementById('scheduleBody');
        tbody.innerHTML = '';

        result.rows.forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${row.index}</td>
            <td>${row.label}</td>
            <td class="align-right">${formatMoney(row.principal)}</td>
            <td class="align-right">${formatMoney(row.interest)}</td>
            <td class="align-right" style="font-weight: 600;">${formatMoney(row.totalPayment)}</td>
            <td class="align-right">${formatMoney(row.balance)}</td>
          `;
          tbody.appendChild(tr);
        });

        // Update UI - Schedule table footer (totals row)
        document.getElementById('scheduleTotals').style.display = 'table-footer-group';
        document.getElementById('footerPrincipal').textContent = formatMoney(result.totals.principal);
        document.getElementById('footerInterest').textContent = formatMoney(result.totals.interest);
        document.getElementById('footerTotal').textContent = formatMoney(result.totals.totalRepayment);

        // Update UI - Debug console
        const frequencyLabel = document.getElementById('frequency').selectedOptions[0].text;
        const loanStartModeLabel = document.getElementById('loanStartMode').selectedOptions[0].text;
        const firstPaymentDueLabel = document.getElementById('firstPaymentDue').selectedOptions[0].text;

        const debugLines = [
          '✔ Calculation completed',
          '',
          '=== PARAMETERS ===',
          `Loan amount: ${formatMoney(loanAmount * 100)}`,
          `Annual interest rate: ${annualInterestRate.toFixed(2)}%`,
          `Repayment type: ${repaymentType === 'one_time' ? 'One-time payment' : 'Installments'}`,
          `Number of installments: ${numberOfInstallments}`,
          `Payment frequency: ${frequencyLabel}`,
          `First payment due: ${firstPaymentDueLabel}`,
          `  → Days: ${firstPaymentDays}, Months: ${firstPaymentMonths}, Years: ${firstPaymentYears}`,
          `Loan start: ${loanStartModeLabel}`,
          `  → Real date: ${calculatedLoanStartDate ? formatDateDisplay(calculatedLoanStartDate) : 'Unknown (preview mode)'}`,
          `Context mode: ${contextMode === 'actual' ? 'Actual (known loan start)' : 'Preview (no real date)'}`,
          `Effective mode: ${result.effectiveMode === 'actual' ? 'Actual (real calendar dates)' : 'Preview (relative labels)'}`,
          '',
          '=== LOAN DURATION ===',
          loanDuration || 'N/A',
          '',
          '=== TOTALS ===',
          `Total principal: ${formatMoney(result.totals.principal)}`,
          `Total interest: ${formatMoney(result.totals.interest)}`,
          `Total repayment: ${formatMoney(result.totals.totalRepayment)}`,
          '',
          '=== SCHEDULE ===',
          `Generated ${result.rows.length} payment(s)`
        ];

        // Add table of payments for internal validation
        if (result.rows.length <= 12) {
          debugLines.push('');
          result.rows.forEach(row => {
            debugLines.push(
              `Payment ${row.index}: ${row.label} | ` +
              `Principal: ${formatMoney(row.principal)} | ` +
              `Interest: ${formatMoney(row.interest)} | ` +
              `Total: ${formatMoney(row.totalPayment)}`
            );
          });
        }

        // Update Debug Console (only for calculate.html)
        const debugConsole = document.getElementById('debugConsole');
        if (debugConsole) {
          debugConsole.textContent = debugLines.join('\n');
        }

        // Update Loan Summary (only for calculator.html)
        const loanSummaryContent = document.getElementById('loanSummaryContent');
        if (loanSummaryContent) {
          renderLoanSummary({
            loanAmount: loanAmount * 100,
            annualInterestRate,
            repaymentType,
            numberOfInstallments,
            firstPaymentDueLabel,
            loanDuration,
            totalInterest: result.totals.interest,
            totalRepayment: result.totals.totalRepayment,
            firstDueDate: result.rows.length > 0 ? result.rows[0].label : 'N/A',
            lastDueDate: result.rows.length > 0 ? result.rows[result.rows.length - 1].label : 'N/A'
          });
        }

      } catch (error) {
        console.error('Calculation error:', error);
        const debugConsole = document.getElementById('debugConsole');
        if (debugConsole) {
          debugConsole.innerHTML =
            '<span class="error-message">ERROR:</span>\n' +
            error.message + '\n\n' +
            (error.stack || '');
        }
        const loanSummaryContent = document.getElementById('loanSummaryContent');
        if (loanSummaryContent) {
          loanSummaryContent.innerHTML = '<p style="color: #ef4444;">Error calculating loan schedule. Please check your inputs.</p>';
        }
      }
    }

    // Initialize: set initial UI state based on repayment type and defaults
    document.getElementById('repaymentType').value = 'one_time';
    document.getElementById('firstPaymentDue').value = '1-year';
    updateRepaymentTypeUI();

    // Initialize fair range pill
    updateFairRangePill();

    // Don't trigger initial calculation - wait for user to enter loan amount
    // Show waiting message instead
    document.getElementById('scheduleBody').innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">Waiting for calculation...</td></tr>';
    document.getElementById('loanSummaryContent').innerHTML = 'Configure parameters to see loan summary...';

    // Loan amount validation and formatting

    // Clear error message helper
    function clearPrincipalError() {
      const el = getPrincipalErrorElement();
      if (!el) return;
      el.style.display = 'none';
      el.textContent = '';
    }

    // Show error message helper
    function showPrincipalError(message) {
      const el = getPrincipalErrorElement();
      if (!el) {
        // Fail-safe: do nothing if the element is missing
        return;
      }

      if (message) {
        el.textContent = message;
        el.style.display = 'block';
      } else {
        el.textContent = '';
        el.style.display = 'none';
      }
    }

    // Update loan amount highlight based on whether field is empty
    function updateLoanAmountHighlight() {
      const input = getPrincipalInputElement();
      if (!input) return;

      const value = input.value.trim();
      if (value === '') {
        input.classList.add('loan-amount-empty');
      } else {
        input.classList.remove('loan-amount-empty');
      }
    }

    // On focus: remove formatting to let user type freely, clear errors
    const principalInputEl = getPrincipalInputElement();
    if (principalInputEl) {
      principalInputEl.addEventListener('focus', function() {
        clearPrincipalError();
        const num = parseMoney(this.value);
        if (num > 0) {
          this.value = num.toString();
        }
      });

      // On blur: validate and format
      principalInputEl.addEventListener('blur', function() {
        const trimmed = this.value.trim();

        // Empty field
        if (trimmed === '') {
          showPrincipalError('Please enter a loan amount.');
          return;
        }

        // Parse the value
        const num = parseMoney(trimmed);

        // Invalid or zero/negative
        if (num <= 0) {
          showPrincipalError('Loan amount must be more than €0.');
          return;
        }

        // Valid - format and clear error
        clearPrincipalError();
        this.value = formatMoneyInput(num);
      });
    }

    // ============================================================================
    // DATE PARSING AND FORMATTING HELPERS
    // ============================================================================

    /**
     * Parse ISO date format (YYYY-MM-DD) from native date input to Date object
     * @param {string} dateStr - Date string in YYYY-MM-DD format
     * @returns {Date|null} - Date object or null if invalid
     */
    function parseIsoDate(dateStr) {
      if (!dateStr || typeof dateStr !== 'string') {
        return null;
      }

      const trimmed = dateStr.trim();
      if (!trimmed) {
        return null;
      }

      // Native date input returns YYYY-MM-DD format
      // Add T00:00:00 to ensure we get midnight in local time
      const date = new Date(trimmed + 'T00:00:00');

      // Check if date is valid
      if (isNaN(date.getTime())) {
        return null;
      }

      return date;
    }

    // ============================================================================
    // DATE PICKERS
    // ============================================================================

    /**
     * Helper to get today at midnight (avoid time-of-day issues)
     */
    function getTodayMidnight() {
      const now = new Date();
      return new Date(now.getFullYear(), now.getMonth(), now.getDate());
    }

    // Add event listeners for date inputs
    document.getElementById('loanStartDate').addEventListener('change', function() {
      updateRepaymentMinDate();
      runRepaymentCalculation();
    });

    document.getElementById('firstPaymentDate').addEventListener('change', function() {
      runRepaymentCalculation();
    });

    /**
     * Update minimum date for repayment picker based on loan start date
     * Uses native HTML5 date input min attribute
     */
    function updateRepaymentMinDate() {
      const loanStartMode = document.getElementById('loanStartMode').value;
      const loanStartDateInput = document.getElementById('loanStartDate');
      const firstPaymentDateInput = document.getElementById('firstPaymentDate');

      const today = getTodayMidnight();
      let minDate = today;

      // If user picked a specific loan start date, use it as minimum
      if (loanStartMode === 'pick-date' && loanStartDateInput.value) {
        const loanStartDate = new Date(loanStartDateInput.value + 'T00:00:00');
        if (loanStartDate > minDate) {
          minDate = loanStartDate;
        }
      }

      // Set min attribute in YYYY-MM-DD format
      const minDateStr = minDate.toISOString().split('T')[0];
      firstPaymentDateInput.setAttribute('min', minDateStr);

      // Clear the date if it's now invalid
      if (firstPaymentDateInput.value) {
        const selectedDate = new Date(firstPaymentDateInput.value + 'T00:00:00');
        if (selectedDate < minDate) {
          firstPaymentDateInput.value = '';
        }
      }
    }

    // Initialize minimum date for repayment picker on page load
    const today = getTodayMidnight();
    const todayStr = today.toISOString().split('T')[0];
    document.getElementById('firstPaymentDate').setAttribute('min', todayStr);

    // Update min date when loan start mode changes
    document.getElementById('loanStartMode').addEventListener('change', updateRepaymentMinDate);

    // ============================================================================
    // CLICK-TO-OPEN DATE PICKERS
    // ============================================================================

    /**
     * Enable click-to-open behavior for native date inputs
     * Ensures clicking anywhere in the input opens the date picker,
     * not just the small calendar icon
     */
    function enableClickToOpenDatepickers() {
      const dateInputIds = ['loanStartDate', 'firstPaymentDate'];

      dateInputIds.forEach((id) => {
        const input = document.getElementById(id);
        if (!input) return;

        // Open picker when input is clicked
        input.addEventListener('click', () => {
          try {
            // Modern browsers support showPicker()
            if (input.showPicker) {
              input.showPicker();
            } else {
              // Fallback: focus usually opens the picker
              input.focus();
            }
          } catch (e) {
            // Some browsers may throw SecurityError, ignore it
            console.debug('Date picker open attempt:', e);
          }
        });

        // Also open when input receives focus (keyboard navigation)
        input.addEventListener('focus', () => {
          try {
            if (input.showPicker) {
              input.showPicker();
            }
          } catch (e) {
            // Ignore errors
            console.debug('Date picker open attempt:', e);
          }
        });
      });
    }

    // Initialize click-to-open behavior after DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', enableClickToOpenDatepickers);
    } else {
      // DOM already loaded, run immediately
      enableClickToOpenDatepickers();
    }

    // Initialize loan amount highlight on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', updateLoanAmountHighlight);
    } else {
      // DOM already loaded, run immediately
      updateLoanAmountHighlight();
    }
  </script>
</body>
</html>
