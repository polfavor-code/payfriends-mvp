<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Loan Calculator - PayFriends</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #0c1015 0%, #1a1f2e 100%);
      color: #e5e7eb;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: rgba(31, 41, 55, 0.6);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 8px;
      color: #fff;
    }

    .subtitle {
      color: #9ca3af;
      font-size: 14px;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }

    @media (max-width: 1024px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: rgba(31, 41, 55, 0.6);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 24px;
    }

    .card h2 {
      font-size: 18px;
      margin-bottom: 20px;
      color: #fff;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 8px;
      color: #d1d5db;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      background: rgba(12, 16, 21, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 10px 12px;
      color: #e5e7eb;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    /* Select-specific styling for proper arrow positioning */
    .form-group select {
      padding-right: 36px; /* Extra space for dropdown arrow */
      background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%23e5e7eb' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      cursor: pointer;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: rgba(59, 130, 246, 0.5);
    }

    .form-group input:disabled,
    .form-group select:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .form-group input[type="number"] {
      font-variant-numeric: tabular-nums;
    }

    /* Highlight for empty loan amount input */
    .loan-amount-empty {
      border-color: #34d399 !important;
      box-shadow: 0 0 0 1px #34d399;
    }

    /* Loan amount helper / validation note */
    .loan-amount-note {
      font-size: 12px;
      margin-top: 6px;
      font-style: normal;
      color: #34d399;
    }

    .form-hint {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 6px;
      font-style: italic;
    }

    .hidden {
      display: none;
    }

    .btn {
      width: 100%;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.2s;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .btn:active {
      transform: translateY(0);
    }

    .totals {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .total-card {
      background: rgba(12, 16, 21, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      padding: 16px;
    }

    .total-label {
      font-size: 12px;
      text-transform: uppercase;
      color: #9ca3af;
      margin-bottom: 8px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .total-value {
      font-size: 24px;
      font-weight: 700;
      color: #fff;
      font-variant-numeric: tabular-nums;
    }

    .schedule-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .loan-meta {
      margin-bottom: 16px;
    }

    .loan-meta-primary {
      font-size: 15px;
      font-weight: 500;
      color: #e5e7eb;
    }

    .loan-meta-secondary {
      margin-top: 4px;
      font-size: 14px;
      font-weight: 500;
      color: #34d399;
    }

    .schedule-subtitle {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 16px;
    }

    .schedule-table {
      overflow-x: auto;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      background: rgba(12, 16, 21, 0.8);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead th {
      background: rgba(31, 41, 55, 0.98);
      padding: 12px;
      text-align: left;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      color: #9ca3af;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    thead th.align-right {
      text-align: right;
    }

    tbody td {
      padding: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      color: #d1d5db;
    }

    tbody td.align-right {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    tbody tr:nth-child(even) {
      background: rgba(10, 13, 17, 0.6);
    }

    tbody tr:hover {
      background: rgba(55, 65, 81, 0.3);
    }

    tfoot td {
      padding: 14px 12px;
      border-top: 1px solid rgba(16, 185, 129, 0.6);
      font-weight: 700;
      color: #34d399;
      font-size: 14px;
    }

    tfoot td.align-right {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    tfoot td:first-child {
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge-preview {
      background: rgba(59, 130, 246, 0.2);
      color: #60a5fa;
    }

    .badge-actual {
      background: rgba(16, 185, 129, 0.2);
      color: #34d399;
    }

    .info-box {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 8px;
      padding: 12px;
      margin-top: 16px;
      font-size: 13px;
      color: #93c5fd;
      line-height: 1.5;
    }

    .debug-console {
      background: rgba(12, 16, 21, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      padding: 16px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      color: #a5f3fc;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .error-message {
      color: #ef4444;
      font-weight: 600;
    }

    :root {
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #34d399;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Loan Calculator</h1>
      <p class="subtitle">Calculate repayment schedules and interest for loans between friends</p>
    </div>

    <!-- Calculator container - partial will be loaded here -->
    <div id="calculator-root"></div>
  </div>

  <!-- Load dependencies -->
  <script src="/js/formatters.js"></script>
  <script src="/components/fairness-icon.js"></script>

  <!-- Load shared calculator engine -->
  <script src="/js/loanCalculatorEngine.js"></script>

  <script>
    // Load the calculator partial and initialize
    async function initializeCalculator() {
      try {
        // Fetch the calculator partial HTML
        const response = await fetch('/partials/loan-calculator-form.html');
        if (!response.ok) {
          throw new Error(`Failed to load calculator: ${response.status}`);
        }

        const html = await response.text();
        document.getElementById('calculator-root').innerHTML = html;

        // Now that the HTML is loaded, set up the calculator logic
        setupCalculatorLogic();
      } catch (error) {
        console.error('Error initializing calculator:', error);
        document.getElementById('calculator-root').innerHTML =
          '<div class="card"><p style="color: #ef4444;">Error loading calculator. Please refresh the page.</p></div>';
      }
    }

    // Set up calculator UI logic and event listeners
    function setupCalculatorLogic() {
      // Get formatting functions from window
      const formatMoney = window.formatCurrency2;

      // Safe DOM references for principal input and error elements
      let principalInput = null;
      let principalError = null;

      function getPrincipalInputElement() {
        if (!principalInput) {
          principalInput = document.getElementById('principal');
        }
        return principalInput;
      }

      function getPrincipalErrorElement() {
        if (!principalError) {
          principalError = document.getElementById('principalError');
        }
        return principalError;
      }

      // Interest mode ('interest' or 'no-interest')
      let interestMode = 'interest';

      // ============================================================================
      // INTEREST MODE TOGGLE
      // ============================================================================

      /**
       * Set interest mode (Interest or No interest)
       */
      function setInterestMode(mode) {
        interestMode = mode;
        const modeInterestBtn = document.getElementById('mode-interest');
        const modeNoInterestBtn = document.getElementById('mode-no-interest');
        const interestInputRow = document.getElementById('interest-input-row');
        const fairRangeExplanation = document.getElementById('fair-range-explanation');

        if (mode === 'interest') {
          // Interest mode: show input and fair range
          modeInterestBtn.style.background = '#6ee7b7';
          modeInterestBtn.style.color = '#000';
          modeNoInterestBtn.style.background = 'transparent';
          modeNoInterestBtn.style.color = '#e5e7eb';
          interestInputRow.style.display = 'flex';
        } else {
          // No interest mode: hide input and fair range
          modeInterestBtn.style.background = 'transparent';
          modeInterestBtn.style.color = '#e5e7eb';
          modeNoInterestBtn.style.background = '#6ee7b7';
          modeNoInterestBtn.style.color = '#000';
          interestInputRow.style.display = 'none';
          // Also hide explanation if it was open
          fairRangeExplanation.classList.add('hidden');
          document.getElementById('fair-range-pill').setAttribute('aria-expanded', 'false');
        }

        // Trigger recalculation
        runRepaymentCalculation();
      }

      /**
       * Toggle fair range explanation visibility
       */
      function toggleFairRangeExplanation() {
        const explanation = document.getElementById('fair-range-explanation');
        const pill = document.getElementById('fair-range-pill');
        const isExpanded = pill.getAttribute('aria-expanded') === 'true';

        if (isExpanded) {
          explanation.classList.add('hidden');
          pill.setAttribute('aria-expanded', 'false');
        } else {
          explanation.classList.remove('hidden');
          pill.setAttribute('aria-expanded', 'true');
        }
      }

      /**
       * Calculate fair interest range based on loan parameters
       * Returns {min, max} percentage values
       */
      function calculateFairRange() {
        // Get loan parameters
        const principalValue = document.getElementById('principal').value.trim();
        const loanAmount = window.PayFriendsCalculator.parseMoney(principalValue);
        const repaymentType = document.getElementById('repaymentType').value;
        const numberOfInstallments = parseInt(document.getElementById('numInstallments').value);
        const firstPaymentDueOption = document.getElementById('firstPaymentDue').value;

        // Base range
        let minRate = 4;
        let maxRate = 7;

        // Adjust based on loan amount (higher amounts = higher risk)
        if (loanAmount > 0) {
          if (loanAmount > 10000 * 100) { // > €10,000
            minRate += 1;
            maxRate += 1;
          } else if (loanAmount < 2000 * 100) { // < €2,000
            minRate = Math.max(3, minRate - 1);
            maxRate = Math.max(5, maxRate - 1);
          }
        }

        // Adjust based on duration (longer = more uncertainty)
        const durationMonths = estimateLoanDurationMonths(firstPaymentDueOption, numberOfInstallments);
        if (durationMonths > 24) { // > 2 years
          minRate += 1;
          maxRate += 1;
        } else if (durationMonths < 6) { // < 6 months
          minRate = Math.max(3, minRate - 1);
          maxRate = Math.max(5, maxRate - 1);
        }

        // Adjust based on installments (more installments = lower risk)
        if (repaymentType === 'installments' && numberOfInstallments >= 12) {
          maxRate = Math.max(5, maxRate - 1);
        }

        return { min: minRate, max: maxRate };
      }

      /**
       * Estimate loan duration in months for fair range calculation
       */
      function estimateLoanDurationMonths(firstPaymentOption, installments) {
        let months = 12; // default 1 year

        // Estimate from first payment option
        if (firstPaymentOption === '1-week') months = 0.25;
        else if (firstPaymentOption === '1-month') months = 1;
        else if (firstPaymentOption === '6-months') months = 6;
        else if (firstPaymentOption === '1-year') months = 12;
        else if (firstPaymentOption === '2-years') months = 24;
        else if (firstPaymentOption === '3-years') months = 36;

        // For installments, approximate total duration
        if (installments > 1) {
          months = months * installments;
        }

        return months;
      }

      /**
       * Update fair range pill text
       */
      function updateFairRangePill() {
        const range = calculateFairRange();
        document.getElementById('fair-range-text').textContent = `Fair range (${range.min}–${range.max}%)`;
      }

      /**
       * Update UI based on repayment type
       */
      function updateRepaymentTypeUI() {
        const repaymentType = document.getElementById('repaymentType').value;
        const isOneTime = repaymentType === 'one_time';

        const numInstallmentsGroup = document.getElementById('numInstallments').closest('.form-group');
        const frequencyGroup = document.getElementById('frequencyGroup');
        const installmentsHint = document.getElementById('installmentsHint');
        const paymentTimingLabel = document.getElementById('paymentTimingLabel');
        const paymentTimingHint = document.getElementById('paymentTimingHint');
        const firstPaymentDue = document.getElementById('firstPaymentDue');
        const numInstallments = document.getElementById('numInstallments');

        if (isOneTime) {
          // 1-time payment mode
          paymentTimingLabel.textContent = 'Full repayment due (after loan start)';
          paymentTimingHint.textContent = 'When full repayment is due.';
          numInstallments.value = 1;
          numInstallmentsGroup.style.display = 'none';
          frequencyGroup.style.display = 'none';
          installmentsHint.style.display = 'block';
          if (!firstPaymentDue.value || firstPaymentDue.value === '') {
            firstPaymentDue.value = '1-year';
          }
        } else {
          // Installments mode
          paymentTimingLabel.textContent = 'First payment due (after loan start)';
          paymentTimingHint.textContent = 'When the first repayment is due.';
          numInstallmentsGroup.style.display = 'block';
          numInstallments.value = 12;
          frequencyGroup.style.display = 'block';
          installmentsHint.style.display = 'none';
          firstPaymentDue.value = '1-year';
        }

        // Trigger recalculation after UI update
        runRepaymentCalculation();
        updateFairRangePill();
      }

      /**
       * Reset calculator to defaults
       */
      function resetCalculator() {
        document.getElementById('principal').value = '';
        document.getElementById('interest').value = 5;
        document.getElementById('repaymentType').value = 'one_time';
        document.getElementById('numInstallments').value = 1;
        document.getElementById('frequency').value = 'every-month';
        document.getElementById('firstPaymentDue').value = '1-year';
        document.getElementById('loanStartMode').value = 'upon_acceptance';

        setInterestMode('interest');
        updateLoanAmountHighlight();

        document.getElementById('loanStartDateGroup').classList.add('hidden');
        document.getElementById('firstPaymentDateGroup').classList.add('hidden');
        document.getElementById('loanStartDate').value = '';
        document.getElementById('firstPaymentDate').value = '';

        updateRepaymentTypeUI();

        document.getElementById('scheduleBody').innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">Waiting for calculation...</td></tr>';
        document.getElementById('scheduleTotals').style.display = 'none';
        document.getElementById('loanSummaryContent').innerHTML = 'Configure parameters to see loan summary...';

        // Hide config loan timing
        const configLoanTiming = document.getElementById('config-loan-timing');
        if (configLoanTiming) {
          configLoanTiming.style.display = 'none';
        }
      }

      /**
       * Debounce utility for input events
       */
      function debounce(func, delay) {
        let timeoutId;
        return function(...args) {
          clearTimeout(timeoutId);
          timeoutId = setTimeout(() => func.apply(this, args), delay);
        };
      }

      /**
       * Main calculation function wrapper
       */
      function runRepaymentCalculation() {
        calculateSchedule();
      }

      // Create debounced version for input events
      const debouncedCalculation = debounce(runRepaymentCalculation, 300);

      /**
       * Render loan summary
       */
      function renderLoanSummary(summary) {
        const container = document.getElementById('loanSummaryContent');
        if (!container) return;

        const lines = [];

        // Loan amount
        lines.push(`<p><strong>Loan amount:</strong> ${formatMoney(summary.loanAmount)}</p>`);

        // Repayment type
        const repaymentTypeLabel = summary.repaymentType === 'one_time' ? 'One-time payment' : 'Installments';
        lines.push(`<p><strong>Repayment type:</strong> ${repaymentTypeLabel}</p>`);

        // Loan duration
        if (summary.loanDuration) {
          lines.push(`<p><strong>Loan duration:</strong> ${summary.loanDuration}</p>`);
        }

        // Interest rate
        if (summary.annualInterestRate === 0) {
          lines.push(`<p><strong>Annual interest rate:</strong> No interest (0%)</p>`);
        } else {
          lines.push(`<p><strong>Annual interest rate:</strong> ${summary.annualInterestRate.toFixed(2)}% per year</p>`);
        }

        // Total interest (with Fairness icon)
        const fairnessIcon = fairnessIconSVG('', {width: '16px', height: '16px', display: 'inline-block', verticalAlign: 'middle', marginLeft: '4px'});
        lines.push(`<p><strong>Total interest:</strong> ${formatMoney(summary.totalInterest)} <span class="pf-fairness-icon" title="Fairness Between Friends" style="display: inline-flex; align-items: center; vertical-align: middle;">${fairnessIcon}</span></p>`);

        // Total to repay (with Fairness icon)
        lines.push(`<p><strong>Total to repay:</strong> ${formatMoney(summary.totalRepayment)} <span class="pf-fairness-icon" title="Fairness Between Friends" style="display: inline-flex; align-items: center; vertical-align: middle;">${fairnessIcon}</span></p>`);

        // Additional details based on repayment type
        if (summary.repaymentType === 'installments' && summary.numberOfInstallments > 1) {
          const principalPerInstallment = Math.round(summary.loanAmount / summary.numberOfInstallments);
          lines.push(`<p><strong>Principal per installment:</strong> ~${formatMoney(principalPerInstallment)} (excluding interest)</p>`);
        }

        // First payment due
        if (summary.firstDueDate) {
          const label = summary.repaymentType === 'one_time' ? 'Full repayment due' : 'First payment due';
          lines.push(`<p><strong>${label}:</strong> ${summary.firstDueDate}</p>`);
        }

        // Fairness Between Friends summary note
        lines.push(`
          <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.08); font-size: 13px; color: #9ca3af;">
            <p style="margin-bottom: 8px;">
              Amounts marked with <span class="pf-fairness-icon-inline" title="Fairness Between Friends" style="display: inline-flex; align-items: center; vertical-align: middle; margin: 0 2px;">${fairnessIcon}</span> are calculated using the Fairness Between Friends rules.
              <a href="#" id="fairnessToggle" style="color: #34d399; text-decoration: none; border-bottom: 1px solid transparent; transition: border-color 0.2s;" onmouseover="this.style.borderBottomColor='#34d399'" onmouseout="this.style.borderBottomColor='transparent'">How it works</a>
            </p>
            <div id="fairnessExplanation" style="display: none; margin-top: 12px; padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 6px; font-size: 12px; line-height: 1.6; color: #d1d5db;">
              Fairness Between Friends adjusts interest dynamically based on the outstanding balance and the time that has passed. This means paying earlier or more reduces total interest, while paying later or less increases it. Both sides always see the current, fair value of the loan in real time.
            </div>
          </div>
        `);

        container.innerHTML = lines.join('');

        // Toggle Fairness "How it works" explanation
        const fairnessToggle = document.getElementById('fairnessToggle');
        const fairnessExplanation = document.getElementById('fairnessExplanation');

        if (fairnessToggle && fairnessExplanation) {
          fairnessToggle.addEventListener('click', function(e) {
            e.preventDefault();
            if (fairnessExplanation.style.display === 'none') {
              fairnessExplanation.style.display = 'block';
            } else {
              fairnessExplanation.style.display = 'none';
            }
          });
        }
      }

      /**
       * Main calculation function triggered by input changes
       */
      function calculateSchedule() {
        try {
          // Use the shared calculator engine to build inputs from form
          const calculatorContainer = document.querySelector('[data-loan-calculator]');
          const loanInputs = window.PayFriendsCalculator.buildLoanInputsFromForm(calculatorContainer);

          // Override interest rate if in "No interest" mode
          if (interestMode === 'no-interest') {
            loanInputs.annualInterestRate = 0;
          }

          // Validation (match wizard Step 2 logic)
          const principalValue = document.getElementById('principal').value.trim();
          const loanAmount = window.PayFriendsCalculator.parseMoney(principalValue);

          if (principalValue === '' || !loanAmount || loanAmount <= 0 || isNaN(loanAmount)) {
            // Don't show error - just show waiting state
            document.getElementById('scheduleBody').innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">Enter loan amount and details to calculate...</td></tr>';
            document.getElementById('scheduleTotals').style.display = 'none';
            document.getElementById('loanSummaryContent').innerHTML = 'Configure parameters to see loan summary...';

            // Hide config loan timing
            const configLoanTiming = document.getElementById('config-loan-timing');
            if (configLoanTiming) {
              configLoanTiming.style.display = 'none';
            }
            return;
          }

          // Generate schedule using shared engine
          const result = window.PayFriendsCalculator.calculateLoanSchedule(loanInputs);

          // Update UI - Schedule header
          const badge = result.effectiveMode === 'preview'
            ? '<span class="badge badge-preview">Preview</span>'
            : '<span class="badge badge-actual">Actual</span>';
          document.getElementById('modeBadge').innerHTML = badge;

          // Build loan start label with duration
          const loanStartText = window.PayFriendsCalculator.getLoanStartLabelWithContext(
            loanInputs.explicitLoanStartDate,
            result.effectiveMode,
            loanInputs.loanStartMode
          );

          const loanDuration = window.PayFriendsCalculator.calculateLoanDuration(
            result.rows,
            loanInputs.explicitLoanStartDate,
            result.effectiveMode
          );

          // Update the configuration card with loan timing info (same as wizard Step 2)
          const configLoanTiming = document.getElementById('config-loan-timing');
          const configLoanStart = document.getElementById('config-loan-start');
          const configLoanDuration = document.getElementById('config-loan-duration');

          if (configLoanTiming && configLoanStart && configLoanDuration) {
            configLoanStart.innerHTML = `Loan start: ${loanStartText}`;
            if (loanDuration) {
              configLoanDuration.innerHTML = `Loan duration: ${loanDuration}`;
              configLoanDuration.style.display = 'block';
            } else {
              configLoanDuration.style.display = 'none';
            }
            configLoanTiming.style.display = 'block';
          }

          // Update UI - Schedule table body
          const tbody = document.getElementById('scheduleBody');
          tbody.innerHTML = '';

          result.rows.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${row.index}</td>
              <td>${row.label}</td>
              <td class="align-right">${formatMoney(row.principal)}</td>
              <td class="align-right">${formatMoney(row.interest)}</td>
              <td class="align-right" style="font-weight: 600;">${formatMoney(row.totalPayment)}</td>
              <td class="align-right">${formatMoney(row.balance)}</td>
            `;
            tbody.appendChild(tr);
          });

          // Update UI - Schedule table footer (totals row)
          document.getElementById('scheduleTotals').style.display = 'table-footer-group';
          document.getElementById('footerPrincipal').textContent = formatMoney(result.totals.principal);
          document.getElementById('footerInterest').textContent = formatMoney(result.totals.interest);
          document.getElementById('footerTotal').textContent = formatMoney(result.totals.totalRepayment);

          // Update Loan Summary
          const summary = window.PayFriendsCalculator.calculateLoanSummary(loanInputs, result);
          renderLoanSummary(summary);

        } catch (error) {
          console.error('Calculation error:', error);
          document.getElementById('loanSummaryContent').innerHTML =
            '<p style="color: #ef4444;">Error calculating loan schedule. Please check your inputs.</p>';
        }
      }

      // Clear error message helper
      function clearPrincipalError() {
        const el = getPrincipalErrorElement();
        if (!el) return;
        el.style.display = 'none';
        el.textContent = '';
      }

      // Show error message helper
      function showPrincipalError(message) {
        const el = getPrincipalErrorElement();
        if (!el) return;

        if (message) {
          el.textContent = message;
          el.style.display = 'block';
        } else {
          el.textContent = '';
          el.style.display = 'none';
        }
      }

      // Update loan amount highlight based on whether field is empty
      function updateLoanAmountHighlight() {
        const input = getPrincipalInputElement();
        if (!input) return;

        const value = input.value.trim();
        if (value === '') {
          input.classList.add('loan-amount-empty');
        } else {
          input.classList.remove('loan-amount-empty');
        }
      }

      // ============================================================================
      // EVENT LISTENERS
      // ============================================================================

      // Loan amount
      document.getElementById('principal').addEventListener('input', () => {
        updateLoanAmountHighlight();
        debouncedCalculation();
        updateFairRangePill();
      });

      // Principal input formatting (match wizard Step 2 approach)
      const principalInputEl = getPrincipalInputElement();
      if (principalInputEl) {
        principalInputEl.addEventListener('focus', function() {
          const num = window.PayFriendsCalculator.parseMoney(this.value);
          if (num > 0) {
            this.value = num.toString();
          }
        });

        principalInputEl.addEventListener('blur', function() {
          const trimmed = this.value.trim();
          if (trimmed !== '') {
            const num = window.PayFriendsCalculator.parseMoney(trimmed);
            if (num > 0) {
              // Format the input for better UX
              this.value = window.PayFriendsCalculator.formatMoneyInput(num);
            }
          }
        });
      }

      // Interest rate
      document.getElementById('interest').addEventListener('input', () => {
        debouncedCalculation();
        updateFairRangePill();
      });

      // Interest mode toggle buttons
      document.getElementById('mode-interest').addEventListener('click', () => setInterestMode('interest'));
      document.getElementById('mode-no-interest').addEventListener('click', () => setInterestMode('no-interest'));

      // Fair range pill toggle
      document.getElementById('fair-range-pill').addEventListener('click', toggleFairRangeExplanation);

      // Loan start date mode
      document.getElementById('loanStartMode').addEventListener('change', runRepaymentCalculation);

      // Repayment type
      document.getElementById('repaymentType').addEventListener('change', updateRepaymentTypeUI);

      // First payment due
      document.getElementById('firstPaymentDue').addEventListener('change', () => {
        runRepaymentCalculation();
        updateFairRangePill();
      });

      // Payment frequency
      document.getElementById('frequency').addEventListener('change', runRepaymentCalculation);

      // Number of installments
      document.getElementById('numInstallments').addEventListener('input', () => {
        debouncedCalculation();
        updateFairRangePill();
      });

      // Calculator reset link
      const calculatorResetLink = document.getElementById('calculator-reset-link');
      if (calculatorResetLink) {
        calculatorResetLink.addEventListener('click', function(event) {
          event.preventDefault();
          resetCalculator();
        });
      }

      // Show/hide loan start date picker
      document.getElementById('loanStartMode').addEventListener('change', function() {
        const loanStartDateGroup = document.getElementById('loanStartDateGroup');
        const loanStartDateInput = document.getElementById('loanStartDate');
        if (this.value === 'pick-date') {
          loanStartDateGroup.classList.remove('hidden');
        } else {
          loanStartDateGroup.classList.add('hidden');
          loanStartDateInput.value = '';
        }
      });

      // Show/hide first payment date picker
      document.getElementById('firstPaymentDue').addEventListener('change', function() {
        const firstPaymentDateGroup = document.getElementById('firstPaymentDateGroup');
        const firstPaymentDateInput = document.getElementById('firstPaymentDate');
        if (this.value === 'pick-date') {
          firstPaymentDateGroup.classList.remove('hidden');
        } else {
          firstPaymentDateGroup.classList.add('hidden');
          firstPaymentDateInput.value = '';
        }
      });

      // Date input changes
      document.getElementById('loanStartDate').addEventListener('change', runRepaymentCalculation);
      document.getElementById('firstPaymentDate').addEventListener('change', runRepaymentCalculation);

      // ============================================================================
      // INITIALIZATION
      // ============================================================================

      // Set initial UI state
      document.getElementById('repaymentType').value = 'one_time';
      document.getElementById('firstPaymentDue').value = '1-year';
      updateRepaymentTypeUI();
      updateFairRangePill();
      updateLoanAmountHighlight();

      // Show waiting message (match wizard Step 2)
      document.getElementById('scheduleBody').innerHTML =
        '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">Enter loan amount and details to calculate...</td></tr>';
      document.getElementById('loanSummaryContent').innerHTML =
        'Configure parameters to see loan summary...';
    }

    // Initialize calculator when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeCalculator);
    } else {
      initializeCalculator();
    }
  </script>
</body>
</html>
