<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PayFriends — Select Agreement</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <!-- Shared control styles -->
  <link rel="stylesheet" href="/css/shared-controls.css" />
  <!-- App-wide styles -->
  <link rel="stylesheet" href="/css/app.css" />
  <!-- Shared header component -->
  <script src="/js/header.js"></script>
  <!-- Centralized currency formatters -->
  <script src="/js/formatters.js"></script>
  <style>
    :root {
      --bg: #0e1116;
      --card: #151a21;
      --text: #e6eef6;
      --muted: #a7b0bd;
      --accent: #3ddc97;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 16px;
    }

    .back-link {
      display: inline-block;
      color: var(--muted);
      text-decoration: none;
      margin-bottom: 16px;
      font-size: 14px
    }

    .back-link:hover {
      color: var(--text);
      text-decoration: underline
    }

    h1 {
      margin: 0 0 8px 0;
      font-size: 28px
    }

    .subtitle {
      color: var(--muted);
      font-size: 15px;
      margin: 0 0 32px 0;
      line-height: 1.6
    }

    .agreements-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 16px;
      margin-top: 24px
    }

    .agreement-card {
      background: var(--card);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 16px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      color: inherit;
      display: block;
    }

    .agreement-card:hover {
      border-color: rgba(61, 220, 151, 0.3);
      background: rgba(255, 255, 255, 0.02);
      transform: translateY(-2px);
    }

    .agreement-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px
    }

    .user-avatar {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      overflow: hidden;
      flex-shrink: 0
    }

    .user-avatar.size-medium {
      width: 48px;
      height: 48px;
      font-size: 18px;
      font-weight: 600
    }

    .user-avatar-image {
      width: 100%;
      height: 100%;
      object-fit: cover
    }

    .user-avatar-initials {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 600;
      text-transform: uppercase
    }

    .user-avatar-initials.color-1 {
      background: #6366f1
    }

    .user-avatar-initials.color-2 {
      background: #8b5cf6
    }

    .user-avatar-initials.color-3 {
      background: #ec4899
    }

    .user-avatar-initials.color-4 {
      background: #f59e0b
    }

    .user-avatar-initials.color-5 {
      background: #10b981
    }

    .user-avatar-initials.color-6 {
      background: #3b82f6
    }

    .user-avatar-initials.color-7 {
      background: #14b8a6
    }

    .agreement-names {
      flex: 1;
      min-width: 0
    }

    .agreement-name {
      font-weight: 600;
      font-size: 15px;
      line-height: 1.3
    }

    .agreement-role {
      color: var(--muted);
      font-size: 12px;
      margin-top: 2px
    }

    .agreement-details {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(255, 255, 255, 0.06)
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 14px
    }

    .detail-label {
      color: var(--muted)
    }

    .detail-value {
      color: var(--text);
      font-weight: 500
    }

    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px
    }

    .status-badge.active {
      background: #22c55e;
      color: #0d130f
    }

    .empty-state {
      text-align: center;
      color: var(--muted);
      padding: 64px 32px;
      font-size: 15px
    }

    .loading {
      text-align: center;
      color: var(--muted);
      padding: 48px 32px;
      font-size: 15px
    }
  </style>
</head>

<body>
  <div class="container">
    <a href="/app" class="back-link">← Back to Dashboard</a>

    <h1 id="page-title">Select agreement</h1>
    <p class="subtitle" id="page-subtitle">Choose which agreement you want to report a payment for.</p>

    <div id="loading" class="loading">Loading your agreements...</div>
    <div id="empty-state" class="empty-state" style="display:none">
      No active agreements found. Please create a loan agreement first.
    </div>
    <div id="agreements-grid" class="agreements-grid" style="display:none"></div>
  </div>

  <script>
    // Load formatters (relies on side-effect of assigning to window)
    import('/js/formatters.js').then(() => {
      initializePage();
    });

    function initializePage() {
      // Get role from URL parameter
      const params = new URLSearchParams(window.location.search);
      const role = params.get('role') || 'borrower'; // Default to borrower

      // Update page title based on role
      const pageTitle = document.getElementById('page-title');
      const pageSubtitle = document.getElementById('page-subtitle');
      if (role === 'lender') {
        pageTitle.textContent = 'Select agreement (as lender)';
        pageSubtitle.textContent = 'Choose which agreement you want to report a payment for as the lender.';
      } else {
        pageTitle.textContent = 'Select agreement (as borrower)';
        pageSubtitle.textContent = 'Choose which agreement you want to report a payment for as the borrower.';
      }

      // Helper functions
      function getInitials(name) {
        if (!name) return '?';
        const parts = name.trim().split(/\s+/);
        if (parts.length === 1) {
          return parts[0].substring(0, 2).toUpperCase();
        }
        return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
      }

      function getAvatarColor(name) {
        if (!name) return 'color-1';
        const hash = name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
        const colorIndex = (hash % 7) + 1;
        return `color-${colorIndex}`;
      }

      // Load agreements
      async function loadAgreements() {
        const loading = document.getElementById('loading');
        const emptyState = document.getElementById('empty-state');
        const grid = document.getElementById('agreements-grid');

        try {
          // Get current user
          const userResponse = await fetch('/api/user');
          if (!userResponse.ok) {
            window.location.href = '/login.html';
            return;
          }
          const userData = await userResponse.json();
          const currentUser = userData.user;

          // Get all agreements
          const agreementsResponse = await fetch('/api/agreements');
          if (!agreementsResponse.ok) {
            throw new Error('Failed to load agreements');
          }
          const agreements = await agreementsResponse.json();

          // Filter active agreements by role
          const activeAgreements = agreements.filter(agreement => {
            if (agreement.status !== 'active') return false;
            if (role === 'borrower') {
              return agreement.borrower_user_id === currentUser.id;
            } else {
              return agreement.lender_user_id === currentUser.id;
            }
          });

          loading.style.display = 'none';

          if (activeAgreements.length === 0) {
            emptyState.style.display = 'block';
            return;
          }

          // If only 1 agreement, navigate directly
          if (activeAgreements.length === 1) {
            window.location.href = `/agreements/${activeAgreements[0].id}/report-payment`;
            return;
          }

          // Render agreement cards
          grid.style.display = 'grid';
          activeAgreements.forEach(agreement => {
            const card = createAgreementCard(agreement, currentUser, role);
            grid.appendChild(card);
          });

        } catch (err) {
          console.error('Error loading agreements:', err);
          loading.textContent = 'Error loading agreements. Please try again.';
          loading.style.color = '#ff6b6b';
        }
      }

      function createAgreementCard(agreement, currentUser, role) {
        const card = document.createElement('a');
        card.className = 'agreement-card';
        card.href = `/agreements/${agreement.id}/report-payment`;

        // Determine counterparty (person on the other side of the agreement)
        const isUserBorrower = agreement.borrower_user_id === currentUser.id;
        const counterpartyName = isUserBorrower
          ? (agreement.lender_full_name || agreement.lender_name || agreement.lender_email)
          : (agreement.borrower_full_name || agreement.friend_first_name || agreement.borrower_email);

        const lenderName = agreement.lender_full_name || agreement.lender_name || agreement.lender_email;
        const borrowerName = agreement.borrower_full_name || agreement.friend_first_name || agreement.borrower_email;

        // Create avatar
        let avatarHtml = '';
        const counterpartyInitials = getInitials(counterpartyName);
        const counterpartyColorClass = getAvatarColor(counterpartyName);
        avatarHtml = `<div class="user-avatar size-medium"><div class="user-avatar-initials ${counterpartyColorClass}">${counterpartyInitials}</div></div>`;

        // Calculate outstanding amount
        const totalDueCents = agreement.today_total_due_cents || agreement.planned_total_due_cents || agreement.amount_cents;
        const paidCents = agreement.total_paid_cents || 0;
        const outstandingCents = Math.max(0, totalDueCents - paidCents);

        card.innerHTML = `
        <div class="agreement-header">
          ${avatarHtml}
          <div class="agreement-names">
            <div class="agreement-name">${counterpartyName}</div>
            <div class="agreement-role">${role === 'borrower' ? 'You are borrowing from' : 'You lent to'} ${isUserBorrower ? lenderName : borrowerName}</div>
          </div>
        </div>
        <div class="agreement-details">
          ${agreement.description ? `
            <div class="detail-row">
              <span class="detail-label">Description:</span>
              <span class="detail-value">${escapeHtml(agreement.description)}</span>
            </div>
          ` : ''}
          <div class="detail-row">
            <span class="detail-label">Loan amount:</span>
            <span class="detail-value">${formatCurrency2(agreement.amount_cents)}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Outstanding:</span>
            <span class="detail-value">${formatCurrency2(outstandingCents)}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Status:</span>
            <span class="detail-value">
              <span class="status-badge active">Active</span>
            </span>
          </div>
        </div>
      `;

        return card;
      }

      function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // Initialize
      loadAgreements();
    } // end initializePage
  </script>
</body>

</html>