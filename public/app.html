<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PayFriends — My Agreements</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <!-- Shared control styles -->
  <link rel="stylesheet" href="/css/shared-controls.css" />
  <!-- App-wide styles -->
  <link rel="stylesheet" href="/css/app.css" />
  <!-- Shared header component -->
  <script src="/js/header.js"></script>
  <!-- Phone input component -->
  <script src="/js/phone-input.js"></script>
  <!-- Centralized currency formatters -->
  <script src="/js/formatters.js"></script>
  <!-- Summary block component -->
  <script src="/components/summary-block.js"></script>
  <!-- Fairness icon component -->
  <script src="/components/fairness-icon.js"></script>
  <!-- Loan calculator engine (shared calculation logic) -->
  <script src="/js/loanCalculatorEngine.js"></script>
  <!-- Legal pages router -->
  <script src="/js/legal-router.js"></script>
  <!-- Legal pages content -->
  <script src="/js/legal-pages.js"></script>
  <!-- Profile pages router -->
  <script src="/js/profile-router.js"></script>
  <!-- Profile pages content -->
  <script src="/js/profile-pages.js"></script>
  <style>
    :root{
      --bg:#0e1116; --card:#151a21; --text:#e6eef6; --muted:#a7b0bd; --accent:#3ddc97;
      --danger:#ef4444;
      --danger-ink:#fca5a5;
      --danger-border:rgba(239,68,68,.28);
      --danger-bg:rgba(239,68,68,.06);
      --warning:#f97316;
      --warning-ink:#fb923c;
      --warning-border:rgba(249,115,22,.28);
      --warning-bg:rgba(249,115,22,.06);
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif; background:var(--bg); color:var(--text);}
    .container{max-width:1200px;margin:0 auto;padding:32px 16px;}
    .header{display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid rgba(255,255,255,0.08)}
    .header-left h1{margin:0 0 4px 0;font-size:28px}
    .header-left .user-email{color:var(--muted); font-size:14px}
    .header-right{display:flex; gap:16px; align-items:center}
    .top-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid rgba(255,255,255,0.08)}
    .top-header-left{display:flex; align-items:center; gap:12px}
    .top-header-right{display:flex; gap:12px; align-items:center}
    .logo-coin{height:54px; width:auto}
    .top-header-text{display:flex; flex-direction:column; gap:2px}
    .app-name{font-size:24px; font-weight:600; line-height:1.2; margin:0}
    .user-meta{color:var(--muted); font-size:14px; line-height:1.2}
    .app-slogan{color:var(--muted); font-size:14px; line-height:1.2; margin-top:2px}
    .top-header-user-info{color:var(--text); font-size:14px; line-height:1; white-space:nowrap; display:inline-flex; align-items:center; height:40px}
    .top-header-actions{display:flex; gap:12px; align-items:center}
    .inbox-count{color:var(--accent); font-weight:700}
    .card{background:var(--card);border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:16px;margin:16px 0}
    .row{display:flex; gap:12px; align-items:center; margin:10px 0}
    .row label{width:160px; color:var(--muted)}
    .row input{flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text)}
    .row input:focus{outline:none; border-color:var(--accent); background:#10151d}
    .row input:hover{background:#10151d}
    .row input:-webkit-autofill,
    .row input:-webkit-autofill:hover,
    .row input:-webkit-autofill:focus,
    .row input:-webkit-autofill:active{
      -webkit-background-clip:text;
      -webkit-text-fill-color:var(--text);
      transition:background-color 5000s ease-in-out 0s;
      box-shadow:inset 0 0 20px 20px #10151d;
    }
    button{padding:10px 14px;border-radius:10px;border:0;background:var(--accent);color:#0d130f;font-weight:700; cursor:pointer}
    button:hover{filter:brightness(1.06)}
    button.secondary{background:transparent; border:1px solid rgba(255,255,255,0.15); color:var(--text); margin-left:8px}
    button.secondary:hover{background:rgba(255,255,255,0.05)}
    button.btn-review-pending{background:#facc15; color:#0d130f}
    button.btn-review-pending:hover{filter:brightness(1.1)}
    .tabs{display:flex; gap:8px; margin-bottom:16px; border-bottom:1px solid rgba(255,255,255,0.08)}
    .tab{padding:10px 16px; cursor:pointer; color:var(--muted); border-bottom:2px solid transparent; margin-bottom:-1px}
    .tab.active{color:var(--accent); border-bottom-color:var(--accent)}
    .tab:hover{color:var(--text)}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:10px 12px; border-bottom:1px solid rgba(255,255,255,0.08); text-align:left; vertical-align:middle}
    th{color:var(--muted); font-weight:600; font-size:13px}
    th:nth-child(5), td:nth-child(5){text-align:center; width:80px}
    .status{color:var(--muted); margin-top:8px; min-height:1.2em;}
    .status-badge{display:inline-block; padding:4px 10px; border-radius:6px; font-size:12px; font-weight:600}
    .status-badge.pending{background:#4a4a4a; color:#fff}
    .status-badge.active{background:#3d7bdc; color:#fff}
    .status-badge.settled{background:#3ddc97; color:#0d130f}
    .status-badge.declined{background:#ff6b6b; color:#fff}
    .status-badge.cancelled{background:#6c757d; color:#fff}
    .status-text{font-size:14px; font-weight:400}
    .status-text.active{color:#22c55e}
    .status-text.pending{color:#facc15}
    .status-text.overdue{color:#f87171}
    .status-text.settled{color:#9ca3af}
    .status-text.cancelled{color:#9ca3af}
    .status-text.declined{color:#f87171}
    .status-indicator{width:22px;height:22px;border-radius:9999px;display:inline-flex;align-items:center;justify-content:center;margin:0 auto;cursor:help}
    .status-indicator--active{background:#22c55e}
    .status-indicator--pending{background:#facc15}
    .status-indicator--settled{background:#9ca3af}
    .status-indicator--overdue{background:#f87171}
    .status-indicator--cancelled{background:#9ca3af}
    .status-indicator--declined{background:#f87171}
    .status-dot{display:inline-block; width:16px; height:16px; border-radius:9999px; cursor:help; position:relative}
    .status-dot--active{background:#22c55e}
    .status-dot--pending{background:#facc15}
    .status-dot--settled{background:#9ca3af}
    .status-dot--overdue{background:#f87171}
    .status-dot--cancelled{background:#9ca3af}
    .status-dot--declined{background:#f87171}
    .status-dot-wrapper{display:inline-flex;align-items:center;justify-content:center;position:relative}
    .status-dot-wrapper::after{content:attr(data-tooltip);position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);background:#1f2937;color:#fff;padding:6px 12px;border-radius:6px;font-size:12px;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity 0.2s ease;border:1px solid rgba(255,255,255,0.1);z-index:1000}
    .status-dot-wrapper::before{content:'';position:absolute;bottom:calc(100% + 2px);left:50%;transform:translateX(-50%);border:4px solid transparent;border-top-color:#1f2937;opacity:0;pointer-events:none;transition:opacity 0.2s ease;z-index:1000}
    .status-dot-wrapper:hover::after,.status-dot-wrapper:hover::before{opacity:1}
    .actions-column{display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:flex-end; width:100%}
    .actions-column button{flex:0 0 auto; padding:8px 12px; font-size:14px; white-space:nowrap; width:auto}
    .btn-confirm-payment{background:#f97316; color:#fff; border:0; padding:8px 12px; border-radius:8px; font-weight:600; cursor:pointer; font-size:14px}
    .btn-confirm-payment:hover{background:#ea580c}
    .btn-payment-issue{background:#dc2626; color:#fff; border:0; padding:8px 12px; border-radius:8px; font-weight:600; cursor:pointer; font-size:14px}
    .btn-payment-issue:hover{background:#b91c1c}
    .messages-list{margin-top:12px; display:flex; flex-direction:column; gap:8px}
    .message-item{padding:16px 18px; background:transparent; border-radius:12px; margin:0; font-size:14px; transition:background 0.16s ease, border-color 0.16s ease, transform 0.08s ease; border:1px solid rgba(255,255,255,0.06); cursor:pointer}
    .message-item.message-clickable{cursor:pointer}
    .message-item.message-clickable:hover{background:rgba(255,255,255,0.02); transform:translateY(-1px)}
    .message-item.message-unread{font-weight:500; background:rgba(61,220,151,0.05); border:1px solid rgba(61,220,151,0.3)}
    .message-item.message-unread.message-clickable{cursor:pointer}
    .message-item.message-unread.message-clickable:hover{background:rgba(61,220,151,0.08); border-color:rgba(61,220,151,0.35)}
    .unread-indicator{color:var(--accent); font-size:16px; margin-left:8px; flex-shrink:0}
    .message-subject{font-weight:600; margin-bottom:4px}
    .message-date{color:var(--muted); font-size:12px}
    .empty-state{text-align:center; color:var(--muted); padding:32px; font-size:14px}
    /* Payment issue variant - orange theme for activity items */
    .activity-item--issue,.message-item.activity-item--issue{background:var(--warning-bg) !important; border-color:var(--warning-border) !important}
    .activity-item--issue .message-date,.message-item.activity-item--issue .message-date{color:var(--warning-ink)}
    .activity-item--issue .unread-indicator,.message-item.activity-item--issue .unread-indicator{color:var(--warning) !important; text-shadow:0 0 8px rgba(249,115,22,.3)}
    /* New Agreement wizard header */
    .new-agreement-header{display:flex; align-items:center; justify-content:space-between; margin-bottom:16px}
    .new-agreement-title{font-size:28px; font-weight:700; margin:0}
    .back-to-agreements-link{font-size:14px; color:#9da7b8; text-decoration:none; cursor:pointer; transition:color 0.15s ease}
    .back-to-agreements-link:hover{color:#ffffff; text-decoration:underline}
    @media (max-width:768px){
      .new-agreement-header{flex-direction:column; align-items:flex-start; gap:4px}
      .back-to-agreements-link{align-self:flex-start}
    }
    /* Wizard steps navigation */
    .wizard-steps{display:flex; gap:8px; margin-bottom:24px; flex-wrap:wrap}
    .wizard-step{border-radius:999px; border:1px solid #2c333d; padding:8px 16px; background-color:#151a21; color:#9da7b8; font-size:14px; font-weight:500; cursor:pointer; transition:background-color 0.15s ease, color 0.15s ease, border-color 0.15s ease; white-space:nowrap}
    .wizard-step:hover:not(.active){background-color:#1b222c; border-color:#3a4453; color:#e6eef6}
    .wizard-step.active{background-color:var(--accent); border-color:var(--accent); color:#0e1116; font-weight:600}
    .wizard-step.completed{color:#9da7b8}
    .wizard-content{min-height:200px}
    .wizard-footer{display:flex; justify-content:space-between; align-items:center; margin-top:24px; padding-top:0; gap:12px}
    .wizard-footer button{flex:0 0 auto}
    .wizard-footer .wizard-back{order:1}
    .wizard-footer .wizard-next{order:2; margin-left:auto}
    .hidden{display:none}
    .role-badge{display:inline-block; padding:4px 8px; border-radius:6px; font-size:11px; font-weight:600; background:#2a2a2a; color:#fff}
    .role-badge.lend{background:#3d7bdc; color:#fff}
    .role-badge.borrow{background:#e67e22; color:#fff}
    .invite-url-box{background:#10151d; padding:12px; border-radius:8px; margin:16px 0; font-family:monospace; font-size:13px; word-break:break-all; border:1px solid rgba(255,255,255,0.08)}
    .summary-row{display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.08)}
    .summary-row:last-child{border-bottom:none}
    .summary-label{color:var(--muted)}
    .summary-value{font-weight:600}
    .modal-overlay{position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:1000}
    .modal-card{background:var(--card); border:1px solid rgba(255,255,255,0.12); border-radius:16px; padding:24px; max-width:600px; width:90%; max-height:90vh; overflow-y:auto}
    .modal-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:12px; border-bottom:1px solid rgba(255,255,255,0.08)}
    .modal-title{margin:0; font-size:20px; font-weight:600}
    .modal-close{background:transparent; border:0; color:var(--muted); font-size:24px; cursor:pointer; padding:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center; border-radius:6px}
    .modal-close:hover{background:rgba(255,255,255,0.05); color:var(--text)}
    .modal-body{margin-bottom:20px}
    .modal-footer{display:flex; gap:12px; justify-content:flex-end; padding-top:16px; border-top:1px solid rgba(255,255,255,0.08)}
    .modal-info-row{display:flex; justify-content:space-between; padding:12px; background:#10151d; border-radius:8px; margin:8px 0}
    .modal-info-label{color:var(--muted); font-size:14px}
    .modal-info-value{font-weight:600; font-size:14px}
    .modal-note{background:#10151d; padding:12px; border-radius:8px; margin:12px 0; font-size:14px; color:var(--text)}
    .modal-helper-text{color:var(--muted); font-size:13px; margin-bottom:16px; line-height:1.5}
    .actions-header-text{display:inline-block; text-align:right; width:100%}
    .user-avatar{display:inline-flex; align-items:center; justify-content:center; border-radius:50%; overflow:hidden; flex-shrink:0; vertical-align:middle}
    .user-avatar.size-small{width:36px; height:36px; min-width:36px; font-size:13px; font-weight:600; line-height:1; letter-spacing:-0.2px}
    .user-avatar-image{width:100%; height:100%; object-fit:cover}
    .user-avatar-initials{width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:600; text-transform:uppercase}
    .user-avatar-initials.color-1{background:#6366f1}
    .user-avatar-initials.color-2{background:#8b5cf6}
    .user-avatar-initials.color-3{background:#ec4899}
    .user-avatar-initials.color-4{background:#f59e0b}
    .user-avatar-initials.color-5{background:#10b981}
    .user-avatar-initials.color-6{background:#3b82f6}
    .user-avatar-initials.color-7{background:#14b8a6}
    .counterparty-cell{display:flex; align-items:center; gap:10px}
    .due-date-overdue{color:#f87171}
    .due-date-upcoming{color:var(--muted)}
    .due-date-settled{color:#9ca3af}
    .toggle-switch{position:relative;display:inline-block;width:48px;height:24px}
    .toggle-switch input{opacity:0;width:0;height:0}
    .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#4a4a4a;transition:0.3s;border-radius:24px}
    .toggle-slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background-color:white;transition:0.3s;border-radius:50%}
    .toggle-switch input:checked + .toggle-slider{background-color:var(--accent)}
    .toggle-switch input:checked + .toggle-slider:before{transform:translateX(24px)}
    .toggle-switch input:disabled + .toggle-slider{opacity:0.5;cursor:not-allowed}
    .reminder-option-active{background:rgba(61,220,151,0.05) !important;border:1px solid rgba(61,220,151,0.15) !important;border-radius:12px !important}
    .payment-method-card.selected{border-color:var(--accent) !important;background:rgba(61,220,151,0.08) !important}
    .payment-method-card.disabled{opacity:0.4;cursor:not-allowed !important;pointer-events:none}

    /* Custom Phone Input Widget */
    .phone-input-wrapper{position:relative}
    .phone-input-row{display:flex;gap:8px;align-items:stretch}

    /* Country button */
    .phone-country-button{
      display:flex;align-items:center;gap:8px;
      padding:0 12px;
      background:#10151d;
      border:1px solid rgba(255,255,255,0.12);
      border-radius:10px;
      color:var(--text);
      font-size:15px;
      cursor:pointer;
      transition:all 0.2s;
      white-space:nowrap;
      min-width:180px;
    }
    .phone-country-button:hover,
    .phone-country-button:focus{
      border-color:rgba(61,220,151,0.4);
      outline:none;
    }
    .phone-country-flag{font-size:18px}
    .phone-country-name{flex:1}
    .phone-caret{font-size:10px;color:var(--muted)}

    /* Prefix display */
    .phone-prefix{
      display:flex;align-items:center;
      padding:0 12px;
      background:#10151d;
      border:1px solid rgba(255,255,255,0.12);
      border-radius:10px;
      color:var(--muted);
      font-size:15px;
      min-width:60px;
      justify-content:center;
    }

    /* Local number input */
    .phone-number-input{
      flex:1;
      padding:12px;
      background:#10151d;
      border:1px solid rgba(255,255,255,0.12);
      border-radius:10px;
      color:var(--text);
      font-size:15px;
      font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif;
    }
    .phone-number-input:focus{
      outline:none;
      border-color:rgba(61,220,151,0.4);
      background:#10151d;
    }
    .phone-number-input:hover{background:#10151d}
    .phone-number-input:-webkit-autofill,
    .phone-number-input:-webkit-autofill:hover,
    .phone-number-input:-webkit-autofill:focus,
    .phone-number-input:-webkit-autofill:active{
      -webkit-background-clip:text;
      -webkit-text-fill-color:var(--text);
      transition:background-color 5000s ease-in-out 0s;
      box-shadow:inset 0 0 20px 20px #10151d;
    }
    .phone-number-input.phone-input-invalid{
      border-color:#ff6b6b;
    }

    /* Hidden full number field */
    .phone-number-full{display:none}

    /* Dropdown */
    .phone-dropdown{
      display:none;
      position:absolute;
      top:100%;
      left:0;
      right:0;
      margin-top:4px;
      background:#151a21;
      border:1px solid rgba(255,255,255,0.15);
      border-radius:10px;
      box-shadow:0 4px 16px rgba(0,0,0,0.4);
      z-index:1000;
      max-height:320px;
      overflow:hidden;
    }

    /* Dropdown search */
    .phone-dropdown-search{
      width:calc(100% - 24px);
      margin:12px;
      padding:10px 12px;
      background:#10151d;
      border:1px solid rgba(255,255,255,0.12);
      border-radius:8px;
      color:var(--text);
      font-size:15px;
      font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif;
    }
    .phone-dropdown-search:focus{
      outline:none;
      border-color:rgba(61,220,151,0.4);
      background:#10151d;
    }
    .phone-dropdown-search:hover{background:#10151d}
    .phone-dropdown-search:-webkit-autofill,
    .phone-dropdown-search:-webkit-autofill:hover,
    .phone-dropdown-search:-webkit-autofill:focus,
    .phone-dropdown-search:-webkit-autofill:active{
      -webkit-background-clip:text;
      -webkit-text-fill-color:var(--text);
      transition:background-color 5000s ease-in-out 0s;
      box-shadow:inset 0 0 20px 20px #10151d;
    }
    .phone-dropdown-search::placeholder{
      color:var(--muted);
    }

    /* Country list */
    .phone-country-list{
      max-height:220px;
      overflow-y:auto;
      padding:4px 0;
    }
    .phone-country-list::-webkit-scrollbar{width:6px}
    .phone-country-list::-webkit-scrollbar-thumb{background-color:#333;border-radius:4px}

    /* Country item */
    .phone-country-item{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 16px;
      cursor:pointer;
      transition:all 0.15s;
      border-left:3px solid transparent;
    }
    .phone-country-item:hover{
      background:rgba(61,220,151,0.08);
      border-left-color:var(--accent);
    }
    .phone-country-item .phone-country-flag{font-size:18px}
    .phone-country-item .phone-country-name{flex:1;color:var(--text);font-size:14px}
    .phone-country-item .phone-country-dial{color:var(--muted);font-size:14px}

    /* Phone error message */
    .phone-error{color:#ff6b6b;font-size:13px;margin-top:4px;display:none}

    /* Summary grid layout for Step 4 - COMPACT STYLING TO MATCH STEP 2 */
    .summary-grid{
      display:flex;
      flex-direction:column;
      gap:0;
    }
    .summary-grid-row{
      display:grid;
      grid-template-columns:1fr 2fr;
      gap:12px;
      padding:10px 0;
      align-items:center;
    }
    .summary-grid-row:not(:last-child){
      border-bottom:1px solid rgba(255,255,255,0.05);
    }
    .summary-grid-row.items-start{
      align-items:start;
    }
    .summary-grid-label{
      font-size:14px;
      font-weight:500;
      color:#9ca3af;
      line-height:1.4;
    }
    .summary-grid-value{
      font-size:14px;
      font-weight:500;
      color:#e5e7eb;
      line-height:1.4;
      width:100%;
    }
    @media (max-width: 768px) {
      .summary-grid-row{
        grid-template-columns:1fr;
        gap:4px;
        padding:12px 0;
      }
    }

    /* Step 4 specific styles - match Step 2 layout */
    #wizard-step-4 {
      max-width: 1200px;
      margin: 0 auto;
    }
    #wizard-step-4 h4 {
      font-size: 16px;
      font-weight: 600;
      margin: 0 0 12px 0;
      color: var(--text);
    }
    /* Step 4 toggle buttons should be full-width, but not footer buttons */
    #wizard-step-4 .secondary {
      padding: 12px 16px;
    }
    #wizard-step-4 .secondary:not(.wizard-footer .secondary) {
      margin: 0;
      width: 100%;
    }
    #wizard-step-4 > div[style*="margin:16px 0"] {
      margin: 16px 0 !important;
    }

    /* Loan Calculator Styles - used in Step 2 */
    .loan-calculator .main-grid {
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }

    @media (max-width: 1024px) {
      .loan-calculator .main-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Align wizard footer with calculator grid on Step 2 */
    #wizard-step-2 .wizard-footer {
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 24px;
      align-items: center;
    }

    #wizard-step-2 .wizard-footer .wizard-back {
      order: 0;
      justify-self: start;
    }

    #wizard-step-2 .wizard-footer .wizard-next {
      order: 0;
      justify-self: end;
      margin-left: 0;
    }

    @media (max-width: 1024px) {
      #wizard-step-2 .wizard-footer {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      #wizard-step-2 .wizard-footer .wizard-back,
      #wizard-step-2 .wizard-footer .wizard-next {
        justify-self: stretch;
      }
    }

    /* Flatten schedule card layout for Step 2 - remove inner box */
    #wizard-step-2 .schedule-table {
      border: none;
      border-radius: 0;
      background: transparent;
      padding: 0;
      margin: 0;
    }

    .loan-calculator .form-group {
      margin-bottom: 20px;
    }

    .loan-calculator .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 8px;
      color: #d1d5db;
    }

    .loan-calculator .form-group input,
    .loan-calculator .form-group select {
      width: 100%;
      background: rgba(12, 16, 21, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 10px 12px;
      color: #e5e7eb;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    .loan-calculator .form-group select {
      padding-right: 36px;
      background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%23e5e7eb' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      cursor: pointer;
    }

    .loan-calculator .form-group input:focus,
    .loan-calculator .form-group select:focus {
      outline: none;
      border-color: rgba(59, 130, 246, 0.5);
    }

    .loan-calculator .form-group input[type="number"] {
      font-variant-numeric: tabular-nums;
    }

    .loan-calculator .loan-amount-empty {
      border-color: #34d399 !important;
      box-shadow: 0 0 0 1px #34d399;
    }

    .loan-calculator .loan-amount-note {
      font-size: 12px;
      margin-top: 6px;
      font-style: normal;
      color: #34d399;
    }

    .loan-calculator .form-hint {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 6px;
      font-style: italic;
    }

    .loan-calculator .schedule-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .loan-calculator .schedule-header h2 {
      margin: 0;
    }

    .loan-calculator .config-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .loan-calculator .config-header h2 {
      margin: 0;
    }

    .loan-calculator .loan-meta {
      margin-bottom: 16px;
    }

    .loan-calculator .loan-meta-primary {
      font-size: 15px;
      font-weight: 500;
      color: #e5e7eb;
    }

    .loan-calculator .loan-meta-secondary {
      margin-top: 4px;
      font-size: 14px;
      font-weight: 500;
      color: #34d399;
    }

    .loan-calculator .schedule-table {
      overflow-x: auto;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      background: rgba(12, 16, 21, 0.8);
    }

    .loan-calculator table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .loan-calculator thead th {
      background: rgba(31, 41, 55, 0.98);
      padding: 12px;
      text-align: left;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      color: #9ca3af;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .loan-calculator thead th.align-right {
      text-align: right;
    }

    /* Column widths for repayment schedule table */
    .loan-calculator .col-index {
      width: 40px;
      min-width: 40px;
    }

    .loan-calculator .col-due-date {
      width: 180px;
      min-width: 180px;
    }

    .loan-calculator .col-principal {
      width: 110px;
      min-width: 110px;
    }

    .loan-calculator .col-interest {
      width: 110px;
      min-width: 110px;
    }

    .loan-calculator .col-total-payment {
      width: 130px;
      min-width: 130px;
    }

    .loan-calculator .col-balance {
      width: 110px;
      min-width: 110px;
    }

    .loan-calculator tbody td {
      padding: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      color: #d1d5db;
    }

    .loan-calculator tbody td.align-right {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .loan-calculator tbody tr:nth-child(even) {
      background: rgba(10, 13, 17, 0.6);
    }

    .loan-calculator tbody tr:hover {
      background: rgba(55, 65, 81, 0.3);
    }

    .loan-calculator tfoot td {
      padding: 14px 12px;
      border-top: 1px solid rgba(16, 185, 129, 0.6);
      font-weight: 700;
      color: #34d399;
      font-size: 14px;
    }

    .loan-calculator tfoot td.align-right {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .loan-calculator tfoot td:first-child {
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .loan-calculator .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .loan-calculator .badge-preview {
      background: rgba(59, 130, 246, 0.2);
      color: #60a5fa;
    }

    .loan-calculator .badge-actual {
      background: rgba(16, 185, 129, 0.2);
      color: #34d399;
    }
  </style>
</head>
<body>
  <main class="container">
    <!-- Header will be loaded dynamically by header.js -->

    <!-- Activity section (initially hidden) -->
    <section class="card" id="activity-section" style="display:none">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
        <h2 style="margin:0">Activity</h2>
        <button id="mark-all-read-btn" onclick="markAllAsRead()" style="padding:6px 12px; font-size:13px">Mark all as read</button>
      </div>
      <p id="activity-timezone-note" style="font-size:13px; color:var(--muted); margin:0 0 16px 0">
        Times in this history are shown in your local timezone.
      </p>
      <div class="messages-list" id="activity-list">
        <p class="empty-state">No activity yet</p>
      </div>
    </section>

    <section class="card" id="list-section">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
        <h2 style="margin:0">My Agreements</h2>
      </div>

      <div class="tabs">
        <div class="tab active" data-filter="all" onclick="filterByStatus('all')">All</div>
        <div class="tab" data-filter="pending" onclick="filterByStatus('pending')">Pending</div>
        <div class="tab" data-filter="active" onclick="filterByStatus('active')">Active</div>
        <div class="tab" data-filter="settled" onclick="filterByStatus('settled')">Settled</div>
      </div>

      <table id="list">
        <thead>
          <tr>
            <th id="counterparty-header">Borrower</th>
            <th>Description</th>
            <th>Outstanding / Total</th>
            <th id="due-header">Next repayment due</th>
            <th>Status</th>
            <th><span class="actions-header-text">Actions</span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="empty-state" class="empty-state" style="display:none">
        No agreements found for this filter.
      </div>
      <div style="display:flex; justify-content:flex-end; margin-top:16px">
        <button id="new-agreement-btn" onclick="toggleNewAgreement()" style="display:flex; align-items:center; gap:8px; padding:12px 20px">
          <span style="font-size:18px; font-weight:bold">+</span>
          <span>New Agreement</span>
        </button>
      </div>
    </section>

    <!-- Welcome hero for first-time users with no agreements -->
    <section class="dashboard-hero" id="welcome-card" style="display:none">
      <div class="dashboard-hero-inner">
        <div class="dashboard-hero-text">
          <h1 class="dashboard-hero__title" id="welcome-heading">Welcome</h1>

          <p class="dashboard-hero__lead">
            PayFriends keeps money and friendships in balance. Create simple agreements with friends, let us handle the reminders, and always know exactly where you stand.
          </p>

          <p class="dashboard-hero__text">
            Start by creating your first agreement. You can lend money to a friend or set up a plan to repay someone else. We will take care of the plan, the schedule and the follow up.
          </p>

          <p class="dashboard-hero__features-link">
            <a href="/features" class="link-accent">
              See all features and how we work our magic
            </a>
          </p>

          <div class="dashboard-hero__actions">
            <button id="new-agreement-from-welcome" onclick="startNewAgreementFromWelcome()" class="primary-button">
              + New Agreement
            </button>
            <button onclick="closeNewAgreement()" class="secondary">
              View my agreements
            </button>
          </div>
        </div>

        <div class="dashboard-hero-mascot">
          <img src="/images/mascot.png" alt="PayFriends mascot" />
        </div>
      </div>
    </section>

    <!-- Wizard for creating agreements -->
    <div id="new-agreement-section" class="hidden">
      <!-- Header: title + back link on same row -->
      <div class="new-agreement-header">
        <h1 class="new-agreement-title">New Agreement</h1>
        <a onclick="closeNewAgreement()" class="back-to-agreements-link">&lt; Back to My agreements</a>
      </div>

      <!-- Wizard step navigation -->
      <nav class="wizard-steps" role="navigation" aria-label="Agreement wizard steps">
        <div class="wizard-step" id="step-indicator-1" onclick="clickStep(1)" aria-label="Step 1, Basics">1. Basics</div>
        <div class="wizard-step" id="step-indicator-2" onclick="clickStep(2)" aria-label="Step 2, Terms">2. Terms</div>
        <div class="wizard-step" id="step-indicator-3" onclick="clickStep(3)" aria-label="Step 3, Payments">3. Payments</div>
        <div class="wizard-step" id="step-indicator-4" onclick="clickStep(4)" aria-label="Step 4, Summary">4. Summary</div>
        <div class="wizard-step" id="step-indicator-5" onclick="clickStep(5)" aria-label="Step 5, Share">5. Share</div>
      </nav>

      <!-- Wizard steps container -->
      <div class="wizard-steps-container">
        <!-- Step 1: Setup -->
      <div id="wizard-step-1" class="wizard-content">
        <div id="readonly-banner-1" class="hidden" style="background:rgba(250,204,21,0.1); border:1px solid rgba(250,204,21,0.3); border-radius:8px; padding:12px; margin-bottom:20px; font-size:14px; color:var(--text)">
          ⚠️ This agreement has already been sent to <span id="readonly-name-1"></span> and can't be edited. To change details, cancel it from your dashboard and create a new one.
        </div>
        <h3 style="margin-top:0">Let's set up your agreement.</h3>
        <p style="color:var(--muted); font-size:14px; margin:-6px 0 20px 0">Start by choosing what you want to do.</p>

        <!-- Role selector cards -->
        <div style="margin:16px 0 24px 0">
          <label style="display:flex; align-items:center; gap:12px; cursor:pointer; padding:16px; border-radius:10px; border:2px solid rgba(255,255,255,0.08); margin-bottom:12px; transition:all 0.2s" onclick="selectRoleCard('lend')" id="role-card-lend">
            <input type="radio" name="role" value="lend" onchange="toggleBorrowerFields()" style="width:20px; height:20px" />
            <div style="flex:1">
              <div style="font-weight:600; font-size:15px">I want to lend money</div>
            </div>
          </label>
          <label style="display:flex; align-items:center; gap:12px; padding:16px; border-radius:10px; border:2px solid rgba(255,255,255,0.08); opacity:0.4; cursor:not-allowed">
            <input type="radio" name="role" value="borrow" disabled style="width:20px; height:20px" />
            <div style="flex:1">
              <div style="font-weight:600; font-size:15px">Borrow coming soon</div>
              <div style="color:var(--muted); font-size:13px">(greyed out)</div>
            </div>
          </label>
        </div>

        <div id="borrower-fields" class="hidden" style="transition:all 0.3s ease">
          <div class="row">
            <label>Borrower name</label>
            <input id="friend-first-name" placeholder="Alex" required oninput="autoCapitalizeName()" />
          </div>
          <p style="color:var(--muted); font-size:12px; margin:-6px 0 12px 172px">Full name or first name.</p>

          <div class="row">
            <label>Borrower email</label>
            <input id="friend-email" type="email" placeholder="alex@example.com" required />
          </div>
          <p style="color:var(--muted); font-size:12px; margin:-6px 0 12px 172px">To this email address we will send the link to review the agreement.</p>

          <div class="row">
            <label>Borrower phone</label>
            <div class="phone-input-wrapper" data-phone-id="agreement-phone">
              <div class="phone-input-row">
                <button type="button" class="phone-country-button"></button>
                <span class="phone-prefix"></span>
                <input type="tel" class="phone-number-input" placeholder="612345678" />
                <input type="hidden" id="agreement-phone" name="agreement-phone" class="phone-number-full" />
              </div>
              <div class="phone-dropdown">
                <input type="text" class="phone-dropdown-search" placeholder="Search country or code…" />
                <div class="phone-country-list"></div>
              </div>
            </div>
            <div id="agreement-phone-error" class="phone-error">Please enter a valid phone number.</div>
          </div>
          <p style="color:rgba(255,255,255,0.5); font-size:13px; margin:-6px 0 12px 172px">Borrower's phone number is required to send reminders.</p>

          <div class="row">
            <label>Loan description</label>
            <input id="description" type="text" placeholder="e.g. Money for rent, Car repair, Holiday loan" required maxlength="30" oninput="autoCapitalizeDescription()" />
          </div>
          <p style="color:var(--muted); font-size:12px; margin:-6px 0 12px 172px">A short note to identify this agreement.</p>
        </div>

        <!-- Wizard navigation footer -->
        <div class="wizard-footer">
          <button class="wizard-next" onclick="goToTerms()">Continue to Terms</button>
        </div>
        <p id="step1-status" class="status"></p>
      </div>

      <!-- Step 2: Loan Calculator -->
      <div id="wizard-step-2" class="wizard-content hidden">
        <div id="readonly-banner-2" class="hidden" style="background:rgba(250,204,21,0.1); border:1px solid rgba(250,204,21,0.3); border-radius:8px; padding:12px; margin-bottom:20px; font-size:14px; color:var(--text)">
          ⚠️ This agreement has already been sent to <span id="readonly-name-2"></span> and can't be edited. To change details, cancel it from your dashboard and create a new one.
        </div>
        <h3 style="margin-top:0">Configure loan terms and repayment schedule.</h3>

        <!-- Calculator will be loaded here -->
        <div id="wizard-calculator-container"></div>

        <!-- Wizard navigation footer -->
        <div class="wizard-footer">
          <button class="secondary wizard-back" onclick="goToStep(1)">Back</button>
          <button class="wizard-next" onclick="saveCalculatorAndContinue()">Continue to Payments</button>
        </div>
        <p id="step2-status" class="status"></p>
      </div>

      <!-- Step 3: Payments & Reminders -->
      <div id="wizard-step-3" class="wizard-content hidden">
        <div id="readonly-banner-3" class="hidden" style="background:rgba(250,204,21,0.1); border:1px solid rgba(250,204,21,0.3); border-radius:8px; padding:12px; margin-bottom:20px; font-size:14px; color:var(--text)">
          ⚠️ This agreement has already been sent to <span id="readonly-name-3"></span> and can't be edited. To change details, cancel it from your dashboard and create a new one.
        </div>
        <h3 style="margin-top:0">Decide how repayments will be made and managed.</h3>

        <!-- Payment methods -->
        <div style="margin:24px 0">
          <h4 style="margin:0 0 12px 0; font-size:16px">Payment methods</h4>
          <p style="color:var(--muted); font-size:13px; margin-bottom:12px">Select all that apply:</p>

          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px">
            <label class="payment-method-card" data-value="bank" style="display:flex; align-items:center; cursor:pointer; padding:14px 16px; border-radius:12px; border:2px solid rgba(255,255,255,0.15); background:rgba(255,255,255,0.02); transition:all 0.2s">
              <input type="checkbox" class="payment-method-checkbox" value="bank" style="display:none" />
              <span style="font-size:14px; font-weight:500">Bank transfer</span>
            </label>
            <label class="payment-method-card" data-value="paypal" style="display:flex; align-items:center; cursor:pointer; padding:14px 16px; border-radius:12px; border:2px solid rgba(255,255,255,0.15); background:rgba(255,255,255,0.02); transition:all 0.2s">
              <input type="checkbox" class="payment-method-checkbox" value="paypal" style="display:none" />
              <span style="font-size:14px; font-weight:500">PayPal</span>
            </label>
            <label class="payment-method-card" data-value="crypto" style="display:flex; align-items:center; cursor:pointer; padding:14px 16px; border-radius:12px; border:2px solid rgba(255,255,255,0.15); background:rgba(255,255,255,0.02); transition:all 0.2s">
              <input type="checkbox" class="payment-method-checkbox" value="crypto" style="display:none" />
              <span style="font-size:14px; font-weight:500">Crypto</span>
            </label>
            <label class="payment-method-card" data-value="cash" style="display:flex; align-items:center; cursor:pointer; padding:14px 16px; border-radius:12px; border:2px solid rgba(255,255,255,0.15); background:rgba(255,255,255,0.02); transition:all 0.2s">
              <input type="checkbox" class="payment-method-checkbox" value="cash" style="display:none" />
              <span style="font-size:14px; font-weight:500">Cash</span>
            </label>
            <label class="payment-method-card" data-value="other" style="display:flex; align-items:center; cursor:pointer; padding:14px 16px; border-radius:12px; border:2px solid rgba(255,255,255,0.15); background:rgba(255,255,255,0.02); transition:all 0.2s">
              <input type="checkbox" class="payment-method-checkbox" value="other" style="display:none" />
              <span style="font-size:14px; font-weight:500">Other</span>
            </label>
          </div>

          <!-- Payment method detail fields (shown below the grid when selected) -->
          <div id="payment-method-details" style="margin-top:16px">
            <!-- Bank transfer details -->
            <div id="bank-details" class="payment-detail-section hidden" style="margin:16px 0; padding:16px; background:rgba(255,255,255,0.03); border-radius:8px; border:1px solid rgba(255,255,255,0.08)">
              <label style="display:block; margin-bottom:8px; font-weight:500; font-size:14px">Bank transfer instructions *</label>
              <textarea id="bank-instructions" placeholder="Enter all information needed to receive a bank transfer, including the account holder name.&#10;&#10;Examples: IBAN, account number, routing number, sort code, BSB, SWIFT, or any regional format." style="width:100%; min-height:120px; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text); font-family:inherit; resize:vertical"></textarea>
              <p style="color:var(--muted); font-size:12px; margin:6px 0 0 0">Enter all information needed to receive a bank transfer, including the account holder name. Examples: IBAN, account number, routing number, sort code, BSB, SWIFT, or any regional format.</p>
            </div>

            <!-- PayPal details -->
            <div id="paypal-details" class="payment-detail-section hidden" style="margin:16px 0; padding:16px; background:rgba(255,255,255,0.03); border-radius:8px; border:1px solid rgba(255,255,255,0.08)">
              <label style="display:block; margin-bottom:8px; font-weight:500; font-size:14px">PayPal email *</label>
              <input id="paypal-email" type="email" placeholder="your.email@example.com" style="width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text)" />
            </div>

            <!-- Crypto details -->
            <div id="crypto-details" class="payment-detail-section hidden" style="margin:16px 0; padding:16px; background:rgba(255,255,255,0.03); border-radius:8px; border:1px solid rgba(255,255,255,0.08)">
              <label style="display:block; margin-bottom:8px; font-weight:500; font-size:14px">Crypto payment instructions *</label>
              <textarea id="crypto-instructions" placeholder="Include wallet address and the network.&#10;&#10;Example: 0xABC123… (ETH on ERC-20)" style="width:100%; min-height:100px; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text); font-family:inherit; resize:vertical"></textarea>
              <p style="color:var(--muted); font-size:12px; margin:6px 0 0 0">Include wallet address and the network. Example: 0xABC123… (ETH on ERC-20).</p>
            </div>

            <!-- Cash - no fields needed -->

            <!-- Other method details -->
            <div id="other-details" class="payment-detail-section hidden" style="margin:16px 0; padding:16px; background:rgba(255,255,255,0.03); border-radius:8px; border:1px solid rgba(255,255,255,0.08)">
              <label style="display:block; margin-bottom:8px; font-weight:500; font-size:14px">Description *</label>
              <input id="other-payment-description" type="text" placeholder="Describe the other payment method" style="width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text)" />
            </div>
          </div>
        </div>

        <!-- Require proof of repayment -->
        <div style="margin:24px 0 48px 0">
          <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px">
            <label class="toggle-switch">
              <input type="checkbox" id="proof-required" checked />
              <span class="toggle-slider"></span>
            </label>
            <h4 style="margin:0; font-size:16px">Require proof of repayment</h4>
          </div>
          <p style="color:var(--muted); font-size:13px; margin:0; line-height:1.5">The borrower will be asked to upload proof for each repayment, such as a photo, screenshot or PDF of the transfer or receipt.</p>
        </div>

        <!-- Reminders -->
        <div style="margin:24px 0">
          <h4 style="margin:0 0 8px 0; font-size:16px">Reminders</h4>
          <p style="color:var(--muted); font-size:13px; margin-bottom:12px">We only send reminders if no payment has been reported for that installment.</p>

          <label style="display:flex; align-items:flex-start; gap:12px; cursor:pointer; padding:16px; border-radius:10px; border:2px solid rgba(255,255,255,0.08); margin-bottom:12px; transition:all 0.2s" id="reminder-auto-card">
            <input type="radio" name="reminder-mode" value="auto" onchange="toggleReminderMode()" checked style="margin-top:2px" />
            <div style="flex:1">
              <div style="font-weight:600; margin-bottom:6px">Auto (recommended)</div>
              <div style="color:var(--muted); font-size:13px; line-height:1.5">We'll remind the borrower 7 days before, 1 day before and on the due date. If no payment is reported, we'll send follow-up reminders 1 day after, then every 3 days.</div>
            </div>
          </label>
          <label style="display:flex; align-items:flex-start; gap:12px; cursor:pointer; padding:16px; border-radius:10px; border:2px solid rgba(255,255,255,0.08); transition:all 0.2s" id="reminder-custom-card">
            <input type="radio" name="reminder-mode" value="custom" onchange="toggleReminderMode()" style="margin-top:2px" />
            <div style="flex:1">
              <div style="font-weight:600; margin-bottom:6px">Custom schedule</div>
              <div id="custom-reminders" class="hidden" style="margin-top:12px">
                <div style="color:var(--muted); font-size:13px; margin-bottom:10px">Select when to send reminders:</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px">
                  <label style="display:flex; align-items:center; gap:6px; font-size:13px">
                    <input type="checkbox" value="-14" class="custom-reminder-checkbox" /> 14 days before
                  </label>
                  <label style="display:flex; align-items:center; gap:6px; font-size:13px">
                    <input type="checkbox" value="-7" class="custom-reminder-checkbox" /> 7 days before
                  </label>
                  <label style="display:flex; align-items:center; gap:6px; font-size:13px">
                    <input type="checkbox" value="-3" class="custom-reminder-checkbox" /> 3 days before
                  </label>
                  <label style="display:flex; align-items:center; gap:6px; font-size:13px">
                    <input type="checkbox" value="-1" class="custom-reminder-checkbox" /> 1 day before
                  </label>
                  <label style="display:flex; align-items:center; gap:6px; font-size:13px">
                    <input type="checkbox" value="0" class="custom-reminder-checkbox" /> On the due date
                  </label>
                  <label style="display:flex; align-items:center; gap:6px; font-size:13px">
                    <input type="checkbox" value="1" class="custom-reminder-checkbox" /> 1 day after
                  </label>
                  <label style="display:flex; align-items:center; gap:6px; font-size:13px">
                    <input type="checkbox" value="3" class="custom-reminder-checkbox" /> Every 3 days after
                  </label>
                  <label style="display:flex; align-items:center; gap:6px; font-size:13px">
                    <input type="checkbox" value="7" class="custom-reminder-checkbox" /> Every 7 days after
                  </label>
                </div>
                <p id="custom-reminder-error" style="color:#ff6b6b; font-size:12px; margin-top:8px; display:none">Please select at least one reminder</p>
              </div>
            </div>
          </label>
        </div>

        <!-- Worst-case scenario (only shown for loans >= 6000 EUR) -->
        <div id="worst-case-scenario-container" style="margin:48px 0 24px 0">
          <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px">
            <label class="toggle-switch">
              <input type="checkbox" id="debt-collection-clause" checked />
              <span class="toggle-slider"></span>
            </label>
            <h4 style="margin:0; font-size:16px">Worst case scenario</h4>
          </div>
          <p style="color:var(--muted); font-size:13px; margin:0; line-height:1.5">If the borrower does not repay in time and ignores reminders or cannot agree a new plan with the lender, PayFriends will hand the case to an independent debt collector. Once this happens, the lender is no longer involved in collection — the third party handles it, and any collection fees are for the borrower's account.</p>
        </div>

        <!-- Wizard navigation footer -->
        <div class="wizard-footer">
          <button class="secondary wizard-back" onclick="goToStep(2)">Back</button>
          <button class="wizard-next" onclick="goToSummary()">Continue to Summary</button>
        </div>
        <p id="step3-status" class="status"></p>
      </div>

      <!-- Step 4: Summary -->
      <div id="wizard-step-4" class="wizard-content hidden">
        <div id="readonly-banner-4" class="hidden" style="background:rgba(250,204,21,0.1); border:1px solid rgba(250,204,21,0.3); border-radius:8px; padding:12px; margin-bottom:20px; font-size:14px; color:var(--text)">
          ⚠️ This agreement has already been sent to <span id="readonly-name-4"></span> and can't be edited. To change details, cancel it from your dashboard and create a new one.
        </div>
        <h3 style="margin-top:0">Review and send your agreement.</h3>

        <!-- Summary text at top -->
        <div style="background:rgba(61,220,151,0.05); border:1px solid rgba(61,220,151,0.15); border-radius:12px; padding:20px; margin:20px 0">
          <p id="full-summary-text" style="margin:0; color:var(--accent); font-size:15px; line-height:1.8; white-space:pre-line"></p>
        </div>

        <!-- General details table -->
        <div style="margin:16px 0">
          <h4 style="margin:0 0 12px 0; font-size:16px">Agreement Details</h4>
          <div style="background:#10151d; border:1px solid rgba(255,255,255,0.08); border-radius:8px; padding:16px">
            <div id="general-details-content"></div>

            <!-- Fairness Between Friends footer -->
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255, 255, 255, 0.08); font-size: 13px; color: #9ca3af;">
              <p style="margin-bottom: 8px;">
                Amounts marked with <span class="pf-fairness-icon-inline" title="Fairness Between Friends" style="display: inline-flex; align-items: center; vertical-align: middle; margin: 0 2px;"></span> are calculated using the Fairness Between Friends rules.
                <a href="#" id="step4FairnessToggle" style="color: #34d399; text-decoration: none; border-bottom: 1px solid transparent; transition: border-color 0.2s;" onmouseover="this.style.borderBottomColor='#34d399'" onmouseout="this.style.borderBottomColor='transparent'">How it works</a>
              </p>
              <div id="step4FairnessExplanation" style="display: none; margin-top: 12px; padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 6px; font-size: 12px; line-height: 1.6; color: #d1d5db;">
                Fairness Between Friends adjusts interest dynamically based on the outstanding balance and the time that has passed. This means paying earlier or more reduces total interest, while paying later or less increases it. Both sides always see the current, fair value of the loan in real time.
              </div>
            </div>
          </div>
        </div>

        <!-- Expandable: Repayment schedule & interest calculation -->
        <div style="margin:16px 0">
          <button onclick="toggleSection('interest-calc-section')" class="secondary" style="width:100%; text-align:left; padding:12px 16px; font-size:14px; display:flex; justify-content:space-between; align-items:center">
            <span>Repayment schedule & interest calculation</span>
            <span id="interest-calc-toggle">▼</span>
          </button>
          <div id="interest-calc-section" class="hidden" style="background:#10151d; border:1px solid rgba(255,255,255,0.08); border-radius:0 0 8px 8px; padding:16px; margin-top:-1px">
            <div id="interest-calc-content"></div>
          </div>
        </div>

        <!-- Expandable: Repayment details & reminders -->
        <div style="margin:16px 0">
          <button onclick="toggleSection('payments-reminders-section')" class="secondary" style="width:100%; text-align:left; padding:12px 16px; font-size:14px; display:flex; justify-content:space-between; align-items:center">
            <span>Repayment details & reminders</span>
            <span id="payments-reminders-toggle">▼</span>
          </button>
          <div id="payments-reminders-section" class="hidden" style="background:#10151d; border:1px solid rgba(255,255,255,0.08); border-radius:0 0 8px 8px; padding:16px; margin-top:-1px">
            <div id="payments-reminders-content"></div>
          </div>
        </div>

        <!-- Status message for Step 4 -->
        <p id="step4-status" class="status-message" style="color:var(--text); margin:16px 0; font-size:14px"></p>

        <!-- Wizard navigation footer - before sending -->
        <div id="invite-not-sent" class="wizard-footer">
          <button class="secondary wizard-back" onclick="goToStep(3)">Back to edit</button>
          <button class="wizard-next" onclick="sendInvite()">Share to <span id="send-friend-name"></span> for review</button>
        </div>

        <!-- After sending state -->
        <div id="invite-sent" class="hidden">
          <div style="background:rgba(61,220,151,0.1); border:1px solid rgba(61,220,151,0.2); border-radius:12px; padding:16px; margin:24px 0">
            <p style="margin:0; color:var(--accent); font-weight:600; font-size:16px">✓ Invite sent!</p>
          </div>
          <p style="color:var(--muted); font-size:14px">Share this invite link with your friend:</p>
          <div class="invite-url-box" id="invite-url"></div>

          <!-- Wizard navigation footer - after sending -->
          <div class="wizard-footer">
            <button class="wizard-next" onclick="copyInviteUrl()">Copy invite link</button>
            <button class="secondary" onclick="resetWizard()">Create another agreement</button>
          </div>
        </div>

        <p id="step3-status" class="status"></p>
      </div>

      <!-- Step 5: Share -->
      <div id="wizard-step-5" class="wizard-content hidden">
        <h3 style="margin-top:0">Sharing options</h3>

        <!-- Success header -->
        <div style="background:rgba(61,220,151,0.1); border:1px solid rgba(61,220,151,0.25); border-radius:12px; padding:20px; margin:20px 0">
          <div style="font-size:18px; font-weight:700; color:var(--accent); margin-bottom:8px">Agreement sent by email</div>
          <div style="font-size:14px; color:var(--text)">We've emailed this agreement to <span id="share-invite-name"></span> at <span id="share-invite-email"></span>. You can also share the link or QR code below.</div>
        </div>

        <!-- Share link section -->
        <div style="margin:24px 0">
          <h4 style="margin:0 0 12px 0; font-size:16px">Share the invite link</h4>
          <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px">
            <input id="share-link-input" type="text" readonly style="flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text); font-family:monospace; font-size:13px" />
            <button onclick="copyShareLink()" style="width:auto; white-space:nowrap; padding:10px 16px">Copy link</button>
          </div>
          <p style="color:var(--muted); font-size:13px; margin:0">You can paste this link into WhatsApp, Signal, email or anywhere else you like. Please note that <span id="share-signup-name"></span> needs to sign up with <span id="share-signup-email"></span> in order to view the agreement.</p>
        </div>

        <!-- QR code section -->
        <div style="margin:24px 0">
          <h4 style="margin:0 0 12px 0; font-size:16px">Or let <span id="share-qr-name"></span> scan this QR code</h4>
          <div id="qr-code-container"></div>
        </div>

        <!-- Wizard navigation footer -->
        <div class="wizard-footer">
          <button class="secondary" onclick="createAnotherAgreement()">Create another agreement</button>
          <button class="wizard-next" onclick="goToDashboard()">Done, return to dashboard</button>
        </div>

        <p id="step5-status" class="status"></p>
      </div>
      </div>
    </div>

    <!-- Payment Confirmation Modal -->
    <div id="confirm-payment-modal" class="modal-overlay" style="display:none" onclick="closeModalOnOverlay(event, 'confirm-payment-modal')">
      <div class="modal-card" onclick="event.stopPropagation()">
        <div class="modal-header">
          <h2 class="modal-title">Confirm payment</h2>
          <button class="modal-close" onclick="closeConfirmPaymentModal()">&times;</button>
        </div>
        <div class="modal-body" id="confirm-payment-modal-body">
          <p style="text-align:center; color:var(--muted)">Loading...</p>
        </div>
      </div>
    </div>

    <!-- Payment Issue Modal -->
    <div id="difficulty-modal" class="modal-overlay" style="display:none" onclick="closeModalOnOverlay(event, 'difficulty-modal')">
      <div class="modal-card" onclick="event.stopPropagation()">
        <div class="modal-header">
          <h2 class="modal-title">Payment issue</h2>
          <button class="modal-close" onclick="closeDifficultyModal()">&times;</button>
        </div>
        <div class="modal-body" id="difficulty-modal-body">
          <p style="text-align:center; color:var(--muted)">Loading...</p>
        </div>
      </div>
    </div>
  </main>

  <script>
    let allAgreements = [];
    let currentFilter = 'all';
    let currentUser = null;
    let wizardData = {
      role: null,
      friendFirstName: '',
      friendEmail: '',
      description: '',
      amount: '',
      repaymentType: 'one_time',
      dueDate: '',
      oneTimeDueOption: 'in_1_year', // Store the due date option for one-time loans
      moneySentDate: '',
      moneySentOption: 'on-acceptance',
      // Installment fields
      planLength: null,
      planUnit: 'months',
      firstPaymentDate: '',
      installmentCount: null,
      installmentAmount: null,
      finalDueDate: '',
      // Interest fields
      hasInterest: true,
      interestRate: 0,
      totalInterest: 0,
      totalRepayAmount: 0,
      // Payment preferences
      paymentMethods: ['bank'],
      paymentOtherDescription: '',
      reminderMode: 'auto',
      reminderOffsets: [-7, -1, 0, 1, 3],
      proofRequired: true,
      debtCollectionClause: true,
      inviteUrl: '',
      agreementSent: false
    };

    // Worst case scenario is only shown for loans from 6,000 EUR and higher,
    // since debt collectors and legal escalation rarely make sense below this amount.
    const WORST_CASE_MIN_AMOUNT_EUR = 6000;

    // Currency formatters are loaded from /js/formatters.js
    // - formatCurrency0(cents) - for My Agreements table (no decimals, nl-NL locale)
    // - formatCurrency2(cents) - for details and schedules (2 decimals, nl-NL locale)
    // - formatEuro0(euros), formatEuro2(euros) - for euro amounts (not cents)

    // Get initials from a name (e.g., "Alex Smith" -> "AS", "Alex" -> "A")
    function getInitials(name) {
      if (!name || typeof name !== 'string') return '?';
      const parts = name.trim().split(/\s+/);
      if (parts.length === 1) {
        return parts[0].charAt(0).toUpperCase();
      }
      return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
    }

    // Get consistent color class based on name hash
    function getColorClass(name) {
      if (!name) return 'color-1';
      let hash = 0;
      for (let i = 0; i < name.length; i++) {
        hash = name.charCodeAt(i) + ((hash << 5) - hash);
      }
      const colorIndex = (Math.abs(hash) % 7) + 1;
      return `color-${colorIndex}`;
    }

    // Generate avatar HTML (image or initials)
    function generateAvatarHTML(user, size = 'small') {
      const initials = getInitials(user.name || user.counterparty_name || '');
      const colorClass = getColorClass(user.name || user.counterparty_name || '');

      if (user.profile_picture_url) {
        return `<div class="user-avatar size-${size}">
          <img src="${user.profile_picture_url}" class="user-avatar-image" alt="${user.name || ''}" />
        </div>`;
      } else {
        return `<div class="user-avatar size-${size}">
          <div class="user-avatar-initials ${colorClass}">${initials}</div>
        </div>`;
      }
    }

    // Format due date with countdown logic
    function formatDueDate(agreement, isLender) {
      const status = agreement.status || 'pending';

      // For settled agreements
      if (status === 'settled' && agreement.settled_date) {
        const settledDate = new Date(agreement.settled_date);
        const formatted = settledDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        return `<span class="due-date-settled">Settled on ${formatted}</span>`;
      }

      // For pending or cancelled, just show the date
      if (status === 'pending' || status === 'cancelled') {
        return agreement.due_date || '—';
      }

      // For active agreements, calculate next payment due
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      let nextDueDate = null;
      if (agreement.next_payment_date) {
        nextDueDate = new Date(agreement.next_payment_date);
      } else if (agreement.due_date) {
        nextDueDate = new Date(agreement.due_date);
      }

      if (!nextDueDate) {
        return '—';
      }

      nextDueDate.setHours(0, 0, 0, 0);
      const diffTime = nextDueDate - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

      const dateStr = nextDueDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });

      if (diffDays < 0) {
        // Overdue
        const daysOverdue = Math.abs(diffDays);
        return `<span class="due-date-overdue">${dateStr} (${daysOverdue} day${daysOverdue !== 1 ? 's' : ''} overdue)</span>`;
      } else if (diffDays === 0) {
        return `<span class="due-date-overdue">${dateStr} (due today)</span>`;
      } else if (diffDays <= 7) {
        return `<span>${dateStr} (in ${diffDays} day${diffDays !== 1 ? 's' : ''})</span>`;
      } else {
        return dateStr;
      }
    }

    // Format the amount input field on blur
    function formatAmountInput() {
      const input = document.getElementById('amount');
      const value = input.value.trim();
      if (!value) return;

      // Remove any existing formatting (dots, commas)
      const cleanValue = value.replace(/[.,]/g, '');
      const num = parseFloat(cleanValue);

      if (!isNaN(num) && num > 0) {
        // Format with thousand separators (nl-NL style: 6.000)
        input.value = new Intl.NumberFormat('nl-NL').format(num);
      }
    }

    // Remove formatting from amount input on focus for easier editing
    function unformatAmountInput() {
      const input = document.getElementById('amount');
      const value = input.value.trim();
      if (!value) return;

      // Remove thousand separators
      const cleanValue = value.replace(/\./g, '').replace(/,/g, '');
      if (!isNaN(cleanValue) && cleanValue !== '') {
        input.value = cleanValue;
      }
    }

    // Validate amount field and show error if needed
    function validateAmountField() {
      const input = document.getElementById('amount');
      const errorElement = document.getElementById('amount-error');
      const value = input.value.trim();

      if (!value) {
        input.style.border = '1px solid #f87171';
        errorElement.textContent = 'Please enter a loan amount.';
        errorElement.classList.remove('hidden');
        return false;
      }

      const cleanValue = value.replace(/[.,]/g, '');
      const num = parseFloat(cleanValue);

      if (isNaN(num) || num <= 0) {
        input.style.border = '1px solid #f87171';
        errorElement.textContent = 'Please enter a valid loan amount.';
        errorElement.classList.remove('hidden');
        return false;
      }

      // Clear error state
      input.style.border = '';
      errorElement.classList.add('hidden');
      return true;
    }

    // Capitalize first letter of description
    function capitalizeDescription() {
      const input = document.getElementById('description');
      const value = input.value.trim();
      if (value.length > 0) {
        input.value = value.charAt(0).toUpperCase() + value.slice(1);
      }
    }

    // Calculate time ago from a timestamp
    function timeAgo(timestamp) {
      const now = new Date();
      const past = new Date(timestamp);
      const diffMs = now - past;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);
      const diffHour = Math.floor(diffMin / 60);
      const diffDay = Math.floor(diffHour / 24);

      if (diffSec < 60) return 'just now';
      if (diffMin < 60) return `${diffMin} min${diffMin > 1 ? 's' : ''} ago`;
      if (diffHour < 24) return `${diffHour} hour${diffHour > 1 ? 's' : ''} ago`;
      if (diffDay === 1) return '1 day ago';
      if (diffDay < 30) return `${diffDay} days ago`;
      const diffMonth = Math.floor(diffDay / 30);
      if (diffMonth === 1) return '1 month ago';
      if (diffMonth < 12) return `${diffMonth} months ago`;
      const diffYear = Math.floor(diffDay / 365);
      return `${diffYear} year${diffYear > 1 ? 's' : ''} ago`;
    }

    // Wizard functions
    function goToStep(step) {
      // Hide all steps
      for (let i = 1; i <= 5; i++) {
        document.getElementById(`wizard-step-${i}`).classList.add('hidden');
        const indicator = document.getElementById(`step-indicator-${i}`);
        indicator.classList.remove('active');
        indicator.removeAttribute('aria-current');
      }

      // Show current step
      document.getElementById(`wizard-step-${step}`).classList.remove('hidden');
      const activeIndicator = document.getElementById(`step-indicator-${step}`);
      activeIndicator.classList.add('active');
      activeIndicator.setAttribute('aria-current', 'step');

      // Mark previous steps as completed
      for (let i = 1; i < step; i++) {
        document.getElementById(`step-indicator-${i}`).classList.add('completed');
      }

      // Special handling for step 1: ensure borrower fields visibility is correct
      if (step === 1) {
        toggleBorrowerFields();
      }

      // Special handling for step 2: load and initialize calculator
      if (step === 2) {
        initializeWizardCalculator();
      }

      // Special handling for step 3: initialize reminder mode highlight
      if (step === 3) {
        toggleReminderMode();
      }

      // Apply read-only mode if agreement has been sent
      if (wizardData.agreementSent && step <= 4) {
        applyReadOnlyMode(step);
      }
    }

    function applyReadOnlyMode(step) {
      // Show banner with borrower name
      const banner = document.getElementById(`readonly-banner-${step}`);
      const nameSpan = document.getElementById(`readonly-name-${step}`);
      if (banner && nameSpan) {
        nameSpan.textContent = wizardData.friendFirstName;
        banner.classList.remove('hidden');
      }

      // Disable all inputs in the step
      const stepDiv = document.getElementById(`wizard-step-${step}`);
      if (stepDiv) {
        const inputs = stepDiv.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
          input.disabled = true;
          input.style.opacity = '0.6';
          input.style.cursor = 'not-allowed';
        });

        // Disable all buttons except "Back" or navigation buttons
        const buttons = stepDiv.querySelectorAll('button');
        buttons.forEach(button => {
          if (!button.classList.contains('secondary') && !button.textContent.includes('Back')) {
            button.disabled = true;
            button.style.opacity = '0.5';
            button.style.cursor = 'not-allowed';
          }
        });
      }

      // Special handling for Step 5: replace send button with "View Share options"
      if (step === 5) {
        const inviteNotSent = document.getElementById('invite-not-sent');
        const inviteSent = document.getElementById('invite-sent');
        if (inviteNotSent && inviteSent) {
          inviteNotSent.classList.add('hidden');
          inviteSent.classList.add('hidden');
        }

        // Add a button to navigate to Step 5 (Share) if it doesn't exist
        const step4Div = document.getElementById('wizard-step-4');
        let viewShareBtn = document.getElementById('view-share-btn');
        if (!viewShareBtn && step4Div) {
          viewShareBtn = document.createElement('div');
          viewShareBtn.id = 'view-share-btn';
          viewShareBtn.style.marginTop = '32px';
          viewShareBtn.innerHTML = '<button onclick="goToStep(5)">View Share options</button>';
          step4Div.appendChild(viewShareBtn);
        }
      }
    }

    // Handle step click with validation
    function clickStep(targetStep) {
      // Determine current step
      let currentStep = 1;
      for (let i = 1; i <= 5; i++) {
        if (!document.getElementById(`wizard-step-${i}`).classList.contains('hidden')) {
          currentStep = i;
          break;
        }
      }

      // If agreement has been sent, allow navigation to all steps including Step 5
      if (wizardData.agreementSent) {
        goToStep(targetStep);
        return;
      }

      // Allow clicking back without validation
      if (targetStep < currentStep) {
        goToStep(targetStep);
        return;
      }

      // If clicking forward, validate current step and navigate
      if (targetStep > currentStep) {
        // Step 1 → 2+: Validate step 1 fields
        if (currentStep === 1 && targetStep >= 2) {
          if (!validateStep1()) return;
          if (targetStep === 2) {
            goToTerms();
            return;
          }
        }

        // Step 2 → 3+: Validate calculator and navigate to Payments
        if (currentStep === 2 && targetStep >= 3) {
          saveCalculatorAndContinue();
          return;
        }

        // Step 3 → 4+: Navigate to summary
        if (currentStep === 3 && targetStep >= 4) {
          if (targetStep === 4) {
            goToSummary();
            return;
          }
        }

        // Step 4 → 5: Can only happen after sending (handled by sendInvite)
        if (currentStep === 4 && targetStep === 5) {
          return; // Prevent manual navigation to step 5
        }

        // Step 5 allows clicking back
        if (currentStep === 5 && targetStep < 5) {
          goToStep(targetStep);
          return;
        }
      }

      // If same step, do nothing
      if (targetStep === currentStep) {
        return;
      }
    }

    // Select role card and update UI
    function selectRoleCard(role) {
      wizardData.role = role;
      document.querySelector(`input[name="role"][value="${role}"]`).checked = true;

      // Visual feedback
      document.getElementById('role-card-lend').style.borderColor = role === 'lend' ? 'var(--accent)' : 'rgba(255,255,255,0.08)';

      // Show/hide borrower fields
      toggleBorrowerFields();
    }

    // Toggle borrower fields visibility based on role selection
    function toggleBorrowerFields() {
      const role = document.querySelector('input[name="role"]:checked')?.value;
      const borrowerFields = document.getElementById('borrower-fields');

      if (role === 'lend') {
        borrowerFields.classList.remove('hidden');
      } else {
        borrowerFields.classList.add('hidden');
      }
    }

    // Auto-capitalize name input
    function autoCapitalizeName() {
      const input = document.getElementById('friend-first-name');
      const value = input.value;
      if (value.length > 0) {
        input.value = value.charAt(0).toUpperCase() + value.slice(1);
      }
    }

    // Auto-capitalize description input
    function autoCapitalizeDescription() {
      const input = document.getElementById('description');
      const value = input.value;
      if (value.length > 0) {
        input.value = value.charAt(0).toUpperCase() + value.slice(1);
      }
    }

    // Validate step 1 (Setup)
    function validateStep1() {
      const role = wizardData.role || document.querySelector('input[name="role"]:checked')?.value;
      const friendFirstName = document.getElementById('friend-first-name').value.trim();
      const friendEmail = document.getElementById('friend-email').value.trim();
      const description = document.getElementById('description').value.trim();
      const status = document.getElementById('step1-status');
      const phoneError = document.getElementById('agreement-phone-error');

      // Hide phone error initially
      phoneError.style.display = 'none';

      if (!role) {
        status.textContent = 'Please select a role (lend or borrow)';
        return false;
      }

      if (!friendFirstName) {
        status.textContent = 'Please enter borrower name';
        return false;
      }

      if (!friendEmail) {
        status.textContent = 'Please enter borrower email';
        return false;
      }

      // Validate phone number
      if (!agreementPhoneInput || !agreementPhoneInput.isValidNumber()) {
        phoneError.style.display = 'block';
        if (agreementPhoneInput) {
          agreementPhoneInput.setInvalid(true);
        }
        status.textContent = 'Please fix the errors above';
        return false;
      }
      // Clear invalid state if valid
      agreementPhoneInput.setInvalid(false);

      if (!description) {
        status.textContent = 'Please enter loan description';
        return false;
      }

      if (description.length > 30) {
        status.textContent = 'Loan description must be 30 characters or less';
        return false;
      }

      // Get phone number in E.164 format
      const phoneNumber = agreementPhoneInput.getNumber();

      // Store validated data
      wizardData.role = role;
      wizardData.friendFirstName = friendFirstName.charAt(0).toUpperCase() + friendFirstName.slice(1);
      wizardData.friendEmail = friendEmail;
      wizardData.phoneNumber = phoneNumber;
      wizardData.description = description.charAt(0).toUpperCase() + description.slice(1);

      status.textContent = '';
      return true;
    }

    // Navigate to Terms step
    function goToTerms() {
      if (!validateStep1()) return;
      goToStep(2);
      // Initialize default due date for one-time payment if not already set
      const dueDateInput = document.getElementById('due-date');
      if (dueDateInput && !dueDateInput.value) {
        updateOneTimeDueOption();
      }
    }

    // Toggle between one-time and installment fields
    function toggleInstallmentFields() {
      const repaymentType = document.querySelector('input[name="repayment-type"]:checked').value;
      const oneTimeFields = document.getElementById('one-time-fields');
      const installmentFields = document.getElementById('installment-fields');
      const oneTimeCard = document.getElementById('repayment-onetime-card');
      const installmentsCard = document.getElementById('repayment-installments-card');

      if (repaymentType === 'installments') {
        oneTimeFields.classList.add('hidden');
        installmentFields.classList.remove('hidden');
        wizardData.repaymentType = 'installments';

        // Update card styling
        oneTimeCard.classList.remove('reminder-option-active');
        installmentsCard.classList.add('reminder-option-active');

        // Set defaults for loan duration fields
        const loanDurationValue = document.getElementById('loan-duration-value');
        const loanDurationUnit = document.getElementById('loan-duration-unit');
        const numRepaymentsInput = document.getElementById('num-repayments');

        if (!loanDurationValue.value) {
          loanDurationValue.value = '12';
        }
        if (!loanDurationUnit.value) {
          loanDurationUnit.value = 'months';
        }
        if (!numRepaymentsInput.value) {
          numRepaymentsInput.value = '12';
        }

        // Set default first payment option
        document.getElementById('first-payment-option').value = '1month';
        updateFirstPaymentOption();
      } else {
        oneTimeFields.classList.remove('hidden');
        installmentFields.classList.add('hidden');
        wizardData.repaymentType = 'one_time';

        // Update card styling
        oneTimeCard.classList.add('reminder-option-active');
        installmentsCard.classList.remove('reminder-option-active');

        // Clear loan duration values to avoid leaking into calculations
        const loanDurationValue = document.getElementById('loan-duration-value');
        const loanDurationUnit = document.getElementById('loan-duration-unit');
        loanDurationValue.value = '';
        loanDurationUnit.value = 'months';

        // Ensure default due date is set
        const dueDateInput = document.getElementById('due-date');
        if (!dueDateInput.value) {
          const oneTimeDueOption = document.getElementById('one-time-due-option');
          oneTimeDueOption.value = 'in_1_month';
          updateOneTimeDueOption();
        } else {
          updateOneTimeEstimate();
        }
      }
    }

    // Update first payment date based on selected option
    function updateMoneySentOption() {
      const option = document.getElementById('money-sent-option').value;
      const customDateField = document.getElementById('custom-money-sent-date');
      const moneySentDateInput = document.getElementById('money-sent-date');

      // Store the option for later use
      wizardData.moneySentOption = option;

      if (option === 'custom') {
        customDateField.classList.remove('hidden');
      } else {
        customDateField.classList.add('hidden');

        // Calculate money sent date
        const today = new Date();
        let sentDate;

        if (option === 'on-acceptance') {
          // Store a special value, will be resolved later
          wizardData.moneySentDate = 'on-acceptance';
          // Update due date calculation for one-time payments
          const repaymentType = document.querySelector('input[name="repayment-type"]:checked')?.value;
          const oneTimeDueOption = document.getElementById('one-time-due-option').value;
          if (repaymentType === 'one_time' && oneTimeDueOption !== 'pick_date') {
            updateOneTimeDueOption();
          } else if (repaymentType === 'installments') {
            // Recalculate installment schedule when money transfer date changes
            calculateInstallments();
          }
          return;
        } else if (option === 'today') {
          sentDate = new Date(today);
        } else if (option === 'tomorrow') {
          sentDate = new Date(today);
          sentDate.setDate(sentDate.getDate() + 1);
        } else if (option === '3days') {
          sentDate = new Date(today);
          sentDate.setDate(sentDate.getDate() + 3);
        } else if (option === '7days') {
          sentDate = new Date(today);
          sentDate.setDate(sentDate.getDate() + 7);
        }

        // Set the date input value
        moneySentDateInput.value = sentDate.toISOString().split('T')[0];
        wizardData.moneySentDate = moneySentDateInput.value;

        // Update due date calculation for one-time payments
        const repaymentType = document.querySelector('input[name="repayment-type"]:checked')?.value;
        const oneTimeDueOption = document.getElementById('one-time-due-option').value;
        if (repaymentType === 'one_time' && oneTimeDueOption !== 'pick_date') {
          updateOneTimeDueOption();
        } else if (repaymentType === 'installments') {
          // Recalculate installment schedule when money transfer date changes
          calculateInstallments();
        }
      }
    }

    // Handle custom money sent date changes
    function onMoneySentDateChange() {
      const moneySentDateInput = document.getElementById('money-sent-date');
      wizardData.moneySentDate = moneySentDateInput.value;

      // Update due date calculation for one-time payments
      const repaymentType = document.querySelector('input[name="repayment-type"]:checked')?.value;
      const oneTimeDueOption = document.getElementById('one-time-due-option').value;
      if (repaymentType === 'one_time' && oneTimeDueOption !== 'pick_date') {
        updateOneTimeDueOption();
      } else if (repaymentType === 'installments') {
        // Recalculate installment schedule when money transfer date changes
        calculateInstallments();
      }
    }

    function updateOneTimeDueOption() {
      const option = document.getElementById('one-time-due-option').value;
      const customDateField = document.getElementById('custom-one-time-due-date');
      const dueDateInput = document.getElementById('due-date');

      // Store the option in wizardData
      wizardData.oneTimeDueOption = option;

      if (option === 'pick_date') {
        customDateField.classList.remove('hidden');
      } else {
        customDateField.classList.add('hidden');

        // Get base date: use money transfer date if available, otherwise today
        let baseDate;
        const moneySentOption = document.getElementById('money-sent-option').value;
        const moneySentDateInput = document.getElementById('money-sent-date');

        if (moneySentOption === 'on-acceptance') {
          // If "on acceptance", use today as base (normalized to midnight local time)
          baseDate = new Date();
          baseDate.setHours(0, 0, 0, 0);
        } else if (moneySentDateInput.value) {
          // Use the money sent date - parse as YYYY-MM-DD and create at midnight local time
          const parts = moneySentDateInput.value.split('-');
          baseDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]), 0, 0, 0, 0);
        } else {
          // Fallback to today (normalized to midnight local time)
          baseDate = new Date();
          baseDate.setHours(0, 0, 0, 0);
        }

        // Calculate due date based on selected option
        let dueDate;

        if (option === 'in_1_week') {
          dueDate = addWeeks(baseDate, 1);
        } else if (option === 'in_1_month') {
          dueDate = addMonthsKeepingDay(baseDate, 1);
        } else if (option === 'in_3_months') {
          dueDate = addMonthsKeepingDay(baseDate, 3);
        } else if (option === 'in_6_months') {
          dueDate = addMonthsKeepingDay(baseDate, 6);
        } else if (option === 'in_1_year' || option === 'in_1_years') {
          dueDate = addYears(baseDate, 1);
        }

        // Set the date input value - format as YYYY-MM-DD
        if (dueDate) {
          const year = dueDate.getFullYear();
          const month = String(dueDate.getMonth() + 1).padStart(2, '0');
          const day = String(dueDate.getDate()).padStart(2, '0');
          dueDateInput.value = `${year}-${month}-${day}`;
        }
      }
      // Always update the estimate when the option changes
      updateOneTimeEstimate();
    }

    function updateOneTimeEstimate() {
      const dueDate = document.getElementById('due-date').value;
      const amount = document.getElementById('amount').value;

      if (!amount) {
        document.getElementById('one-time-estimate').textContent = '';
        return;
      }

      const cleanAmount = amount.replace(/[.,]/g, '');
      const amountNum = parseFloat(cleanAmount);

      if (isNaN(amountNum) || amountNum <= 0) {
        document.getElementById('one-time-estimate').textContent = '';
        return;
      }

      const amountFormatted = formatEuro2(amountNum);

      // Check if loan start is "on acceptance"
      const moneySentOption = document.getElementById('money-sent-option').value;
      const isLoanStartOnAcceptance = moneySentOption === 'on-acceptance';

      // Check if due date option is relative (not "pick_date")
      const oneTimeDueOption = document.getElementById('one-time-due-option').value;
      const isRelativeDueDate = oneTimeDueOption !== 'pick_date';

      // If loan start is "on acceptance" AND due date is relative, show relative text
      if (isLoanStartOnAcceptance && isRelativeDueDate) {
        const relativeText = getRelativeDueDateText(oneTimeDueOption);
        document.getElementById('one-time-estimate').textContent =
          `One-time payment of ${amountFormatted} (excl interest) ${relativeText}.`;
        return;
      }

      // Otherwise, show concrete date (if available)
      if (!dueDate) {
        document.getElementById('one-time-estimate').textContent = '';
        return;
      }

      const date = new Date(dueDate);
      const dateFormatted = date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });

      document.getElementById('one-time-estimate').textContent =
        `One-time payment of ${amountFormatted} (excl interest) on ${dateFormatted}.`;
    }

    // Unified function to update estimate based on repayment type
    function updateEstimate() {
      const repaymentType = document.querySelector('input[name="repayment-type"]:checked').value;

      if (repaymentType === 'installments') {
        // For installments, recalculate the installment summary
        calculateInstallments();
      } else {
        // For one-time payment, update the one-time estimate
        updateOneTimeEstimate();
      }

      // Also update worst case scenario visibility whenever amount changes
      updateWorstCaseVisibility();
    }

    // Update visibility of worst case scenario option based on loan amount
    function updateWorstCaseVisibility() {
      const amountInput = document.getElementById('amount');
      if (!amountInput) return;

      const amountValue = amountInput.value;
      const cleanAmount = amountValue.replace(/[.,]/g, '');
      const amountNum = parseFloat(cleanAmount) || 0;

      const container = document.getElementById('worst-case-scenario-container');
      const checkbox = document.getElementById('debt-collection-clause');

      if (!container) return;

      const showWorstCase = amountNum >= WORST_CASE_MIN_AMOUNT_EUR;

      if (showWorstCase) {
        container.style.display = '';
      } else {
        container.style.display = 'none';
        // Clear the checkbox when hidden
        if (checkbox) {
          checkbox.checked = false;
        }
      }
    }

    // Helper function to add months while keeping day-of-month (or last valid day)
    function addMonthsKeepingDay(date, months) {
      const result = new Date(date);
      const targetDay = result.getDate();

      // Add the months
      result.setMonth(result.getMonth() + months);

      // If the day changed (e.g., Jan 31 + 1 month = Mar 3), set to last day of target month
      if (result.getDate() !== targetDay) {
        result.setDate(0); // Go to last day of previous month
      }

      return result;
    }

    // Helper function to add weeks to a date
    function addWeeks(date, weeks) {
      const result = new Date(date);
      result.setDate(result.getDate() + (weeks * 7));
      return result;
    }

    // Helper function to add years to a date
    function addYears(date, years) {
      const result = new Date(date);
      result.setFullYear(result.getFullYear() + years);
      return result;
    }

    // Helper function to get interval text from loan duration and number of repayments
    function getIntervalText(loanDurationValue, loanDurationUnit, numRepayments) {
      // Convert to days
      let totalDays;
      switch (loanDurationUnit) {
        case 'days': totalDays = loanDurationValue; break;
        case 'weeks': totalDays = loanDurationValue * 7; break;
        case 'months': totalDays = loanDurationValue * 30; break;
        case 'years': totalDays = loanDurationValue * 365; break;
      }

      const intervalDays = totalDays / numRepayments;

      // Format based on interval size
      if (intervalDays < 14) {
        const days = Math.round(intervalDays);
        return days === 1 ? 'daily' : `every ${days} days`;
      } else if (intervalDays < 60) {
        const weeks = Math.round(intervalDays / 7);
        return weeks === 1 ? 'weekly' : `every ${weeks} weeks`;
      } else if (intervalDays < 730) {
        const months = Math.round(intervalDays / 30);
        if (months === 1) return 'monthly';
        if (months === 2) return 'bi-monthly';
        if (months === 3) return 'quarterly';
        if (months === 6) return 'semi-annually';
        return `every ${months} months`;
      } else {
        const years = Math.round(intervalDays / 365);
        return years === 1 ? 'annually' : `every ${years} years`;
      }
    }

    // Helper function to format payment frequency for summary text
    function getFrequencyTextForSummary(loanDurationValue, loanDurationUnit, numRepayments) {
      // Convert to days
      let totalDays;
      switch (loanDurationUnit) {
        case 'days': totalDays = loanDurationValue; break;
        case 'weeks': totalDays = loanDurationValue * 7; break;
        case 'months': totalDays = loanDurationValue * 30; break;
        case 'years': totalDays = loanDurationValue * 365; break;
      }

      const intervalDays = totalDays / numRepayments;

      // Format based on interval size for summary context
      if (intervalDays < 14) {
        const days = Math.round(intervalDays);
        return days === 1 ? 'every day' : `every ${days} days`;
      } else if (intervalDays < 60) {
        const weeks = Math.round(intervalDays / 7);
        return weeks === 1 ? 'every week' : `every ${weeks} weeks`;
      } else if (intervalDays < 730) {
        const months = Math.round(intervalDays / 30);
        if (months === 1) return 'every month';
        if (months === 2) return 'every 2 months';
        if (months === 3) return 'every 3 months';
        if (months === 6) return 'every 6 months';
        if (months === 12) return 'once a year';
        return `every ${months} months`;
      } else {
        const years = Math.round(intervalDays / 365);
        return years === 1 ? 'once a year' : `every ${years} years`;
      }
    }

    // Determine payment frequency code for schedule calculation
    function getPaymentFrequency(loanDurationValue, loanDurationUnit, numRepayments) {
      // Convert to days
      let totalDays;
      switch (loanDurationUnit) {
        case 'days': totalDays = loanDurationValue; break;
        case 'weeks': totalDays = loanDurationValue * 7; break;
        case 'months': totalDays = loanDurationValue * 30; break;
        case 'years': totalDays = loanDurationValue * 365; break;
      }

      const intervalDays = totalDays / numRepayments;

      // Classify into standard frequency codes
      // Allow ±10% tolerance for matching standard frequencies
      if (Math.abs(intervalDays - 7) <= 1) {
        return 'weekly';
      } else if (Math.abs(intervalDays - 14) <= 2) {
        return 'biweekly';
      } else if (Math.abs(intervalDays - 28) <= 2) {
        return 'every_4_weeks';
      } else if (Math.abs(intervalDays - 30) <= 3 || Math.abs(intervalDays - 31) <= 3) {
        return 'monthly';
      } else if (Math.abs(intervalDays - 91) <= 5) {
        return 'quarterly';
      } else if (Math.abs(intervalDays - 365) <= 10) {
        return 'yearly';
      } else {
        // Default to monthly for anything ambiguous
        return 'monthly';
      }
    }

    // Get first payment offset in months from option value
    function getFirstPaymentOffsetMonths(firstPaymentOption) {
      const monthMap = {
        '1month': 1,
        '2months': 2,
        '3months': 3,
        '6months': 6,
        '12months': 12
      };

      if (monthMap[firstPaymentOption]) {
        return monthMap[firstPaymentOption];
      }

      // For day-based options, convert to approximate months
      if (firstPaymentOption === '3days') return 3 / 30;
      if (firstPaymentOption === '7days') return 7 / 30;

      // For custom dates, we'll calculate the offset separately
      return null;
    }

    // Generate payment dates for installments using month-based calculation
    function generateInstallmentPaymentDates(params) {
      const {
        loanStartDate,
        durationMonths,
        numberOfPayments,
        firstPaymentOption,
        firstPaymentDate
      } = params;

      const paymentDates = [];
      const intervalMonths = durationMonths / numberOfPayments;

      // Determine first payment offset in months
      let firstOffsetMonths;

      if (firstPaymentOption === 'custom' && firstPaymentDate) {
        // For custom dates, calculate the offset from loan start to first payment
        const loanStart = new Date(loanStartDate);
        const firstPayment = new Date(firstPaymentDate);
        loanStart.setHours(0, 0, 0, 0);
        firstPayment.setHours(0, 0, 0, 0);

        // Calculate approximate month difference
        const yearDiff = firstPayment.getFullYear() - loanStart.getFullYear();
        const monthDiff = firstPayment.getMonth() - loanStart.getMonth();
        firstOffsetMonths = yearDiff * 12 + monthDiff;

        // Adjust for day of month differences
        if (firstPayment.getDate() < loanStart.getDate()) {
          firstOffsetMonths -= 1;
        }
      } else {
        // For preset options, get the offset directly
        firstOffsetMonths = getFirstPaymentOffsetMonths(firstPaymentOption);

        // If offset is null or not a clean month value, default to intervalMonths
        if (firstOffsetMonths === null || firstOffsetMonths < 0.5) {
          firstOffsetMonths = intervalMonths;
        }
      }

      // Generate dates using month-based offsets
      const loanStart = new Date(loanStartDate);
      loanStart.setHours(0, 0, 0, 0);

      for (let i = 0; i < numberOfPayments; i++) {
        const offsetMonths = firstOffsetMonths + (i * intervalMonths);
        const dueDate = addMonthsKeepingDay(loanStart, offsetMonths);
        paymentDates.push(dueDate);
      }

      return paymentDates;
    }


    function updateFirstPaymentOption() {
      const option = document.getElementById('first-payment-option').value;
      const customDateField = document.getElementById('custom-first-payment-date');
      const firstPaymentDateInput = document.getElementById('first-payment-date');

      if (option === 'custom') {
        customDateField.classList.remove('hidden');
      } else {
        customDateField.classList.add('hidden');

        // Calculate first payment date
        const today = new Date();
        let firstDate;

        if (option === 'today') {
          firstDate = new Date(today);
        } else if (option === 'tomorrow') {
          firstDate = new Date(today);
          firstDate.setDate(firstDate.getDate() + 1);
        } else if (option === '3days') {
          firstDate = new Date(today);
          firstDate.setDate(firstDate.getDate() + 3);
        } else if (option === '7days') {
          firstDate = new Date(today);
          firstDate.setDate(firstDate.getDate() + 7);
        } else if (option === '1month') {
          firstDate = addMonthsKeepingDay(today, 1);
        } else if (option === '2months') {
          firstDate = addMonthsKeepingDay(today, 2);
        } else if (option === '3months') {
          firstDate = addMonthsKeepingDay(today, 3);
        } else if (option === '6months') {
          firstDate = addMonthsKeepingDay(today, 6);
        } else if (option === '12months') {
          firstDate = addMonthsKeepingDay(today, 12);
        }

        // Set the date input value
        firstPaymentDateInput.value = firstDate.toISOString().split('T')[0];
        calculateInstallments();
      }
    }

    // Calculate installment details using loan duration and repayments
    function calculateInstallments() {
      const amount = document.getElementById('amount').value;
      const loanDurationValue = parseInt(document.getElementById('loan-duration-value').value);
      const loanDurationUnit = document.getElementById('loan-duration-unit').value;
      const numRepaymentsInput = document.getElementById('num-repayments');
      const firstPaymentDate = document.getElementById('first-payment-date').value;
      const errorElement = document.getElementById('num-repayments-error');
      const planLengthSummary = document.getElementById('plan-length-summary');
      const installmentEstimate = document.getElementById('installment-estimate');
      const intervalDisplay = document.getElementById('repayment-interval-display');

      // Clear error
      errorElement.classList.add('hidden');

      // Get number of repayments
      const numRepayments = parseInt(numRepaymentsInput.value);

      // Validate input
      if (!numRepaymentsInput.value || isNaN(numRepayments) || numRepayments < 2 || numRepayments > 120) {
        errorElement.textContent = 'Please enter a number of payments between 2 and 120.';
        errorElement.classList.remove('hidden');
        planLengthSummary.textContent = '';
        installmentEstimate.textContent = '';
        intervalDisplay.textContent = '';
        return;
      }

      if (!loanDurationValue || !loanDurationUnit || !amount || !numRepayments || !firstPaymentDate) {
        planLengthSummary.textContent = '';
        installmentEstimate.textContent = '';
        intervalDisplay.textContent = '';
        return;
      }

      // Parse amount
      const cleanAmount = amount.replace(/[.,]/g, '');
      const amountNum = parseFloat(cleanAmount);

      if (isNaN(amountNum) || amountNum <= 0) {
        planLengthSummary.textContent = '';
        installmentEstimate.textContent = '';
        return;
      }

      // Convert loan duration to days
      let totalDays;
      switch (loanDurationUnit) {
        case 'days':
          totalDays = loanDurationValue;
          break;
        case 'weeks':
          totalDays = loanDurationValue * 7;
          break;
        case 'months':
          totalDays = loanDurationValue * 30;
          break;
        case 'years':
          totalDays = loanDurationValue * 365;
          break;
      }

      // Calculate interval for display (total duration / number of repayments)
      const intervalDays = totalDays / numRepayments;

      // Format interval for display with appropriate units
      let intervalText;
      if (intervalDays < 14) {
        const days = Math.round(intervalDays);
        intervalText = `Every ${days} ${days === 1 ? 'day' : 'days'}`;
      } else if (intervalDays < 60) {
        const weeks = Math.round(intervalDays / 7);
        intervalText = `Every ${weeks} ${weeks === 1 ? 'week' : 'weeks'}`;
      } else if (intervalDays < 730) {
        const months = Math.round(intervalDays / 30);
        intervalText = `Every ${months} ${months === 1 ? 'month' : 'months'}`;
      } else {
        const years = Math.round(intervalDays / 365);
        intervalText = `Every ${years} ${years === 1 ? 'year' : 'years'}`;
      }
      intervalDisplay.textContent = intervalText;

      // Calculate final end date from first payment + loan duration
      const firstDate = new Date(firstPaymentDate);
      let finalDate = new Date(firstDate);

      switch (loanDurationUnit) {
        case 'days':
          finalDate.setDate(finalDate.getDate() + loanDurationValue);
          break;
        case 'weeks':
          finalDate.setDate(finalDate.getDate() + (loanDurationValue * 7));
          break;
        case 'months':
          finalDate = addMonthsKeepingDay(firstDate, loanDurationValue);
          break;
        case 'years':
          finalDate = addMonthsKeepingDay(firstDate, loanDurationValue * 12);
          break;
      }

      // Generate installment schedule - evenly spread dates from first to final
      const installmentSchedule = [];
      const totalDurationMs = finalDate - firstDate;

      for (let i = 0; i < numRepayments; i++) {
        let paymentDate;
        if (i === 0) {
          paymentDate = new Date(firstDate);
        } else if (i === numRepayments - 1) {
          paymentDate = new Date(finalDate);
        } else {
          // Evenly space intermediate payments
          const progressRatio = i / (numRepayments - 1);
          paymentDate = new Date(firstDate.getTime() + (totalDurationMs * progressRatio));
        }
        installmentSchedule.push(paymentDate.toISOString().split('T')[0]);
      }

      // Calculate installment amount
      const installmentAmount = (amountNum / numRepayments).toFixed(2);

      // Format dates
      const firstFormatted = firstDate.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
      const finalFormatted = finalDate.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });

      // Format duration for display
      let durationText;
      if (loanDurationUnit === 'days') {
        durationText = `${loanDurationValue} ${loanDurationValue === 1 ? 'day' : 'days'}`;
      } else if (loanDurationUnit === 'weeks') {
        durationText = `${loanDurationValue} ${loanDurationValue === 1 ? 'week' : 'weeks'}`;
      } else if (loanDurationUnit === 'months') {
        durationText = `${loanDurationValue} ${loanDurationValue === 1 ? 'month' : 'months'}`;
      } else {
        durationText = `${loanDurationValue} ${loanDurationValue === 1 ? 'year' : 'years'}`;
      }

      // Store in wizard data
      wizardData.loanDurationValue = loanDurationValue;
      wizardData.loanDurationUnit = loanDurationUnit;
      wizardData.numRepayments = numRepayments;
      wizardData.planLength = loanDurationValue;
      wizardData.planUnit = loanDurationUnit;
      wizardData.installmentCount = numRepayments;
      wizardData.installmentAmount = parseFloat(installmentAmount);
      wizardData.firstPaymentDate = firstPaymentDate;
      wizardData.firstPaymentOption = document.getElementById('first-payment-option').value;
      wizardData.finalDueDate = installmentSchedule[installmentSchedule.length - 1];
      wizardData.installmentSchedule = installmentSchedule;
      wizardData.paymentFrequency = getPaymentFrequency(loanDurationValue, loanDurationUnit, numRepayments);

      // Display summary
      const installmentFormatted = formatEuro2(installmentAmount);
      const frequencyText = getFrequencyTextForSummary(loanDurationValue, loanDurationUnit, numRepayments);

      // Loan duration summary
      planLengthSummary.textContent = `Plan length: ${durationText}.`;

      // Payment summary with frequency
      installmentEstimate.textContent = `${numRepayments} payment${numRepayments === 1 ? '' : 's'} of about ${installmentFormatted} each (excl interest) ${frequencyText}.`;
    }

    // Update due date helper text
    function updateDueDateHelper() {
      updateOneTimeEstimate();
    }

    // Validate step 2 (Terms)
    function validateStep2() {
      const amountInput = document.getElementById('amount');
      const repaymentType = document.querySelector('input[name="repayment-type"]:checked').value;
      const status = document.getElementById('step2-status');

      // Validate amount field with enhanced UX
      if (!validateAmountField()) {
        amountInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        amountInput.focus();
        return false;
      }

      const amount = amountInput.value;
      const cleanAmount = amount.replace(/[.,]/g, '');
      const amountNum = parseFloat(cleanAmount);

      // Validate money sent date
      const moneySentOption = document.getElementById('money-sent-option').value;
      let moneySentDate;

      if (moneySentOption === 'custom') {
        moneySentDate = document.getElementById('money-sent-date').value;
        if (!moneySentDate) {
          status.textContent = 'Please select when money was/will be sent to borrower';
          return false;
        }
      } else if (moneySentOption === 'on-acceptance') {
        moneySentDate = 'on-acceptance'; // Special value
      } else {
        // For other options, the date should already be set by updateMoneySentOption
        moneySentDate = document.getElementById('money-sent-date').value;
      }

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      if (repaymentType === 'one_time') {
        const dueDate = document.getElementById('due-date').value;
        if (!dueDate) {
          status.textContent = 'Please select a due date';
          return false;
        }

        wizardData.dueDate = dueDate;
        wizardData.finalDueDate = dueDate;
        wizardData.installmentCount = 1;
      } else {
        // Validate installment fields
        const loanDurationValue = parseInt(document.getElementById('loan-duration-value').value);
        const loanDurationUnit = document.getElementById('loan-duration-unit').value;
        const numRepaymentsInput = document.getElementById('num-repayments');
        const firstPaymentDate = document.getElementById('first-payment-date').value;

        // Validate loan duration
        if (!loanDurationValue || loanDurationValue <= 0) {
          status.textContent = 'Please enter a valid loan duration';
          return false;
        }

        // Validate number of payments
        const numRepayments = parseInt(numRepaymentsInput.value);
        if (!numRepaymentsInput.value || isNaN(numRepayments) || numRepayments < 2 || numRepayments > 120) {
          status.textContent = 'Please enter a valid number of payments (2-120)';
          return false;
        }

        // Validate first payment date
        if (!firstPaymentDate) {
          status.textContent = 'Please select a first payment date';
          return false;
        }

        // Validate maximum plan length (50 years in any unit)
        let planLengthInMonths;
        if (loanDurationUnit === 'days') {
          planLengthInMonths = loanDurationValue / 30;
        } else if (loanDurationUnit === 'weeks') {
          planLengthInMonths = loanDurationValue / 4.33;
        } else if (loanDurationUnit === 'months') {
          planLengthInMonths = loanDurationValue;
        } else if (loanDurationUnit === 'years') {
          planLengthInMonths = loanDurationValue * 12;
        }

        if (planLengthInMonths > 600) {
          status.textContent = 'Please choose a shorter plan. Maximum allowed length is 50 years';
          return false;
        }

        // For installments, set due_date to finalDueDate for database compatibility
        wizardData.dueDate = wizardData.finalDueDate;
      }

      // Store validated data
      wizardData.amount = amountNum;
      wizardData.moneySentDate = moneySentDate;

      status.textContent = '';
      return true;
    }

    // Navigate to interest step
    // ============================================================================
    // LOAN CALCULATOR INTEGRATION FOR STEP 2
    // ============================================================================

    let wizardCalculatorInitialized = false;
    let wizardCalculatorSchedule = null;
    let wizardCalculatorSummary = null;

    /**
     * Initialize the loan calculator in Step 2
     */
    async function initializeWizardCalculator() {
      // Only load calculator once
      if (wizardCalculatorInitialized) {
        return;
      }

      try {
        // Fetch the calculator partial HTML
        const response = await fetch('/partials/loan-calculator-form.html');
        if (!response.ok) {
          throw new Error(`Failed to load calculator: ${response.status}`);
        }

        const html = await response.text();
        document.getElementById('wizard-calculator-container').innerHTML = html;

        // Set up the calculator logic
        setupWizardCalculatorLogic();

        wizardCalculatorInitialized = true;
      } catch (error) {
        console.error('Error initializing wizard calculator:', error);
        document.getElementById('wizard-calculator-container').innerHTML =
          '<div style="padding: 20px; color: #ef4444;">Error loading calculator. Please refresh the page.</div>';
      }
    }

    /**
     * Set up calculator UI logic and event listeners for wizard Step 2
     */
    function setupWizardCalculatorLogic() {
      const formatMoney = window.formatCurrency2;

      // Interest mode ('interest' or 'no-interest')
      let interestMode = 'interest';

      /**
       * Reset calculator to defaults (wizard version)
       */
      function resetWizardCalculator() {
        document.getElementById('principal').value = '';
        document.getElementById('interest').value = 5;
        document.getElementById('repaymentType').value = 'one_time';
        document.getElementById('numInstallments').value = 1;
        document.getElementById('frequency').value = 'every-month';
        document.getElementById('firstPaymentDue').value = '1-year';
        document.getElementById('loanStartMode').value = 'upon_acceptance';

        setInterestMode('interest');
        updateLoanAmountHighlight();

        document.getElementById('loanStartDateGroup').classList.add('hidden');
        document.getElementById('firstPaymentDateGroup').classList.add('hidden');
        document.getElementById('loanStartDate').value = '';
        document.getElementById('firstPaymentDate').value = '';

        updateRepaymentTypeUI();

        document.getElementById('scheduleBody').innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">Enter loan amount and details to calculate...</td></tr>';
        document.getElementById('scheduleTotals').style.display = 'none';
        document.getElementById('loanSummaryContent').innerHTML = 'Configure parameters to see loan summary...';

        // Hide config loan timing
        const configLoanTiming = document.getElementById('config-loan-timing');
        if (configLoanTiming) {
          configLoanTiming.style.display = 'none';
        }

        // Clear wizard results
        wizardCalculatorSchedule = null;
        wizardCalculatorSummary = null;
      }

      // Enable the reset button and attach handler
      const resetBtn = document.getElementById('calculator-reset-link');
      if (resetBtn) {
        resetBtn.style.display = 'inline-block';
        resetBtn.addEventListener('click', function(event) {
          event.preventDefault();
          resetWizardCalculator();
        });
      }

      /**
       * Set interest mode (Interest or No interest)
       */
      function setInterestMode(mode) {
        interestMode = mode;
        const modeInterestBtn = document.getElementById('mode-interest');
        const modeNoInterestBtn = document.getElementById('mode-no-interest');
        const interestInputRow = document.getElementById('interest-input-row');
        const fairRangeExplanation = document.getElementById('fair-range-explanation');

        if (mode === 'interest') {
          modeInterestBtn.style.background = '#6ee7b7';
          modeInterestBtn.style.color = '#000';
          modeNoInterestBtn.style.background = 'transparent';
          modeNoInterestBtn.style.color = '#e5e7eb';
          interestInputRow.style.display = 'flex';
        } else {
          modeInterestBtn.style.background = 'transparent';
          modeInterestBtn.style.color = '#e5e7eb';
          modeNoInterestBtn.style.background = '#6ee7b7';
          modeNoInterestBtn.style.color = '#000';
          interestInputRow.style.display = 'none';
          fairRangeExplanation.classList.add('hidden');
          document.getElementById('fair-range-pill').setAttribute('aria-expanded', 'false');
        }

        runCalculation();
      }

      /**
       * Toggle fair range explanation visibility
       */
      function toggleFairRangeExplanation() {
        const explanation = document.getElementById('fair-range-explanation');
        const pill = document.getElementById('fair-range-pill');
        const isExpanded = pill.getAttribute('aria-expanded') === 'true';

        if (isExpanded) {
          explanation.classList.add('hidden');
          pill.setAttribute('aria-expanded', 'false');
        } else {
          explanation.classList.remove('hidden');
          pill.setAttribute('aria-expanded', 'true');
        }
      }

      /**
       * Calculate fair interest range
       */
      function calculateFairRange() {
        const principalValue = document.getElementById('principal').value.trim();
        const loanAmount = window.PayFriendsCalculator.parseMoney(principalValue);
        const repaymentType = document.getElementById('repaymentType').value;
        const numberOfInstallments = parseInt(document.getElementById('numInstallments').value);
        const firstPaymentDueOption = document.getElementById('firstPaymentDue').value;

        let minRate = 4;
        let maxRate = 7;

        if (loanAmount > 0) {
          if (loanAmount > 10000 * 100) {
            minRate += 1;
            maxRate += 1;
          } else if (loanAmount < 2000 * 100) {
            minRate = Math.max(3, minRate - 1);
            maxRate = Math.max(5, maxRate - 1);
          }
        }

        const durationMonths = estimateLoanDurationMonths(firstPaymentDueOption, numberOfInstallments);
        if (durationMonths > 24) {
          minRate += 1;
          maxRate += 1;
        } else if (durationMonths < 6) {
          minRate = Math.max(3, minRate - 1);
          maxRate = Math.max(5, maxRate - 1);
        }

        if (repaymentType === 'installments' && numberOfInstallments >= 12) {
          maxRate = Math.max(5, maxRate - 1);
        }

        return { min: minRate, max: maxRate };
      }

      function estimateLoanDurationMonths(firstPaymentOption, installments) {
        let months = 12;
        if (firstPaymentOption === '1-week') months = 0.25;
        else if (firstPaymentOption === '1-month') months = 1;
        else if (firstPaymentOption === '6-months') months = 6;
        else if (firstPaymentOption === '1-year') months = 12;
        else if (firstPaymentOption === '2-years') months = 24;
        else if (firstPaymentOption === '3-years') months = 36;

        if (installments > 1) {
          months = months * installments;
        }
        return months;
      }

      function updateFairRangePill() {
        const range = calculateFairRange();
        document.getElementById('fair-range-text').textContent = `Fair range (${range.min}–${range.max}%)`;
      }

      function updateRepaymentTypeUI() {
        const repaymentType = document.getElementById('repaymentType').value;
        const isOneTime = repaymentType === 'one_time';

        const numInstallmentsGroup = document.getElementById('numInstallments').closest('.form-group');
        const frequencyGroup = document.getElementById('frequencyGroup');
        const installmentsHint = document.getElementById('installmentsHint');
        const paymentTimingLabel = document.getElementById('paymentTimingLabel');
        const paymentTimingHint = document.getElementById('paymentTimingHint');
        const firstPaymentDue = document.getElementById('firstPaymentDue');
        const numInstallments = document.getElementById('numInstallments');

        if (isOneTime) {
          paymentTimingLabel.textContent = 'Full repayment due (after loan start)';
          paymentTimingHint.textContent = 'When full repayment is due.';
          numInstallments.value = 1;
          numInstallmentsGroup.style.display = 'none';
          frequencyGroup.style.display = 'none';
          installmentsHint.style.display = 'block';
          if (!firstPaymentDue.value || firstPaymentDue.value === '') {
            firstPaymentDue.value = '1-year';
          }
        } else {
          paymentTimingLabel.textContent = 'First payment due (after loan start)';
          paymentTimingHint.textContent = 'When the first repayment is due.';
          numInstallmentsGroup.style.display = 'block';
          numInstallments.value = 12;
          frequencyGroup.style.display = 'block';
          installmentsHint.style.display = 'none';
          firstPaymentDue.value = '1-year';
        }

        runCalculation();
        updateFairRangePill();
      }

      function debounce(func, delay) {
        let timeoutId;
        return function(...args) {
          clearTimeout(timeoutId);
          timeoutId = setTimeout(() => func.apply(this, args), delay);
        };
      }

      function runCalculation() {
        calculateSchedule();
      }

      const debouncedCalculation = debounce(runCalculation, 300);

      function renderLoanSummary(summary) {
        const container = document.getElementById('loanSummaryContent');
        if (!container) return;

        const lines = [];
        const pStyle = 'margin: 0 0 4px 0; line-height: 1.5;'; // Compact spacing between lines

        lines.push(`<p style="${pStyle}"><strong>Loan amount:</strong> ${formatMoney(summary.loanAmount)}</p>`);

        const repaymentTypeLabel = summary.repaymentType === 'one_time' ? 'One-time payment' : 'Installments';
        lines.push(`<p style="${pStyle}"><strong>Repayment type:</strong> ${repaymentTypeLabel}</p>`);

        if (summary.loanDuration) {
          lines.push(`<p style="${pStyle}"><strong>Loan duration:</strong> ${summary.loanDuration}</p>`);
        }

        if (summary.annualInterestRate === 0) {
          lines.push(`<p style="${pStyle}"><strong>Annual interest rate:</strong> No interest (0%)</p>`);
        } else {
          lines.push(`<p style="${pStyle}"><strong>Annual interest rate:</strong> ${summary.annualInterestRate.toFixed(2)}% per year</p>`);
        }

        const fairnessIcon = fairnessIconSVG('', {width: '16px', height: '16px', display: 'inline-block', verticalAlign: 'middle', marginLeft: '4px'});
        lines.push(`<p style="${pStyle}"><strong>Total interest:</strong> ${formatMoney(summary.totalInterest)} <span class="pf-fairness-icon" title="Fairness Between Friends" style="display: inline-flex; align-items: center; vertical-align: middle;">${fairnessIcon}</span></p>`);
        lines.push(`<p style="${pStyle}"><strong>Total to repay:</strong> ${formatMoney(summary.totalRepayment)} <span class="pf-fairness-icon" title="Fairness Between Friends" style="display: inline-flex; align-items: center; vertical-align: middle;">${fairnessIcon}</span></p>`);

        if (summary.repaymentType === 'installments' && summary.numberOfInstallments > 1) {
          const principalPerInstallment = Math.round(summary.loanAmount / summary.numberOfInstallments);
          lines.push(`<p style="${pStyle}"><strong>Principal per installment:</strong> ~${formatMoney(principalPerInstallment)} (excluding interest)</p>`);
        }

        if (summary.firstDueDate) {
          const label = summary.repaymentType === 'one_time' ? 'Full repayment due' : 'First payment due';
          lines.push(`<p style="margin: 0;"><strong>${label}:</strong> ${summary.firstDueDate}</p>`);
        }

        // Fairness Between Friends footer
        lines.push(`
          <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255, 255, 255, 0.08); font-size: 13px; color: #9ca3af;">
            <p style="margin-bottom: 8px;">
              Amounts marked with <span class="pf-fairness-icon-inline" title="Fairness Between Friends" style="display: inline-flex; align-items: center; vertical-align: middle; margin: 0 2px;">${fairnessIcon}</span> are calculated using the Fairness Between Friends rules.
              <a href="#" id="wizardFairnessToggle" style="color: #34d399; text-decoration: none; border-bottom: 1px solid transparent; transition: border-color 0.2s;" onmouseover="this.style.borderBottomColor='#34d399'" onmouseout="this.style.borderBottomColor='transparent'">How it works</a>
            </p>
            <div id="wizardFairnessExplanation" style="display: none; margin-top: 12px; padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 6px; font-size: 12px; line-height: 1.6; color: #d1d5db;">
              Fairness Between Friends adjusts interest dynamically based on the outstanding balance and the time that has passed. This means paying earlier or more reduces total interest, while paying later or less increases it. Both sides always see the current, fair value of the loan in real time.
            </div>
          </div>
        `);

        container.innerHTML = lines.join('');

        // Toggle Fairness "How it works" explanation
        const fairnessToggle = document.getElementById('wizardFairnessToggle');
        const fairnessExplanation = document.getElementById('wizardFairnessExplanation');

        if (fairnessToggle && fairnessExplanation) {
          fairnessToggle.addEventListener('click', function(e) {
            e.preventDefault();
            if (fairnessExplanation.style.display === 'none') {
              fairnessExplanation.style.display = 'block';
            } else {
              fairnessExplanation.style.display = 'none';
            }
          });
        }
      }

      function calculateSchedule() {
        try {
          const calculatorContainer = document.querySelector('[data-loan-calculator]');
          const loanInputs = window.PayFriendsCalculator.buildLoanInputsFromForm(calculatorContainer);

          if (interestMode === 'no-interest') {
            loanInputs.annualInterestRate = 0;
          }

          const principalValue = document.getElementById('principal').value.trim();
          const loanAmount = window.PayFriendsCalculator.parseMoney(principalValue);

          if (principalValue === '' || !loanAmount || loanAmount <= 0 || isNaN(loanAmount)) {
            document.getElementById('scheduleBody').innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">Enter loan amount and details to calculate...</td></tr>';
            document.getElementById('scheduleTotals').style.display = 'none';
            wizardCalculatorSchedule = null;
            wizardCalculatorSummary = null;
            return;
          }

          const result = window.PayFriendsCalculator.calculateLoanSchedule(loanInputs);

          const badge = result.effectiveMode === 'preview'
            ? '<span class="badge badge-preview">Preview</span>'
            : '<span class="badge badge-actual">Actual</span>';
          document.getElementById('modeBadge').innerHTML = badge;

          const loanStartText = window.PayFriendsCalculator.getLoanStartLabelWithContext(
            loanInputs.explicitLoanStartDate,
            result.effectiveMode,
            loanInputs.loanStartMode
          );

          const loanDuration = window.PayFriendsCalculator.calculateLoanDuration(
            result.rows,
            loanInputs.explicitLoanStartDate,
            result.effectiveMode
          );

          // Update the configuration card with loan timing info
          const configLoanTiming = document.getElementById('config-loan-timing');
          const configLoanStart = document.getElementById('config-loan-start');
          const configLoanDuration = document.getElementById('config-loan-duration');

          if (configLoanTiming && configLoanStart && configLoanDuration) {
            configLoanStart.innerHTML = `Loan start: <span style="color: #34d399;">${loanStartText}</span>`;
            if (loanDuration) {
              configLoanDuration.innerHTML = `Loan duration: <span style="color: #34d399;">${loanDuration}</span>`;
              configLoanDuration.style.display = 'block';
            } else {
              configLoanDuration.style.display = 'none';
            }
            configLoanTiming.style.display = 'block';
          }

          const tbody = document.getElementById('scheduleBody');
          tbody.innerHTML = '';

          result.rows.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class="col-index">${row.index}</td>
              <td class="col-due-date">${row.label}</td>
              <td class="align-right col-principal">${formatMoney(row.principal)}</td>
              <td class="align-right col-interest">${formatMoney(row.interest)}</td>
              <td class="align-right col-total-payment" style="font-weight: 600;">${formatMoney(row.totalPayment)}</td>
              <td class="align-right col-balance">${formatMoney(row.balance)}</td>
            `;
            tbody.appendChild(tr);
          });

          document.getElementById('scheduleTotals').style.display = 'table-footer-group';
          document.getElementById('footerPrincipal').textContent = formatMoney(result.totals.principal);
          document.getElementById('footerInterest').textContent = formatMoney(result.totals.interest);
          document.getElementById('footerTotal').textContent = formatMoney(result.totals.totalRepayment);

          const summary = window.PayFriendsCalculator.calculateLoanSummary(loanInputs, result);
          renderLoanSummary(summary);

          // Store results for wizard
          wizardCalculatorSchedule = result;
          wizardCalculatorSummary = summary;

        } catch (error) {
          console.error('Calculation error:', error);
          document.getElementById('loanSummaryContent').innerHTML =
            '<p style="color: #ef4444;">Error calculating loan schedule. Please check your inputs.</p>';
        }
      }

      function updateLoanAmountHighlight() {
        const input = document.getElementById('principal');
        if (!input) return;

        const value = input.value.trim();
        if (value === '') {
          input.classList.add('loan-amount-empty');
        } else {
          input.classList.remove('loan-amount-empty');
        }
      }

      // Event listeners
      document.getElementById('principal').addEventListener('input', () => {
        updateLoanAmountHighlight();
        debouncedCalculation();
        updateFairRangePill();
      });

      document.getElementById('principal').addEventListener('blur', function() {
        const trimmed = this.value.trim();
        if (trimmed !== '') {
          const num = window.PayFriendsCalculator.parseMoney(trimmed);
          if (num > 0) {
            this.value = window.PayFriendsCalculator.formatMoneyInput(num);
          }
        }
      });

      document.getElementById('interest').addEventListener('input', () => {
        debouncedCalculation();
        updateFairRangePill();
      });

      document.getElementById('mode-interest').addEventListener('click', () => setInterestMode('interest'));
      document.getElementById('mode-no-interest').addEventListener('click', () => setInterestMode('no-interest'));
      document.getElementById('fair-range-pill').addEventListener('click', toggleFairRangeExplanation);
      document.getElementById('loanStartMode').addEventListener('change', runCalculation);
      document.getElementById('repaymentType').addEventListener('change', updateRepaymentTypeUI);

      document.getElementById('firstPaymentDue').addEventListener('change', () => {
        runCalculation();
        updateFairRangePill();
      });

      document.getElementById('frequency').addEventListener('change', runCalculation);

      document.getElementById('numInstallments').addEventListener('input', () => {
        debouncedCalculation();
        updateFairRangePill();
      });

      document.getElementById('loanStartMode').addEventListener('change', function() {
        const loanStartDateGroup = document.getElementById('loanStartDateGroup');
        const loanStartDateInput = document.getElementById('loanStartDate');
        if (this.value === 'pick-date') {
          loanStartDateGroup.classList.remove('hidden');
        } else {
          loanStartDateGroup.classList.add('hidden');
          loanStartDateInput.value = '';
        }
      });

      document.getElementById('firstPaymentDue').addEventListener('change', function() {
        const firstPaymentDateGroup = document.getElementById('firstPaymentDateGroup');
        const firstPaymentDateInput = document.getElementById('firstPaymentDate');
        if (this.value === 'pick-date') {
          firstPaymentDateGroup.classList.remove('hidden');
        } else {
          firstPaymentDateGroup.classList.add('hidden');
          firstPaymentDateInput.value = '';
        }
      });

      document.getElementById('loanStartDate').addEventListener('change', runCalculation);
      document.getElementById('firstPaymentDate').addEventListener('change', runCalculation);

      // Initialize
      document.getElementById('repaymentType').value = 'one_time';
      document.getElementById('firstPaymentDue').value = '1-year';
      updateRepaymentTypeUI();
      updateFairRangePill();
      updateLoanAmountHighlight();
    }

    /**
     * Save calculator results and proceed to next step (Interest)
     */
    function saveCalculatorAndContinue() {
      // Validate that calculator has been used and has valid results
      if (!wizardCalculatorSchedule || !wizardCalculatorSummary) {
        document.getElementById('step2-status').textContent = 'Please configure the loan terms and wait for the calculation to complete.';
        document.getElementById('step2-status').style.color = '#ef4444';
        return;
      }

      const principalValue = document.getElementById('principal').value.trim();
      const loanAmount = window.PayFriendsCalculator.parseMoney(principalValue);

      if (!loanAmount || loanAmount <= 0) {
        document.getElementById('step2-status').textContent = 'Please enter a valid loan amount.';
        document.getElementById('step2-status').style.color = '#ef4444';
        return;
      }

      // Extract values from calculator
      const repaymentType = document.getElementById('repaymentType').value;
      const numberOfInstallments = parseInt(document.getElementById('numInstallments').value);
      const paymentFrequency = document.getElementById('frequency').value;
      const loanStartMode = document.getElementById('loanStartMode').value;
      const loanStartDate = document.getElementById('loanStartDate').value;
      const firstPaymentDue = document.getElementById('firstPaymentDue').value;
      const firstPaymentDate = document.getElementById('firstPaymentDate').value;

      // Store in wizard data
      wizardData.amount = loanAmount / 100; // Convert cents to euros
      wizardData.repaymentType = repaymentType;
      wizardData.moneySentOption = loanStartMode;
      wizardData.moneySentDate = loanStartDate;

      // Store schedule and summary for later use
      wizardData.calculatedSchedule = wizardCalculatorSchedule;
      wizardData.calculatedSummary = wizardCalculatorSummary;

      // Extract actual dates from calculator schedule rows
      // The calculator produces exact dates in the schedule, use those as the source of truth
      if (wizardCalculatorSchedule && wizardCalculatorSchedule.rows && wizardCalculatorSchedule.rows.length > 0) {
        const firstRow = wizardCalculatorSchedule.rows[0];
        const lastRow = wizardCalculatorSchedule.rows[wizardCalculatorSchedule.rows.length - 1];

        console.log('=== DEBUG: saveCalculatorAndContinue - Extracting Dates ===');
        console.log('Schedule rows count:', wizardCalculatorSchedule.rows.length);
        console.log('First row:', firstRow);
        console.log('First row dueDate:', firstRow.dueDate);
        console.log('First row dueDate type:', typeof firstRow.dueDate);
        console.log('First row dueDate instanceof Date:', firstRow.dueDate instanceof Date);
        console.log('Last row:', lastRow);
        console.log('Last row dueDate:', lastRow.dueDate);
        console.log('Repayment type:', repaymentType);

        // Helper to convert Date object or date string to YYYY-MM-DD
        // Also handles parsing relative date labels when date is null (preview mode)
        function formatDateYMD(date, labelFallback, loanStartDate) {
          console.log('formatDateYMD called with:', date, 'Type:', typeof date, 'instanceof Date:', date instanceof Date);
          console.log('labelFallback:', labelFallback, 'loanStartDate:', loanStartDate);

          // If date is null but we have a label (preview mode), calculate from label
          if (!date && labelFallback) {
            console.log('formatDateYMD: date is null, attempting to parse from label');

            // Use today as loan start if not specified (preview mode default behavior)
            const baseDate = loanStartDate ? new Date(loanStartDate) : new Date();
            baseDate.setHours(0, 0, 0, 0);
            console.log('formatDateYMD: using base date:', baseDate);

            // Parse relative labels like "1 year after loan start", "6 months after loan start", etc.
            const yearsMatch = labelFallback.match(/(\d+)\s+years?\s+after/);
            const monthsMatch = labelFallback.match(/(\d+)\s+months?\s+after/);
            const daysMatch = labelFallback.match(/(\d+)\s+days?\s+after/);
            const weekMatch = labelFallback.match(/(\d+)\s+weeks?\s+after/);

            let calculatedDate = null;
            if (yearsMatch) {
              const years = parseInt(yearsMatch[1]);
              calculatedDate = window.PayFriendsCalculator.addYears(baseDate, years);
              console.log(`formatDateYMD: parsed ${years} years, calculated date:`, calculatedDate);
            } else if (monthsMatch) {
              const months = parseInt(monthsMatch[1]);
              calculatedDate = window.PayFriendsCalculator.addMonths(baseDate, months);
              console.log(`formatDateYMD: parsed ${months} months, calculated date:`, calculatedDate);
            } else if (weekMatch) {
              const weeks = parseInt(weekMatch[1]);
              calculatedDate = window.PayFriendsCalculator.addDays(baseDate, weeks * 7);
              console.log(`formatDateYMD: parsed ${weeks} weeks, calculated date:`, calculatedDate);
            } else if (daysMatch) {
              const days = parseInt(daysMatch[1]);
              calculatedDate = window.PayFriendsCalculator.addDays(baseDate, days);
              console.log(`formatDateYMD: parsed ${days} days, calculated date:`, calculatedDate);
            } else if (labelFallback.includes('On loan start')) {
              calculatedDate = baseDate;
              console.log('formatDateYMD: parsed "On loan start", using base date');
            }

            if (calculatedDate) {
              date = calculatedDate;
            }
          }

          if (!date) {
            console.log('formatDateYMD returning null - no date provided and could not parse label');
            return null;
          }

          // If it's already a string in YYYY-MM-DD format, return as-is
          if (typeof date === 'string') {
            if (/^\d{4}-\d{2}-\d{2}$/.test(date)) {
              console.log('formatDateYMD: date already in YYYY-MM-DD format:', date);
              return date;
            }
            // Try to parse string as date
            console.log('formatDateYMD: attempting to parse string as date');
            date = new Date(date);
          }

          // Now it should be a Date object
          if (!(date instanceof Date) || isNaN(date.getTime())) {
            console.log('formatDateYMD returning null - invalid date after parsing');
            return null;
          }

          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          const formatted = `${year}-${month}-${day}`;
          console.log('formatDateYMD formatted result:', formatted);
          return formatted;
        }

        if (repaymentType === 'one_time') {
          // For one-time, there's only one payment date
          // Pass label as fallback for preview mode, and loan start date for calculation
          const onlyDueDate = formatDateYMD(firstRow.dueDate, firstRow.label, loanStartDate);
          console.log('One-time: onlyDueDate =', onlyDueDate);
          wizardData.installmentCount = 1;
          wizardData.oneTimeDueOption = firstPaymentDue;
          wizardData.dueDate = onlyDueDate;
          wizardData.finalDueDate = onlyDueDate; // Same as dueDate for one-time
          console.log('One-time: Set wizardData.dueDate =', wizardData.dueDate);
        } else {
          // For installments, save first and final payment dates from schedule
          // Pass labels as fallback for preview mode, and loan start date for calculation
          const firstDueDate = formatDateYMD(firstRow.dueDate, firstRow.label, loanStartDate);
          const finalDueDate = formatDateYMD(lastRow.dueDate, lastRow.label, loanStartDate);
          console.log('Installments: firstDueDate =', firstDueDate);
          console.log('Installments: finalDueDate =', finalDueDate);

          wizardData.installmentCount = numberOfInstallments;
          wizardData.paymentFrequency = paymentFrequency;
          wizardData.firstPaymentOption = firstPaymentDue;
          wizardData.firstPaymentDate = firstDueDate;
          wizardData.finalDueDate = finalDueDate;
          // Backend expects dueDate to be the final due date for installments
          wizardData.dueDate = finalDueDate;
          console.log('Installments: Set wizardData.dueDate =', wizardData.dueDate);
        }
      } else {
        // Fallback if calculator didn't produce schedule (shouldn't happen)
        console.log('=== WARNING: Calculator schedule missing or empty ===');
        console.log('wizardCalculatorSchedule:', wizardCalculatorSchedule);
        console.log('Has rows?:', wizardCalculatorSchedule?.rows);
        console.log('Rows length?:', wizardCalculatorSchedule?.rows?.length);

        if (repaymentType === 'one_time') {
          wizardData.installmentCount = 1;
          wizardData.oneTimeDueOption = firstPaymentDue;
          wizardData.dueDate = firstPaymentDate || null;
          console.log('Fallback: Set wizardData.dueDate =', wizardData.dueDate);
        } else {
          wizardData.installmentCount = numberOfInstallments;
          wizardData.paymentFrequency = paymentFrequency;
          wizardData.firstPaymentOption = firstPaymentDue;
          wizardData.firstPaymentDate = firstPaymentDate;
          console.log('Fallback: Set wizardData.firstPaymentDate =', wizardData.firstPaymentDate);
          console.log('Fallback: wizardData.dueDate NOT SET (missing for installments!)');
        }
      }

      // Clear status and proceed
      document.getElementById('step2-status').textContent = '';

      // Interest is now fully handled in the calculator, so proceed directly to Payments
      goToStep(3);
    }

    /**
     * Calculate fair range for wizard (helper function)
     */
    function calculateFairRangeForWizard() {
      const loanAmount = wizardData.amount * 100; // convert back to cents
      const repaymentType = wizardData.repaymentType;
      const numberOfInstallments = wizardData.installmentCount || 1;

      let minRate = 4;
      let maxRate = 7;

      if (loanAmount > 0) {
        if (loanAmount > 10000 * 100) {
          minRate += 1;
          maxRate += 1;
        } else if (loanAmount < 2000 * 100) {
          minRate = Math.max(3, minRate - 1);
          maxRate = Math.max(5, maxRate - 1);
        }
      }

      // Estimate duration from summary if available
      if (wizardData.calculatedSummary && wizardData.calculatedSummary.loanDuration) {
        const durationStr = wizardData.calculatedSummary.loanDuration.toLowerCase();
        if (durationStr.includes('year')) {
          const years = parseInt(durationStr);
          if (years > 2) {
            minRate += 1;
            maxRate += 1;
          }
        } else if (durationStr.includes('month')) {
          const months = parseInt(durationStr);
          if (months > 24) {
            minRate += 1;
            maxRate += 1;
          } else if (months < 6) {
            minRate = Math.max(3, minRate - 1);
            maxRate = Math.max(5, maxRate - 1);
          }
        }
      }

      if (repaymentType === 'installments' && numberOfInstallments >= 12) {
        maxRate = Math.max(5, maxRate - 1);
      }

      return { min: minRate, max: maxRate };
    }

    function goToInterest() {
      if (!validateStep2()) return;

      // Calculate recommended interest rate based on duration and fair range
      const amount = wizardData.amount;
      let durationInMonths;

      if (wizardData.repaymentType === 'installments') {
        // Convert plan duration to months
        const planLength = wizardData.planLength;
        const planUnit = wizardData.planUnit;

        if (planUnit === 'months') {
          durationInMonths = planLength;
        } else if (planUnit === 'years') {
          durationInMonths = planLength * 12;
        } else if (planUnit === 'weeks') {
          durationInMonths = planLength / 4.33; // approximate weeks to months
        } else if (planUnit === 'days') {
          durationInMonths = planLength / 30; // approximate days to months
        }
      } else {
        durationInMonths = Math.ceil((new Date(wizardData.dueDate) - new Date()) / (1000 * 60 * 60 * 24 * 30));
      }

      // Recommend rate based on fair range midpoint
      let recommendedRate;
      if (durationInMonths <= 3) {
        recommendedRate = 4;
      } else if (durationInMonths <= 12) {
        recommendedRate = 5;
      } else if (durationInMonths <= 24) {
        recommendedRate = 7;
      } else {
        recommendedRate = 8;
      }

      // Set the interest rate and trigger calculation
      document.getElementById('interest-rate').value = recommendedRate;
      wizardData.hasInterest = true;
      wizardData.interestMode = 'rate';

      goToStep(3);

      // Initialize interest mode toggle to "rate" mode
      setInterestMode('rate');
      calculateInterest();
    }

    // Toggle no interest checkbox
    // Store the last user-entered interest rate
    let lastInterestRate = null;

    // Set interest mode (rate or none)
    function setInterestMode(mode) {
      const modeRateBtn = document.getElementById('mode-rate');
      const modeNoneBtn = document.getElementById('mode-none');
      const interestRateInput = document.getElementById('interest-rate');

      if (mode === 'rate') {
        // Style toggle buttons
        modeRateBtn.style.background = 'var(--accent)';
        modeRateBtn.style.color = '#000';
        modeRateBtn.style.fontWeight = '600';
        modeNoneBtn.style.background = 'transparent';
        modeNoneBtn.style.color = 'var(--text)';
        modeNoneBtn.style.fontWeight = '500';

        // Restore last interest rate or use default
        if (lastInterestRate !== null && lastInterestRate > 0) {
          interestRateInput.value = lastInterestRate;
        } else if (!interestRateInput.value || interestRateInput.value === '0') {
          // Use center of fair range as default
          const fairRangeMin = wizardData.fairRangeMin || 4;
          const fairRangeMax = wizardData.fairRangeMax || 7;
          interestRateInput.value = Math.round((fairRangeMin + fairRangeMax) / 2);
        }

        wizardData.hasInterest = true;
        wizardData.interestMode = 'rate';
      } else {
        // Style toggle buttons
        modeNoneBtn.style.background = 'var(--accent)';
        modeNoneBtn.style.color = '#000';
        modeNoneBtn.style.fontWeight = '600';
        modeRateBtn.style.background = 'transparent';
        modeRateBtn.style.color = 'var(--text)';
        modeRateBtn.style.fontWeight = '500';

        // Save current rate and set to 0
        const currentRate = parseFloat(interestRateInput.value);
        if (currentRate > 0) {
          lastInterestRate = currentRate;
        }

        wizardData.hasInterest = false;
        wizardData.interestMode = 'none';
      }

      // Recalculate with new mode
      calculateInterest();
    }

    // Handle interest input with clamping
    function handleInterestInput() {
      const interestRateInput = document.getElementById('interest-rate');
      let value = parseFloat(interestRateInput.value);

      // Clamp to 0-99
      if (value < 0) {
        value = 0;
        interestRateInput.value = 0;
      } else if (value > 99) {
        value = 99;
        interestRateInput.value = 99;
      }

      // Save the value if > 0
      if (value > 0) {
        lastInterestRate = value;
      }

      // Recalculate
      calculateInterest();
    }

    // Toggle fairness explanation panel
    function toggleFairnessExplanation() {
      const panel = document.getElementById('fairness-explanation');
      const badge = document.getElementById('interest-rate-badge');

      if (panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        badge.setAttribute('aria-expanded', 'true');
      } else {
        panel.classList.add('hidden');
        badge.setAttribute('aria-expanded', 'false');
      }
    }

    // Toggle breakdown visibility
    function toggleBreakdown() {
      const breakdown = document.getElementById('interest-breakdown');
      const toggleText = document.getElementById('breakdown-toggle-text');

      if (breakdown.classList.contains('hidden')) {
        breakdown.classList.remove('hidden');
        toggleText.textContent = 'Hide payment breakdown';
      } else {
        breakdown.classList.add('hidden');
        toggleText.textContent = 'Show payment breakdown';
      }
    }

    // Helper function to compute duration between two dates for one-time loans
    function computeOneTimeLoanDuration(startDate, dueDate, oneTimeDueOption) {
      // If user selected a preset duration, extract it from the option
      if (oneTimeDueOption && oneTimeDueOption !== 'pick_date') {
        if (oneTimeDueOption === 'in_1_week') return '1 week';
        if (oneTimeDueOption === 'in_1_month') return '1 month';
        if (oneTimeDueOption === 'in_3_months') return '3 months';
        if (oneTimeDueOption === 'in_6_months') return '6 months';
        if (oneTimeDueOption === 'in_1_year') return '1 year';
      }

      // Otherwise, compute duration from dates
      const start = new Date(startDate);
      const due = new Date(dueDate);

      // Calculate difference in months
      const yearsDiff = due.getFullYear() - start.getFullYear();
      const monthsDiff = due.getMonth() - start.getMonth();
      const daysDiff = due.getDate() - start.getDate();

      let totalMonths = yearsDiff * 12 + monthsDiff;

      // Adjust for partial months (round to nearest month)
      if (daysDiff >= 15) {
        totalMonths += 1; // Round up if 15+ days into next month
      } else if (daysDiff < 0) {
        totalMonths -= 1; // Subtract if we haven't reached the same day
      }

      // Format the duration
      if (totalMonths === 0) {
        // Less than a month - show in days
        const days = Math.round((due - start) / (1000 * 60 * 60 * 24));
        return days === 1 ? '1 day' : `${days} days`;
      } else if (totalMonths < 12) {
        return totalMonths === 1 ? '1 month' : `${totalMonths} months`;
      } else if (totalMonths % 12 === 0) {
        const years = totalMonths / 12;
        return years === 1 ? '1 year' : `${years} years`;
      } else {
        // Mixed years and months, just show total months
        return `${totalMonths} months`;
      }
    }

    /**
     * Format the due date for display in the Payment breakdown table.
     * For one-time loans when loan start is "on acceptance" and due date is offset-based,
     * returns a relative label like "1 year after loan start".
     * For installments when loan start is "on acceptance", returns a relative label
     * like "X months after loan start" based on the installment schedule.
     * Otherwise, returns the formatted calendar date.
     */
    function formatOneTimeDueDateDisplay(dateISO, installmentIndex) {
      const isOneTime = wizardData.repaymentType === 'one_time';
      const isInstallments = wizardData.repaymentType === 'installments';
      const isOnAcceptance = wizardData.moneySentDate === 'on-acceptance';
      const oneTimeDueOption = wizardData.oneTimeDueOption;
      const isOffsetBased = oneTimeDueOption && oneTimeDueOption !== 'pick_date';

      // Show relative label for one-time loans with "on acceptance" start and offset-based due date
      if (isOneTime && isOnAcceptance && isOffsetBased) {
        // Map oneTimeDueOption values to readable labels
        const labelMap = {
          'in_1_week': '1 week after loan start',
          'in_1_month': '1 month after loan start',
          'in_3_months': '3 months after loan start',
          'in_6_months': '6 months after loan start',
          'in_1_year': '1 year after loan start'
        };
        return labelMap[oneTimeDueOption] || formatScheduleDate(dateISO);
      }

      // Show relative label for installments with "on acceptance" start
      if (isInstallments && isOnAcceptance && installmentIndex !== undefined) {
        // Convert duration to months
        let durationMonths;
        if (wizardData.planUnit === 'months') {
          durationMonths = wizardData.planLength;
        } else if (wizardData.planUnit === 'years') {
          durationMonths = wizardData.planLength * 12;
        } else if (wizardData.planUnit === 'weeks') {
          durationMonths = wizardData.planLength / 4.33; // Approximate
        } else if (wizardData.planUnit === 'days') {
          durationMonths = wizardData.planLength / 30; // Approximate
        }

        const intervalMonths = durationMonths / wizardData.installmentCount;
        const firstOffsetMonths = getFirstPaymentOffsetMonths(wizardData.firstPaymentOption || '1month') || intervalMonths;
        const offsetMonths = firstOffsetMonths + (installmentIndex * intervalMonths);

        // Round to nearest integer for cleaner display
        const roundedOffset = Math.round(offsetMonths);

        if (roundedOffset === 1) {
          return '1 month after loan start';
        } else {
          return `${roundedOffset} months after loan start`;
        }
      }

      // Default: show the actual calendar date
      return formatScheduleDate(dateISO);
    }

    // Calculate interest using fair amortization (equal principal payments)
    function calculateInterest() {
      let interestRate = parseFloat(document.getElementById('interest-rate').value) || 0;
      const principal = wizardData.amount;

      if (!principal || principal <= 0) {
        return;
      }

      // If we're in "no interest" mode, force rate to 0 for calculations
      if (wizardData.interestMode === 'none' || !wizardData.hasInterest) {
        interestRate = 0;
      }

      // Calculate duration in months for fair range and period rate
      let durationInMonths;
      let periodsPerYear = 12;
      let durationLabel = '';

      if (wizardData.repaymentType === 'installments') {
        const planLength = wizardData.planLength;
        const planUnit = wizardData.planUnit;

        if (planUnit === 'months') {
          durationInMonths = planLength;
          periodsPerYear = 12;
          durationLabel = `${planLength} month${planLength > 1 ? 's' : ''}`;
        } else if (planUnit === 'years') {
          durationInMonths = planLength * 12;
          periodsPerYear = 12;
          durationLabel = `${planLength} year${planLength > 1 ? 's' : ''}`;
        } else if (planUnit === 'weeks') {
          durationInMonths = planLength / 4.33;
          periodsPerYear = 52;
          durationLabel = `${planLength} week${planLength > 1 ? 's' : ''}`;
        } else if (planUnit === 'days') {
          durationInMonths = planLength / 30;
          periodsPerYear = 365;
          durationLabel = `${planLength} day${planLength > 1 ? 's' : ''}`;
        }
      } else {
        // For one-time loans, compute duration from loan start to due date
        let startDate;
        if (wizardData.moneySentDate && wizardData.moneySentDate !== 'on-acceptance') {
          startDate = wizardData.moneySentDate;
        } else {
          // Fallback to today if money sent date is not set
          startDate = new Date().toISOString().split('T')[0];
        }

        // Compute duration for display
        durationLabel = computeOneTimeLoanDuration(startDate, wizardData.dueDate, wizardData.oneTimeDueOption);

        // Calculate durationInMonths for fair range calculation (from start to due date)
        const start = new Date(startDate);
        const due = new Date(wizardData.dueDate);
        durationInMonths = Math.ceil((due - start) / (1000 * 60 * 60 * 24 * 30));
        periodsPerYear = 12;
      }

      // Calculate fair range based on duration
      let fairRangeMin, fairRangeMax;
      if (durationInMonths <= 3) {
        fairRangeMin = 3;
        fairRangeMax = 5;
      } else if (durationInMonths <= 12) {
        fairRangeMin = 4;
        fairRangeMax = 7;
      } else if (durationInMonths <= 24) {
        fairRangeMin = 5;
        fairRangeMax = 9;
      } else {
        fairRangeMin = 6;
        fairRangeMax = 10;
      }

      // Store fair range in wizardData for use in mode switching
      wizardData.fairRangeMin = fairRangeMin;
      wizardData.fairRangeMax = fairRangeMax;

      // Update badge based on rate and mode
      const badge = document.getElementById('interest-rate-badge');
      const badgeText = document.getElementById('interest-rate-badge-text');
      const explanationSummary = document.getElementById('fairness-explanation-summary');

      // Check if we're in "no interest" mode
      const isNoInterestMode = wizardData.interestMode === 'none' || (!wizardData.hasInterest && interestRate === 0);

      if (isNoInterestMode) {
        // In "no interest" mode, show neutral badge
        badge.style.display = 'inline-flex';
        badgeText.textContent = 'No interest set';
        badge.style.background = 'rgba(156,163,175,0.15)';
        badge.style.color = '#9ca3af';
        explanationSummary.textContent = `For this amount and duration (${durationLabel.toLowerCase()}), a fair interest range would typically be ${fairRangeMin}–${fairRangeMax}% per year, but you've chosen not to charge interest.`;
      } else if (interestRate === 0) {
        // Rate is 0 but in rate mode
        badge.style.display = 'inline-flex';
        badgeText.textContent = 'No interest (0%)';
        badge.style.background = 'rgba(156,163,175,0.15)';
        badge.style.color = '#9ca3af';
        explanationSummary.textContent = `For this amount and duration (${durationLabel.toLowerCase()}), a fair interest range would typically be ${fairRangeMin}–${fairRangeMax}% per year.`;
      } else {
        badge.style.display = 'inline-flex';
        if (interestRate >= fairRangeMin && interestRate <= fairRangeMax) {
          badgeText.textContent = `Fair range (${fairRangeMin}–${fairRangeMax}%)`;
          badge.style.background = 'rgba(61,220,151,0.15)';
          badge.style.color = 'var(--accent)';
          explanationSummary.textContent = `Together, these factors suggest a fair range like ${fairRangeMin}–${fairRangeMax}% for this loan. Your rate of ${interestRate}% falls within this range.`;
        } else if (interestRate > fairRangeMax) {
          badgeText.textContent = `Above typical (>${fairRangeMax}%)`;
          badge.style.background = 'rgba(249,115,22,0.15)';
          badge.style.color = '#f97316';
          explanationSummary.textContent = `Together, these factors suggest a fair range like ${fairRangeMin}–${fairRangeMax}% for this loan. Your rate of ${interestRate}% is higher than typical.`;
        } else {
          badgeText.textContent = `Generous (<${fairRangeMin}%)`;
          badge.style.background = 'rgba(59,130,246,0.15)';
          badge.style.color = '#3b82f6';
          explanationSummary.textContent = `Together, these factors suggest a fair range like ${fairRangeMin}–${fairRangeMax}% for this loan. Your rate of ${interestRate}% is quite generous.`;
        }
      }

      // Fair interest calculation using equal principal payments with daily interest
      const n = wizardData.repaymentType === 'installments' ? wizardData.installmentCount : 1;
      const annualRate = interestRate / 100;
      const dailyRate = annualRate / 365; // Use 365 days per year for daily rate
      const principalPerInstallment = principal / n;

      let totalInterest = 0;
      const schedule = [];

      // Determine start date (money sent date or first payment date for calculations)
      let startDate;
      if (wizardData.moneySentDate && wizardData.moneySentDate !== 'on-acceptance') {
        startDate = new Date(wizardData.moneySentDate);
      } else {
        // Fallback to today if money sent date is not set
        startDate = new Date();
        startDate.setHours(0, 0, 0, 0);
      }

      // Generate payment dates
      let paymentDates = [];
      if (wizardData.repaymentType === 'installments') {
        // For installments with known start date, use month-based calculation
        if (wizardData.moneySentDate && wizardData.moneySentDate !== 'on-acceptance') {
          // Convert duration to months
          let durationMonths;
          if (wizardData.planUnit === 'months') {
            durationMonths = wizardData.planLength;
          } else if (wizardData.planUnit === 'years') {
            durationMonths = wizardData.planLength * 12;
          } else if (wizardData.planUnit === 'weeks') {
            durationMonths = wizardData.planLength / 4.33; // Approximate
          } else if (wizardData.planUnit === 'days') {
            durationMonths = wizardData.planLength / 30; // Approximate
          }

          paymentDates = generateInstallmentPaymentDates({
            loanStartDate: wizardData.moneySentDate,
            durationMonths: durationMonths,
            numberOfPayments: n,
            firstPaymentOption: wizardData.firstPaymentOption || '1month',
            firstPaymentDate: wizardData.firstPaymentDate
          });

          // Update wizardData with calculated dates
          wizardData.firstPaymentDate = paymentDates[0].toISOString().split('T')[0];
          wizardData.finalDueDate = paymentDates[paymentDates.length - 1].toISOString().split('T')[0];
        } else {
          // For "on acceptance" loans, we still need dates for interest calculation
          // Use frequency-based calculation as fallback
          const dateResult = generatePaymentDates({
            transferDate: startDate,
            firstDueDate: wizardData.firstPaymentDate,
            frequency: wizardData.paymentFrequency,
            count: n
          });
          paymentDates = dateResult.paymentDates;
        }
      } else if (wizardData.repaymentType === 'one_time' && wizardData.dueDate) {
        paymentDates = [new Date(wizardData.dueDate)];
      }

      let previousDate = startDate;

      for (let i = 1; i <= n; i++) {
        const outstandingBefore = principal - principalPerInstallment * (i - 1);

        // Calculate interest based on actual days
        let interestForPeriod;
        if (paymentDates.length >= i) {
          const currentPaymentDate = paymentDates[i - 1];
          const daysBetween = Math.round((currentPaymentDate - previousDate) / (1000 * 60 * 60 * 24));
          interestForPeriod = outstandingBefore * dailyRate * daysBetween;
          previousDate = currentPaymentDate;
        } else {
          // Fallback to period rate if dates not available (shouldn't happen with new system)
          const periodRate = annualRate / periodsPerYear;
          interestForPeriod = outstandingBefore * periodRate;
        }

        const payment = principalPerInstallment + interestForPeriod;
        const remainingAfter = outstandingBefore - principalPerInstallment;

        totalInterest += interestForPeriod;

        schedule.push({
          period: i,
          payment: payment,
          principal: principalPerInstallment,
          interest: interestForPeriod,
          remaining: remainingAfter > 0.01 ? remainingAfter : 0,
          dueDate: paymentDates[i - 1] || null
        });
      }

      const totalRepayAmount = principal + totalInterest;

      wizardData.interestRate = interestRate;
      wizardData.totalInterest = totalInterest;
      wizardData.totalRepayAmount = totalRepayAmount;

      // Update summary card (use formatEuro2 for 2-decimal nl-NL formatting)
      document.getElementById('summary-loan-amount').textContent = formatEuro2(principal);

      // For one-time loans, show repayment type and computed duration separately
      if (wizardData.repaymentType === 'one_time') {
        document.getElementById('summary-repayment-type-row').style.display = 'flex';
        document.getElementById('summary-repayment-type').textContent = 'One-time payment';
        document.getElementById('summary-duration').textContent = durationLabel;
      } else {
        // For installments, hide repayment type row and show duration only
        document.getElementById('summary-repayment-type-row').style.display = 'none';
        document.getElementById('summary-duration').textContent = durationLabel;
      }

      document.getElementById('summary-interest-rate').textContent = interestRate;
      document.getElementById('total-interest-display').textContent = formatEuro2(totalInterest);
      document.getElementById('total-repay-display').textContent = formatEuro2(totalRepayAmount);

      // Generate breakdown table using shared schedule utility
      const isInstallments = wizardData.repaymentType === 'installments';

      // Update table header based on repayment type
      const thead = document.getElementById('breakdown-thead');
      thead.innerHTML = '';
      thead.innerHTML = `
        <th style="text-align:left; padding:8px 4px">Due date</th>
        <th style="text-align:right; padding:8px 4px">Loan repayment</th>
        <th style="text-align:right; padding:8px 4px">Interest</th>
        <th style="text-align:right; padding:8px 4px">Payment total</th>
        ${isInstallments ? '<th style="text-align:right; padding:8px 4px">Outstanding</th>' : ''}
      `;

      const tbody = document.getElementById('breakdown-tbody');
      tbody.innerHTML = '';

      // Use shared buildRepaymentSchedule function
      const sharedSchedule = buildRepaymentSchedule({
        principalCents: principal * 100,
        aprPercent: interestRate,
        count: n,
        paymentDates: paymentDates,
        startDate: startDate
      });

      // Render rows
      sharedSchedule.rows.forEach((row, index) => {
        const tr = document.createElement('tr');
        const rowStyle = index % 2 === 0 ? 'background:rgba(12,16,21,0.3)' : 'background:rgba(10,13,17,0.3)';
        tr.style = rowStyle + '; border-bottom:1px solid rgba(255,255,255,0.05)';
        tr.innerHTML = `
          <td style="padding:8px 4px">${formatOneTimeDueDateDisplay(row.dateISO, index)}</td>
          <td style="text-align:right; padding:8px 4px">${formatCurrency2(row.principalCents)}</td>
          <td style="text-align:right; padding:8px 4px">${formatCurrency2(row.interestCents)}</td>
          <td style="text-align:right; padding:8px 4px; font-weight:600">${formatCurrency2(row.paymentCents)}</td>
          ${isInstallments ? `<td style="text-align:right; padding:8px 4px">${formatCurrency2(row.remainingCents)}</td>` : ''}
        `;
        tbody.appendChild(tr);
      });
    }

    // Navigate to payment preferences
    function goToPayments() {
      // Update interest data if no interest selected
      if (!wizardData.hasInterest || wizardData.interestMode === 'none') {
        wizardData.interestRate = 0;
        wizardData.totalInterest = 0;
        wizardData.totalRepayAmount = wizardData.amount;
      }

      goToStep(3);

      // Update worst case scenario visibility based on loan amount
      updateWorstCaseVisibility();
    }

    // Navigate to summary
    function goToSummary() {
      // Get selected payment methods
      const selectedMethods = Array.from(document.querySelectorAll('.payment-method-checkbox:checked')).map(cb => cb.value);

      // Validate at least one payment method is selected
      if (selectedMethods.length === 0) {
        document.getElementById('step3-status').textContent = 'Please select at least one payment method';
        return;
      }

      // Build payment methods JSON with details
      const paymentMethodsData = [];

      // Validate and collect Bank transfer details
      if (selectedMethods.includes('bank')) {
        const bankInstructions = document.getElementById('bank-instructions').value.trim();
        if (!bankInstructions) {
          document.getElementById('step3-status').textContent = 'Please enter bank transfer instructions';
          return;
        }
        paymentMethodsData.push({
          method: 'bank',
          details: bankInstructions,
          status: 'active'
        });
      }

      // Validate and collect PayPal details
      if (selectedMethods.includes('paypal')) {
        const paypalEmail = document.getElementById('paypal-email').value.trim();
        if (!paypalEmail) {
          document.getElementById('step3-status').textContent = 'Please enter PayPal email';
          return;
        }
        paymentMethodsData.push({
          method: 'paypal',
          details: paypalEmail,
          status: 'active'
        });
      }

      // Validate and collect Crypto details
      if (selectedMethods.includes('crypto')) {
        const cryptoInstructions = document.getElementById('crypto-instructions').value.trim();
        if (!cryptoInstructions) {
          document.getElementById('step3-status').textContent = 'Please enter crypto payment instructions';
          return;
        }
        paymentMethodsData.push({
          method: 'crypto',
          details: cryptoInstructions,
          status: 'active'
        });
      }

      // Cash - no details required
      if (selectedMethods.includes('cash')) {
        paymentMethodsData.push({
          method: 'cash',
          details: '',
          status: 'active'
        });
      }

      // Validate and collect Other details
      if (selectedMethods.includes('other')) {
        const otherDescription = document.getElementById('other-payment-description').value.trim();
        if (!otherDescription) {
          document.getElementById('step3-status').textContent = 'Please describe the other payment method';
          return;
        }
        paymentMethodsData.push({
          method: 'other',
          details: otherDescription,
          status: 'active'
        });
      }

      // Store payment methods data
      wizardData.paymentMethods = selectedMethods;
      wizardData.paymentMethodsJson = JSON.stringify(paymentMethodsData);

      // Get reminder settings
      const reminderMode = document.querySelector('input[name="reminder-mode"]:checked').value;
      wizardData.reminderMode = reminderMode;

      if (reminderMode === 'auto') {
        wizardData.reminderOffsets = [-7, -1, 0, 1, 3];
      } else {
        // Get selected custom reminder offsets
        const checkboxes = document.querySelectorAll('.custom-reminder-checkbox:checked');
        if (checkboxes.length === 0) {
          document.getElementById('custom-reminder-error').style.display = 'block';
          document.getElementById('step3-status').textContent = 'Please select at least one reminder';
          return;
        }
        wizardData.reminderOffsets = Array.from(checkboxes).map(cb => parseInt(cb.value));
      }

      wizardData.proofRequired = document.getElementById('proof-required').checked;

      // Only include debt collection clause if amount is >= 6000 EUR
      const amountEur = wizardData.amount || 0;
      if (amountEur >= WORST_CASE_MIN_AMOUNT_EUR) {
        wizardData.debtCollectionClause = document.getElementById('debt-collection-clause').checked;
      } else {
        wizardData.debtCollectionClause = false;
      }

      goToStep(4);
      updateSummary();
    }

    // Toggle expandable sections in summary
    function toggleSection(sectionId) {
      const section = document.getElementById(sectionId);
      const toggleId = sectionId.replace('-section', '-toggle');
      const toggle = document.getElementById(toggleId);

      if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        toggle.textContent = '▲';
      } else {
        section.classList.add('hidden');
        toggle.textContent = '▼';
      }
    }

    // Toggle payment method detail fields
    function togglePaymentMethodDetails() {
      // Bank transfer
      const bankCheckbox = document.querySelector('.payment-method-checkbox[value="bank"]');
      const bankDetails = document.getElementById('bank-details');
      if (bankCheckbox && bankCheckbox.checked) {
        bankDetails.classList.remove('hidden');
      } else {
        bankDetails.classList.add('hidden');
        document.getElementById('bank-instructions').value = '';
      }

      // PayPal
      const paypalCheckbox = document.querySelector('.payment-method-checkbox[value="paypal"]');
      const paypalDetails = document.getElementById('paypal-details');
      if (paypalCheckbox && paypalCheckbox.checked) {
        paypalDetails.classList.remove('hidden');
      } else {
        paypalDetails.classList.add('hidden');
        document.getElementById('paypal-email').value = '';
      }

      // Crypto
      const cryptoCheckbox = document.querySelector('.payment-method-checkbox[value="crypto"]');
      const cryptoDetails = document.getElementById('crypto-details');
      if (cryptoCheckbox && cryptoCheckbox.checked) {
        cryptoDetails.classList.remove('hidden');
      } else {
        cryptoDetails.classList.add('hidden');
        document.getElementById('crypto-instructions').value = '';
      }

      // Other
      const otherCheckbox = document.querySelector('.payment-method-checkbox[value="other"]');
      const otherDetails = document.getElementById('other-details');
      if (otherCheckbox && otherCheckbox.checked) {
        otherDetails.classList.remove('hidden');
      } else {
        otherDetails.classList.add('hidden');
        document.getElementById('other-payment-description').value = '';
      }
    }

    // Handle payment method card clicks
    function setupPaymentMethodCards() {
      const cards = document.querySelectorAll('.payment-method-card');

      cards.forEach(card => {
        const checkbox = card.querySelector('.payment-method-checkbox');
        const value = card.dataset.value;

        // Set initial state
        updateCardVisualState(card, checkbox.checked);

        // Handle clicks
        card.addEventListener('click', (e) => {
          // Prevent default label behavior to avoid double-toggle
          e.preventDefault();

          // Toggle checkbox
          checkbox.checked = !checkbox.checked;

          // Handle special logic for "Any method"
          handlePaymentMethodChange(value, checkbox.checked);
        });

        // Also listen to checkbox change events
        checkbox.addEventListener('change', () => {
          handlePaymentMethodChange(value, checkbox.checked);
        });
      });
    }

    // Handle payment method selection logic
    function handlePaymentMethodChange(changedValue, isChecked) {
      const allCards = document.querySelectorAll('.payment-method-card');

      // Update visual state for all cards
      allCards.forEach(card => {
        const cb = card.querySelector('.payment-method-checkbox');
        updateCardVisualState(card, cb.checked);
      });

      // Show/hide detail fields based on selection
      togglePaymentMethodDetails();

      // Clear any error messages
      document.getElementById('step3-status').textContent = '';
    }

    // Update card visual state (selected/unselected)
    function updateCardVisualState(card, isSelected) {
      if (isSelected) {
        card.classList.add('selected');
      } else {
        card.classList.remove('selected');
      }
    }

    // Toggle reminder mode (auto vs custom)
    function toggleReminderMode() {
      const mode = document.querySelector('input[name="reminder-mode"]:checked').value;
      const customReminders = document.getElementById('custom-reminders');
      const autoCard = document.getElementById('reminder-auto-card');
      const customCard = document.getElementById('reminder-custom-card');

      if (mode === 'custom') {
        customReminders.classList.remove('hidden');
        autoCard.classList.remove('reminder-option-active');
        customCard.classList.add('reminder-option-active');
      } else {
        customReminders.classList.add('hidden');
        autoCard.classList.add('reminder-option-active');
        customCard.classList.remove('reminder-option-active');
        // Hide error if switching away from custom
        document.getElementById('custom-reminder-error').style.display = 'none';
      }
    }

    // Helper function to convert payment frequency label to adjective form for summary text
    function getFrequencyAdjective(frequencyLabel) {
      if (!frequencyLabel) return '';

      // Convert frequency labels like "Every month" to "monthly"
      const label = frequencyLabel.toLowerCase();

      if (label === 'every month') return 'monthly';
      if (label === 'every week (same weekday)') return 'weekly';
      if (label === 'every year') return 'yearly';
      if (label === 'every 7 days (weekly)') return 'weekly';

      // For other frequencies like "Every 2 weeks", "Every 3 months", etc., keep as-is
      // Just remove "Every " prefix and lowercase
      return label.replace(/^every\s+/i, '');
    }

    // Update summary in step 4
    function updateSummary() {
      const lenderName = currentUser?.full_name || currentUser?.email || 'You';
      const borrowerName = wizardData.friendFirstName;
      const description = wizardData.description;

      // USE CALCULATED VALUES FROM STEP 2
      const summary = wizardData.calculatedSummary || {};
      const schedule = wizardData.calculatedSchedule || {};

      // All amounts in summary are already in cents
      const amountCents = summary.loanAmount || Math.round(wizardData.amount * 100);
      const amountFormatted = formatCurrency2(amountCents);
      const interestRate = summary.annualInterestRate || 0;
      const totalInterestCents = summary.totalInterest || 0;
      const totalRepaymentCents = summary.totalRepayment || amountCents;
      const totalRepayFormatted = formatCurrency2(totalRepaymentCents);

      // Get formatted date strings from summary (these are already formatted)
      const firstDueDateStr = summary.firstDueDate || '';
      const lastDueDateStr = summary.lastDueDate || '';

      // Full summary text (3 lines)
      let summaryLine1 = `${lenderName} lends ${amountFormatted} to ${borrowerName} for '${description}'.`;

      let summaryLine2 = '';
      if (wizardData.repaymentType === 'one_time') {
        // For one-time loans, use the firstDueDate from summary
        if (firstDueDateStr) {
          summaryLine2 = `To be repaid in one payment on ${firstDueDateStr}.`;
        } else {
          summaryLine2 = `To be repaid in one payment.`;
        }
      } else {
        // For installments, use the SHORT FORMAT with dynamic loan start suffix
        const numInstallments = summary.numberOfInstallments || wizardData.installmentCount || 1;
        const loanDuration = summary.loanDuration || '';
        const frequencyLabel = summary.paymentFrequencyLabel || '';
        const frequencyAdj = getFrequencyAdjective(frequencyLabel);

        // Clean the duration label - remove any existing start context suffixes
        // loanDuration may contain text like "1 year 11 months after agreement is accepted" or "1 year 11 months after loan start"
        const rawDurationLabel = loanDuration
          .replace(' after agreement is accepted', '')
          .replace(' after loan start', '');

        // Build loan start suffix based only on start type
        let loanStartSuffix = '';
        if (wizardData.moneySentOption === 'on-acceptance' || wizardData.moneySentOption === 'upon_acceptance') {
          loanStartSuffix = ' after agreement is accepted';
        }

        // Build: "To be repaid in {numberOfInstallments} {paymentFrequencyLabel} installments over {loanDurationLabel}{loanStartSuffix}."
        let sentence = `To be repaid in ${numInstallments}`;
        if (frequencyAdj) {
          sentence += ` ${frequencyAdj}`;
        }
        sentence += ` installment${numInstallments === 1 ? '' : 's'}`;
        if (rawDurationLabel) {
          sentence += ` over ${rawDurationLabel}`;
        }
        sentence += loanStartSuffix + '.';
        summaryLine2 = sentence;
      }

      let summaryLine3 = '';
      if (interestRate > 0) {
        summaryLine3 = `Total to repay: ${totalRepayFormatted} (including ${interestRate}% interest per year).`;
      } else {
        summaryLine3 = `Total to repay: ${totalRepayFormatted} (interest-free loan).`;
      }

      // Store calculated values in wizardData for use by other functions
      wizardData.interestRate = interestRate;
      wizardData.totalInterest = totalInterestCents / 100; // convert to euros for compatibility
      wizardData.totalRepayAmount = totalRepaymentCents / 100; // convert to euros for compatibility
      wizardData.loanDurationLabel = summary.loanDuration || '';

      const summaryText = summaryLine1 + '\n' + summaryLine2 + '\n' + summaryLine3;

      document.getElementById('full-summary-text').textContent = summaryText;
      document.getElementById('send-friend-name').textContent = borrowerName;

      // Populate all sections
      populateGeneralDetails();
      populateInterestCalculation();
      populatePaymentsAndReminders();
    }

    // Populate general details section using deterministic renderer
    function populateGeneralDetails() {
      const content = document.getElementById('general-details-content');
      const html = renderSummaryFields(wizardData, currentUser);
      content.innerHTML = html;

      // Inject fairness icons into "Total interest" and "Total to repay" rows
      const rows = content.querySelectorAll('.summary-grid-row');
      rows.forEach(row => {
        const label = row.querySelector('.summary-grid-label');
        const valueSpan = row.querySelector('.summary-grid-value');

        if (label && valueSpan) {
          const labelText = label.textContent.trim();

          // Add heart icon to "Total interest" and "Total to repay" rows
          if (labelText === 'Total interest:' || labelText === 'Total to repay:') {
            // Create icon span
            const iconSpan = document.createElement('span');
            iconSpan.className = 'pf-fairness-icon';
            iconSpan.title = 'Fairness Between Friends';
            iconSpan.style.display = 'inline-flex';
            iconSpan.style.alignItems = 'center';
            iconSpan.style.verticalAlign = 'middle';
            iconSpan.style.marginLeft = '4px';
            iconSpan.innerHTML = fairnessIconSVG('', {width: '16px', height: '16px', display: 'inline-block', verticalAlign: 'middle'});

            // Append icon to value span
            valueSpan.appendChild(iconSpan);
          }
        }
      });

      // Inject icon in the footer text
      const footerIcon = content.parentElement.querySelector('.pf-fairness-icon-inline');
      if (footerIcon) {
        footerIcon.innerHTML = fairnessIconSVG('', {width: '16px', height: '16px', display: 'inline-block', verticalAlign: 'middle'});
      }

      // Set up "How it works" toggle event listener
      const fairnessToggle = document.getElementById('step4FairnessToggle');
      const fairnessExplanation = document.getElementById('step4FairnessExplanation');

      if (fairnessToggle && fairnessExplanation) {
        // Remove any existing listeners to avoid duplicates
        const newToggle = fairnessToggle.cloneNode(true);
        fairnessToggle.parentNode.replaceChild(newToggle, fairnessToggle);

        newToggle.addEventListener('click', function(e) {
          e.preventDefault();
          if (fairnessExplanation.style.display === 'none') {
            fairnessExplanation.style.display = 'block';
          } else {
            fairnessExplanation.style.display = 'none';
          }
        });
      }
    }

    // Populate interest calculation section
    function populateInterestCalculation() {
      const content = document.getElementById('interest-calc-content');

      // USE CALCULATED SCHEDULE FROM STEP 2
      const schedule = wizardData.calculatedSchedule;
      const summary = wizardData.calculatedSummary || {};
      const interestRate = summary.annualInterestRate || 0;

      // For interest-free loans
      if (interestRate === 0) {
        content.innerHTML = `<p style="margin:0; font-size:14px; color:#d1d5db">This is an interest-free loan. Borrower repays only the loan amount.</p>`;
        return;
      }

      // For loans with interest - use calculated schedule directly
      if (!schedule || !schedule.rows || schedule.rows.length === 0) {
        content.innerHTML = `<p style="margin:0; font-size:14px; color:#d1d5db">Schedule not available.</p>`;
        return;
      }

      const totalInterest = formatCurrency2(schedule.totals.interest);
      const totalRepay = formatCurrency2(schedule.totals.totalRepayment);
      const termText = schedule.rows.length === 1 ? 'one payment' : `${schedule.rows.length} repayments`;

      // Build HTML - EXACT COPY OF STEP 2 SCHEDULE TABLE
      let html = `<p style="margin:0 0 16px 0; font-size:14px; color:#d1d5db; line-height:1.5">At ${interestRate}% interest per year over ${termText}, total interest is about ${totalInterest} and total to repay is ${totalRepay}.</p>`;

      // Render the schedule table - matching Step 2 format exactly
      html += `<div style="overflow-x:auto; border:1px solid rgba(255,255,255,0.08); border-radius:8px; background:rgba(12,16,21,0.8)">`;
      html += `<table style="width:100%; border-collapse:collapse; font-size:13px">`;

      // Header - match Step 2 styling
      html += `<thead>`;
      html += `<tr style="background:rgba(31,41,55,0.98)">`;
      html += `<th style="padding:12px; text-align:left; font-weight:600; font-size:12px; text-transform:uppercase; color:#9ca3af; border-bottom:1px solid rgba(255,255,255,0.08); position:sticky; top:0; z-index:10">#</th>`;
      html += `<th style="padding:12px; text-align:left; font-weight:600; font-size:12px; text-transform:uppercase; color:#9ca3af; border-bottom:1px solid rgba(255,255,255,0.08); position:sticky; top:0; z-index:10">Due date</th>`;
      html += `<th class="align-right" style="padding:12px; text-align:right; font-weight:600; font-size:12px; text-transform:uppercase; color:#9ca3af; border-bottom:1px solid rgba(255,255,255,0.08); position:sticky; top:0; z-index:10">Principal</th>`;
      html += `<th class="align-right" style="padding:12px; text-align:right; font-weight:600; font-size:12px; text-transform:uppercase; color:#9ca3af; border-bottom:1px solid rgba(255,255,255,0.08); position:sticky; top:0; z-index:10">Interest</th>`;
      html += `<th class="align-right" style="padding:12px; text-align:right; font-weight:600; font-size:12px; text-transform:uppercase; color:#9ca3af; border-bottom:1px solid rgba(255,255,255,0.08); position:sticky; top:0; z-index:10">Total payment</th>`;
      html += `<th class="align-right" style="padding:12px; text-align:right; font-weight:600; font-size:12px; text-transform:uppercase; color:#9ca3af; border-bottom:1px solid rgba(255,255,255,0.08); position:sticky; top:0; z-index:10">Balance</th>`;
      html += `</tr>`;
      html += `</thead>`;

      // Body - match Step 2 styling
      html += `<tbody>`;
      schedule.rows.forEach((row, index) => {
        const bgStyle = index % 2 === 0 ? '' : 'background:rgba(10,13,17,0.6)';
        html += `<tr style="${bgStyle}">`;
        html += `<td style="padding:12px; border-bottom:1px solid rgba(255,255,255,0.04); color:#d1d5db">${row.index}</td>`;
        html += `<td style="padding:12px; border-bottom:1px solid rgba(255,255,255,0.04); color:#d1d5db">${row.label}</td>`;
        html += `<td class="align-right" style="padding:12px; text-align:right; border-bottom:1px solid rgba(255,255,255,0.04); color:#d1d5db; font-variant-numeric:tabular-nums">${formatCurrency2(row.principal)}</td>`;
        html += `<td class="align-right" style="padding:12px; text-align:right; border-bottom:1px solid rgba(255,255,255,0.04); color:#d1d5db; font-variant-numeric:tabular-nums">${formatCurrency2(row.interest)}</td>`;
        html += `<td class="align-right" style="padding:12px; text-align:right; border-bottom:1px solid rgba(255,255,255,0.04); color:#d1d5db; font-variant-numeric:tabular-nums; font-weight:600">${formatCurrency2(row.totalPayment)}</td>`;
        html += `<td class="align-right" style="padding:12px; text-align:right; border-bottom:1px solid rgba(255,255,255,0.04); color:#d1d5db; font-variant-numeric:tabular-nums">${formatCurrency2(row.balance)}</td>`;
        html += `</tr>`;
      });
      html += `</tbody>`;

      // Footer - match Step 2 styling
      html += `<tfoot>`;
      html += `<tr style="color:#34d399">`;
      html += `<td colspan="2" style="padding:14px 12px; border-top:1px solid rgba(16,185,129,0.6); font-weight:700; font-size:14px; text-transform:uppercase; letter-spacing:0.5px; color:#34d399; text-align:left">Loan totals</td>`;
      html += `<td class="align-right" style="padding:14px 12px; border-top:1px solid rgba(16,185,129,0.6); font-weight:700; font-size:14px; text-align:right; font-variant-numeric:tabular-nums">${formatCurrency2(schedule.totals.principal)}</td>`;
      html += `<td class="align-right" style="padding:14px 12px; border-top:1px solid rgba(16,185,129,0.6); font-weight:700; font-size:14px; text-align:right; font-variant-numeric:tabular-nums">${formatCurrency2(schedule.totals.interest)}</td>`;
      html += `<td class="align-right" style="padding:14px 12px; border-top:1px solid rgba(16,185,129,0.6); font-weight:700; font-size:14px; text-align:right; font-variant-numeric:tabular-nums">${formatCurrency2(schedule.totals.totalRepayment)}</td>`;
      html += `<td></td>`;
      html += `</tr>`;
      html += `</tfoot>`;

      html += `</table>`;
      html += `</div>`;

      content.innerHTML = html;
    }

    // Toggle payment breakdown in summary
    function togglePaymentBreakdownInSummary() {
      const breakdown = document.getElementById('summary-payment-breakdown');
      const toggleText = document.getElementById('summary-breakdown-toggle-text');

      if (breakdown && breakdown.classList.contains('hidden')) {
        breakdown.classList.remove('hidden');
        if (toggleText) toggleText.textContent = 'Hide payment breakdown';
      } else if (breakdown) {
        breakdown.classList.add('hidden');
        if (toggleText) toggleText.textContent = 'Show payment breakdown';
      }
    }

    // Populate payments and reminders section
    function populatePaymentsAndReminders() {
      const content = document.getElementById('payments-reminders-content');

      let html = '<div class="summary-grid">';

      // Payment methods - use same mapping as summary-block.js
      const methods = wizardData.paymentMethods || [];
      const methodLabels = methods.map(m => {
        if (m === 'bank') return 'Bank transfer';
        if (m === 'cash') return 'Cash';
        if (m === 'paypal') return 'PayPal';
        if (m === 'crypto') return 'Crypto';
        if (m === 'any') return 'Any method';
        if (m === 'other') return `Other${wizardData.paymentOtherDescription ? ': ' + wizardData.paymentOtherDescription : ''}`;
        return m;
      });
      const methodsText = methodLabels.length > 0 ? methodLabels.join(', ') : 'Not specified';
      html += `<div class="summary-grid-row">
        <label class="summary-grid-label">Repayment methods:</label>
        <div class="summary-grid-value">
          <div style="color:var(--muted); font-size:14px">${methodsText}</div>
        </div>
      </div>`;

      // Proof required
      html += `<div class="summary-grid-row">
        <label class="summary-grid-label">Require proof of repayment:</label>
        <div class="summary-grid-value">
          <div style="color:var(--muted); font-size:13px; line-height:1.5">${wizardData.proofRequired ? 'Yes — The borrower will be asked to upload proof for each repayment, such as a photo, screenshot or PDF of the transfer or receipt.' : 'No — The borrower can report repayments without uploading proof.'}</div>
        </div>
      </div>`;

      // Reminder schedule (merged mode and schedule into one line)
      let reminderScheduleText = '';
      if (wizardData.reminderMode === 'auto') {
        reminderScheduleText = 'Auto: 7 days before, 1 day before, on the due date. If unpaid: 1 day after, then every 3 days.';
      } else if (wizardData.reminderOffsets && wizardData.reminderOffsets.length > 0) {
        const reminders = wizardData.reminderOffsets.sort((a, b) => a - b).map(offset => {
          if (offset < 0) return `${Math.abs(offset)} days before`;
          if (offset === 0) return 'On the due date';
          if (offset === 3) return 'Every 3 days after';
          if (offset === 7) return 'Every 7 days after';
          return `${offset} day${offset > 1 ? 's' : ''} after`;
        }).join(', ');
        reminderScheduleText = `Custom: ${reminders}`;
      } else {
        reminderScheduleText = 'Not configured';
      }

      html += `<div class="summary-grid-row">
        <label class="summary-grid-label">Reminder schedule:</label>
        <div class="summary-grid-value">
          <div style="color:var(--muted); font-size:14px; line-height:1.6">${reminderScheduleText}</div>
        </div>
      </div>`;

      // Worst case scenario (only show if enabled)
      if (wizardData.debtCollectionClause) {
        html += `<div class="summary-grid-row items-start">
          <label class="summary-grid-label">Worst case scenario:</label>
          <div class="summary-grid-value">
            <div style="color:var(--muted); font-size:13px; line-height:1.6">If the borrower does not repay in time and ignores reminders or cannot agree a new plan with the lender, PayFriends will hand the case to an independent debt collector. Once this happens, the lender is no longer involved in collection — the third party handles it, and any collection fees are for the borrower's account.</div>
          </div>
        </div>`;
      }

      html += '</div>';
      content.innerHTML = html;
    }

    // Populate reminder plan section
    function populateReminderPlan() {
      const content = document.getElementById('reminder-plan-content');

      let html = `<p style="margin:0 0 8px 0; font-size:14px; font-weight:600">${wizardData.reminderMode === 'auto' ? 'Auto reminders' : 'Custom schedule'}:</p>`;

      if (wizardData.reminderMode === 'auto') {
        html += `<p style="margin:0; font-size:13px; color:var(--muted); line-height:1.6">Borrower receives reminders 7 days before, 1 day before, and on the due date. If still unpaid, follow-up reminders are sent 1 day after and every 3 days until payment or renegotiation.</p>`;
      } else {
        html += `<ul style="margin:0; padding-left:20px; font-size:13px; color:var(--muted)">`;
        wizardData.reminderOffsets.sort((a, b) => a - b).forEach(offset => {
          if (offset < 0) {
            html += `<li>${Math.abs(offset)} day${Math.abs(offset) > 1 ? 's' : ''} before due date</li>`;
          } else if (offset === 0) {
            html += `<li>On due date</li>`;
          } else {
            html += `<li>${offset} day${offset > 1 ? 's' : ''} after due date</li>`;
          }
        });
        html += `</ul>`;
      }

      content.innerHTML = html;
    }

    // Populate clauses section
    function populateClauses() {
      const content = document.getElementById('clauses-content');

      // Payment methods
      let methodsText = '';
      if (wizardData.paymentMethods && wizardData.paymentMethods.length > 0) {
        const methodLabels = wizardData.paymentMethods.map(m => {
          if (m === 'bank') return 'Bank transfer';
          if (m === 'cash') return 'Cash';
          if (m === 'paypal') return 'PayPal';
          if (m === 'crypto') return 'Crypto';
          if (m === 'any') return 'Any method';
          if (m === 'other') return `Other (${wizardData.paymentOtherDescription || 'not specified'})`;
          return m;
        });
        methodsText = methodLabels.join(', ');
      } else {
        methodsText = 'Not specified';
      }

      let html = `<div style="margin-bottom:12px">`;
      html += `<div style="font-weight:600; font-size:14px; margin-bottom:4px">Payment methods:</div>`;
      html += `<div style="color:var(--muted); font-size:13px">${methodsText}</div>`;
      html += `</div>`;

      html += `<div style="margin-bottom:16px">`;
      html += `<div style="font-weight:600; font-size:14px; margin-bottom:4px">Proof of payment:</div>`;
      html += `<div style="color:var(--muted); font-size:13px; line-height:1.5">${wizardData.proofRequired ? 'The borrower must upload proof of payment (photo, screenshot, scan or PDF) with every reported payment.' : 'Not required — borrower can report payments without uploading proof.'}</div>`;
      html += `</div>`;

      html += `<div>`;
      html += `<div style="font-weight:600; font-size:14px; margin-bottom:4px">Worst case scenario:</div>`;
      html += `<div style="color:var(--muted); font-size:13px; line-height:1.5">${wizardData.debtCollectionClause ? 'Enabled — If the borrower does not repay, does not propose a new plan, or cannot reach an agreement with the lender, both parties agree that the case may be handed over to an independent debt collector registered in accordance with local law. Any collection fees are for the borrower\'s account.' : 'Disabled — Debt collection clause not enabled.'}</div>`;
      html += `</div>`;

      content.innerHTML = html;
    }

    async function sendInvite() {
      // Use Step 4 status element
      const status = document.getElementById('step4-status');
      status.textContent = 'Creating agreement…';

      try {
        // Helper function to parse amount - handles formats like "4.444,00" or "4444.00"
        function parseAmount(value) {
          if (typeof value === 'number') return value;
          if (!value) return 0;

          // Remove any currency symbols and whitespace
          let cleaned = String(value).replace(/[€$\s]/g, '');

          // If it contains both dot and comma, determine which is decimal separator
          if (cleaned.includes('.') && cleaned.includes(',')) {
            // European format: 4.444,00 -> 4444.00
            cleaned = cleaned.replace(/\./g, '').replace(',', '.');
          } else if (cleaned.includes(',')) {
            // Just comma: 4444,00 -> 4444.00
            cleaned = cleaned.replace(',', '.');
          }
          // Otherwise it's already in correct format

          const parsed = parseFloat(cleaned);
          return isNaN(parsed) ? 0 : parsed;
        }

        // Helper function to parse interest rate - handles formats like "5% per year" or "5"
        function parseInterestRate(value) {
          if (typeof value === 'number') return value;
          if (!value) return 0;

          const cleaned = String(value).replace(/[%]/g, '').replace(/per year/gi, '').trim();
          const parsed = parseFloat(cleaned);
          return isNaN(parsed) ? 0 : parsed;
        }

        // Helper function to format date to ISO string (YYYY-MM-DD)
        function formatDateISO(value) {
          if (!value) return null;

          // If it's already a date object
          if (value instanceof Date) {
            if (isNaN(value.getTime())) return null;
            return value.toISOString().split('T')[0];
          }

          // If it's a string
          const str = String(value).trim();
          if (!str) return null;

          // If already in YYYY-MM-DD format, return as-is
          if (/^\d{4}-\d{2}-\d{2}$/.test(str)) {
            return str;
          }

          // Try to parse it
          const date = new Date(str);
          if (isNaN(date.getTime())) return null;

          return date.toISOString().split('T')[0];
        }

        // ===== CAPTURE REQUIRED FIELDS =====
        // wizardData is now properly populated by Step 2's saveCalculatorAndContinue()
        // which extracts dates directly from the calculator schedule

        console.log('=== DEBUG: sendInvite - Start ===');
        console.log('Full wizardData:', JSON.parse(JSON.stringify(wizardData)));
        console.log('wizardData.dueDate:', wizardData.dueDate);
        console.log('wizardData.finalDueDate:', wizardData.finalDueDate);
        console.log('wizardData.firstPaymentDate:', wizardData.firstPaymentDate);

        // 1. borrowerEmail - REQUIRED
        const borrowerEmail = wizardData.friendEmail;

        // 2. description - REQUIRED
        const description = wizardData.description;

        // 3. amount - REQUIRED (as a number)
        const summary = wizardData.calculatedSummary || {};
        const amountValue = summary.loanAmount
          ? summary.loanAmount / 100  // Convert from cents to euros
          : wizardData.amount;

        // 4. dueDate - REQUIRED (as YYYY-MM-DD string)
        // Step 2 now saves this from calculator schedule rows
        // For one-time: dueDate = the single payment date
        // For installments: dueDate = finalDueDate (last payment)
        const dueDate = wizardData.dueDate;
        console.log('dueDate captured:', dueDate);

        // 5. moneySentDate - can be null for "on acceptance"
        const moneySentDate = formatDateISO(wizardData.moneySentDate);

        // ===== VALIDATE REQUIRED FIELDS =====
        const missingFields = [];
        if (!borrowerEmail) missingFields.push('borrower email');
        if (!description) missingFields.push('description');
        if (!amountValue || amountValue <= 0) missingFields.push('amount');
        if (!dueDate) missingFields.push('due date');

        if (missingFields.length > 0) {
          status.textContent = `❌ Missing required fields: ${missingFields.join(', ')}`;
          console.error('=== Missing Required Fields ===');
          console.error('borrowerEmail:', borrowerEmail);
          console.error('description:', description);
          console.error('amountValue:', amountValue);
          console.error('dueDate:', dueDate);
          console.error('Full wizardData:', wizardData);
          console.error('Calculator summary:', wizardData.calculatedSummary);
          console.error('Calculator schedule:', wizardData.calculatedSchedule);
          return;
        }

        // ===== BUILD PAYLOAD =====

        // Parse interest rate
        const interestRateValue = summary.annualInterestRate !== undefined
          ? summary.annualInterestRate
          : parseInterestRate(wizardData.interestRate);

        // Parse total interest and repay amount
        const totalInterestValue = summary.totalInterest
          ? summary.totalInterest / 100
          : parseAmount(wizardData.totalInterest);

        const totalRepayValue = summary.totalRepayment
          ? summary.totalRepayment / 100
          : parseAmount(wizardData.totalRepayAmount);

        // Send all selected payment methods as comma-separated string
        const paymentMethodsStr = wizardData.paymentMethods && wizardData.paymentMethods.length > 0
          ? wizardData.paymentMethods.join(',')
          : 'bank';

        const payload = {
          friendFirstName: wizardData.friendFirstName || document.getElementById('friend-first-name')?.value,
          borrowerEmail: borrowerEmail,
          phoneNumber: wizardData.phoneNumber,
          description: description,
          amount: amountValue,
          moneySentDate: moneySentDate,
          dueDate: dueDate,
          direction: wizardData.role || 'lend',
          repaymentType: wizardData.repaymentType || 'one_time',
          interestRate: interestRateValue,
          totalInterest: totalInterestValue,
          totalRepayAmount: totalRepayValue,
          paymentPreferenceMethod: paymentMethodsStr,
          paymentMethodsJson: wizardData.paymentMethodsJson,
          paymentOtherDescription: wizardData.paymentOtherDescription,
          reminderMode: wizardData.reminderMode || 'auto',
          reminderOffsets: wizardData.reminderOffsets,
          proofRequired: wizardData.proofRequired !== undefined ? wizardData.proofRequired : true,
          // Only include debt collection clause if amount >= 6000 EUR
          debtCollectionClause: (amountValue >= WORST_CASE_MIN_AMOUNT_EUR) ? wizardData.debtCollectionClause : false
        };

        // Add installment-specific fields if applicable
        if (wizardData.repaymentType === 'installments') {
          payload.planLength = wizardData.planLength;
          payload.planUnit = wizardData.planUnit;
          payload.installmentCount = summary.numberOfInstallments || wizardData.installmentCount;
          payload.installmentAmount = wizardData.installmentAmount;
          payload.firstPaymentDate = formatDateISO(wizardData.firstPaymentDate);
          payload.finalDueDate = formatDateISO(wizardData.finalDueDate);
          payload.paymentFrequency = wizardData.paymentFrequency || 'monthly';
        }

        // Add one-time specific fields if applicable
        if (wizardData.repaymentType === 'one_time') {
          payload.oneTimeDueOption = wizardData.oneTimeDueOption || 'in_1_year';
        }

        // Log the payload for debugging (show all fields clearly)
        console.log('=== Sending Agreement Payload ===');
        console.log('Required fields:');
        console.log('  - borrowerEmail:', payload.borrowerEmail);
        console.log('  - description:', payload.description);
        console.log('  - amount:', payload.amount, '(EUR)');
        console.log('  - dueDate:', payload.dueDate);
        console.log('Full payload:', JSON.stringify(payload, null, 2));

        const res = await fetch('/api/agreements', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json();

        // If backend returns error, show it and stay on Step 4
        if (!res.ok) {
          const errorMessage = data.error || data.message || 'Failed to create agreement';
          status.textContent = '❌ ' + errorMessage;
          console.error('Backend error response:', data);
          console.error('Status code:', res.status);
          return; // Don't navigate to Step 5
        }

        // Success! Store invite URL and navigate to Step 5
        wizardData.inviteUrl = data.inviteUrl;
        wizardData.agreementSent = true;

        // Clear status and navigate to Step 5 (Share)
        status.textContent = '';
        goToStep(5);
        populateShareStep();
        refresh();
        loadMessages();
      } catch (err) {
        // Network or other errors
        status.textContent = '❌ ' + err.message;
        console.error('Error sending invite:', err);
      }
    }

    function copyInviteUrl() {
      const url = wizardData.inviteUrl;
      navigator.clipboard.writeText(url).then(() => {
        document.getElementById('step3-status').textContent = '✅ Copied to clipboard!';
        setTimeout(() => {
          document.getElementById('step3-status').textContent = '';
        }, 2000);
      }).catch(() => {
        document.getElementById('step3-status').textContent = '❌ Failed to copy';
      });
    }

    function populateShareStep() {
      const firstName = wizardData.friendFirstName;
      const email = wizardData.friendEmail;
      const inviteUrl = wizardData.inviteUrl;

      // Update step indicator
      document.getElementById('step-indicator-5').textContent = '5. Share';

      // Populate all name placeholders
      document.getElementById('share-invite-name').textContent = firstName;
      document.getElementById('share-invite-email').textContent = email;
      document.getElementById('share-qr-name').textContent = firstName;
      document.getElementById('share-signup-name').textContent = firstName;
      document.getElementById('share-signup-email').textContent = email;

      // Populate share link input
      document.getElementById('share-link-input').value = inviteUrl;

      // Generate QR code
      const qrContainer = document.getElementById('qr-code-container');
      qrContainer.innerHTML = ''; // Clear any existing QR code
      new QRCode(qrContainer, {
        text: inviteUrl,
        width: 200,
        height: 200,
        colorDark: '#000000',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.H
      });
    }

    function copyShareLink() {
      const url = wizardData.inviteUrl;
      const button = event.target;
      const originalText = button.textContent;

      navigator.clipboard.writeText(url).then(() => {
        button.textContent = '✓ Copied!';
        button.style.background = 'var(--accent)';
        setTimeout(() => {
          button.textContent = originalText;
          button.style.background = '';
        }, 2000);
      }).catch(() => {
        document.getElementById('step5-status').textContent = '❌ Failed to copy';
      });
    }

    function goToDashboard() {
      closeNewAgreement();
      refresh();
    }

    function createAnotherAgreement() {
      resetWizard();
      goToStep(1);
    }

    function resetWizard() {
      wizardData = {
        role: null,
        friendFirstName: '',
        friendEmail: '',
        description: '',
        amount: '',
        repaymentType: 'one_time',
        dueDate: '',
        moneySentDate: '',
        moneySentOption: 'on-acceptance',
        planLength: null,
        planUnit: 'months',
        firstPaymentDate: '',
        installmentCount: null,
        installmentAmount: null,
        finalDueDate: '',
        hasInterest: true,
        interestRate: 0,
        totalInterest: 0,
        totalRepayAmount: 0,
        paymentMethods: ['bank'],
        paymentOtherDescription: '',
        reminderMode: 'auto',
        reminderOffsets: [-7, -1, 0, 1, 3],
        proofRequired: true,
        debtCollectionClause: true,
        inviteUrl: '',
        agreementSent: false
      };

      // Reset Step 1 fields
      document.querySelectorAll('input[name="role"]').forEach(r => r.checked = false);
      document.getElementById('role-card-lend').style.borderColor = 'rgba(255,255,255,0.08)';
      document.getElementById('friend-first-name').value = '';
      document.getElementById('friend-email').value = '';
      document.getElementById('description').value = '';

      // Reset Step 2 fields
      document.getElementById('amount').value = '';
      document.querySelector('input[name="repayment-type"][value="one_time"]').checked = true;
      document.getElementById('due-date').value = '';
      document.getElementById('first-payment-date').value = '';
      document.getElementById('loan-duration-value').value = '12';
      document.getElementById('loan-duration-unit').value = 'months';
      document.getElementById('num-repayments').value = '12';
      document.getElementById('first-payment-option').value = '1month';

      // Reset Step 3 fields
      document.getElementById('interest-rate').value = '';
      wizardData.interestMode = 'rate';
      wizardData.hasInterest = true;
      lastInterestRate = null;

      // Reset Step 4 fields
      document.querySelectorAll('.payment-method-checkbox').forEach(cb => {
        cb.checked = cb.value === 'bank';
      });
      // Update card visual states
      document.querySelectorAll('.payment-method-card').forEach(card => {
        const cb = card.querySelector('.payment-method-checkbox');
        updateCardVisualState(card, cb.checked);
        card.classList.remove('disabled');
      });
      document.getElementById('any-method-helper').classList.add('hidden');
      document.getElementById('other-payment-method').classList.add('hidden');
      document.getElementById('other-payment-description').value = '';
      document.querySelector('input[name="reminder-mode"][value="auto"]').checked = true;
      document.querySelectorAll('.custom-reminder-checkbox').forEach(cb => cb.checked = false);
      document.getElementById('proof-required').checked = true;
      document.getElementById('debt-collection-clause').checked = true;

      // Reset status messages
      document.getElementById('step1-status').textContent = '';
      document.getElementById('step2-status').textContent = '';
      document.getElementById('step3-status').textContent = '';
      document.getElementById('step3-status').textContent = '';
      document.getElementById('step5-status').textContent = '';

      // Reset invite section
      document.getElementById('invite-not-sent').classList.remove('hidden');
      document.getElementById('invite-sent').classList.add('hidden');

      // Reset field visibility
      toggleInstallmentFields();
      toggleReminderMode();

      goToStep(1);
      closeNewAgreement();
    }

    function toggleNewAgreement() {
      const section = document.getElementById('new-agreement-section');
      const listSection = document.getElementById('list-section');
      if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        document.getElementById('new-agreement-btn').style.display = 'none';
        // Hide the My Agreements section when showing the wizard
        if (listSection) {
          listSection.style.display = 'none';
        }
        // Scroll the wizard into view
        setTimeout(() => {
          section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
      } else {
        closeNewAgreement();
      }
    }

    function startNewAgreementFromWelcome() {
      const welcomeCard = document.getElementById('welcome-card');
      const newAgreementSection = document.getElementById('new-agreement-section');
      const listSection = document.getElementById('list-section');

      // Hide the welcome card
      if (welcomeCard) {
        welcomeCard.style.display = 'none';
      }

      // Hide the list section when showing the wizard
      if (listSection) {
        listSection.style.display = 'none';
      }

      // Show the new agreement wizard
      if (newAgreementSection) {
        newAgreementSection.classList.remove('hidden');
        // Scroll the wizard into view
        setTimeout(() => {
          newAgreementSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
      }
    }

    function closeNewAgreement() {
      const newAgreementSection = document.getElementById('new-agreement-section');
      const newAgreementBtn = document.getElementById('new-agreement-btn');
      const welcomeCard = document.getElementById('welcome-card');
      const listSection = document.getElementById('list-section');

      // Hide the new agreement wizard
      if (newAgreementSection) {
        newAgreementSection.classList.add('hidden');
      }

      // Show the new agreement button (if it exists - it won't exist in welcome state)
      if (newAgreementBtn) {
        newAgreementBtn.style.display = 'flex';
      }

      // If there are no agreements, restore the welcome card
      if (welcomeCard && allAgreements.length === 0) {
        welcomeCard.style.display = 'block';
        if (listSection) {
          listSection.style.display = 'none';
        }
      } else {
        // If there are agreements, show the list section
        if (listSection) {
          listSection.style.display = 'block';
        }
      }
    }

    // Fetch current user (now handled by shared header, but we still need to set currentUser)
    async function loadUser() {
      try {
        // Get user from shared header (already loaded)
        currentUser = PayFriendsHeader.getCurrentUser();

        if (!currentUser) {
          window.location.href = '/';
          return;
        }
      } catch (err) {
        console.error('Error loading user:', err);
        window.location.href = '/';
      }
    }

    // Note: Logout is now handled by shared header.js

    // Toggle activity visibility
    function toggleActivity() {
      const activity = document.getElementById('activity-section');
      activity.style.display = activity.style.display === 'none' ? 'block' : 'none';
    }

    // Load activity
    async function loadMessages() {
      try {
        const res = await fetch('/api/messages');
        const data = await res.json();

        const messages = data.messages || [];
        const unreadCount = data.unread_count || 0;

        // Update header with unread count using shared header function
        if (window.PayFriendsHeader) {
          PayFriendsHeader.updateActivityButton(unreadCount);
        }

        // Update timezone note with user's actual timezone
        const timezoneNote = document.getElementById('activity-timezone-note');
        if (timezoneNote && currentUser?.timezone) {
          timezoneNote.textContent = `Times in this history are shown in your local timezone (${currentUser.timezone}).`;
        }

        const activityList = document.getElementById('activity-list');
        if (messages.length === 0) {
          activityList.innerHTML = '<p class="empty-state">No activity yet</p>';
        } else {
          activityList.innerHTML = messages.map(msg => {
            const userTimezone = currentUser?.timezone;
            const timestamp = formatTimestamp(msg.created_at, userTimezone);
            const relativeTime = timeAgo(msg.created_at);
            const isUnread = !msg.read_at;

            // Determine activity text based on event_type
            let activityText = msg.body; // Fallback to original body

            if (msg.event_type === 'AGREEMENT_SENT') {
              // For sent agreements, show pending status if still pending
              const borrowerName = msg.borrower_full_name || msg.friend_first_name || msg.borrower_email;
              if (msg.agreement_status === 'pending') {
                activityText = `Agreement sent to ${msg.borrower_email} (pending review by ${borrowerName})`;
              } else {
                activityText = `Agreement sent to ${msg.borrower_email}`;
              }
            } else if (msg.event_type === 'AGREEMENT_ACCEPTED') {
              const borrowerName = msg.borrower_full_name || msg.friend_first_name || msg.borrower_email;
              activityText = `Agreement accepted by ${borrowerName}`;
            } else if (msg.event_type === 'AGREEMENT_DECLINED') {
              const borrowerName = msg.borrower_full_name || msg.friend_first_name || msg.borrower_email;
              activityText = `Agreement declined by ${borrowerName}`;
            } else if (msg.event_type === 'AGREEMENT_ASSIGNED_TO_BORROWER') {
              // Use the body text as-is for this event
              activityText = msg.body;
            } else if (msg.event_type === 'AGREEMENT_REVIEW_LATER') {
              activityText = msg.body;
            } else if (msg.event_type === 'AGREEMENT_CANCELLED_LENDER') {
              activityText = msg.body;
            } else if (msg.event_type === 'AGREEMENT_CANCELLED_BORROWER') {
              activityText = msg.body;
            } else if (msg.event_type === 'HARDSHIP_REQUEST_LENDER') {
              // Payment difficulty - use borrower's name and add emphasis
              const borrowerName = msg.borrower_full_name || msg.friend_first_name || msg.borrower_email;
              activityText = `${borrowerName} reported a payment issue and requested a new plan`;
            } else if (msg.event_type === 'HARDSHIP_REQUEST_BORROWER') {
              // Borrower view of their own hardship request
              activityText = msg.body; // Use the body text from the database
            } else if (msg.event_type === 'HARDSHIP_RESOLVED') {
              // Repayment issue resolved
              activityText = msg.body;
            }

            // Determine the link URL based on agreement_id and event_type
            let linkUrl = '';
            if (msg.agreement_id) {
              // For pending agreements where the current user is the borrower, go to review page
              if (msg.agreement_status === 'pending' && msg.borrower_user_id === currentUser.id) {
                linkUrl = `/agreements/${msg.agreement_id}/review`;
              } else {
                // Default to manage page for all other agreement-related events
                linkUrl = `/agreements/${msg.agreement_id}/manage`;
              }
            }

            const unreadClass = isUnread ? 'message-unread' : '';
            const clickableClass = linkUrl ? 'message-clickable' : '';
            const onclickAttr = linkUrl ? `onclick="handleActivityClick(${msg.id}, '${linkUrl}')"` : '';

            // Add warning icon for payment difficulty (both borrower and lender views)
            const isPaymentDifficulty = msg.event_type === 'HARDSHIP_REQUEST_LENDER' || msg.event_type === 'HARDSHIP_REQUEST_BORROWER';
            const warningIcon = isPaymentDifficulty ? '<span style="color:var(--warning); font-weight:700; margin-right:8px" title="Payment issue requires attention">⚠</span>' : '';

            // Add cancelled badge for cancelled agreements
            const isCancelled = msg.event_type === 'AGREEMENT_CANCELLED_LENDER' || msg.event_type === 'AGREEMENT_CANCELLED_BORROWER';
            const cancelledBadge = isCancelled ? '<span style="display:inline-block; padding:2px 8px; border-radius:4px; font-size:11px; font-weight:600; background:#6c757d; color:#fff; margin-left:8px">Cancelled</span>' : '';

            // Apply issue modifier class for payment issues
            const issueClass = isPaymentDifficulty ? 'activity-item--issue' : '';

            return `
              <div class="message-item ${unreadClass} ${clickableClass} ${issueClass}" ${onclickAttr}>
                <div style="display:flex; justify-content:space-between; align-items:center">
                  <div class="message-date">${timestamp} (${relativeTime})</div>
                  ${isUnread ? '<span class="unread-indicator">●</span>' : ''}
                </div>
                <div style="margin-top:4px; ${isPaymentDifficulty ? 'font-weight:600; color:var(--text)' : ''}">${warningIcon}${activityText}${cancelledBadge}</div>
              </div>
            `;
          }).join('');
        }
      } catch (err) {
        console.error('Error loading activity:', err);
      }
    }

    // Handle activity item click - mark as read and navigate
    async function handleActivityClick(messageId, url) {
      try {
        // Mark as read
        await fetch(`/api/activity/${messageId}/mark-read`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        // Navigate to the URL
        window.location.href = url;
      } catch (err) {
        console.error('Error marking message as read:', err);
        // Still navigate even if marking fails
        window.location.href = url;
      }
    }

    // Mark all messages as read
    async function markAllAsRead() {
      try {
        const res = await fetch('/api/activity/mark-all-read', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (res.ok) {
          // Reload messages to update UI
          await loadMessages();
        }
      } catch (err) {
        console.error('Error marking all as read:', err);
      }
    }

    // Navigate to review page for borrowers
    function reviewAgreement(id) {
      window.location.href = `/agreements/${id}/review`;
    }

    // Navigate to manage page for lenders and borrowers
    function viewAgreement(id) {
      window.location.href = `/agreements/${id}/manage`;
    }

    // Filter agreements by status
    function filterByStatus(status) {
      currentFilter = status;

      // Update active tab
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.getAttribute('data-filter') === status) {
          tab.classList.add('active');
        }
      });

      renderAgreements();
    }

    // Render agreements based on current filter
    function renderAgreements() {
      // Use shared component
      renderAgreementsTable(allAgreements, currentUser, currentFilter);
    }

    // Refresh agreements
    async function refresh() {
      try {
        const res = await fetch('/api/agreements');
        allAgreements = await res.json();
        renderAgreements();
      } catch (err) {
        console.error('Error loading agreements:', err);
      }
    }

    // Modal functions
    function closeModalOnOverlay(event, modalId) {
      if (event.target.classList.contains('modal-overlay')) {
        document.getElementById(modalId).style.display = 'none';
      }
    }

    // Close modal on ESC key
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeConfirmPaymentModal();
        closeDifficultyModal();
      }
    });

    // Payment Confirmation Modal
    async function openConfirmPaymentModal(agreementId) {
      const modal = document.getElementById('confirm-payment-modal');
      const modalBody = document.getElementById('confirm-payment-modal-body');

      modal.style.display = 'flex';
      modalBody.innerHTML = '<p style="text-align:center; color:var(--muted)">Loading...</p>';

      try {
        // Fetch agreement details and payments
        const [agreementRes, paymentsRes] = await Promise.all([
          fetch(`/api/agreements/${agreementId}`),
          fetch(`/api/agreements/${agreementId}/payments`)
        ]);

        if (!agreementRes.ok || !paymentsRes.ok) {
          throw new Error('Failed to load payment details');
        }

        const agreement = await agreementRes.json();
        const payments = await paymentsRes.json();

        // Find the pending payment that needs confirmation
        const pendingPayment = payments.find(p => p.status === 'pending');

        if (!pendingPayment) {
          modalBody.innerHTML = '<p style="color:var(--muted)">No pending payment found.</p>';
          return;
        }

        // Build modal content
        const amount = formatCurrency2(pendingPayment.amount_cents);
        const borrowerName = pendingPayment.recorded_by_name || agreement.friend_first_name || agreement.borrower_email;

        let proofOfPaymentHtml = '';
        if (pendingPayment.proof_file_path) {
          proofOfPaymentHtml = `
            <div class="modal-info-row">
              <span class="modal-info-label">Proof of payment</span>
              <button class="secondary" onclick="viewProofOfPayment(${pendingPayment.id})" style="padding:6px 12px; font-size:13px">View proof</button>
            </div>
          `;
        }

        modalBody.innerHTML = `
          <div class="modal-info-row">
            <span class="modal-info-label">Amount</span>
            <span class="modal-info-value">${amount}</span>
          </div>
          <div class="modal-info-row">
            <span class="modal-info-label">Method</span>
            <span class="modal-info-value">${pendingPayment.method || '—'}</span>
          </div>
          ${pendingPayment.note ? `<div class="modal-note"><strong>Note:</strong> ${pendingPayment.note}</div>` : ''}
          <div class="modal-info-row">
            <span class="modal-info-label">Reported by</span>
            <span class="modal-info-value">${borrowerName}</span>
          </div>
          ${proofOfPaymentHtml}
          <div class="modal-footer">
            <button onclick="declinePayment(${agreementId}, ${pendingPayment.id})" class="secondary">Decline</button>
            <button onclick="confirmPayment(${agreementId}, ${pendingPayment.id})">Confirm payment</button>
          </div>
          <p class="modal-helper-text" style="margin-top:12px; text-align:center">This will update the payment history and outstanding amount.</p>
        `;
      } catch (err) {
        console.error('Error loading payment details:', err);
        modalBody.innerHTML = '<p style="color:#ff6b6b">Failed to load payment details</p>';
      }
    }

    function closeConfirmPaymentModal() {
      document.getElementById('confirm-payment-modal').style.display = 'none';
    }

    async function confirmPayment(agreementId, paymentId) {
      try {
        const res = await fetch(`/api/payments/${paymentId}/approve`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || 'Failed to confirm payment');
        }

        closeConfirmPaymentModal();
        refresh();
        loadMessages();
      } catch (err) {
        console.error('Error confirming payment:', err);
        alert('Failed to confirm payment: ' + err.message);
      }
    }

    async function declinePayment(agreementId, paymentId) {
      try {
        const res = await fetch(`/api/payments/${paymentId}/decline`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || 'Failed to decline payment');
        }

        closeConfirmPaymentModal();
        refresh();
        loadMessages();
      } catch (err) {
        console.error('Error declining payment:', err);
        alert('Failed to decline payment: ' + err.message);
      }
    }

    function viewProofOfPayment(paymentId) {
      // Open proof of payment in new tab
      window.open(`/api/payments/${paymentId}/proof`, '_blank');
    }

    // Difficulty Modal
    async function openDifficultyModal(agreementId) {
      const modal = document.getElementById('difficulty-modal');
      const modalBody = document.getElementById('difficulty-modal-body');

      modal.style.display = 'flex';
      modalBody.innerHTML = '<p style="text-align:center; color:var(--muted)">Loading...</p>';

      try {
        const res = await fetch(`/api/agreements/${agreementId}/hardship-requests`);
        if (!res.ok) throw new Error('Failed to load difficulty details');

        const hardshipRequests = await res.json();

        // Find the most recent request (they're ordered by created_at DESC)
        const openDifficulty = hardshipRequests[0];

        if (!openDifficulty) {
          modalBody.innerHTML = '<p style="color:var(--muted)">No difficulty request found.</p>';
          return;
        }

        // Build preferred options list
        let preferredOptionsHtml = '';
        if (openDifficulty.preferred_adjustments) {
          const optionLabels = {
            'smaller_payments': 'Smaller monthly payments',
            'postpone': 'Postponement',
            'longer_term': 'Longer term',
            'partial_forgiveness': 'Partial forgiveness'
          };
          const optionsArray = openDifficulty.preferred_adjustments.split(',');
          const optionsList = optionsArray
            .map(opt => optionLabels[opt.trim()] || opt)
            .join('</li><li>');
          preferredOptionsHtml = `
            <div class="modal-info-row" style="flex-direction:column; align-items:flex-start">
              <span class="modal-info-label">Preferred options:</span>
              <ul style="margin:8px 0 0 20px; padding:0">
                <li>${optionsList}</li>
              </ul>
            </div>
          `;
        }

        // Format can_pay_now amount
        let canPayNowText = '€ 0,00 (Cannot pay anything now)';
        if (openDifficulty.can_pay_now_cents && openDifficulty.can_pay_now_cents > 0) {
          canPayNowText = formatCurrency2(openDifficulty.can_pay_now_cents);
        }

        modalBody.innerHTML = `
          <p class="modal-helper-text">Your friend has asked for help with this payment. Here's what they shared:</p>

          ${openDifficulty.reason_category ? `
            <div class="modal-info-row">
              <span class="modal-info-label">Reason</span>
              <span class="modal-info-value">${openDifficulty.reason_category}</span>
            </div>
          ` : ''}

          ${openDifficulty.reason_text ? `
            <div class="modal-note"><strong>Explanation:</strong><br>${openDifficulty.reason_text}</div>
          ` : ''}

          <div class="modal-info-row">
            <span class="modal-info-label">Can pay now</span>
            <span class="modal-info-value">${canPayNowText}</span>
          </div>

          ${preferredOptionsHtml}

          <div class="modal-footer">
            <button onclick="closeDifficultyModal()" class="secondary">Close</button>
            <button onclick="window.location.href='/agreements/${agreementId}/manage'">Open full agreement</button>
          </div>
        `;
      } catch (err) {
        console.error('Error loading difficulty details:', err);
        modalBody.innerHTML = '<p style="color:#ff6b6b">Failed to load difficulty details</p>';
      }
    }

    function closeDifficultyModal() {
      document.getElementById('difficulty-modal').style.display = 'none';
    }

    // Initialize with shared header
    // Initialize intl-tel-input for agreement phone
    let agreementPhoneInput;

    document.addEventListener('DOMContentLoaded', async () => {
      // Check if we're on a legal page route
      if (window.LegalRouter && window.LegalRouter.initialize()) {
        // Legal router is handling this page
        // Initialize only the header without activity section
        await PayFriendsHeader.initialize({
          hasActivitySection: false
        });
        return; // Don't initialize the app content
      }

      // Check if we're on a profile page route
      if (window.ProfileRouter && window.ProfileRouter.initialize()) {
        // Profile router is handling this page
        // Initialize only the header without activity section
        await PayFriendsHeader.initialize({
          hasActivitySection: false
        });
        return; // Don't initialize the app content
      }

      // Normal app initialization (not a legal or profile page)
      // Initialize shared header with custom activity button handler
      await PayFriendsHeader.initialize({
        hasActivitySection: true,
        onActivityClick: toggleActivity
      });

      // Phone input is auto-initialized by PhoneInputManager
      // Get reference to the instance
      agreementPhoneInput = window.PhoneInputManager.getInstance('agreement-phone');

      // Initialize payment method cards
      setupPaymentMethodCards();

      // Load user and other data
      loadUser();
      refresh();
      loadMessages();
      goToStep(1);

      // Check if we should auto-open the new agreement wizard
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('new') === 'true') {
        // Remove the parameter from URL without reloading
        window.history.replaceState({}, '', '/app');
        // Auto-open the wizard
        setTimeout(() => {
          startNewAgreementFromWelcome();
        }, 500);
      }
    });
  </script>

  <!-- Shared Schedule Calculation Utility -->
  <script src="/js/schedule.js"></script>

  <!-- Shared Agreements Table Component -->
  <script src="/components/agreements-table.js"></script>
</body>
</html>
