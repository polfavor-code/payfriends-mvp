<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PayFriends — My Agreements</title>
  <style>
    :root{
      --bg:#0e1116; --card:#151a21; --text:#e6eef6; --muted:#a7b0bd; --accent:#3ddc97;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif; background:var(--bg); color:var(--text);}
    .container{max-width:1200px;margin:0 auto;padding:32px 16px;}
    .header{display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid rgba(255,255,255,0.08)}
    .header-left h1{margin:0 0 4px 0;font-size:28px}
    .header-left .user-email{color:var(--muted); font-size:14px}
    .header-right{display:flex; gap:16px; align-items:center}
    .logout-btn{padding:8px 16px;border-radius:8px;border:1px solid rgba(255,255,255,0.15);background:transparent;color:var(--text);font-weight:500; cursor:pointer; font-size:14px}
    .logout-btn:hover{background:rgba(255,255,255,0.05)}
    .inbox-widget{background:var(--card);border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:12px 16px; cursor:pointer}
    .inbox-widget:hover{background:#1a2028}
    .inbox-count{color:var(--accent); font-weight:700}
    .card{background:var(--card);border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:16px;margin:16px 0}
    .row{display:flex; gap:12px; align-items:center; margin:10px 0}
    .row label{width:160px; color:var(--muted)}
    .row input{flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text)}
    button{padding:10px 14px;border-radius:10px;border:0;background:var(--accent);color:#0d130f;font-weight:700; cursor:pointer}
    button:hover{filter:brightness(1.06)}
    button.secondary{background:transparent; border:1px solid rgba(255,255,255,0.15); color:var(--text); margin-left:8px}
    button.secondary:hover{background:rgba(255,255,255,0.05)}
    .tabs{display:flex; gap:8px; margin-bottom:16px; border-bottom:1px solid rgba(255,255,255,0.08)}
    .tab{padding:10px 16px; cursor:pointer; color:var(--muted); border-bottom:2px solid transparent; margin-bottom:-1px}
    .tab.active{color:var(--accent); border-bottom-color:var(--accent)}
    .tab:hover{color:var(--text)}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:10px 12px; border-bottom:1px solid rgba(255,255,255,0.08); text-align:left}
    th{color:var(--muted); font-weight:600; font-size:13px}
    .status{color:var(--muted); margin-top:8px; min-height:1.2em;}
    .status-badge{display:inline-block; padding:4px 10px; border-radius:6px; font-size:12px; font-weight:600}
    .status-badge.pending{background:#4a4a4a; color:#fff}
    .status-badge.active{background:#3d7bdc; color:#fff}
    .status-badge.settled{background:#3ddc97; color:#0d130f}
    .status-badge.declined{background:#ff6b6b; color:#fff}
    .messages-list{margin-top:12px}
    .message-item{padding:10px; background:#10151d; border-radius:8px; margin:8px 0; font-size:14px}
    .message-subject{font-weight:600; margin-bottom:4px}
    .message-date{color:var(--muted); font-size:12px}
    .empty-state{text-align:center; color:var(--muted); padding:32px; font-size:14px}
    .wizard-steps{display:flex; gap:16px; margin-bottom:24px; align-items:center}
    .wizard-step{flex:1; padding:8px 16px; background:#10151d; border-radius:8px; text-align:center; font-size:14px; border:2px solid transparent}
    .wizard-step.active{border-color:var(--accent); color:var(--accent); font-weight:600}
    .wizard-step.completed{color:var(--accent)}
    .wizard-content{min-height:200px}
    .hidden{display:none}
    .role-badge{display:inline-block; padding:4px 8px; border-radius:6px; font-size:11px; font-weight:600; background:#2a2a2a; color:#fff}
    .role-badge.lend{background:#3d7bdc; color:#fff}
    .role-badge.borrow{background:#e67e22; color:#fff}
    .invite-url-box{background:#10151d; padding:12px; border-radius:8px; margin:16px 0; font-family:monospace; font-size:13px; word-break:break-all; border:1px solid rgba(255,255,255,0.08)}
    .summary-row{display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.08)}
    .summary-row:last-child{border-bottom:none}
    .summary-label{color:var(--muted)}
    .summary-value{font-weight:600}
  </style>
</head>
<body>
  <main class="container">
    <header class="header">
      <div class="header-left">
        <h1><a href="/app" style="color:var(--text); text-decoration:none; cursor:pointer">My Agreements</a></h1>
        <p class="user-email" id="user-email">Loading...</p>
      </div>
      <div class="header-right">
        <div class="inbox-widget" onclick="toggleActivity()">
          Activity (<span class="inbox-count" id="activity-count">0</span>)
        </div>
        <a href="/profile" style="color:var(--text); text-decoration:none; padding:8px 16px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background:transparent; font-weight:500; font-size:14px; display:inline-block">My Profile</a>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </header>

    <!-- Activity section (initially hidden) -->
    <section class="card" id="activity-section" style="display:none">
      <h2>Activity</h2>
      <div class="messages-list" id="activity-list">
        <p class="empty-state">No activity yet</p>
      </div>
    </section>

    <!-- Wizard for creating agreements -->
    <section class="card">
      <h2>New Agreement</h2>

      <!-- Wizard Steps -->
      <div class="wizard-steps">
        <div class="wizard-step" id="step-indicator-1">1. Role</div>
        <div class="wizard-step" id="step-indicator-2">2. Details</div>
        <div class="wizard-step" id="step-indicator-3">3. Summary</div>
      </div>

      <!-- Step 1: Role Selection -->
      <div id="wizard-step-1" class="wizard-content">
        <h3 style="margin-top:0">I want to...</h3>
        <div style="display:flex; gap:16px; flex-wrap:wrap">
          <button onclick="selectRole('lend')" style="flex:1; min-width:200px">Lend money to a friend</button>
          <!-- Future: uncomment for borrow flow
          <button onclick="selectRole('borrow')" style="flex:1; min-width:200px" disabled>Borrow money from a friend (Coming soon)</button>
          -->
        </div>
      </div>

      <!-- Step 2: Friend & Basic Details -->
      <div id="wizard-step-2" class="wizard-content hidden">
        <h3 style="margin-top:0">Friend & Agreement Details</h3>
        <div class="row">
          <label>Friend's first name</label>
          <input id="friend-first-name" placeholder="Alex" required />
        </div>
        <div class="row">
          <label>Friend's email</label>
          <input id="friend-email" type="email" placeholder="alex@example.com" required />
        </div>
        <div class="row">
          <label>Amount (EUR)</label>
          <input id="amount" type="number" step="0.01" min="0.01" placeholder="50.00" required />
        </div>
        <div class="row">
          <label>Due date</label>
          <input id="due-date" type="date" required />
        </div>
        <div style="margin-top:16px">
          <button onclick="goToSummary()">Continue to Summary</button>
          <button class="secondary" onclick="goToStep(1)">Back</button>
        </div>
        <p id="step2-status" class="status"></p>
      </div>

      <!-- Step 3: Summary & Send -->
      <div id="wizard-step-3" class="wizard-content hidden">
        <h3 style="margin-top:0">Summary</h3>
        <div style="background:#10151d; padding:16px; border-radius:8px; margin:16px 0">
          <div class="summary-row">
            <span class="summary-label">You are</span>
            <span class="summary-value">Lending</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Amount</span>
            <span class="summary-value" id="summary-amount">€0.00</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">To</span>
            <span class="summary-value" id="summary-friend"></span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Friend email</span>
            <span class="summary-value" id="summary-email"></span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Repayment</span>
            <span class="summary-value">One payment on <span id="summary-due"></span></span>
          </div>
        </div>

        <div id="invite-not-sent">
          <button onclick="sendInvite()">Send to <span id="send-friend-name"></span> for review</button>
          <button class="secondary" onclick="goToStep(2)">Back</button>
        </div>

        <div id="invite-sent" class="hidden">
          <div style="background:rgba(61,220,151,0.1); border:1px solid rgba(61,220,151,0.2); border-radius:8px; padding:12px; margin:16px 0">
            <p style="margin:0; color:var(--accent); font-weight:600">Invite sent!</p>
          </div>
          <p style="color:var(--muted); font-size:14px">Share this invite link with your friend:</p>
          <div class="invite-url-box" id="invite-url"></div>
          <button onclick="copyInviteUrl()">Copy invite link</button>
          <button class="secondary" onclick="resetWizard()">Create another agreement</button>
        </div>

        <p id="step3-status" class="status"></p>
      </div>
    </section>

    <section class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
        <h2 style="margin:0">Agreements</h2>
      </div>

      <div class="tabs">
        <div class="tab active" data-filter="all" onclick="filterByStatus('all')">All</div>
        <div class="tab" data-filter="pending" onclick="filterByStatus('pending')">Pending</div>
        <div class="tab" data-filter="active" onclick="filterByStatus('active')">Active</div>
        <div class="tab" data-filter="settled" onclick="filterByStatus('settled')">Settled</div>
      </div>

      <table id="list">
        <thead>
          <tr>
            <th>ID</th>
            <th>Your role</th>
            <th>Lender</th>
            <th>Borrower</th>
            <th>Amount</th>
            <th>Due</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="empty-state" class="empty-state" style="display:none">
        No agreements found for this filter.
      </div>
    </section>
  </main>

  <script>
    let allAgreements = [];
    let currentFilter = 'all';
    let currentUser = null;
    let wizardData = {
      role: null,
      friendFirstName: '',
      friendEmail: '',
      amount: '',
      dueDate: '',
      inviteUrl: ''
    };

    // Format amount in cents to euros with thousand separators, no decimals
    function formatAmount(cents) {
      const euros = Math.round(cents / 100);
      return new Intl.NumberFormat('de-DE').format(euros);
    }

    // Calculate time ago from a timestamp
    function timeAgo(timestamp) {
      const now = new Date();
      const past = new Date(timestamp);
      const diffMs = now - past;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);
      const diffHour = Math.floor(diffMin / 60);
      const diffDay = Math.floor(diffHour / 24);

      if (diffSec < 60) return 'just now';
      if (diffMin < 60) return `${diffMin} min${diffMin > 1 ? 's' : ''} ago`;
      if (diffHour < 24) return `${diffHour} hour${diffHour > 1 ? 's' : ''} ago`;
      if (diffDay === 1) return '1 day ago';
      if (diffDay < 30) return `${diffDay} days ago`;
      const diffMonth = Math.floor(diffDay / 30);
      if (diffMonth === 1) return '1 month ago';
      if (diffMonth < 12) return `${diffMonth} months ago`;
      const diffYear = Math.floor(diffDay / 365);
      return `${diffYear} year${diffYear > 1 ? 's' : ''} ago`;
    }

    // Wizard functions
    function goToStep(step) {
      // Hide all steps
      for (let i = 1; i <= 3; i++) {
        document.getElementById(`wizard-step-${i}`).classList.add('hidden');
        document.getElementById(`step-indicator-${i}`).classList.remove('active');
      }

      // Show current step
      document.getElementById(`wizard-step-${step}`).classList.remove('hidden');
      document.getElementById(`step-indicator-${step}`).classList.add('active');

      // Mark previous steps as completed
      for (let i = 1; i < step; i++) {
        document.getElementById(`step-indicator-${i}`).classList.add('completed');
      }
    }

    function selectRole(role) {
      wizardData.role = role;
      goToStep(2);
    }

    function goToSummary() {
      const friendFirstName = document.getElementById('friend-first-name').value.trim();
      const friendEmail = document.getElementById('friend-email').value.trim();
      const amount = document.getElementById('amount').value;
      const dueDate = document.getElementById('due-date').value;
      const status = document.getElementById('step2-status');

      if (!friendFirstName || !friendEmail || !amount || !dueDate) {
        status.textContent = 'Please fill in all fields';
        return;
      }

      // Validate due date is not in the past
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const dueDateObj = new Date(dueDate);
      dueDateObj.setHours(0, 0, 0, 0);

      if (dueDateObj < today) {
        status.textContent = 'Due date cannot be in the past.';
        return;
      }

      status.textContent = '';
      wizardData.friendFirstName = friendFirstName;
      wizardData.friendEmail = friendEmail;
      wizardData.amount = amount;
      wizardData.dueDate = dueDate;

      // Update summary
      const amountCents = Math.round(parseFloat(amount) * 100);
      document.getElementById('summary-amount').textContent = `€ ${formatAmount(amountCents)}`;
      document.getElementById('summary-friend').textContent = friendFirstName;
      document.getElementById('summary-email').textContent = friendEmail;
      document.getElementById('summary-due').textContent = new Date(dueDate).toLocaleDateString();
      document.getElementById('send-friend-name').textContent = friendFirstName;

      goToStep(3);
    }

    async function sendInvite() {
      const status = document.getElementById('step3-status');
      status.textContent = 'Creating agreement...';

      try {
        const res = await fetch('/api/agreements', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            friendFirstName: wizardData.friendFirstName,
            borrowerEmail: wizardData.friendEmail,
            amount: wizardData.amount,
            dueDate: wizardData.dueDate,
            direction: wizardData.role,
            repaymentType: 'one_time'
          })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed');

        wizardData.inviteUrl = data.inviteUrl;
        document.getElementById('invite-url').textContent = data.inviteUrl;

        // Hide send button, show invite URL
        document.getElementById('invite-not-sent').classList.add('hidden');
        document.getElementById('invite-sent').classList.remove('hidden');

        status.textContent = '';
        refresh();
        loadMessages();
      } catch (err) {
        status.textContent = '❌ ' + err.message;
      }
    }

    function copyInviteUrl() {
      const url = wizardData.inviteUrl;
      navigator.clipboard.writeText(url).then(() => {
        document.getElementById('step3-status').textContent = '✅ Copied to clipboard!';
        setTimeout(() => {
          document.getElementById('step3-status').textContent = '';
        }, 2000);
      }).catch(() => {
        document.getElementById('step3-status').textContent = '❌ Failed to copy';
      });
    }

    function resetWizard() {
      wizardData = {
        role: null,
        friendFirstName: '',
        friendEmail: '',
        amount: '',
        dueDate: '',
        inviteUrl: ''
      };

      document.getElementById('friend-first-name').value = '';
      document.getElementById('friend-email').value = '';
      document.getElementById('amount').value = '';
      document.getElementById('due-date').value = '';
      document.getElementById('step2-status').textContent = '';
      document.getElementById('step3-status').textContent = '';

      document.getElementById('invite-not-sent').classList.remove('hidden');
      document.getElementById('invite-sent').classList.add('hidden');

      goToStep(1);
    }

    // Fetch current user
    async function loadUser() {
      try {
        const res = await fetch('/api/user');
        if (!res.ok) {
          window.location.href = '/';
          return;
        }
        const data = await res.json();
        currentUser = data.user;

        // Display full name and email, or just email if full_name is not set
        const displayText = currentUser.full_name
          ? `${currentUser.full_name} | ${currentUser.email}`
          : currentUser.email;
        document.getElementById('user-email').textContent = displayText;
      } catch (err) {
        console.error('Error loading user:', err);
        window.location.href = '/';
      }
    }

    // Logout
    async function logout() {
      try {
        await fetch('/auth/logout', { method: 'POST' });
        window.location.href = '/';
      } catch (err) {
        console.error('Logout error:', err);
        window.location.href = '/';
      }
    }

    // Toggle activity visibility
    function toggleActivity() {
      const activity = document.getElementById('activity-section');
      activity.style.display = activity.style.display === 'none' ? 'block' : 'none';
    }

    // Load activity
    async function loadMessages() {
      try {
        const res = await fetch('/api/messages');
        const messages = await res.json();

        document.getElementById('activity-count').textContent = messages.length;

        const activityList = document.getElementById('activity-list');
        if (messages.length === 0) {
          activityList.innerHTML = '<p class="empty-state">No activity yet</p>';
        } else {
          activityList.innerHTML = messages.map(msg => {
            const timestamp = new Date(msg.created_at).toLocaleString();
            const relativeTime = timeAgo(msg.created_at);

            // Determine activity text based on event_type
            let activityText = msg.body; // Fallback to original body

            if (msg.event_type === 'AGREEMENT_SENT') {
              // For sent agreements, show pending status if still pending
              const borrowerName = msg.borrower_full_name || msg.friend_first_name || msg.borrower_email;
              if (msg.agreement_status === 'pending') {
                activityText = `Agreement sent to ${msg.borrower_email} (pending review by ${borrowerName})`;
              } else {
                activityText = `Agreement sent to ${msg.borrower_email}`;
              }
            } else if (msg.event_type === 'AGREEMENT_ACCEPTED') {
              const borrowerName = msg.borrower_full_name || msg.friend_first_name || msg.borrower_email;
              activityText = `Agreement accepted by ${borrowerName}`;
            } else if (msg.event_type === 'AGREEMENT_DECLINED') {
              const borrowerName = msg.borrower_full_name || msg.friend_first_name || msg.borrower_email;
              activityText = `Agreement declined by ${borrowerName}`;
            } else if (msg.event_type === 'AGREEMENT_ASSIGNED_TO_BORROWER') {
              // Use the body text as-is for this event
              activityText = msg.body;
            } else if (msg.event_type === 'AGREEMENT_REVIEW_LATER') {
              activityText = msg.body;
            }

            return `
              <div class="message-item">
                <div class="message-date">${timestamp} (${relativeTime})</div>
                <div style="margin-top:4px">${activityText}</div>
              </div>
            `;
          }).join('');
        }
      } catch (err) {
        console.error('Error loading activity:', err);
      }
    }

    // Navigate to review page for borrowers
    function reviewAgreement(id) {
      window.location.href = `/agreements/${id}/review`;
    }

    // Navigate to view page for lenders
    function viewAgreement(id) {
      window.location.href = `/agreements/${id}/view`;
    }

    // Mark as paid (which sets status to "settled")
    async function markAsPaid(id) {
      try {
        const res = await fetch(`/api/agreements/${id}/status`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'paid' })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed');

        // Refresh agreements
        await refresh();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // Filter agreements by status
    function filterByStatus(status) {
      currentFilter = status;

      // Update active tab
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.getAttribute('data-filter') === status) {
          tab.classList.add('active');
        }
      });

      renderAgreements();
    }

    // Render agreements based on current filter
    function renderAgreements() {
      const tbody = document.querySelector('#list tbody');
      const emptyState = document.getElementById('empty-state');

      let filtered = allAgreements;
      if (currentFilter !== 'all') {
        filtered = allAgreements.filter(a => a.status === currentFilter);
      }

      if (filtered.length === 0) {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
        document.getElementById('list').style.display = 'none';
        return;
      }

      emptyState.style.display = 'none';
      document.getElementById('list').style.display = 'table';
      tbody.innerHTML = '';

      for (const a of filtered) {
        const tr = document.createElement('tr');
        tr.setAttribute('data-id', a.id);
        const amount = formatAmount(a.amount_cents);
        const statusText = a.status || 'pending';
        const statusBadge = `<span class="status-badge ${statusText}">${statusText}</span>`;

        // Determine role
        const isLender = a.lender_user_id === currentUser.id;
        const role = isLender ? 'Lender' : 'Borrower';
        const roleBadge = `<span class="role-badge ${isLender ? 'lend' : 'borrow'}">${role}</span>`;

        // Determine lender name (use full_name if available, fallback to lender_name or email)
        const lenderName = a.lender_full_name || a.lender_name || a.lender_email;

        // Determine borrower name (use full_name if available, fallback to friend_first_name or email)
        const borrowerName = a.borrower_full_name || a.friend_first_name || a.borrower_email;

        // Determine action button based on status and role
        let actionBtn = '—';
        if (statusText === 'pending' && !isLender) {
          // Borrower can review pending agreements
          actionBtn = `<button onclick="reviewAgreement(${a.id})">Review</button>`;
        } else if (statusText === 'pending' && isLender) {
          // Lender can view pending agreements
          actionBtn = `<button onclick="viewAgreement(${a.id})">View</button>`;
        } else if (statusText === 'active' && isLender) {
          // Lender can mark active agreements as paid
          actionBtn = `<button onclick="markAsPaid(${a.id})">Mark as Paid</button>`;
        }

        tr.innerHTML = `
          <td>${a.id}</td>
          <td>${roleBadge}</td>
          <td>${lenderName}</td>
          <td>${borrowerName}</td>
          <td>€ ${amount}</td>
          <td>${a.due_date}</td>
          <td>${statusBadge}</td>
          <td>${actionBtn}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    // Refresh agreements
    async function refresh() {
      try {
        const res = await fetch('/api/agreements');
        allAgreements = await res.json();
        renderAgreements();
      } catch (err) {
        console.error('Error loading agreements:', err);
      }
    }

    // Initialize
    loadUser();
    refresh();
    loadMessages();
    goToStep(1);
  </script>
</body>
</html>
