<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PayFriends — My Agreements</title>
  <style>
    :root{
      --bg:#0e1116; --card:#151a21; --text:#e6eef6; --muted:#a7b0bd; --accent:#3ddc97;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif; background:var(--bg); color:var(--text);}
    .container{max-width:1200px;margin:0 auto;padding:32px 16px;}
    .header{display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid rgba(255,255,255,0.08)}
    .header-left h1{margin:0 0 4px 0;font-size:28px}
    .header-left .user-email{color:var(--muted); font-size:14px}
    .header-right{display:flex; gap:16px; align-items:center}
    .logout-btn{padding:8px 16px;border-radius:8px;border:1px solid rgba(255,255,255,0.15);background:transparent;color:var(--text);font-weight:500; cursor:pointer; font-size:14px}
    .logout-btn:hover{background:rgba(255,255,255,0.05)}
    .inbox-widget{background:var(--card);border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:12px 16px; cursor:pointer}
    .inbox-widget:hover{background:#1a2028}
    .inbox-count{color:var(--accent); font-weight:700}
    .card{background:var(--card);border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:16px;margin:16px 0}
    .row{display:flex; gap:12px; align-items:center; margin:10px 0}
    .row label{width:160px; color:var(--muted)}
    .row input{flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text)}
    button{padding:10px 14px;border-radius:10px;border:0;background:var(--accent);color:#0d130f;font-weight:700; cursor:pointer}
    button:hover{filter:brightness(1.06)}
    button.secondary{background:transparent; border:1px solid rgba(255,255,255,0.15); color:var(--text); margin-left:8px}
    button.secondary:hover{background:rgba(255,255,255,0.05)}
    .tabs{display:flex; gap:8px; margin-bottom:16px; border-bottom:1px solid rgba(255,255,255,0.08)}
    .tab{padding:10px 16px; cursor:pointer; color:var(--muted); border-bottom:2px solid transparent; margin-bottom:-1px}
    .tab.active{color:var(--accent); border-bottom-color:var(--accent)}
    .tab:hover{color:var(--text)}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:10px 12px; border-bottom:1px solid rgba(255,255,255,0.08); text-align:left; vertical-align:middle}
    th{color:var(--muted); font-weight:600; font-size:13px}
    .status{color:var(--muted); margin-top:8px; min-height:1.2em;}
    .status-badge{display:inline-block; padding:4px 10px; border-radius:6px; font-size:12px; font-weight:600}
    .status-badge.pending{background:#4a4a4a; color:#fff}
    .status-badge.active{background:#3d7bdc; color:#fff}
    .status-badge.settled{background:#3ddc97; color:#0d130f}
    .status-badge.declined{background:#ff6b6b; color:#fff}
    .status-badge.cancelled{background:#6c757d; color:#fff}
    .actions-column{display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:flex-end; width:100%}
    .actions-column button{flex:0 0 auto; padding:8px 12px; font-size:13px; white-space:nowrap; width:auto}
    .btn-confirm-payment{background:#f97316; color:#fff; border:0; padding:8px 12px; border-radius:8px; font-weight:600; cursor:pointer; font-size:13px}
    .btn-confirm-payment:hover{background:#ea580c}
    .btn-payment-issue{background:#dc2626; color:#fff; border:0; padding:8px 12px; border-radius:8px; font-weight:600; cursor:pointer; font-size:13px}
    .btn-payment-issue:hover{background:#b91c1c}
    .messages-list{margin-top:12px}
    .message-item{padding:10px; background:#10151d; border-radius:8px; margin:8px 0; font-size:14px; transition:all 0.2s ease}
    .message-item.message-clickable{cursor:pointer; border:1px solid transparent}
    .message-item.message-clickable:hover{background:#1a2028; border-color:rgba(61,220,151,0.3); transform:translateX(2px)}
    .message-item.message-unread{font-weight:500; background:#1a2028; border:1px solid rgba(61,220,151,0.15)}
    .unread-indicator{color:var(--accent); font-size:16px; margin-left:8px}
    .message-subject{font-weight:600; margin-bottom:4px}
    .message-date{color:var(--muted); font-size:12px}
    .empty-state{text-align:center; color:var(--muted); padding:32px; font-size:14px}
    .wizard-steps{display:flex; gap:16px; margin-bottom:24px; align-items:center}
    .wizard-step{flex:1; padding:8px 16px; background:#10151d; border-radius:8px; text-align:center; font-size:14px; border:2px solid transparent; cursor:pointer; transition:all 0.2s ease}
    .wizard-step:hover{background:#1a2028; border-color:rgba(61,220,151,0.3)}
    .wizard-step.active{border-color:var(--accent); color:var(--accent); font-weight:600}
    .wizard-step.completed{color:var(--accent)}
    .wizard-content{min-height:200px}
    .hidden{display:none}
    .role-badge{display:inline-block; padding:4px 8px; border-radius:6px; font-size:11px; font-weight:600; background:#2a2a2a; color:#fff}
    .role-badge.lend{background:#3d7bdc; color:#fff}
    .role-badge.borrow{background:#e67e22; color:#fff}
    .invite-url-box{background:#10151d; padding:12px; border-radius:8px; margin:16px 0; font-family:monospace; font-size:13px; word-break:break-all; border:1px solid rgba(255,255,255,0.08)}
    .summary-row{display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.08)}
    .summary-row:last-child{border-bottom:none}
    .summary-label{color:var(--muted)}
    .summary-value{font-weight:600}
    .modal-overlay{position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:1000}
    .modal-card{background:var(--card); border:1px solid rgba(255,255,255,0.12); border-radius:16px; padding:24px; max-width:600px; width:90%; max-height:90vh; overflow-y:auto}
    .modal-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:12px; border-bottom:1px solid rgba(255,255,255,0.08)}
    .modal-title{margin:0; font-size:20px; font-weight:600}
    .modal-close{background:transparent; border:0; color:var(--muted); font-size:24px; cursor:pointer; padding:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center; border-radius:6px}
    .modal-close:hover{background:rgba(255,255,255,0.05); color:var(--text)}
    .modal-body{margin-bottom:20px}
    .modal-footer{display:flex; gap:12px; justify-content:flex-end; padding-top:16px; border-top:1px solid rgba(255,255,255,0.08)}
    .modal-info-row{display:flex; justify-content:space-between; padding:12px; background:#10151d; border-radius:8px; margin:8px 0}
    .modal-info-label{color:var(--muted); font-size:14px}
    .modal-info-value{font-weight:600; font-size:14px}
    .modal-note{background:#10151d; padding:12px; border-radius:8px; margin:12px 0; font-size:14px; color:var(--text)}
    .modal-helper-text{color:var(--muted); font-size:13px; margin-bottom:16px; line-height:1.5}
    .actions-header-text{display:inline-block; padding-left:40px}
  </style>
</head>
<body>
  <main class="container">
    <header class="header">
      <div class="header-left">
        <h1><a href="/app" style="color:var(--text); text-decoration:none; cursor:pointer">My Agreements</a></h1>
        <p class="user-email" id="user-email">Loading...</p>
      </div>
      <div class="header-right">
        <div class="inbox-widget" onclick="toggleActivity()">
          Activity (<span class="inbox-count" id="activity-count">0</span>)
        </div>
        <a href="/profile" style="color:var(--text); text-decoration:none; padding:8px 16px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background:transparent; font-weight:500; font-size:14px; display:inline-block">My Profile</a>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </header>

    <!-- Activity section (initially hidden) -->
    <section class="card" id="activity-section" style="display:none">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
        <h2 style="margin:0">Activity</h2>
        <button id="mark-all-read-btn" onclick="markAllAsRead()" style="padding:6px 12px; font-size:13px">Mark all as read</button>
      </div>
      <div class="messages-list" id="activity-list">
        <p class="empty-state">No activity yet</p>
      </div>
    </section>

    <!-- New Agreement Button -->
    <div style="margin:16px 0">
      <button id="new-agreement-btn" onclick="toggleNewAgreement()" style="display:flex; align-items:center; gap:8px; padding:12px 20px">
        <span style="font-size:18px; font-weight:bold">+</span>
        <span>New Agreement</span>
      </button>
    </div>

    <!-- Wizard for creating agreements -->
    <section class="card hidden" id="new-agreement-section">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
        <h2 style="margin:0">New Agreement</h2>
        <button class="secondary" onclick="closeNewAgreement()" style="padding:6px 12px; font-size:13px">Close</button>
      </div>

      <!-- Wizard Steps -->
      <div class="wizard-steps">
        <div class="wizard-step" id="step-indicator-1" onclick="clickStep(1)">1. Role</div>
        <div class="wizard-step" id="step-indicator-2" onclick="clickStep(2)">2. Terms</div>
        <div class="wizard-step" id="step-indicator-3" onclick="clickStep(3)">3. Interest</div>
        <div class="wizard-step" id="step-indicator-4" onclick="clickStep(4)">4. Summary</div>
      </div>

      <!-- Step 1: Role Selection -->
      <div id="wizard-step-1" class="wizard-content">
        <h3 style="margin-top:0">I want to...</h3>
        <div style="display:flex; gap:16px; flex-wrap:wrap">
          <button onclick="selectRole('lend')" style="flex:1; min-width:200px">Lend money to a friend</button>
          <!-- Future: uncomment for borrow flow
          <button onclick="selectRole('borrow')" style="flex:1; min-width:200px" disabled>Borrow money from a friend (Coming soon)</button>
          -->
        </div>
      </div>

      <!-- Step 2: Friend & Terms (+ Installments) -->
      <div id="wizard-step-2" class="wizard-content hidden">
        <h3 style="margin-top:0">Friend & Terms</h3>
        <div class="row">
          <label>Friend's first name</label>
          <input id="friend-first-name" placeholder="Alex" required />
        </div>
        <div class="row">
          <label>Friend's email</label>
          <input id="friend-email" type="email" placeholder="alex@example.com" required />
        </div>
        <div class="row">
          <label>Short description*</label>
          <input id="description" type="text" placeholder="Holiday loan, Car repair..." required maxlength="30" onblur="capitalizeDescription()" />
        </div>
        <p style="color:var(--muted); font-size:12px; margin:-6px 0 12px 172px">A short note to help identify this agreement (max 30 characters).</p>
        <div class="row">
          <label>Amount (EUR)</label>
          <input id="amount" type="text" placeholder="50.00" required onblur="formatAmountInput()" onfocus="unformatAmountInput()" />
        </div>
        <div class="row">
          <label>Repayment type</label>
          <select id="repayment-type" onchange="toggleInstallmentFields()" style="flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text)">
            <option value="one_time">One-time payment</option>
            <option value="installments">Installments</option>
          </select>
        </div>
        <!-- One-time payment fields -->
        <div id="one-time-fields">
          <div class="row">
            <label>Due date</label>
            <input id="due-date" type="date" required onchange="updateDueDateHelper()" />
          </div>
          <p id="due-date-helper" style="color:var(--muted); font-size:12px; margin:-6px 0 12px 172px"></p>
        </div>
        <!-- Installment fields -->
        <div id="installment-fields" class="hidden">
          <div class="row">
            <label>Plan length</label>
            <div style="flex:1; display:flex; gap:8px">
              <input id="plan-length" type="number" min="1" step="1" placeholder="6" required onchange="calculateInstallments()" style="flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text)" />
              <select id="plan-unit" onchange="calculateInstallments()" style="flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text)">
                <option value="days">Days</option>
                <option value="weeks">Weeks</option>
                <option value="months" selected>Months</option>
                <option value="years">Years</option>
              </select>
            </div>
          </div>
          <p style="color:var(--muted); font-size:12px; margin:-6px 0 12px 172px">We'll use this to calculate a fair payment schedule and interest.</p>
          <div class="row">
            <label>First payment date</label>
            <input id="first-payment-date" type="date" required onchange="calculateInstallments()" />
          </div>
          <p id="installment-summary" style="color:var(--accent); font-size:13px; margin:8px 0 12px 172px; font-weight:500"></p>
        </div>
        <div style="margin-top:16px">
          <button onclick="goToInterest()">Continue</button>
          <button class="secondary" onclick="goToStep(1)">Back</button>
        </div>
        <p id="step2-status" class="status"></p>
      </div>

      <!-- Step 3: Interest & Fairness -->
      <div id="wizard-step-3" class="wizard-content hidden">
        <h3 style="margin-top:0">Interest & Fairness</h3>

        <div style="margin:16px 0">
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.08); margin-bottom:8px">
            <input type="radio" name="interest-option" value="yes" onchange="toggleInterestFields()" checked />
            <span>Add interest</span>
          </label>
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.08)">
            <input type="radio" name="interest-option" value="no" onchange="toggleInterestFields()" />
            <span>No interest (I'm lending interest-free)</span>
          </label>
        </div>

        <div id="interest-fields">
          <div class="row">
            <label>Annual interest rate</label>
            <div style="flex:1; display:flex; align-items:center; gap:8px">
              <input id="interest-rate" type="number" min="0" max="100" step="0.1" placeholder="5.0" oninput="calculateInterest()" style="flex:1" />
              <span style="color:var(--muted)">%</span>
            </div>
          </div>
          <p id="fair-range-text" style="color:var(--muted); font-size:12px; margin:-6px 0 12px 172px; line-height:1.5"></p>
          <div id="rate-warning" style="display:none; margin:-6px 0 12px 172px">
            <span style="display:inline-block; padding:4px 8px; border-radius:6px; font-size:11px; font-weight:600; background:#f97316; color:#fff" id="rate-warning-text"></span>
          </div>

          <div id="interest-summary" style="background:rgba(61,220,151,0.05); border:1px solid rgba(61,220,151,0.2); border-radius:8px; padding:12px; margin:16px 0">
            <p style="margin:0 0 8px 0; color:var(--text); font-size:14px" id="installment-schedule-note"></p>
            <p style="margin:0 0 8px 0; color:var(--text); font-size:14px">
              <strong>Total interest:</strong> €<span id="total-interest-display">0</span>
            </p>
            <p style="margin:0 0 8px 0; color:var(--text); font-size:14px">
              <strong>Total to repay:</strong> €<span id="total-repay-display">0</span>
            </p>
            <p style="margin:8px 0 0 0; color:var(--muted); font-size:12px; font-style:italic">(interest only on what's still outstanding)</p>
          </div>

          <div style="margin:16px 0">
            <button onclick="toggleBreakdown()" class="secondary" style="padding:6px 12px; font-size:13px">
              <span id="breakdown-toggle-text">Show calculation</span>
            </button>
          </div>

          <div id="interest-breakdown" class="hidden" style="background:#10151d; border-radius:8px; padding:12px; margin:16px 0; max-height:300px; overflow-y:auto">
            <table style="width:100%; font-size:12px">
              <thead>
                <tr style="border-bottom:1px solid rgba(255,255,255,0.08)">
                  <th style="text-align:left; padding:8px 4px">#</th>
                  <th style="text-align:right; padding:8px 4px">Payment</th>
                  <th style="text-align:right; padding:8px 4px">Principal</th>
                  <th style="text-align:right; padding:8px 4px">Interest</th>
                  <th style="text-align:right; padding:8px 4px">Remaining</th>
                </tr>
              </thead>
              <tbody id="breakdown-tbody"></tbody>
            </table>
          </div>
        </div>

        <div id="no-interest-summary" class="hidden" style="background:rgba(61,220,151,0.05); border:1px solid rgba(61,220,151,0.2); border-radius:8px; padding:12px; margin:16px 0">
          <p style="margin:0; color:var(--text); font-size:14px">No interest will be charged. Borrower only repays the original amount (<span id="no-interest-amount">€0</span>).</p>
        </div>

        <div style="margin-top:16px">
          <button onclick="goToPaymentPreferences()">Continue</button>
          <button class="secondary" onclick="goToStep(2)">Back</button>
        </div>
        <p id="step3-status" class="status"></p>
      </div>

      <!-- Step 4: Payment Preferences + Summary -->
      <div id="wizard-step-4" class="wizard-content hidden">
        <h3 style="margin-top:0">Payment Preferences & Summary</h3>

        <!-- Payment preferences -->
        <div style="margin-bottom:24px">
          <h4 style="margin:0 0 12px 0">Payment Preferences</h4>

          <!-- Payment method -->
          <div class="row">
            <label>Preferred method</label>
            <select id="payment-preference" onchange="toggleOtherPaymentMethod()" style="max-width:300px; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text)">
              <option value="bank">Bank transfer</option>
              <option value="cash">Cash in person</option>
              <option value="crypto">Crypto</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div id="other-payment-method" class="hidden" style="margin:8px 0 12px 172px">
            <input id="other-payment-description" type="text" placeholder="Describe the method (e.g. local app, voucher, etc.)" style="width:100%; max-width:400px; padding:8px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text)" />
          </div>

          <!-- Reminders -->
          <div style="margin:16px 0">
            <label style="font-weight:600; font-size:14px; margin-bottom:8px; display:block">Reminders</label>
            <label style="display:flex; align-items:flex-start; gap:8px; cursor:pointer; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.08); margin-bottom:8px">
              <input type="radio" name="reminder-mode" value="auto" onchange="toggleReminderMode()" checked style="margin-top:2px" />
              <div>
                <div style="font-weight:600">Auto (recommended)</div>
                <div style="color:var(--muted); font-size:13px; margin-top:4px">We'll remind the borrower 7 and 1 day before and on the due date. If no payment is reported, we'll send follow-up reminders 3 and 7 days after the due date.</div>
              </div>
            </label>
            <label style="display:flex; align-items:flex-start; gap:8px; cursor:pointer; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.08)">
              <input type="radio" name="reminder-mode" value="custom" onchange="toggleReminderMode()" style="margin-top:2px" />
              <div style="flex:1">
                <div style="font-weight:600">Custom schedule</div>
                <div id="custom-reminders" class="hidden" style="margin-top:8px">
                  <div style="color:var(--muted); font-size:13px; margin-bottom:8px">Send reminders:</div>
                  <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px">
                    <label style="display:flex; align-items:center; gap:6px; font-size:13px">
                      <input type="checkbox" value="-14" class="custom-reminder-checkbox" /> 14 days before
                    </label>
                    <label style="display:flex; align-items:center; gap:6px; font-size:13px">
                      <input type="checkbox" value="-7" class="custom-reminder-checkbox" /> 7 days before
                    </label>
                    <label style="display:flex; align-items:center; gap:6px; font-size:13px">
                      <input type="checkbox" value="-3" class="custom-reminder-checkbox" /> 3 days before
                    </label>
                    <label style="display:flex; align-items:center; gap:6px; font-size:13px">
                      <input type="checkbox" value="-1" class="custom-reminder-checkbox" /> 1 day before
                    </label>
                    <label style="display:flex; align-items:center; gap:6px; font-size:13px">
                      <input type="checkbox" value="0" class="custom-reminder-checkbox" /> On due date
                    </label>
                    <label style="display:flex; align-items:center; gap:6px; font-size:13px">
                      <input type="checkbox" value="3" class="custom-reminder-checkbox" /> 3 days after
                    </label>
                    <label style="display:flex; align-items:center; gap:6px; font-size:13px">
                      <input type="checkbox" value="7" class="custom-reminder-checkbox" /> 7 days after
                    </label>
                  </div>
                  <p id="custom-reminder-error" style="color:#ff6b6b; font-size:12px; margin-top:8px; display:none">Please select at least one reminder</p>
                </div>
              </div>
            </label>
          </div>

          <!-- Proof of payment requirement -->
          <div style="margin:16px 0">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer">
              <input type="checkbox" id="proof-required" />
              <span style="font-size:14px">Borrower must upload proof whenever they report a payment</span>
            </label>
          </div>
        </div>

        <!-- If things go wrong section -->
        <div style="margin-bottom:24px">
          <h4 style="margin:0 0 12px 0">If things go wrong</h4>
          <label style="display:flex; align-items:flex-start; gap:8px; cursor:pointer; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.08)">
            <input type="checkbox" id="debt-collection-clause" style="margin-top:2px" />
            <div style="font-size:14px; line-height:1.5">
              <strong>Include an escalation clause in this agreement.</strong>
              <div style="color:var(--muted); margin-top:4px">If the borrower fails to repay, does not initiate or respond to renegotiation attempts, or no solution can be reached, both parties agree that the case may be transferred to an independent debt-collection partner registered in accordance with local law. Any collection fees are for the borrower's expense.</div>
            </div>
          </label>
        </div>

        <!-- Summary -->
        <h4 style="margin:0 0 12px 0">Agreement Summary</h4>
        <div style="background:#10151d; padding:16px; border-radius:8px; margin:16px 0">
          <p id="full-summary-text" style="margin:0 0 16px 0; color:var(--text); font-size:15px; line-height:1.6"></p>

          <div class="summary-row">
            <span class="summary-label">Description</span>
            <span class="summary-value" id="summary-description"></span>
          </div>
          <div class="summary-row">
            <span class="summary-label">To</span>
            <span class="summary-value" id="summary-friend"></span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Friend email</span>
            <span class="summary-value" id="summary-email"></span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Amount</span>
            <span class="summary-value" id="summary-amount">€0</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Repayment</span>
            <span class="summary-value" id="summary-repayment">One payment</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Interest</span>
            <span class="summary-value" id="summary-interest">0%</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Total to repay</span>
            <span class="summary-value" id="summary-total-repay">€0</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Preferred method</span>
            <span class="summary-value" id="summary-payment-method"></span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Proof of payment</span>
            <span class="summary-value" id="summary-proof-required"></span>
          </div>
          <div class="summary-row" id="summary-escalation-row">
            <span class="summary-label">Escalation clause</span>
            <span class="summary-value" id="summary-escalation"></span>
          </div>
        </div>

        <div id="invite-not-sent">
          <button onclick="sendInvite()">Send to <span id="send-friend-name"></span> for review</button>
          <button class="secondary" onclick="goToStep(3)">Back</button>
        </div>

        <div id="invite-sent" class="hidden">
          <div style="background:rgba(61,220,151,0.1); border:1px solid rgba(61,220,151,0.2); border-radius:8px; padding:12px; margin:16px 0">
            <p style="margin:0; color:var(--accent); font-weight:600">Invite sent!</p>
          </div>
          <p style="color:var(--muted); font-size:14px">Share this invite link with your friend:</p>
          <div class="invite-url-box" id="invite-url"></div>
          <button onclick="copyInviteUrl()">Copy invite link</button>
          <button class="secondary" onclick="resetWizard()">Create another agreement</button>
        </div>

        <p id="step4-status" class="status"></p>
      </div>
    </section>

    <section class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
        <h2 style="margin:0">Agreements</h2>
      </div>

      <div class="tabs">
        <div class="tab active" data-filter="all" onclick="filterByStatus('all')">All</div>
        <div class="tab" data-filter="pending" onclick="filterByStatus('pending')">Pending</div>
        <div class="tab" data-filter="active" onclick="filterByStatus('active')">Active</div>
        <div class="tab" data-filter="settled" onclick="filterByStatus('settled')">Settled</div>
      </div>

      <table id="list">
        <thead>
          <tr>
            <th id="counterparty-header">Counterparty</th>
            <th>Description</th>
            <th>Amount</th>
            <th>Outstanding</th>
            <th>Due</th>
            <th>Status</th>
            <th><span class="actions-header-text">Actions</span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="empty-state" class="empty-state" style="display:none">
        No agreements found for this filter.
      </div>
    </section>

    <!-- Payment Confirmation Modal -->
    <div id="confirm-payment-modal" class="modal-overlay" style="display:none" onclick="closeModalOnOverlay(event, 'confirm-payment-modal')">
      <div class="modal-card" onclick="event.stopPropagation()">
        <div class="modal-header">
          <h2 class="modal-title">Confirm payment</h2>
          <button class="modal-close" onclick="closeConfirmPaymentModal()">&times;</button>
        </div>
        <div class="modal-body" id="confirm-payment-modal-body">
          <p style="text-align:center; color:var(--muted)">Loading...</p>
        </div>
      </div>
    </div>

    <!-- Payment Issue Modal -->
    <div id="difficulty-modal" class="modal-overlay" style="display:none" onclick="closeModalOnOverlay(event, 'difficulty-modal')">
      <div class="modal-card" onclick="event.stopPropagation()">
        <div class="modal-header">
          <h2 class="modal-title">Payment issue</h2>
          <button class="modal-close" onclick="closeDifficultyModal()">&times;</button>
        </div>
        <div class="modal-body" id="difficulty-modal-body">
          <p style="text-align:center; color:var(--muted)">Loading...</p>
        </div>
      </div>
    </div>
  </main>

  <script>
    let allAgreements = [];
    let currentFilter = 'all';
    let currentUser = null;
    let wizardData = {
      role: null,
      friendFirstName: '',
      friendEmail: '',
      description: '',
      amount: '',
      repaymentType: 'one_time',
      dueDate: '',
      // Installment fields
      planLength: null,
      planUnit: 'months',
      firstPaymentDate: '',
      installmentCount: null,
      installmentAmount: null,
      finalDueDate: '',
      // Interest fields
      hasInterest: false,
      interestRate: 0,
      totalInterest: 0,
      totalRepayAmount: 0,
      // Payment preferences
      paymentPreferenceMethod: 'bank',
      paymentOtherDescription: '',
      reminderMode: 'auto',
      reminderOffsets: [-7, -1, 0, 3, 7],
      proofRequired: false,
      debtCollectionClause: false,
      inviteUrl: ''
    };

    // Format amount in cents to euros with thousand separators, no decimals
    function formatAmount(cents) {
      const euros = Math.round(cents / 100);
      return new Intl.NumberFormat('de-DE').format(euros);
    }

    // Format the amount input field on blur
    function formatAmountInput() {
      const input = document.getElementById('amount');
      const value = input.value.trim();
      if (!value) return;

      // Remove any existing formatting (dots, commas)
      const cleanValue = value.replace(/[.,]/g, '');
      const num = parseFloat(cleanValue);

      if (!isNaN(num) && num > 0) {
        // Format with thousand separators (German style: 6.000)
        input.value = new Intl.NumberFormat('de-DE').format(num);
      }
    }

    // Remove formatting from amount input on focus for easier editing
    function unformatAmountInput() {
      const input = document.getElementById('amount');
      const value = input.value.trim();
      if (!value) return;

      // Remove thousand separators
      const cleanValue = value.replace(/\./g, '').replace(/,/g, '');
      if (!isNaN(cleanValue) && cleanValue !== '') {
        input.value = cleanValue;
      }
    }

    // Capitalize first letter of description
    function capitalizeDescription() {
      const input = document.getElementById('description');
      const value = input.value.trim();
      if (value.length > 0) {
        input.value = value.charAt(0).toUpperCase() + value.slice(1);
      }
    }

    // Calculate time ago from a timestamp
    function timeAgo(timestamp) {
      const now = new Date();
      const past = new Date(timestamp);
      const diffMs = now - past;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);
      const diffHour = Math.floor(diffMin / 60);
      const diffDay = Math.floor(diffHour / 24);

      if (diffSec < 60) return 'just now';
      if (diffMin < 60) return `${diffMin} min${diffMin > 1 ? 's' : ''} ago`;
      if (diffHour < 24) return `${diffHour} hour${diffHour > 1 ? 's' : ''} ago`;
      if (diffDay === 1) return '1 day ago';
      if (diffDay < 30) return `${diffDay} days ago`;
      const diffMonth = Math.floor(diffDay / 30);
      if (diffMonth === 1) return '1 month ago';
      if (diffMonth < 12) return `${diffMonth} months ago`;
      const diffYear = Math.floor(diffDay / 365);
      return `${diffYear} year${diffYear > 1 ? 's' : ''} ago`;
    }

    // Wizard functions
    function goToStep(step) {
      // Hide all steps
      for (let i = 1; i <= 4; i++) {
        document.getElementById(`wizard-step-${i}`).classList.add('hidden');
        document.getElementById(`step-indicator-${i}`).classList.remove('active');
      }

      // Show current step
      document.getElementById(`wizard-step-${step}`).classList.remove('hidden');
      document.getElementById(`step-indicator-${step}`).classList.add('active');

      // Mark previous steps as completed
      for (let i = 1; i < step; i++) {
        document.getElementById(`step-indicator-${i}`).classList.add('completed');
      }
    }

    // Handle step click with validation
    function clickStep(targetStep) {
      // Determine current step
      let currentStep = 1;
      for (let i = 1; i <= 4; i++) {
        if (!document.getElementById(`wizard-step-${i}`).classList.contains('hidden')) {
          currentStep = i;
          break;
        }
      }

      // Allow clicking back without validation
      if (targetStep < currentStep) {
        goToStep(targetStep);
        return;
      }

      // If clicking forward, validate current step and navigate
      if (targetStep > currentStep) {
        // Step 1 → 2: Role must be selected
        if (currentStep === 1 && targetStep >= 2) {
          if (!wizardData.role) {
            document.getElementById('step2-status').textContent = 'Please select a role first';
            return;
          }
          if (targetStep === 2) {
            goToStep(2);
            return;
          }
        }

        // Step 2 → 3: Validate step 2 fields
        if (currentStep === 2 && targetStep >= 3) {
          if (!validateStep2()) return;
          if (targetStep === 3) {
            goToInterest();
            return;
          }
        }

        // Step 3 → 4: Navigate to payment preferences
        if (currentStep === 3 && targetStep === 4) {
          goToPaymentPreferences();
          return;
        }
      }

      // If same step, do nothing
      if (targetStep === currentStep) {
        return;
      }
    }

    function selectRole(role) {
      wizardData.role = role;
      goToStep(2);
    }

    // Toggle between one-time and installment fields
    function toggleInstallmentFields() {
      const repaymentType = document.getElementById('repayment-type').value;
      const oneTimeFields = document.getElementById('one-time-fields');
      const installmentFields = document.getElementById('installment-fields');

      if (repaymentType === 'installments') {
        oneTimeFields.classList.add('hidden');
        installmentFields.classList.remove('hidden');
        wizardData.repaymentType = 'installments';
        calculateInstallments();
      } else {
        oneTimeFields.classList.remove('hidden');
        installmentFields.classList.add('hidden');
        wizardData.repaymentType = 'one_time';
        updateDueDateHelper();
      }
    }

    // Calculate installment details
    function calculateInstallments() {
      const amount = document.getElementById('amount').value;
      const planLength = parseInt(document.getElementById('plan-length').value);
      const planUnit = document.getElementById('plan-unit').value;
      const firstPaymentDate = document.getElementById('first-payment-date').value;

      if (!amount || !planLength || !firstPaymentDate) {
        document.getElementById('installment-summary').textContent = '';
        return;
      }

      if (planLength <= 0) {
        document.getElementById('installment-summary').textContent = 'Plan length must be greater than 0';
        return;
      }

      // Parse amount
      const cleanAmount = amount.replace(/[.,]/g, '');
      const amountNum = parseFloat(cleanAmount);

      if (isNaN(amountNum) || amountNum <= 0) {
        document.getElementById('installment-summary').textContent = '';
        return;
      }

      // Calculate installment count based on unit
      let installmentCount;
      if (planUnit === 'months') {
        installmentCount = planLength;
      } else if (planUnit === 'years') {
        installmentCount = planLength * 12;
      } else if (planUnit === 'weeks') {
        installmentCount = planLength;
      } else if (planUnit === 'days') {
        installmentCount = planLength;
      }

      // Calculate installment amount
      const installmentAmount = (amountNum / installmentCount).toFixed(2);

      // Calculate final due date based on unit
      const firstDate = new Date(firstPaymentDate);
      const finalDate = new Date(firstDate);

      if (planUnit === 'months') {
        finalDate.setMonth(finalDate.getMonth() + planLength - 1);
      } else if (planUnit === 'years') {
        finalDate.setFullYear(finalDate.getFullYear() + planLength);
        finalDate.setMonth(finalDate.getMonth() - 1);
      } else if (planUnit === 'weeks') {
        finalDate.setDate(finalDate.getDate() + (planLength - 1) * 7);
      } else if (planUnit === 'days') {
        finalDate.setDate(finalDate.getDate() + planLength - 1);
      }

      // Format dates
      const firstFormatted = firstDate.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
      const finalFormatted = finalDate.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });

      // Store in wizard data
      wizardData.planLength = planLength;
      wizardData.planUnit = planUnit;
      wizardData.installmentCount = installmentCount;
      wizardData.installmentAmount = parseFloat(installmentAmount);
      wizardData.firstPaymentDate = firstPaymentDate;
      wizardData.finalDueDate = finalDate.toISOString().split('T')[0];

      // Display summary
      const amountFormatted = new Intl.NumberFormat('de-DE').format(Math.round(amountNum));
      const installmentFormatted = new Intl.NumberFormat('de-DE').format(Math.round(installmentAmount));

      // Choose appropriate frequency label
      let frequencyLabel = planUnit === 'months' ? 'monthly' :
                          planUnit === 'years' ? 'monthly' :
                          planUnit === 'weeks' ? 'weekly' :
                          'daily';

      document.getElementById('installment-summary').textContent =
        `€${amountFormatted} in ${installmentCount} ${frequencyLabel} payments of about €${installmentFormatted}, from ${firstFormatted} to ${finalFormatted}.`;
    }

    // Update due date helper text
    function updateDueDateHelper() {
      const dueDate = document.getElementById('due-date').value;
      if (!dueDate) {
        document.getElementById('due-date-helper').textContent = '';
        return;
      }

      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const dueDateObj = new Date(dueDate);
      dueDateObj.setHours(0, 0, 0, 0);

      const diffMs = dueDateObj - today;
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

      if (diffDays > 0) {
        document.getElementById('due-date-helper').textContent = `Due in ${diffDays} day${diffDays === 1 ? '' : 's'}`;
      } else if (diffDays === 0) {
        document.getElementById('due-date-helper').textContent = 'Due today';
      } else {
        document.getElementById('due-date-helper').textContent = 'Due date cannot be in the past';
      }
    }

    // Validate step 2
    function validateStep2() {
      const friendFirstName = document.getElementById('friend-first-name').value.trim();
      const friendEmail = document.getElementById('friend-email').value.trim();
      const description = document.getElementById('description').value.trim();
      const amount = document.getElementById('amount').value;
      const repaymentType = document.getElementById('repayment-type').value;
      const status = document.getElementById('step2-status');

      if (!friendFirstName || !friendEmail || !description || !amount) {
        status.textContent = 'Please fill in all required fields';
        return false;
      }

      if (description.length > 30) {
        status.textContent = 'Description must be 30 characters or less';
        return false;
      }

      // Validate amount
      const cleanAmount = amount.replace(/[.,]/g, '');
      const amountNum = parseFloat(cleanAmount);
      if (isNaN(amountNum) || amountNum <= 0) {
        status.textContent = 'Please enter a valid amount';
        return false;
      }

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      if (repaymentType === 'one_time') {
        const dueDate = document.getElementById('due-date').value;
        if (!dueDate) {
          status.textContent = 'Please select a due date';
          return false;
        }

        const dueDateObj = new Date(dueDate);
        dueDateObj.setHours(0, 0, 0, 0);
        if (dueDateObj < today) {
          status.textContent = 'Due date cannot be in the past';
          return false;
        }

        wizardData.dueDate = dueDate;
        wizardData.finalDueDate = dueDate;
      } else {
        const firstPaymentDate = document.getElementById('first-payment-date').value;
        if (!firstPaymentDate) {
          status.textContent = 'Please select a first payment date';
          return false;
        }

        const firstDateObj = new Date(firstPaymentDate);
        firstDateObj.setHours(0, 0, 0, 0);
        if (firstDateObj < today) {
          status.textContent = 'First payment date cannot be in the past';
          return false;
        }

        // For installments, set due_date to finalDueDate for database compatibility
        wizardData.dueDate = wizardData.finalDueDate;
      }

      // Store validated data
      wizardData.friendFirstName = friendFirstName;
      wizardData.friendEmail = friendEmail;
      wizardData.description = description.charAt(0).toUpperCase() + description.slice(1);
      wizardData.amount = amountNum;

      status.textContent = '';
      return true;
    }

    // Navigate to interest step
    function goToInterest() {
      if (!validateStep2()) return;

      // Calculate recommended interest rate based on duration and fair range
      const amount = wizardData.amount;
      let durationInMonths;

      if (wizardData.repaymentType === 'installments') {
        // Convert plan duration to months
        const planLength = wizardData.planLength;
        const planUnit = wizardData.planUnit;

        if (planUnit === 'months') {
          durationInMonths = planLength;
        } else if (planUnit === 'years') {
          durationInMonths = planLength * 12;
        } else if (planUnit === 'weeks') {
          durationInMonths = planLength / 4.33; // approximate weeks to months
        } else if (planUnit === 'days') {
          durationInMonths = planLength / 30; // approximate days to months
        }
      } else {
        durationInMonths = Math.ceil((new Date(wizardData.dueDate) - new Date()) / (1000 * 60 * 60 * 24 * 30));
      }

      // Recommend rate based on fair range midpoint
      let recommendedRate;
      if (durationInMonths <= 3) {
        recommendedRate = 4;
      } else if (durationInMonths <= 12) {
        recommendedRate = 5;
      } else if (durationInMonths <= 24) {
        recommendedRate = 7;
      } else {
        recommendedRate = 8;
      }

      // Set the interest rate and trigger calculation
      document.getElementById('interest-rate').value = recommendedRate;
      wizardData.hasInterest = true;

      // Update no-interest amount for the no-interest option
      const amountCents = Math.round(wizardData.amount * 100);
      document.getElementById('no-interest-amount').textContent = `€${formatAmount(amountCents)}`;

      // Ensure "Add interest" is selected and calculate
      document.querySelector('input[name="interest-option"][value="yes"]').checked = true;
      toggleInterestFields();

      goToStep(3);
    }

    // Toggle interest fields
    function toggleInterestFields() {
      const interestOption = document.querySelector('input[name="interest-option"]:checked').value;
      const noInterestSummary = document.getElementById('no-interest-summary');
      const interestFields = document.getElementById('interest-fields');

      if (interestOption === 'yes') {
        noInterestSummary.classList.add('hidden');
        interestFields.classList.remove('hidden');
        wizardData.hasInterest = true;
        calculateInterest();
      } else {
        noInterestSummary.classList.remove('hidden');
        interestFields.classList.add('hidden');
        wizardData.hasInterest = false;
        wizardData.interestRate = 0;
        wizardData.totalInterest = 0;
        wizardData.totalRepayAmount = wizardData.amount;

        // Update no-interest amount display
        const amountCents = Math.round(wizardData.amount * 100);
        document.getElementById('no-interest-amount').textContent = `€${formatAmount(amountCents)}`;
      }
    }

    // Toggle breakdown visibility
    function toggleBreakdown() {
      const breakdown = document.getElementById('interest-breakdown');
      const toggleText = document.getElementById('breakdown-toggle-text');

      if (breakdown.classList.contains('hidden')) {
        breakdown.classList.remove('hidden');
        toggleText.textContent = 'Hide calculation';
      } else {
        breakdown.classList.add('hidden');
        toggleText.textContent = 'Show calculation';
      }
    }

    // Calculate interest using fair amortization (equal principal payments)
    function calculateInterest() {
      const interestRate = parseFloat(document.getElementById('interest-rate').value) || 0;
      const principal = wizardData.amount;

      if (!principal || principal <= 0) {
        return;
      }

      // Calculate duration in months for fair range and period rate
      let durationInMonths;
      let periodsPerYear = 12;

      if (wizardData.repaymentType === 'installments') {
        const planLength = wizardData.planLength;
        const planUnit = wizardData.planUnit;

        if (planUnit === 'months') {
          durationInMonths = planLength;
          periodsPerYear = 12;
        } else if (planUnit === 'years') {
          durationInMonths = planLength * 12;
          periodsPerYear = 12;
        } else if (planUnit === 'weeks') {
          durationInMonths = planLength / 4.33;
          periodsPerYear = 52;
        } else if (planUnit === 'days') {
          durationInMonths = planLength / 30;
          periodsPerYear = 365;
        }
      } else {
        durationInMonths = Math.ceil((new Date(wizardData.dueDate) - new Date()) / (1000 * 60 * 60 * 24 * 30));
        periodsPerYear = 12;
      }

      // Calculate fair range based on duration
      let fairRangeMin, fairRangeMax;
      if (durationInMonths <= 3) {
        fairRangeMin = 3;
        fairRangeMax = 5;
      } else if (durationInMonths <= 12) {
        fairRangeMin = 4;
        fairRangeMax = 7;
      } else if (durationInMonths <= 24) {
        fairRangeMin = 5;
        fairRangeMax = 9;
      } else {
        fairRangeMin = 6;
        fairRangeMax = 10;
      }

      // Display fair range text
      document.getElementById('fair-range-text').textContent =
        `For this type of personal loan and these repayment terms, a fair interest range is about ${fairRangeMin}–${fairRangeMax}% per year. Lower rates are generous, higher rates may feel unfair.`;

      // Show warning if rate is outside range
      const rateWarning = document.getElementById('rate-warning');
      const rateWarningText = document.getElementById('rate-warning-text');
      if (interestRate > 0 && (interestRate < fairRangeMin || interestRate > fairRangeMax)) {
        if (interestRate > fairRangeMax) {
          rateWarningText.textContent = 'Above typical range for similar loans';
          rateWarningText.style.background = '#f97316';
        } else {
          rateWarningText.textContent = 'Very low rate – unusually generous';
          rateWarningText.style.background = '#3ddc97';
          rateWarningText.style.color = '#0d130f';
        }
        rateWarning.style.display = 'block';
      } else {
        rateWarning.style.display = 'none';
      }

      // Fair interest calculation using equal principal payments
      const n = wizardData.repaymentType === 'installments' ? wizardData.installmentCount : 1;
      const annualRate = interestRate / 100;
      const periodRate = annualRate / periodsPerYear;
      const principalPerInstallment = principal / n;

      let totalInterest = 0;
      const schedule = [];

      for (let i = 1; i <= n; i++) {
        const outstandingBefore = principal - principalPerInstallment * (i - 1);
        const interestForPeriod = outstandingBefore * periodRate;
        const payment = principalPerInstallment + interestForPeriod;
        const remainingAfter = outstandingBefore - principalPerInstallment;

        totalInterest += interestForPeriod;

        schedule.push({
          period: i,
          payment: payment,
          principal: principalPerInstallment,
          interest: interestForPeriod,
          remaining: remainingAfter > 0.01 ? remainingAfter : 0
        });
      }

      const totalRepayAmount = principal + totalInterest;

      wizardData.interestRate = interestRate;
      wizardData.totalInterest = totalInterest;
      wizardData.totalRepayAmount = totalRepayAmount;

      // Display totals
      document.getElementById('total-interest-display').textContent = new Intl.NumberFormat('de-DE').format(Math.round(totalInterest));
      document.getElementById('total-repay-display').textContent = new Intl.NumberFormat('de-DE').format(Math.round(totalRepayAmount));

      // Show installment schedule note
      if (wizardData.repaymentType === 'installments' && n > 1) {
        const firstPayment = schedule[0].payment;
        const firstPaymentFormatted = new Intl.NumberFormat('de-DE').format(Math.round(firstPayment));
        document.getElementById('installment-schedule-note').textContent =
          `Estimated schedule: ${n} payments, starting around €${firstPaymentFormatted} and decreasing as the balance goes down.`;
      } else {
        document.getElementById('installment-schedule-note').textContent = '';
      }

      // Generate breakdown table
      const tbody = document.getElementById('breakdown-tbody');
      tbody.innerHTML = '';

      for (const row of schedule) {
        const tr = document.createElement('tr');
        tr.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
        tr.innerHTML = `
          <td style="padding:8px 4px">${row.period}</td>
          <td style="text-align:right; padding:8px 4px">€${new Intl.NumberFormat('de-DE').format(Math.round(row.payment))}</td>
          <td style="text-align:right; padding:8px 4px">€${new Intl.NumberFormat('de-DE').format(Math.round(row.principal))}</td>
          <td style="text-align:right; padding:8px 4px">€${new Intl.NumberFormat('de-DE').format(Math.round(row.interest))}</td>
          <td style="text-align:right; padding:8px 4px">€${new Intl.NumberFormat('de-DE').format(Math.round(row.remaining))}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    // Navigate to payment preferences
    function goToPaymentPreferences() {
      // Update interest data if no interest selected
      if (!wizardData.hasInterest) {
        wizardData.interestRate = 0;
        wizardData.totalInterest = 0;
        wizardData.totalRepayAmount = wizardData.amount;
      }

      goToStep(4);
      updateSummary();
    }

    // Toggle other payment method description field
    function toggleOtherPaymentMethod() {
      const method = document.getElementById('payment-preference').value;
      const otherField = document.getElementById('other-payment-method');

      if (method === 'other') {
        otherField.classList.remove('hidden');
      } else {
        otherField.classList.add('hidden');
        document.getElementById('other-payment-description').value = '';
      }
    }

    // Toggle reminder mode (auto vs custom)
    function toggleReminderMode() {
      const mode = document.querySelector('input[name="reminder-mode"]:checked').value;
      const customReminders = document.getElementById('custom-reminders');

      if (mode === 'custom') {
        customReminders.classList.remove('hidden');
      } else {
        customReminders.classList.add('hidden');
        // Hide error if switching away from custom
        document.getElementById('custom-reminder-error').style.display = 'none';
      }
    }

    // Update summary in step 4
    function updateSummary() {
      const lenderName = currentUser?.full_name || currentUser?.email || 'You';
      const borrowerName = wizardData.friendFirstName;
      const amountCents = Math.round(wizardData.amount * 100);
      const amountFormatted = formatAmount(amountCents);
      const description = wizardData.description;
      const interestRate = wizardData.interestRate;
      const totalRepayAmount = Math.round(wizardData.totalRepayAmount * 100);
      const totalRepayFormatted = formatAmount(totalRepayAmount);

      // Full summary text
      let summaryText = `${lenderName} lends €${amountFormatted} to ${borrowerName} for '${description}'`;

      if (wizardData.repaymentType === 'one_time') {
        const dueDate = new Date(wizardData.dueDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        summaryText += `, to be repaid in one payment by ${dueDate}`;
      } else {
        const firstDate = new Date(wizardData.firstPaymentDate).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        const finalDate = new Date(wizardData.finalDueDate).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        const installmentWithInterest = wizardData.totalRepayAmount / wizardData.installmentCount;
        const installmentFormatted = new Intl.NumberFormat('de-DE').format(Math.round(installmentWithInterest));
        summaryText += `, to be repaid in ${wizardData.installmentCount} monthly payments of about €${installmentFormatted}, from ${firstDate} to ${finalDate}`;
      }

      if (interestRate > 0) {
        const totalInterestFormatted = formatAmount(Math.round(wizardData.totalInterest * 100));
        summaryText += ` (interest ${interestRate}% p.a., total €${totalRepayFormatted})`;
      } else {
        summaryText += `.`;
      }

      document.getElementById('full-summary-text').textContent = summaryText;

      // Update summary fields
      document.getElementById('summary-description').textContent = description;
      document.getElementById('summary-friend').textContent = borrowerName;
      document.getElementById('summary-email').textContent = wizardData.friendEmail;
      document.getElementById('summary-amount').textContent = `€${amountFormatted}`;

      // Repayment summary
      if (wizardData.repaymentType === 'one_time') {
        const dueDate = new Date(wizardData.dueDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        document.getElementById('summary-repayment').textContent = `One payment on ${dueDate}`;
      } else {
        const firstDate = new Date(wizardData.firstPaymentDate).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        const finalDate = new Date(wizardData.finalDueDate).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        document.getElementById('summary-repayment').textContent =
          `${wizardData.installmentCount} monthly payments, ${firstDate} to ${finalDate}`;
      }

      document.getElementById('summary-interest').textContent = interestRate > 0 ? `${interestRate}% p.a.` : 'None';
      document.getElementById('summary-total-repay').textContent = `€${totalRepayFormatted}`;

      // Payment method
      const paymentMethod = document.getElementById('payment-preference').value;
      let paymentMethodLabel = paymentMethod === 'bank' ? 'Bank transfer' :
                               paymentMethod === 'cash' ? 'Cash in person' :
                               paymentMethod === 'crypto' ? 'Crypto' : 'Other';
      if (paymentMethod === 'other') {
        const otherDesc = document.getElementById('other-payment-description').value.trim();
        if (otherDesc) {
          paymentMethodLabel += ` (${otherDesc})`;
        }
      }
      document.getElementById('summary-payment-method').textContent = paymentMethodLabel;

      // Proof required
      const proofRequired = document.getElementById('proof-required').checked;
      document.getElementById('summary-proof-required').textContent = proofRequired ? 'Required' : 'Optional';

      // Escalation clause
      const escalationClause = document.getElementById('debt-collection-clause').checked;
      document.getElementById('summary-escalation').textContent = escalationClause ? 'Included' : 'Not included';

      document.getElementById('send-friend-name').textContent = borrowerName;
    }

    async function sendInvite() {
      const status = document.getElementById('step4-status');
      status.textContent = 'Creating agreement...';

      // Get payment preferences
      wizardData.paymentPreferenceMethod = document.getElementById('payment-preference').value;
      wizardData.paymentOtherDescription = document.getElementById('other-payment-description').value.trim();

      // Get reminder settings
      const reminderMode = document.querySelector('input[name="reminder-mode"]:checked').value;
      wizardData.reminderMode = reminderMode;

      if (reminderMode === 'auto') {
        wizardData.reminderOffsets = [-7, -1, 0, 3, 7];
      } else {
        // Get selected custom reminder offsets
        const checkboxes = document.querySelectorAll('.custom-reminder-checkbox:checked');
        if (checkboxes.length === 0) {
          document.getElementById('custom-reminder-error').style.display = 'block';
          status.textContent = '';
          return;
        }
        wizardData.reminderOffsets = Array.from(checkboxes).map(cb => parseInt(cb.value));
      }

      wizardData.proofRequired = document.getElementById('proof-required').checked;
      wizardData.debtCollectionClause = document.getElementById('debt-collection-clause').checked;

      try {
        const payload = {
          friendFirstName: wizardData.friendFirstName,
          borrowerEmail: wizardData.friendEmail,
          description: wizardData.description,
          amount: wizardData.amount,
          dueDate: wizardData.dueDate,
          direction: wizardData.role,
          repaymentType: wizardData.repaymentType,
          interestRate: wizardData.interestRate,
          totalInterest: wizardData.totalInterest,
          totalRepayAmount: wizardData.totalRepayAmount,
          paymentPreferenceMethod: wizardData.paymentPreferenceMethod,
          paymentOtherDescription: wizardData.paymentOtherDescription,
          reminderMode: wizardData.reminderMode,
          reminderOffsets: wizardData.reminderOffsets,
          proofRequired: wizardData.proofRequired,
          debtCollectionClause: wizardData.debtCollectionClause
        };

        // Add installment-specific fields if applicable
        if (wizardData.repaymentType === 'installments') {
          payload.planLength = wizardData.planLength;
          payload.planUnit = wizardData.planUnit;
          payload.installmentCount = wizardData.installmentCount;
          payload.installmentAmount = wizardData.installmentAmount;
          payload.firstPaymentDate = wizardData.firstPaymentDate;
          payload.finalDueDate = wizardData.finalDueDate;
        }

        const res = await fetch('/api/agreements', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed');

        wizardData.inviteUrl = data.inviteUrl;
        document.getElementById('invite-url').textContent = data.inviteUrl;

        // Hide send button, show invite URL
        document.getElementById('invite-not-sent').classList.add('hidden');
        document.getElementById('invite-sent').classList.remove('hidden');

        status.textContent = '';
        refresh();
        loadMessages();
      } catch (err) {
        status.textContent = '❌ ' + err.message;
      }
    }

    function copyInviteUrl() {
      const url = wizardData.inviteUrl;
      navigator.clipboard.writeText(url).then(() => {
        document.getElementById('step3-status').textContent = '✅ Copied to clipboard!';
        setTimeout(() => {
          document.getElementById('step3-status').textContent = '';
        }, 2000);
      }).catch(() => {
        document.getElementById('step3-status').textContent = '❌ Failed to copy';
      });
    }

    function resetWizard() {
      wizardData = {
        role: null,
        friendFirstName: '',
        friendEmail: '',
        description: '',
        amount: '',
        repaymentType: 'one_time',
        dueDate: '',
        planLength: null,
        planUnit: 'months',
        firstPaymentDate: '',
        installmentCount: null,
        installmentAmount: null,
        finalDueDate: '',
        hasInterest: false,
        interestRate: 0,
        totalInterest: 0,
        totalRepayAmount: 0,
        paymentPreferenceMethod: 'bank',
        paymentOtherDescription: '',
        reminderMode: 'auto',
        reminderOffsets: [-7, -1, 0, 3, 7],
        proofRequired: false,
        debtCollectionClause: false,
        inviteUrl: ''
      };

      document.getElementById('friend-first-name').value = '';
      document.getElementById('friend-email').value = '';
      document.getElementById('description').value = '';
      document.getElementById('amount').value = '';
      document.getElementById('repayment-type').value = 'one_time';
      document.getElementById('due-date').value = '';
      document.getElementById('first-payment-date').value = '';
      document.getElementById('plan-length').value = '';
      document.getElementById('plan-unit').value = 'months';
      document.getElementById('interest-rate').value = '';
      document.getElementById('payment-preference').value = 'bank';
      document.getElementById('other-payment-description').value = '';
      document.querySelector('input[name="reminder-mode"][value="auto"]').checked = true;
      document.querySelectorAll('.custom-reminder-checkbox').forEach(cb => cb.checked = false);
      document.getElementById('proof-required').checked = false;
      document.getElementById('debt-collection-clause').checked = false;
      document.querySelector('input[name="interest-option"][value="yes"]').checked = true;

      document.getElementById('step2-status').textContent = '';
      document.getElementById('step3-status').textContent = '';
      document.getElementById('step4-status').textContent = '';

      document.getElementById('invite-not-sent').classList.remove('hidden');
      document.getElementById('invite-sent').classList.add('hidden');

      // Reset field visibility
      toggleInstallmentFields();
      toggleInterestFields();

      goToStep(1);
      closeNewAgreement();
    }

    function toggleNewAgreement() {
      const section = document.getElementById('new-agreement-section');
      if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        document.getElementById('new-agreement-btn').style.display = 'none';
      } else {
        closeNewAgreement();
      }
    }

    function closeNewAgreement() {
      document.getElementById('new-agreement-section').classList.add('hidden');
      document.getElementById('new-agreement-btn').style.display = 'flex';
    }

    // Fetch current user
    async function loadUser() {
      try {
        const res = await fetch('/api/user');
        if (!res.ok) {
          window.location.href = '/';
          return;
        }
        const data = await res.json();
        currentUser = data.user;

        // Display full name and email, or just email if full_name is not set
        const displayText = currentUser.full_name
          ? `${currentUser.full_name} | ${currentUser.email}`
          : currentUser.email;
        document.getElementById('user-email').textContent = displayText;
      } catch (err) {
        console.error('Error loading user:', err);
        window.location.href = '/';
      }
    }

    // Logout
    async function logout() {
      try {
        await fetch('/auth/logout', { method: 'POST' });
        window.location.href = '/';
      } catch (err) {
        console.error('Logout error:', err);
        window.location.href = '/';
      }
    }

    // Toggle activity visibility
    function toggleActivity() {
      const activity = document.getElementById('activity-section');
      activity.style.display = activity.style.display === 'none' ? 'block' : 'none';
    }

    // Load activity
    async function loadMessages() {
      try {
        const res = await fetch('/api/messages');
        const data = await res.json();

        const messages = data.messages || [];
        const unreadCount = data.unread_count || 0;

        // Update header with unread count
        document.getElementById('activity-count').textContent = unreadCount;

        const activityList = document.getElementById('activity-list');
        if (messages.length === 0) {
          activityList.innerHTML = '<p class="empty-state">No activity yet</p>';
        } else {
          activityList.innerHTML = messages.map(msg => {
            const timestamp = new Date(msg.created_at).toLocaleString();
            const relativeTime = timeAgo(msg.created_at);
            const isUnread = !msg.read_at;

            // Determine activity text based on event_type
            let activityText = msg.body; // Fallback to original body

            if (msg.event_type === 'AGREEMENT_SENT') {
              // For sent agreements, show pending status if still pending
              const borrowerName = msg.borrower_full_name || msg.friend_first_name || msg.borrower_email;
              if (msg.agreement_status === 'pending') {
                activityText = `Agreement sent to ${msg.borrower_email} (pending review by ${borrowerName})`;
              } else {
                activityText = `Agreement sent to ${msg.borrower_email}`;
              }
            } else if (msg.event_type === 'AGREEMENT_ACCEPTED') {
              const borrowerName = msg.borrower_full_name || msg.friend_first_name || msg.borrower_email;
              activityText = `Agreement accepted by ${borrowerName}`;
            } else if (msg.event_type === 'AGREEMENT_DECLINED') {
              const borrowerName = msg.borrower_full_name || msg.friend_first_name || msg.borrower_email;
              activityText = `Agreement declined by ${borrowerName}`;
            } else if (msg.event_type === 'AGREEMENT_ASSIGNED_TO_BORROWER') {
              // Use the body text as-is for this event
              activityText = msg.body;
            } else if (msg.event_type === 'AGREEMENT_REVIEW_LATER') {
              activityText = msg.body;
            } else if (msg.event_type === 'AGREEMENT_CANCELLED_LENDER') {
              activityText = msg.body;
            } else if (msg.event_type === 'AGREEMENT_CANCELLED_BORROWER') {
              activityText = msg.body;
            }

            // Determine the link URL based on agreement_id and event_type
            let linkUrl = '';
            if (msg.agreement_id) {
              // For pending agreements where the current user is the borrower, go to review page
              if (msg.agreement_status === 'pending' && msg.borrower_user_id === currentUser.id) {
                linkUrl = `/agreements/${msg.agreement_id}/review`;
              } else {
                // Default to manage page for all other agreement-related events
                linkUrl = `/agreements/${msg.agreement_id}/manage`;
              }
            }

            const unreadClass = isUnread ? 'message-unread' : '';
            const clickableClass = linkUrl ? 'message-clickable' : '';
            const onclickAttr = linkUrl ? `onclick="handleActivityClick(${msg.id}, '${linkUrl}')"` : '';

            return `
              <div class="message-item ${unreadClass} ${clickableClass}" ${onclickAttr}>
                <div style="display:flex; justify-content:space-between; align-items:center">
                  <div class="message-date">${timestamp} (${relativeTime})</div>
                  ${isUnread ? '<span class="unread-indicator">●</span>' : ''}
                </div>
                <div style="margin-top:4px">${activityText}</div>
              </div>
            `;
          }).join('');
        }
      } catch (err) {
        console.error('Error loading activity:', err);
      }
    }

    // Handle activity item click - mark as read and navigate
    async function handleActivityClick(messageId, url) {
      try {
        // Mark as read
        await fetch(`/api/activity/${messageId}/mark-read`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        // Navigate to the URL
        window.location.href = url;
      } catch (err) {
        console.error('Error marking message as read:', err);
        // Still navigate even if marking fails
        window.location.href = url;
      }
    }

    // Mark all messages as read
    async function markAllAsRead() {
      try {
        const res = await fetch('/api/activity/mark-all-read', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (res.ok) {
          // Reload messages to update UI
          await loadMessages();
        }
      } catch (err) {
        console.error('Error marking all as read:', err);
      }
    }

    // Navigate to review page for borrowers
    function reviewAgreement(id) {
      window.location.href = `/agreements/${id}/review`;
    }

    // Navigate to manage page for lenders and borrowers
    function viewAgreement(id) {
      window.location.href = `/agreements/${id}/manage`;
    }

    // Filter agreements by status
    function filterByStatus(status) {
      currentFilter = status;

      // Update active tab
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.getAttribute('data-filter') === status) {
          tab.classList.add('active');
        }
      });

      renderAgreements();
    }

    // Render agreements based on current filter
    function renderAgreements() {
      const tbody = document.querySelector('#list tbody');
      const emptyState = document.getElementById('empty-state');
      const counterpartyHeader = document.getElementById('counterparty-header');

      let filtered = allAgreements;
      if (currentFilter !== 'all') {
        // For Pending tab, exclude cancelled agreements
        if (currentFilter === 'pending') {
          filtered = allAgreements.filter(a => a.status === 'pending');
        } else {
          filtered = allAgreements.filter(a => a.status === currentFilter);
        }
      }

      if (filtered.length === 0) {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
        document.getElementById('list').style.display = 'none';
        return;
      }

      emptyState.style.display = 'none';
      document.getElementById('list').style.display = 'table';
      tbody.innerHTML = '';

      // Determine header label based on user's role in agreements
      // Default to showing both, but if all agreements have user as same role, show specific header
      let userRoles = new Set();
      for (const a of filtered) {
        const isLender = a.lender_user_id === currentUser.id;
        userRoles.add(isLender ? 'lender' : 'borrower');
      }

      // Set header based on predominant role
      if (userRoles.size === 1) {
        if (userRoles.has('lender')) {
          counterpartyHeader.textContent = 'Borrower';
        } else {
          counterpartyHeader.textContent = 'Lender';
        }
      } else {
        // Mixed roles, keep generic header
        counterpartyHeader.textContent = 'Counterparty';
      }

      for (const a of filtered) {
        const tr = document.createElement('tr');
        tr.setAttribute('data-id', a.id);
        const amount = formatAmount(a.amount_cents);
        const statusText = a.status || 'pending';
        const capitalizedStatus = statusText.charAt(0).toUpperCase() + statusText.slice(1);

        // Build status column with main badge only
        let statusBadge = `<span class="status-badge ${statusText}">${capitalizedStatus}</span>`;

        // Determine role
        const isLender = a.lender_user_id === currentUser.id;

        // Use counterparty name only, no badge
        const counterpartyName = a.counterparty_name || '—';
        const counterpartyDisplay = counterpartyName;

        // Get description or show fallback
        const description = a.description || '<span style="color:var(--muted); font-style:italic">(No description)</span>';

        // Calculate outstanding amount
        const outstanding = formatAmount(a.outstanding_cents || a.amount_cents);

        // Build actions column with main button and conditional alert buttons
        let actionsHtml = '';
        if (statusText === 'cancelled') {
          // No actions for cancelled agreements
          actionsHtml = '—';
        } else if (statusText === 'pending' && !isLender) {
          // Borrower can review pending agreements
          actionsHtml = `<div class="actions-column">
            <button onclick="reviewAgreement(${a.id})">Review</button>
          </div>`;
        } else {
          // For lenders on any agreement, or borrowers on active/settled
          let mainBtnLabel = (statusText === 'pending' || statusText === 'active' || statusText === 'settled') ? 'Manage' : 'View';

          let buttons = `<button onclick="viewAgreement(${a.id})">${mainBtnLabel}</button>`;

          // Add conditional action buttons for lenders
          if (isLender) {
            if (a.hasPendingPaymentToConfirm) {
              buttons += `<button class="btn-confirm-payment" onclick="openConfirmPaymentModal(${a.id})">Confirm payment</button>`;
            }
            if (a.hasOpenDifficulty) {
              buttons += `<button class="btn-payment-issue" onclick="openDifficultyModal(${a.id})">Payment issue</button>`;
            }
          }

          actionsHtml = `<div class="actions-column">${buttons}</div>`;
        }

        tr.innerHTML = `
          <td>${counterpartyDisplay}</td>
          <td>${description}</td>
          <td>€ ${amount}</td>
          <td>€ ${outstanding}</td>
          <td>${a.due_date}</td>
          <td>${statusBadge}</td>
          <td>${actionsHtml}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    // Refresh agreements
    async function refresh() {
      try {
        const res = await fetch('/api/agreements');
        allAgreements = await res.json();
        renderAgreements();
      } catch (err) {
        console.error('Error loading agreements:', err);
      }
    }

    // Modal functions
    function closeModalOnOverlay(event, modalId) {
      if (event.target.classList.contains('modal-overlay')) {
        document.getElementById(modalId).style.display = 'none';
      }
    }

    // Close modal on ESC key
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeConfirmPaymentModal();
        closeDifficultyModal();
      }
    });

    // Payment Confirmation Modal
    async function openConfirmPaymentModal(agreementId) {
      const modal = document.getElementById('confirm-payment-modal');
      const modalBody = document.getElementById('confirm-payment-modal-body');

      modal.style.display = 'flex';
      modalBody.innerHTML = '<p style="text-align:center; color:var(--muted)">Loading...</p>';

      try {
        // Fetch agreement details and payments
        const [agreementRes, paymentsRes] = await Promise.all([
          fetch(`/api/agreements/${agreementId}`),
          fetch(`/api/agreements/${agreementId}/payments`)
        ]);

        if (!agreementRes.ok || !paymentsRes.ok) {
          throw new Error('Failed to load payment details');
        }

        const agreement = await agreementRes.json();
        const payments = await paymentsRes.json();

        // Find the pending payment that needs confirmation
        const pendingPayment = payments.find(p => p.status === 'pending');

        if (!pendingPayment) {
          modalBody.innerHTML = '<p style="color:var(--muted)">No pending payment found.</p>';
          return;
        }

        // Build modal content
        const amount = formatAmount(pendingPayment.amount_cents);
        const borrowerName = pendingPayment.recorded_by_name || agreement.friend_first_name || agreement.borrower_email;

        let proofOfPaymentHtml = '';
        if (pendingPayment.proof_file_path) {
          proofOfPaymentHtml = `
            <div class="modal-info-row">
              <span class="modal-info-label">Proof of payment</span>
              <button class="secondary" onclick="viewProofOfPayment(${pendingPayment.id})" style="padding:6px 12px; font-size:13px">View proof</button>
            </div>
          `;
        }

        modalBody.innerHTML = `
          <div class="modal-info-row">
            <span class="modal-info-label">Amount</span>
            <span class="modal-info-value">€ ${amount}</span>
          </div>
          <div class="modal-info-row">
            <span class="modal-info-label">Method</span>
            <span class="modal-info-value">${pendingPayment.method || '—'}</span>
          </div>
          ${pendingPayment.note ? `<div class="modal-note"><strong>Note:</strong> ${pendingPayment.note}</div>` : ''}
          <div class="modal-info-row">
            <span class="modal-info-label">Reported by</span>
            <span class="modal-info-value">${borrowerName}</span>
          </div>
          ${proofOfPaymentHtml}
          <div class="modal-footer">
            <button onclick="declinePayment(${agreementId}, ${pendingPayment.id})" class="secondary">Decline</button>
            <button onclick="confirmPayment(${agreementId}, ${pendingPayment.id})">Confirm payment</button>
          </div>
          <p class="modal-helper-text" style="margin-top:12px; text-align:center">This will update the payment history and outstanding amount.</p>
        `;
      } catch (err) {
        console.error('Error loading payment details:', err);
        modalBody.innerHTML = '<p style="color:#ff6b6b">Failed to load payment details</p>';
      }
    }

    function closeConfirmPaymentModal() {
      document.getElementById('confirm-payment-modal').style.display = 'none';
    }

    async function confirmPayment(agreementId, paymentId) {
      try {
        const res = await fetch(`/api/payments/${paymentId}/approve`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || 'Failed to confirm payment');
        }

        closeConfirmPaymentModal();
        refresh();
        loadMessages();
      } catch (err) {
        console.error('Error confirming payment:', err);
        alert('Failed to confirm payment: ' + err.message);
      }
    }

    async function declinePayment(agreementId, paymentId) {
      try {
        const res = await fetch(`/api/payments/${paymentId}/decline`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || 'Failed to decline payment');
        }

        closeConfirmPaymentModal();
        refresh();
        loadMessages();
      } catch (err) {
        console.error('Error declining payment:', err);
        alert('Failed to decline payment: ' + err.message);
      }
    }

    function viewProofOfPayment(paymentId) {
      // Open proof of payment in new tab
      window.open(`/api/payments/${paymentId}/proof`, '_blank');
    }

    // Difficulty Modal
    async function openDifficultyModal(agreementId) {
      const modal = document.getElementById('difficulty-modal');
      const modalBody = document.getElementById('difficulty-modal-body');

      modal.style.display = 'flex';
      modalBody.innerHTML = '<p style="text-align:center; color:var(--muted)">Loading...</p>';

      try {
        const res = await fetch(`/api/agreements/${agreementId}/hardship-requests`);
        if (!res.ok) throw new Error('Failed to load difficulty details');

        const hardshipRequests = await res.json();

        // Find the most recent request (they're ordered by created_at DESC)
        const openDifficulty = hardshipRequests[0];

        if (!openDifficulty) {
          modalBody.innerHTML = '<p style="color:var(--muted)">No difficulty request found.</p>';
          return;
        }

        // Build preferred options list
        let preferredOptionsHtml = '';
        if (openDifficulty.preferred_adjustments) {
          const optionLabels = {
            'smaller_payments': 'Smaller monthly payments',
            'postpone': 'Postponement',
            'longer_term': 'Longer term',
            'partial_forgiveness': 'Partial forgiveness'
          };
          const optionsArray = openDifficulty.preferred_adjustments.split(',');
          const optionsList = optionsArray
            .map(opt => optionLabels[opt.trim()] || opt)
            .join('</li><li>');
          preferredOptionsHtml = `
            <div class="modal-info-row" style="flex-direction:column; align-items:flex-start">
              <span class="modal-info-label">Preferred options:</span>
              <ul style="margin:8px 0 0 20px; padding:0">
                <li>${optionsList}</li>
              </ul>
            </div>
          `;
        }

        // Format can_pay_now amount
        let canPayNowText = '€ 0 (Cannot pay anything now)';
        if (openDifficulty.can_pay_now_cents && openDifficulty.can_pay_now_cents > 0) {
          canPayNowText = `€ ${formatAmount(openDifficulty.can_pay_now_cents)}`;
        }

        modalBody.innerHTML = `
          <p class="modal-helper-text">Your friend has asked for help with this payment. Here's what they shared:</p>

          ${openDifficulty.reason_category ? `
            <div class="modal-info-row">
              <span class="modal-info-label">Reason</span>
              <span class="modal-info-value">${openDifficulty.reason_category}</span>
            </div>
          ` : ''}

          ${openDifficulty.reason_text ? `
            <div class="modal-note"><strong>Explanation:</strong><br>${openDifficulty.reason_text}</div>
          ` : ''}

          <div class="modal-info-row">
            <span class="modal-info-label">Can pay now</span>
            <span class="modal-info-value">${canPayNowText}</span>
          </div>

          ${preferredOptionsHtml}

          <div class="modal-footer">
            <button onclick="closeDifficultyModal()" class="secondary">Close</button>
            <button onclick="window.location.href='/agreements/${agreementId}/manage'">Open full agreement</button>
          </div>
        `;
      } catch (err) {
        console.error('Error loading difficulty details:', err);
        modalBody.innerHTML = '<p style="color:#ff6b6b">Failed to load difficulty details</p>';
      }
    }

    function closeDifficultyModal() {
      document.getElementById('difficulty-modal').style.display = 'none';
    }

    // Initialize
    loadUser();
    refresh();
    loadMessages();
    goToStep(1);
  </script>
</body>
</html>
