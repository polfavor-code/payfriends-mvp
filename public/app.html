<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PayFriends — My Agreements</title>
  <style>
    :root{
      --bg:#0e1116; --card:#151a21; --text:#e6eef6; --muted:#a7b0bd; --accent:#3ddc97;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif; background:var(--bg); color:var(--text);}
    .container{max-width:1200px;margin:0 auto;padding:32px 16px;}
    .header{display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid rgba(255,255,255,0.08)}
    .header-left h1{margin:0 0 4px 0;font-size:28px}
    .header-left .user-email{color:var(--muted); font-size:14px}
    .header-right{display:flex; gap:16px; align-items:center}
    .logout-btn{padding:8px 16px;border-radius:8px;border:1px solid rgba(255,255,255,0.15);background:transparent;color:var(--text);font-weight:500; cursor:pointer; font-size:14px}
    .logout-btn:hover{background:rgba(255,255,255,0.05)}
    .inbox-widget{background:var(--card);border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:12px 16px; cursor:pointer}
    .inbox-widget:hover{background:#1a2028}
    .inbox-count{color:var(--accent); font-weight:700}
    .card{background:var(--card);border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:16px;margin:16px 0}
    .row{display:flex; gap:12px; align-items:center; margin:10px 0}
    .row label{width:160px; color:var(--muted)}
    .row input{flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text)}
    button{padding:10px 14px;border-radius:10px;border:0;background:var(--accent);color:#0d130f;font-weight:700; cursor:pointer}
    button:hover{filter:brightness(1.06)}
    button.secondary{background:transparent; border:1px solid rgba(255,255,255,0.15); color:var(--text); margin-left:8px}
    button.secondary:hover{background:rgba(255,255,255,0.05)}
    .tabs{display:flex; gap:8px; margin-bottom:16px; border-bottom:1px solid rgba(255,255,255,0.08)}
    .tab{padding:10px 16px; cursor:pointer; color:var(--muted); border-bottom:2px solid transparent; margin-bottom:-1px}
    .tab.active{color:var(--accent); border-bottom-color:var(--accent)}
    .tab:hover{color:var(--text)}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:10px 12px; border-bottom:1px solid rgba(255,255,255,0.08); text-align:left; vertical-align:middle}
    th{color:var(--muted); font-weight:600; font-size:13px}
    .status{color:var(--muted); margin-top:8px; min-height:1.2em;}
    .status-badge{display:inline-block; padding:4px 10px; border-radius:6px; font-size:12px; font-weight:600}
    .status-badge.pending{background:#4a4a4a; color:#fff}
    .status-badge.active{background:#3d7bdc; color:#fff}
    .status-badge.settled{background:#3ddc97; color:#0d130f}
    .status-badge.declined{background:#ff6b6b; color:#fff}
    .status-badge.cancelled{background:#6c757d; color:#fff}
    .actions-column{display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:flex-end; width:100%}
    .actions-column button{flex:0 0 auto; padding:8px 12px; font-size:13px; white-space:nowrap; width:auto}
    .btn-confirm-payment{background:#f97316; color:#fff; border:0; padding:8px 12px; border-radius:8px; font-weight:600; cursor:pointer; font-size:13px}
    .btn-confirm-payment:hover{background:#ea580c}
    .btn-payment-issue{background:#dc2626; color:#fff; border:0; padding:8px 12px; border-radius:8px; font-weight:600; cursor:pointer; font-size:13px}
    .btn-payment-issue:hover{background:#b91c1c}
    .messages-list{margin-top:12px}
    .message-item{padding:10px; background:#10151d; border-radius:8px; margin:8px 0; font-size:14px; transition:all 0.2s ease}
    .message-item.message-clickable{cursor:pointer; border:1px solid transparent}
    .message-item.message-clickable:hover{background:#1a2028; border-color:rgba(61,220,151,0.3); transform:translateX(2px)}
    .message-item.message-unread{font-weight:500; background:#1a2028; border:1px solid rgba(61,220,151,0.15)}
    .unread-indicator{color:var(--accent); font-size:16px; margin-left:8px}
    .message-subject{font-weight:600; margin-bottom:4px}
    .message-date{color:var(--muted); font-size:12px}
    .empty-state{text-align:center; color:var(--muted); padding:32px; font-size:14px}
    .wizard-steps{display:flex; gap:16px; margin-bottom:24px; align-items:center}
    .wizard-step{flex:1; padding:8px 16px; background:#10151d; border-radius:8px; text-align:center; font-size:14px; border:2px solid transparent; cursor:pointer; transition:all 0.2s ease}
    .wizard-step:hover{background:#1a2028; border-color:rgba(61,220,151,0.3)}
    .wizard-step.active{border-color:var(--accent); color:var(--accent); font-weight:600}
    .wizard-step.completed{color:var(--accent)}
    .wizard-content{min-height:200px}
    .hidden{display:none}
    .role-badge{display:inline-block; padding:4px 8px; border-radius:6px; font-size:11px; font-weight:600; background:#2a2a2a; color:#fff}
    .role-badge.lend{background:#3d7bdc; color:#fff}
    .role-badge.borrow{background:#e67e22; color:#fff}
    .invite-url-box{background:#10151d; padding:12px; border-radius:8px; margin:16px 0; font-family:monospace; font-size:13px; word-break:break-all; border:1px solid rgba(255,255,255,0.08)}
    .summary-row{display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.08)}
    .summary-row:last-child{border-bottom:none}
    .summary-label{color:var(--muted)}
    .summary-value{font-weight:600}
    .modal-overlay{position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:1000}
    .modal-card{background:var(--card); border:1px solid rgba(255,255,255,0.12); border-radius:16px; padding:24px; max-width:600px; width:90%; max-height:90vh; overflow-y:auto}
    .modal-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:12px; border-bottom:1px solid rgba(255,255,255,0.08)}
    .modal-title{margin:0; font-size:20px; font-weight:600}
    .modal-close{background:transparent; border:0; color:var(--muted); font-size:24px; cursor:pointer; padding:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center; border-radius:6px}
    .modal-close:hover{background:rgba(255,255,255,0.05); color:var(--text)}
    .modal-body{margin-bottom:20px}
    .modal-footer{display:flex; gap:12px; justify-content:flex-end; padding-top:16px; border-top:1px solid rgba(255,255,255,0.08)}
    .modal-info-row{display:flex; justify-content:space-between; padding:12px; background:#10151d; border-radius:8px; margin:8px 0}
    .modal-info-label{color:var(--muted); font-size:14px}
    .modal-info-value{font-weight:600; font-size:14px}
    .modal-note{background:#10151d; padding:12px; border-radius:8px; margin:12px 0; font-size:14px; color:var(--text)}
    .modal-helper-text{color:var(--muted); font-size:13px; margin-bottom:16px; line-height:1.5}
    .actions-header-text{display:inline-block; padding-left:40px}
  </style>
</head>
<body>
  <main class="container">
    <header class="header">
      <div class="header-left">
        <h1><a href="/app" style="color:var(--text); text-decoration:none; cursor:pointer">My Agreements</a></h1>
        <p class="user-email" id="user-email">Loading...</p>
      </div>
      <div class="header-right">
        <div class="inbox-widget" onclick="toggleActivity()">
          Activity (<span class="inbox-count" id="activity-count">0</span>)
        </div>
        <a href="/profile" style="color:var(--text); text-decoration:none; padding:8px 16px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background:transparent; font-weight:500; font-size:14px; display:inline-block">My Profile</a>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </header>

    <!-- Activity section (initially hidden) -->
    <section class="card" id="activity-section" style="display:none">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
        <h2 style="margin:0">Activity</h2>
        <button id="mark-all-read-btn" onclick="markAllAsRead()" style="padding:6px 12px; font-size:13px">Mark all as read</button>
      </div>
      <div class="messages-list" id="activity-list">
        <p class="empty-state">No activity yet</p>
      </div>
    </section>

    <!-- New Agreement Button -->
    <div style="margin:16px 0">
      <button id="new-agreement-btn" onclick="toggleNewAgreement()" style="display:flex; align-items:center; gap:8px; padding:12px 20px">
        <span style="font-size:18px; font-weight:bold">+</span>
        <span>New Agreement</span>
      </button>
    </div>

    <!-- Wizard for creating agreements -->
    <section class="card hidden" id="new-agreement-section">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
        <h2 style="margin:0">New Agreement</h2>
        <button class="secondary" onclick="closeNewAgreement()" style="padding:6px 12px; font-size:13px">Close</button>
      </div>

      <!-- Wizard Steps -->
      <div class="wizard-steps">
        <div class="wizard-step" id="step-indicator-1" onclick="clickStep(1)">1. Setup</div>
        <div class="wizard-step" id="step-indicator-2" onclick="clickStep(2)">2. Terms</div>
        <div class="wizard-step" id="step-indicator-3" onclick="clickStep(3)">3. Interest</div>
        <div class="wizard-step" id="step-indicator-4" onclick="clickStep(4)">4. Payments</div>
        <div class="wizard-step" id="step-indicator-5" onclick="clickStep(5)">5. Summary</div>
      </div>

      <!-- Step 1: Setup -->
      <div id="wizard-step-1" class="wizard-content">
        <h3 style="margin-top:0">Let's set up your agreement.</h3>
        <p style="color:var(--muted); font-size:14px; margin:-6px 0 20px 0">Start by choosing what you want to do.</p>

        <!-- Role selector cards -->
        <div style="margin:16px 0 24px 0">
          <label style="display:flex; align-items:center; gap:12px; cursor:pointer; padding:16px; border-radius:10px; border:2px solid rgba(255,255,255,0.08); margin-bottom:12px; transition:all 0.2s" onclick="selectRoleCard('lend')" id="role-card-lend">
            <input type="radio" name="role" value="lend" style="width:20px; height:20px" />
            <div style="flex:1">
              <div style="font-weight:600; font-size:15px">I want to lend money</div>
            </div>
          </label>
          <label style="display:flex; align-items:center; gap:12px; padding:16px; border-radius:10px; border:2px solid rgba(255,255,255,0.08); opacity:0.4; cursor:not-allowed">
            <input type="radio" name="role" value="borrow" disabled style="width:20px; height:20px" />
            <div style="flex:1">
              <div style="font-weight:600; font-size:15px">Borrow coming soon</div>
              <div style="color:var(--muted); font-size:13px">(greyed out)</div>
            </div>
          </label>
        </div>

        <div class="row">
          <label>Counterparty name*</label>
          <input id="friend-first-name" placeholder="Alex" required oninput="autoCapitalizeName()" />
        </div>
        <p style="color:var(--muted); font-size:12px; margin:-6px 0 12px 172px">Full name or first name.</p>

        <div class="row">
          <label>Counterparty email*</label>
          <input id="friend-email" type="email" placeholder="alex@example.com" required />
        </div>
        <p style="color:var(--muted); font-size:12px; margin:-6px 0 12px 172px">They'll receive a link to review the agreement.</p>

        <div class="row">
          <label>What is this for?*</label>
          <input id="description" type="text" placeholder="e.g. Money for rent, Car repair, Holiday loan" required maxlength="30" oninput="autoCapitalizeDescription()" />
        </div>
        <p style="color:var(--muted); font-size:12px; margin:-6px 0 12px 172px">A short note to identify this agreement.</p>

        <div style="margin-top:24px">
          <button onclick="goToTerms()">Continue to Terms</button>
        </div>
        <p id="step1-status" class="status"></p>
      </div>

      <!-- Step 2: Terms -->
      <div id="wizard-step-2" class="wizard-content hidden">
        <h3 style="margin-top:0">Define the loan terms.</h3>

        <div class="row">
          <label>Loan amount (€)*</label>
          <input id="amount" type="text" placeholder="6000" required onblur="formatAmountInput()" onfocus="unformatAmountInput()" />
        </div>
        <p style="color:var(--muted); font-size:12px; margin:-6px 0 20px 172px">Enter the amount in euros.</p>

        <div style="margin:16px 0 24px 0">
          <label style="font-weight:600; font-size:14px; margin-bottom:8px; display:block">Repayment type*</label>
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.08); margin-bottom:8px">
            <input type="radio" name="repayment-type" value="one_time" onchange="toggleInstallmentFields()" checked />
            <span>One-time payment</span>
          </label>
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.08)">
            <input type="radio" name="repayment-type" value="installments" onchange="toggleInstallmentFields()" />
            <span>Installments</span>
          </label>
        </div>

        <!-- One-time payment fields -->
        <div id="one-time-fields">
          <div class="row">
            <label>Due date</label>
            <input id="due-date" type="date" required onchange="updateDueDateHelper()" />
          </div>
          <p id="due-date-helper" style="color:var(--muted); font-size:12px; margin:-6px 0 12px 172px"></p>
        </div>

        <!-- Installment fields -->
        <div id="installment-fields" class="hidden">
          <div class="row">
            <label>Plan length*</label>
            <div style="flex:1; display:flex; gap:8px">
              <input id="plan-length" type="number" min="1" step="1" placeholder="12" required oninput="calculateInstallments()" style="flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text)" />
              <select id="plan-unit" onchange="calculateInstallments()" style="flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text)">
                <option value="days">Days</option>
                <option value="weeks">Weeks</option>
                <option value="months" selected>Months</option>
                <option value="years">Years</option>
              </select>
            </div>
          </div>

          <div style="margin:16px 0 24px 0">
            <label style="font-weight:600; font-size:14px; margin-bottom:8px; display:block">First payment due*</label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.08); margin-bottom:8px">
              <input type="radio" name="first-payment-option" value="1month" onchange="updateFirstPaymentOption()" checked />
              <span>In 1 month</span>
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.08); margin-bottom:8px">
              <input type="radio" name="first-payment-option" value="2months" onchange="updateFirstPaymentOption()" />
              <span>In 2 months</span>
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.08); margin-bottom:8px">
              <input type="radio" name="first-payment-option" value="3months" onchange="updateFirstPaymentOption()" />
              <span>In 3 months</span>
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.08)">
              <input type="radio" name="first-payment-option" value="custom" onchange="updateFirstPaymentOption()" />
              <span>Pick a date</span>
            </label>
          </div>

          <div id="custom-first-payment-date" class="hidden" style="margin:16px 0">
            <div class="row">
              <label>First payment date</label>
              <input id="first-payment-date" type="date" required onchange="calculateInstallments()" />
            </div>
          </div>

          <div id="final-payment-estimate" style="color:var(--accent); font-size:13px; margin:12px 0; font-weight:500"></div>
          <p id="installment-summary" style="color:var(--muted); font-size:13px; margin:8px 0 12px 0"></p>
        </div>

        <p style="color:var(--muted); font-size:13px; margin:20px 0; line-height:1.5">These terms will define your repayment schedule and fair interest calculation.</p>

        <div style="margin-top:24px">
          <button onclick="goToInterest()">Continue to Interest</button>
          <button class="secondary" onclick="goToStep(1)">Back</button>
        </div>
        <p id="step2-status" class="status"></p>
      </div>

      <!-- Step 3: Interest & Calculation -->
      <div id="wizard-step-3" class="wizard-content hidden">
        <h3 style="margin-top:0">Add interest and review calculations.</h3>

        <div class="row" style="margin-top:20px">
          <label>Interest rate (% per year)</label>
          <div style="flex:1; display:flex; align-items:center; gap:12px">
            <input id="interest-rate" type="number" min="0" max="100" step="0.1" placeholder="6.0" oninput="calculateInterest()" style="flex:1" />
            <span id="interest-rate-badge" style="display:inline-block; padding:6px 12px; border-radius:6px; font-size:12px; font-weight:600; white-space:nowrap"></span>
          </div>
        </div>

        <div style="margin:12px 0 20px 172px">
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer">
            <input type="checkbox" id="no-interest-checkbox" onchange="toggleNoInterest()" />
            <span style="font-size:14px">No interest</span>
          </label>
        </div>

        <div id="interest-summary-card" style="background:#10151d; border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:20px; margin:24px 0">
          <h4 style="margin:0 0 16px 0; font-size:16px; border-bottom:1px solid rgba(255,255,255,0.08); padding-bottom:12px">Loan summary</h4>
          <div style="display:flex; justify-content:space-between; padding:8px 0">
            <span style="color:var(--muted)">Loan amount</span>
            <span style="font-weight:600">€<span id="summary-loan-amount">0</span></span>
          </div>
          <div style="display:flex; justify-content:space-between; padding:8px 0">
            <span style="color:var(--muted)">Duration</span>
            <span style="font-weight:600" id="summary-duration">—</span>
          </div>
          <div style="display:flex; justify-content:space-between; padding:8px 0">
            <span style="color:var(--muted)">Interest rate</span>
            <span style="font-weight:600"><span id="summary-interest-rate">0</span> % per year</span>
          </div>
          <div style="display:flex; justify-content:space-between; padding:8px 0; border-top:1px solid rgba(255,255,255,0.08); margin-top:8px; padding-top:12px">
            <span style="color:var(--muted)">Total interest</span>
            <span style="font-weight:600">€<span id="total-interest-display">0</span></span>
          </div>
          <div style="display:flex; justify-content:space-between; padding:8px 0">
            <span style="color:var(--muted); font-weight:600">Total to repay</span>
            <span style="font-weight:700; font-size:18px; color:var(--accent)">€<span id="total-repay-display">0</span></span>
          </div>
          <p style="margin:12px 0 0 0; color:var(--muted); font-size:12px; line-height:1.5">Interest is calculated only on the remaining balance — fair and transparent.</p>
        </div>

        <div style="margin:20px 0">
          <button onclick="toggleBreakdown()" class="secondary" style="padding:8px 16px; font-size:14px">
            <span id="breakdown-toggle-text">Show detailed calculation</span>
          </button>
        </div>

        <div id="interest-breakdown" class="hidden" style="background:#10151d; border:1px solid rgba(255,255,255,0.08); border-radius:8px; padding:16px; margin:20px 0; max-height:400px; overflow-y:auto">
          <h5 style="margin:0 0 12px 0; font-size:14px">Amortization schedule</h5>
          <table style="width:100%; font-size:13px">
            <thead>
              <tr style="border-bottom:1px solid rgba(255,255,255,0.08)">
                <th style="text-align:left; padding:8px 4px">#</th>
                <th style="text-align:right; padding:8px 4px">Payment</th>
                <th style="text-align:right; padding:8px 4px">Interest</th>
                <th style="text-align:right; padding:8px 4px">Principal</th>
                <th style="text-align:right; padding:8px 4px">Remaining</th>
              </tr>
            </thead>
            <tbody id="breakdown-tbody"></tbody>
          </table>
        </div>

        <div style="margin-top:32px">
          <button onclick="goToPayments()">Continue to Payments</button>
          <button class="secondary" onclick="goToStep(2)">Back</button>
        </div>
        <p id="step3-status" class="status"></p>
      </div>

      <!-- Step 4: Payments & Reminders -->
      <div id="wizard-step-4" class="wizard-content hidden">
        <h3 style="margin-top:0">Decide how repayments will be made and managed.</h3>

        <!-- Payment methods -->
        <div style="margin:24px 0">
          <h4 style="margin:0 0 12px 0; font-size:16px">Payment methods</h4>
          <p style="color:var(--muted); font-size:13px; margin-bottom:12px">Select all that apply:</p>

          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); margin-bottom:6px; background:rgba(255,255,255,0.02)">
            <input type="checkbox" class="payment-method-checkbox" value="bank" checked />
            <span style="font-size:14px">Bank transfer</span>
          </label>
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); margin-bottom:6px; background:rgba(255,255,255,0.02)">
            <input type="checkbox" class="payment-method-checkbox" value="cash" />
            <span style="font-size:14px">Cash in person</span>
          </label>
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); margin-bottom:6px; background:rgba(255,255,255,0.02)">
            <input type="checkbox" class="payment-method-checkbox" value="crypto" />
            <span style="font-size:14px">Crypto</span>
          </label>
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); margin-bottom:6px; background:rgba(255,255,255,0.02)">
            <input type="checkbox" class="payment-method-checkbox" value="any" />
            <span style="font-size:14px">Any method</span>
          </label>
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); margin-bottom:6px; background:rgba(255,255,255,0.02)">
            <input type="checkbox" class="payment-method-checkbox" value="other" onchange="toggleOtherPaymentMethod()" />
            <span style="font-size:14px">Other</span>
          </label>

          <div id="other-payment-method" class="hidden" style="margin:8px 0 12px 0">
            <input id="other-payment-description" type="text" placeholder="Describe the other payment method" style="width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text)" />
          </div>

          <!-- Proof of payment requirement -->
          <div style="margin:16px 0 0 0">
            <label style="display:flex; align-items:flex-start; gap:8px; cursor:pointer">
              <input type="checkbox" id="proof-required" style="margin-top:2px" />
              <span style="font-size:14px; line-height:1.5">Borrower must upload proof when reporting a payment.</span>
            </label>
          </div>
        </div>

        <!-- Reminders -->
        <div style="margin:24px 0">
          <h4 style="margin:0 0 8px 0; font-size:16px">Reminders</h4>
          <p style="color:var(--muted); font-size:13px; margin-bottom:12px">We only send reminders when no payment has been reported for that installment.</p>

          <label style="display:flex; align-items:flex-start; gap:12px; cursor:pointer; padding:16px; border-radius:10px; border:2px solid rgba(255,255,255,0.08); margin-bottom:12px; transition:all 0.2s" id="reminder-auto-card">
            <input type="radio" name="reminder-mode" value="auto" onchange="toggleReminderMode()" checked style="margin-top:2px" />
            <div style="flex:1">
              <div style="font-weight:600; margin-bottom:6px">Auto (recommended)</div>
              <div style="color:var(--muted); font-size:13px; line-height:1.5">Borrower will receive reminders 7 days before, 1 day before, and on the due date. If still unpaid, follow-up reminders are sent 1 day after and every 3 days until payment or renegotiation.</div>
            </div>
          </label>
          <label style="display:flex; align-items:flex-start; gap:12px; cursor:pointer; padding:16px; border-radius:10px; border:2px solid rgba(255,255,255,0.08); transition:all 0.2s" id="reminder-custom-card">
            <input type="radio" name="reminder-mode" value="custom" onchange="toggleReminderMode()" style="margin-top:2px" />
            <div style="flex:1">
              <div style="font-weight:600; margin-bottom:6px">Custom schedule</div>
              <div id="custom-reminders" class="hidden" style="margin-top:12px">
                <div style="color:var(--muted); font-size:13px; margin-bottom:10px">Select when to send reminders:</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px">
                  <label style="display:flex; align-items:center; gap:6px; font-size:13px">
                    <input type="checkbox" value="-14" class="custom-reminder-checkbox" /> 14 days before
                  </label>
                  <label style="display:flex; align-items:center; gap:6px; font-size:13px">
                    <input type="checkbox" value="-7" class="custom-reminder-checkbox" /> 7 days before
                  </label>
                  <label style="display:flex; align-items:center; gap:6px; font-size:13px">
                    <input type="checkbox" value="0" class="custom-reminder-checkbox" /> On due date
                  </label>
                  <label style="display:flex; align-items:center; gap:6px; font-size:13px">
                    <input type="checkbox" value="1" class="custom-reminder-checkbox" /> 1 day after
                  </label>
                  <label style="display:flex; align-items:center; gap:6px; font-size:13px">
                    <input type="checkbox" value="3" class="custom-reminder-checkbox" /> Every 3 days after
                  </label>
                </div>
                <p id="custom-reminder-error" style="color:#ff6b6b; font-size:12px; margin-top:8px; display:none">Please select at least one reminder</p>
              </div>
            </div>
          </label>
        </div>

        <!-- Worst-case scenario -->
        <div style="margin:24px 0">
          <h4 style="margin:0 0 12px 0; font-size:16px">Worst-case scenario</h4>
          <label style="display:flex; align-items:flex-start; gap:10px; cursor:pointer; padding:16px; border-radius:10px; border:1px solid rgba(255,255,255,0.08)">
            <input type="checkbox" id="debt-collection-clause" style="margin-top:2px" />
            <div style="font-size:14px; line-height:1.6">
              <strong>Include a worst-case scenario clause.</strong>
              <div style="color:var(--muted); margin-top:6px">If the borrower fails to repay, does not initiate renegotiation, or no solution can be reached, both parties agree that the case may be transferred to an independent debt-collection partner registered under local law. Any collection fees are for the borrower's expense.</div>
            </div>
          </label>
        </div>

        <div style="margin-top:32px">
          <button onclick="goToSummary()">Continue to Summary</button>
          <button class="secondary" onclick="goToStep(3)">Back</button>
        </div>
        <p id="step4-status" class="status"></p>
      </div>

      <!-- Step 5: Summary -->
      <div id="wizard-step-5" class="wizard-content hidden">
        <h3 style="margin-top:0">Review and send your agreement.</h3>

        <!-- Summary text at top -->
        <div style="background:rgba(61,220,151,0.05); border:1px solid rgba(61,220,151,0.15); border-radius:12px; padding:20px; margin:20px 0">
          <p id="full-summary-text" style="margin:0; color:var(--text); font-size:15px; line-height:1.8"></p>
        </div>

        <!-- Expandable: Repayment schedule -->
        <div style="margin:16px 0">
          <button onclick="toggleSection('repayment-schedule-section')" class="secondary" style="width:100%; text-align:left; padding:12px 16px; font-size:14px; display:flex; justify-content:space-between; align-items:center">
            <span>Repayment schedule</span>
            <span id="repayment-schedule-toggle">▼</span>
          </button>
          <div id="repayment-schedule-section" class="hidden" style="background:#10151d; border:1px solid rgba(255,255,255,0.08); border-radius:0 0 8px 8px; padding:16px; margin-top:-1px">
            <div id="repayment-schedule-content"></div>
          </div>
        </div>

        <!-- Expandable: Interest calculation -->
        <div style="margin:16px 0">
          <button onclick="toggleSection('interest-calc-section')" class="secondary" style="width:100%; text-align:left; padding:12px 16px; font-size:14px; display:flex; justify-content:space-between; align-items:center">
            <span>Interest calculation</span>
            <span id="interest-calc-toggle">▼</span>
          </button>
          <div id="interest-calc-section" class="hidden" style="background:#10151d; border:1px solid rgba(255,255,255,0.08); border-radius:0 0 8px 8px; padding:16px; margin-top:-1px">
            <div id="interest-calc-content"></div>
          </div>
        </div>

        <!-- Expandable: Reminder plan -->
        <div style="margin:16px 0">
          <button onclick="toggleSection('reminder-plan-section')" class="secondary" style="width:100%; text-align:left; padding:12px 16px; font-size:14px; display:flex; justify-content:space-between; align-items:center">
            <span>Reminder plan</span>
            <span id="reminder-plan-toggle">▼</span>
          </button>
          <div id="reminder-plan-section" class="hidden" style="background:#10151d; border:1px solid rgba(255,255,255,0.08); border-radius:0 0 8px 8px; padding:16px; margin-top:-1px">
            <div id="reminder-plan-content"></div>
          </div>
        </div>

        <!-- Expandable: Clauses & conditions -->
        <div style="margin:16px 0">
          <button onclick="toggleSection('clauses-section')" class="secondary" style="width:100%; text-align:left; padding:12px 16px; font-size:14px; display:flex; justify-content:space-between; align-items:center">
            <span>Clauses & conditions</span>
            <span id="clauses-toggle">▼</span>
          </button>
          <div id="clauses-section" class="hidden" style="background:#10151d; border:1px solid rgba(255,255,255,0.08); border-radius:0 0 8px 8px; padding:16px; margin-top:-1px">
            <div id="clauses-content"></div>
          </div>
        </div>

        <div id="invite-not-sent" style="margin-top:32px">
          <button onclick="sendInvite()">Send to <span id="send-friend-name"></span> for review</button>
          <button class="secondary" onclick="goToStep(4)">Back to edit</button>
        </div>

        <div id="invite-sent" class="hidden">
          <div style="background:rgba(61,220,151,0.1); border:1px solid rgba(61,220,151,0.2); border-radius:12px; padding:16px; margin:24px 0">
            <p style="margin:0; color:var(--accent); font-weight:600; font-size:16px">✓ Invite sent!</p>
          </div>
          <p style="color:var(--muted); font-size:14px">Share this invite link with your friend:</p>
          <div class="invite-url-box" id="invite-url"></div>
          <button onclick="copyInviteUrl()">Copy invite link</button>
          <button class="secondary" onclick="resetWizard()">Create another agreement</button>
        </div>

        <p id="step5-status" class="status"></p>
      </div>
    </section>

    <section class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
        <h2 style="margin:0">Agreements</h2>
      </div>

      <div class="tabs">
        <div class="tab active" data-filter="all" onclick="filterByStatus('all')">All</div>
        <div class="tab" data-filter="pending" onclick="filterByStatus('pending')">Pending</div>
        <div class="tab" data-filter="active" onclick="filterByStatus('active')">Active</div>
        <div class="tab" data-filter="settled" onclick="filterByStatus('settled')">Settled</div>
      </div>

      <table id="list">
        <thead>
          <tr>
            <th id="counterparty-header">Counterparty</th>
            <th>Description</th>
            <th>Amount</th>
            <th>Outstanding</th>
            <th>Due</th>
            <th>Status</th>
            <th><span class="actions-header-text">Actions</span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="empty-state" class="empty-state" style="display:none">
        No agreements found for this filter.
      </div>
    </section>

    <!-- Payment Confirmation Modal -->
    <div id="confirm-payment-modal" class="modal-overlay" style="display:none" onclick="closeModalOnOverlay(event, 'confirm-payment-modal')">
      <div class="modal-card" onclick="event.stopPropagation()">
        <div class="modal-header">
          <h2 class="modal-title">Confirm payment</h2>
          <button class="modal-close" onclick="closeConfirmPaymentModal()">&times;</button>
        </div>
        <div class="modal-body" id="confirm-payment-modal-body">
          <p style="text-align:center; color:var(--muted)">Loading...</p>
        </div>
      </div>
    </div>

    <!-- Payment Issue Modal -->
    <div id="difficulty-modal" class="modal-overlay" style="display:none" onclick="closeModalOnOverlay(event, 'difficulty-modal')">
      <div class="modal-card" onclick="event.stopPropagation()">
        <div class="modal-header">
          <h2 class="modal-title">Payment issue</h2>
          <button class="modal-close" onclick="closeDifficultyModal()">&times;</button>
        </div>
        <div class="modal-body" id="difficulty-modal-body">
          <p style="text-align:center; color:var(--muted)">Loading...</p>
        </div>
      </div>
    </div>
  </main>

  <script>
    let allAgreements = [];
    let currentFilter = 'all';
    let currentUser = null;
    let wizardData = {
      role: null,
      friendFirstName: '',
      friendEmail: '',
      description: '',
      amount: '',
      repaymentType: 'one_time',
      dueDate: '',
      // Installment fields
      planLength: null,
      planUnit: 'months',
      firstPaymentDate: '',
      installmentCount: null,
      installmentAmount: null,
      finalDueDate: '',
      // Interest fields
      hasInterest: true,
      interestRate: 0,
      totalInterest: 0,
      totalRepayAmount: 0,
      // Payment preferences
      paymentMethods: ['bank'],
      paymentOtherDescription: '',
      reminderMode: 'auto',
      reminderOffsets: [-7, -1, 0, 1, 3],
      proofRequired: false,
      debtCollectionClause: false,
      inviteUrl: ''
    };

    // Format amount in cents to euros with thousand separators, no decimals
    function formatAmount(cents) {
      const euros = Math.round(cents / 100);
      return new Intl.NumberFormat('de-DE').format(euros);
    }

    // Format the amount input field on blur
    function formatAmountInput() {
      const input = document.getElementById('amount');
      const value = input.value.trim();
      if (!value) return;

      // Remove any existing formatting (dots, commas)
      const cleanValue = value.replace(/[.,]/g, '');
      const num = parseFloat(cleanValue);

      if (!isNaN(num) && num > 0) {
        // Format with thousand separators (German style: 6.000)
        input.value = new Intl.NumberFormat('de-DE').format(num);
      }
    }

    // Remove formatting from amount input on focus for easier editing
    function unformatAmountInput() {
      const input = document.getElementById('amount');
      const value = input.value.trim();
      if (!value) return;

      // Remove thousand separators
      const cleanValue = value.replace(/\./g, '').replace(/,/g, '');
      if (!isNaN(cleanValue) && cleanValue !== '') {
        input.value = cleanValue;
      }
    }

    // Capitalize first letter of description
    function capitalizeDescription() {
      const input = document.getElementById('description');
      const value = input.value.trim();
      if (value.length > 0) {
        input.value = value.charAt(0).toUpperCase() + value.slice(1);
      }
    }

    // Calculate time ago from a timestamp
    function timeAgo(timestamp) {
      const now = new Date();
      const past = new Date(timestamp);
      const diffMs = now - past;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);
      const diffHour = Math.floor(diffMin / 60);
      const diffDay = Math.floor(diffHour / 24);

      if (diffSec < 60) return 'just now';
      if (diffMin < 60) return `${diffMin} min${diffMin > 1 ? 's' : ''} ago`;
      if (diffHour < 24) return `${diffHour} hour${diffHour > 1 ? 's' : ''} ago`;
      if (diffDay === 1) return '1 day ago';
      if (diffDay < 30) return `${diffDay} days ago`;
      const diffMonth = Math.floor(diffDay / 30);
      if (diffMonth === 1) return '1 month ago';
      if (diffMonth < 12) return `${diffMonth} months ago`;
      const diffYear = Math.floor(diffDay / 365);
      return `${diffYear} year${diffYear > 1 ? 's' : ''} ago`;
    }

    // Wizard functions
    function goToStep(step) {
      // Hide all steps
      for (let i = 1; i <= 5; i++) {
        document.getElementById(`wizard-step-${i}`).classList.add('hidden');
        document.getElementById(`step-indicator-${i}`).classList.remove('active');
      }

      // Show current step
      document.getElementById(`wizard-step-${step}`).classList.remove('hidden');
      document.getElementById(`step-indicator-${step}`).classList.add('active');

      // Mark previous steps as completed
      for (let i = 1; i < step; i++) {
        document.getElementById(`step-indicator-${i}`).classList.add('completed');
      }
    }

    // Handle step click with validation
    function clickStep(targetStep) {
      // Determine current step
      let currentStep = 1;
      for (let i = 1; i <= 5; i++) {
        if (!document.getElementById(`wizard-step-${i}`).classList.contains('hidden')) {
          currentStep = i;
          break;
        }
      }

      // Allow clicking back without validation
      if (targetStep < currentStep) {
        goToStep(targetStep);
        return;
      }

      // If clicking forward, validate current step and navigate
      if (targetStep > currentStep) {
        // Step 1 → 2+: Validate step 1 fields
        if (currentStep === 1 && targetStep >= 2) {
          if (!validateStep1()) return;
          if (targetStep === 2) {
            goToTerms();
            return;
          }
        }

        // Step 2 → 3+: Validate step 2 fields
        if (currentStep === 2 && targetStep >= 3) {
          if (!validateStep2()) return;
          if (targetStep === 3) {
            goToInterest();
            return;
          }
        }

        // Step 3 → 4+: Navigate to payments
        if (currentStep === 3 && targetStep >= 4) {
          if (targetStep === 4) {
            goToPayments();
            return;
          }
        }

        // Step 4 → 5: Navigate to summary
        if (currentStep === 4 && targetStep === 5) {
          goToSummary();
          return;
        }
      }

      // If same step, do nothing
      if (targetStep === currentStep) {
        return;
      }
    }

    // Select role card and update UI
    function selectRoleCard(role) {
      wizardData.role = role;
      document.querySelector(`input[name="role"][value="${role}"]`).checked = true;

      // Visual feedback
      document.getElementById('role-card-lend').style.borderColor = role === 'lend' ? 'var(--accent)' : 'rgba(255,255,255,0.08)';
    }

    // Auto-capitalize name input
    function autoCapitalizeName() {
      const input = document.getElementById('friend-first-name');
      const value = input.value;
      if (value.length > 0) {
        input.value = value.charAt(0).toUpperCase() + value.slice(1);
      }
    }

    // Auto-capitalize description input
    function autoCapitalizeDescription() {
      const input = document.getElementById('description');
      const value = input.value;
      if (value.length > 0) {
        input.value = value.charAt(0).toUpperCase() + value.slice(1);
      }
    }

    // Validate step 1 (Setup)
    function validateStep1() {
      const role = wizardData.role || document.querySelector('input[name="role"]:checked')?.value;
      const friendFirstName = document.getElementById('friend-first-name').value.trim();
      const friendEmail = document.getElementById('friend-email').value.trim();
      const description = document.getElementById('description').value.trim();
      const status = document.getElementById('step1-status');

      if (!role) {
        status.textContent = 'Please select a role (lend or borrow)';
        return false;
      }

      if (!friendFirstName) {
        status.textContent = 'Please enter counterparty name';
        return false;
      }

      if (!friendEmail) {
        status.textContent = 'Please enter counterparty email';
        return false;
      }

      if (!description) {
        status.textContent = 'Please enter what this is for';
        return false;
      }

      if (description.length > 30) {
        status.textContent = 'Description must be 30 characters or less';
        return false;
      }

      // Store validated data
      wizardData.role = role;
      wizardData.friendFirstName = friendFirstName.charAt(0).toUpperCase() + friendFirstName.slice(1);
      wizardData.friendEmail = friendEmail;
      wizardData.description = description.charAt(0).toUpperCase() + description.slice(1);

      status.textContent = '';
      return true;
    }

    // Navigate to Terms step
    function goToTerms() {
      if (!validateStep1()) return;
      goToStep(2);
    }

    // Toggle between one-time and installment fields
    function toggleInstallmentFields() {
      const repaymentType = document.querySelector('input[name="repayment-type"]:checked').value;
      const oneTimeFields = document.getElementById('one-time-fields');
      const installmentFields = document.getElementById('installment-fields');

      if (repaymentType === 'installments') {
        oneTimeFields.classList.add('hidden');
        installmentFields.classList.remove('hidden');
        wizardData.repaymentType = 'installments';
        // Set default first payment option
        document.querySelector('input[name="first-payment-option"][value="1month"]').checked = true;
        updateFirstPaymentOption();
      } else {
        oneTimeFields.classList.remove('hidden');
        installmentFields.classList.add('hidden');
        wizardData.repaymentType = 'one_time';
        updateDueDateHelper();
      }
    }

    // Update first payment date based on selected option
    function updateFirstPaymentOption() {
      const option = document.querySelector('input[name="first-payment-option"]:checked').value;
      const customDateField = document.getElementById('custom-first-payment-date');
      const firstPaymentDateInput = document.getElementById('first-payment-date');

      if (option === 'custom') {
        customDateField.classList.remove('hidden');
      } else {
        customDateField.classList.add('hidden');

        // Calculate first payment date
        const today = new Date();
        let firstDate;

        if (option === '1month') {
          firstDate = new Date(today);
          firstDate.setMonth(firstDate.getMonth() + 1);
        } else if (option === '2months') {
          firstDate = new Date(today);
          firstDate.setMonth(firstDate.getMonth() + 2);
        } else if (option === '3months') {
          firstDate = new Date(today);
          firstDate.setMonth(firstDate.getMonth() + 3);
        }

        // Set the date input value
        firstPaymentDateInput.value = firstDate.toISOString().split('T')[0];
        calculateInstallments();
      }
    }

    // Calculate installment details
    function calculateInstallments() {
      const amount = document.getElementById('amount').value;
      const planLength = parseInt(document.getElementById('plan-length').value);
      const planUnit = document.getElementById('plan-unit').value;
      const firstPaymentDate = document.getElementById('first-payment-date').value;

      if (!amount || !planLength || !firstPaymentDate) {
        document.getElementById('installment-summary').textContent = '';
        return;
      }

      if (planLength <= 0) {
        document.getElementById('installment-summary').textContent = 'Plan length must be greater than 0';
        return;
      }

      // Parse amount
      const cleanAmount = amount.replace(/[.,]/g, '');
      const amountNum = parseFloat(cleanAmount);

      if (isNaN(amountNum) || amountNum <= 0) {
        document.getElementById('installment-summary').textContent = '';
        return;
      }

      // Calculate installment count based on unit
      let installmentCount;
      if (planUnit === 'months') {
        installmentCount = planLength;
      } else if (planUnit === 'years') {
        installmentCount = planLength * 12;
      } else if (planUnit === 'weeks') {
        installmentCount = planLength;
      } else if (planUnit === 'days') {
        installmentCount = planLength;
      }

      // Calculate installment amount
      const installmentAmount = (amountNum / installmentCount).toFixed(2);

      // Calculate final due date based on unit
      const firstDate = new Date(firstPaymentDate);
      const finalDate = new Date(firstDate);

      if (planUnit === 'months') {
        finalDate.setMonth(finalDate.getMonth() + planLength - 1);
      } else if (planUnit === 'years') {
        finalDate.setFullYear(finalDate.getFullYear() + planLength);
        finalDate.setMonth(finalDate.getMonth() - 1);
      } else if (planUnit === 'weeks') {
        finalDate.setDate(finalDate.getDate() + (planLength - 1) * 7);
      } else if (planUnit === 'days') {
        finalDate.setDate(finalDate.getDate() + planLength - 1);
      }

      // Format dates
      const firstFormatted = firstDate.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
      const finalFormatted = finalDate.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });

      // Store in wizard data
      wizardData.planLength = planLength;
      wizardData.planUnit = planUnit;
      wizardData.installmentCount = installmentCount;
      wizardData.installmentAmount = parseFloat(installmentAmount);
      wizardData.firstPaymentDate = firstPaymentDate;
      wizardData.finalDueDate = finalDate.toISOString().split('T')[0];

      // Display summary
      const amountFormatted = new Intl.NumberFormat('de-DE').format(Math.round(amountNum));
      const installmentFormatted = new Intl.NumberFormat('de-DE').format(Math.round(installmentAmount));

      // Choose appropriate frequency label
      let frequencyLabel = planUnit === 'months' ? 'monthly' :
                          planUnit === 'years' ? 'monthly' :
                          planUnit === 'weeks' ? 'weekly' :
                          'daily';

      document.getElementById('final-payment-estimate').textContent =
        `Estimated final payment date: ${finalFormatted}`;
      document.getElementById('installment-summary').textContent =
        `${installmentCount} ${frequencyLabel} payments of about €${installmentFormatted} each.`;
    }

    // Update due date helper text
    function updateDueDateHelper() {
      const dueDate = document.getElementById('due-date').value;
      if (!dueDate) {
        document.getElementById('due-date-helper').textContent = '';
        return;
      }

      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const dueDateObj = new Date(dueDate);
      dueDateObj.setHours(0, 0, 0, 0);

      const diffMs = dueDateObj - today;
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

      if (diffDays > 0) {
        document.getElementById('due-date-helper').textContent = `Due in ${diffDays} day${diffDays === 1 ? '' : 's'}`;
      } else if (diffDays === 0) {
        document.getElementById('due-date-helper').textContent = 'Due today';
      } else {
        document.getElementById('due-date-helper').textContent = 'Due date cannot be in the past';
      }
    }

    // Validate step 2 (Terms)
    function validateStep2() {
      const amount = document.getElementById('amount').value;
      const repaymentType = document.querySelector('input[name="repayment-type"]:checked').value;
      const status = document.getElementById('step2-status');

      if (!amount) {
        status.textContent = 'Please enter a loan amount';
        return false;
      }

      // Validate amount
      const cleanAmount = amount.replace(/[.,]/g, '');
      const amountNum = parseFloat(cleanAmount);
      if (isNaN(amountNum) || amountNum <= 0) {
        status.textContent = 'Please enter a valid amount';
        return false;
      }

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      if (repaymentType === 'one_time') {
        const dueDate = document.getElementById('due-date').value;
        if (!dueDate) {
          status.textContent = 'Please select a due date';
          return false;
        }

        const dueDateObj = new Date(dueDate);
        dueDateObj.setHours(0, 0, 0, 0);
        if (dueDateObj < today) {
          status.textContent = 'Due date cannot be in the past';
          return false;
        }

        wizardData.dueDate = dueDate;
        wizardData.finalDueDate = dueDate;
      } else {
        const planLength = parseInt(document.getElementById('plan-length').value);
        if (!planLength || planLength <= 0) {
          status.textContent = 'Please enter a valid plan length';
          return false;
        }

        const firstPaymentDate = document.getElementById('first-payment-date').value;
        if (!firstPaymentDate) {
          status.textContent = 'Please select a first payment date';
          return false;
        }

        const firstDateObj = new Date(firstPaymentDate);
        firstDateObj.setHours(0, 0, 0, 0);
        if (firstDateObj < today) {
          status.textContent = 'First payment date cannot be in the past';
          return false;
        }

        // For installments, set due_date to finalDueDate for database compatibility
        wizardData.dueDate = wizardData.finalDueDate;
      }

      // Store validated data
      wizardData.amount = amountNum;

      status.textContent = '';
      return true;
    }

    // Navigate to interest step
    function goToInterest() {
      if (!validateStep2()) return;

      // Calculate recommended interest rate based on duration and fair range
      const amount = wizardData.amount;
      let durationInMonths;

      if (wizardData.repaymentType === 'installments') {
        // Convert plan duration to months
        const planLength = wizardData.planLength;
        const planUnit = wizardData.planUnit;

        if (planUnit === 'months') {
          durationInMonths = planLength;
        } else if (planUnit === 'years') {
          durationInMonths = planLength * 12;
        } else if (planUnit === 'weeks') {
          durationInMonths = planLength / 4.33; // approximate weeks to months
        } else if (planUnit === 'days') {
          durationInMonths = planLength / 30; // approximate days to months
        }
      } else {
        durationInMonths = Math.ceil((new Date(wizardData.dueDate) - new Date()) / (1000 * 60 * 60 * 24 * 30));
      }

      // Recommend rate based on fair range midpoint
      let recommendedRate;
      if (durationInMonths <= 3) {
        recommendedRate = 4;
      } else if (durationInMonths <= 12) {
        recommendedRate = 5;
      } else if (durationInMonths <= 24) {
        recommendedRate = 7;
      } else {
        recommendedRate = 8;
      }

      // Set the interest rate and trigger calculation
      document.getElementById('interest-rate').value = recommendedRate;
      wizardData.hasInterest = true;

      // Ensure no-interest checkbox is unchecked
      document.getElementById('no-interest-checkbox').checked = false;

      goToStep(3);
      calculateInterest();
    }

    // Toggle no interest checkbox
    function toggleNoInterest() {
      const checkbox = document.getElementById('no-interest-checkbox');
      const interestRateInput = document.getElementById('interest-rate');

      if (checkbox.checked) {
        // Disable interest rate input
        interestRateInput.disabled = true;
        interestRateInput.style.opacity = '0.5';
        interestRateInput.value = '0';
        wizardData.hasInterest = false;
        wizardData.interestRate = 0;
        wizardData.totalInterest = 0;
        wizardData.totalRepayAmount = wizardData.amount;

        // Hide badge
        document.getElementById('interest-rate-badge').style.display = 'none';

        // Update summary
        calculateInterest();
      } else {
        // Enable interest rate input
        interestRateInput.disabled = false;
        interestRateInput.style.opacity = '1';
        interestRateInput.value = '6';
        wizardData.hasInterest = true;

        // Show badge
        document.getElementById('interest-rate-badge').style.display = 'inline-block';

        // Recalculate
        calculateInterest();
      }
    }

    // Toggle breakdown visibility
    function toggleBreakdown() {
      const breakdown = document.getElementById('interest-breakdown');
      const toggleText = document.getElementById('breakdown-toggle-text');

      if (breakdown.classList.contains('hidden')) {
        breakdown.classList.remove('hidden');
        toggleText.textContent = 'Hide calculation';
      } else {
        breakdown.classList.add('hidden');
        toggleText.textContent = 'Show calculation';
      }
    }

    // Calculate interest using fair amortization (equal principal payments)
    function calculateInterest() {
      const interestRate = parseFloat(document.getElementById('interest-rate').value) || 0;
      const principal = wizardData.amount;

      if (!principal || principal <= 0) {
        return;
      }

      // Calculate duration in months for fair range and period rate
      let durationInMonths;
      let periodsPerYear = 12;
      let durationLabel = '';

      if (wizardData.repaymentType === 'installments') {
        const planLength = wizardData.planLength;
        const planUnit = wizardData.planUnit;

        if (planUnit === 'months') {
          durationInMonths = planLength;
          periodsPerYear = 12;
          durationLabel = `${planLength} month${planLength > 1 ? 's' : ''}`;
        } else if (planUnit === 'years') {
          durationInMonths = planLength * 12;
          periodsPerYear = 12;
          durationLabel = `${planLength} year${planLength > 1 ? 's' : ''}`;
        } else if (planUnit === 'weeks') {
          durationInMonths = planLength / 4.33;
          periodsPerYear = 52;
          durationLabel = `${planLength} week${planLength > 1 ? 's' : ''}`;
        } else if (planUnit === 'days') {
          durationInMonths = planLength / 30;
          periodsPerYear = 365;
          durationLabel = `${planLength} day${planLength > 1 ? 's' : ''}`;
        }
      } else {
        durationInMonths = Math.ceil((new Date(wizardData.dueDate) - new Date()) / (1000 * 60 * 60 * 24 * 30));
        periodsPerYear = 12;
        durationLabel = 'One-time payment';
      }

      // Calculate fair range based on duration
      let fairRangeMin, fairRangeMax;
      if (durationInMonths <= 3) {
        fairRangeMin = 3;
        fairRangeMax = 5;
      } else if (durationInMonths <= 12) {
        fairRangeMin = 4;
        fairRangeMax = 7;
      } else if (durationInMonths <= 24) {
        fairRangeMin = 5;
        fairRangeMax = 9;
      } else {
        fairRangeMin = 6;
        fairRangeMax = 10;
      }

      // Update badge based on rate
      const badge = document.getElementById('interest-rate-badge');
      if (document.getElementById('no-interest-checkbox').checked || interestRate === 0) {
        badge.style.display = 'none';
      } else {
        badge.style.display = 'inline-block';
        if (interestRate >= fairRangeMin && interestRate <= fairRangeMax) {
          badge.textContent = `🟢 Fair range (${fairRangeMin}–${fairRangeMax}%)`;
          badge.style.background = 'rgba(61,220,151,0.15)';
          badge.style.color = 'var(--accent)';
        } else if (interestRate > fairRangeMax) {
          badge.textContent = `🟠 Above typical (>${fairRangeMax}%)`;
          badge.style.background = 'rgba(249,115,22,0.15)';
          badge.style.color = '#f97316';
        } else {
          badge.textContent = `🔵 Generous (<${fairRangeMin}%)`;
          badge.style.background = 'rgba(59,130,246,0.15)';
          badge.style.color = '#3b82f6';
        }
      }

      // Fair interest calculation using equal principal payments
      const n = wizardData.repaymentType === 'installments' ? wizardData.installmentCount : 1;
      const annualRate = interestRate / 100;
      const periodRate = annualRate / periodsPerYear;
      const principalPerInstallment = principal / n;

      let totalInterest = 0;
      const schedule = [];

      for (let i = 1; i <= n; i++) {
        const outstandingBefore = principal - principalPerInstallment * (i - 1);
        const interestForPeriod = outstandingBefore * periodRate;
        const payment = principalPerInstallment + interestForPeriod;
        const remainingAfter = outstandingBefore - principalPerInstallment;

        totalInterest += interestForPeriod;

        schedule.push({
          period: i,
          payment: payment,
          principal: principalPerInstallment,
          interest: interestForPeriod,
          remaining: remainingAfter > 0.01 ? remainingAfter : 0
        });
      }

      const totalRepayAmount = principal + totalInterest;

      wizardData.interestRate = interestRate;
      wizardData.totalInterest = totalInterest;
      wizardData.totalRepayAmount = totalRepayAmount;

      // Update summary card
      document.getElementById('summary-loan-amount').textContent = new Intl.NumberFormat('de-DE').format(Math.round(principal));
      document.getElementById('summary-duration').textContent = durationLabel;
      document.getElementById('summary-interest-rate').textContent = interestRate;
      document.getElementById('total-interest-display').textContent = new Intl.NumberFormat('de-DE').format(Math.round(totalInterest));
      document.getElementById('total-repay-display').textContent = new Intl.NumberFormat('de-DE').format(Math.round(totalRepayAmount));

      // Generate breakdown table
      const tbody = document.getElementById('breakdown-tbody');
      tbody.innerHTML = '';

      for (const row of schedule) {
        const tr = document.createElement('tr');
        tr.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
        tr.innerHTML = `
          <td style="padding:8px 4px">${row.period}</td>
          <td style="text-align:right; padding:8px 4px">€${new Intl.NumberFormat('de-DE').format(Math.round(row.payment))}</td>
          <td style="text-align:right; padding:8px 4px">€${new Intl.NumberFormat('de-DE').format(Math.round(row.principal))}</td>
          <td style="text-align:right; padding:8px 4px">€${new Intl.NumberFormat('de-DE').format(Math.round(row.interest))}</td>
          <td style="text-align:right; padding:8px 4px">€${new Intl.NumberFormat('de-DE').format(Math.round(row.remaining))}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    // Navigate to payment preferences
    function goToPayments() {
      // Update interest data if no interest selected
      if (!wizardData.hasInterest || document.getElementById('no-interest-checkbox').checked) {
        wizardData.interestRate = 0;
        wizardData.totalInterest = 0;
        wizardData.totalRepayAmount = wizardData.amount;
      }

      goToStep(4);
    }

    // Navigate to summary
    function goToSummary() {
      // Get selected payment methods
      const selectedMethods = Array.from(document.querySelectorAll('.payment-method-checkbox:checked')).map(cb => cb.value);
      wizardData.paymentMethods = selectedMethods;

      // Get payment other description if "other" is selected
      if (selectedMethods.includes('other')) {
        wizardData.paymentOtherDescription = document.getElementById('other-payment-description').value.trim();
      }

      // Get reminder settings
      const reminderMode = document.querySelector('input[name="reminder-mode"]:checked').value;
      wizardData.reminderMode = reminderMode;

      if (reminderMode === 'auto') {
        wizardData.reminderOffsets = [-7, -1, 0, 1, 3];
      } else {
        // Get selected custom reminder offsets
        const checkboxes = document.querySelectorAll('.custom-reminder-checkbox:checked');
        if (checkboxes.length === 0) {
          document.getElementById('custom-reminder-error').style.display = 'block';
          document.getElementById('step4-status').textContent = 'Please select at least one reminder';
          return;
        }
        wizardData.reminderOffsets = Array.from(checkboxes).map(cb => parseInt(cb.value));
      }

      wizardData.proofRequired = document.getElementById('proof-required').checked;
      wizardData.debtCollectionClause = document.getElementById('debt-collection-clause').checked;

      goToStep(5);
      updateSummary();
    }

    // Toggle expandable sections in summary
    function toggleSection(sectionId) {
      const section = document.getElementById(sectionId);
      const toggleId = sectionId.replace('-section', '-toggle');
      const toggle = document.getElementById(toggleId);

      if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        toggle.textContent = '▲';
      } else {
        section.classList.add('hidden');
        toggle.textContent = '▼';
      }
    }

    // Toggle other payment method description field
    function toggleOtherPaymentMethod() {
      const otherCheckbox = document.querySelector('.payment-method-checkbox[value="other"]');
      const otherField = document.getElementById('other-payment-method');

      if (otherCheckbox && otherCheckbox.checked) {
        otherField.classList.remove('hidden');
      } else {
        otherField.classList.add('hidden');
        document.getElementById('other-payment-description').value = '';
      }
    }

    // Toggle reminder mode (auto vs custom)
    function toggleReminderMode() {
      const mode = document.querySelector('input[name="reminder-mode"]:checked').value;
      const customReminders = document.getElementById('custom-reminders');

      if (mode === 'custom') {
        customReminders.classList.remove('hidden');
      } else {
        customReminders.classList.add('hidden');
        // Hide error if switching away from custom
        document.getElementById('custom-reminder-error').style.display = 'none';
      }
    }

    // Update summary in step 5
    function updateSummary() {
      const lenderName = currentUser?.full_name || currentUser?.email || 'You';
      const borrowerName = wizardData.friendFirstName;
      const amountCents = Math.round(wizardData.amount * 100);
      const amountFormatted = formatAmount(amountCents);
      const description = wizardData.description;
      const interestRate = wizardData.interestRate;
      const totalRepayAmount = Math.round(wizardData.totalRepayAmount * 100);
      const totalRepayFormatted = formatAmount(totalRepayAmount);

      // Full summary text
      let summaryText = `${lenderName} lends €${amountFormatted} to ${borrowerName} for '${description}'. `;

      if (wizardData.repaymentType === 'one_time') {
        const dueDate = new Date(wizardData.dueDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        summaryText += `Repayable in one payment by ${dueDate}`;
      } else {
        summaryText += `Repayable in ${wizardData.installmentCount} monthly installments`;
      }

      if (interestRate > 0) {
        summaryText += ` with ${interestRate} % annual interest. Total repayment €${totalRepayFormatted} (interest on outstanding balance only).`;
      } else {
        summaryText += ` with no interest.`;
      }

      document.getElementById('full-summary-text').textContent = summaryText;
      document.getElementById('send-friend-name').textContent = borrowerName;

      // Populate expandable sections
      populateRepaymentSchedule();
      populateInterestCalculation();
      populateReminderPlan();
      populateClauses();
    }

    // Populate repayment schedule section
    function populateRepaymentSchedule() {
      const content = document.getElementById('repayment-schedule-content');

      if (wizardData.repaymentType === 'one_time') {
        const dueDate = new Date(wizardData.dueDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
        content.innerHTML = `<p style="margin:0; font-size:14px">One-time payment of €${formatAmount(Math.round(wizardData.totalRepayAmount * 100))} due on ${dueDate}.</p>`;
      } else {
        const firstDate = new Date(wizardData.firstPaymentDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
        const finalDate = new Date(wizardData.finalDueDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });

        let html = `<p style="margin:0 0 12px 0; font-size:14px">${wizardData.installmentCount} installments from ${firstDate} to ${finalDate}:</p>`;
        html += `<ul style="margin:0; padding-left:20px; font-size:13px; color:var(--muted)">`;
        html += `<li>Principal per payment: €${formatAmount(Math.round((wizardData.amount / wizardData.installmentCount) * 100))}</li>`;
        html += `<li>Interest calculated on remaining balance each period</li>`;
        html += `<li>Total to repay: €${formatAmount(Math.round(wizardData.totalRepayAmount * 100))}</li>`;
        html += `</ul>`;
        content.innerHTML = html;
      }
    }

    // Populate interest calculation section
    function populateInterestCalculation() {
      const content = document.getElementById('interest-calc-content');

      if (wizardData.interestRate === 0 || !wizardData.hasInterest) {
        content.innerHTML = `<p style="margin:0; font-size:14px; color:var(--muted)">No interest applied. Borrower repays only the principal amount.</p>`;
      } else {
        // Get the breakdown table HTML from step 3
        const breakdownTbody = document.getElementById('breakdown-tbody').innerHTML;
        let html = `<p style="margin:0 0 12px 0; font-size:14px">Interest at ${wizardData.interestRate}% per year, calculated on outstanding balance:</p>`;
        html += `<div style="max-height:300px; overflow-y:auto">`;
        html += `<table style="width:100%; font-size:12px">`;
        html += `<thead><tr style="border-bottom:1px solid rgba(255,255,255,0.08)">`;
        html += `<th style="text-align:left; padding:8px 4px">#</th>`;
        html += `<th style="text-align:right; padding:8px 4px">Payment</th>`;
        html += `<th style="text-align:right; padding:8px 4px">Interest</th>`;
        html += `<th style="text-align:right; padding:8px 4px">Principal</th>`;
        html += `<th style="text-align:right; padding:8px 4px">Remaining</th>`;
        html += `</tr></thead><tbody>${breakdownTbody}</tbody></table></div>`;
        content.innerHTML = html;
      }
    }

    // Populate reminder plan section
    function populateReminderPlan() {
      const content = document.getElementById('reminder-plan-content');

      let html = `<p style="margin:0 0 8px 0; font-size:14px; font-weight:600">${wizardData.reminderMode === 'auto' ? 'Auto reminders' : 'Custom schedule'}:</p>`;

      if (wizardData.reminderMode === 'auto') {
        html += `<p style="margin:0; font-size:13px; color:var(--muted); line-height:1.6">Borrower receives reminders 7 days before, 1 day before, and on the due date. If still unpaid, follow-up reminders are sent 1 day after and every 3 days until payment or renegotiation.</p>`;
      } else {
        html += `<ul style="margin:0; padding-left:20px; font-size:13px; color:var(--muted)">`;
        wizardData.reminderOffsets.sort((a, b) => a - b).forEach(offset => {
          if (offset < 0) {
            html += `<li>${Math.abs(offset)} day${Math.abs(offset) > 1 ? 's' : ''} before due date</li>`;
          } else if (offset === 0) {
            html += `<li>On due date</li>`;
          } else {
            html += `<li>${offset} day${offset > 1 ? 's' : ''} after due date</li>`;
          }
        });
        html += `</ul>`;
      }

      content.innerHTML = html;
    }

    // Populate clauses section
    function populateClauses() {
      const content = document.getElementById('clauses-content');

      // Payment methods
      let methodsText = '';
      if (wizardData.paymentMethods && wizardData.paymentMethods.length > 0) {
        const methodLabels = wizardData.paymentMethods.map(m => {
          if (m === 'bank') return 'Bank transfer';
          if (m === 'cash') return 'Cash in person';
          if (m === 'crypto') return 'Crypto';
          if (m === 'any') return 'Any method';
          if (m === 'other') return `Other (${wizardData.paymentOtherDescription || 'not specified'})`;
          return m;
        });
        methodsText = methodLabels.join(', ');
      } else {
        methodsText = 'Not specified';
      }

      let html = `<div style="margin-bottom:12px">`;
      html += `<div style="font-weight:600; font-size:14px; margin-bottom:4px">Payment methods:</div>`;
      html += `<div style="color:var(--muted); font-size:13px">${methodsText}</div>`;
      html += `</div>`;

      html += `<div style="margin-bottom:12px">`;
      html += `<div style="font-weight:600; font-size:14px; margin-bottom:4px">Proof of payment:</div>`;
      html += `<div style="color:var(--muted); font-size:13px">${wizardData.proofRequired ? 'Required when reporting payments' : 'Not required'}</div>`;
      html += `</div>`;

      html += `<div>`;
      html += `<div style="font-weight:600; font-size:14px; margin-bottom:4px">Worst-case scenario clause:</div>`;
      html += `<div style="color:var(--muted); font-size:13px">${wizardData.debtCollectionClause ? 'Included - may be transferred to debt collection if no repayment or renegotiation' : 'Not included'}</div>`;
      html += `</div>`;

      content.innerHTML = html;
    }

    async function sendInvite() {
      const status = document.getElementById('step5-status');
      status.textContent = 'Creating agreement...';

      try {
        // Send the first payment method for backwards compatibility
        const primaryPaymentMethod = wizardData.paymentMethods && wizardData.paymentMethods.length > 0
          ? wizardData.paymentMethods[0]
          : 'bank';

        const payload = {
          friendFirstName: wizardData.friendFirstName,
          borrowerEmail: wizardData.friendEmail,
          description: wizardData.description,
          amount: wizardData.amount,
          dueDate: wizardData.dueDate,
          direction: wizardData.role,
          repaymentType: wizardData.repaymentType,
          interestRate: wizardData.interestRate,
          totalInterest: wizardData.totalInterest,
          totalRepayAmount: wizardData.totalRepayAmount,
          paymentPreferenceMethod: primaryPaymentMethod,
          paymentOtherDescription: wizardData.paymentOtherDescription,
          reminderMode: wizardData.reminderMode,
          reminderOffsets: wizardData.reminderOffsets,
          proofRequired: wizardData.proofRequired,
          debtCollectionClause: wizardData.debtCollectionClause
        };

        // Add installment-specific fields if applicable
        if (wizardData.repaymentType === 'installments') {
          payload.planLength = wizardData.planLength;
          payload.planUnit = wizardData.planUnit;
          payload.installmentCount = wizardData.installmentCount;
          payload.installmentAmount = wizardData.installmentAmount;
          payload.firstPaymentDate = wizardData.firstPaymentDate;
          payload.finalDueDate = wizardData.finalDueDate;
        }

        const res = await fetch('/api/agreements', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed');

        wizardData.inviteUrl = data.inviteUrl;
        document.getElementById('invite-url').textContent = data.inviteUrl;

        // Hide send button, show invite URL
        document.getElementById('invite-not-sent').classList.add('hidden');
        document.getElementById('invite-sent').classList.remove('hidden');

        status.textContent = '';
        refresh();
        loadMessages();
      } catch (err) {
        status.textContent = '❌ ' + err.message;
      }
    }

    function copyInviteUrl() {
      const url = wizardData.inviteUrl;
      navigator.clipboard.writeText(url).then(() => {
        document.getElementById('step3-status').textContent = '✅ Copied to clipboard!';
        setTimeout(() => {
          document.getElementById('step3-status').textContent = '';
        }, 2000);
      }).catch(() => {
        document.getElementById('step3-status').textContent = '❌ Failed to copy';
      });
    }

    function resetWizard() {
      wizardData = {
        role: null,
        friendFirstName: '',
        friendEmail: '',
        description: '',
        amount: '',
        repaymentType: 'one_time',
        dueDate: '',
        planLength: null,
        planUnit: 'months',
        firstPaymentDate: '',
        installmentCount: null,
        installmentAmount: null,
        finalDueDate: '',
        hasInterest: true,
        interestRate: 0,
        totalInterest: 0,
        totalRepayAmount: 0,
        paymentMethods: ['bank'],
        paymentOtherDescription: '',
        reminderMode: 'auto',
        reminderOffsets: [-7, -1, 0, 1, 3],
        proofRequired: false,
        debtCollectionClause: false,
        inviteUrl: ''
      };

      // Reset Step 1 fields
      document.querySelectorAll('input[name="role"]').forEach(r => r.checked = false);
      document.getElementById('role-card-lend').style.borderColor = 'rgba(255,255,255,0.08)';
      document.getElementById('friend-first-name').value = '';
      document.getElementById('friend-email').value = '';
      document.getElementById('description').value = '';

      // Reset Step 2 fields
      document.getElementById('amount').value = '';
      document.querySelector('input[name="repayment-type"][value="one_time"]').checked = true;
      document.getElementById('due-date').value = '';
      document.getElementById('first-payment-date').value = '';
      document.getElementById('plan-length').value = '';
      document.getElementById('plan-unit').value = 'months';
      document.querySelector('input[name="first-payment-option"][value="1month"]').checked = true;

      // Reset Step 3 fields
      document.getElementById('interest-rate').value = '';
      document.getElementById('interest-rate').disabled = false;
      document.getElementById('interest-rate').style.opacity = '1';
      document.getElementById('no-interest-checkbox').checked = false;

      // Reset Step 4 fields
      document.querySelectorAll('.payment-method-checkbox').forEach(cb => {
        cb.checked = cb.value === 'bank';
      });
      document.getElementById('other-payment-description').value = '';
      document.querySelector('input[name="reminder-mode"][value="auto"]').checked = true;
      document.querySelectorAll('.custom-reminder-checkbox').forEach(cb => cb.checked = false);
      document.getElementById('proof-required').checked = false;
      document.getElementById('debt-collection-clause').checked = false;

      // Reset status messages
      document.getElementById('step1-status').textContent = '';
      document.getElementById('step2-status').textContent = '';
      document.getElementById('step3-status').textContent = '';
      document.getElementById('step4-status').textContent = '';
      document.getElementById('step5-status').textContent = '';

      // Reset invite section
      document.getElementById('invite-not-sent').classList.remove('hidden');
      document.getElementById('invite-sent').classList.add('hidden');

      // Reset field visibility
      toggleInstallmentFields();
      toggleReminderMode();

      goToStep(1);
      closeNewAgreement();
    }

    function toggleNewAgreement() {
      const section = document.getElementById('new-agreement-section');
      if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        document.getElementById('new-agreement-btn').style.display = 'none';
      } else {
        closeNewAgreement();
      }
    }

    function closeNewAgreement() {
      document.getElementById('new-agreement-section').classList.add('hidden');
      document.getElementById('new-agreement-btn').style.display = 'flex';
    }

    // Fetch current user
    async function loadUser() {
      try {
        const res = await fetch('/api/user');
        if (!res.ok) {
          window.location.href = '/';
          return;
        }
        const data = await res.json();
        currentUser = data.user;

        // Display full name and email, or just email if full_name is not set
        const displayText = currentUser.full_name
          ? `${currentUser.full_name} | ${currentUser.email}`
          : currentUser.email;
        document.getElementById('user-email').textContent = displayText;
      } catch (err) {
        console.error('Error loading user:', err);
        window.location.href = '/';
      }
    }

    // Logout
    async function logout() {
      try {
        await fetch('/auth/logout', { method: 'POST' });
        window.location.href = '/';
      } catch (err) {
        console.error('Logout error:', err);
        window.location.href = '/';
      }
    }

    // Toggle activity visibility
    function toggleActivity() {
      const activity = document.getElementById('activity-section');
      activity.style.display = activity.style.display === 'none' ? 'block' : 'none';
    }

    // Load activity
    async function loadMessages() {
      try {
        const res = await fetch('/api/messages');
        const data = await res.json();

        const messages = data.messages || [];
        const unreadCount = data.unread_count || 0;

        // Update header with unread count
        document.getElementById('activity-count').textContent = unreadCount;

        const activityList = document.getElementById('activity-list');
        if (messages.length === 0) {
          activityList.innerHTML = '<p class="empty-state">No activity yet</p>';
        } else {
          activityList.innerHTML = messages.map(msg => {
            const timestamp = new Date(msg.created_at).toLocaleString();
            const relativeTime = timeAgo(msg.created_at);
            const isUnread = !msg.read_at;

            // Determine activity text based on event_type
            let activityText = msg.body; // Fallback to original body

            if (msg.event_type === 'AGREEMENT_SENT') {
              // For sent agreements, show pending status if still pending
              const borrowerName = msg.borrower_full_name || msg.friend_first_name || msg.borrower_email;
              if (msg.agreement_status === 'pending') {
                activityText = `Agreement sent to ${msg.borrower_email} (pending review by ${borrowerName})`;
              } else {
                activityText = `Agreement sent to ${msg.borrower_email}`;
              }
            } else if (msg.event_type === 'AGREEMENT_ACCEPTED') {
              const borrowerName = msg.borrower_full_name || msg.friend_first_name || msg.borrower_email;
              activityText = `Agreement accepted by ${borrowerName}`;
            } else if (msg.event_type === 'AGREEMENT_DECLINED') {
              const borrowerName = msg.borrower_full_name || msg.friend_first_name || msg.borrower_email;
              activityText = `Agreement declined by ${borrowerName}`;
            } else if (msg.event_type === 'AGREEMENT_ASSIGNED_TO_BORROWER') {
              // Use the body text as-is for this event
              activityText = msg.body;
            } else if (msg.event_type === 'AGREEMENT_REVIEW_LATER') {
              activityText = msg.body;
            } else if (msg.event_type === 'AGREEMENT_CANCELLED_LENDER') {
              activityText = msg.body;
            } else if (msg.event_type === 'AGREEMENT_CANCELLED_BORROWER') {
              activityText = msg.body;
            }

            // Determine the link URL based on agreement_id and event_type
            let linkUrl = '';
            if (msg.agreement_id) {
              // For pending agreements where the current user is the borrower, go to review page
              if (msg.agreement_status === 'pending' && msg.borrower_user_id === currentUser.id) {
                linkUrl = `/agreements/${msg.agreement_id}/review`;
              } else {
                // Default to manage page for all other agreement-related events
                linkUrl = `/agreements/${msg.agreement_id}/manage`;
              }
            }

            const unreadClass = isUnread ? 'message-unread' : '';
            const clickableClass = linkUrl ? 'message-clickable' : '';
            const onclickAttr = linkUrl ? `onclick="handleActivityClick(${msg.id}, '${linkUrl}')"` : '';

            return `
              <div class="message-item ${unreadClass} ${clickableClass}" ${onclickAttr}>
                <div style="display:flex; justify-content:space-between; align-items:center">
                  <div class="message-date">${timestamp} (${relativeTime})</div>
                  ${isUnread ? '<span class="unread-indicator">●</span>' : ''}
                </div>
                <div style="margin-top:4px">${activityText}</div>
              </div>
            `;
          }).join('');
        }
      } catch (err) {
        console.error('Error loading activity:', err);
      }
    }

    // Handle activity item click - mark as read and navigate
    async function handleActivityClick(messageId, url) {
      try {
        // Mark as read
        await fetch(`/api/activity/${messageId}/mark-read`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        // Navigate to the URL
        window.location.href = url;
      } catch (err) {
        console.error('Error marking message as read:', err);
        // Still navigate even if marking fails
        window.location.href = url;
      }
    }

    // Mark all messages as read
    async function markAllAsRead() {
      try {
        const res = await fetch('/api/activity/mark-all-read', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (res.ok) {
          // Reload messages to update UI
          await loadMessages();
        }
      } catch (err) {
        console.error('Error marking all as read:', err);
      }
    }

    // Navigate to review page for borrowers
    function reviewAgreement(id) {
      window.location.href = `/agreements/${id}/review`;
    }

    // Navigate to manage page for lenders and borrowers
    function viewAgreement(id) {
      window.location.href = `/agreements/${id}/manage`;
    }

    // Filter agreements by status
    function filterByStatus(status) {
      currentFilter = status;

      // Update active tab
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.getAttribute('data-filter') === status) {
          tab.classList.add('active');
        }
      });

      renderAgreements();
    }

    // Render agreements based on current filter
    function renderAgreements() {
      const tbody = document.querySelector('#list tbody');
      const emptyState = document.getElementById('empty-state');
      const counterpartyHeader = document.getElementById('counterparty-header');

      let filtered = allAgreements;
      if (currentFilter !== 'all') {
        // For Pending tab, exclude cancelled agreements
        if (currentFilter === 'pending') {
          filtered = allAgreements.filter(a => a.status === 'pending');
        } else {
          filtered = allAgreements.filter(a => a.status === currentFilter);
        }
      }

      if (filtered.length === 0) {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
        document.getElementById('list').style.display = 'none';
        return;
      }

      emptyState.style.display = 'none';
      document.getElementById('list').style.display = 'table';
      tbody.innerHTML = '';

      // Determine header label based on user's role in agreements
      // Default to showing both, but if all agreements have user as same role, show specific header
      let userRoles = new Set();
      for (const a of filtered) {
        const isLender = a.lender_user_id === currentUser.id;
        userRoles.add(isLender ? 'lender' : 'borrower');
      }

      // Set header based on predominant role
      if (userRoles.size === 1) {
        if (userRoles.has('lender')) {
          counterpartyHeader.textContent = 'Borrower';
        } else {
          counterpartyHeader.textContent = 'Lender';
        }
      } else {
        // Mixed roles, keep generic header
        counterpartyHeader.textContent = 'Counterparty';
      }

      for (const a of filtered) {
        const tr = document.createElement('tr');
        tr.setAttribute('data-id', a.id);
        const amount = formatAmount(a.amount_cents);
        const statusText = a.status || 'pending';
        const capitalizedStatus = statusText.charAt(0).toUpperCase() + statusText.slice(1);

        // Build status column with main badge only
        let statusBadge = `<span class="status-badge ${statusText}">${capitalizedStatus}</span>`;

        // Determine role
        const isLender = a.lender_user_id === currentUser.id;

        // Use counterparty name only, no badge
        const counterpartyName = a.counterparty_name || '—';
        const counterpartyDisplay = counterpartyName;

        // Get description or show fallback
        const description = a.description || '<span style="color:var(--muted); font-style:italic">(No description)</span>';

        // Calculate outstanding amount
        const outstanding = formatAmount(a.outstanding_cents || a.amount_cents);

        // Build actions column with main button and conditional alert buttons
        let actionsHtml = '';
        if (statusText === 'cancelled') {
          // No actions for cancelled agreements
          actionsHtml = '—';
        } else if (statusText === 'pending' && !isLender) {
          // Borrower can review pending agreements
          actionsHtml = `<div class="actions-column">
            <button onclick="reviewAgreement(${a.id})">Review</button>
          </div>`;
        } else {
          // For lenders on any agreement, or borrowers on active/settled
          let mainBtnLabel = (statusText === 'pending' || statusText === 'active' || statusText === 'settled') ? 'Manage' : 'View';

          let buttons = `<button onclick="viewAgreement(${a.id})">${mainBtnLabel}</button>`;

          // Add conditional action buttons for lenders
          if (isLender) {
            if (a.hasPendingPaymentToConfirm) {
              buttons += `<button class="btn-confirm-payment" onclick="openConfirmPaymentModal(${a.id})">Confirm payment</button>`;
            }
            if (a.hasOpenDifficulty) {
              buttons += `<button class="btn-payment-issue" onclick="openDifficultyModal(${a.id})">Payment issue</button>`;
            }
          }

          actionsHtml = `<div class="actions-column">${buttons}</div>`;
        }

        tr.innerHTML = `
          <td>${counterpartyDisplay}</td>
          <td>${description}</td>
          <td>€ ${amount}</td>
          <td>€ ${outstanding}</td>
          <td>${a.due_date}</td>
          <td>${statusBadge}</td>
          <td>${actionsHtml}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    // Refresh agreements
    async function refresh() {
      try {
        const res = await fetch('/api/agreements');
        allAgreements = await res.json();
        renderAgreements();
      } catch (err) {
        console.error('Error loading agreements:', err);
      }
    }

    // Modal functions
    function closeModalOnOverlay(event, modalId) {
      if (event.target.classList.contains('modal-overlay')) {
        document.getElementById(modalId).style.display = 'none';
      }
    }

    // Close modal on ESC key
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeConfirmPaymentModal();
        closeDifficultyModal();
      }
    });

    // Payment Confirmation Modal
    async function openConfirmPaymentModal(agreementId) {
      const modal = document.getElementById('confirm-payment-modal');
      const modalBody = document.getElementById('confirm-payment-modal-body');

      modal.style.display = 'flex';
      modalBody.innerHTML = '<p style="text-align:center; color:var(--muted)">Loading...</p>';

      try {
        // Fetch agreement details and payments
        const [agreementRes, paymentsRes] = await Promise.all([
          fetch(`/api/agreements/${agreementId}`),
          fetch(`/api/agreements/${agreementId}/payments`)
        ]);

        if (!agreementRes.ok || !paymentsRes.ok) {
          throw new Error('Failed to load payment details');
        }

        const agreement = await agreementRes.json();
        const payments = await paymentsRes.json();

        // Find the pending payment that needs confirmation
        const pendingPayment = payments.find(p => p.status === 'pending');

        if (!pendingPayment) {
          modalBody.innerHTML = '<p style="color:var(--muted)">No pending payment found.</p>';
          return;
        }

        // Build modal content
        const amount = formatAmount(pendingPayment.amount_cents);
        const borrowerName = pendingPayment.recorded_by_name || agreement.friend_first_name || agreement.borrower_email;

        let proofOfPaymentHtml = '';
        if (pendingPayment.proof_file_path) {
          proofOfPaymentHtml = `
            <div class="modal-info-row">
              <span class="modal-info-label">Proof of payment</span>
              <button class="secondary" onclick="viewProofOfPayment(${pendingPayment.id})" style="padding:6px 12px; font-size:13px">View proof</button>
            </div>
          `;
        }

        modalBody.innerHTML = `
          <div class="modal-info-row">
            <span class="modal-info-label">Amount</span>
            <span class="modal-info-value">€ ${amount}</span>
          </div>
          <div class="modal-info-row">
            <span class="modal-info-label">Method</span>
            <span class="modal-info-value">${pendingPayment.method || '—'}</span>
          </div>
          ${pendingPayment.note ? `<div class="modal-note"><strong>Note:</strong> ${pendingPayment.note}</div>` : ''}
          <div class="modal-info-row">
            <span class="modal-info-label">Reported by</span>
            <span class="modal-info-value">${borrowerName}</span>
          </div>
          ${proofOfPaymentHtml}
          <div class="modal-footer">
            <button onclick="declinePayment(${agreementId}, ${pendingPayment.id})" class="secondary">Decline</button>
            <button onclick="confirmPayment(${agreementId}, ${pendingPayment.id})">Confirm payment</button>
          </div>
          <p class="modal-helper-text" style="margin-top:12px; text-align:center">This will update the payment history and outstanding amount.</p>
        `;
      } catch (err) {
        console.error('Error loading payment details:', err);
        modalBody.innerHTML = '<p style="color:#ff6b6b">Failed to load payment details</p>';
      }
    }

    function closeConfirmPaymentModal() {
      document.getElementById('confirm-payment-modal').style.display = 'none';
    }

    async function confirmPayment(agreementId, paymentId) {
      try {
        const res = await fetch(`/api/payments/${paymentId}/approve`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || 'Failed to confirm payment');
        }

        closeConfirmPaymentModal();
        refresh();
        loadMessages();
      } catch (err) {
        console.error('Error confirming payment:', err);
        alert('Failed to confirm payment: ' + err.message);
      }
    }

    async function declinePayment(agreementId, paymentId) {
      try {
        const res = await fetch(`/api/payments/${paymentId}/decline`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || 'Failed to decline payment');
        }

        closeConfirmPaymentModal();
        refresh();
        loadMessages();
      } catch (err) {
        console.error('Error declining payment:', err);
        alert('Failed to decline payment: ' + err.message);
      }
    }

    function viewProofOfPayment(paymentId) {
      // Open proof of payment in new tab
      window.open(`/api/payments/${paymentId}/proof`, '_blank');
    }

    // Difficulty Modal
    async function openDifficultyModal(agreementId) {
      const modal = document.getElementById('difficulty-modal');
      const modalBody = document.getElementById('difficulty-modal-body');

      modal.style.display = 'flex';
      modalBody.innerHTML = '<p style="text-align:center; color:var(--muted)">Loading...</p>';

      try {
        const res = await fetch(`/api/agreements/${agreementId}/hardship-requests`);
        if (!res.ok) throw new Error('Failed to load difficulty details');

        const hardshipRequests = await res.json();

        // Find the most recent request (they're ordered by created_at DESC)
        const openDifficulty = hardshipRequests[0];

        if (!openDifficulty) {
          modalBody.innerHTML = '<p style="color:var(--muted)">No difficulty request found.</p>';
          return;
        }

        // Build preferred options list
        let preferredOptionsHtml = '';
        if (openDifficulty.preferred_adjustments) {
          const optionLabels = {
            'smaller_payments': 'Smaller monthly payments',
            'postpone': 'Postponement',
            'longer_term': 'Longer term',
            'partial_forgiveness': 'Partial forgiveness'
          };
          const optionsArray = openDifficulty.preferred_adjustments.split(',');
          const optionsList = optionsArray
            .map(opt => optionLabels[opt.trim()] || opt)
            .join('</li><li>');
          preferredOptionsHtml = `
            <div class="modal-info-row" style="flex-direction:column; align-items:flex-start">
              <span class="modal-info-label">Preferred options:</span>
              <ul style="margin:8px 0 0 20px; padding:0">
                <li>${optionsList}</li>
              </ul>
            </div>
          `;
        }

        // Format can_pay_now amount
        let canPayNowText = '€ 0 (Cannot pay anything now)';
        if (openDifficulty.can_pay_now_cents && openDifficulty.can_pay_now_cents > 0) {
          canPayNowText = `€ ${formatAmount(openDifficulty.can_pay_now_cents)}`;
        }

        modalBody.innerHTML = `
          <p class="modal-helper-text">Your friend has asked for help with this payment. Here's what they shared:</p>

          ${openDifficulty.reason_category ? `
            <div class="modal-info-row">
              <span class="modal-info-label">Reason</span>
              <span class="modal-info-value">${openDifficulty.reason_category}</span>
            </div>
          ` : ''}

          ${openDifficulty.reason_text ? `
            <div class="modal-note"><strong>Explanation:</strong><br>${openDifficulty.reason_text}</div>
          ` : ''}

          <div class="modal-info-row">
            <span class="modal-info-label">Can pay now</span>
            <span class="modal-info-value">${canPayNowText}</span>
          </div>

          ${preferredOptionsHtml}

          <div class="modal-footer">
            <button onclick="closeDifficultyModal()" class="secondary">Close</button>
            <button onclick="window.location.href='/agreements/${agreementId}/manage'">Open full agreement</button>
          </div>
        `;
      } catch (err) {
        console.error('Error loading difficulty details:', err);
        modalBody.innerHTML = '<p style="color:#ff6b6b">Failed to load difficulty details</p>';
      }
    }

    function closeDifficultyModal() {
      document.getElementById('difficulty-modal').style.display = 'none';
    }

    // Initialize
    loadUser();
    refresh();
    loadMessages();
    goToStep(1);
  </script>
</body>
</html>
