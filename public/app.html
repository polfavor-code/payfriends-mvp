<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PayFriends — My Agreements</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <!-- Shared header component -->
  <script src="/js/header.js"></script>
  <!-- Phone input component -->
  <script src="/js/phone-input.js"></script>
  <style>
    :root{
      --bg:#0e1116; --card:#151a21; --text:#e6eef6; --muted:#a7b0bd; --accent:#3ddc97;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif; background:var(--bg); color:var(--text);}
    .container{max-width:1200px;margin:0 auto;padding:32px 16px;}
    .header{display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid rgba(255,255,255,0.08)}
    .header-left h1{margin:0 0 4px 0;font-size:28px}
    .header-left .user-email{color:var(--muted); font-size:14px}
    .header-right{display:flex; gap:16px; align-items:center}
    .top-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid rgba(255,255,255,0.08)}
    .top-header-left{display:flex; align-items:center; gap:12px}
    .top-header-right{display:flex; flex-direction:column; align-items:flex-end; gap:8px}
    .logo-coin{height:54px; width:auto}
    .top-header-text{display:flex; flex-direction:column; gap:2px}
    .app-name{font-size:24px; font-weight:600; line-height:1.2; margin:0}
    .user-meta{color:var(--muted); font-size:14px; line-height:1.2}
    .app-slogan{color:var(--muted); font-size:14px; line-height:1.2; margin-top:2px}
    .top-header-user-info{color:var(--text); font-size:14px; text-align:right}
    .top-header-actions{display:flex; gap:12px; align-items:center}
    .logout-btn{padding:8px 16px;border-radius:8px;border:1px solid rgba(255,255,255,0.15);background:transparent;color:var(--text);font-weight:500; cursor:pointer; font-size:14px; white-space:nowrap; height:36px}
    .logout-btn:hover{background:rgba(255,255,255,0.05)}
    .inbox-widget{padding:8px 16px;border-radius:8px;border:1px solid rgba(255,255,255,0.15);background:transparent;color:var(--text);font-weight:500;font-size:14px; cursor:pointer; transition:all 0.2s ease; white-space:nowrap; height:36px; display:inline-flex; align-items:center}
    .inbox-widget:hover{background:rgba(255,255,255,0.05)}
    .inbox-widget.inbox-widget-has-unread{background:var(--card);border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:10px 18px;font-size:15px; height:auto}
    .inbox-widget.inbox-widget-has-unread:hover{background:#1a2028}
    .inbox-count{color:var(--accent); font-weight:700}
    .card{background:var(--card);border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:16px;margin:16px 0}
    .row{display:flex; gap:12px; align-items:center; margin:10px 0}
    .row label{width:160px; color:var(--muted)}
    .row input{flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text)}
    .row input:focus{outline:none; border-color:var(--accent); background:#10151d}
    .row input:hover{background:#10151d}
    .row input:-webkit-autofill,
    .row input:-webkit-autofill:hover,
    .row input:-webkit-autofill:focus,
    .row input:-webkit-autofill:active{
      -webkit-background-clip:text;
      -webkit-text-fill-color:var(--text);
      transition:background-color 5000s ease-in-out 0s;
      box-shadow:inset 0 0 20px 20px #10151d;
    }
    button{padding:10px 14px;border-radius:10px;border:0;background:var(--accent);color:#0d130f;font-weight:700; cursor:pointer}
    button:hover{filter:brightness(1.06)}
    button.secondary{background:transparent; border:1px solid rgba(255,255,255,0.15); color:var(--text); margin-left:8px}
    button.secondary:hover{background:rgba(255,255,255,0.05)}
    button.btn-review-pending{background:#facc15; color:#0d130f}
    button.btn-review-pending:hover{filter:brightness(1.1)}
    .tabs{display:flex; gap:8px; margin-bottom:16px; border-bottom:1px solid rgba(255,255,255,0.08)}
    .tab{padding:10px 16px; cursor:pointer; color:var(--muted); border-bottom:2px solid transparent; margin-bottom:-1px}
    .tab.active{color:var(--accent); border-bottom-color:var(--accent)}
    .tab:hover{color:var(--text)}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:10px 12px; border-bottom:1px solid rgba(255,255,255,0.08); text-align:left; vertical-align:middle}
    th{color:var(--muted); font-weight:600; font-size:13px}
    th:nth-child(5), td:nth-child(5){text-align:center; width:80px}
    .status{color:var(--muted); margin-top:8px; min-height:1.2em;}
    .status-badge{display:inline-block; padding:4px 10px; border-radius:6px; font-size:12px; font-weight:600}
    .status-badge.pending{background:#4a4a4a; color:#fff}
    .status-badge.active{background:#3d7bdc; color:#fff}
    .status-badge.settled{background:#3ddc97; color:#0d130f}
    .status-badge.declined{background:#ff6b6b; color:#fff}
    .status-badge.cancelled{background:#6c757d; color:#fff}
    .status-text{font-size:14px; font-weight:400}
    .status-text.active{color:#22c55e}
    .status-text.pending{color:#facc15}
    .status-text.overdue{color:#f87171}
    .status-text.settled{color:#9ca3af}
    .status-text.cancelled{color:#9ca3af}
    .status-text.declined{color:#f87171}
    .status-indicator{width:22px;height:22px;border-radius:9999px;display:inline-flex;align-items:center;justify-content:center;margin:0 auto;cursor:help}
    .status-indicator--active{background:#22c55e}
    .status-indicator--pending{background:#facc15}
    .status-indicator--settled{background:#9ca3af}
    .status-indicator--overdue{background:#f87171}
    .status-indicator--cancelled{background:#9ca3af}
    .status-indicator--declined{background:#f87171}
    .status-dot{display:inline-block; width:16px; height:16px; border-radius:9999px; cursor:help; position:relative}
    .status-dot--active{background:#22c55e}
    .status-dot--pending{background:#facc15}
    .status-dot--settled{background:#9ca3af}
    .status-dot--overdue{background:#f87171}
    .status-dot--cancelled{background:#9ca3af}
    .status-dot--declined{background:#f87171}
    .status-dot-wrapper{display:inline-flex;align-items:center;justify-content:center;position:relative}
    .status-dot-wrapper::after{content:attr(data-tooltip);position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);background:#1f2937;color:#fff;padding:6px 12px;border-radius:6px;font-size:12px;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity 0.2s ease;border:1px solid rgba(255,255,255,0.1);z-index:1000}
    .status-dot-wrapper::before{content:'';position:absolute;bottom:calc(100% + 2px);left:50%;transform:translateX(-50%);border:4px solid transparent;border-top-color:#1f2937;opacity:0;pointer-events:none;transition:opacity 0.2s ease;z-index:1000}
    .status-dot-wrapper:hover::after,.status-dot-wrapper:hover::before{opacity:1}
    .actions-column{display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:flex-end; width:100%}
    .actions-column button{flex:0 0 auto; padding:8px 12px; font-size:14px; white-space:nowrap; width:auto}
    .btn-confirm-payment{background:#f97316; color:#fff; border:0; padding:8px 12px; border-radius:8px; font-weight:600; cursor:pointer; font-size:14px}
    .btn-confirm-payment:hover{background:#ea580c}
    .btn-payment-issue{background:#dc2626; color:#fff; border:0; padding:8px 12px; border-radius:8px; font-weight:600; cursor:pointer; font-size:14px}
    .btn-payment-issue:hover{background:#b91c1c}
    .messages-list{margin-top:12px}
    .message-item{padding:10px; background:var(--card); border-radius:8px; margin:8px 0; font-size:14px; transition:all 0.2s ease; border:1px solid transparent}
    .message-item.message-clickable{cursor:pointer}
    .message-item.message-clickable:hover{border-color:rgba(255,255,255,0.12)}
    .message-item.message-unread{font-weight:500; background:rgba(61,220,151,0.1); border:1px solid rgba(61,220,151,0.25)}
    .message-item.message-unread.message-clickable{cursor:pointer}
    .message-item.message-unread.message-clickable:hover{background:rgba(61,220,151,0.12); border-color:rgba(61,220,151,0.3); transform:translateX(2px)}
    .unread-indicator{color:var(--accent); font-size:16px; margin-left:8px}
    .message-subject{font-weight:600; margin-bottom:4px}
    .message-date{color:var(--muted); font-size:12px}
    .empty-state{text-align:center; color:var(--muted); padding:32px; font-size:14px}
    .wizard-steps{display:flex; gap:16px; margin-bottom:24px; align-items:center}
    .wizard-step{flex:1; padding:8px 16px; background:#10151d; border-radius:8px; text-align:center; font-size:14px; border:2px solid transparent; cursor:pointer; transition:all 0.2s ease}
    .wizard-step:hover{background:#1a2028; border-color:rgba(61,220,151,0.3)}
    .wizard-step.active{border-color:var(--accent); color:var(--accent); font-weight:600}
    .wizard-step.completed{color:var(--accent)}
    .wizard-content{min-height:200px}
    .hidden{display:none}
    .role-badge{display:inline-block; padding:4px 8px; border-radius:6px; font-size:11px; font-weight:600; background:#2a2a2a; color:#fff}
    .role-badge.lend{background:#3d7bdc; color:#fff}
    .role-badge.borrow{background:#e67e22; color:#fff}
    .invite-url-box{background:#10151d; padding:12px; border-radius:8px; margin:16px 0; font-family:monospace; font-size:13px; word-break:break-all; border:1px solid rgba(255,255,255,0.08)}
    .summary-row{display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.08)}
    .summary-row:last-child{border-bottom:none}
    .summary-label{color:var(--muted)}
    .summary-value{font-weight:600}
    .modal-overlay{position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:1000}
    .modal-card{background:var(--card); border:1px solid rgba(255,255,255,0.12); border-radius:16px; padding:24px; max-width:600px; width:90%; max-height:90vh; overflow-y:auto}
    .modal-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:12px; border-bottom:1px solid rgba(255,255,255,0.08)}
    .modal-title{margin:0; font-size:20px; font-weight:600}
    .modal-close{background:transparent; border:0; color:var(--muted); font-size:24px; cursor:pointer; padding:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center; border-radius:6px}
    .modal-close:hover{background:rgba(255,255,255,0.05); color:var(--text)}
    .modal-body{margin-bottom:20px}
    .modal-footer{display:flex; gap:12px; justify-content:flex-end; padding-top:16px; border-top:1px solid rgba(255,255,255,0.08)}
    .modal-info-row{display:flex; justify-content:space-between; padding:12px; background:#10151d; border-radius:8px; margin:8px 0}
    .modal-info-label{color:var(--muted); font-size:14px}
    .modal-info-value{font-weight:600; font-size:14px}
    .modal-note{background:#10151d; padding:12px; border-radius:8px; margin:12px 0; font-size:14px; color:var(--text)}
    .modal-helper-text{color:var(--muted); font-size:13px; margin-bottom:16px; line-height:1.5}
    .actions-header-text{display:inline-block; text-align:right; width:100%}
    .user-avatar{display:inline-flex; align-items:center; justify-content:center; border-radius:50%; overflow:hidden; flex-shrink:0; vertical-align:middle}
    .user-avatar.size-small{width:22px; height:22px; font-size:10px; font-weight:600; margin-right:8px}
    .user-avatar-image{width:100%; height:100%; object-fit:cover}
    .user-avatar-initials{width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:600; text-transform:uppercase}
    .user-avatar-initials.color-1{background:#6366f1}
    .user-avatar-initials.color-2{background:#8b5cf6}
    .user-avatar-initials.color-3{background:#ec4899}
    .user-avatar-initials.color-4{background:#f59e0b}
    .user-avatar-initials.color-5{background:#10b981}
    .user-avatar-initials.color-6{background:#3b82f6}
    .user-avatar-initials.color-7{background:#14b8a6}
    .counterparty-cell{display:flex; align-items:center}
    .due-date-overdue{color:#f87171}
    .due-date-upcoming{color:var(--muted)}
    .due-date-settled{color:#9ca3af}
    .toggle-switch{position:relative;display:inline-block;width:48px;height:24px}
    .toggle-switch input{opacity:0;width:0;height:0}
    .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#4a4a4a;transition:0.3s;border-radius:24px}
    .toggle-slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background-color:white;transition:0.3s;border-radius:50%}
    .toggle-switch input:checked + .toggle-slider{background-color:var(--accent)}
    .toggle-switch input:checked + .toggle-slider:before{transform:translateX(24px)}
    .toggle-switch input:disabled + .toggle-slider{opacity:0.5;cursor:not-allowed}
    .reminder-option-active{background:rgba(61,220,151,0.05) !important;border:1px solid rgba(61,220,151,0.15) !important;border-radius:12px !important}

    /* Custom Phone Input Widget */
    .phone-input-wrapper{position:relative}
    .phone-input-row{display:flex;gap:8px;align-items:stretch}

    /* Country button */
    .phone-country-button{
      display:flex;align-items:center;gap:8px;
      padding:0 12px;
      background:#10151d;
      border:1px solid rgba(255,255,255,0.12);
      border-radius:10px;
      color:var(--text);
      font-size:15px;
      cursor:pointer;
      transition:all 0.2s;
      white-space:nowrap;
      min-width:180px;
    }
    .phone-country-button:hover,
    .phone-country-button:focus{
      border-color:rgba(61,220,151,0.4);
      outline:none;
    }
    .phone-country-flag{font-size:18px}
    .phone-country-name{flex:1}
    .phone-caret{font-size:10px;color:var(--muted)}

    /* Prefix display */
    .phone-prefix{
      display:flex;align-items:center;
      padding:0 12px;
      background:#10151d;
      border:1px solid rgba(255,255,255,0.12);
      border-radius:10px;
      color:var(--muted);
      font-size:15px;
      min-width:60px;
      justify-content:center;
    }

    /* Local number input */
    .phone-number-input{
      flex:1;
      padding:12px;
      background:#10151d;
      border:1px solid rgba(255,255,255,0.12);
      border-radius:10px;
      color:var(--text);
      font-size:15px;
      font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif;
    }
    .phone-number-input:focus{
      outline:none;
      border-color:rgba(61,220,151,0.4);
      background:#10151d;
    }
    .phone-number-input:hover{background:#10151d}
    .phone-number-input:-webkit-autofill,
    .phone-number-input:-webkit-autofill:hover,
    .phone-number-input:-webkit-autofill:focus,
    .phone-number-input:-webkit-autofill:active{
      -webkit-background-clip:text;
      -webkit-text-fill-color:var(--text);
      transition:background-color 5000s ease-in-out 0s;
      box-shadow:inset 0 0 20px 20px #10151d;
    }
    .phone-number-input.phone-input-invalid{
      border-color:#ff6b6b;
    }

    /* Hidden full number field */
    .phone-number-full{display:none}

    /* Dropdown */
    .phone-dropdown{
      display:none;
      position:absolute;
      top:100%;
      left:0;
      right:0;
      margin-top:4px;
      background:#151a21;
      border:1px solid rgba(255,255,255,0.15);
      border-radius:10px;
      box-shadow:0 4px 16px rgba(0,0,0,0.4);
      z-index:1000;
      max-height:320px;
      overflow:hidden;
    }

    /* Dropdown search */
    .phone-dropdown-search{
      width:calc(100% - 24px);
      margin:12px;
      padding:10px 12px;
      background:#10151d;
      border:1px solid rgba(255,255,255,0.12);
      border-radius:8px;
      color:var(--text);
      font-size:15px;
      font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif;
    }
    .phone-dropdown-search:focus{
      outline:none;
      border-color:rgba(61,220,151,0.4);
      background:#10151d;
    }
    .phone-dropdown-search:hover{background:#10151d}
    .phone-dropdown-search:-webkit-autofill,
    .phone-dropdown-search:-webkit-autofill:hover,
    .phone-dropdown-search:-webkit-autofill:focus,
    .phone-dropdown-search:-webkit-autofill:active{
      -webkit-background-clip:text;
      -webkit-text-fill-color:var(--text);
      transition:background-color 5000s ease-in-out 0s;
      box-shadow:inset 0 0 20px 20px #10151d;
    }
    .phone-dropdown-search::placeholder{
      color:var(--muted);
    }

    /* Country list */
    .phone-country-list{
      max-height:220px;
      overflow-y:auto;
      padding:4px 0;
    }
    .phone-country-list::-webkit-scrollbar{width:6px}
    .phone-country-list::-webkit-scrollbar-thumb{background-color:#333;border-radius:4px}

    /* Country item */
    .phone-country-item{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 16px;
      cursor:pointer;
      transition:all 0.15s;
      border-left:3px solid transparent;
    }
    .phone-country-item:hover{
      background:rgba(61,220,151,0.08);
      border-left-color:var(--accent);
    }
    .phone-country-item .phone-country-flag{font-size:18px}
    .phone-country-item .phone-country-name{flex:1;color:var(--text);font-size:14px}
    .phone-country-item .phone-country-dial{color:var(--muted);font-size:14px}

    /* Phone error message */
    .phone-error{color:#ff6b6b;font-size:13px;margin-top:4px;display:none}
  </style>
</head>
<body>
  <main class="container">
    <!-- Header will be loaded dynamically by header.js -->

    <!-- Activity section (initially hidden) -->
    <section class="card" id="activity-section" style="display:none">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
        <h2 style="margin:0">Activity</h2>
        <button id="mark-all-read-btn" onclick="markAllAsRead()" style="padding:6px 12px; font-size:13px">Mark all as read</button>
      </div>
      <div class="messages-list" id="activity-list">
        <p class="empty-state">No activity yet</p>
      </div>
    </section>

    <section class="card" id="list-section">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
        <h2 style="margin:0">My Agreements</h2>
      </div>

      <div class="tabs">
        <div class="tab active" data-filter="all" onclick="filterByStatus('all')">All</div>
        <div class="tab" data-filter="pending" onclick="filterByStatus('pending')">Pending</div>
        <div class="tab" data-filter="active" onclick="filterByStatus('active')">Active</div>
        <div class="tab" data-filter="settled" onclick="filterByStatus('settled')">Settled</div>
      </div>

      <table id="list">
        <thead>
          <tr>
            <th id="counterparty-header">Borrower</th>
            <th>Description</th>
            <th>Outstanding / Total</th>
            <th id="due-header">Next repayment due</th>
            <th>Status</th>
            <th><span class="actions-header-text">Actions</span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="empty-state" class="empty-state" style="display:none">
        No agreements found for this filter.
      </div>
      <div style="display:flex; justify-content:flex-end; margin-top:16px">
        <button id="new-agreement-btn" onclick="toggleNewAgreement()" style="display:flex; align-items:center; gap:8px; padding:12px 20px">
          <span style="font-size:18px; font-weight:bold">+</span>
          <span>New Agreement</span>
        </button>
      </div>
    </section>

    <!-- Welcome card for first-time users with no agreements -->
    <section class="card" id="welcome-card" style="display:none; text-align:center; padding:48px 32px">
      <h2 style="margin:0 0 16px 0; font-size:28px">Welcome to PayFriends.app</h2>
      <p style="color:var(--text); font-size:16px; line-height:1.6; max-width:700px; margin:0 auto 32px auto">
        PayFriends takes over the awkward part of lending — reminding, chasing, negotiating and recalculating — so you don't have to be the debt collector for your friends.
      </p>
      <div style="max-width:600px; margin:0 auto 32px auto; text-align:left">
        <div style="display:flex; gap:12px; margin-bottom:16px">
          <div style="color:var(--accent); font-size:20px; flex-shrink:0">✓</div>
          <div style="color:var(--text); font-size:15px">Create clear, written agreements for loans between friends.</div>
        </div>
        <div style="display:flex; gap:12px; margin-bottom:16px">
          <div style="color:var(--accent); font-size:20px; flex-shrink:0">✓</div>
          <div style="color:var(--text); font-size:15px">Automatic fair recalculations when repayments are early, late, or different amounts.</div>
        </div>
        <div style="display:flex; gap:12px">
          <div style="color:var(--accent); font-size:20px; flex-shrink:0">✓</div>
          <div style="color:var(--text); font-size:15px">PayFriends negotiates new plans with the borrower when they have payment issues.</div>
        </div>
      </div>
      <button onclick="toggleNewAgreement()" style="display:inline-flex; align-items:center; gap:8px; padding:14px 24px; width:auto; font-size:16px">
        <span style="font-size:20px; font-weight:bold">+</span>
        <span>New Agreement</span>
      </button>
    </section>

    <!-- Wizard for creating agreements -->
    <section class="card hidden" id="new-agreement-section">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
        <h2 style="margin:0">New Agreement</h2>
        <button class="secondary" onclick="closeNewAgreement()" style="padding:6px 12px; font-size:13px">Close</button>
      </div>

      <!-- Wizard Steps -->
      <div class="wizard-steps">
        <div class="wizard-step" id="step-indicator-1" onclick="clickStep(1)">1. Basics</div>
        <div class="wizard-step" id="step-indicator-2" onclick="clickStep(2)">2. Terms</div>
        <div class="wizard-step" id="step-indicator-3" onclick="clickStep(3)">3. Interest</div>
        <div class="wizard-step" id="step-indicator-4" onclick="clickStep(4)">4. Payments</div>
        <div class="wizard-step" id="step-indicator-5" onclick="clickStep(5)">5. Summary</div>
        <div class="wizard-step" id="step-indicator-6" onclick="clickStep(6)">6. Share with Bob</div>
      </div>

      <!-- Step 1: Setup -->
      <div id="wizard-step-1" class="wizard-content">
        <div id="readonly-banner-1" class="hidden" style="background:rgba(250,204,21,0.1); border:1px solid rgba(250,204,21,0.3); border-radius:8px; padding:12px; margin-bottom:20px; font-size:14px; color:var(--text)">
          ⚠️ This agreement has already been sent to <span id="readonly-name-1"></span> and can't be edited. To change details, cancel it from your dashboard and create a new one.
        </div>
        <h3 style="margin-top:0">Let's set up your agreement.</h3>
        <p style="color:var(--muted); font-size:14px; margin:-6px 0 20px 0">Start by choosing what you want to do.</p>

        <!-- Role selector cards -->
        <div style="margin:16px 0 24px 0">
          <label style="display:flex; align-items:center; gap:12px; cursor:pointer; padding:16px; border-radius:10px; border:2px solid rgba(255,255,255,0.08); margin-bottom:12px; transition:all 0.2s" onclick="selectRoleCard('lend')" id="role-card-lend">
            <input type="radio" name="role" value="lend" onchange="toggleBorrowerFields()" style="width:20px; height:20px" />
            <div style="flex:1">
              <div style="font-weight:600; font-size:15px">I want to lend money</div>
            </div>
          </label>
          <label style="display:flex; align-items:center; gap:12px; padding:16px; border-radius:10px; border:2px solid rgba(255,255,255,0.08); opacity:0.4; cursor:not-allowed">
            <input type="radio" name="role" value="borrow" disabled style="width:20px; height:20px" />
            <div style="flex:1">
              <div style="font-weight:600; font-size:15px">Borrow coming soon</div>
              <div style="color:var(--muted); font-size:13px">(greyed out)</div>
            </div>
          </label>
        </div>

        <div id="borrower-fields" class="hidden" style="transition:all 0.3s ease">
          <div class="row">
            <label>Borrower name</label>
            <input id="friend-first-name" placeholder="Alex" required oninput="autoCapitalizeName()" />
          </div>
          <p style="color:var(--muted); font-size:12px; margin:-6px 0 12px 172px">Full name or first name.</p>

          <div class="row">
            <label>Borrower email</label>
            <input id="friend-email" type="email" placeholder="alex@example.com" required />
          </div>
          <p style="color:var(--muted); font-size:12px; margin:-6px 0 12px 172px">To this email address we will send the link to review the agreement.</p>

          <div class="row">
            <label>Borrower phone</label>
            <div class="phone-input-wrapper" data-phone-id="agreement-phone">
              <div class="phone-input-row">
                <button type="button" class="phone-country-button"></button>
                <span class="phone-prefix"></span>
                <input type="tel" class="phone-number-input" placeholder="612345678" />
                <input type="hidden" id="agreement-phone" name="agreement-phone" class="phone-number-full" />
              </div>
              <div class="phone-dropdown">
                <input type="text" class="phone-dropdown-search" placeholder="Search country or code…" />
                <div class="phone-country-list"></div>
              </div>
            </div>
            <div id="agreement-phone-error" class="phone-error">Please enter a valid phone number.</div>
          </div>
          <p style="color:rgba(255,255,255,0.5); font-size:13px; margin:-6px 0 12px 172px">Borrower's phone number is required to send reminders.</p>

          <div class="row">
            <label>Loan description</label>
            <input id="description" type="text" placeholder="e.g. Money for rent, Car repair, Holiday loan" required maxlength="30" oninput="autoCapitalizeDescription()" />
          </div>
          <p style="color:var(--muted); font-size:12px; margin:-6px 0 12px 172px">A short note to identify this agreement.</p>

          <div style="margin-top:24px">
            <button onclick="goToTerms()">Continue to Terms</button>
          </div>
        </div>
        <p id="step1-status" class="status"></p>
      </div>

      <!-- Step 2: Terms -->
      <div id="wizard-step-2" class="wizard-content hidden">
        <div id="readonly-banner-2" class="hidden" style="background:rgba(250,204,21,0.1); border:1px solid rgba(250,204,21,0.3); border-radius:8px; padding:12px; margin-bottom:20px; font-size:14px; color:var(--text)">
          ⚠️ This agreement has already been sent to <span id="readonly-name-2"></span> and can't be edited. To change details, cancel it from your dashboard and create a new one.
        </div>
        <h3 style="margin-top:0">Define the loan terms.</h3>

        <div class="row">
          <label>Loan amount (€)</label>
          <input id="amount" type="text" placeholder="e.g. 6.000" required onblur="formatAmountInput(); validateAmountField();" onfocus="unformatAmountInput()" oninput="updateEstimate()" />
        </div>
        <p style="color:var(--muted); font-size:12px; margin:6px 0 4px 172px">Enter the amount in euros.</p>
        <p id="amount-error" class="hidden" style="color:#f87171; font-size:13px; margin:0 0 16px 172px"></p>

        <div class="row">
          <label>Money transfer date</label>
          <select id="money-sent-option" onchange="updateMoneySentOption()" style="flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text)">
            <option value="on-acceptance">When agreement is accepted</option>
            <option value="today">Today</option>
            <option value="tomorrow">Tomorrow</option>
            <option value="3days">In 3 days</option>
            <option value="7days">In 7 days</option>
            <option value="custom">Pick a date…</option>
          </select>
        </div>
        <div id="custom-money-sent-date" class="hidden" style="margin:16px 0">
          <div class="row">
            <label>Pick a date</label>
            <input id="money-sent-date" type="date" required />
          </div>
        </div>
        <p style="color:var(--muted); font-size:12px; margin:-6px 0 20px 172px">When was or will the money be sent to the borrower? You can also choose a date in the past when adding an existing loan.</p>

        <div style="margin:16px 0 24px 0">
          <label style="font-weight:600; font-size:14px; margin-bottom:8px; display:block">Repayment type</label>
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:12px; border-radius:10px; border:2px solid rgba(255,255,255,0.08); margin-bottom:8px; transition:all 0.2s" id="repayment-onetime-card">
            <input type="radio" name="repayment-type" value="one_time" onchange="toggleInstallmentFields()" checked />
            <span>One-time payment</span>
          </label>
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:12px; border-radius:10px; border:2px solid rgba(255,255,255,0.08); transition:all 0.2s" id="repayment-installments-card">
            <input type="radio" name="repayment-type" value="installments" onchange="toggleInstallmentFields()" />
            <span>Installments</span>
          </label>
        </div>

        <!-- One-time payment fields -->
        <div id="one-time-fields">
          <div class="row">
            <label>Full repayment due</label>
            <select id="one-time-due-option" onchange="updateOneTimeDueOption()" style="flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text)">
              <option value="1month">In 1 month</option>
              <option value="2months">In 2 months</option>
              <option value="3months">In 3 months</option>
              <option value="custom">Pick a date…</option>
            </select>
          </div>
          <p style="color:var(--muted); font-size:12px; margin:6px 0 20px 172px">Select when the borrower is expected to repay the full loan amount.</p>

          <div id="custom-one-time-due-date" class="hidden" style="margin:16px 0">
            <div class="row">
              <label>Pick a date</label>
              <input id="due-date" type="date" required onchange="updateDueDateHelper()" />
            </div>
          </div>

          <div id="one-time-estimate" style="color:var(--accent); font-size:14px; font-weight:500; margin:32px 0 12px 0; line-height:1.6"></div>
        </div>

        <!-- Installment fields -->
        <div id="installment-fields" class="hidden">
          <!-- Loan duration (only visible for installments) -->
          <div id="loan-duration-section">
            <div class="row">
              <label>Loan duration</label>
              <div style="flex:1; display:flex; gap:8px">
                <input id="loan-duration-value" type="number" min="1" max="600" step="1" value="12" oninput="calculateInstallments()" style="flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text)" />
                <select id="loan-duration-unit" onchange="calculateInstallments()" style="flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text)">
                  <option value="days">Days</option>
                  <option value="weeks">Weeks</option>
                  <option value="months" selected>Months</option>
                  <option value="years">Years</option>
                </select>
              </div>
            </div>
            <p style="color:var(--muted); font-size:12px; margin:6px 0 20px 172px">How long the loan lasts in total (for example 12 months or 3 years).</p>
          </div>

          <div class="row">
            <label>Number of payments</label>
            <input id="num-repayments" type="number" min="2" max="120" step="1" value="12" placeholder="e.g. 12" oninput="calculateInstallments()" style="flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text)" />
          </div>
          <p style="color:var(--muted); font-size:12px; margin:6px 0 20px 172px">How many separate payments the borrower will make over this period.</p>
          <p id="num-repayments-error" class="hidden" style="color:#f87171; font-size:13px; margin:-14px 0 20px 172px"></p>

          <div class="row">
            <label>Payment frequency</label>
            <div id="repayment-interval-display" style="flex:1; padding:10px 12px; border-radius:10px; background:rgba(255,255,255,0.02); color:var(--muted); font-size:14px">
              Every 1 month
            </div>
          </div>
          <p style="color:var(--muted); font-size:12px; margin:6px 0 20px 172px">Automatically calculated from the loan duration and number of payments.</p>

          <div class="row">
            <label>First payment due</label>
            <select id="first-payment-option" onchange="updateFirstPaymentOption()" style="flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text)">
              <option value="3days">In 3 days</option>
              <option value="7days">In 7 days</option>
              <option value="1month" selected>In 1 month from now</option>
              <option value="2months">In 2 months from now</option>
              <option value="3months">In 3 months from now</option>
              <option value="6months">In 6 months from now</option>
              <option value="12months">In 12 months from now</option>
              <option value="today">Today</option>
              <option value="tomorrow">Tomorrow</option>
              <option value="custom">Pick a date…</option>
            </select>
          </div>
          <p style="color:var(--muted); font-size:12px; margin:6px 0 20px 172px">When will the borrower start paying you back?</p>

          <div id="custom-first-payment-date" class="hidden" style="margin:16px 0">
            <div class="row">
              <label>Pick a date</label>
              <input id="first-payment-date" type="date" required onchange="calculateInstallments()" />
            </div>
          </div>

          <div id="installment-summary" style="margin:32px 0 12px 0; line-height:1.8">
            <p id="plan-length-summary" style="color:var(--muted); font-size:14px; margin:0 0 4px 0"></p>
            <p id="installment-estimate" style="color:var(--accent); font-size:14px; font-weight:500; margin:0"></p>
          </div>
        </div>

        <div style="margin-top:24px">
          <button onclick="goToInterest()">Continue to Interest</button>
          <button class="secondary" onclick="goToStep(1)">Back</button>
        </div>
        <p id="step2-status" class="status"></p>
      </div>

      <!-- Step 3: Interest & Calculation -->
      <div id="wizard-step-3" class="wizard-content hidden">
        <div id="readonly-banner-3" class="hidden" style="background:rgba(250,204,21,0.1); border:1px solid rgba(250,204,21,0.3); border-radius:8px; padding:12px; margin-bottom:20px; font-size:14px; color:var(--text)">
          ⚠️ This agreement has already been sent to <span id="readonly-name-3"></span> and can't be edited. To change details, cancel it from your dashboard and create a new one.
        </div>
        <h3 style="margin-top:0">Interest & payment calculation</h3>

        <div class="row" style="margin-top:20px; align-items:center">
          <label>Interest rate</label>
          <div style="flex:1; display:flex; align-items:center; gap:12px; justify-content:space-between">
            <div style="display:flex; align-items:center; gap:8px">
              <input id="interest-rate" type="number" min="0" max="100" step="0.1" placeholder="4" oninput="calculateInterest()" style="width:100px; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text)" />
              <span style="color:var(--text); font-size:14px">% per year</span>
            </div>
            <span id="interest-rate-badge" style="display:inline-block; padding:6px 12px; border-radius:6px; font-size:12px; font-weight:600; white-space:nowrap"></span>
          </div>
        </div>
        <p id="interest-rate-helper" style="color:var(--muted); font-size:12px; margin:4px 0 12px 172px"></p>

        <div style="margin:12px 0 20px 172px">
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer">
            <input type="checkbox" id="no-interest-checkbox" onchange="toggleNoInterest()" />
            <span style="font-size:14px">No interest</span>
          </label>
        </div>

        <div id="interest-summary-card" style="background:#10151d; border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:20px; margin:24px 0">
          <h4 style="margin:0 0 16px 0; font-size:16px; border-bottom:1px solid rgba(255,255,255,0.08); padding-bottom:12px">Loan summary</h4>
          <div style="display:flex; justify-content:space-between; padding:8px 0">
            <span style="color:var(--muted)">Loan amount</span>
            <span style="font-weight:600">€<span id="summary-loan-amount">0</span></span>
          </div>
          <div style="display:flex; justify-content:space-between; padding:8px 0">
            <span style="color:var(--muted)">Duration</span>
            <span style="font-weight:600" id="summary-duration">—</span>
          </div>
          <div style="display:flex; justify-content:space-between; padding:8px 0">
            <span style="color:var(--muted)">Interest rate</span>
            <span style="font-weight:600"><span id="summary-interest-rate">0</span> % per year</span>
          </div>
          <div style="display:flex; justify-content:space-between; padding:8px 0; border-top:1px solid rgba(255,255,255,0.08); margin-top:8px; padding-top:12px">
            <span style="color:var(--muted)">Total interest</span>
            <span style="font-weight:600">€<span id="total-interest-display">0</span></span>
          </div>
          <div style="display:flex; justify-content:space-between; padding:8px 0">
            <span style="color:var(--muted); font-weight:600">Total to repay</span>
            <span style="font-weight:700; font-size:18px; color:var(--accent)">€<span id="total-repay-display">0</span></span>
          </div>
          <p style="margin:12px 0 0 0; color:var(--muted); font-size:12px; line-height:1.5">Interest is calculated only on the remaining balance — fair and transparent.</p>
        </div>

        <div style="margin:20px 0">
          <button onclick="toggleBreakdown()" class="secondary" style="padding:8px 16px; font-size:14px">
            <span id="breakdown-toggle-text">Show payment breakdown</span>
          </button>
        </div>

        <div id="interest-breakdown" class="hidden" style="background:#10151d; border:1px solid rgba(255,255,255,0.08); border-radius:8px; padding:16px; margin:20px 0; max-height:400px; overflow-y:auto">
          <h5 style="margin:0 0 12px 0; font-size:14px">Payment breakdown</h5>
          <table style="width:100%; font-size:13px">
            <thead>
              <tr style="border-bottom:1px solid rgba(255,255,255,0.08)">
                <th style="text-align:left; padding:8px 4px">#</th>
                <th style="text-align:left; padding:8px 4px">Date</th>
                <th style="text-align:right; padding:8px 4px">Payment</th>
                <th style="text-align:right; padding:8px 4px">Loan repayment</th>
                <th style="text-align:right; padding:8px 4px">Interest</th>
                <th style="text-align:right; padding:8px 4px">Remaining</th>
              </tr>
            </thead>
            <tbody id="breakdown-tbody"></tbody>
          </table>
        </div>

        <div style="margin-top:32px">
          <button onclick="goToPayments()">Continue to Payments</button>
          <button class="secondary" onclick="goToStep(2)">Back</button>
        </div>
        <p id="step3-status" class="status"></p>
      </div>

      <!-- Step 4: Payments & Reminders -->
      <div id="wizard-step-4" class="wizard-content hidden">
        <div id="readonly-banner-4" class="hidden" style="background:rgba(250,204,21,0.1); border:1px solid rgba(250,204,21,0.3); border-radius:8px; padding:12px; margin-bottom:20px; font-size:14px; color:var(--text)">
          ⚠️ This agreement has already been sent to <span id="readonly-name-4"></span> and can't be edited. To change details, cancel it from your dashboard and create a new one.
        </div>
        <h3 style="margin-top:0">Decide how repayments will be made and managed.</h3>

        <!-- Payment methods -->
        <div style="margin:24px 0">
          <h4 style="margin:0 0 12px 0; font-size:16px">Payment methods</h4>
          <p style="color:var(--muted); font-size:13px; margin-bottom:12px">Select all that apply:</p>

          <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02)">
              <input type="checkbox" class="payment-method-checkbox" value="bank" checked />
              <span style="font-size:14px">Bank transfer</span>
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02)">
              <input type="checkbox" class="payment-method-checkbox" value="cash" />
              <span style="font-size:14px">Cash</span>
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02)">
              <input type="checkbox" class="payment-method-checkbox" value="paypal" />
              <span style="font-size:14px">PayPal / mobile payment</span>
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02)">
              <input type="checkbox" class="payment-method-checkbox" value="crypto" />
              <span style="font-size:14px">Crypto</span>
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02)">
              <input type="checkbox" class="payment-method-checkbox" value="other" onchange="toggleOtherPaymentMethod()" />
              <span style="font-size:14px">Other</span>
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02)">
              <input type="checkbox" class="payment-method-checkbox" value="any" />
              <span style="font-size:14px">Any method</span>
            </label>
          </div>

          <div id="other-payment-method" class="hidden" style="margin:12px 0">
            <input id="other-payment-description" type="text" placeholder="Describe the other payment method" style="width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text)" />
          </div>
        </div>

        <!-- Require proof of repayment -->
        <div style="margin:24px 0">
          <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px">
            <label class="toggle-switch">
              <input type="checkbox" id="proof-required" checked />
              <span class="toggle-slider"></span>
            </label>
            <h4 style="margin:0; font-size:16px">Require proof of repayment</h4>
          </div>
          <p style="color:var(--muted); font-size:13px; margin:0; line-height:1.5">The borrower will be asked to upload proof for each repayment, such as a photo, screenshot or PDF of the transfer or receipt.</p>
        </div>

        <!-- Reminders -->
        <div style="margin:24px 0">
          <h4 style="margin:0 0 8px 0; font-size:16px">Reminders</h4>
          <p style="color:var(--muted); font-size:13px; margin-bottom:12px">We only send reminders if no payment has been reported for that installment.</p>

          <label style="display:flex; align-items:flex-start; gap:12px; cursor:pointer; padding:16px; border-radius:10px; border:2px solid rgba(255,255,255,0.08); margin-bottom:12px; transition:all 0.2s" id="reminder-auto-card">
            <input type="radio" name="reminder-mode" value="auto" onchange="toggleReminderMode()" checked style="margin-top:2px" />
            <div style="flex:1">
              <div style="font-weight:600; margin-bottom:6px">Auto (recommended)</div>
              <div style="color:var(--muted); font-size:13px; line-height:1.5">We'll remind the borrower 7 days before, 1 day before and on the due date. If no payment is reported, we'll send follow-up reminders 1 day after, then every 3 days.</div>
            </div>
          </label>
          <label style="display:flex; align-items:flex-start; gap:12px; cursor:pointer; padding:16px; border-radius:10px; border:2px solid rgba(255,255,255,0.08); transition:all 0.2s" id="reminder-custom-card">
            <input type="radio" name="reminder-mode" value="custom" onchange="toggleReminderMode()" style="margin-top:2px" />
            <div style="flex:1">
              <div style="font-weight:600; margin-bottom:6px">Custom schedule</div>
              <div id="custom-reminders" class="hidden" style="margin-top:12px">
                <div style="color:var(--muted); font-size:13px; margin-bottom:10px">Select when to send reminders:</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px">
                  <label style="display:flex; align-items:center; gap:6px; font-size:13px">
                    <input type="checkbox" value="-14" class="custom-reminder-checkbox" /> 14 days before
                  </label>
                  <label style="display:flex; align-items:center; gap:6px; font-size:13px">
                    <input type="checkbox" value="-7" class="custom-reminder-checkbox" /> 7 days before
                  </label>
                  <label style="display:flex; align-items:center; gap:6px; font-size:13px">
                    <input type="checkbox" value="-3" class="custom-reminder-checkbox" /> 3 days before
                  </label>
                  <label style="display:flex; align-items:center; gap:6px; font-size:13px">
                    <input type="checkbox" value="-1" class="custom-reminder-checkbox" /> 1 day before
                  </label>
                  <label style="display:flex; align-items:center; gap:6px; font-size:13px">
                    <input type="checkbox" value="0" class="custom-reminder-checkbox" /> On the due date
                  </label>
                  <label style="display:flex; align-items:center; gap:6px; font-size:13px">
                    <input type="checkbox" value="1" class="custom-reminder-checkbox" /> 1 day after
                  </label>
                  <label style="display:flex; align-items:center; gap:6px; font-size:13px">
                    <input type="checkbox" value="3" class="custom-reminder-checkbox" /> Every 3 days after
                  </label>
                  <label style="display:flex; align-items:center; gap:6px; font-size:13px">
                    <input type="checkbox" value="7" class="custom-reminder-checkbox" /> Every 7 days after
                  </label>
                </div>
                <p id="custom-reminder-error" style="color:#ff6b6b; font-size:12px; margin-top:8px; display:none">Please select at least one reminder</p>
              </div>
            </div>
          </label>
        </div>

        <!-- Worst-case scenario -->
        <div style="margin:24px 0">
          <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px">
            <label class="toggle-switch">
              <input type="checkbox" id="debt-collection-clause" checked />
              <span class="toggle-slider"></span>
            </label>
            <h4 style="margin:0; font-size:16px">Worst case scenario</h4>
          </div>
          <p style="color:var(--muted); font-size:13px; margin:0; line-height:1.5">If the borrower does not repay in time and ignores reminders or cannot agree a new plan with the lender, PayFriends will hand the case to an independent debt collector. Once this happens, the lender is no longer involved in collection — the third party handles it, and any collection fees are for the borrower's account.</p>
        </div>

        <div style="margin-top:32px">
          <button onclick="goToSummary()">Continue to Summary</button>
          <button class="secondary" onclick="goToStep(3)">Back</button>
        </div>
        <p id="step4-status" class="status"></p>
      </div>

      <!-- Step 5: Summary -->
      <div id="wizard-step-5" class="wizard-content hidden">
        <div id="readonly-banner-5" class="hidden" style="background:rgba(250,204,21,0.1); border:1px solid rgba(250,204,21,0.3); border-radius:8px; padding:12px; margin-bottom:20px; font-size:14px; color:var(--text)">
          ⚠️ This agreement has already been sent to <span id="readonly-name-5"></span> and can't be edited. To change details, cancel it from your dashboard and create a new one.
        </div>
        <h3 style="margin-top:0">Review and send your agreement.</h3>

        <!-- Summary text at top -->
        <div style="background:rgba(61,220,151,0.05); border:1px solid rgba(61,220,151,0.15); border-radius:12px; padding:20px; margin:20px 0">
          <p id="full-summary-text" style="margin:0; color:var(--accent); font-size:15px; line-height:1.8; white-space:pre-line"></p>
        </div>

        <!-- General details table -->
        <div style="margin:16px 0">
          <h4 style="margin:0 0 12px 0; font-size:16px">Agreement Details</h4>
          <div style="background:#10151d; border:1px solid rgba(255,255,255,0.08); border-radius:8px; padding:16px">
            <div id="general-details-content"></div>
          </div>
        </div>

        <!-- Expandable: Interest, payment calculation & installment schedule -->
        <div style="margin:16px 0">
          <button onclick="toggleSection('interest-calc-section')" class="secondary" style="width:100%; text-align:left; padding:12px 16px; font-size:14px; display:flex; justify-content:space-between; align-items:center">
            <span>Interest, payment calculation & installment schedule</span>
            <span id="interest-calc-toggle">▼</span>
          </button>
          <div id="interest-calc-section" class="hidden" style="background:#10151d; border:1px solid rgba(255,255,255,0.08); border-radius:0 0 8px 8px; padding:16px; margin-top:-1px">
            <div id="interest-calc-content"></div>
          </div>
        </div>

        <!-- Expandable: Payments & Reminders -->
        <div style="margin:16px 0">
          <button onclick="toggleSection('payments-reminders-section')" class="secondary" style="width:100%; text-align:left; padding:12px 16px; font-size:14px; display:flex; justify-content:space-between; align-items:center">
            <span>Payments & reminders</span>
            <span id="payments-reminders-toggle">▼</span>
          </button>
          <div id="payments-reminders-section" class="hidden" style="background:#10151d; border:1px solid rgba(255,255,255,0.08); border-radius:0 0 8px 8px; padding:16px; margin-top:-1px">
            <div id="payments-reminders-content"></div>
          </div>
        </div>

        <div id="invite-not-sent" style="margin-top:32px">
          <button onclick="sendInvite()">Send to <span id="send-friend-name"></span> for review</button>
          <button class="secondary" onclick="goToStep(4)">Back to edit</button>
        </div>

        <div id="invite-sent" class="hidden">
          <div style="background:rgba(61,220,151,0.1); border:1px solid rgba(61,220,151,0.2); border-radius:12px; padding:16px; margin:24px 0">
            <p style="margin:0; color:var(--accent); font-weight:600; font-size:16px">✓ Invite sent!</p>
          </div>
          <p style="color:var(--muted); font-size:14px">Share this invite link with your friend:</p>
          <div class="invite-url-box" id="invite-url"></div>
          <button onclick="copyInviteUrl()">Copy invite link</button>
          <button class="secondary" onclick="resetWizard()">Create another agreement</button>
        </div>

        <p id="step5-status" class="status"></p>
      </div>

      <!-- Step 6: Share -->
      <div id="wizard-step-6" class="wizard-content hidden">
        <h3 style="margin-top:0">6. Share agreement with <span id="share-heading-name"></span></h3>

        <!-- Success header -->
        <div style="background:rgba(61,220,151,0.1); border:1px solid rgba(61,220,151,0.25); border-radius:12px; padding:20px; margin:20px 0">
          <div style="font-size:18px; font-weight:700; color:var(--accent); margin-bottom:8px">Agreement sent by email</div>
          <div style="font-size:14px; color:var(--text)">We've emailed this agreement to <span id="share-invite-name"></span> at <span id="share-invite-email"></span>. You can also share the link or QR code below.</div>
        </div>

        <!-- Share link section -->
        <div style="margin:24px 0">
          <h4 style="margin:0 0 12px 0; font-size:16px">Share the invite link</h4>
          <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px">
            <input id="share-link-input" type="text" readonly style="flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text); font-family:monospace; font-size:13px" />
            <button onclick="copyShareLink()" style="width:auto; white-space:nowrap; padding:10px 16px">Copy link</button>
          </div>
          <p style="color:var(--muted); font-size:13px; margin:0">You can paste this link into WhatsApp, Signal, email or anywhere else you like. Please note that <span id="share-signup-name"></span> needs to sign up with <span id="share-signup-email"></span> in order to view the agreement.</p>
        </div>

        <!-- QR code section -->
        <div style="margin:24px 0">
          <h4 style="margin:0 0 12px 0; font-size:16px">Or let <span id="share-qr-name"></span> scan this QR code</h4>
          <div id="qr-code-container"></div>
        </div>

        <!-- Buttons -->
        <div style="margin-top:32px; display:flex; gap:12px">
          <button onclick="goToDashboard()">Done, return to dashboard</button>
          <button class="secondary" onclick="createAnotherAgreement()">Create another agreement</button>
        </div>

        <p id="step6-status" class="status"></p>
      </div>
    </section>

    <!-- Payment Confirmation Modal -->
    <div id="confirm-payment-modal" class="modal-overlay" style="display:none" onclick="closeModalOnOverlay(event, 'confirm-payment-modal')">
      <div class="modal-card" onclick="event.stopPropagation()">
        <div class="modal-header">
          <h2 class="modal-title">Confirm payment</h2>
          <button class="modal-close" onclick="closeConfirmPaymentModal()">&times;</button>
        </div>
        <div class="modal-body" id="confirm-payment-modal-body">
          <p style="text-align:center; color:var(--muted)">Loading...</p>
        </div>
      </div>
    </div>

    <!-- Payment Issue Modal -->
    <div id="difficulty-modal" class="modal-overlay" style="display:none" onclick="closeModalOnOverlay(event, 'difficulty-modal')">
      <div class="modal-card" onclick="event.stopPropagation()">
        <div class="modal-header">
          <h2 class="modal-title">Payment issue</h2>
          <button class="modal-close" onclick="closeDifficultyModal()">&times;</button>
        </div>
        <div class="modal-body" id="difficulty-modal-body">
          <p style="text-align:center; color:var(--muted)">Loading...</p>
        </div>
      </div>
    </div>
  </main>

  <script>
    let allAgreements = [];
    let currentFilter = 'all';
    let currentUser = null;
    let wizardData = {
      role: null,
      friendFirstName: '',
      friendEmail: '',
      description: '',
      amount: '',
      repaymentType: 'one_time',
      dueDate: '',
      moneySentDate: '',
      moneySentOption: 'on-acceptance',
      // Installment fields
      planLength: null,
      planUnit: 'months',
      firstPaymentDate: '',
      installmentCount: null,
      installmentAmount: null,
      finalDueDate: '',
      // Interest fields
      hasInterest: true,
      interestRate: 0,
      totalInterest: 0,
      totalRepayAmount: 0,
      // Payment preferences
      paymentMethods: ['bank'],
      paymentOtherDescription: '',
      reminderMode: 'auto',
      reminderOffsets: [-7, -1, 0, 1, 3],
      proofRequired: true,
      debtCollectionClause: true,
      inviteUrl: '',
      agreementSent: false
    };

    // Format amount in cents to euros with thousand separators, no decimals
    function formatAmount(cents) {
      const euros = Math.round(cents / 100);
      return new Intl.NumberFormat('de-DE').format(euros);
    }

    // Get initials from a name (e.g., "Alex Smith" -> "AS", "Alex" -> "A")
    function getInitials(name) {
      if (!name || typeof name !== 'string') return '?';
      const parts = name.trim().split(/\s+/);
      if (parts.length === 1) {
        return parts[0].charAt(0).toUpperCase();
      }
      return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
    }

    // Get consistent color class based on name hash
    function getColorClass(name) {
      if (!name) return 'color-1';
      let hash = 0;
      for (let i = 0; i < name.length; i++) {
        hash = name.charCodeAt(i) + ((hash << 5) - hash);
      }
      const colorIndex = (Math.abs(hash) % 7) + 1;
      return `color-${colorIndex}`;
    }

    // Generate avatar HTML (image or initials)
    function generateAvatarHTML(user, size = 'small') {
      const initials = getInitials(user.name || user.counterparty_name || '');
      const colorClass = getColorClass(user.name || user.counterparty_name || '');

      if (user.profile_picture_url) {
        return `<div class="user-avatar size-${size}">
          <img src="${user.profile_picture_url}" class="user-avatar-image" alt="${user.name || ''}" />
        </div>`;
      } else {
        return `<div class="user-avatar size-${size}">
          <div class="user-avatar-initials ${colorClass}">${initials}</div>
        </div>`;
      }
    }

    // Format due date with countdown logic
    function formatDueDate(agreement, isLender) {
      const status = agreement.status || 'pending';

      // For settled agreements
      if (status === 'settled' && agreement.settled_date) {
        const settledDate = new Date(agreement.settled_date);
        const formatted = settledDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        return `<span class="due-date-settled">Settled on ${formatted}</span>`;
      }

      // For pending or cancelled, just show the date
      if (status === 'pending' || status === 'cancelled') {
        return agreement.due_date || '—';
      }

      // For active agreements, calculate next payment due
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      let nextDueDate = null;
      if (agreement.next_payment_date) {
        nextDueDate = new Date(agreement.next_payment_date);
      } else if (agreement.due_date) {
        nextDueDate = new Date(agreement.due_date);
      }

      if (!nextDueDate) {
        return '—';
      }

      nextDueDate.setHours(0, 0, 0, 0);
      const diffTime = nextDueDate - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

      const dateStr = nextDueDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });

      if (diffDays < 0) {
        // Overdue
        const daysOverdue = Math.abs(diffDays);
        return `<span class="due-date-overdue">${dateStr} (${daysOverdue} day${daysOverdue !== 1 ? 's' : ''} overdue)</span>`;
      } else if (diffDays === 0) {
        return `<span class="due-date-overdue">${dateStr} (due today)</span>`;
      } else if (diffDays <= 7) {
        return `<span>${dateStr} (in ${diffDays} day${diffDays !== 1 ? 's' : ''})</span>`;
      } else {
        return dateStr;
      }
    }

    // Format the amount input field on blur
    function formatAmountInput() {
      const input = document.getElementById('amount');
      const value = input.value.trim();
      if (!value) return;

      // Remove any existing formatting (dots, commas)
      const cleanValue = value.replace(/[.,]/g, '');
      const num = parseFloat(cleanValue);

      if (!isNaN(num) && num > 0) {
        // Format with thousand separators (German style: 6.000)
        input.value = new Intl.NumberFormat('de-DE').format(num);
      }
    }

    // Remove formatting from amount input on focus for easier editing
    function unformatAmountInput() {
      const input = document.getElementById('amount');
      const value = input.value.trim();
      if (!value) return;

      // Remove thousand separators
      const cleanValue = value.replace(/\./g, '').replace(/,/g, '');
      if (!isNaN(cleanValue) && cleanValue !== '') {
        input.value = cleanValue;
      }
    }

    // Validate amount field and show error if needed
    function validateAmountField() {
      const input = document.getElementById('amount');
      const errorElement = document.getElementById('amount-error');
      const value = input.value.trim();

      if (!value) {
        input.style.border = '1px solid #f87171';
        errorElement.textContent = 'Please enter a loan amount.';
        errorElement.classList.remove('hidden');
        return false;
      }

      const cleanValue = value.replace(/[.,]/g, '');
      const num = parseFloat(cleanValue);

      if (isNaN(num) || num <= 0) {
        input.style.border = '1px solid #f87171';
        errorElement.textContent = 'Please enter a valid loan amount.';
        errorElement.classList.remove('hidden');
        return false;
      }

      // Clear error state
      input.style.border = '';
      errorElement.classList.add('hidden');
      return true;
    }

    // Capitalize first letter of description
    function capitalizeDescription() {
      const input = document.getElementById('description');
      const value = input.value.trim();
      if (value.length > 0) {
        input.value = value.charAt(0).toUpperCase() + value.slice(1);
      }
    }

    // Calculate time ago from a timestamp
    function timeAgo(timestamp) {
      const now = new Date();
      const past = new Date(timestamp);
      const diffMs = now - past;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);
      const diffHour = Math.floor(diffMin / 60);
      const diffDay = Math.floor(diffHour / 24);

      if (diffSec < 60) return 'just now';
      if (diffMin < 60) return `${diffMin} min${diffMin > 1 ? 's' : ''} ago`;
      if (diffHour < 24) return `${diffHour} hour${diffHour > 1 ? 's' : ''} ago`;
      if (diffDay === 1) return '1 day ago';
      if (diffDay < 30) return `${diffDay} days ago`;
      const diffMonth = Math.floor(diffDay / 30);
      if (diffMonth === 1) return '1 month ago';
      if (diffMonth < 12) return `${diffMonth} months ago`;
      const diffYear = Math.floor(diffDay / 365);
      return `${diffYear} year${diffYear > 1 ? 's' : ''} ago`;
    }

    // Wizard functions
    function goToStep(step) {
      // Hide all steps
      for (let i = 1; i <= 6; i++) {
        document.getElementById(`wizard-step-${i}`).classList.add('hidden');
        document.getElementById(`step-indicator-${i}`).classList.remove('active');
      }

      // Show current step
      document.getElementById(`wizard-step-${step}`).classList.remove('hidden');
      document.getElementById(`step-indicator-${step}`).classList.add('active');

      // Mark previous steps as completed
      for (let i = 1; i < step; i++) {
        document.getElementById(`step-indicator-${i}`).classList.add('completed');
      }

      // Special handling for step 1: ensure borrower fields visibility is correct
      if (step === 1) {
        toggleBorrowerFields();
      }

      // Special handling for step 2: initialize repayment type card styling
      if (step === 2) {
        const oneTimeCard = document.getElementById('repayment-onetime-card');
        const installmentsCard = document.getElementById('repayment-installments-card');
        const repaymentType = document.querySelector('input[name="repayment-type"]:checked').value;

        if (repaymentType === 'one_time') {
          oneTimeCard.classList.add('reminder-option-active');
          installmentsCard.classList.remove('reminder-option-active');
        } else {
          oneTimeCard.classList.remove('reminder-option-active');
          installmentsCard.classList.add('reminder-option-active');
        }
      }

      // Special handling for step 4: initialize reminder mode highlight
      if (step === 4) {
        toggleReminderMode();
      }

      // Apply read-only mode if agreement has been sent
      if (wizardData.agreementSent && step <= 5) {
        applyReadOnlyMode(step);
      }
    }

    function applyReadOnlyMode(step) {
      // Show banner with borrower name
      const banner = document.getElementById(`readonly-banner-${step}`);
      const nameSpan = document.getElementById(`readonly-name-${step}`);
      if (banner && nameSpan) {
        nameSpan.textContent = wizardData.friendFirstName;
        banner.classList.remove('hidden');
      }

      // Disable all inputs in the step
      const stepDiv = document.getElementById(`wizard-step-${step}`);
      if (stepDiv) {
        const inputs = stepDiv.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
          input.disabled = true;
          input.style.opacity = '0.6';
          input.style.cursor = 'not-allowed';
        });

        // Disable all buttons except "Back" or navigation buttons
        const buttons = stepDiv.querySelectorAll('button');
        buttons.forEach(button => {
          if (!button.classList.contains('secondary') && !button.textContent.includes('Back')) {
            button.disabled = true;
            button.style.opacity = '0.5';
            button.style.cursor = 'not-allowed';
          }
        });
      }

      // Special handling for Step 5: replace send button with "View Share options"
      if (step === 5) {
        const inviteNotSent = document.getElementById('invite-not-sent');
        const inviteSent = document.getElementById('invite-sent');
        if (inviteNotSent && inviteSent) {
          inviteNotSent.classList.add('hidden');
          inviteSent.classList.add('hidden');
        }

        // Add a button to navigate to Step 6 if it doesn't exist
        const step5Div = document.getElementById('wizard-step-5');
        let viewShareBtn = document.getElementById('view-share-btn');
        if (!viewShareBtn && step5Div) {
          viewShareBtn = document.createElement('div');
          viewShareBtn.id = 'view-share-btn';
          viewShareBtn.style.marginTop = '32px';
          viewShareBtn.innerHTML = '<button onclick="goToStep(6)">View Share options</button>';
          step5Div.appendChild(viewShareBtn);
        }
      }
    }

    // Handle step click with validation
    function clickStep(targetStep) {
      // Determine current step
      let currentStep = 1;
      for (let i = 1; i <= 6; i++) {
        if (!document.getElementById(`wizard-step-${i}`).classList.contains('hidden')) {
          currentStep = i;
          break;
        }
      }

      // If agreement has been sent, allow navigation to all steps including Step 6
      if (wizardData.agreementSent) {
        goToStep(targetStep);
        return;
      }

      // Allow clicking back without validation
      if (targetStep < currentStep) {
        goToStep(targetStep);
        return;
      }

      // If clicking forward, validate current step and navigate
      if (targetStep > currentStep) {
        // Step 1 → 2+: Validate step 1 fields
        if (currentStep === 1 && targetStep >= 2) {
          if (!validateStep1()) return;
          if (targetStep === 2) {
            goToTerms();
            return;
          }
        }

        // Step 2 → 3+: Validate step 2 fields
        if (currentStep === 2 && targetStep >= 3) {
          if (!validateStep2()) return;
          if (targetStep === 3) {
            goToInterest();
            return;
          }
        }

        // Step 3 → 4+: Navigate to payments
        if (currentStep === 3 && targetStep >= 4) {
          if (targetStep === 4) {
            goToPayments();
            return;
          }
        }

        // Step 4 → 5: Navigate to summary
        if (currentStep === 4 && targetStep === 5) {
          goToSummary();
          return;
        }

        // Step 5 → 6: Can only happen after sending (handled by sendInvite)
        if (currentStep === 5 && targetStep === 6) {
          return; // Prevent manual navigation to step 6
        }

        // Step 6 allows clicking back
        if (currentStep === 6 && targetStep < 6) {
          goToStep(targetStep);
          return;
        }
      }

      // If same step, do nothing
      if (targetStep === currentStep) {
        return;
      }
    }

    // Select role card and update UI
    function selectRoleCard(role) {
      wizardData.role = role;
      document.querySelector(`input[name="role"][value="${role}"]`).checked = true;

      // Visual feedback
      document.getElementById('role-card-lend').style.borderColor = role === 'lend' ? 'var(--accent)' : 'rgba(255,255,255,0.08)';

      // Show/hide borrower fields
      toggleBorrowerFields();
    }

    // Toggle borrower fields visibility based on role selection
    function toggleBorrowerFields() {
      const role = document.querySelector('input[name="role"]:checked')?.value;
      const borrowerFields = document.getElementById('borrower-fields');

      if (role === 'lend') {
        borrowerFields.classList.remove('hidden');
      } else {
        borrowerFields.classList.add('hidden');
      }
    }

    // Auto-capitalize name input
    function autoCapitalizeName() {
      const input = document.getElementById('friend-first-name');
      const value = input.value;
      if (value.length > 0) {
        input.value = value.charAt(0).toUpperCase() + value.slice(1);
      }
    }

    // Auto-capitalize description input
    function autoCapitalizeDescription() {
      const input = document.getElementById('description');
      const value = input.value;
      if (value.length > 0) {
        input.value = value.charAt(0).toUpperCase() + value.slice(1);
      }
    }

    // Validate step 1 (Setup)
    function validateStep1() {
      const role = wizardData.role || document.querySelector('input[name="role"]:checked')?.value;
      const friendFirstName = document.getElementById('friend-first-name').value.trim();
      const friendEmail = document.getElementById('friend-email').value.trim();
      const description = document.getElementById('description').value.trim();
      const status = document.getElementById('step1-status');
      const phoneError = document.getElementById('agreement-phone-error');

      // Hide phone error initially
      phoneError.style.display = 'none';

      if (!role) {
        status.textContent = 'Please select a role (lend or borrow)';
        return false;
      }

      if (!friendFirstName) {
        status.textContent = 'Please enter borrower name';
        return false;
      }

      if (!friendEmail) {
        status.textContent = 'Please enter borrower email';
        return false;
      }

      // Validate phone number
      if (!agreementPhoneInput || !agreementPhoneInput.isValidNumber()) {
        phoneError.style.display = 'block';
        if (agreementPhoneInput) {
          agreementPhoneInput.setInvalid(true);
        }
        status.textContent = 'Please fix the errors above';
        return false;
      }
      // Clear invalid state if valid
      agreementPhoneInput.setInvalid(false);

      if (!description) {
        status.textContent = 'Please enter loan description';
        return false;
      }

      if (description.length > 30) {
        status.textContent = 'Loan description must be 30 characters or less';
        return false;
      }

      // Get phone number in E.164 format
      const phoneNumber = agreementPhoneInput.getNumber();

      // Store validated data
      wizardData.role = role;
      wizardData.friendFirstName = friendFirstName.charAt(0).toUpperCase() + friendFirstName.slice(1);
      wizardData.friendEmail = friendEmail;
      wizardData.phoneNumber = phoneNumber;
      wizardData.description = description.charAt(0).toUpperCase() + description.slice(1);

      status.textContent = '';
      return true;
    }

    // Navigate to Terms step
    function goToTerms() {
      if (!validateStep1()) return;
      goToStep(2);
      // Initialize default due date for one-time payment if not already set
      const dueDateInput = document.getElementById('due-date');
      if (!dueDateInput.value) {
        updateOneTimeDueOption();
      }
    }

    // Toggle between one-time and installment fields
    function toggleInstallmentFields() {
      const repaymentType = document.querySelector('input[name="repayment-type"]:checked').value;
      const oneTimeFields = document.getElementById('one-time-fields');
      const installmentFields = document.getElementById('installment-fields');
      const oneTimeCard = document.getElementById('repayment-onetime-card');
      const installmentsCard = document.getElementById('repayment-installments-card');

      if (repaymentType === 'installments') {
        oneTimeFields.classList.add('hidden');
        installmentFields.classList.remove('hidden');
        wizardData.repaymentType = 'installments';

        // Update card styling
        oneTimeCard.classList.remove('reminder-option-active');
        installmentsCard.classList.add('reminder-option-active');

        // Set defaults for loan duration fields
        const loanDurationValue = document.getElementById('loan-duration-value');
        const loanDurationUnit = document.getElementById('loan-duration-unit');
        const numRepaymentsInput = document.getElementById('num-repayments');

        if (!loanDurationValue.value) {
          loanDurationValue.value = '12';
        }
        if (!loanDurationUnit.value) {
          loanDurationUnit.value = 'months';
        }
        if (!numRepaymentsInput.value) {
          numRepaymentsInput.value = '12';
        }

        // Set default first payment option
        document.getElementById('first-payment-option').value = '1month';
        updateFirstPaymentOption();
      } else {
        oneTimeFields.classList.remove('hidden');
        installmentFields.classList.add('hidden');
        wizardData.repaymentType = 'one_time';

        // Update card styling
        oneTimeCard.classList.add('reminder-option-active');
        installmentsCard.classList.remove('reminder-option-active');

        // Clear loan duration values to avoid leaking into calculations
        const loanDurationValue = document.getElementById('loan-duration-value');
        const loanDurationUnit = document.getElementById('loan-duration-unit');
        loanDurationValue.value = '';
        loanDurationUnit.value = 'months';

        // Ensure default due date is set
        const dueDateInput = document.getElementById('due-date');
        if (!dueDateInput.value) {
          const oneTimeDueOption = document.getElementById('one-time-due-option');
          oneTimeDueOption.value = '1month';
          updateOneTimeDueOption();
        } else {
          updateOneTimeEstimate();
        }
      }
    }

    // Update first payment date based on selected option
    function updateMoneySentOption() {
      const option = document.getElementById('money-sent-option').value;
      const customDateField = document.getElementById('custom-money-sent-date');
      const moneySentDateInput = document.getElementById('money-sent-date');

      // Store the option for later use
      wizardData.moneySentOption = option;

      if (option === 'custom') {
        customDateField.classList.remove('hidden');
      } else {
        customDateField.classList.add('hidden');

        // Calculate money sent date
        const today = new Date();
        let sentDate;

        if (option === 'on-acceptance') {
          // Store a special value, will be resolved later
          wizardData.moneySentDate = 'on-acceptance';
          return;
        } else if (option === 'today') {
          sentDate = new Date(today);
        } else if (option === 'tomorrow') {
          sentDate = new Date(today);
          sentDate.setDate(sentDate.getDate() + 1);
        } else if (option === '3days') {
          sentDate = new Date(today);
          sentDate.setDate(sentDate.getDate() + 3);
        } else if (option === '7days') {
          sentDate = new Date(today);
          sentDate.setDate(sentDate.getDate() + 7);
        }

        // Set the date input value
        moneySentDateInput.value = sentDate.toISOString().split('T')[0];
        wizardData.moneySentDate = moneySentDateInput.value;
      }
    }

    function updateOneTimeDueOption() {
      const option = document.getElementById('one-time-due-option').value;
      const customDateField = document.getElementById('custom-one-time-due-date');
      const dueDateInput = document.getElementById('due-date');

      if (option === 'custom') {
        customDateField.classList.remove('hidden');
      } else {
        customDateField.classList.add('hidden');

        // Calculate due date
        const today = new Date();
        let dueDate;

        if (option === '1month') {
          dueDate = new Date(today);
          dueDate.setMonth(dueDate.getMonth() + 1);
        } else if (option === '2months') {
          dueDate = new Date(today);
          dueDate.setMonth(dueDate.getMonth() + 2);
        } else if (option === '3months') {
          dueDate = new Date(today);
          dueDate.setMonth(dueDate.getMonth() + 3);
        }

        // Set the date input value
        dueDateInput.value = dueDate.toISOString().split('T')[0];
      }
      // Always update the estimate when the option changes
      updateOneTimeEstimate();
    }

    function updateOneTimeEstimate() {
      const dueDate = document.getElementById('due-date').value;
      const amount = document.getElementById('amount').value;

      if (!dueDate || !amount) {
        document.getElementById('one-time-estimate').textContent = '';
        return;
      }

      const cleanAmount = amount.replace(/[.,]/g, '');
      const amountNum = parseFloat(cleanAmount);

      if (isNaN(amountNum) || amountNum <= 0) {
        document.getElementById('one-time-estimate').textContent = '';
        return;
      }

      const date = new Date(dueDate);
      const dateFormatted = date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
      const amountFormatted = new Intl.NumberFormat('de-DE').format(Math.round(amountNum));

      document.getElementById('one-time-estimate').textContent =
        `1 payment of about €${amountFormatted} on ${dateFormatted}, excluding interest.`;
    }

    // Unified function to update estimate based on repayment type
    function updateEstimate() {
      const repaymentType = document.querySelector('input[name="repayment-type"]:checked').value;

      if (repaymentType === 'installments') {
        // For installments, recalculate the installment summary
        calculateInstallments();
      } else {
        // For one-time payment, update the one-time estimate
        updateOneTimeEstimate();
      }
    }

    // Helper function to add months while keeping day-of-month (or last valid day)
    function addMonthsKeepingDay(date, months) {
      const result = new Date(date);
      const targetDay = result.getDate();

      // Add the months
      result.setMonth(result.getMonth() + months);

      // If the day changed (e.g., Jan 31 + 1 month = Mar 3), set to last day of target month
      if (result.getDate() !== targetDay) {
        result.setDate(0); // Go to last day of previous month
      }

      return result;
    }

    // Helper function to get interval text from loan duration and number of repayments
    function getIntervalText(loanDurationValue, loanDurationUnit, numRepayments) {
      // Convert to days
      let totalDays;
      switch (loanDurationUnit) {
        case 'days': totalDays = loanDurationValue; break;
        case 'weeks': totalDays = loanDurationValue * 7; break;
        case 'months': totalDays = loanDurationValue * 30; break;
        case 'years': totalDays = loanDurationValue * 365; break;
      }

      const intervalDays = totalDays / numRepayments;

      // Format based on interval size
      if (intervalDays < 14) {
        const days = Math.round(intervalDays);
        return days === 1 ? 'daily' : `every ${days} days`;
      } else if (intervalDays < 60) {
        const weeks = Math.round(intervalDays / 7);
        return weeks === 1 ? 'weekly' : `every ${weeks} weeks`;
      } else if (intervalDays < 730) {
        const months = Math.round(intervalDays / 30);
        if (months === 1) return 'monthly';
        if (months === 2) return 'bi-monthly';
        if (months === 3) return 'quarterly';
        if (months === 6) return 'semi-annually';
        return `every ${months} months`;
      } else {
        const years = Math.round(intervalDays / 365);
        return years === 1 ? 'annually' : `every ${years} years`;
      }
    }

    // Helper function to format payment frequency for summary text
    function getFrequencyTextForSummary(loanDurationValue, loanDurationUnit, numRepayments) {
      // Convert to days
      let totalDays;
      switch (loanDurationUnit) {
        case 'days': totalDays = loanDurationValue; break;
        case 'weeks': totalDays = loanDurationValue * 7; break;
        case 'months': totalDays = loanDurationValue * 30; break;
        case 'years': totalDays = loanDurationValue * 365; break;
      }

      const intervalDays = totalDays / numRepayments;

      // Format based on interval size for summary context
      if (intervalDays < 14) {
        const days = Math.round(intervalDays);
        return days === 1 ? 'every day' : `every ${days} days`;
      } else if (intervalDays < 60) {
        const weeks = Math.round(intervalDays / 7);
        return weeks === 1 ? 'every week' : `every ${weeks} weeks`;
      } else if (intervalDays < 730) {
        const months = Math.round(intervalDays / 30);
        if (months === 1) return 'every month';
        if (months === 2) return 'every 2 months';
        if (months === 3) return 'every 3 months';
        if (months === 6) return 'every 6 months';
        if (months === 12) return 'once a year';
        return `every ${months} months`;
      } else {
        const years = Math.round(intervalDays / 365);
        return years === 1 ? 'once a year' : `every ${years} years`;
      }
    }


    function updateFirstPaymentOption() {
      const option = document.getElementById('first-payment-option').value;
      const customDateField = document.getElementById('custom-first-payment-date');
      const firstPaymentDateInput = document.getElementById('first-payment-date');

      if (option === 'custom') {
        customDateField.classList.remove('hidden');
      } else {
        customDateField.classList.add('hidden');

        // Calculate first payment date
        const today = new Date();
        let firstDate;

        if (option === 'today') {
          firstDate = new Date(today);
        } else if (option === 'tomorrow') {
          firstDate = new Date(today);
          firstDate.setDate(firstDate.getDate() + 1);
        } else if (option === '3days') {
          firstDate = new Date(today);
          firstDate.setDate(firstDate.getDate() + 3);
        } else if (option === '7days') {
          firstDate = new Date(today);
          firstDate.setDate(firstDate.getDate() + 7);
        } else if (option === '1month') {
          firstDate = addMonthsKeepingDay(today, 1);
        } else if (option === '2months') {
          firstDate = addMonthsKeepingDay(today, 2);
        } else if (option === '3months') {
          firstDate = addMonthsKeepingDay(today, 3);
        } else if (option === '6months') {
          firstDate = addMonthsKeepingDay(today, 6);
        } else if (option === '12months') {
          firstDate = addMonthsKeepingDay(today, 12);
        }

        // Set the date input value
        firstPaymentDateInput.value = firstDate.toISOString().split('T')[0];
        calculateInstallments();
      }
    }

    // Calculate installment details using loan duration and repayments
    function calculateInstallments() {
      const amount = document.getElementById('amount').value;
      const loanDurationValue = parseInt(document.getElementById('loan-duration-value').value);
      const loanDurationUnit = document.getElementById('loan-duration-unit').value;
      const numRepaymentsInput = document.getElementById('num-repayments');
      const firstPaymentDate = document.getElementById('first-payment-date').value;
      const errorElement = document.getElementById('num-repayments-error');
      const planLengthSummary = document.getElementById('plan-length-summary');
      const installmentEstimate = document.getElementById('installment-estimate');
      const intervalDisplay = document.getElementById('repayment-interval-display');

      // Clear error
      errorElement.classList.add('hidden');

      // Get number of repayments
      const numRepayments = parseInt(numRepaymentsInput.value);

      // Validate input
      if (!numRepaymentsInput.value || isNaN(numRepayments) || numRepayments < 2 || numRepayments > 120) {
        errorElement.textContent = 'Please enter a number of payments between 2 and 120.';
        errorElement.classList.remove('hidden');
        planLengthSummary.textContent = '';
        installmentEstimate.textContent = '';
        intervalDisplay.textContent = '';
        return;
      }

      if (!loanDurationValue || !loanDurationUnit || !amount || !numRepayments || !firstPaymentDate) {
        planLengthSummary.textContent = '';
        installmentEstimate.textContent = '';
        intervalDisplay.textContent = '';
        return;
      }

      // Parse amount
      const cleanAmount = amount.replace(/[.,]/g, '');
      const amountNum = parseFloat(cleanAmount);

      if (isNaN(amountNum) || amountNum <= 0) {
        planLengthSummary.textContent = '';
        installmentEstimate.textContent = '';
        return;
      }

      // Convert loan duration to days
      let totalDays;
      switch (loanDurationUnit) {
        case 'days':
          totalDays = loanDurationValue;
          break;
        case 'weeks':
          totalDays = loanDurationValue * 7;
          break;
        case 'months':
          totalDays = loanDurationValue * 30;
          break;
        case 'years':
          totalDays = loanDurationValue * 365;
          break;
      }

      // Calculate interval for display (total duration / number of repayments)
      const intervalDays = totalDays / numRepayments;

      // Format interval for display with appropriate units
      let intervalText;
      if (intervalDays < 14) {
        const days = Math.round(intervalDays);
        intervalText = `Every ${days} ${days === 1 ? 'day' : 'days'}`;
      } else if (intervalDays < 60) {
        const weeks = Math.round(intervalDays / 7);
        intervalText = `Every ${weeks} ${weeks === 1 ? 'week' : 'weeks'}`;
      } else if (intervalDays < 730) {
        const months = Math.round(intervalDays / 30);
        intervalText = `Every ${months} ${months === 1 ? 'month' : 'months'}`;
      } else {
        const years = Math.round(intervalDays / 365);
        intervalText = `Every ${years} ${years === 1 ? 'year' : 'years'}`;
      }
      intervalDisplay.textContent = intervalText;

      // Calculate final end date from first payment + loan duration
      const firstDate = new Date(firstPaymentDate);
      let finalDate = new Date(firstDate);

      switch (loanDurationUnit) {
        case 'days':
          finalDate.setDate(finalDate.getDate() + loanDurationValue);
          break;
        case 'weeks':
          finalDate.setDate(finalDate.getDate() + (loanDurationValue * 7));
          break;
        case 'months':
          finalDate = addMonthsKeepingDay(firstDate, loanDurationValue);
          break;
        case 'years':
          finalDate = addMonthsKeepingDay(firstDate, loanDurationValue * 12);
          break;
      }

      // Generate installment schedule - evenly spread dates from first to final
      const installmentSchedule = [];
      const totalDurationMs = finalDate - firstDate;

      for (let i = 0; i < numRepayments; i++) {
        let paymentDate;
        if (i === 0) {
          paymentDate = new Date(firstDate);
        } else if (i === numRepayments - 1) {
          paymentDate = new Date(finalDate);
        } else {
          // Evenly space intermediate payments
          const progressRatio = i / (numRepayments - 1);
          paymentDate = new Date(firstDate.getTime() + (totalDurationMs * progressRatio));
        }
        installmentSchedule.push(paymentDate.toISOString().split('T')[0]);
      }

      // Calculate installment amount
      const installmentAmount = (amountNum / numRepayments).toFixed(2);

      // Format dates
      const firstFormatted = firstDate.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
      const finalFormatted = finalDate.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });

      // Format duration for display
      let durationText;
      if (loanDurationUnit === 'days') {
        durationText = `${loanDurationValue} ${loanDurationValue === 1 ? 'day' : 'days'}`;
      } else if (loanDurationUnit === 'weeks') {
        durationText = `${loanDurationValue} ${loanDurationValue === 1 ? 'week' : 'weeks'}`;
      } else if (loanDurationUnit === 'months') {
        durationText = `${loanDurationValue} ${loanDurationValue === 1 ? 'month' : 'months'}`;
      } else {
        durationText = `${loanDurationValue} ${loanDurationValue === 1 ? 'year' : 'years'}`;
      }

      // Store in wizard data
      wizardData.loanDurationValue = loanDurationValue;
      wizardData.loanDurationUnit = loanDurationUnit;
      wizardData.numRepayments = numRepayments;
      wizardData.planLength = loanDurationValue;
      wizardData.planUnit = loanDurationUnit;
      wizardData.installmentCount = numRepayments;
      wizardData.installmentAmount = parseFloat(installmentAmount);
      wizardData.firstPaymentDate = firstPaymentDate;
      wizardData.finalDueDate = installmentSchedule[installmentSchedule.length - 1];
      wizardData.installmentSchedule = installmentSchedule;

      // Display summary
      const installmentFormatted = new Intl.NumberFormat('de-DE').format(Math.round(installmentAmount));
      const frequencyText = getFrequencyTextForSummary(loanDurationValue, loanDurationUnit, numRepayments);

      // Loan duration summary
      planLengthSummary.textContent = `Plan length: ${durationText} (from ${firstFormatted} to ${finalFormatted}).`;

      // Payment summary with frequency
      installmentEstimate.textContent = `${numRepayments} payment${numRepayments === 1 ? '' : 's'} of about €${installmentFormatted} each, ${frequencyText}, excluding interest.`;
    }

    // Update due date helper text
    function updateDueDateHelper() {
      updateOneTimeEstimate();
    }

    // Validate step 2 (Terms)
    function validateStep2() {
      const amountInput = document.getElementById('amount');
      const repaymentType = document.querySelector('input[name="repayment-type"]:checked').value;
      const status = document.getElementById('step2-status');

      // Validate amount field with enhanced UX
      if (!validateAmountField()) {
        amountInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        amountInput.focus();
        return false;
      }

      const amount = amountInput.value;
      const cleanAmount = amount.replace(/[.,]/g, '');
      const amountNum = parseFloat(cleanAmount);

      // Validate money sent date
      const moneySentOption = document.getElementById('money-sent-option').value;
      let moneySentDate;

      if (moneySentOption === 'custom') {
        moneySentDate = document.getElementById('money-sent-date').value;
        if (!moneySentDate) {
          status.textContent = 'Please select when money was/will be sent to borrower';
          return false;
        }
      } else if (moneySentOption === 'on-acceptance') {
        moneySentDate = 'on-acceptance'; // Special value
      } else {
        // For other options, the date should already be set by updateMoneySentOption
        moneySentDate = document.getElementById('money-sent-date').value;
      }

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      if (repaymentType === 'one_time') {
        const dueDate = document.getElementById('due-date').value;
        if (!dueDate) {
          status.textContent = 'Please select a due date';
          return false;
        }

        wizardData.dueDate = dueDate;
        wizardData.finalDueDate = dueDate;
        wizardData.installmentCount = 1;
      } else {
        // Validate installment fields
        const loanDurationValue = parseInt(document.getElementById('loan-duration-value').value);
        const loanDurationUnit = document.getElementById('loan-duration-unit').value;
        const numRepaymentsInput = document.getElementById('num-repayments');
        const firstPaymentDate = document.getElementById('first-payment-date').value;

        // Validate loan duration
        if (!loanDurationValue || loanDurationValue <= 0) {
          status.textContent = 'Please enter a valid loan duration';
          return false;
        }

        // Validate number of payments
        const numRepayments = parseInt(numRepaymentsInput.value);
        if (!numRepaymentsInput.value || isNaN(numRepayments) || numRepayments < 2 || numRepayments > 120) {
          status.textContent = 'Please enter a valid number of payments (2-120)';
          return false;
        }

        // Validate first payment date
        if (!firstPaymentDate) {
          status.textContent = 'Please select a first payment date';
          return false;
        }

        // Validate maximum plan length (50 years in any unit)
        let planLengthInMonths;
        if (loanDurationUnit === 'days') {
          planLengthInMonths = loanDurationValue / 30;
        } else if (loanDurationUnit === 'weeks') {
          planLengthInMonths = loanDurationValue / 4.33;
        } else if (loanDurationUnit === 'months') {
          planLengthInMonths = loanDurationValue;
        } else if (loanDurationUnit === 'years') {
          planLengthInMonths = loanDurationValue * 12;
        }

        if (planLengthInMonths > 600) {
          status.textContent = 'Please choose a shorter plan. Maximum allowed length is 50 years';
          return false;
        }

        // For installments, set due_date to finalDueDate for database compatibility
        wizardData.dueDate = wizardData.finalDueDate;
      }

      // Store validated data
      wizardData.amount = amountNum;
      wizardData.moneySentDate = moneySentDate;

      status.textContent = '';
      return true;
    }

    // Navigate to interest step
    function goToInterest() {
      if (!validateStep2()) return;

      // Calculate recommended interest rate based on duration and fair range
      const amount = wizardData.amount;
      let durationInMonths;

      if (wizardData.repaymentType === 'installments') {
        // Convert plan duration to months
        const planLength = wizardData.planLength;
        const planUnit = wizardData.planUnit;

        if (planUnit === 'months') {
          durationInMonths = planLength;
        } else if (planUnit === 'years') {
          durationInMonths = planLength * 12;
        } else if (planUnit === 'weeks') {
          durationInMonths = planLength / 4.33; // approximate weeks to months
        } else if (planUnit === 'days') {
          durationInMonths = planLength / 30; // approximate days to months
        }
      } else {
        durationInMonths = Math.ceil((new Date(wizardData.dueDate) - new Date()) / (1000 * 60 * 60 * 24 * 30));
      }

      // Recommend rate based on fair range midpoint
      let recommendedRate;
      if (durationInMonths <= 3) {
        recommendedRate = 4;
      } else if (durationInMonths <= 12) {
        recommendedRate = 5;
      } else if (durationInMonths <= 24) {
        recommendedRate = 7;
      } else {
        recommendedRate = 8;
      }

      // Set the interest rate and trigger calculation
      document.getElementById('interest-rate').value = recommendedRate;
      wizardData.hasInterest = true;

      // Ensure no-interest checkbox is unchecked
      document.getElementById('no-interest-checkbox').checked = false;

      goToStep(3);
      calculateInterest();
    }

    // Toggle no interest checkbox
    function toggleNoInterest() {
      const checkbox = document.getElementById('no-interest-checkbox');
      const interestRateInput = document.getElementById('interest-rate');

      if (checkbox.checked) {
        // Disable interest rate input
        interestRateInput.disabled = true;
        interestRateInput.style.opacity = '0.5';
        interestRateInput.value = '0';
        wizardData.hasInterest = false;
        wizardData.interestRate = 0;
        wizardData.totalInterest = 0;
        wizardData.totalRepayAmount = wizardData.amount;

        // Hide badge
        document.getElementById('interest-rate-badge').style.display = 'none';

        // Update summary
        calculateInterest();
      } else {
        // Enable interest rate input
        interestRateInput.disabled = false;
        interestRateInput.style.opacity = '1';
        interestRateInput.value = '6';
        wizardData.hasInterest = true;

        // Show badge
        document.getElementById('interest-rate-badge').style.display = 'inline-block';

        // Recalculate
        calculateInterest();
      }
    }

    // Toggle breakdown visibility
    function toggleBreakdown() {
      const breakdown = document.getElementById('interest-breakdown');
      const toggleText = document.getElementById('breakdown-toggle-text');

      if (breakdown.classList.contains('hidden')) {
        breakdown.classList.remove('hidden');
        toggleText.textContent = 'Hide payment breakdown';
      } else {
        breakdown.classList.add('hidden');
        toggleText.textContent = 'Show payment breakdown';
      }
    }

    // Calculate interest using fair amortization (equal principal payments)
    function calculateInterest() {
      const interestRate = parseFloat(document.getElementById('interest-rate').value) || 0;
      const principal = wizardData.amount;

      if (!principal || principal <= 0) {
        return;
      }

      // Calculate duration in months for fair range and period rate
      let durationInMonths;
      let periodsPerYear = 12;
      let durationLabel = '';

      if (wizardData.repaymentType === 'installments') {
        const planLength = wizardData.planLength;
        const planUnit = wizardData.planUnit;

        if (planUnit === 'months') {
          durationInMonths = planLength;
          periodsPerYear = 12;
          durationLabel = `${planLength} month${planLength > 1 ? 's' : ''}`;
        } else if (planUnit === 'years') {
          durationInMonths = planLength * 12;
          periodsPerYear = 12;
          durationLabel = `${planLength} year${planLength > 1 ? 's' : ''}`;
        } else if (planUnit === 'weeks') {
          durationInMonths = planLength / 4.33;
          periodsPerYear = 52;
          durationLabel = `${planLength} week${planLength > 1 ? 's' : ''}`;
        } else if (planUnit === 'days') {
          durationInMonths = planLength / 30;
          periodsPerYear = 365;
          durationLabel = `${planLength} day${planLength > 1 ? 's' : ''}`;
        }
      } else {
        durationInMonths = Math.ceil((new Date(wizardData.dueDate) - new Date()) / (1000 * 60 * 60 * 24 * 30));
        periodsPerYear = 12;
        durationLabel = 'One-time payment';
      }

      // Calculate fair range based on duration
      let fairRangeMin, fairRangeMax;
      if (durationInMonths <= 3) {
        fairRangeMin = 3;
        fairRangeMax = 5;
      } else if (durationInMonths <= 12) {
        fairRangeMin = 4;
        fairRangeMax = 7;
      } else if (durationInMonths <= 24) {
        fairRangeMin = 5;
        fairRangeMax = 9;
      } else {
        fairRangeMin = 6;
        fairRangeMax = 10;
      }

      // Update badge and helper text based on rate
      const badge = document.getElementById('interest-rate-badge');
      const helper = document.getElementById('interest-rate-helper');

      if (document.getElementById('no-interest-checkbox').checked || interestRate === 0) {
        badge.style.display = 'none';
        helper.textContent = '';
      } else {
        badge.style.display = 'inline-block';
        if (interestRate >= fairRangeMin && interestRate <= fairRangeMax) {
          badge.textContent = `🟢 Fair range (${fairRangeMin}–${fairRangeMax}%)`;
          badge.style.background = 'rgba(61,220,151,0.15)';
          badge.style.color = 'var(--accent)';
          helper.textContent = `For this amount and term, a rate of ${fairRangeMin}–${fairRangeMax}% per year is considered fair.`;
        } else if (interestRate > fairRangeMax) {
          badge.textContent = `🟠 Above typical (>${fairRangeMax}%)`;
          badge.style.background = 'rgba(249,115,22,0.15)';
          badge.style.color = '#f97316';
          helper.textContent = `For this amount and term, a rate of ${fairRangeMin}–${fairRangeMax}% per year is considered fair.`;
        } else {
          badge.textContent = `🔵 Generous (<${fairRangeMin}%)`;
          badge.style.background = 'rgba(59,130,246,0.15)';
          badge.style.color = '#3b82f6';
          helper.textContent = `For this amount and term, a rate of ${fairRangeMin}–${fairRangeMax}% per year is considered fair.`;
        }
      }

      // Fair interest calculation using equal principal payments with daily interest
      const n = wizardData.repaymentType === 'installments' ? wizardData.installmentCount : 1;
      const annualRate = interestRate / 100;
      const dailyRate = annualRate / 365; // Use 365 days per year for daily rate
      const principalPerInstallment = principal / n;

      let totalInterest = 0;
      const schedule = [];

      // Determine start date (money sent date or first payment date for calculations)
      let startDate;
      if (wizardData.moneySentDate && wizardData.moneySentDate !== 'on-acceptance') {
        startDate = new Date(wizardData.moneySentDate);
      } else {
        // Fallback to today if money sent date is not set
        startDate = new Date();
        startDate.setHours(0, 0, 0, 0);
      }

      // Get payment dates from schedule
      let paymentDates = [];
      if (wizardData.repaymentType === 'installments' && wizardData.installmentSchedule) {
        paymentDates = wizardData.installmentSchedule.map(dateStr => new Date(dateStr));
      } else if (wizardData.repaymentType === 'one_time' && wizardData.dueDate) {
        paymentDates = [new Date(wizardData.dueDate)];
      }

      let previousDate = startDate;

      for (let i = 1; i <= n; i++) {
        const outstandingBefore = principal - principalPerInstallment * (i - 1);

        // Calculate interest based on actual days
        let interestForPeriod;
        if (paymentDates.length >= i) {
          const currentPaymentDate = paymentDates[i - 1];
          const daysBetween = Math.round((currentPaymentDate - previousDate) / (1000 * 60 * 60 * 24));
          interestForPeriod = outstandingBefore * dailyRate * daysBetween;
          previousDate = currentPaymentDate;
        } else {
          // Fallback to period rate if dates not available (shouldn't happen with new system)
          const periodRate = annualRate / periodsPerYear;
          interestForPeriod = outstandingBefore * periodRate;
        }

        const payment = principalPerInstallment + interestForPeriod;
        const remainingAfter = outstandingBefore - principalPerInstallment;

        totalInterest += interestForPeriod;

        schedule.push({
          period: i,
          payment: payment,
          principal: principalPerInstallment,
          interest: interestForPeriod,
          remaining: remainingAfter > 0.01 ? remainingAfter : 0,
          dueDate: paymentDates[i - 1] || null
        });
      }

      const totalRepayAmount = principal + totalInterest;

      wizardData.interestRate = interestRate;
      wizardData.totalInterest = totalInterest;
      wizardData.totalRepayAmount = totalRepayAmount;

      // Update summary card
      document.getElementById('summary-loan-amount').textContent = new Intl.NumberFormat('de-DE').format(Math.round(principal));
      document.getElementById('summary-duration').textContent = durationLabel;
      document.getElementById('summary-interest-rate').textContent = interestRate;
      document.getElementById('total-interest-display').textContent = new Intl.NumberFormat('de-DE').format(Math.round(totalInterest));
      document.getElementById('total-repay-display').textContent = new Intl.NumberFormat('de-DE').format(Math.round(totalRepayAmount));

      // Generate breakdown table
      const tbody = document.getElementById('breakdown-tbody');
      tbody.innerHTML = '';

      for (let i = 0; i < schedule.length; i++) {
        const row = schedule[i];

        // Use the date from the schedule
        let dateStr = '—';
        if (row.dueDate) {
          dateStr = row.dueDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        const tr = document.createElement('tr');
        tr.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
        tr.innerHTML = `
          <td style="padding:8px 4px">${row.period}</td>
          <td style="padding:8px 4px">${dateStr}</td>
          <td style="text-align:right; padding:8px 4px">€${new Intl.NumberFormat('de-DE').format(Math.round(row.payment))}</td>
          <td style="text-align:right; padding:8px 4px">€${new Intl.NumberFormat('de-DE').format(Math.round(row.principal))}</td>
          <td style="text-align:right; padding:8px 4px">€${new Intl.NumberFormat('de-DE').format(Math.round(row.interest))}</td>
          <td style="text-align:right; padding:8px 4px">€${new Intl.NumberFormat('de-DE').format(Math.round(row.remaining))}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    // Navigate to payment preferences
    function goToPayments() {
      // Update interest data if no interest selected
      if (!wizardData.hasInterest || document.getElementById('no-interest-checkbox').checked) {
        wizardData.interestRate = 0;
        wizardData.totalInterest = 0;
        wizardData.totalRepayAmount = wizardData.amount;
      }

      goToStep(4);
    }

    // Navigate to summary
    function goToSummary() {
      // Get selected payment methods
      const selectedMethods = Array.from(document.querySelectorAll('.payment-method-checkbox:checked')).map(cb => cb.value);

      // Validate at least one payment method is selected
      if (selectedMethods.length === 0) {
        document.getElementById('step4-status').textContent = 'Please select at least one payment method';
        return;
      }

      wizardData.paymentMethods = selectedMethods;

      // Get payment other description if "other" is selected
      if (selectedMethods.includes('other')) {
        wizardData.paymentOtherDescription = document.getElementById('other-payment-description').value.trim();
      }

      // Get reminder settings
      const reminderMode = document.querySelector('input[name="reminder-mode"]:checked').value;
      wizardData.reminderMode = reminderMode;

      if (reminderMode === 'auto') {
        wizardData.reminderOffsets = [-7, -1, 0, 1, 3];
      } else {
        // Get selected custom reminder offsets
        const checkboxes = document.querySelectorAll('.custom-reminder-checkbox:checked');
        if (checkboxes.length === 0) {
          document.getElementById('custom-reminder-error').style.display = 'block';
          document.getElementById('step4-status').textContent = 'Please select at least one reminder';
          return;
        }
        wizardData.reminderOffsets = Array.from(checkboxes).map(cb => parseInt(cb.value));
      }

      wizardData.proofRequired = document.getElementById('proof-required').checked;
      wizardData.debtCollectionClause = document.getElementById('debt-collection-clause').checked;

      goToStep(5);
      updateSummary();
    }

    // Toggle expandable sections in summary
    function toggleSection(sectionId) {
      const section = document.getElementById(sectionId);
      const toggleId = sectionId.replace('-section', '-toggle');
      const toggle = document.getElementById(toggleId);

      if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        toggle.textContent = '▲';
      } else {
        section.classList.add('hidden');
        toggle.textContent = '▼';
      }
    }

    // Toggle other payment method description field
    function toggleOtherPaymentMethod() {
      const otherCheckbox = document.querySelector('.payment-method-checkbox[value="other"]');
      const otherField = document.getElementById('other-payment-method');

      if (otherCheckbox && otherCheckbox.checked) {
        otherField.classList.remove('hidden');
      } else {
        otherField.classList.add('hidden');
        document.getElementById('other-payment-description').value = '';
      }
    }

    // Toggle reminder mode (auto vs custom)
    function toggleReminderMode() {
      const mode = document.querySelector('input[name="reminder-mode"]:checked').value;
      const customReminders = document.getElementById('custom-reminders');
      const autoCard = document.getElementById('reminder-auto-card');
      const customCard = document.getElementById('reminder-custom-card');

      if (mode === 'custom') {
        customReminders.classList.remove('hidden');
        autoCard.classList.remove('reminder-option-active');
        customCard.classList.add('reminder-option-active');
      } else {
        customReminders.classList.add('hidden');
        autoCard.classList.add('reminder-option-active');
        customCard.classList.remove('reminder-option-active');
        // Hide error if switching away from custom
        document.getElementById('custom-reminder-error').style.display = 'none';
      }
    }

    // Update summary in step 5
    function updateSummary() {
      const lenderName = currentUser?.full_name || currentUser?.email || 'You';
      const borrowerName = wizardData.friendFirstName;
      const amountCents = Math.round(wizardData.amount * 100);
      const amountFormatted = formatAmount(amountCents);
      const description = wizardData.description;
      const interestRate = wizardData.interestRate;
      const totalRepayAmount = Math.round(wizardData.totalRepayAmount * 100);
      const totalRepayFormatted = formatAmount(totalRepayAmount);

      // Full summary text (3 lines)
      let summaryLine1 = `${lenderName} lends €${amountFormatted} to ${borrowerName} for '${description}'.`;

      let summaryLine2 = '';
      if (wizardData.repaymentType === 'one_time') {
        const dueDate = new Date(wizardData.dueDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        summaryLine2 = `To be repaid in one payment by ${dueDate}.`;
      } else {
        const firstDate = new Date(wizardData.firstPaymentDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        const finalDate = new Date(wizardData.finalDueDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        const intervalText = getIntervalText(wizardData.loanDurationValue, wizardData.loanDurationUnit, wizardData.installmentCount);
        summaryLine2 = `To be repaid in ${wizardData.installmentCount} ${intervalText} payments, from ${firstDate} to ${finalDate}.`;
      }

      let summaryLine3 = '';
      if (interestRate > 0) {
        summaryLine3 = `Total to repay: €${totalRepayFormatted} (including ${interestRate}% interest per year).`;
      } else {
        summaryLine3 = `Total to repay: €${amountFormatted} (interest-free loan).`;
      }

      const summaryText = summaryLine1 + '\n' + summaryLine2 + '\n' + summaryLine3;

      document.getElementById('full-summary-text').textContent = summaryText;
      document.getElementById('send-friend-name').textContent = borrowerName;

      // Populate all sections
      populateGeneralDetails();
      populateInterestCalculation();
      populatePaymentsAndReminders();
    }

    // Populate general details section
    function populateGeneralDetails() {
      const content = document.getElementById('general-details-content');
      const lenderName = currentUser?.full_name || currentUser?.email || 'You';

      let html = '<div style="display:flex; flex-direction:column; gap:12px">';

      html += `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.05)">
        <span style="color:var(--muted)">Description</span>
        <span style="font-weight:600">${wizardData.description}</span>
      </div>`;

      html += `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.05)">
        <span style="color:var(--muted)">Lender</span>
        <span style="font-weight:600">${lenderName}</span>
      </div>`;

      html += `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.05)">
        <span style="color:var(--muted)">Borrower</span>
        <span style="font-weight:600">${wizardData.friendFirstName}</span>
      </div>`;

      html += `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.05)">
        <span style="color:var(--muted)">Borrower email</span>
        <span style="font-weight:600">${wizardData.friendEmail}</span>
      </div>`;

      html += `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.05)">
        <span style="color:var(--muted)">Amount</span>
        <span style="font-weight:600">€${formatAmount(Math.round(wizardData.amount * 100))}</span>
      </div>`;

      let moneySentDateFormatted;
      if (wizardData.moneySentDate === 'on-acceptance') {
        moneySentDateFormatted = 'Upon agreement acceptance';
      } else if (wizardData.moneySentOption) {
        // Show friendly text for relative dates
        const option = wizardData.moneySentOption;
        if (option === 'today') moneySentDateFormatted = 'Today';
        else if (option === 'tomorrow') moneySentDateFormatted = 'Tomorrow';
        else if (option === '3days') moneySentDateFormatted = 'In 3 days';
        else if (option === '7days') moneySentDateFormatted = 'In 7 days';
        else moneySentDateFormatted = new Date(wizardData.moneySentDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
      } else {
        moneySentDateFormatted = new Date(wizardData.moneySentDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
      }
      html += `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.05)">
        <span style="color:var(--muted)">Money transfer date</span>
        <span style="font-weight:600">${moneySentDateFormatted}</span>
      </div>`;

      html += `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.05)">
        <span style="color:var(--muted)">Repayment type</span>
        <span style="font-weight:600">${wizardData.repaymentType === 'one_time' ? 'One-time payment' : 'Installments'}</span>
      </div>`;

      if (wizardData.repaymentType === 'installments') {
        const intervalText = getIntervalText(wizardData.loanDurationValue, wizardData.loanDurationUnit, wizardData.numRepayments || wizardData.installmentCount);

        const durationText = wizardData.planUnit === 'days' ? `${wizardData.planLength} ${wizardData.planLength === 1 ? 'day' : 'days'}` :
                             wizardData.planUnit === 'weeks' ? `${wizardData.planLength} ${wizardData.planLength === 1 ? 'week' : 'weeks'}` :
                             wizardData.planUnit === 'months' ? `${wizardData.planLength} ${wizardData.planLength === 1 ? 'month' : 'months'}` :
                             wizardData.planUnit === 'years' ? `${wizardData.planLength} ${wizardData.planLength === 1 ? 'year' : 'years'}` :
                             `${wizardData.planLength} months`;

        html += `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.05)">
          <span style="color:var(--muted)">Loan duration</span>
          <span style="font-weight:600">${durationText}</span>
        </div>`;

        html += `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.05)">
          <span style="color:var(--muted)">Number of repayments</span>
          <span style="font-weight:600">${wizardData.numRepayments || wizardData.installmentCount}</span>
        </div>`;

        html += `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.05)">
          <span style="color:var(--muted)">Repayment interval</span>
          <span style="font-weight:600">${intervalText}</span>
        </div>`;

        const firstDate = new Date(wizardData.firstPaymentDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        html += `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.05)">
          <span style="color:var(--muted)">First payment date</span>
          <span style="font-weight:600">${firstDate}</span>
        </div>`;

        const finalDate = new Date(wizardData.finalDueDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        html += `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.05)">
          <span style="color:var(--muted)">Final due date</span>
          <span style="font-weight:600">${finalDate}</span>
        </div>`;
      } else {
        const dueDate = new Date(wizardData.dueDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        html += `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.05)">
          <span style="color:var(--muted)">Due date</span>
          <span style="font-weight:600">${dueDate}</span>
        </div>`;
      }

      html += '</div>';
      content.innerHTML = html;
    }

    // Populate interest calculation section
    function populateInterestCalculation() {
      const content = document.getElementById('interest-calc-content');

      if (wizardData.interestRate === 0 || !wizardData.hasInterest) {
        content.innerHTML = `<p style="margin:0; font-size:14px">This is an interest-free loan. Borrower repays only the loan amount.</p>`;
      } else {
        const totalInterest = formatAmount(Math.round(wizardData.totalInterest * 100));
        const totalRepay = formatAmount(Math.round(wizardData.totalRepayAmount * 100));
        const termText = wizardData.repaymentType === 'installments'
          ? `${wizardData.installmentCount} repayments`
          : 'one payment';

        let html = `<p style="margin:0 0 12px 0; font-size:14px">At ${wizardData.interestRate}% interest per year over ${termText}, total interest is about €${totalInterest} and total to repay is €${totalRepay}.</p>`;

        // Build unified breakdown table with dates
        const breakdownTbody = document.getElementById('breakdown-tbody');
        const rows = breakdownTbody?.getElementsByTagName('tr') || [];

        if (rows.length > 0) {
          html += `<div id="summary-payment-breakdown" style="margin:16px 0; max-height:300px; overflow-y:auto">`;
          html += `<table style="width:100%; font-size:12px">`;
          html += `<thead><tr style="border-bottom:1px solid rgba(255,255,255,0.08)">`;
          html += `<th style="text-align:left; padding:6px 4px; font-size:12px">№</th>`;
          html += `<th style="text-align:left; padding:6px 4px; font-size:12px">Date</th>`;
          html += `<th style="text-align:right; padding:6px 4px; font-size:12px">Payment</th>`;
          html += `<th style="text-align:right; padding:6px 4px; font-size:12px">Loan repayment</th>`;
          html += `<th style="text-align:right; padding:6px 4px; font-size:12px">Interest</th>`;
          html += `<th style="text-align:right; padding:6px 4px; font-size:12px">Remaining</th>`;
          html += `</tr></thead><tbody>`;

          const rowCount = wizardData.repaymentType === 'installments' ? wizardData.installmentCount : 1;
          for (let i = 0; i < rowCount; i++) {
            let dateStr = '—';
            if (wizardData.repaymentType === 'one_time' && wizardData.dueDate) {
              const dueDate = new Date(wizardData.dueDate);
              dateStr = dueDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
            } else if (wizardData.repaymentType === 'installments' && wizardData.firstPaymentDate) {
              const firstDate = new Date(wizardData.firstPaymentDate);
              const planUnit = wizardData.planUnit || 'months';
              const installmentDate = new Date(firstDate);
              if (planUnit === 'months') {
                installmentDate.setMonth(installmentDate.getMonth() + i);
              } else if (planUnit === 'weeks') {
                installmentDate.setDate(installmentDate.getDate() + (i * 7));
              } else if (planUnit === 'days') {
                installmentDate.setDate(installmentDate.getDate() + i);
              } else if (planUnit === 'years') {
                installmentDate.setFullYear(installmentDate.getFullYear() + i);
              }
              dateStr = installmentDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
            }

            // Get corresponding values from the breakdown table
            let numVal = '', paymentVal = '', interestVal = '', principalVal = '', remainingVal = '';
            if (rows[i]) {
              const cells = rows[i].getElementsByTagName('td');
              if (cells.length >= 6) {
                numVal = cells[0].textContent;
                // cells[1] is Date, which we calculate separately
                paymentVal = cells[2].textContent;
                principalVal = cells[3].textContent;
                interestVal = cells[4].textContent;
                remainingVal = cells[5].textContent;
              }
            }

            html += `<tr style="border-bottom:1px solid rgba(255,255,255,0.05)">`;
            html += `<td style="padding:8px 4px">${numVal}</td>`;
            html += `<td style="padding:8px 4px">${dateStr}</td>`;
            html += `<td style="text-align:right; padding:8px 4px">${paymentVal}</td>`;
            html += `<td style="text-align:right; padding:8px 4px">${principalVal}</td>`;
            html += `<td style="text-align:right; padding:8px 4px">${interestVal}</td>`;
            html += `<td style="text-align:right; padding:8px 4px">${remainingVal}</td>`;
            html += `</tr>`;
          }

          html += `</tbody></table></div>`;
        }

        content.innerHTML = html;
      }
    }

    // Toggle payment breakdown in summary
    function togglePaymentBreakdownInSummary() {
      const breakdown = document.getElementById('summary-payment-breakdown');
      const toggleText = document.getElementById('summary-breakdown-toggle-text');

      if (breakdown && breakdown.classList.contains('hidden')) {
        breakdown.classList.remove('hidden');
        if (toggleText) toggleText.textContent = 'Hide payment breakdown';
      } else if (breakdown) {
        breakdown.classList.add('hidden');
        if (toggleText) toggleText.textContent = 'Show payment breakdown';
      }
    }

    // Populate payments and reminders section
    function populatePaymentsAndReminders() {
      const content = document.getElementById('payments-reminders-content');

      let html = '<div style="display:flex; flex-direction:column; gap:16px">';

      // Payment methods
      const methods = wizardData.paymentMethods || [];
      const methodsText = methods.length > 0 ? methods.join(', ') : 'Not specified';
      html += `<div>
        <div style="font-weight:600; margin-bottom:6px; font-size:14px">Preferred payment methods:</div>
        <div style="color:var(--muted); font-size:14px">${methodsText}</div>
      </div>`;

      // Proof required
      html += `<div>
        <div style="font-weight:600; margin-bottom:6px; font-size:14px">Require proof of repayment:</div>
        <div style="color:var(--muted); font-size:13px; line-height:1.5">${wizardData.proofRequired ? 'Yes — The borrower will be asked to upload proof for each repayment, such as a photo, screenshot or PDF of the transfer or receipt.' : 'No — The borrower can report repayments without uploading proof.'}</div>
      </div>`;

      // Reminder mode
      html += `<div>
        <div style="font-weight:600; margin-bottom:6px; font-size:14px">Reminder mode:</div>
        <div style="color:var(--muted); font-size:14px">${wizardData.reminderMode === 'auto' ? 'Auto (recommended)' : 'Custom schedule'}</div>
      </div>`;

      // Reminder details
      if (wizardData.reminderMode === 'auto') {
        html += `<div>
          <div style="font-weight:600; margin-bottom:6px; font-size:14px">Reminder schedule:</div>
          <div style="color:var(--muted); font-size:14px; line-height:1.6">7 days before, 1 day before, on the due date. If unpaid: 1 day after, then every 3 days.</div>
        </div>`;
      } else if (wizardData.reminderOffsets && wizardData.reminderOffsets.length > 0) {
        const reminders = wizardData.reminderOffsets.sort((a, b) => a - b).map(offset => {
          if (offset < 0) return `${Math.abs(offset)} days before`;
          if (offset === 0) return 'On the due date';
          if (offset === 3) return 'Every 3 days after';
          if (offset === 7) return 'Every 7 days after';
          return `${offset} day${offset > 1 ? 's' : ''} after`;
        }).join(', ');

        html += `<div>
          <div style="font-weight:600; margin-bottom:6px; font-size:14px">Reminder schedule:</div>
          <div style="color:var(--muted); font-size:14px">${reminders}</div>
        </div>`;
      }

      // Worst case scenario (only show if enabled)
      if (wizardData.debtCollectionClause) {
        html += `<div>
          <div style="font-weight:600; margin-bottom:6px; font-size:14px">Worst case scenario:</div>
          <div style="color:var(--muted); font-size:13px; line-height:1.6">If the borrower does not repay in time and ignores reminders or cannot agree a new plan with the lender, PayFriends will hand the case to an independent debt collector. Once this happens, the lender is no longer involved in collection — the third party handles it, and any collection fees are for the borrower's account.</div>
        </div>`;
      }

      html += '</div>';
      content.innerHTML = html;
    }

    // Populate reminder plan section
    function populateReminderPlan() {
      const content = document.getElementById('reminder-plan-content');

      let html = `<p style="margin:0 0 8px 0; font-size:14px; font-weight:600">${wizardData.reminderMode === 'auto' ? 'Auto reminders' : 'Custom schedule'}:</p>`;

      if (wizardData.reminderMode === 'auto') {
        html += `<p style="margin:0; font-size:13px; color:var(--muted); line-height:1.6">Borrower receives reminders 7 days before, 1 day before, and on the due date. If still unpaid, follow-up reminders are sent 1 day after and every 3 days until payment or renegotiation.</p>`;
      } else {
        html += `<ul style="margin:0; padding-left:20px; font-size:13px; color:var(--muted)">`;
        wizardData.reminderOffsets.sort((a, b) => a - b).forEach(offset => {
          if (offset < 0) {
            html += `<li>${Math.abs(offset)} day${Math.abs(offset) > 1 ? 's' : ''} before due date</li>`;
          } else if (offset === 0) {
            html += `<li>On due date</li>`;
          } else {
            html += `<li>${offset} day${offset > 1 ? 's' : ''} after due date</li>`;
          }
        });
        html += `</ul>`;
      }

      content.innerHTML = html;
    }

    // Populate clauses section
    function populateClauses() {
      const content = document.getElementById('clauses-content');

      // Payment methods
      let methodsText = '';
      if (wizardData.paymentMethods && wizardData.paymentMethods.length > 0) {
        const methodLabels = wizardData.paymentMethods.map(m => {
          if (m === 'bank') return 'Bank transfer';
          if (m === 'cash') return 'Cash in person';
          if (m === 'crypto') return 'Crypto';
          if (m === 'any') return 'Any method';
          if (m === 'other') return `Other (${wizardData.paymentOtherDescription || 'not specified'})`;
          return m;
        });
        methodsText = methodLabels.join(', ');
      } else {
        methodsText = 'Not specified';
      }

      let html = `<div style="margin-bottom:12px">`;
      html += `<div style="font-weight:600; font-size:14px; margin-bottom:4px">Payment methods:</div>`;
      html += `<div style="color:var(--muted); font-size:13px">${methodsText}</div>`;
      html += `</div>`;

      html += `<div style="margin-bottom:16px">`;
      html += `<div style="font-weight:600; font-size:14px; margin-bottom:4px">Proof of payment:</div>`;
      html += `<div style="color:var(--muted); font-size:13px; line-height:1.5">${wizardData.proofRequired ? 'The borrower must upload proof of payment (photo, screenshot, scan or PDF) with every reported payment.' : 'Not required — borrower can report payments without uploading proof.'}</div>`;
      html += `</div>`;

      html += `<div>`;
      html += `<div style="font-weight:600; font-size:14px; margin-bottom:4px">Worst case scenario:</div>`;
      html += `<div style="color:var(--muted); font-size:13px; line-height:1.5">${wizardData.debtCollectionClause ? 'Enabled — If the borrower does not repay, does not propose a new plan, or cannot reach an agreement with the lender, both parties agree that the case may be handed over to an independent debt collector registered in accordance with local law. Any collection fees are for the borrower\'s account.' : 'Disabled — Debt collection clause not enabled.'}</div>`;
      html += `</div>`;

      content.innerHTML = html;
    }

    async function sendInvite() {
      const status = document.getElementById('step5-status');
      status.textContent = 'Creating agreement...';

      try {
        // Send all selected payment methods as comma-separated string
        const paymentMethodsStr = wizardData.paymentMethods && wizardData.paymentMethods.length > 0
          ? wizardData.paymentMethods.join(',')
          : 'bank';

        const payload = {
          friendFirstName: wizardData.friendFirstName,
          borrowerEmail: wizardData.friendEmail,
          phoneNumber: wizardData.phoneNumber,
          description: wizardData.description,
          amount: wizardData.amount,
          moneySentDate: wizardData.moneySentDate,
          dueDate: wizardData.dueDate,
          direction: wizardData.role,
          repaymentType: wizardData.repaymentType,
          interestRate: wizardData.interestRate,
          totalInterest: wizardData.totalInterest,
          totalRepayAmount: wizardData.totalRepayAmount,
          paymentPreferenceMethod: paymentMethodsStr,
          paymentOtherDescription: wizardData.paymentOtherDescription,
          reminderMode: wizardData.reminderMode,
          reminderOffsets: wizardData.reminderOffsets,
          proofRequired: wizardData.proofRequired,
          debtCollectionClause: wizardData.debtCollectionClause
        };

        // Add installment-specific fields if applicable
        if (wizardData.repaymentType === 'installments') {
          payload.planLength = wizardData.planLength;
          payload.planUnit = wizardData.planUnit;
          payload.installmentCount = wizardData.installmentCount;
          payload.installmentAmount = wizardData.installmentAmount;
          payload.firstPaymentDate = wizardData.firstPaymentDate;
          payload.finalDueDate = wizardData.finalDueDate;
        }

        const res = await fetch('/api/agreements', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed');

        wizardData.inviteUrl = data.inviteUrl;
        wizardData.agreementSent = true;

        // Navigate to Step 6 (Share)
        status.textContent = '';
        goToStep(6);
        populateShareStep();
        refresh();
        loadMessages();
      } catch (err) {
        status.textContent = '❌ ' + err.message;
      }
    }

    function copyInviteUrl() {
      const url = wizardData.inviteUrl;
      navigator.clipboard.writeText(url).then(() => {
        document.getElementById('step3-status').textContent = '✅ Copied to clipboard!';
        setTimeout(() => {
          document.getElementById('step3-status').textContent = '';
        }, 2000);
      }).catch(() => {
        document.getElementById('step3-status').textContent = '❌ Failed to copy';
      });
    }

    function populateShareStep() {
      const firstName = wizardData.friendFirstName;
      const email = wizardData.friendEmail;
      const inviteUrl = wizardData.inviteUrl;

      // Update step indicator to include borrower name
      document.getElementById('step-indicator-6').textContent = `6. Share with ${firstName}`;

      // Populate all name placeholders
      document.getElementById('share-heading-name').textContent = firstName;
      document.getElementById('share-invite-name').textContent = firstName;
      document.getElementById('share-invite-email').textContent = email;
      document.getElementById('share-qr-name').textContent = firstName;
      document.getElementById('share-signup-name').textContent = firstName;
      document.getElementById('share-signup-email').textContent = email;

      // Populate share link input
      document.getElementById('share-link-input').value = inviteUrl;

      // Generate QR code
      const qrContainer = document.getElementById('qr-code-container');
      qrContainer.innerHTML = ''; // Clear any existing QR code
      new QRCode(qrContainer, {
        text: inviteUrl,
        width: 200,
        height: 200,
        colorDark: '#000000',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.H
      });
    }

    function copyShareLink() {
      const url = wizardData.inviteUrl;
      const button = event.target;
      const originalText = button.textContent;

      navigator.clipboard.writeText(url).then(() => {
        button.textContent = '✓ Copied!';
        button.style.background = 'var(--accent)';
        setTimeout(() => {
          button.textContent = originalText;
          button.style.background = '';
        }, 2000);
      }).catch(() => {
        document.getElementById('step6-status').textContent = '❌ Failed to copy';
      });
    }

    function goToDashboard() {
      closeNewAgreement();
      refresh();
    }

    function createAnotherAgreement() {
      resetWizard();
      goToStep(1);
    }

    function resetWizard() {
      wizardData = {
        role: null,
        friendFirstName: '',
        friendEmail: '',
        description: '',
        amount: '',
        repaymentType: 'one_time',
        dueDate: '',
        moneySentDate: '',
        moneySentOption: 'on-acceptance',
        planLength: null,
        planUnit: 'months',
        firstPaymentDate: '',
        installmentCount: null,
        installmentAmount: null,
        finalDueDate: '',
        hasInterest: true,
        interestRate: 0,
        totalInterest: 0,
        totalRepayAmount: 0,
        paymentMethods: ['bank'],
        paymentOtherDescription: '',
        reminderMode: 'auto',
        reminderOffsets: [-7, -1, 0, 1, 3],
        proofRequired: true,
        debtCollectionClause: true,
        inviteUrl: '',
        agreementSent: false
      };

      // Reset Step 1 fields
      document.querySelectorAll('input[name="role"]').forEach(r => r.checked = false);
      document.getElementById('role-card-lend').style.borderColor = 'rgba(255,255,255,0.08)';
      document.getElementById('friend-first-name').value = '';
      document.getElementById('friend-email').value = '';
      document.getElementById('description').value = '';

      // Reset Step 2 fields
      document.getElementById('amount').value = '';
      document.querySelector('input[name="repayment-type"][value="one_time"]').checked = true;
      document.getElementById('due-date').value = '';
      document.getElementById('first-payment-date').value = '';
      document.getElementById('loan-duration-value').value = '12';
      document.getElementById('loan-duration-unit').value = 'months';
      document.getElementById('num-repayments').value = '12';
      document.getElementById('first-payment-option').value = '1month';

      // Reset Step 3 fields
      document.getElementById('interest-rate').value = '';
      document.getElementById('interest-rate').disabled = false;
      document.getElementById('interest-rate').style.opacity = '1';
      document.getElementById('no-interest-checkbox').checked = false;

      // Reset Step 4 fields
      document.querySelectorAll('.payment-method-checkbox').forEach(cb => {
        cb.checked = cb.value === 'bank';
      });
      document.getElementById('other-payment-description').value = '';
      document.querySelector('input[name="reminder-mode"][value="auto"]').checked = true;
      document.querySelectorAll('.custom-reminder-checkbox').forEach(cb => cb.checked = false);
      document.getElementById('proof-required').checked = true;
      document.getElementById('debt-collection-clause').checked = true;

      // Reset status messages
      document.getElementById('step1-status').textContent = '';
      document.getElementById('step2-status').textContent = '';
      document.getElementById('step3-status').textContent = '';
      document.getElementById('step4-status').textContent = '';
      document.getElementById('step5-status').textContent = '';

      // Reset invite section
      document.getElementById('invite-not-sent').classList.remove('hidden');
      document.getElementById('invite-sent').classList.add('hidden');

      // Reset field visibility
      toggleInstallmentFields();
      toggleReminderMode();

      goToStep(1);
      closeNewAgreement();
    }

    function toggleNewAgreement() {
      const section = document.getElementById('new-agreement-section');
      if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        document.getElementById('new-agreement-btn').style.display = 'none';
        // Scroll the wizard into view
        setTimeout(() => {
          section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
      } else {
        closeNewAgreement();
      }
    }

    function closeNewAgreement() {
      document.getElementById('new-agreement-section').classList.add('hidden');
      document.getElementById('new-agreement-btn').style.display = 'flex';
    }

    // Fetch current user (now handled by shared header, but we still need to set currentUser)
    async function loadUser() {
      try {
        // Get user from shared header (already loaded)
        currentUser = PayFriendsHeader.getCurrentUser();

        if (!currentUser) {
          window.location.href = '/';
          return;
        }
      } catch (err) {
        console.error('Error loading user:', err);
        window.location.href = '/';
      }
    }

    // Note: Logout is now handled by shared header.js

    // Toggle activity visibility
    function toggleActivity() {
      const activity = document.getElementById('activity-section');
      activity.style.display = activity.style.display === 'none' ? 'block' : 'none';
    }

    // Load activity
    async function loadMessages() {
      try {
        const res = await fetch('/api/messages');
        const data = await res.json();

        const messages = data.messages || [];
        const unreadCount = data.unread_count || 0;

        // Update header with unread count using shared header function
        if (window.PayFriendsHeader) {
          PayFriendsHeader.updateActivityButton(unreadCount);
        }

        const activityList = document.getElementById('activity-list');
        if (messages.length === 0) {
          activityList.innerHTML = '<p class="empty-state">No activity yet</p>';
        } else {
          activityList.innerHTML = messages.map(msg => {
            const timestamp = new Date(msg.created_at).toLocaleString();
            const relativeTime = timeAgo(msg.created_at);
            const isUnread = !msg.read_at;

            // Determine activity text based on event_type
            let activityText = msg.body; // Fallback to original body

            if (msg.event_type === 'AGREEMENT_SENT') {
              // For sent agreements, show pending status if still pending
              const borrowerName = msg.borrower_full_name || msg.friend_first_name || msg.borrower_email;
              if (msg.agreement_status === 'pending') {
                activityText = `Agreement sent to ${msg.borrower_email} (pending review by ${borrowerName})`;
              } else {
                activityText = `Agreement sent to ${msg.borrower_email}`;
              }
            } else if (msg.event_type === 'AGREEMENT_ACCEPTED') {
              const borrowerName = msg.borrower_full_name || msg.friend_first_name || msg.borrower_email;
              activityText = `Agreement accepted by ${borrowerName}`;
            } else if (msg.event_type === 'AGREEMENT_DECLINED') {
              const borrowerName = msg.borrower_full_name || msg.friend_first_name || msg.borrower_email;
              activityText = `Agreement declined by ${borrowerName}`;
            } else if (msg.event_type === 'AGREEMENT_ASSIGNED_TO_BORROWER') {
              // Use the body text as-is for this event
              activityText = msg.body;
            } else if (msg.event_type === 'AGREEMENT_REVIEW_LATER') {
              activityText = msg.body;
            } else if (msg.event_type === 'AGREEMENT_CANCELLED_LENDER') {
              activityText = msg.body;
            } else if (msg.event_type === 'AGREEMENT_CANCELLED_BORROWER') {
              activityText = msg.body;
            } else if (msg.event_type === 'HARDSHIP_REQUEST_LENDER') {
              // Payment difficulty - use borrower's name and add emphasis
              const borrowerName = msg.borrower_full_name || msg.friend_first_name || msg.borrower_email;
              activityText = `${borrowerName} reported a payment issue and requested a new plan`;
            }

            // Determine the link URL based on agreement_id and event_type
            let linkUrl = '';
            if (msg.agreement_id) {
              // For pending agreements where the current user is the borrower, go to review page
              if (msg.agreement_status === 'pending' && msg.borrower_user_id === currentUser.id) {
                linkUrl = `/agreements/${msg.agreement_id}/review`;
              } else {
                // Default to manage page for all other agreement-related events
                linkUrl = `/agreements/${msg.agreement_id}/manage`;
              }
            }

            const unreadClass = isUnread ? 'message-unread' : '';
            const clickableClass = linkUrl ? 'message-clickable' : '';
            const onclickAttr = linkUrl ? `onclick="handleActivityClick(${msg.id}, '${linkUrl}')"` : '';

            // Add warning icon for payment difficulty
            const isPaymentDifficulty = msg.event_type === 'HARDSHIP_REQUEST_LENDER';
            const warningIcon = isPaymentDifficulty ? '<span style="color:#f59e0b; font-weight:700; margin-right:8px" title="Payment issue requires attention">⚠</span>' : '';

            return `
              <div class="message-item ${unreadClass} ${clickableClass}" ${onclickAttr}>
                <div style="display:flex; justify-content:space-between; align-items:center">
                  <div class="message-date">${timestamp} (${relativeTime})</div>
                  ${isUnread ? '<span class="unread-indicator">●</span>' : ''}
                </div>
                <div style="margin-top:4px; ${isPaymentDifficulty ? 'font-weight:600; color:var(--text)' : ''}">${warningIcon}${activityText}</div>
              </div>
            `;
          }).join('');
        }
      } catch (err) {
        console.error('Error loading activity:', err);
      }
    }

    // Handle activity item click - mark as read and navigate
    async function handleActivityClick(messageId, url) {
      try {
        // Mark as read
        await fetch(`/api/activity/${messageId}/mark-read`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        // Navigate to the URL
        window.location.href = url;
      } catch (err) {
        console.error('Error marking message as read:', err);
        // Still navigate even if marking fails
        window.location.href = url;
      }
    }

    // Mark all messages as read
    async function markAllAsRead() {
      try {
        const res = await fetch('/api/activity/mark-all-read', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (res.ok) {
          // Reload messages to update UI
          await loadMessages();
        }
      } catch (err) {
        console.error('Error marking all as read:', err);
      }
    }

    // Navigate to review page for borrowers
    function reviewAgreement(id) {
      window.location.href = `/agreements/${id}/review`;
    }

    // Navigate to manage page for lenders and borrowers
    function viewAgreement(id) {
      window.location.href = `/agreements/${id}/manage`;
    }

    // Filter agreements by status
    function filterByStatus(status) {
      currentFilter = status;

      // Update active tab
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.getAttribute('data-filter') === status) {
          tab.classList.add('active');
        }
      });

      renderAgreements();
    }

    // Render agreements based on current filter
    function renderAgreements() {
      const tbody = document.querySelector('#list tbody');
      const emptyState = document.getElementById('empty-state');
      const counterpartyHeader = document.getElementById('counterparty-header');
      const listSection = document.getElementById('list-section');
      const welcomeCard = document.getElementById('welcome-card');

      // Show welcome card if user has zero agreements overall
      if (allAgreements.length === 0) {
        listSection.style.display = 'none';
        welcomeCard.style.display = 'block';
        return;
      }

      // Hide welcome card when there are agreements
      listSection.style.display = 'block';
      welcomeCard.style.display = 'none';

      let filtered = allAgreements;
      if (currentFilter !== 'all') {
        // For Pending tab, exclude cancelled agreements
        if (currentFilter === 'pending') {
          filtered = allAgreements.filter(a => a.status === 'pending');
        } else {
          filtered = allAgreements.filter(a => a.status === currentFilter);
        }
      }

      if (filtered.length === 0) {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
        document.getElementById('list').style.display = 'none';
        return;
      }

      emptyState.style.display = 'none';
      document.getElementById('list').style.display = 'table';
      tbody.innerHTML = '';

      // Determine header label based on user's role in agreements
      // Default to showing both, but if all agreements have user as same role, show specific header
      let userRoles = new Set();
      for (const a of filtered) {
        const isLender = a.lender_user_id === currentUser.id;
        userRoles.add(isLender ? 'lender' : 'borrower');
      }

      // Set headers based on predominant role
      const dueHeader = document.getElementById('due-header');
      if (userRoles.size === 1) {
        if (userRoles.has('lender')) {
          counterpartyHeader.textContent = 'Borrower';
          dueHeader.textContent = 'Next repayment due';
        } else {
          counterpartyHeader.textContent = 'Lender';
          dueHeader.textContent = 'Next payment due';
        }
      } else {
        // Mixed roles, keep generic headers
        counterpartyHeader.textContent = 'Counterparty';
        dueHeader.textContent = 'Due';
      }

      for (const a of filtered) {
        const tr = document.createElement('tr');
        tr.setAttribute('data-id', a.id);
        const amount = formatAmount(a.amount_cents);
        const statusText = a.status || 'pending';
        const capitalizedStatus = statusText.charAt(0).toUpperCase() + statusText.slice(1);

        // Build status column with colored dot indicator (no text)
        let tooltipText = capitalizedStatus;
        if (statusText === 'pending') {
          tooltipText = 'Pending';
        } else if (statusText === 'active') {
          tooltipText = 'Active';
        } else if (statusText === 'settled') {
          tooltipText = 'Settled';
        } else if (statusText === 'cancelled') {
          tooltipText = 'Cancelled';
        } else if (statusText === 'declined') {
          tooltipText = 'Declined';
        } else if (statusText === 'overdue') {
          tooltipText = 'Overdue';
        }
        let statusBadge = `<div class="status-dot-wrapper" data-tooltip="${tooltipText}"><span class="status-dot status-dot--${statusText}" role="img" aria-label="${tooltipText}"></span></div>`;

        // Determine role
        const isLender = a.lender_user_id === currentUser.id;

        // Generate avatar and counterparty display with name
        const counterpartyName = a.counterparty_name || '—';
        const avatarHTML = generateAvatarHTML({
          counterparty_name: counterpartyName,
          profile_picture_url: a.counterparty_profile_picture_url
        });
        const counterpartyDisplay = `<div class="counterparty-cell">${avatarHTML}<span>${counterpartyName}</span></div>`;

        // Get description or show fallback
        const description = a.description || '<span style="color:var(--muted); font-style:italic">(No description)</span>';

        // Calculate outstanding amount with original amount tooltip
        const outstandingCents = a.outstanding_cents || a.amount_cents;
        const outstanding = formatAmount(outstandingCents);
        const originalAmount = formatAmount(a.amount_cents);
        const outstandingDisplay = `<span title="Original: €${originalAmount}">€ ${outstanding} / € ${originalAmount}</span>`;

        // Format due date with countdown
        const dueDateDisplay = formatDueDate(a, isLender);

        // Build actions column with main button and conditional alert buttons
        let actionsHtml = '';
        if (statusText === 'cancelled') {
          // No actions for cancelled agreements
          actionsHtml = '—';
        } else if (statusText === 'pending' && !isLender) {
          // Borrower can review pending agreements
          actionsHtml = `<div class="actions-column">
            <button class="btn-review-pending" onclick="reviewAgreement(${a.id})">Review</button>
          </div>`;
        } else {
          // For lenders on any agreement, or borrowers on active/settled
          let mainBtnLabel = (statusText === 'pending' || statusText === 'active' || statusText === 'settled') ? 'Manage' : 'View';

          let buttons = `<button onclick="viewAgreement(${a.id})">${mainBtnLabel}</button>`;

          // Add conditional action buttons for lenders
          if (isLender) {
            if (a.hasPendingPaymentToConfirm) {
              buttons += `<button class="btn-confirm-payment" onclick="openConfirmPaymentModal(${a.id})">Confirm payment</button>`;
            }
            if (a.hasOpenDifficulty) {
              buttons += `<button class="btn-payment-issue" onclick="openDifficultyModal(${a.id})">Payment issue</button>`;
            }
          }

          actionsHtml = `<div class="actions-column">${buttons}</div>`;
        }

        tr.innerHTML = `
          <td>${counterpartyDisplay}</td>
          <td>${description}</td>
          <td>${outstandingDisplay}</td>
          <td>${dueDateDisplay}</td>
          <td>${statusBadge}</td>
          <td>${actionsHtml}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    // Refresh agreements
    async function refresh() {
      try {
        const res = await fetch('/api/agreements');
        allAgreements = await res.json();
        renderAgreements();
      } catch (err) {
        console.error('Error loading agreements:', err);
      }
    }

    // Modal functions
    function closeModalOnOverlay(event, modalId) {
      if (event.target.classList.contains('modal-overlay')) {
        document.getElementById(modalId).style.display = 'none';
      }
    }

    // Close modal on ESC key
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeConfirmPaymentModal();
        closeDifficultyModal();
      }
    });

    // Payment Confirmation Modal
    async function openConfirmPaymentModal(agreementId) {
      const modal = document.getElementById('confirm-payment-modal');
      const modalBody = document.getElementById('confirm-payment-modal-body');

      modal.style.display = 'flex';
      modalBody.innerHTML = '<p style="text-align:center; color:var(--muted)">Loading...</p>';

      try {
        // Fetch agreement details and payments
        const [agreementRes, paymentsRes] = await Promise.all([
          fetch(`/api/agreements/${agreementId}`),
          fetch(`/api/agreements/${agreementId}/payments`)
        ]);

        if (!agreementRes.ok || !paymentsRes.ok) {
          throw new Error('Failed to load payment details');
        }

        const agreement = await agreementRes.json();
        const payments = await paymentsRes.json();

        // Find the pending payment that needs confirmation
        const pendingPayment = payments.find(p => p.status === 'pending');

        if (!pendingPayment) {
          modalBody.innerHTML = '<p style="color:var(--muted)">No pending payment found.</p>';
          return;
        }

        // Build modal content
        const amount = formatAmount(pendingPayment.amount_cents);
        const borrowerName = pendingPayment.recorded_by_name || agreement.friend_first_name || agreement.borrower_email;

        let proofOfPaymentHtml = '';
        if (pendingPayment.proof_file_path) {
          proofOfPaymentHtml = `
            <div class="modal-info-row">
              <span class="modal-info-label">Proof of payment</span>
              <button class="secondary" onclick="viewProofOfPayment(${pendingPayment.id})" style="padding:6px 12px; font-size:13px">View proof</button>
            </div>
          `;
        }

        modalBody.innerHTML = `
          <div class="modal-info-row">
            <span class="modal-info-label">Amount</span>
            <span class="modal-info-value">€ ${amount}</span>
          </div>
          <div class="modal-info-row">
            <span class="modal-info-label">Method</span>
            <span class="modal-info-value">${pendingPayment.method || '—'}</span>
          </div>
          ${pendingPayment.note ? `<div class="modal-note"><strong>Note:</strong> ${pendingPayment.note}</div>` : ''}
          <div class="modal-info-row">
            <span class="modal-info-label">Reported by</span>
            <span class="modal-info-value">${borrowerName}</span>
          </div>
          ${proofOfPaymentHtml}
          <div class="modal-footer">
            <button onclick="declinePayment(${agreementId}, ${pendingPayment.id})" class="secondary">Decline</button>
            <button onclick="confirmPayment(${agreementId}, ${pendingPayment.id})">Confirm payment</button>
          </div>
          <p class="modal-helper-text" style="margin-top:12px; text-align:center">This will update the payment history and outstanding amount.</p>
        `;
      } catch (err) {
        console.error('Error loading payment details:', err);
        modalBody.innerHTML = '<p style="color:#ff6b6b">Failed to load payment details</p>';
      }
    }

    function closeConfirmPaymentModal() {
      document.getElementById('confirm-payment-modal').style.display = 'none';
    }

    async function confirmPayment(agreementId, paymentId) {
      try {
        const res = await fetch(`/api/payments/${paymentId}/approve`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || 'Failed to confirm payment');
        }

        closeConfirmPaymentModal();
        refresh();
        loadMessages();
      } catch (err) {
        console.error('Error confirming payment:', err);
        alert('Failed to confirm payment: ' + err.message);
      }
    }

    async function declinePayment(agreementId, paymentId) {
      try {
        const res = await fetch(`/api/payments/${paymentId}/decline`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || 'Failed to decline payment');
        }

        closeConfirmPaymentModal();
        refresh();
        loadMessages();
      } catch (err) {
        console.error('Error declining payment:', err);
        alert('Failed to decline payment: ' + err.message);
      }
    }

    function viewProofOfPayment(paymentId) {
      // Open proof of payment in new tab
      window.open(`/api/payments/${paymentId}/proof`, '_blank');
    }

    // Difficulty Modal
    async function openDifficultyModal(agreementId) {
      const modal = document.getElementById('difficulty-modal');
      const modalBody = document.getElementById('difficulty-modal-body');

      modal.style.display = 'flex';
      modalBody.innerHTML = '<p style="text-align:center; color:var(--muted)">Loading...</p>';

      try {
        const res = await fetch(`/api/agreements/${agreementId}/hardship-requests`);
        if (!res.ok) throw new Error('Failed to load difficulty details');

        const hardshipRequests = await res.json();

        // Find the most recent request (they're ordered by created_at DESC)
        const openDifficulty = hardshipRequests[0];

        if (!openDifficulty) {
          modalBody.innerHTML = '<p style="color:var(--muted)">No difficulty request found.</p>';
          return;
        }

        // Build preferred options list
        let preferredOptionsHtml = '';
        if (openDifficulty.preferred_adjustments) {
          const optionLabels = {
            'smaller_payments': 'Smaller monthly payments',
            'postpone': 'Postponement',
            'longer_term': 'Longer term',
            'partial_forgiveness': 'Partial forgiveness'
          };
          const optionsArray = openDifficulty.preferred_adjustments.split(',');
          const optionsList = optionsArray
            .map(opt => optionLabels[opt.trim()] || opt)
            .join('</li><li>');
          preferredOptionsHtml = `
            <div class="modal-info-row" style="flex-direction:column; align-items:flex-start">
              <span class="modal-info-label">Preferred options:</span>
              <ul style="margin:8px 0 0 20px; padding:0">
                <li>${optionsList}</li>
              </ul>
            </div>
          `;
        }

        // Format can_pay_now amount
        let canPayNowText = '€ 0 (Cannot pay anything now)';
        if (openDifficulty.can_pay_now_cents && openDifficulty.can_pay_now_cents > 0) {
          canPayNowText = `€ ${formatAmount(openDifficulty.can_pay_now_cents)}`;
        }

        modalBody.innerHTML = `
          <p class="modal-helper-text">Your friend has asked for help with this payment. Here's what they shared:</p>

          ${openDifficulty.reason_category ? `
            <div class="modal-info-row">
              <span class="modal-info-label">Reason</span>
              <span class="modal-info-value">${openDifficulty.reason_category}</span>
            </div>
          ` : ''}

          ${openDifficulty.reason_text ? `
            <div class="modal-note"><strong>Explanation:</strong><br>${openDifficulty.reason_text}</div>
          ` : ''}

          <div class="modal-info-row">
            <span class="modal-info-label">Can pay now</span>
            <span class="modal-info-value">${canPayNowText}</span>
          </div>

          ${preferredOptionsHtml}

          <div class="modal-footer">
            <button onclick="closeDifficultyModal()" class="secondary">Close</button>
            <button onclick="window.location.href='/agreements/${agreementId}/manage'">Open full agreement</button>
          </div>
        `;
      } catch (err) {
        console.error('Error loading difficulty details:', err);
        modalBody.innerHTML = '<p style="color:#ff6b6b">Failed to load difficulty details</p>';
      }
    }

    function closeDifficultyModal() {
      document.getElementById('difficulty-modal').style.display = 'none';
    }

    // Initialize with shared header
    // Initialize intl-tel-input for agreement phone
    let agreementPhoneInput;

    document.addEventListener('DOMContentLoaded', async () => {
      // Initialize shared header with custom activity button handler
      await PayFriendsHeader.initialize({
        hasActivitySection: true,
        onActivityClick: toggleActivity
      });

      // Phone input is auto-initialized by PhoneInputManager
      // Get reference to the instance
      agreementPhoneInput = window.PhoneInputManager.getInstance('agreement-phone');

      // Load user and other data
      loadUser();
      refresh();
      loadMessages();
      goToStep(1);
    });
  </script>
</body>
</html>
