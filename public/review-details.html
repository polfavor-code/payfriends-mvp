<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PayFriends — Agreement Details</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- Shared control styles -->
  <link rel="stylesheet" href="/css/shared-controls.css" />
  <!-- Shared header component -->
  <script src="/js/header.js"></script>
  <style>
    :root{
      --bg:#0e1116; --card:#151a21; --text:#e6eef6; --muted:#a7b0bd; --accent:#3ddc97;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif; background:var(--bg); color:var(--text);}
    .container{max-width:1200px; margin:0 auto; padding:32px 16px;}
    .card{background:var(--card); border:1px solid rgba(255,255,255,0.06); border-radius:16px; padding:24px; margin:16px 0}
    h1{margin:0 0 8px 0; font-size:24px}
    h2{margin:0 0 16px 0; font-size:20px}
    p{color:var(--muted); line-height:1.6; margin:8px 0}
    .detail-row{display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.08)}
    .detail-row:last-child{border-bottom:none}
    .detail-label{color:var(--muted); font-weight:500}
    .detail-value{color:var(--text); font-weight:600}
    button{padding:12px 20px; border-radius:10px; border:0; background:var(--accent); color:#0d130f; font-weight:700; cursor:pointer; font-size:14px; width:100%}
    button:hover{filter:brightness(1.06)}
    button.secondary{background:transparent; border:1px solid rgba(255,255,255,0.15); color:var(--text); margin-top:8px}
    button.secondary:hover{background:rgba(255,255,255,0.05)}
    button.tertiary{background:transparent; border:1px solid rgba(255,255,255,0.10); color:var(--muted); margin-top:8px}
    button.tertiary:hover{background:rgba(255,255,255,0.03)}
    button.btn-danger{background:#7a1a1a; border:1px solid #a83232; color:#fff; margin-top:8px}
    button.btn-danger:hover{background:#8a2020; border-color:#b84444}
    button.btn-danger:disabled{opacity:0.5; cursor:not-allowed}
    .status{color:var(--muted); margin-top:12px; min-height:1.2em; font-size:14px}
    .hidden{display:none}
    .error{color:#ff6b6b}
    .success{color:var(--accent)}
    .amount{font-size:32px; font-weight:700; color:var(--accent); text-align:center; margin:16px 0}
    .note{background:rgba(61,220,151,0.1); border:1px solid rgba(61,220,151,0.2); border-radius:8px; padding:12px; color:var(--text); font-size:14px; margin:16px 0}
    .status-badge{display:inline-block; padding:4px 10px; border-radius:6px; font-size:12px; font-weight:600}
    .status-badge.pending{background:#f97316; color:#fff}
    .status-badge.active{background:#22c55e; color:#0d130f}
    .status-badge.settled{background:#4a4a4a; color:#fff}
    .status-badge.declined{background:#ff6b6b; color:#fff}
    .status-badge.cancelled{background:#6c757d; color:#fff}
    .alert-box{background:rgba(255,165,0,0.1); border:1px solid rgba(255,165,0,0.3); border-radius:8px; padding:12px; color:var(--text); font-size:14px; margin:16px 0}
    .form-group{margin:20px 0}
    .form-label{display:block; color:var(--text); font-weight:600; margin-bottom:8px; font-size:14px}
    .form-radio{display:block; margin:8px 0; padding:10px; border:1px solid rgba(255,255,255,0.1); border-radius:8px; cursor:pointer; transition:background 0.2s}
    .form-radio:hover{background:rgba(255,255,255,0.03)}
    .form-radio input{margin-right:8px}
    .form-radio label{cursor:pointer; color:var(--text); font-size:14px}
    .form-checkbox{display:block; margin:8px 0; padding:10px; border:1px solid rgba(255,255,255,0.1); border-radius:8px; cursor:pointer; transition:background 0.2s}
    .form-checkbox:hover{background:rgba(255,255,255,0.03)}
    .form-checkbox input{margin-right:8px}
    .form-checkbox label{cursor:pointer; color:var(--text); font-size:14px}
    textarea{width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background:var(--bg); color:var(--text); font-family:inherit; font-size:14px; resize:vertical; min-height:80px}
    textarea:focus{outline:none; border-color:var(--accent); background:var(--bg)}
    textarea:hover{background:var(--bg)}
    textarea:-webkit-autofill,
    textarea:-webkit-autofill:hover,
    textarea:-webkit-autofill:focus,
    textarea:-webkit-autofill:active{
      -webkit-background-clip:text;
      -webkit-text-fill-color:var(--text);
      transition:background-color 5000s ease-in-out 0s;
      box-shadow:inset 0 0 20px 20px var(--bg);
    }
    textarea::placeholder{color:var(--muted)}
    input[type="number"]{width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background:var(--bg); color:var(--text); font-family:inherit; font-size:14px}
    input[type="number"]:focus{outline:none; border-color:var(--accent); background:var(--bg)}
    input[type="number"]:hover{background:var(--bg)}
    input[type="number"]:-webkit-autofill,
    input[type="number"]:-webkit-autofill:hover,
    input[type="number"]:-webkit-autofill:focus,
    input[type="number"]:-webkit-autofill:active{
      -webkit-background-clip:text;
      -webkit-text-fill-color:var(--text);
      transition:background-color 5000s ease-in-out 0s;
      box-shadow:inset 0 0 20px 20px var(--bg);
    }
    input[type="number"]::placeholder{color:var(--muted)}
    .summary-box{background:rgba(61,220,151,0.05); border:1px solid rgba(61,220,151,0.15); border-radius:12px; padding:20px; margin:20px 0}
    .summary-item{margin:8px 0; color:var(--text); font-size:14px}
    .summary-label{color:var(--muted); font-weight:600}
    button.warning{background:#ff9800; color:#0d130f}
    button.warning:hover{filter:brightness(1.1)}
    .payment-item{background:#10151d; border-radius:8px; padding:12px; margin:12px 0; border:1px solid rgba(255,255,255,0.08)}
    .payment-date{color:var(--muted); font-size:12px}
    .payment-amount{font-weight:700; color:var(--accent); font-size:16px}
    .payment-method{color:var(--muted); font-style:italic; font-size:14px}
    .payment-note{color:var(--text); margin-top:4px; font-size:14px}
    .payment-recorded-by{color:var(--muted); margin-top:4px; font-size:14px}
    .payment-meta-line{font-size:14px}
    .record-payment-btn{background:#3d7bdc; margin-top:16px}
    .record-payment-btn:hover{filter:brightness(1.1)}
    select{appearance:none; background-image:url('data:image/svg+xml;utf8,<svg fill="%23a7b0bd" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>'); background-repeat:no-repeat; background-position:right 8px center}
    .payment-status-badge{display:inline-block; padding:4px 10px; border-radius:6px; font-size:12px; font-weight:600; margin-left:8px}
    .payment-status-badge.approved{background:#3ddc97; color:#0d130f}
    .payment-status-badge.pending{background:#ff9800; color:#0d130f}
    .payment-status-badge.declined{background:#ff6b6b; color:#fff}
    .payment-approval-buttons{margin-top:8px; display:flex; gap:8px}
    .payment-approval-buttons button{width:auto; padding:8px 16px; font-size:13px}
    .secondary-status-badge{display:inline-block; padding:4px 10px; border-radius:6px; font-size:12px; font-weight:600; margin-left:8px}
    .secondary-status-badge.pending-confirmation{background:#f97316; color:#fff}
    .secondary-status-badge.pending-resolution{background:#dc2626; color:#fff}
    .hardship-button-spacing{margin-top:20px}
    .form-section{background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:20px; margin-bottom:24px}
    .form-section-title{font-size:16px; font-weight:600; color:var(--text); margin-bottom:12px}
    #proof-modal-download:hover{background:#3a3a3a; border-color:rgba(255,255,255,0.25)}
    .top-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid rgba(255,255,255,0.08)}
    .top-header-left{display:flex; align-items:center; gap:12px}
    .top-header-right{display:flex; gap:16px; align-items:center}
    .logo-coin{height:54px; width:auto}
    .top-header-text{display:flex; flex-direction:column; gap:2px}
    .app-name{font-size:24px; font-weight:600; line-height:1.2; margin:0}
    .user-meta{color:var(--muted); font-size:14px; line-height:1.2}
    .app-slogan{color:var(--muted); font-size:14px; line-height:1.2; margin-top:2px}
    .top-header-user-info{color:var(--text); font-size:14px; text-align:right}
    .top-header-actions{display:flex; gap:12px; align-items:center}
    .inbox-count{color:var(--accent);font-weight:700}
    .tabs{display:flex; gap:8px; margin-bottom:16px; border-bottom:1px solid rgba(255,255,255,0.08)}
    .tab{padding:10px 16px; cursor:pointer; color:var(--muted); border-bottom:2px solid transparent; margin-bottom:-1px}
    .tab.active{color:var(--accent); border-bottom-color:var(--accent)}
    .tab:hover{color:var(--text)}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:10px 12px; border-bottom:1px solid rgba(255,255,255,0.08); text-align:left; vertical-align:middle}
    th{color:var(--muted); font-weight:600; font-size:13px}
    .actions-column{display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:flex-end; width:100%}
    .actions-column button{flex:0 0 auto; padding:8px 12px; font-size:14px; white-space:nowrap; width:auto}
    .empty-state{text-align:center; color:var(--muted); padding:32px; font-size:14px}
    .user-avatar{display:inline-flex; align-items:center; justify-content:center; border-radius:50%; overflow:hidden; flex-shrink:0; vertical-align:middle}
    .user-avatar.size-small{width:22px; height:22px; font-size:10px; font-weight:600; margin-right:8px}
    .user-avatar.size-medium{width:48px; height:48px; font-size:18px; font-weight:600}
    .user-avatar.size-large{width:60px; height:60px; font-size:22px; font-weight:600; margin-right:16px}
    .user-avatar.size-xl{width:110px; height:110px; font-size:36px; font-weight:600; margin-right:20px}
    .user-avatar-image{width:100%; height:100%; object-fit:cover}
    .user-avatar-initials{width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:600; text-transform:uppercase}
    .user-avatar-initials.color-1{background:#6366f1}
    .user-avatar-initials.color-2{background:#8b5cf6}
    .user-avatar-initials.color-3{background:#ec4899}
    .user-avatar-initials.color-4{background:#f59e0b}
    .user-avatar-initials.color-5{background:#10b981}
    .user-avatar-initials.color-6{background:#3b82f6}
    .user-avatar-initials.color-7{background:#14b8a6}
    .counterparty-cell{display:flex; align-items:center}
    .due-date-overdue{color:#f87171}
    .due-date-upcoming{color:var(--muted)}
    .due-date-settled{color:#9ca3af}
    .status-indicator{width:22px;height:22px;border-radius:9999px;display:inline-flex;align-items:center;justify-content:center;margin:0 auto;cursor:help}
    .status-indicator--active{background:#22c55e}
    .status-indicator--pending{background:#facc15}
    .status-indicator--settled{background:#9ca3af}
    .status-indicator--overdue{background:#f87171}
    .status-indicator--cancelled{background:#9ca3af}
    .status-indicator--declined{background:#f87171}
    .status-dot{display:inline-block; width:22px; height:22px; border-radius:9999px; cursor:help; position:relative}
    .status-dot--active{background:#22c55e}
    .status-dot--pending{background:#facc15}
    .status-dot--settled{background:#9ca3af}
    .status-dot--overdue{background:#f87171}
    .status-dot--cancelled{background:#9ca3af}
    .status-dot--declined{background:#f87171}
    .status-dot-wrapper{display:inline-flex;align-items:center;justify-content:center;position:relative}
    .status-dot-wrapper::after{content:attr(data-tooltip);position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);background:#1f2937;color:#fff;padding:6px 12px;border-radius:6px;font-size:12px;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity 0.2s ease;border:1px solid rgba(255,255,255,0.1);z-index:1000}
    .status-dot-wrapper::before{content:'';position:absolute;bottom:calc(100% + 2px);left:50%;transform:translateX(-50%);border:4px solid transparent;border-top-color:#1f2937;opacity:0;pointer-events:none;transition:opacity 0.2s ease;z-index:1000}
    .status-dot-wrapper:hover::after,.status-dot-wrapper:hover::before{opacity:1}
  </style>
</head>
<body>
  <div class="container">
    <!-- Header will be loaded dynamically by header.js -->

    <!-- My Agreements section -->
    <section class="card" id="list-section">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
        <h2 style="margin:0">My Agreements</h2>
      </div>

      <div class="tabs">
        <div class="tab active" data-filter="all" onclick="filterByStatus('all')">All</div>
        <div class="tab" data-filter="pending" onclick="filterByStatus('pending')">Pending</div>
        <div class="tab" data-filter="active" onclick="filterByStatus('active')">Active</div>
        <div class="tab" data-filter="settled" onclick="filterByStatus('settled')">Settled</div>
      </div>

      <table id="list">
        <thead>
          <tr>
            <th id="counterparty-header">Borrower</th>
            <th>Description</th>
            <th>Outstanding / Total</th>
            <th id="due-header">Next repayment due</th>
            <th>Status</th>
            <th style="text-align:right">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="empty-state" class="empty-state" style="display:none">
        No agreements found for this filter.
      </div>
      <div style="display:flex; justify-content:flex-end; margin-top:16px">
        <button onclick="window.location.href='/app'" style="display:flex; align-items:center; gap:8px; padding:12px 20px; width:auto">
          <span style="font-size:18px; font-weight:bold">+</span>
          <span>New Agreement</span>
        </button>
      </div>
    </section>

    <div class="card hidden" id="loading-card">
      <h1 id="page-title">Agreement Details</h1>
      <p id="loading-text">Loading agreement details...</p>
    </div>

    <!-- Manage agreement header (for view mode) -->
    <div id="manage-header" class="hidden" style="margin:16px 0 24px 0">
      <h2 style="margin:0 0 8px 0; font-size:24px">Manage agreement</h2>
      <p id="manage-subline" style="margin:8px 0 0 0; font-size:16px; color:var(--muted)"></p>
    </div>

    <!-- Agreement summary block (above details card) -->
    <div id="summary-section" class="hidden" style="background:rgba(61,220,151,0.05); border:1px solid rgba(61,220,151,0.15); border-radius:12px; padding:20px; margin:20px 0; display:flex; align-items:center; gap:16px">
      <div id="summary-avatar" style="flex-shrink:0"></div>
      <div style="flex:1">
        <p id="agreement-summary-line1" style="margin:0 0 12px 0; font-size:15px; line-height:1.6; color:var(--accent)"></p>
        <p id="agreement-summary-line2" style="margin:0 0 12px 0; font-size:15px; line-height:1.6; color:var(--accent)"></p>
        <p id="agreement-summary-line3" style="margin:0; font-size:15px; line-height:1.6; color:var(--accent)"></p>
      </div>
    </div>

    <!-- Primary payment action button (for active agreements) - moved up -->
    <div id="payment-action-section" class="hidden" style="margin:16px 0">
      <button id="record-payment-btn" class="record-payment-btn" style="width:100%">Report Payment</button>
    </div>

    <!-- Secondary difficulty button (for borrowers on active agreements) - moved up -->
    <div id="hardship-button-section" class="hidden" style="margin:16px 0">
      <button class="warning" onclick="showHardshipForm()" style="width:100%">Having trouble paying? Let's work on a solution.</button>
    </div>

    <!-- Agreement details -->
    <div id="details-section" class="card hidden">
      <h2>Agreement Details</h2>

      <!-- Details section -->
      <div style="margin:16px 0">
        <div class="detail-row">
          <span class="detail-label">Lender</span>
          <span class="detail-value" id="lender-name"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Borrower</span>
          <span class="detail-value" id="borrower-name"></span>
        </div>
        <div class="detail-row" id="description-row">
          <span class="detail-label">Description</span>
          <span class="detail-value" id="description-display"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Amount</span>
          <span class="detail-value" id="amount-display"></span>
        </div>
        <div class="detail-row" id="money-sent-row" style="display:none">
          <span class="detail-label">Money transfer date</span>
          <span class="detail-value" id="money-sent-display"></span>
        </div>
        <div class="detail-row" id="repayment-type-row">
          <span class="detail-label">Payment type</span>
          <span class="detail-value" id="repayment-type-display"></span>
        </div>
        <div class="detail-row" id="installment-info-row" style="display:none">
          <span class="detail-label">Installment plan</span>
          <span class="detail-value" id="installment-info-display"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Due date</span>
          <span class="detail-value">
            <span id="due-date"></span>
            <span id="due-date-countdown" style="color:var(--muted); margin-left:8px"></span>
          </span>
        </div>
        <div class="detail-row" id="interest-row" style="display:none">
          <span class="detail-label">Interest</span>
          <span class="detail-value" id="interest-display"></span>
        </div>
        <div class="detail-row" id="total-repay-row" style="display:none">
          <span class="detail-label">Total to repay</span>
          <span class="detail-value" id="total-repay-display"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Status</span>
          <span class="detail-value" id="status-display"></span>
        </div>
      </div>

      <!-- Interest, payment calculation & installment schedule (collapsible) -->
      <div id="interest-calc-card" class="hidden" style="margin:16px 0">
        <button onclick="toggleReviewSection('interest-calc-detail')" class="secondary" style="width:100%; text-align:left; padding:12px 16px; font-size:14px; display:flex; justify-content:space-between; align-items:center">
          <span>Interest, payment calculation & installment schedule</span>
          <span id="interest-calc-detail-toggle">▼</span>
        </button>
        <div id="interest-calc-detail" class="hidden" style="background:#10151d; border:1px solid rgba(255,255,255,0.08); border-radius:0 0 8px 8px; padding:16px; margin-top:-1px">
          <div id="interest-calc-detail-content"></div>
        </div>
      </div>

      <!-- Payments & reminders (collapsible) -->
      <div id="payments-reminders-card" class="hidden" style="margin:16px 0">
        <button onclick="toggleReviewSection('payments-reminders-detail')" class="secondary" style="width:100%; text-align:left; padding:12px 16px; font-size:14px; display:flex; justify-content:space-between; align-items:center">
          <span>Payments & reminders</span>
          <span id="payments-reminders-detail-toggle">▼</span>
        </button>
        <div id="payments-reminders-detail" class="hidden" style="background:#10151d; border:1px solid rgba(255,255,255,0.08); border-radius:0 0 8px 8px; padding:16px; margin-top:-1px">
          <div id="payments-reminders-detail-content"></div>
        </div>
      </div>

      <!-- Share (collapsible, lender only, for pending agreements) -->
      <div id="share-card" class="hidden" style="margin:16px 0">
        <button onclick="toggleReviewSection('share-detail')" class="secondary" style="width:100%; text-align:left; padding:12px 16px; font-size:14px; display:flex; justify-content:space-between; align-items:center">
          <span>Share</span>
          <span id="share-detail-toggle">▼</span>
        </button>
        <div id="share-detail" class="hidden" style="background:#10151d; border:1px solid rgba(255,255,255,0.08); border-radius:0 0 8px 8px; padding:16px; margin-top:-1px">
          <div id="share-detail-content"></div>
        </div>
      </div>

      <!-- Borrower review actions (only for pending agreements) -->
      <div id="borrower-actions" class="hidden">
        <div class="note">
          By accepting this agreement, you confirm the terms and agree to repay the amount by the due date.
        </div>

        <button onclick="handleAccept()">Accept Agreement</button>
        <button class="secondary" onclick="handleDecline()">Decline</button>
        <button class="tertiary" onclick="handleReviewLater()">Review Later</button>
      </div>

      <!-- Lender actions (only for pending agreements) -->
      <div id="lender-actions" class="hidden">
        <button id="cancel-agreement-btn" class="btn-danger" onclick="openCancelModal()" style="width:100%">Cancel pending agreement</button>
      </div>

      <p class="status" id="action-status"></p>
    </div>

    <!-- Hardship indicator for lender (needs attention alert) -->
    <div id="hardship-indicator" class="card hidden">
      <div class="alert-box">
        <strong>Needs attention:</strong> Borrower has requested help with this payment. Check Activity for details.
      </div>
    </div>

    <!-- Payment summary (for active and settled agreements) -->
    <div id="payment-summary" class="card hidden">
      <h2>Payment Summary</h2>
      <div style="margin:16px 0">
        <div class="detail-row">
          <span class="detail-label">Original amount</span>
          <span class="detail-value" id="original-amount"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Total paid</span>
          <span class="detail-value" id="total-paid"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Outstanding</span>
          <span class="detail-value" id="outstanding-amount"></span>
        </div>
      </div>
    </div>

    <!-- Payment history (for active and settled agreements) -->
    <div id="payment-history" class="card hidden">
      <h2>Payment History</h2>
      <div id="payments-list">
        <p style="color:var(--muted); font-size:14px">No payments recorded yet.</p>
      </div>
    </div>

    <!-- Record payment form (for active agreements) -->
    <div id="record-payment-section" class="card hidden">
      <h2 id="payment-form-header">Record a Payment</h2>
      <p id="payment-form-subtitle" style="color:var(--muted); font-size:14px; margin-bottom:16px">
        Record a payment that has been made for this agreement.
      </p>

      <div class="form-group">
        <label class="form-label" for="payment-amount-field">Amount (EUR)</label>
        <input type="number" id="payment-amount-field" placeholder="e.g. 50" min="0" step="0.01">
      </div>

      <div class="form-group">
        <label class="form-label" for="payment-method">Payment method</label>
        <select id="payment-method" required style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background:var(--bg); color:var(--text); font-family:inherit; font-size:14px">
          <option value="">Select method...</option>
          <option value="cash">Cash</option>
          <option value="bank">Bank transfer</option>
          <option value="crypto">Crypto</option>
          <option value="other">Other</option>
        </select>
      </div>

      <div id="payment-proof-section" class="form-group" style="display:none">
        <label class="form-label" id="payment-proof-label" for="payment-proof">Proof of repayment</label>
        <p id="payment-proof-helper" style="color:var(--muted); font-size:12px; margin-bottom:8px">
          Upload a screenshot, photo or PDF that shows this repayment.
        </p>
        <input type="file" id="payment-proof" accept="image/*,.pdf" style="width:100%; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background:var(--bg); color:var(--text); font-family:inherit; font-size:14px">
      </div>

      <div class="form-group">
        <label class="form-label" for="payment-note">Note (optional)</label>
        <textarea id="payment-note" placeholder="Add any details about this payment..."></textarea>
      </div>

      <button id="payment-submit-btn" onclick="submitPayment()">Record Payment</button>
      <button class="secondary" onclick="cancelPaymentForm()">Cancel</button>

      <p class="status" id="payment-status"></p>
    </div>

    <!-- Hardship request form -->
    <div id="hardship-form" class="card hidden">
      <h2>Request Payment Assistance</h2>
      <p style="color:var(--muted); margin-bottom:20px">
        Let us know what's making this payment difficult. We'll share your situation with your friend to work out a new plan together.
      </p>

      <!-- Step 1: Reason -->
      <div class="form-section">
        <div class="form-section-title">What's making it hard to pay on time?</div>

        <div class="form-radio">
          <input type="radio" name="reason" id="reason-unexpected" value="unexpected_expense">
          <label for="reason-unexpected">Unexpected expense (medical, car, etc.)</label>
        </div>

        <div class="form-radio">
          <input type="radio" name="reason" id="reason-income" value="income_lower">
          <label for="reason-income">Income temporarily lower</label>
        </div>

        <div class="form-radio">
          <input type="radio" name="reason" id="reason-job" value="job_loss">
          <label for="reason-job">Lost my job / work changed</label>
        </div>

        <div class="form-radio">
          <input type="radio" name="reason" id="reason-miscalc" value="miscalculated">
          <label for="reason-miscalc">I miscalculated what I could afford</label>
        </div>

        <div class="form-radio">
          <input type="radio" name="reason" id="reason-other" value="other">
          <label for="reason-other">Something else</label>
        </div>
      </div>

      <div class="form-section">
        <div class="form-section-title">Explain in your own words (optional but recommended)</div>
        <textarea id="reason-text" placeholder="Tell your friend more about your situation..."></textarea>
      </div>

      <!-- Step 2: Can pay now -->
      <div class="form-section">
        <div class="form-section-title">Can you pay something now?</div>
        <p style="color:var(--muted); font-size:14px; margin-top:4px; margin-bottom:12px">
          Even a small payment will show your commitment to <span id="lender-first-name-text"></span>.
        </p>

        <div class="form-radio">
          <input type="radio" name="can-pay" id="can-pay-yes" value="yes" onchange="togglePaymentAmount()">
          <label for="can-pay-yes">Yes, I can pay some of it now</label>
        </div>

        <div class="form-radio">
          <input type="radio" name="can-pay" id="can-pay-no" value="no" onchange="togglePaymentAmount()">
          <label for="can-pay-no">No, I can't pay anything right now</label>
        </div>

        <div id="payment-amount-input" class="hidden" style="margin-top:16px">
          <label class="form-label" for="payment-amount">Amount I can pay now (EUR)</label>
          <input type="number" id="payment-amount" placeholder="e.g. 50" min="0" step="1">
        </div>
      </div>

      <!-- Step 3: Preferred adjustments -->
      <div class="form-section">
        <div class="form-section-title">What kind of new plan would feel most realistic for you? (Check all that apply)</div>

        <div class="form-checkbox">
          <input type="checkbox" id="adj-smaller" value="smaller_payments_longer_period">
          <label for="adj-smaller">Pay a smaller amount each month over a longer period</label>
        </div>

        <div class="form-checkbox">
          <input type="checkbox" id="adj-skip" value="skip_or_reduce_next">
          <label for="adj-skip">Skip or reduce this upcoming payment, and increase the later payments to catch up.</label>
        </div>

        <div class="form-checkbox">
          <input type="checkbox" id="adj-partial" value="partial_now_rest_later">
          <label for="adj-partial">Pay part now and move the rest to a later date</label>
        </div>

        <div class="form-checkbox">
          <input type="checkbox" id="adj-lower" value="lower_monthly_higher_interest">
          <label for="adj-lower">Lower the monthly amount, even if the total interest becomes higher and the loan runs longer.</label>
        </div>

        <div class="form-checkbox">
          <input type="checkbox" id="adj-unsure" value="not_sure_please_suggest">
          <label for="adj-unsure">I'm not sure – please suggest something for us</label>
        </div>
      </div>

      <!-- Step 4: Summary -->
      <div class="form-group">
        <label class="form-label">Summary</label>
        <div class="summary-box">
          <p style="margin:0 0 12px 0; color:var(--text)">This is what will be shared with your friend:</p>
          <div class="summary-item">
            <span class="summary-label">Reason:</span> <span id="summary-reason">-</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Can pay now:</span> <span id="summary-pay">-</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Preferred options:</span> <span id="summary-adjustments">-</span>
          </div>
        </div>
      </div>

      <button onclick="submitHardshipRequest()">Send request</button>
      <button class="secondary" onclick="cancelHardshipForm()">Cancel</button>

      <p class="status" id="hardship-status"></p>
    </div>

    <!-- Error state -->
    <div id="error-section" class="card hidden">
      <h2>Error</h2>
      <p id="error-message">Unable to load agreement details.</p>
      <a href="/app" style="display:inline-block; margin-top:16px; padding:10px 20px; background:var(--accent); color:#0d130f; border-radius:10px; text-decoration:none; font-weight:600">Go to Dashboard</a>
    </div>
  </div>

  <script>
    let agreement = null;
    let currentUser = null;
    let mode = 'view'; // 'review' or 'view'

    // Initialize shared header
    document.addEventListener('DOMContentLoaded', async () => {
      await PayFriendsHeader.initialize();
      initializePage();
    });
    const pathParts = window.location.pathname.split('/');
    const agreementId = pathParts[2];
    const action = pathParts[3]; // 'review' or 'view'

    // For agreements list
    let allAgreements = [];
    let currentFilter = 'all';

    // Format amount in cents to euros with thousand separators, no decimals
    function formatAmount(cents) {
      const euros = Math.round(cents / 100);
      return new Intl.NumberFormat('de-DE').format(euros);
    }

    // Format currency with 2 decimals for schedule tables
    function formatCurrency2(amount) {
      return new Intl.NumberFormat('nl-NL', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount);
    }

    // Generate initials for user avatar
    function getInitials(name) {
      if (!name) return '?';
      const parts = name.trim().split(/\s+/);
      if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
      return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
    }

    // Get avatar color based on name
    function getAvatarColor(name) {
      if (!name) return 'color-1';
      const hash = name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
      return `color-${(hash % 7) + 1}`;
    }

    async function loadAgreementData() {
      try {
        // Get current user from shared header
        currentUser = PayFriendsHeader.getCurrentUser();

        if (!currentUser) {
          window.location.href = '/';
          return;
        }

        // Fetch agreement
        const res = await fetch(`/api/agreements/${agreementId}`);
        if (!res.ok) {
          showError('Agreement not found or you do not have access to it.');
          return;
        }
        agreement = await res.json();

        // Determine mode based on URL and user role
        const isLender = agreement.lender_user_id === currentUser.id;
        const isBorrower = agreement.borrower_user_id === currentUser.id;

        if (action === 'review' && isBorrower && agreement.status === 'pending') {
          mode = 'review';
          showReviewSection();
        } else {
          mode = 'view';
          showViewSection();
        }
      } catch (err) {
        console.error('Error loading agreement:', err);
        showError('An error occurred while loading the agreement.');
      }
    }

    function showReviewSection() {
      document.getElementById('loading-card').classList.add('hidden');
      document.getElementById('details-section').classList.remove('hidden');

      populateDetails();

      // Explicitly hide all payment-related sections for review page
      document.getElementById('payment-action-section').classList.add('hidden');
      document.getElementById('hardship-button-section').classList.add('hidden');
      document.getElementById('hardship-indicator').classList.add('hidden');
      document.getElementById('payment-summary').classList.add('hidden');
      document.getElementById('payment-history').classList.add('hidden');
      document.getElementById('record-payment-section').classList.add('hidden');
      document.getElementById('hardship-form').classList.add('hidden');
      document.getElementById('error-section').classList.add('hidden');

      // Check if agreement is cancelled
      if (agreement.status === 'cancelled') {
        // Show cancelled message, hide all action buttons
        document.getElementById('borrower-actions').classList.add('hidden');
        document.getElementById('lender-actions').classList.add('hidden');
      } else {
        // Show borrower actions
        document.getElementById('borrower-actions').classList.remove('hidden');
        document.getElementById('lender-actions').classList.add('hidden');
      }
    }

    async function showViewSection() {
      document.getElementById('loading-card').classList.add('hidden');
      document.getElementById('details-section').classList.remove('hidden');

      // Show and populate manage header
      const borrowerName = agreement.borrower_full_name || agreement.friend_first_name || agreement.borrower_email;
      const description = agreement.description || 'Agreement';
      document.getElementById('manage-subline').textContent = `${description} – ${borrowerName}`;
      document.getElementById('manage-header').classList.remove('hidden');

      populateDetails();

      // Hide borrower actions
      document.getElementById('borrower-actions').classList.add('hidden');

      const isLender = agreement.lender_user_id === currentUser.id;
      const isBorrower = agreement.borrower_user_id === currentUser.id;

      // Check if this is a lender viewing a pending agreement
      if (isLender && agreement.status === 'pending') {
        // Show lender actions (cancel button)
        document.getElementById('lender-actions').classList.remove('hidden');
      } else {
        // Hide lender actions
        document.getElementById('lender-actions').classList.add('hidden');
      }

      // Show payment sections for active and settled agreements
      if (agreement.status === 'active' || agreement.status === 'settled') {
        await loadPaymentData();

        // Check for hardship requests
        const hasHardshipRequests = await checkHardshipRequests();

        // Show hardship indicator for lender if there are requests
        if (isLender && hasHardshipRequests && agreement.status === 'active') {
          document.getElementById('hardship-indicator').classList.remove('hidden');
        }

        // Show "Having trouble paying?" button for borrower on active agreements
        if (isBorrower && agreement.status === 'active') {
          document.getElementById('hardship-button-section').classList.remove('hidden');
        }

        // Show payment action button for active agreements
        if (agreement.status === 'active') {
          showPaymentActionButton();
        }
      }
    }

    // Calculate time until/since due date
    function getDueDateCountdown(dueDate) {
      const now = new Date();
      const due = new Date(dueDate);
      const diffMs = due - now;
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

      if (diffDays > 0) {
        return `(in ${diffDays} day${diffDays === 1 ? '' : 's'})`;
      } else if (diffDays === 0) {
        return '(today)';
      } else {
        const overdueDays = Math.abs(diffDays);
        return `(${overdueDays} day${overdueDays === 1 ? '' : 's'} overdue)`;
      }
    }

    function populateDetails() {
      const amount = formatAmount(agreement.amount_cents);
      const lenderName = agreement.lender_full_name || agreement.lender_name || agreement.lender_email;
      const borrowerName = agreement.borrower_full_name || agreement.friend_first_name || agreement.borrower_email;

      const isLender = agreement.lender_user_id === currentUser.id;
      const isBorrower = agreement.borrower_user_id === currentUser.id;

      // Determine repayment details
      const repaymentType = agreement.repayment_type || 'one_time';
      const hasInterest = agreement.interest_rate && agreement.interest_rate > 0;

      // Generate human-readable summary line 1
      let summaryLine1 = '';
      if (isLender) {
        summaryLine1 = `You lent €${amount} to ${borrowerName}.`;
      } else if (isBorrower) {
        summaryLine1 = `${lenderName} lent you €${amount}.`;
      } else {
        summaryLine1 = `${lenderName} lent €${amount} to ${borrowerName}.`;
      }
      document.getElementById('agreement-summary-line1').textContent = summaryLine1;

      // Generate human-readable summary line 2 (payment schedule)
      let summaryLine2 = '';
      if (repaymentType === 'installments' && agreement.installment_count) {
        const firstDate = new Date(agreement.first_payment_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        const finalDate = new Date(agreement.final_due_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        summaryLine2 = `${agreement.installment_count} monthly payments, from ${firstDate} to ${finalDate}.`;
      } else {
        const dueDate = new Date(agreement.due_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        summaryLine2 = `Due by ${dueDate}.`;
      }
      document.getElementById('agreement-summary-line2').textContent = summaryLine2;

      // Generate human-readable summary line 3 (outstanding and total)
      const outstanding = formatAmount(agreement.outstanding_cents || agreement.amount_cents);
      let summaryLine3 = `€${outstanding} remains outstanding.`;

      if (hasInterest) {
        const totalRepay = formatAmount(Math.round((agreement.total_repay_amount || agreement.amount_cents / 100) * 100));
        summaryLine3 += ` Total to repay: €${totalRepay} (incl. ${agreement.interest_rate}% interest).`;
      }
      document.getElementById('agreement-summary-line3').textContent = summaryLine3;

      // Create and insert borrower avatar (always show borrower)
      let avatarHtml = '';
      if (agreement.borrower_profile_picture && agreement.borrower_user_id) {
        avatarHtml = `<div class="user-avatar size-xl"><img src="/api/profile/picture/${agreement.borrower_user_id}" class="user-avatar-image" /></div>`;
      } else {
        const initials = getInitials(borrowerName);
        const colorClass = getAvatarColor(borrowerName);
        avatarHtml = `<div class="user-avatar size-xl"><div class="user-avatar-initials ${colorClass}">${initials}</div></div>`;
      }
      document.getElementById('summary-avatar').innerHTML = avatarHtml;

      // Show summary section
      document.getElementById('summary-section').classList.remove('hidden');

      // Populate details section
      document.getElementById('amount-display').textContent = `€ ${amount}`;
      document.getElementById('lender-name').textContent = lenderName;
      document.getElementById('borrower-name').textContent = borrowerName;

      // Money transfer date (show if available)
      if (agreement.money_sent_date) {
        let moneySentDateText;
        if (agreement.money_sent_date === 'on-acceptance') {
          moneySentDateText = 'Upon agreement acceptance';
        } else {
          moneySentDateText = new Date(agreement.money_sent_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        }
        document.getElementById('money-sent-display').textContent = moneySentDateText;
        document.getElementById('money-sent-row').style.display = 'flex';
      } else {
        document.getElementById('money-sent-row').style.display = 'none';
      }

      // Repayment type
      const repaymentTypeText = repaymentType === 'installments' ? 'Installments' : 'One-time payment';
      document.getElementById('repayment-type-display').textContent = repaymentTypeText;

      // Installment info (show only if installments)
      if (repaymentType === 'installments' && agreement.installment_count) {
        const installmentAmount = formatAmount(Math.round((agreement.installment_amount || 0) * 100));
        const firstDate = new Date(agreement.first_payment_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        const finalDate = new Date(agreement.final_due_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        document.getElementById('installment-info-display').innerHTML =
          `<div style="text-align:right">${agreement.installment_count} monthly payments of €${installmentAmount}</div><div style="text-align:right">from ${firstDate} to ${finalDate}</div>`;
        document.getElementById('installment-info-row').style.display = 'flex';
      } else {
        document.getElementById('installment-info-row').style.display = 'none';
      }

      // Due date (for one-time, this is the due date; for installments, this is the final due date)
      const dueDate = repaymentType === 'installments' && agreement.final_due_date
        ? new Date(agreement.final_due_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })
        : new Date(agreement.due_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
      document.getElementById('due-date').textContent = dueDate;

      // Add due date countdown
      const dueDateForCountdown = repaymentType === 'installments' && agreement.final_due_date
        ? agreement.final_due_date
        : agreement.due_date;
      document.getElementById('due-date-countdown').textContent = getDueDateCountdown(dueDateForCountdown);

      // Interest info (show only if interest > 0)
      if (hasInterest) {
        const interestRate = agreement.interest_rate;
        const totalInterest = formatAmount(Math.round((agreement.total_interest || 0) * 100));
        document.getElementById('interest-display').textContent = `${interestRate}% per year (total interest: €${totalInterest})`;
        document.getElementById('interest-row').style.display = 'flex';

        // Total to repay
        const totalRepay = formatAmount(Math.round((agreement.total_repay_amount || agreement.amount_cents / 100) * 100));
        document.getElementById('total-repay-display').textContent = `€${totalRepay}`;
        document.getElementById('total-repay-row').style.display = 'flex';
      } else {
        document.getElementById('interest-row').style.display = 'none';
        document.getElementById('total-repay-row').style.display = 'none';
      }

      // Show description if available
      if (agreement.description) {
        document.getElementById('description-display').textContent = agreement.description;
        document.getElementById('description-row').style.display = 'flex';
      } else {
        document.getElementById('description-row').style.display = 'none';
      }

      // Status badge with secondary badges
      const statusText = agreement.status || 'pending';
      let capitalizedStatus = statusText.charAt(0).toUpperCase() + statusText.slice(1);

      // For pending agreements, show "Pending review by {BorrowerName}" for lenders
      if (statusText === 'pending' && isLender) {
        const borrowerFirstName = (agreement.borrower_full_name || agreement.friend_first_name || agreement.borrower_email).split(' ')[0];
        capitalizedStatus = `Pending review by ${borrowerFirstName}`;
      }

      let statusHtml = `<span class="status-badge ${statusText}">${capitalizedStatus}</span>`;

      // Check for pending payment confirmation (only for lenders on active agreements)
      if (isLender && agreement.status === 'active') {
        checkPendingPaymentConfirmation().then(hasPending => {
          if (hasPending) {
            const currentHtml = document.getElementById('status-display').innerHTML;
            if (!currentHtml.includes('Pending payment confirmation')) {
              document.getElementById('status-display').innerHTML = currentHtml + '<span class="secondary-status-badge pending-confirmation">Pending payment confirmation</span>';
            }
          }
        });
      }

      // Check for open difficulty (for both lenders and borrowers on active agreements)
      if (agreement.status === 'active') {
        checkHardshipRequests().then(hasHardship => {
          if (hasHardship) {
            const currentHtml = document.getElementById('status-display').innerHTML;
            if (!currentHtml.includes('Pending resolution')) {
              document.getElementById('status-display').innerHTML = currentHtml + '<span class="secondary-status-badge pending-resolution">Pending resolution</span>';
            }
          }
        });
      }

      document.getElementById('status-display').innerHTML = statusHtml;

      // Populate collapsible detail sections
      populateInterestCalcDetail();
      populatePaymentsAndRemindersDetail();
      populateShareDetail();
    }

    async function checkPendingPaymentConfirmation() {
      try {
        const res = await fetch(`/api/agreements/${agreementId}/payments`);
        if (res.ok) {
          const payments = await res.json();
          return payments.some(p => p.status === 'pending');
        }
      } catch (err) {
        console.error('Error checking pending payments:', err);
      }
      return false;
    }

    function showError(message) {
      document.getElementById('loading-card').classList.add('hidden');
      document.getElementById('error-section').classList.remove('hidden');
      document.getElementById('error-message').textContent = message;
    }

    async function handleAccept() {
      const status = document.getElementById('action-status');
      status.textContent = 'Accepting...';
      status.className = 'status';

      try {
        const res = await fetch(`/api/agreements/${agreementId}/accept`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();

        if (!res.ok) {
          status.textContent = data.error || 'Failed to accept';
          status.className = 'status error';
          return;
        }

        status.textContent = 'Agreement accepted! Redirecting...';
        status.className = 'status success';

        setTimeout(() => {
          window.location.href = '/app';
        }, 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    async function handleDecline() {
      if (!confirm('Are you sure you want to decline this agreement?')) {
        return;
      }

      const status = document.getElementById('action-status');
      status.textContent = 'Declining...';
      status.className = 'status';

      try {
        const res = await fetch(`/api/agreements/${agreementId}/decline`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();

        if (!res.ok) {
          status.textContent = data.error || 'Failed to decline';
          status.className = 'status error';
          return;
        }

        status.textContent = 'Agreement declined. Redirecting...';
        status.className = 'status success';

        setTimeout(() => {
          window.location.href = '/app';
        }, 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    async function handleReviewLater() {
      const status = document.getElementById('action-status');
      status.textContent = 'Saving...';
      status.className = 'status';

      try {
        const res = await fetch(`/api/agreements/${agreementId}/review-later`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();

        if (!res.ok) {
          status.textContent = data.error || 'Failed to save';
          status.className = 'status error';
          return;
        }

        status.textContent = 'Saved! Redirecting to dashboard...';
        status.className = 'status success';

        setTimeout(() => {
          window.location.href = '/app';
        }, 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    // Store the element that opened the modal for focus restoration
    let cancelModalTrigger = null;

    function openCancelModal() {
      cancelModalTrigger = document.activeElement;
      const modal = document.getElementById('cancel-modal');
      modal.style.display = 'flex';

      // Focus on the confirm button
      setTimeout(() => {
        const confirmBtn = document.getElementById('confirm-cancel-btn');
        confirmBtn.focus();
      }, 100);

      // Add keyboard event listener for Esc key
      document.addEventListener('keydown', handleCancelModalKeydown);
    }

    function closeCancelModal() {
      const modal = document.getElementById('cancel-modal');
      modal.style.display = 'none';

      // Remove keyboard event listener
      document.removeEventListener('keydown', handleCancelModalKeydown);

      // Return focus to the trigger button
      if (cancelModalTrigger) {
        cancelModalTrigger.focus();
        cancelModalTrigger = null;
      }
    }

    function handleCancelModalKeydown(e) {
      const modal = document.getElementById('cancel-modal');
      if (modal.style.display === 'none') return;

      // Handle Esc key
      if (e.key === 'Escape') {
        e.preventDefault();
        closeCancelModal();
        return;
      }

      // Handle Tab key for focus trapping
      if (e.key === 'Tab') {
        const focusableElements = modal.querySelectorAll('button, [href], [tabindex]:not([tabindex="-1"])');
        const firstElement = focusableElements[0];
        const lastElement = focusableElements[focusableElements.length - 1];

        if (e.shiftKey) {
          // Shift+Tab
          if (document.activeElement === firstElement) {
            e.preventDefault();
            lastElement.focus();
          }
        } else {
          // Tab
          if (document.activeElement === lastElement) {
            e.preventDefault();
            firstElement.focus();
          }
        }
      }
    }

    async function confirmCancel() {
      // Close modal first
      closeCancelModal();

      const status = document.getElementById('action-status');
      status.textContent = 'Cancelling...';
      status.className = 'status';

      try {
        const res = await fetch(`/api/agreements/${agreementId}/cancel`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();

        if (!res.ok) {
          status.textContent = data.error || 'Failed to cancel';
          status.className = 'status error';
          return;
        }

        status.textContent = 'Agreement cancelled. Redirecting...';
        status.className = 'status success';

        setTimeout(() => {
          window.location.href = '/app';
        }, 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    // Hardship form functions
    function showHardshipForm() {
      document.getElementById('details-section').classList.add('hidden');
      document.getElementById('payment-action-section').classList.add('hidden');
      document.getElementById('hardship-button-section').classList.add('hidden');
      document.getElementById('payment-summary').classList.add('hidden');
      document.getElementById('payment-history').classList.add('hidden');
      document.getElementById('hardship-form').classList.remove('hidden');

      // Set lender's first name
      const lenderName = agreement.lender_full_name || agreement.lender_name;
      const lenderFirstName = lenderName ? lenderName.split(' ')[0] : lenderName;
      document.getElementById('lender-first-name-text').textContent = lenderFirstName || 'your friend';

      // Add event listeners for live summary updates
      document.querySelectorAll('input[name="reason"]').forEach(input => {
        input.addEventListener('change', updateSummary);
      });
      document.querySelectorAll('input[name="can-pay"]').forEach(input => {
        input.addEventListener('change', updateSummary);
      });
      document.getElementById('payment-amount').addEventListener('input', updateSummary);
      document.querySelectorAll('input[type="checkbox"]').forEach(input => {
        input.addEventListener('change', updateSummary);
      });
    }

    function cancelHardshipForm() {
      document.getElementById('hardship-form').classList.add('hidden');
      document.getElementById('details-section').classList.remove('hidden');
      document.getElementById('payment-action-section').classList.remove('hidden');
      document.getElementById('hardship-button-section').classList.remove('hidden');
      document.getElementById('payment-summary').classList.remove('hidden');
      document.getElementById('payment-history').classList.remove('hidden');
    }

    function togglePaymentAmount() {
      const canPayYes = document.getElementById('can-pay-yes').checked;
      const amountInput = document.getElementById('payment-amount-input');

      if (canPayYes) {
        amountInput.classList.remove('hidden');
      } else {
        amountInput.classList.add('hidden');
        document.getElementById('payment-amount').value = '';
      }
    }

    function updateSummary() {
      // Update reason
      const reasonInput = document.querySelector('input[name="reason"]:checked');
      const reasonText = reasonInput ? reasonInput.nextElementSibling.textContent : '-';
      document.getElementById('summary-reason').textContent = reasonText;

      // Update can pay now
      const canPayYes = document.getElementById('can-pay-yes').checked;
      const canPayNo = document.getElementById('can-pay-no').checked;
      const paymentAmount = document.getElementById('payment-amount').value;

      let payText = '-';
      if (canPayYes && paymentAmount) {
        payText = `€${paymentAmount}`;
      } else if (canPayYes) {
        payText = 'Yes (amount not specified)';
      } else if (canPayNo) {
        payText = 'Cannot pay right now';
      }
      document.getElementById('summary-pay').textContent = payText;

      // Update preferred adjustments
      const adjustments = [];
      document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
        adjustments.push(cb.nextElementSibling.textContent);
      });
      const adjustText = adjustments.length > 0 ? adjustments.join('; ') : '-';
      document.getElementById('summary-adjustments').textContent = adjustText;
    }

    async function submitHardshipRequest() {
      const status = document.getElementById('hardship-status');

      // Validate form
      const reasonInput = document.querySelector('input[name="reason"]:checked');
      if (!reasonInput) {
        status.textContent = 'Please select a reason';
        status.className = 'status error';
        return;
      }

      const adjustmentCheckboxes = document.querySelectorAll('input[type="checkbox"]:checked');
      if (adjustmentCheckboxes.length === 0) {
        status.textContent = 'Please select at least one preferred adjustment option';
        status.className = 'status error';
        return;
      }

      // Gather form data
      const reasonCategory = reasonInput.value;
      const reasonText = document.getElementById('reason-text').value.trim() || null;

      const canPayYes = document.getElementById('can-pay-yes').checked;
      let canPayNowCents = null;
      if (canPayYes) {
        const paymentAmount = parseFloat(document.getElementById('payment-amount').value);
        if (paymentAmount && paymentAmount > 0) {
          canPayNowCents = Math.round(paymentAmount * 100);
        }
      }

      const preferredAdjustments = Array.from(adjustmentCheckboxes).map(cb => cb.value);

      status.textContent = 'Sending request...';
      status.className = 'status';

      try {
        const res = await fetch(`/api/agreements/${agreementId}/hardship-request`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            reasonCategory,
            reasonText,
            canPayNowCents,
            preferredAdjustments
          })
        });

        const data = await res.json();

        if (!res.ok) {
          status.textContent = data.error || 'Failed to send request';
          status.className = 'status error';
          return;
        }

        status.textContent = 'Request sent! We\'ve shared your situation and preferences with your friend. Redirecting...';
        status.className = 'status success';

        setTimeout(() => {
          window.location.href = '/app';
        }, 2000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    async function checkHardshipRequests() {
      try {
        const res = await fetch(`/api/agreements/${agreementId}/hardship-requests`);
        if (res.ok) {
          const requests = await res.json();
          return requests.length > 0;
        }
      } catch (err) {
        console.error('Error checking hardship requests:', err);
      }
      return false;
    }

    // Payment functions
    async function loadPaymentData() {
      try {
        // Show payment summary
        document.getElementById('payment-summary').classList.remove('hidden');
        document.getElementById('original-amount').textContent = `€ ${formatAmount(agreement.amount_cents)}`;
        document.getElementById('total-paid').textContent = `€ ${formatAmount(agreement.total_paid_cents || 0)}`;
        document.getElementById('outstanding-amount').textContent = `€ ${formatAmount(agreement.outstanding_cents || agreement.amount_cents)}`;

        // Load payment history
        const res = await fetch(`/api/agreements/${agreementId}/payments`);
        if (res.ok) {
          const payments = await res.json();
          displayPayments(payments);
        }

        // Show "Record payment" button for active agreements
        if (agreement.status === 'active') {
          addRecordPaymentButton();
        }
      } catch (err) {
        console.error('Error loading payment data:', err);
      }
    }

    function displayPayments(payments) {
      const paymentsList = document.getElementById('payments-list');
      const paymentHistory = document.getElementById('payment-history');

      paymentHistory.classList.remove('hidden');

      if (payments.length === 0) {
        paymentsList.innerHTML = '<p style="color:var(--muted); font-size:14px">No payments recorded yet.</p>';
        return;
      }

      const isLender = agreement.lender_user_id === currentUser.id;
      const isBorrower = agreement.borrower_user_id === currentUser.id;

      // Map method values to display names
      const methodNames = {
        'bank': 'Bank transfer',
        'cash': 'Cash',
        'paypal': 'PayPal / mobile payment',
        'crypto': 'Crypto',
        'other': 'Other',
        'any': 'Any method'
      };

      paymentsList.innerHTML = payments.map(payment => {
        const amount = formatAmount(payment.amount_cents);
        const date = new Date(payment.created_at).toLocaleString();
        const methodDisplay = payment.method ? (methodNames[payment.method] || payment.method) : '';
        const method = methodDisplay ? `<div class="payment-method" style="color:var(--muted); margin-top:4px">Method: ${methodDisplay}</div>` : '';
        const note = payment.note ? `<div class="payment-note" style="color:var(--muted); margin-top:4px">Note: ${payment.note}</div>` : '';

        // Determine who recorded the payment
        const recordedByBorrower = payment.recorded_by_user_id === agreement.borrower_user_id;
        const recordedByLender = payment.recorded_by_user_id === agreement.lender_user_id;
        const borrowerName = agreement.borrower_full_name || agreement.borrower_email;
        const lenderName = agreement.lender_full_name || agreement.lender_name;

        // Build status badge and meta text based on who recorded and payment status
        let statusBadge = '';
        let metaText = '';

        if (recordedByBorrower) {
          // Payment reported by borrower
          metaText = `<div class="payment-meta-line">Reported by ${borrowerName}</div>`;

          if (payment.status === 'pending') {
            statusBadge = '<span class="payment-status-badge pending">Pending confirmation</span>';
            metaText += `<div class="payment-meta-line" style="color:#ff9800">Waiting for confirmation from ${lenderName}</div>`;
          } else if (payment.status === 'approved') {
            statusBadge = '<span class="payment-status-badge approved">Approved</span>';
            metaText += `<div class="payment-meta-line" style="color:#3ddc97">Confirmed by ${lenderName}</div>`;
          } else if (payment.status === 'declined') {
            statusBadge = '<span class="payment-status-badge declined">Declined</span>';
            metaText += `<div class="payment-meta-line" style="color:#f44336">Not confirmed by ${lenderName}</div>`;
          }
        } else if (recordedByLender) {
          // Payment added by lender - auto-approved
          statusBadge = '<span class="payment-status-badge approved">Approved</span>';
          metaText = `<div class="payment-meta-line">Added by ${lenderName}</div>`;
        } else {
          // Fallback for other cases
          const recordedBy = payment.recorded_by_name || payment.recorded_by_email;
          metaText = `<div class="payment-meta-line">Recorded by ${recordedBy}</div>`;
        }

        // Proof of payment viewer (above action buttons)
        let proofButton = '';
        if (payment.proof_file_path) {
          proofButton = `
            <div style="margin-top:12px">
              <button onclick="viewProofOfPayment(${payment.id}, '${payment.proof_mime_type}', '${(payment.proof_original_name || 'Proof of payment').replace(/'/g, "\\'")}')" class="secondary" style="font-size:13px; padding:8px 12px; width:100%; text-align:left">
                📎 View proof of payment
              </button>
            </div>
          `;
        }

        // Approval buttons (lender only, for pending payments reported by borrower)
        let approvalButtons = '';
        if (isLender && payment.status === 'pending' && recordedByBorrower) {
          approvalButtons = `
            <div class="payment-approval-buttons" style="margin-top:12px">
              <button onclick="approvePayment(${payment.id})" style="background:#3ddc97">Confirm payment</button>
              <button onclick="declinePayment(${payment.id})" class="secondary">Decline</button>
            </div>
          `;
        }

        return `
          <div class="payment-item">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
              <div style="display:flex; align-items:center; gap:8px">
                <span class="payment-amount">€ ${amount}</span>
                ${statusBadge}
              </div>
              <div class="payment-date">${date}</div>
            </div>
            ${method}
            ${note}
            <div style="margin-top:8px; color:var(--muted)">
              ${metaText}
            </div>
            ${proofButton}
            ${approvalButtons}
          </div>
        `;
      }).join('');
    }

    function showPaymentActionButton() {
      const paymentActionSection = document.getElementById('payment-action-section');
      const recordBtn = document.getElementById('record-payment-btn');

      // Set button text based on user role
      const isLender = agreement.lender_user_id === currentUser.id;
      const isBorrower = agreement.borrower_user_id === currentUser.id;

      if (isBorrower) {
        const lenderName = (agreement.lender_full_name || agreement.lender_name || agreement.lender_email).split(' ')[0];
        recordBtn.textContent = `Report a payment to ${lenderName}`;
      } else if (isLender) {
        const borrowerName = (agreement.borrower_full_name || agreement.friend_first_name || agreement.borrower_email).split(' ')[0];
        recordBtn.textContent = `Report a payment from ${borrowerName}`;
      } else {
        recordBtn.textContent = 'Report Payment';
      }

      recordBtn.onclick = showRecordPaymentForm;
      paymentActionSection.classList.remove('hidden');
    }

    function showRecordPaymentForm() {
      const isBorrower = agreement.borrower_user_id === currentUser.id;
      const isLender = agreement.lender_user_id === currentUser.id;

      // Update form header and button text based on user role
      const formHeader = document.getElementById('payment-form-header');
      const formSubtitle = document.getElementById('payment-form-subtitle');
      const submitBtn = document.getElementById('payment-submit-btn');
      const proofSection = document.getElementById('payment-proof-section');

      const lenderName = agreement.lender_full_name || agreement.lender_name || agreement.lender_email;
      const borrowerName = agreement.borrower_full_name || agreement.friend_first_name || agreement.borrower_email;

      const proofInput = document.getElementById('payment-proof');
      const proofLabel = document.getElementById('payment-proof-label');
      const proofHelper = document.getElementById('payment-proof-helper');

      if (isBorrower) {
        formHeader.textContent = 'Report a payment';
        formSubtitle.textContent = `Confirm your payment to ${lenderName}.`;
        submitBtn.textContent = 'Report Payment';
        // Show proof upload for borrowers
        proofSection.style.display = 'block';

        // Set proof requirement based on agreement
        if (agreement.proof_required) {
          proofLabel.textContent = 'Proof of repayment*';
          proofHelper.textContent = 'Upload a screenshot, photo or PDF that shows this repayment.';
          proofInput.required = true;
        } else {
          proofLabel.textContent = 'Proof of repayment (optional)';
          proofHelper.textContent = 'Upload a screenshot, photo or PDF of your repayment if you have it.';
          proofInput.required = false;
        }
      } else if (isLender) {
        formHeader.textContent = 'Add Received Payment';
        formSubtitle.textContent = `Confirm a payment from ${borrowerName}.`;
        submitBtn.textContent = 'Add Payment';
        // Hide proof upload for lenders
        proofSection.style.display = 'none';
        proofInput.required = false;
      } else {
        formHeader.textContent = 'Report a payment';
        formSubtitle.textContent = 'Record a payment that has been made for this agreement.';
        submitBtn.textContent = 'Report Payment';
        // Hide proof upload by default
        proofSection.style.display = 'none';
        proofInput.required = false;
      }

      // Populate payment method dropdown with only allowed methods
      const paymentMethodSelect = document.getElementById('payment-method');
      const allowedMethods = agreement.payment_preference_method
        ? agreement.payment_preference_method.split(',').map(m => m.trim())
        : [];

      // Clear existing options
      paymentMethodSelect.innerHTML = '';

      // Map method values to display names
      const methodNames = {
        'bank': 'Bank transfer',
        'cash': 'Cash',
        'paypal': 'PayPal / mobile payment',
        'crypto': 'Crypto',
        'other': 'Other',
        'any': 'Any method'
      };

      // If only one method allowed, auto-select it
      if (allowedMethods.length === 1) {
        const method = allowedMethods[0];
        const option = document.createElement('option');
        option.value = method;
        option.textContent = methodNames[method] || method;
        option.selected = true;
        paymentMethodSelect.appendChild(option);
      } else if (allowedMethods.length > 1) {
        // Multiple methods: add a placeholder and all allowed methods
        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'Select method...';
        paymentMethodSelect.appendChild(placeholder);

        allowedMethods.forEach(method => {
          const option = document.createElement('option');
          option.value = method;
          option.textContent = methodNames[method] || method;
          paymentMethodSelect.appendChild(option);
        });
      } else {
        // No methods specified, show all
        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'Select method...';
        paymentMethodSelect.appendChild(placeholder);

        ['cash', 'bank', 'paypal', 'crypto', 'other'].forEach(method => {
          const option = document.createElement('option');
          option.value = method;
          option.textContent = methodNames[method];
          paymentMethodSelect.appendChild(option);
        });
      }

      document.getElementById('details-section').classList.add('hidden');
      document.getElementById('payment-action-section').classList.add('hidden');
      document.getElementById('hardship-button-section').classList.add('hidden');
      document.getElementById('payment-summary').classList.add('hidden');
      document.getElementById('payment-history').classList.add('hidden');
      document.getElementById('record-payment-section').classList.remove('hidden');
    }

    function cancelPaymentForm() {
      document.getElementById('record-payment-section').classList.add('hidden');
      document.getElementById('details-section').classList.remove('hidden');
      document.getElementById('payment-action-section').classList.remove('hidden');
      document.getElementById('hardship-button-section').classList.remove('hidden');
      document.getElementById('payment-summary').classList.remove('hidden');
      document.getElementById('payment-history').classList.remove('hidden');

      // Clear form
      document.getElementById('payment-amount-field').value = '';
      document.getElementById('payment-method').value = '';
      document.getElementById('payment-note').value = '';
      document.getElementById('payment-proof').value = '';
      document.getElementById('payment-status').textContent = '';
    }

    async function submitPayment() {
      const status = document.getElementById('payment-status');
      const amount = parseFloat(document.getElementById('payment-amount-field').value);
      const method = document.getElementById('payment-method').value || null;
      const note = document.getElementById('payment-note').value.trim() || null;
      const proofInput = document.getElementById('payment-proof');
      const proofFile = proofInput?.files[0];

      // Validate amount
      if (!amount || amount <= 0) {
        status.textContent = 'Please enter a valid amount';
        status.className = 'status error';
        return;
      }

      // Validate payment method
      if (!method) {
        status.textContent = 'Please select a payment method';
        status.className = 'status error';
        return;
      }

      // Validate proof of repayment if required
      const isBorrower = agreement.borrower_user_id === currentUser.id;
      if (isBorrower && agreement.proof_required && !proofFile) {
        status.textContent = 'This agreement requires proof of repayment. Please upload a screenshot, photo or PDF of the repayment.';
        status.className = 'status error';
        return;
      }

      // Validate file size if present
      if (proofFile && proofFile.size > 10 * 1024 * 1024) {
        status.textContent = 'File size must be less than 10MB';
        status.className = 'status error';
        return;
      }

      status.textContent = 'Recording payment...';
      status.className = 'status';

      try {
        // Use FormData to support file upload
        const formData = new FormData();
        formData.append('amount', amount);
        if (method) formData.append('method', method);
        if (note) formData.append('note', note);
        if (proofFile) formData.append('proof', proofFile);

        const res = await fetch(`/api/agreements/${agreementId}/payments`, {
          method: 'POST',
          body: formData
          // Don't set Content-Type header - browser will set it with boundary
        });

        const data = await res.json();

        if (!res.ok) {
          status.textContent = data.error || 'Failed to record payment';
          status.className = 'status error';
          return;
        }

        status.textContent = 'Payment recorded successfully! Redirecting...';
        status.className = 'status success';

        // Update agreement data
        agreement = data.agreement;

        setTimeout(() => {
          // If agreement is now settled, redirect to dashboard
          if (agreement.status === 'settled') {
            window.location.href = '/app';
          } else {
            // Reload the page to show updated payment info
            window.location.reload();
          }
        }, 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    // Approve payment
    async function approvePayment(paymentId) {
      try {
        const res = await fetch(`/api/payments/${paymentId}/approve`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();

        if (!res.ok) {
          alert(data.error || 'Failed to approve payment');
          return;
        }

        // Reload payment data and agreement
        await loadAgreementData();
      } catch (err) {
        console.error('Error approving payment:', err);
        alert('Error approving payment');
      }
    }

    // Decline payment
    async function declinePayment(paymentId) {
      if (!confirm('Are you sure you want to decline this payment?')) {
        return;
      }

      try {
        const res = await fetch(`/api/payments/${paymentId}/decline`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();

        if (!res.ok) {
          alert(data.error || 'Failed to decline payment');
          return;
        }

        // Reload payment data and agreement
        await loadAgreementData();
      } catch (err) {
        console.error('Error declining payment:', err);
        alert('Error declining payment');
      }
    }

    // View proof of payment
    function viewProofOfPayment(paymentId, mimeType, fileName) {
      const isPdf = mimeType && mimeType === 'application/pdf';
      const secureUrl = `/api/payments/${paymentId}/proof`;

      const modal = document.getElementById('proof-modal');
      const modalContent = document.getElementById('proof-modal-content');
      const modalCaption = document.getElementById('proof-modal-caption');
      const modalDownload = document.getElementById('proof-modal-download');

      // Set caption and download link
      modalCaption.textContent = fileName || 'Proof of payment';
      modalDownload.href = secureUrl;
      modalDownload.download = fileName || 'proof-of-payment';

      if (isPdf) {
        // Show PDF in iframe/embed
        modalContent.innerHTML = `<iframe src="${secureUrl}" style="width:100%; height:80vh; border:none; background:#fff"></iframe>`;
      } else {
        // Show image
        modalContent.innerHTML = `<img src="${secureUrl}" style="max-width:100%; max-height:80vh; display:block; margin:auto">`;
      }

      modal.style.display = 'flex';
    }

    function closeProofModal() {
      const modal = document.getElementById('proof-modal');
      modal.style.display = 'none';
    }

    // Toggle collapsible sections in review
    function toggleReviewSection(sectionId) {
      const section = document.getElementById(sectionId);
      const toggle = document.getElementById(sectionId + '-toggle');

      if (section && section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        if (toggle) toggle.textContent = '▲';
      } else if (section) {
        section.classList.add('hidden');
        if (toggle) toggle.textContent = '▼';
      }
    }

    // Calculate amortization schedule for interest breakdown
    function calculateAmortizationSchedule() {
      if (!agreement.interest_rate || agreement.interest_rate === 0) {
        return [];
      }

      const principal = agreement.amount_cents / 100;
      const n = agreement.repayment_type === 'installments' ? agreement.installment_count : 1;
      const annualRate = agreement.interest_rate / 100;

      // Determine periods per year based on plan unit
      let periodsPerYear = 12;
      const planUnit = agreement.plan_unit || 'months';
      if (planUnit === 'weeks') {
        periodsPerYear = 52;
      } else if (planUnit === 'days') {
        periodsPerYear = 365;
      } else if (planUnit === 'years') {
        periodsPerYear = 1;
      }

      const periodRate = annualRate / periodsPerYear;
      const principalPerInstallment = principal / n;

      const schedule = [];
      for (let i = 1; i <= n; i++) {
        const outstandingBefore = principal - principalPerInstallment * (i - 1);
        const interestForPeriod = outstandingBefore * periodRate;
        const payment = principalPerInstallment + interestForPeriod;
        const remainingAfter = outstandingBefore - principalPerInstallment;

        schedule.push({
          period: i,
          payment: payment,
          principal: principalPerInstallment,
          interest: interestForPeriod,
          remaining: remainingAfter > 0.01 ? remainingAfter : 0
        });
      }

      return schedule;
    }

    // Populate interest calculation detail for borrower review
    function populateInterestCalcDetail() {
      const card = document.getElementById('interest-calc-card');
      const content = document.getElementById('interest-calc-detail-content');

      if (!agreement.interest_rate || agreement.interest_rate === 0) {
        card.style.display = 'none';
        return;
      }

      card.classList.remove('hidden');

      const totalInterest = formatAmount(Math.round((agreement.total_interest || 0) * 100));
      const totalRepay = formatAmount(Math.round((agreement.total_repay_amount || agreement.amount_cents / 100) * 100));
      const termText = agreement.repayment_type === 'installments' && agreement.installment_count
        ? `${agreement.installment_count} months`
        : 'one payment';

      let html = `<p style="margin:0 0 12px 0; font-size:14px">At ${agreement.interest_rate}% interest per year over ${termText}, total interest is about €${totalInterest} and total to repay is €${totalRepay}.</p>`;

      // Add detailed breakdown table for installments
      if (agreement.repayment_type === 'installments' && agreement.installment_count) {
        const schedule = calculateAmortizationSchedule();
        const firstDate = new Date(agreement.first_payment_date);
        const installmentCount = agreement.installment_count;
        const planUnit = agreement.plan_unit || 'months';

        if (schedule.length > 0) {
          html += '<div style="margin:16px 0; max-height:300px; overflow-y:auto">';
          html += '<table style="width:100%; font-size:12px">';
          html += '<thead><tr style="border-bottom:1px solid rgba(255,255,255,0.08)">';
          html += '<th style="text-align:left; padding:8px 4px">Due date</th>';
          html += '<th style="text-align:right; padding:8px 4px">Payment total</th>';
          html += '<th style="text-align:right; padding:8px 4px">Loan repayment</th>';
          html += '<th style="text-align:right; padding:8px 4px">Interest</th>';
          html += '<th style="text-align:right; padding:8px 4px">Outstanding</th>';
          html += '</tr></thead><tbody>';

          for (let i = 0; i < installmentCount; i++) {
            const installmentDate = new Date(firstDate);
            if (planUnit === 'months') {
              installmentDate.setMonth(installmentDate.getMonth() + i);
            } else if (planUnit === 'weeks') {
              installmentDate.setDate(installmentDate.getDate() + (i * 7));
            } else if (planUnit === 'days') {
              installmentDate.setDate(installmentDate.getDate() + i);
            } else if (planUnit === 'years') {
              installmentDate.setFullYear(installmentDate.getFullYear() + i);
            }
            const dateStr = installmentDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });

            const row = schedule[i];
            if (row) {
              html += `<tr style="border-bottom:1px solid rgba(255,255,255,0.05)">`;
              html += `<td style="padding:8px 4px">${dateStr}</td>`;
              html += `<td style="text-align:right; padding:8px 4px; font-weight:600">${formatCurrency2(row.payment)}</td>`;
              html += `<td style="text-align:right; padding:8px 4px">${formatCurrency2(row.principal)}</td>`;
              html += `<td style="text-align:right; padding:8px 4px">${formatCurrency2(row.interest)}</td>`;
              html += `<td style="text-align:right; padding:8px 4px">${formatCurrency2(row.remaining)}</td>`;
              html += `</tr>`;
            }
          }

          html += '</tbody></table></div>';
        }
      }

      content.innerHTML = html;
    }

    // Populate payments and reminders detail for borrower review
    function populatePaymentsAndRemindersDetail() {
      const card = document.getElementById('payments-reminders-card');
      const content = document.getElementById('payments-reminders-detail-content');

      card.classList.remove('hidden');

      let html = '<div style="display:flex; flex-direction:column; gap:16px">';

      // Payment methods
      const methods = agreement.payment_preference_method
        ? agreement.payment_preference_method.split(',').map(m => m.trim())
        : [];
      const methodsText = methods.length > 0 ? methods.join(', ') : 'Not specified';
      html += `<div>
        <div style="font-weight:600; margin-bottom:6px; font-size:14px">Preferred payment methods:</div>
        <div style="color:var(--muted); font-size:14px">${methodsText}</div>
      </div>`;

      // Proof required
      const proofText = agreement.proof_required
        ? 'Yes — The borrower will be asked to upload proof for each repayment, such as a photo, screenshot or PDF of the transfer or receipt.'
        : 'No — The borrower can report repayments without uploading proof.';
      html += `<div>
        <div style="font-weight:600; margin-bottom:6px; font-size:14px">Require proof of repayment:</div>
        <div style="color:var(--muted); font-size:14px; line-height:1.5">${proofText}</div>
      </div>`;

      // Reminder mode
      const reminderMode = agreement.reminder_mode === 'auto' ? 'Auto (recommended)' : 'Custom schedule';
      html += `<div>
        <div style="font-weight:600; margin-bottom:6px; font-size:14px">Reminders:</div>
        <div style="color:var(--muted); font-size:14px; line-height:1.6">${reminderMode}</div>
      </div>`;

      // Reminder details
      if (agreement.reminder_mode === 'auto') {
        html += `<div style="color:var(--muted); font-size:13px; line-height:1.6; padding:12px; background:rgba(255,255,255,0.02); border-radius:6px">
          You'll receive reminders 7 days before, 1 day before, and on the due date. If no payment is reported, you'll get follow-up reminders 1 day after, then every 3 days.
        </div>`;
      }

      // Worst case scenario (debt collection clause) - only show if enabled
      if (agreement.debt_collection_clause) {
        html += `<div>
          <div style="font-weight:600; margin-bottom:6px; font-size:14px">Worst case scenario:</div>
          <div style="color:var(--muted); font-size:14px; line-height:1.5">If the borrower does not repay in time and ignores reminders or cannot agree a new plan with the lender, PayFriends will hand the case to an independent debt collector. Once this happens, the lender is no longer involved in collection — the third party handles it, and any collection fees are for the borrower's account.</div>
        </div>`;
      }

      html += '</div>';
      content.innerHTML = html;
    }

    // Populate share detail (lender only, for pending agreements)
    async function populateShareDetail() {
      const card = document.getElementById('share-card');
      const content = document.getElementById('share-detail-content');

      // Only show for lenders with pending agreements
      const isLender = agreement.lender_user_id === currentUser.id;
      if (!isLender) {
        card.style.display = 'none';
        return;
      }

      card.classList.remove('hidden');

      let html = '<div style="display:flex; flex-direction:column; gap:20px">';

      // Fetch invite token to construct URL
      try {
        const res = await fetch(`/api/agreements/${agreement.id}/invite`);
        if (res.ok) {
          const inviteData = await res.json();
          const inviteUrl = `${window.location.origin}/review?token=${inviteData.token}`;
          const borrowerName = agreement.borrower_full_name || agreement.friend_first_name || agreement.borrower_email;
          const borrowerEmail = agreement.borrower_email;
          const createdDate = new Date(inviteData.created_at).toLocaleDateString('en-GB', {
            day: 'numeric',
            month: 'short',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });

          // Invite sent info
          const emailPart = borrowerEmail ? ` at <strong style="color:var(--text)">${borrowerEmail}</strong>` : '';
          html += `<div>
            <div style="color:var(--muted); font-size:14px">Invite sent to <strong style="color:var(--text)">${borrowerName}</strong>${emailPart} on ${createdDate}.</div>
          </div>`;

          // Share link
          html += `<div>
            <div style="font-weight:600; margin-bottom:8px; font-size:14px">Share link:</div>
            <div style="display:flex; gap:8px; align-items:center">
              <input type="text" readonly value="${inviteUrl}" id="manage-share-link" style="flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background:#0e1116; color:var(--text); font-family:monospace; font-size:13px" />
              <button onclick="copyManageShareLink()" style="width:auto; white-space:nowrap; padding:10px 16px; background:var(--accent); color:#0d130f; border:none; border-radius:10px; font-weight:600; cursor:pointer">Copy link</button>
            </div>
          </div>`;

          // QR code
          html += `<div>
            <div style="font-weight:600; margin-bottom:8px; font-size:14px">QR code:</div>
            <div id="manage-qr-code-container"></div>
          </div>`;

          html += '</div>';
          content.innerHTML = html;

          // Generate QR code
          setTimeout(() => {
            const qrContainer = document.getElementById('manage-qr-code-container');
            if (qrContainer && typeof QRCode !== 'undefined') {
              qrContainer.innerHTML = ''; // Clear any existing QR
              new QRCode(qrContainer, {
                text: inviteUrl,
                width: 200,
                height: 200,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
              });
            }
          }, 100);
        } else {
          html += '<div style="color:var(--muted); font-size:14px">Unable to load share information.</div></div>';
          content.innerHTML = html;
        }
      } catch (err) {
        console.error('Error loading invite:', err);
        html += '<div style="color:var(--muted); font-size:14px">Unable to load share information.</div></div>';
        content.innerHTML = html;
      }
    }

    // Copy share link from manage page
    function copyManageShareLink() {
      const input = document.getElementById('manage-share-link');
      input.select();
      input.setSelectionRange(0, 99999); // For mobile
      document.execCommand('copy');

      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = 'Copied!';
      setTimeout(() => {
        btn.textContent = originalText;
      }, 2000);
    }

    // Load all agreements
    async function loadAllAgreements() {
      try {
        const res = await fetch('/api/agreements');
        if (res.ok) {
          allAgreements = await res.json();
          renderAgreements();
        }
      } catch (err) {
        console.error('Error loading agreements:', err);
      }
    }

    // Filter agreements by status
    function filterByStatus(status) {
      currentFilter = status;

      // Update active tab
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.getAttribute('data-filter') === status) {
          tab.classList.add('active');
        }
      });

      renderAgreements();
    }

    // Render agreements table
    function renderAgreements() {
      // Use shared component - pass agreementId for highlighting current agreement
      renderAgreementsTable(allAgreements, currentUser, currentFilter, agreementId);
    }

    // Scroll to manage section
    function scrollToManage() {
      const manageHeader = document.getElementById('manage-header');
      if (manageHeader) {
        manageHeader.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    // Navigation functions for agreements table
    function reviewAgreement(id) {
      window.location.href = `/agreements/${id}/review`;
    }

    function viewAgreement(id) {
      window.location.href = `/agreements/${id}/manage`;
    }

    // Modal functions - redirect to manage page if not on current agreement
    function openConfirmPaymentModal(id) {
      if (id === parseInt(agreementId)) {
        // Open the modal if already on this agreement's page
        // For now, just scroll to manage section - modal implementation TBD
        scrollToManage();
      } else {
        window.location.href = `/agreements/${id}/manage`;
      }
    }

    function openDifficultyModal(id) {
      if (id === parseInt(agreementId)) {
        // Open the modal if already on this agreement's page
        // For now, just scroll to manage section - modal implementation TBD
        scrollToManage();
      } else {
        window.location.href = `/agreements/${id}/manage`;
      }
    }

    // Note: Header initialization, user info, logout, and activity count are now handled by shared header.js

    // Create initializePage wrapper for DOMContentLoaded
    function initializePage() {
      if (!agreementId) {
        showError('Invalid agreement ID.');
      } else {
        // Load both the specific agreement and all agreements
        loadAgreementData();
        loadAllAgreements();
      }
    }
  </script>

  <!-- Shared Agreements Table Component -->
  <script src="/components/agreements-table.js"></script>

  <!-- Proof of payment modal -->
  <div id="proof-modal" onclick="closeProofModal()" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.9); align-items:center; justify-content:center;">
    <div onclick="event.stopPropagation()" style="max-width:90%; max-height:90%; width:90%; position:relative; background:#1a1f26; padding:20px; border-radius:8px; cursor:default">
      <!-- Close button -->
      <span onclick="closeProofModal()" style="position:absolute; top:10px; right:15px; color:#fff; font-size:35px; font-weight:bold; cursor:pointer; z-index:1001">&times;</span>

      <!-- Title -->
      <h3 style="color:#fff; margin:0 0 15px 0; padding-right:40px">Proof of payment</h3>

      <!-- Content container (will hold image or iframe) -->
      <div id="proof-modal-content" style="margin-bottom:15px; max-height:80vh; overflow:auto"></div>

      <!-- Caption -->
      <div id="proof-modal-caption" style="color:#ccc; font-size:14px; margin-bottom:15px"></div>

      <!-- Footer with download button -->
      <div style="display:flex; justify-content:flex-end; padding-top:12px; border-top:1px solid rgba(255,255,255,0.1)">
        <a id="proof-modal-download" href="#" download style="display:inline-block; padding:10px 20px; background:#2a2a2a; color:#fff; border:1px solid rgba(255,255,255,0.15); border-radius:8px; text-decoration:none; font-weight:500; font-size:14px; cursor:pointer; transition:all 0.2s ease">Download</a>
      </div>
    </div>
  </div>

  <!-- Cancel Agreement Confirmation Modal -->
  <div id="cancel-modal" onclick="closeCancelModal()" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.85); align-items:center; justify-content:center;" role="dialog" aria-modal="true" aria-labelledby="cancel-modal-title">
    <div onclick="event.stopPropagation()" style="max-width:500px; width:90%; position:relative; background:#1a1f26; padding:24px; border-radius:12px; cursor:default; border:1px solid rgba(255,255,255,0.1);">
      <!-- Close button -->
      <span onclick="closeCancelModal()" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();closeCancelModal();}" tabindex="0" role="button" style="position:absolute; top:10px; right:15px; color:#fff; font-size:28px; font-weight:bold; cursor:pointer; line-height:1;" aria-label="Close">&times;</span>

      <!-- Title -->
      <h3 id="cancel-modal-title" style="color:#fff; margin:0 0 16px 0; padding-right:35px; font-size:20px; font-weight:600;">Cancel this request?</h3>

      <!-- Body text -->
      <p style="color:var(--text); line-height:1.6; margin:0 0 24px 0; font-size:15px;">Are you sure you want to cancel this agreement request? This will withdraw the agreement so your friend can no longer accept it.</p>

      <!-- Action buttons -->
      <div style="display:flex; gap:12px; flex-direction:row-reverse;">
        <button id="confirm-cancel-btn" class="btn-danger" onclick="confirmCancel()" style="width:auto; flex:1; margin-top:0;">Yes, cancel request</button>
        <button class="secondary" onclick="closeCancelModal()" style="width:auto; flex:1; margin-top:0;">Keep agreement</button>
      </div>
    </div>
  </div>

</body>
</html>
