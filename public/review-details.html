<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PayFriends — Agreement Details</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- Shared control styles -->
  <link rel="stylesheet" href="/css/shared-controls.css" />
  <!-- App-wide styles -->
  <link rel="stylesheet" href="/css/app.css" />
  <!-- Renegotiation styles -->
  <link rel="stylesheet" href="/css/renegotiation.css" />
  <!-- Shared header component -->
  <script src="/js/header.js"></script>
  <!-- Centralized currency formatters -->
  <script src="/js/formatters.js"></script>
  <!-- Derived field utilities -->
  <script src="/js/derived-fields.js"></script>
  <!-- Renegotiation module -->
  <script src="/js/renegotiation.js"></script>
  <!-- Fairness icon component -->
  <script src="/components/fairness-icon.js"></script>
  <!-- Payment methods display component -->
  <script src="/components/payment-methods-display.js"></script>
  <style>
    :root{
      --bg:#0e1116; --card:#151a21; --text:#e6eef6; --muted:#a7b0bd; --accent:#3ddc97;
      --danger:#ef4444;
      --warning:#f97316;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif; background:var(--bg); color:var(--text);}
    .container{max-width:1200px; margin:0 auto; padding:32px 16px;}
    .card{background:var(--card); border:1px solid rgba(255,255,255,0.06); border-radius:16px; padding:24px; margin:16px 0}
    h1{margin:0 0 8px 0; font-size:24px}
    h2{margin:0 0 16px 0; font-size:20px}
    p{color:var(--muted); line-height:1.6; margin:8px 0}
    .detail-row{display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.08)}
    .detail-row:last-child{border-bottom:none}
    .detail-label{color:var(--muted); font-weight:500}
    .detail-value{color:var(--text); font-weight:normal}
    button{padding:12px 20px; border-radius:10px; border:0; background:var(--accent); color:#0d130f; font-weight:700; cursor:pointer; font-size:14px; width:100%}
    button:hover{filter:brightness(1.06)}
    button.secondary{background:transparent; border:1px solid rgba(255,255,255,0.15); color:var(--text); margin-top:8px}
    button.secondary:hover{background:rgba(255,255,255,0.05)}
    button.tertiary{background:transparent; border:1px solid rgba(255,255,255,0.10); color:var(--muted); margin-top:8px}
    button.tertiary:hover{background:rgba(255,255,255,0.03)}
    button.btn-danger{background:#7a1a1a; border:1px solid #a83232; color:#fff; margin-top:8px}
    button.btn-danger:hover{background:#8a2020; border-color:#b84444}
    button.btn-danger:disabled{opacity:0.5; cursor:not-allowed}
    .status{color:var(--muted); margin-top:12px; min-height:1.2em; font-size:14px}
    .hidden{display:none}
    .error{color:#ff6b6b}
    .success{color:var(--accent)}
    .amount{font-size:32px; font-weight:700; color:var(--accent); text-align:center; margin:16px 0}
    .note{background:rgba(61,220,151,0.1); border:1px solid rgba(61,220,151,0.2); border-radius:8px; padding:12px; color:var(--text); font-size:14px; margin:16px 0}
    .status-badge{display:inline-block; padding:4px 10px; border-radius:6px; font-size:12px; font-weight:600}
    .status-badge.pending{background:#f97316; color:#fff}
    .status-badge.active{background:#22c55e; color:#0d130f}
    .status-badge.settled{background:#4a4a4a; color:#fff}
    .status-badge.declined{background:#ff6b6b; color:#fff}
    .status-badge.cancelled{background:#6c757d; color:#fff}
    .alert-box{background:rgba(255,165,0,0.1); border:1px solid rgba(255,165,0,0.3); border-radius:8px; padding:12px; color:var(--text); font-size:14px; margin:16px 0}
    .form-group{margin:20px 0}
    .form-label{display:block; color:var(--text); font-weight:600; margin-bottom:8px; font-size:14px}
    .form-radio{display:block; margin:8px 0; padding:10px; border:1px solid rgba(255,255,255,0.1); border-radius:8px; cursor:pointer; transition:background 0.2s}
    .form-radio:hover{background:rgba(255,255,255,0.03)}
    .form-radio input{margin-right:8px}
    .form-radio label{cursor:pointer; color:var(--text); font-size:14px}
    .form-checkbox{display:block; margin:8px 0; padding:10px; border:1px solid rgba(255,255,255,0.1); border-radius:8px; cursor:pointer; transition:background 0.2s}
    .form-checkbox:hover{background:rgba(255,255,255,0.03)}
    .form-checkbox input{margin-right:8px}
    .form-checkbox label{cursor:pointer; color:var(--text); font-size:14px}
    textarea{width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background:var(--bg); color:var(--text); font-family:inherit; font-size:14px; resize:vertical; min-height:80px}
    textarea:focus{outline:none; border-color:var(--accent); background:var(--bg)}
    textarea:hover{background:var(--bg)}
    textarea:-webkit-autofill,
    textarea:-webkit-autofill:hover,
    textarea:-webkit-autofill:focus,
    textarea:-webkit-autofill:active{
      -webkit-background-clip:text;
      -webkit-text-fill-color:var(--text);
      transition:background-color 5000s ease-in-out 0s;
      box-shadow:inset 0 0 20px 20px var(--bg);
    }
    textarea::placeholder{color:var(--muted)}
    input[type="number"]{width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background:var(--bg); color:var(--text); font-family:inherit; font-size:14px}
    input[type="number"]:focus{outline:none; border-color:var(--accent); background:var(--bg)}
    input[type="number"]:hover{background:var(--bg)}
    input[type="number"]:-webkit-autofill,
    input[type="number"]:-webkit-autofill:hover,
    input[type="number"]:-webkit-autofill:focus,
    input[type="number"]:-webkit-autofill:active{
      -webkit-background-clip:text;
      -webkit-text-fill-color:var(--text);
      transition:background-color 5000s ease-in-out 0s;
      box-shadow:inset 0 0 20px 20px var(--bg);
    }
    input[type="number"]::placeholder{color:var(--muted)}
    .summary-box{background:rgba(61,220,151,0.05); border:1px solid rgba(61,220,151,0.15); border-radius:12px; padding:20px; margin:20px 0}
    .summary-item{margin:8px 0; color:var(--text); font-size:14px}
    .summary-label{color:var(--muted); font-weight:600}
    button.warning{background:#ff9800; color:#0d130f}
    button.warning:hover{filter:brightness(1.1)}
    .payment-item{background:#10151d; border-radius:8px; padding:12px; margin:12px 0; border:1px solid rgba(255,255,255,0.08)}
    .payment-date{color:var(--muted); font-size:12px}
    .payment-amount{font-weight:700; color:var(--accent); font-size:16px}
    .payment-method{color:var(--muted); font-style:italic; font-size:14px}
    .payment-note{color:var(--text); margin-top:4px; font-size:14px}
    .payment-recorded-by{color:var(--muted); margin-top:4px; font-size:14px}
    .payment-meta-line{font-size:14px}
    .record-payment-btn{background:#3d7bdc; margin-top:0}
    .record-payment-btn:hover{filter:brightness(1.1)}
    .next-payment-container{display:grid; grid-template-columns:minmax(0,1fr); gap:16px; align-items:start}
    .next-payment-info{display:flex; flex-direction:column; gap:4px}
    .next-payment-actions{display:flex; flex-direction:column; gap:8px; width:100%}
    @media (min-width: 768px){
      .next-payment-container{grid-template-columns:minmax(0,1fr) auto; gap:32px; align-items:center}
      .next-payment-actions{width:auto; min-width:224px}
    }
    select{appearance:none; background-image:url('data:image/svg+xml;utf8,<svg fill="%23a7b0bd" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>'); background-repeat:no-repeat; background-position:right 8px center}
    .payment-status-badge{display:inline-block; padding:4px 10px; border-radius:6px; font-size:12px; font-weight:600; margin-left:8px}
    .payment-status-badge.approved{background:#3ddc97; color:#0d130f}
    .payment-status-badge.pending{background:#ff9800; color:#0d130f}
    .payment-status-badge.declined{background:#ff6b6b; color:#fff}
    .payment-approval-buttons{margin-top:8px; display:flex; gap:8px}
    .payment-approval-buttons button{width:auto; padding:8px 16px; font-size:13px}
    .secondary-status-badge{display:inline-block; padding:4px 10px; border-radius:6px; font-size:12px; font-weight:600; margin-left:8px}
    .secondary-status-badge.pending-confirmation{background:#f97316; color:#fff}
    .secondary-status-badge.pending-resolution{background:#dc2626; color:#fff}
    .hardship-button-spacing{margin-top:20px}
    .form-section{background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:20px; margin-bottom:24px}
    .form-section-title{font-size:16px; font-weight:600; color:var(--text); margin-bottom:12px}
    #proof-modal-download:hover{background:#3a3a3a; border-color:rgba(255,255,255,0.25)}
    .top-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid rgba(255,255,255,0.08)}
    .top-header-left{display:flex; align-items:center; gap:12px}
    .top-header-right{display:flex; gap:12px; align-items:center}
    .logo-coin{height:54px; width:auto}
    .top-header-text{display:flex; flex-direction:column; gap:2px}
    .app-name{font-size:24px; font-weight:600; line-height:1.2; margin:0}
    .user-meta{color:var(--muted); font-size:14px; line-height:1.2}
    .app-slogan{color:var(--muted); font-size:14px; line-height:1.2; margin-top:2px}
    .top-header-user-info{color:var(--text); font-size:14px; line-height:1; white-space:nowrap; display:inline-flex; align-items:center; height:40px}
    .top-header-actions{display:flex; gap:12px; align-items:center}
    .inbox-count{color:var(--accent);font-weight:700}
    .tabs{display:flex; gap:8px; margin-bottom:16px; border-bottom:1px solid rgba(255,255,255,0.08)}
    .tab{padding:10px 16px; cursor:pointer; color:var(--muted); border-bottom:2px solid transparent; margin-bottom:-1px}
    .tab.active{color:var(--accent); border-bottom-color:var(--accent)}
    .tab:hover{color:var(--text)}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:10px 12px; border-bottom:1px solid rgba(255,255,255,0.08); text-align:left; vertical-align:middle}
    th{color:var(--muted); font-weight:600; font-size:13px}
    .actions-column{display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:flex-end; width:100%}
    .actions-column button{flex:0 0 auto; padding:8px 12px; font-size:14px; white-space:nowrap; width:auto}
    .empty-state{text-align:center; color:var(--muted); padding:32px; font-size:14px}
    .user-avatar{display:inline-flex; align-items:center; justify-content:center; border-radius:50%; overflow:hidden; flex-shrink:0; vertical-align:middle}
    .user-avatar.size-small{width:36px; height:36px; min-width:36px; font-size:13px; font-weight:600; line-height:1; letter-spacing:-0.2px}
    .user-avatar.size-medium{width:48px; height:48px; font-size:18px; font-weight:600}
    .user-avatar.size-large{width:60px; height:60px; font-size:22px; font-weight:600; margin-right:16px}
    .user-avatar.size-xl{width:110px; height:110px; font-size:36px; font-weight:600; margin-right:20px}
    .user-avatar-image{width:100%; height:100%; object-fit:cover}
    .user-avatar-initials{width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:600; text-transform:uppercase}
    .user-avatar-initials.color-1{background:#6366f1}
    .user-avatar-initials.color-2{background:#8b5cf6}
    .user-avatar-initials.color-3{background:#ec4899}
    .user-avatar-initials.color-4{background:#f59e0b}
    .user-avatar-initials.color-5{background:#10b981}
    .user-avatar-initials.color-6{background:#3b82f6}
    .user-avatar-initials.color-7{background:#14b8a6}
    /* Override avatar margins inside summary section to allow overlap */
    #summary-section #summary-avatar-lender > *,
    #summary-section #summary-avatar-borrower > * {margin:0 !important}
    .counterparty-cell{display:flex; align-items:center; gap:10px}
    .due-date-overdue{color:#f87171}
    .due-date-upcoming{color:var(--muted)}
    .due-date-settled{color:#9ca3af}
    .status-indicator{width:22px;height:22px;border-radius:9999px;display:inline-flex;align-items:center;justify-content:center;margin:0 auto;cursor:help}
    .status-indicator--active{background:#22c55e}
    .status-indicator--pending{background:#facc15}
    .status-indicator--settled{background:#9ca3af}
    .status-indicator--overdue{background:#f87171}
    .status-indicator--cancelled{background:#9ca3af}
    .status-indicator--declined{background:#f87171}
    .status-dot{display:inline-block; width:16px; height:16px; border-radius:9999px; cursor:help; position:relative}
    .status-dot--active{background:#22c55e}
    .status-dot--pending{background:#facc15}
    .status-dot--settled{background:#9ca3af}
    .status-dot--overdue{background:#f87171}
    .status-dot--cancelled{background:#9ca3af}
    .status-dot--declined{background:#f87171}
    .status-dot-wrapper{display:inline-flex;align-items:center;justify-content:center;position:relative}
    .status-dot-wrapper::after{content:attr(data-tooltip);position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);background:#1f2937;color:#fff;padding:6px 12px;border-radius:6px;font-size:12px;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity 0.2s ease;border:1px solid rgba(255,255,255,0.1);z-index:1000}
    .status-dot-wrapper::before{content:'';position:absolute;bottom:calc(100% + 2px);left:50%;transform:translateX(-50%);border:4px solid transparent;border-top-color:#1f2937;opacity:0;pointer-events:none;transition:opacity 0.2s ease;z-index:1000}
    .status-dot-wrapper:hover::after,.status-dot-wrapper:hover::before{opacity:1}
    .payment-impact-annotation{color:#a7b0bd; font-size:13px; margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.06); line-height:1.6}
    .payment-impact-badge{display:inline-block; padding:2px 8px; border-radius:4px; font-size:11px; font-weight:600; margin-left:6px; background:rgba(61,220,151,0.2); color:#3ddc97}
    .payment-impact-tooltip{position:relative; display:inline-flex; align-items:center; margin-left:4px; cursor:help; color:var(--muted)}
    .payment-impact-tooltip::after{content:attr(data-tooltip); position:absolute; bottom:calc(100% + 8px); left:50%; transform:translateX(-50%); background:#1f2937; color:#fff; padding:8px 12px; border-radius:6px; font-size:12px; white-space:normal; width:250px; opacity:0; pointer-events:none; transition:opacity 0.2s ease; border:1px solid rgba(255,255,255,0.1); z-index:1000; line-height:1.4}
    .payment-impact-tooltip::before{content:''; position:absolute; bottom:calc(100% + 2px); left:50%; transform:translateX(-50%); border:4px solid transparent; border-top-color:#1f2937; opacity:0; pointer-events:none; transition:opacity 0.2s ease; z-index:1000}
    .payment-impact-tooltip:hover::after,.payment-impact-tooltip:hover::before{opacity:1}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    /* Loan Timeline styles */
    .timeline-event{margin-bottom:16px; border-left:2px solid rgba(255,255,255,0.1); padding-left:20px; position:relative}
    .timeline-event::before{content:''; position:absolute; left:-6px; top:4px; width:10px; height:10px; border-radius:50%; background:var(--accent); border:2px solid var(--card)}
    .timeline-event.timeline-event--issue::before{background:var(--warning)}
    .timeline-event.timeline-event--resolved::before{background:#22c55e}
    .timeline-event.timeline-event--settled::before{background:#9ca3af}
    .timeline-event-header{display:flex; justify-content:space-between; align-items:flex-start; cursor:pointer; padding:8px 12px; border-radius:8px; transition:background 0.2s}
    .timeline-event-header:hover{background:rgba(255,255,255,0.03)}
    .timeline-event-title{font-weight:600; color:var(--text); font-size:14px}
    .timeline-event-date{color:var(--muted); font-size:12px; margin-top:2px}
    .timeline-event-details{margin-top:12px; padding:12px; background:rgba(255,255,255,0.02); border-radius:8px; border:1px solid rgba(255,255,255,0.06); display:none}
    .timeline-event-details.expanded{display:block}
    .timeline-event-details-row{display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(255,255,255,0.04)}
    .timeline-event-details-row:last-child{border-bottom:none}
    .timeline-event-label{color:var(--muted); font-size:13px}
    .timeline-event-value{color:var(--text); font-size:13px; font-weight:500}
    .timeline-comparison-table{width:100%; border-collapse:collapse; margin-top:8px}
    .timeline-comparison-table th{text-align:left; padding:8px; font-size:12px; color:var(--muted); font-weight:600; border-bottom:1px solid rgba(255,255,255,0.08)}
    .timeline-comparison-table td{padding:8px; font-size:13px; border-bottom:1px solid rgba(255,255,255,0.04)}
    .timeline-comparison-table td:first-child{color:var(--muted)}
    .timeline-comparison-table td.value-old{color:#f87171}
    .timeline-comparison-table td.value-new{color:var(--accent)}

    /* Toast notification animations */
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
    @media (max-width: 768px) {
      .pf-review-modal{max-width:100% !important; width:100% !important; margin:0 !important; border-radius:0 !important; padding:16px !important}
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header will be loaded dynamically by header.js -->

    <!-- Page top bar (for manage/view mode) -->
    <div id="page-topbar-container"></div>

    <!-- My Agreements section (hidden by default when viewing specific agreement) -->
    <section class="card hidden" id="list-section">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
        <h2 style="margin:0">My Agreements</h2>
      </div>

      <div class="tabs">
        <div class="tab active" data-filter="all" onclick="filterByStatus('all')">All</div>
        <div class="tab" data-filter="pending" onclick="filterByStatus('pending')">Pending</div>
        <div class="tab" data-filter="active" onclick="filterByStatus('active')">Active</div>
        <div class="tab" data-filter="settled" onclick="filterByStatus('settled')">Settled</div>
      </div>

      <table id="list">
        <thead>
          <tr>
            <th id="counterparty-header">Borrower</th>
            <th>Description</th>
            <th>Outstanding / Total</th>
            <th id="due-header">Next repayment due</th>
            <th>Status</th>
            <th style="text-align:right">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="empty-state" class="empty-state" style="display:none">
        No agreements found for this filter.
      </div>
      <div style="display:flex; justify-content:flex-end; margin-top:16px">
        <button onclick="window.location.href='/app'" style="display:flex; align-items:center; gap:8px; padding:12px 20px; width:auto">
          <span style="font-size:18px; font-weight:bold">+</span>
          <span>New Agreement</span>
        </button>
      </div>
    </section>

    <!-- Loading state moved to page-topbar-container -->
    <div id="loading-card" style="margin:24px 0">
      <p id="loading-text" style="color:var(--muted); font-size:14px">Loading...</p>
    </div>

    <!-- Manage agreement header (for view mode) - now using page-topbar component -->
    <div id="manage-header" class="hidden" style="margin:16px 0 24px 0">
      <!-- Top bar will be rendered here dynamically -->
    </div>

    <!-- Agreement summary block (above details card) -->
    <div id="summary-section" class="hidden" style="background:rgba(61,220,151,0.05); border:1px solid rgba(61,220,151,0.15); border-radius:12px; padding:20px; margin:20px 0; display:flex; align-items:center; gap:16px">
      <!-- Both avatars: Lender (left) + Borrower (right) with slight overlap -->
      <div style="flex-shrink:0; position:relative; display:flex; align-items:center">
        <div id="summary-avatar-lender" style="position:relative; z-index:0"></div>
        <div id="summary-avatar-borrower" style="position:relative; margin-left:-16px; z-index:1"></div>
      </div>
      <div style="flex:1">
        <p id="agreement-summary-line1" style="margin:0 0 12px 0; font-size:15px; line-height:1.6; color:var(--accent)"></p>
        <p id="agreement-summary-line2" style="margin:0 0 12px 0; font-size:15px; line-height:1.6; color:var(--accent)"></p>
        <p id="agreement-summary-line3" style="margin:0; font-size:15px; line-height:1.6; color:var(--accent)"></p>
      </div>
    </div>

    <!-- Next Payment Due Card (borrower-only, active agreements) -->
    <div id="next-payment-card" class="card hidden" style="padding:16px 20px; margin:20px 0">
      <div class="next-payment-container">
        <!-- LEFT/TOP: Payment info -->
        <div class="next-payment-info">
          <div id="next-payment-label" style="color:var(--muted); font-size:14px">Next payment due</div>
          <div id="next-payment-amount" style="font-size:28px; font-weight:600; color:var(--accent); font-variant-numeric:tabular-nums"></div>
          <div id="next-payment-due-date" style="color:var(--muted); font-size:14px; margin-top:4px"></div>
          <div id="next-payment-subtitle" style="color:var(--muted); font-size:13px; margin-top:4px"></div>
          <div id="next-payment-planned" style="color:var(--muted); font-size:13px; margin-top:8px; line-height:1.5"></div>
        </div>

        <!-- RIGHT/BOTTOM: Action buttons -->
        <div class="next-payment-actions">
          <button id="borrower-record-payment-btn" class="record-payment-btn" style="width:100%; font-weight:500; white-space:nowrap" aria-label="Report a payment">Report a payment</button>
          <button id="hardship-btn" class="warning" onclick="showRenegotiationInitiationForm()" style="width:100%; font-weight:500; white-space:nowrap" aria-label="Having trouble paying?">Having trouble paying?</button>
        </div>
      </div>
    </div>

    <!-- Inline Report Payment Form (separate card, collapsed by default) -->
    <div id="inline-payment-form-card" class="card hidden" style="padding:20px; margin:20px 0">
      <h3 style="font-size:18px; font-weight:600; margin:0 0 8px 0">Report a payment</h3>
      <p id="inline-payment-subtitle" style="color:var(--muted); font-size:14px; margin:0 0 12px 0">
        Confirm the payment you already made to <span id="inline-lender-name"></span>.
      </p>
      <p style="color:var(--muted); font-size:13px; margin:0 0 20px 0; line-height:1.6; display:flex; align-items:start; gap:4px">
        <img src="/images/payfriends-handshake.svg" style="display:inline-block; height:16px; width:16px; margin-top:2px; flex-shrink:0" alt="PayFriends fairness icon" />
        <span id="fairness-explanation-text"><strong style="color:var(--accent)">Fairness recalculations activated:</strong> <span id="fairness-explanation-detail"></span></span>
      </p>

      <div class="form-group">
        <label class="form-label" for="inline-payment-amount">Amount (EUR)</label>
        <p id="amount-due-today-label" style="color:var(--muted); font-size:13px; margin:0 0 8px 0"></p>
        <div style="position:relative; width:100%; max-width:400px">
          <input type="number" id="inline-payment-amount" placeholder="e.g. 1 234,56" min="0" step="0.01" style="width:100%; padding-right:165px">
          <span id="autofill-amount-link" style="position:absolute; right:12px; top:50%; transform:translateY(-50%); font-size:12px; color:var(--accent); cursor:pointer; white-space:nowrap; text-decoration:underline; text-decoration-style:dotted" title="Autofill with the amount due today">Use amount due today</span>
        </div>
        <p id="early-payment-tip" style="color:var(--muted); font-size:12px; margin:4px 0 0 0; font-style:italic"></p>
        <p id="amount-helper-text" style="color:var(--muted); font-size:13px; margin:8px 0 0 0; line-height:1.5"></p>
      </div>

      <!-- Live Impact Box (only visible for overpayments) -->
      <div id="live-impact-box" class="hidden" style="background:rgba(61,220,151,0.1); border:1px solid rgba(61,220,151,0.3); border-radius:8px; padding:14px 16px; margin:12px 0; font-size:13px; animation:fadeIn 250ms ease-in">
        <div id="impact-content" style="line-height:1.8"></div>
      </div>

      <div class="form-group">
        <label class="form-label" for="inline-payment-method">Payment method</label>
        <select id="inline-payment-method" required style="width:100%; max-width:400px; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background:var(--bg); color:var(--text); font-family:inherit; font-size:14px">
          <!-- Options populated dynamically based on agreement payment methods -->
        </select>
      </div>

      <!-- Payment method details section (shown automatically when method is selected) -->
      <div id="inline-payment-method-details" class="hidden" style="background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.08); border-radius:8px; padding:16px; margin:-8px 0 16px 0; font-size:14px; line-height:1.8">
        <!-- Method details populated dynamically -->
      </div>

      <div id="inline-payment-proof-section" class="form-group">
        <label class="form-label" id="inline-payment-proof-label" for="inline-payment-proof">Proof of repayment</label>
        <div id="inline-payment-proof-dropzone" style="border:2px dashed rgba(255,255,255,0.2); border-radius:8px; padding:20px; background:rgba(255,255,255,0.02); text-align:center; cursor:pointer; transition:all 0.2s ease; min-height:100px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px">
          <input type="file" id="inline-payment-proof" accept="image/jpeg,image/jpg,image/png,image/heic,image/heif,image/gif,image/webp,.pdf,.doc,.docx,.xls,.xlsx,.csv,.txt" style="display:none">
          <p id="inline-payment-proof-text" style="color:var(--muted); font-size:13px; margin:0">
            Drag and drop your proof here, or click Browse to upload
          </p>
          <button type="button" id="inline-payment-proof-browse-btn" style="padding:8px 16px; font-size:13px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:var(--text); cursor:pointer; font-family:inherit; font-weight:500">
            Browse
          </button>
          <p id="inline-payment-proof-filename" style="color:var(--accent); font-size:12px; margin:0; display:none"></p>
        </div>
      </div>

      <!-- Crypto tip (only visible when payment method is Crypto) -->
      <p id="crypto-tx-tip" class="hidden" style="color:var(--muted); font-size:13px; margin:0 0 16px 0">
        <strong>Tip:</strong> You can also paste the TX hash or blockchain link in the note field.
      </p>

      <div class="form-group">
        <label class="form-label" for="inline-payment-note">Note (optional)</label>
        <input type="text" id="inline-payment-note" placeholder="Add a short note (e.g., paid in two parts)" maxlength="120" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background:var(--bg); color:var(--text); font-family:inherit; font-size:14px">
      </div>

      <div style="display:flex; gap:12px; margin-top:20px">
        <button id="inline-payment-submit" onclick="submitInlinePayment()" style="flex:1">Report repayment</button>
        <button class="secondary" onclick="cancelInlinePaymentForm()" style="flex:0.5">Cancel</button>
      </div>

      <p class="status" id="inline-payment-status" style="margin-top:12px"></p>
    </div>

    <!-- Lender payment action button (for active agreements) -->
    <div id="payment-action-section" class="hidden" style="margin:16px 0">
      <button id="record-payment-btn" class="record-payment-btn" style="width:100%">Report Payment</button>
    </div>

    <!-- Agreement details -->
    <div id="details-section" class="card hidden">
      <!-- Details section -->
      <div style="margin:0 0 16px 0">
        <div class="detail-row">
          <span class="detail-label">Lender name</span>
          <span class="detail-value" id="lender-name"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Borrower name</span>
          <span class="detail-value" id="borrower-name"></span>
        </div>
        <div class="detail-row" id="borrower-email-row" style="display:none">
          <span class="detail-label">Borrower email</span>
          <span class="detail-value" id="borrower-email-display"></span>
        </div>
        <div class="detail-row" id="borrower-phone-row" style="display:none">
          <span class="detail-label">Borrower phone</span>
          <span class="detail-value" id="borrower-phone-display"></span>
        </div>
        <div class="detail-row" id="description-row">
          <span class="detail-label">Description</span>
          <span class="detail-value" id="description-display"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Amount</span>
          <span class="detail-value" id="amount-display"></span>
        </div>
        <div class="detail-row" id="money-sent-row" style="display:none">
          <span class="detail-label">Money transfer date (Loan start)</span>
          <span class="detail-value" id="money-sent-display"></span>
        </div>
        <div class="detail-row" id="loan-duration-row" style="display:none">
          <span class="detail-label">Loan duration</span>
          <span class="detail-value" id="loan-duration-display"></span>
        </div>
        <div class="detail-row" id="repayment-type-row" style="display:none">
          <span class="detail-label">Repayment type</span>
          <span class="detail-value" id="repayment-type-display"></span>
        </div>
        <div class="detail-row" id="installment-plan-row" style="display:none">
          <span class="detail-label">Installment plan</span>
          <span class="detail-value" id="installment-plan-display"></span>
        </div>
        <div class="detail-row" id="interest-rate-row" style="display:none">
          <span class="detail-label">Interest rate</span>
          <span class="detail-value" id="interest-rate-display"></span>
        </div>
        <div class="detail-row" id="total-repay-row" style="display:none">
          <span class="detail-label">Total to repay</span>
          <span class="detail-value" id="total-repay-display"></span>
        </div>
        <div class="detail-row" id="installment-count-row" style="display:none">
          <span class="detail-label">Number of payment installments</span>
          <span class="detail-value" id="installment-count-display"></span>
        </div>
        <div class="detail-row" id="payment-frequency-row" style="display:none">
          <span class="detail-label">Payment frequency</span>
          <span class="detail-value" id="payment-frequency-display"></span>
        </div>
        <div class="detail-row" id="first-payment-row" style="display:none">
          <span class="detail-label">First repayment date</span>
          <span class="detail-value" id="first-payment-display"></span>
        </div>
        <div class="detail-row" id="final-due-row" style="display:none">
          <span class="detail-label">Final due date</span>
          <span class="detail-value">
            <span id="final-due-display"></span>
            <span id="final-due-countdown" style="color:var(--muted); margin-left:8px"></span>
          </span>
        </div>

        <!-- Spacer before one-time payment section (for one-time loans) -->
        <div id="onetime-spacer-before" style="height:16px; display:none"></div>

        <div class="detail-row" id="repayment-type-onetime-row" style="display:none">
          <span class="detail-label">Repayment type</span>
          <span class="detail-value" id="repayment-type-onetime-display"></span>
        </div>
        <div class="detail-row" id="full-due-row" style="display:none">
          <span class="detail-label">Full repayment due date</span>
          <span class="detail-value">
            <span id="full-due-display"></span>
            <span id="full-due-countdown" style="color:var(--muted); margin-left:8px"></span>
          </span>
        </div>

        <!-- Spacer after one-time payment section -->
        <div id="onetime-spacer-after" style="height:16px; display:none"></div>

        <div class="detail-row">
          <span class="detail-label">Status</span>
          <span class="detail-value" id="status-display"></span>
        </div>
      </div>

      <!-- Repayment schedule & interest calculation (collapsible) -->
      <div id="interest-calc-card" class="hidden" style="margin:16px 0">
        <button onclick="toggleReviewSection('interest-calc-detail')" class="secondary" style="width:100%; text-align:left; padding:12px 16px; font-size:14px; display:flex; justify-content:space-between; align-items:center">
          <span>Repayment schedule & interest calculation</span>
          <span id="interest-calc-detail-toggle">▼</span>
        </button>
        <div id="interest-calc-detail" class="hidden" style="background:#10151d; border:1px solid rgba(255,255,255,0.08); border-radius:0 0 8px 8px; padding:16px; margin-top:-1px">
          <div id="interest-calc-detail-content"></div>
        </div>
      </div>

      <!-- Repayment details & reminders (collapsible) -->
      <div id="payments-reminders-card" class="hidden" style="margin:16px 0">
        <button onclick="toggleReviewSection('payments-reminders-detail')" class="secondary" style="width:100%; text-align:left; padding:12px 16px; font-size:14px; display:flex; justify-content:space-between; align-items:center">
          <span>Repayment details & reminders</span>
          <span id="payments-reminders-detail-toggle">▼</span>
        </button>
        <div id="payments-reminders-detail" class="hidden" style="background:#10151d; border:1px solid rgba(255,255,255,0.08); border-radius:0 0 8px 8px; padding:16px; margin-top:-1px">
          <div id="payments-reminders-detail-content"></div>
        </div>
      </div>

      <!-- Payment Methods (only shown for active agreements) -->
      <div id="payment-methods-card" class="hidden" style="margin:16px 0">
        <h3 style="margin:0 0 16px 0; font-size:16px">Payment Methods</h3>
        <div id="payment-methods-content">
          <!-- Populated dynamically by JavaScript -->
        </div>
      </div>

      <!-- Fairness Between Friends (collapsible) -->
      <div id="fairness-card" style="margin:16px 0">
        <button onclick="toggleReviewSection('fairness-detail')" class="secondary" style="width:100%; text-align:left; padding:12px 16px; font-size:14px; display:flex; justify-content:space-between; align-items:center">
          <div style="display:flex; align-items:center; gap:8px; color:var(--accent)">
            <span style="display:inline-flex; align-items:center; width:18px; height:18px; flex-shrink:0;" title="Fairness Between Friends"></span>
            <span>Fairness Between Friends (How it Works)</span>
          </div>
          <span id="fairness-detail-toggle">▼</span>
        </button>
        <script>
          document.currentScript.previousElementSibling.querySelector('div > span:first-child').innerHTML = fairnessIconSVG('', {width:'18px', height:'18px', display:'block'});
        </script>
        <div id="fairness-detail" class="hidden" style="background:#10151d; border:1px solid rgba(255,255,255,0.08); border-radius:0 0 8px 8px; padding:16px; margin-top:-1px">
          <p style="margin:0 0 12px 0; font-size:14px; line-height:1.6">
            PayFriends operates on a fairness principle designed to keep lending between friends transparent and balanced.
            Interest is calculated dynamically on the outstanding balance and the time elapsed.
          </p>
          <ul style="margin:0 0 12px 0; padding-left:20px; font-size:14px; line-height:1.6">
            <li style="margin-bottom:8px"><strong>Early or higher payments</strong> reduce the total interest and, where applicable, lower future installment amounts.</li>
            <li style="margin-bottom:8px"><strong>Late or smaller payments</strong> increase the total interest for the period the amount remains outstanding.</li>
            <li style="margin-bottom:8px">These recalculations happen automatically and are reflected instantly in the agreement for both lender and borrower.</li>
          </ul>
          <p style="margin:0; font-size:14px; line-height:1.6">
            Each repayment entry in the payment history clearly notes when a payment caused a change in the total interest, outstanding balance, or future installments.
            This ensures both parties always see the current, fair value of the loan.
          </p>
        </div>
      </div>

      <!-- Sharing details (collapsible, lender only, for pending agreements) -->
      <div id="share-card" class="hidden" style="margin:16px 0">
        <button onclick="toggleReviewSection('share-detail')" class="secondary" style="width:100%; text-align:left; padding:12px 16px; font-size:14px; display:flex; justify-content:space-between; align-items:center">
          <span>Sharing details</span>
          <span id="share-detail-toggle">▼</span>
        </button>
        <div id="share-detail" class="hidden" style="background:#10151d; border:1px solid rgba(255,255,255,0.08); border-radius:0 0 8px 8px; padding:16px; margin-top:-1px">
          <div id="share-detail-content"></div>
        </div>
      </div>

      <!-- Borrower review actions (only for pending agreements) -->
      <div id="borrower-actions" class="hidden">
        <button onclick="handleAccept()">Accept Agreement</button>
        <button class="secondary" onclick="handleDecline()">Decline</button>
        <button class="tertiary" onclick="handleReviewLater()">Review Later</button>
      </div>

      <!-- Lender actions (only for pending agreements) -->
      <div id="lender-actions" class="hidden">
        <button id="cancel-agreement-btn" class="btn-danger" onclick="openCancelModal()" style="width:100%">Cancel pending agreement</button>
      </div>

      <p class="status" id="action-status"></p>
    </div>

    <!-- Hardship indicator for lender (needs attention alert) -->
    <div id="hardship-indicator" class="card hidden">
      <div class="alert-box">
        <strong>Needs attention:</strong> Borrower has requested help with this payment. Check Activity for details.
      </div>
    </div>

    <!-- Renegotiation panel -->
    <div id="renegotiation-panel" class="renegotiation-container hidden">
      <!-- This will be populated dynamically by JavaScript -->
    </div>

    <!-- Payment history (for active and settled agreements) -->
    <div id="payment-history" class="card hidden">
      <h2>Payment History</h2>
      <div id="payments-list">
        <p style="color:var(--muted); font-size:14px">No payments recorded yet.</p>
      </div>
    </div>

    <!-- Loan Timeline (for all agreements) -->
    <div id="loan-timeline" class="card hidden">
      <h2>Loan Timeline</h2>
      <p style="color:var(--muted); font-size:14px; margin-bottom:16px">Complete history of this loan, including all negotiations and changes.</p>
      <div id="timeline-events">
        <p style="color:var(--muted); font-size:14px">Loading timeline...</p>
      </div>
    </div>

    <!-- Record payment form (for active agreements) -->
    <div id="record-payment-section" class="card hidden">
      <h2 id="payment-form-header">Record a Payment</h2>
      <p id="payment-form-subtitle" style="color:var(--muted); font-size:14px; margin-bottom:16px">
        Record a payment that has been made for this agreement.
      </p>

      <div class="form-group">
        <label class="form-label" for="payment-amount-field">Amount (EUR)</label>
        <input type="number" id="payment-amount-field" placeholder="e.g. 50" min="0" step="0.01">
      </div>

      <div class="form-group">
        <label class="form-label" for="payment-method">Payment method</label>
        <select id="payment-method" required style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background:var(--bg); color:var(--text); font-family:inherit; font-size:14px">
          <option value="">Select method...</option>
          <option value="cash">Cash</option>
          <option value="bank">Bank transfer</option>
          <option value="crypto">Crypto</option>
          <option value="other">Other</option>
        </select>
      </div>

      <div id="payment-proof-section" class="form-group" style="display:none">
        <label class="form-label" id="payment-proof-label" for="payment-proof">Proof of repayment</label>
        <p id="payment-proof-helper" style="color:var(--muted); font-size:12px; margin-bottom:8px">
          Upload a screenshot, photo or PDF that shows this repayment.
        </p>
        <input type="file" id="payment-proof" accept="image/*,.pdf" style="width:100%; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background:var(--bg); color:var(--text); font-family:inherit; font-size:14px">
      </div>

      <div class="form-group">
        <label class="form-label" for="payment-note">Note (optional)</label>
        <textarea id="payment-note" placeholder="Add any details about this payment..."></textarea>
      </div>

      <button id="payment-submit-btn" onclick="submitPayment()">Record Payment</button>
      <button class="secondary" onclick="cancelPaymentForm()">Cancel</button>

      <p class="status" id="payment-status"></p>
    </div>

    <!-- Hardship request form -->
    <div id="hardship-form" class="card hidden">
      <h2>Request Payment Assistance</h2>
      <p style="color:var(--muted); margin-bottom:20px">
        Let us know what's making this payment difficult. We'll share your situation with your friend to work out a new plan together.
      </p>

      <!-- Step 1: Reason -->
      <div class="form-section">
        <div class="form-section-title">What's making it hard to pay on time?</div>

        <div class="form-radio">
          <input type="radio" name="reason" id="reason-unexpected" value="unexpected_expense">
          <label for="reason-unexpected">Unexpected expense (medical, car, etc.)</label>
        </div>

        <div class="form-radio">
          <input type="radio" name="reason" id="reason-income" value="income_lower">
          <label for="reason-income">Income temporarily lower</label>
        </div>

        <div class="form-radio">
          <input type="radio" name="reason" id="reason-job" value="job_loss">
          <label for="reason-job">Lost my job / work changed</label>
        </div>

        <div class="form-radio">
          <input type="radio" name="reason" id="reason-miscalc" value="miscalculated">
          <label for="reason-miscalc">I miscalculated what I could afford</label>
        </div>

        <div class="form-radio">
          <input type="radio" name="reason" id="reason-other" value="other">
          <label for="reason-other">Something else</label>
        </div>
      </div>

      <div class="form-section">
        <div class="form-section-title">Explain in your own words (optional but recommended)</div>
        <textarea id="reason-text" placeholder="Tell your friend more about your situation..."></textarea>
      </div>

      <!-- Step 2: Can pay now -->
      <div class="form-section">
        <div class="form-section-title">Can you pay something now?</div>
        <p style="color:var(--muted); font-size:14px; margin-top:4px; margin-bottom:12px">
          Even a small payment will show your commitment to <span id="lender-first-name-text"></span>.
        </p>

        <div class="form-radio">
          <input type="radio" name="can-pay" id="can-pay-yes" value="yes" onchange="togglePaymentAmount()">
          <label for="can-pay-yes">Yes, I can pay some of it now</label>
        </div>

        <div class="form-radio">
          <input type="radio" name="can-pay" id="can-pay-no" value="no" onchange="togglePaymentAmount()">
          <label for="can-pay-no">No, I can't pay anything right now</label>
        </div>

        <div id="payment-amount-input" class="hidden" style="margin-top:16px">
          <label class="form-label" for="payment-amount">Amount I can pay now (EUR)</label>
          <input type="number" id="payment-amount" placeholder="e.g. 50" min="0" step="1">
        </div>
      </div>

      <!-- Step 3: Preferred adjustments -->
      <div class="form-section">
        <div class="form-section-title">What kind of new plan would feel most realistic for you? (Check all that apply)</div>

        <div class="form-checkbox">
          <input type="checkbox" id="adj-smaller" value="smaller_payments_longer_period">
          <label for="adj-smaller">Pay a smaller amount each month over a longer period</label>
        </div>

        <div class="form-checkbox">
          <input type="checkbox" id="adj-skip" value="skip_or_reduce_next">
          <label for="adj-skip">Skip or reduce this upcoming payment, and increase the later payments to catch up.</label>
        </div>

        <div class="form-checkbox">
          <input type="checkbox" id="adj-partial" value="partial_now_rest_later">
          <label for="adj-partial">Pay part now and move the rest to a later date</label>
        </div>

        <div class="form-checkbox">
          <input type="checkbox" id="adj-lower" value="lower_monthly_higher_interest">
          <label for="adj-lower">Lower the monthly amount, even if the total interest becomes higher and the loan runs longer.</label>
        </div>

        <div class="form-checkbox">
          <input type="checkbox" id="adj-unsure" value="not_sure_please_suggest">
          <label for="adj-unsure">I'm not sure – please suggest something for us</label>
        </div>
      </div>

      <!-- Step 4: Summary -->
      <div class="form-group">
        <label class="form-label">Summary</label>
        <div class="summary-box">
          <p style="margin:0 0 12px 0; color:var(--text)">This is what will be shared with your friend:</p>
          <div class="summary-item">
            <span class="summary-label">Reason:</span> <span id="summary-reason">-</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Can pay now:</span> <span id="summary-pay">-</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Preferred options:</span> <span id="summary-adjustments">-</span>
          </div>
        </div>
      </div>

      <button onclick="submitHardshipRequest()">Send request</button>
      <button class="secondary" onclick="cancelHardshipForm()">Cancel</button>

      <p class="status" id="hardship-status"></p>
    </div>

    <!-- Renegotiation initiation form (Step 0 & 1) -->
    <div id="renegotiation-initiation-form" class="card hidden">
      <h2>Request renegotiation</h2>

      <!-- Step 0: How much can you pay now? -->
      <div class="form-section" id="renegotiation-step-0">
        <div style="background:rgba(255,165,0,0.1); border:1px solid rgba(255,165,0,0.3); border-radius:8px; padding:12px; margin-bottom:16px">
          <p id="expected-payment-context" style="margin:0; font-size:14px; color:var(--text); font-weight:500"></p>
        </div>

        <div class="form-section-title">How much can you pay now?</div>

        <div class="form-group">
          <label class="form-label">Amount (€)</label>
          <input type="number" id="renegotiation-can-pay-now" placeholder="0.00" step="0.01" min="0" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background:var(--bg); color:var(--text); font-size:14px">
          <small id="can-pay-now-microcopy" style="color:var(--muted); font-size:12px; line-height:1.5; display:block; margin-top:8px"></small>
        </div>

        <div class="form-group">
          <label class="form-label">Tell your friend what's going on</label>
          <select id="renegotiation-trouble-reason" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background:var(--bg); color:var(--text); font-size:14px">
            <option value="">Select a reason...</option>
            <option value="unexpected_expenses">Unexpected expenses</option>
            <option value="income_delay">Income delay (salary, client, invoice, etc)</option>
            <option value="budget_tight">My budget is tight this month</option>
            <option value="prefer_not_to_say">I prefer not to say</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="form-group hidden" id="renegotiation-reason-other-container">
          <label class="form-label">Explain in your own words</label>
          <textarea id="renegotiation-reason-other" rows="3" placeholder="Tell your friend more about your situation..."></textarea>
        </div>
      </div>

      <!-- Step 1: Choose solution type -->
      <div class="form-section" id="renegotiation-step-1">
        <div class="form-section-title">What kind of solution would work for you?</div>
        <div id="renegotiation-solution-types"></div>
      </div>

      <button id="renegotiation-submit-btn" onclick="submitRenegotiationRequest()">Send renegotiation request</button>
      <button class="secondary" onclick="cancelRenegotiationForm()">Cancel</button>

      <p class="status" id="renegotiation-initiation-status"></p>
    </div>

    <!-- Error state -->
    <div id="error-section" class="card hidden">
      <h2>Error</h2>
      <p id="error-message">Unable to load agreement details.</p>
      <div style="display:flex; gap:12px; margin-top:16px; flex-wrap:wrap">
        <button id="retry-load-btn" onclick="retryLoad()" style="padding:10px 20px; background:var(--accent); color:#0d130f; border:none; border-radius:10px; font-weight:600; cursor:pointer; font-size:14px">Retry</button>
        <a href="/app" style="display:inline-block; padding:10px 20px; background:#374151; color:#cbd5e1; border-radius:10px; text-decoration:none; font-weight:600">Return to My agreements</a>
      </div>
    </div>
  </div>

  <script>
    let agreement = null;
    let currentUser = null;
    let mode = 'view'; // 'review' or 'view'

    // Helper function to escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Get payment method display info
    function getPaymentMethodInfo(method) {
      const methodMap = {
        'bank': { label: 'Bank Transfer', icon: '🏦' },
        'paypal': { label: 'PayPal', icon: '💳' },
        'crypto': { label: 'Crypto', icon: '₿' },
        'cash': { label: 'Cash', icon: '💵' },
        'other': { label: 'Other Method', icon: '💱' }
      };

      return methodMap[method] || { label: method, icon: '💰' };
    }

    // Initialize shared header
    document.addEventListener('DOMContentLoaded', async () => {
      await PayFriendsHeader.initialize();
      initializePage();

      // Add event listener for trouble reason dropdown to show/hide "Other" textarea
      const troubleReasonDropdown = document.getElementById('renegotiation-trouble-reason');
      const otherContainer = document.getElementById('renegotiation-reason-other-container');

      if (troubleReasonDropdown && otherContainer) {
        troubleReasonDropdown.addEventListener('change', function() {
          if (this.value === 'other') {
            otherContainer.classList.remove('hidden');
          } else {
            otherContainer.classList.add('hidden');
          }
        });
      }
    });
    const pathParts = window.location.pathname.split('/');
    const agreementId = pathParts[2];
    const action = pathParts[3]; // 'review' or 'view'

    // For agreements list
    let allAgreements = [];
    let currentFilter = 'all';

    // Currency formatters are loaded from /js/formatters.js
    // - formatCurrency0(cents) - for compact displays (no decimals, nl-NL locale)
    // - formatCurrency2(cents) - for details and schedules (2 decimals, nl-NL locale)
    // - formatEuro0(euros), formatEuro2(euros) - for euro amounts (not cents)

    // Generate initials for user avatar
    function getInitials(name) {
      if (!name) return '?';
      const parts = name.trim().split(/\s+/);
      if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
      return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
    }

    // Get avatar color based on name
    function getAvatarColor(name) {
      if (!name) return 'color-1';
      const hash = name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
      return `color-${(hash % 7) + 1}`;
    }

    async function loadAgreementData() {
      try {
        // Get current user from shared header
        currentUser = PayFriendsHeader.getCurrentUser();

        if (!currentUser) {
          window.location.href = '/';
          return;
        }

        // Fetch agreement
        const res = await fetch(`/api/agreements/${agreementId}`);
        if (!res.ok) {
          // Try to parse error message from response
          let errorMsg = 'Agreement not found or you do not have access to it.';
          try {
            const errorData = await res.json();
            if (errorData.error) {
              errorMsg = errorData.error;
            }
          } catch (e) {
            // Use default error message if response is not JSON
          }

          if (res.status === 404) {
            errorMsg = 'Agreement not found. It may have been deleted or you may not have access to it.';
          } else if (res.status === 403) {
            errorMsg = 'You do not have permission to view this agreement.';
          } else if (res.status >= 500) {
            errorMsg = 'Server error. Please try again later.';
          }

          showError(errorMsg);
          return;
        }
        agreement = await res.json();

        if (!agreement || typeof agreement !== 'object') {
          showError('Invalid agreement data received.');
          return;
        }

        // Determine mode based on URL and user role
        const isLender = agreement.lender_user_id === currentUser.id;
        const isBorrower = agreement.borrower_user_id === currentUser.id;

        if (action === 'review' && isBorrower && agreement.status === 'pending') {
          mode = 'review';
          showReviewSection();
        } else {
          mode = 'view';
          showViewSection();
        }
      } catch (err) {
        console.error('Error loading agreement:', err);
        showError('An error occurred while loading the agreement. Please check your connection and try again.');
      }
    }

    async function showReviewSection() {
      // Hide loading card and clear loading text
      document.getElementById('loading-card').classList.add('hidden');
      document.getElementById('loading-text').textContent = '';
      document.getElementById('details-section').classList.remove('hidden');

      // Hide My Agreements section when in review mode
      document.getElementById('list-section').classList.add('hidden');

      // Show top bar for review mode
      const description = agreement.description || 'Agreement';

      // Dynamically import and render the top bar
      try {
        const { renderPageTopbar } = await import('/components/page-topbar.js');
        const topbar = renderPageTopbar({
          title: 'Review agreement',
          subtitle: description,
          href: '/app'
        });

        // Clear and append the top bar
        const manageHeader = document.getElementById('manage-header');
        manageHeader.innerHTML = '';
        manageHeader.appendChild(topbar);
        manageHeader.classList.remove('hidden');
      } catch (err) {
        console.error('Error loading top bar component:', err);
      }

      populateDetails();

      // Explicitly hide all payment-related sections for review page
      document.getElementById('payment-action-section').classList.add('hidden');
      document.getElementById('hardship-indicator').classList.add('hidden');
      document.getElementById('payment-history').classList.add('hidden');
      document.getElementById('record-payment-section').classList.add('hidden');
      document.getElementById('hardship-form').classList.add('hidden');
      document.getElementById('error-section').classList.add('hidden');

      // Check if agreement is cancelled
      if (agreement.status === 'cancelled') {
        // Show cancelled message, hide all action buttons
        document.getElementById('borrower-actions').classList.add('hidden');
        document.getElementById('lender-actions').classList.add('hidden');
      } else {
        // Show borrower actions
        document.getElementById('borrower-actions').classList.remove('hidden');
        document.getElementById('lender-actions').classList.add('hidden');
      }
    }

    async function showViewSection() {
      // Hide loading card and clear loading text
      document.getElementById('loading-card').classList.add('hidden');
      document.getElementById('loading-text').textContent = '';
      document.getElementById('details-section').classList.remove('hidden');

      // Hide My Agreements section when viewing a specific agreement
      document.getElementById('list-section').classList.add('hidden');

      // Show and populate manage header with new top bar component
      const borrowerName = agreement.borrower_full_name || agreement.friend_first_name || agreement.borrower_email;
      const description = agreement.description || 'Agreement';

      // Dynamically import and render the top bar with status badge
      try {
        const { renderPageTopbar } = await import('/components/page-topbar.js');
        const { getStatusLabel, getStatusBadgeStyle } = await import('/js/status-labels.js');

        // Prepare status badge
        const statusText = agreement.status || 'pending';
        const borrowerFirstName = borrowerName.split(' ')[0];
        const statusLabel = getStatusLabel(statusText, borrowerFirstName);
        const statusBadgeStyle = getStatusBadgeStyle(statusText);

        const topbar = renderPageTopbar({
          title: 'Manage agreement',
          subtitle: `${description} — ${borrowerName}`,
          href: '/app',
          statusBadge: {
            text: statusLabel,
            style: statusBadgeStyle
          }
        });

        // Clear and append the top bar
        const manageHeader = document.getElementById('manage-header');
        manageHeader.innerHTML = '';
        manageHeader.appendChild(topbar);
        manageHeader.classList.remove('hidden');
      } catch (err) {
        console.error('Error loading top bar component:', err);
        // Fallback to old header if import fails
        document.getElementById('manage-subline').textContent = `${description} – ${borrowerName}`;
        document.getElementById('manage-header').classList.remove('hidden');
      }

      populateDetails();

      // Hide borrower actions
      document.getElementById('borrower-actions').classList.add('hidden');

      const isLender = agreement.lender_user_id === currentUser.id;
      const isBorrower = agreement.borrower_user_id === currentUser.id;

      // Check if this is a lender viewing a pending agreement
      if (isLender && agreement.status === 'pending') {
        // Show lender actions (cancel button)
        document.getElementById('lender-actions').classList.remove('hidden');
      } else {
        // Hide lender actions
        document.getElementById('lender-actions').classList.add('hidden');
      }

      // Show payment sections for active and settled agreements
      if (agreement.status === 'active' || agreement.status === 'settled') {
        await loadPaymentData();

        // Check for hardship requests
        const hasHardshipRequests = await checkHardshipRequests();

        // Show hardship indicator for lender if there are requests
        if (isLender && hasHardshipRequests && agreement.status === 'active') {
          document.getElementById('hardship-indicator').classList.remove('hidden');
        }

        // Load and display active renegotiation
        await loadAndDisplayRenegotiation();

        // Load and display loan timeline
        await loadLoanTimeline();

        // Show next payment card for borrower on active agreements
        // This card now includes both action buttons inside
        showNextPaymentCard();

        // Show payment action button for lenders on active agreements
        if (isLender && agreement.status === 'active') {
          showPaymentActionButton();
        }
      }
    }

    // Calculate time until/since due date
    function getDueDateCountdown(dueDate) {
      const now = new Date();
      const due = new Date(dueDate);
      const diffMs = due - now;
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

      if (diffDays > 0) {
        return `(in ${diffDays} day${diffDays === 1 ? '' : 's'})`;
      } else if (diffDays === 0) {
        return '(today)';
      } else {
        const overdueDays = Math.abs(diffDays);
        return `(${overdueDays} day${overdueDays === 1 ? '' : 's'} overdue)`;
      }
    }

    function showNextPaymentCard() {
      // Only show for borrowers on active agreements
      const isBorrower = agreement.borrower_user_id === currentUser.id;

      if (!isBorrower || agreement.status !== 'active') {
        document.getElementById('next-payment-card').classList.add('hidden');
        return;
      }

      const isInstallmentLoan = agreement.repayment_type === 'installments';
      const isOneTimeRepayment = agreement.repayment_type === 'one_time';

      // For installment loans, use the new unified helper
      if (isInstallmentLoan) {
        const installmentStatus = getNextInstallmentStatus({ agreement });

        if (installmentStatus.status === 'paidOff' || installmentStatus.status === 'none') {
          document.getElementById('next-payment-card').classList.add('hidden');
          return;
        }

        const cardEl = document.getElementById('next-payment-card');
        const labelEl = document.getElementById('next-payment-label');
        const amountEl = document.getElementById('next-payment-amount');
        const dueDateEl = document.getElementById('next-payment-due-date');
        const subtitleEl = document.getElementById('next-payment-subtitle');
        const plannedEl = document.getElementById('next-payment-planned');

        const amountFormatted = formatCurrency2(installmentStatus.amountDue);
        const dateFormatted = formatDate(installmentStatus.dueDate);

        // Handle overdue state
        if (installmentStatus.status === 'overdue') {
          // Red warning styling for overdue
          cardEl.style.border = '1px solid #dc2626';
          cardEl.style.backgroundColor = 'rgba(220, 38, 38, 0.05)';

          labelEl.textContent = 'Payment overdue';
          labelEl.style.color = '#dc2626';

          amountEl.textContent = amountFormatted;
          amountEl.style.color = '#dc2626';

          const daysText = installmentStatus.daysOverdue === 1 ? 'day' : 'days';
          dueDateEl.textContent = `was due on ${dateFormatted} (${installmentStatus.daysOverdue} ${daysText} ago). Extra interest is being calculated fairly according to your agreement.`;
          dueDateEl.style.color = '#dc2626';
          dueDateEl.style.display = 'block';

          subtitleEl.style.display = 'none';
          plannedEl.style.display = 'none';
        } else {
          // Upcoming state - green/normal styling
          cardEl.style.border = '';
          cardEl.style.backgroundColor = '';

          labelEl.textContent = 'Next payment of';
          labelEl.style.color = 'var(--muted)';

          amountEl.textContent = amountFormatted;
          amountEl.style.color = 'var(--accent)';

          // Format due date line
          let dueDateText;
          if (installmentStatus.daysUntilDue === 0) {
            dueDateText = `due today`;
          } else {
            const daysText = installmentStatus.daysUntilDue === 1 ? 'day' : 'days';
            dueDateText = `due on ${dateFormatted} (in ${installmentStatus.daysUntilDue} ${daysText})`;
          }

          dueDateEl.textContent = dueDateText;
          dueDateEl.style.color = 'var(--muted)';
          dueDateEl.style.display = 'block';

          subtitleEl.style.display = 'none';
          plannedEl.style.display = 'none';
        }

        // Set up the "Report payment" button
        const recordBtn = document.getElementById('borrower-record-payment-btn');
        const lenderName = (agreement.lender_full_name || agreement.lender_name || agreement.lender_email).split(' ')[0];
        recordBtn.onclick = () => toggleInlinePaymentForm(lenderName, installmentStatus.nextPaymentInfo);

        // Show the card
        cardEl.classList.remove('hidden');
        return;
      }

      // For one-time loans with dynamic interest, use the existing logic
      let nextPaymentInfo;
      let todayAmount, plannedAmount, todayInterest, plannedInterest;

      if (isOneTimeRepayment && agreement.today_total_due_cents !== undefined) {
        // Use dynamic interest fields from API
        todayAmount = agreement.today_total_due_cents;
        plannedAmount = agreement.planned_total_due_cents;
        todayInterest = agreement.today_interest_cents || 0;
        plannedInterest = agreement.planned_interest_max_cents || 0;

        const outstanding = todayAmount - (agreement.total_paid_cents || 0);

        if (outstanding <= 0) {
          document.getElementById('next-payment-card').classList.add('hidden');
          return;
        }

        nextPaymentInfo = {
          amount_cents: outstanding,
          due_date: agreement.due_date,
          schedule_row: null
        };
      } else {
        // Calculate next payment info using existing logic
        nextPaymentInfo = getNextPaymentInfo(agreement);

        if (!nextPaymentInfo) {
          document.getElementById('next-payment-card').classList.add('hidden');
          return;
        }
      }

      // Reset card styling for one-time loans
      const cardEl = document.getElementById('next-payment-card');
      cardEl.style.border = '';
      cardEl.style.backgroundColor = '';

      // Populate the card with payment info
      const amountFormatted = formatCurrency2(nextPaymentInfo.amount_cents);
      const dateFormatted = formatDate(nextPaymentInfo.due_date);

      // Set the label based on repayment type
      const labelText = isOneTimeRepayment ? 'Payment due today' : 'Next payment due';

      const labelEl = document.getElementById('next-payment-label');
      const amountEl = document.getElementById('next-payment-amount');
      const dueDateEl = document.getElementById('next-payment-due-date');

      labelEl.textContent = labelText;
      labelEl.style.color = 'var(--muted)';

      amountEl.textContent = amountFormatted;
      amountEl.style.color = 'var(--accent)';

      dueDateEl.style.display = 'none';

      // For one-time loans with dynamic interest, show additional info
      const subtitleEl = document.getElementById('next-payment-subtitle');
      const plannedEl = document.getElementById('next-payment-planned');

      if (isOneTimeRepayment && todayInterest !== undefined) {
        const interestFormatted = formatCurrency2(todayInterest);
        subtitleEl.textContent = `Includes ${interestFormatted} interest accumulated so far`;
        subtitleEl.style.display = 'block';

        // Show planned amount if different from today
        if (plannedAmount && plannedAmount > todayAmount) {
          const plannedFormatted = formatCurrency2(plannedAmount);
          const plannedInterestFormatted = formatCurrency2(plannedInterest);
          plannedEl.innerHTML = `If you wait until full repayment date (${dateFormatted}): about ${plannedFormatted} (includes ${plannedInterestFormatted} interest for the planned period)`;
          plannedEl.style.display = 'block';
        } else {
          plannedEl.style.display = 'none';
        }
      } else {
        subtitleEl.style.display = 'none';
        plannedEl.style.display = 'none';
      }

      // Set up the "Report payment" button to toggle inline form
      const recordBtn = document.getElementById('borrower-record-payment-btn');
      const lenderName = (agreement.lender_full_name || agreement.lender_name || agreement.lender_email).split(' ')[0];
      recordBtn.onclick = () => toggleInlinePaymentForm(lenderName, nextPaymentInfo);

      // Show the card
      cardEl.classList.remove('hidden');
    }

    function toggleInlinePaymentForm(lenderName, nextPaymentInfo) {
      const inlineFormCard = document.getElementById('inline-payment-form-card');
      const reportBtn = document.getElementById('borrower-record-payment-btn');
      const isHidden = inlineFormCard.classList.contains('hidden');

      if (isHidden) {
        // Show the form card
        inlineFormCard.classList.remove('hidden');

        // Hide the "Report a payment" button to avoid redundancy
        reportBtn.classList.add('hidden');

        // Set lender name in subtitle
        document.getElementById('inline-lender-name').textContent = lenderName;

        // Set lender name in submit button
        const submitBtn = document.getElementById('inline-payment-submit');
        submitBtn.textContent = `Report repayment to ${lenderName}`;

        // Set fairness explanation text based on repayment type
        const fairnessDetail = document.getElementById('fairness-explanation-detail');
        if (agreement.repayment_type === 'one_time') {
          fairnessDetail.textContent = 'Paying earlier reduces interest, so your total repayment becomes lower.';
        } else {
          fairnessDetail.textContent = 'Paying more than the due amount lowers interest and adjusts future installments. (Try adding a higher amount to see the changes)';
        }

        // Populate payment methods based on agreement
        const paymentMethodSelect = document.getElementById('inline-payment-method');
        paymentMethodSelect.innerHTML = '';

        // Get allowed methods from agreement
        const allowedMethods = agreement.payment_preference_method
          ? agreement.payment_preference_method.split(',').map(m => m.trim())
          : [];

        // Map method values to display names
        const methodNames = {
          'bank': 'Bank transfer',
          'cash': 'Cash',
          'revolut': 'Revolut',
          'bizum': 'Bizum',
          'paypal': 'PayPal',
          'crypto': 'Crypto',
          'any': 'Any method',
          'other': 'Other'
        };

        // Populate dropdown with only allowed methods
        if (allowedMethods.length > 0) {
          // If multiple methods, add placeholder
          if (allowedMethods.length > 1) {
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = 'Select method...';
            paymentMethodSelect.appendChild(placeholder);
          }

          // Add allowed methods
          allowedMethods.forEach(method => {
            const option = document.createElement('option');
            option.value = method;
            option.textContent = methodNames[method] || method;
            // If only one method, auto-select it
            if (allowedMethods.length === 1) {
              option.selected = true;
            }
            paymentMethodSelect.appendChild(option);
          });
        } else {
          // Fallback: show all methods if none specified
          const placeholder = document.createElement('option');
          placeholder.value = '';
          placeholder.textContent = 'Select method...';
          paymentMethodSelect.appendChild(placeholder);

          Object.keys(methodNames).forEach(method => {
            const option = document.createElement('option');
            option.value = method;
            option.textContent = methodNames[method];
            paymentMethodSelect.appendChild(option);
          });
        }

        // Set proof requirement based on agreement
        const proofInput = document.getElementById('inline-payment-proof');
        const proofLabel = document.getElementById('inline-payment-proof-label');

        if (agreement.proof_required) {
          proofLabel.textContent = 'Proof of repayment*';
          proofInput.required = true;
        } else {
          proofLabel.textContent = 'Proof of repayment (optional)';
          proofInput.required = false;
        }

        // Set up payment method details toggle
        setupPaymentMethodToggle(agreement, allowedMethods.length === 1);

        // Set up autofill inline link
        const autofillLink = document.getElementById('autofill-amount-link');
        const amountInput = document.getElementById('inline-payment-amount');

        // Show "Amount due today" label
        const dueTodayLabel = document.getElementById('amount-due-today-label');
        const amountDueTodayFormatted = formatCurrency2(nextPaymentInfo.amount_cents);
        dueTodayLabel.textContent = `Amount due today: ${amountDueTodayFormatted}`;

        // Show early payment tip for one-time loans
        const earlyPaymentTip = document.getElementById('early-payment-tip');
        if (agreement.repayment_type === 'one_time' && agreement.interest_rate > 0) {
          earlyPaymentTip.textContent = 'Paying earlier lowers interest and future amounts.';
          earlyPaymentTip.style.display = 'block';
        } else {
          earlyPaymentTip.style.display = 'none';
        }

        autofillLink.onclick = () => {
          const amountInEuros = (nextPaymentInfo.amount_cents / 100).toFixed(2);
          amountInput.value = amountInEuros;
          // Trigger update of helper text and impact box
          updatePaymentHelpers(nextPaymentInfo);
        };

        // Add input listener to amount field
        amountInput.addEventListener('input', () => updatePaymentHelpers(nextPaymentInfo));

        // Set up drag and drop for proof of repayment
        setupProofDropzone();

        // Scroll to form
        inlineFormCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      } else {
        // Hide the form (same as cancel)
        cancelInlinePaymentForm();
      }
    }

    function setupProofDropzone() {
      const dropzone = document.getElementById('inline-payment-proof-dropzone');
      const fileInput = document.getElementById('inline-payment-proof');
      const browseBtn = document.getElementById('inline-payment-proof-browse-btn');
      const filenameDisplay = document.getElementById('inline-payment-proof-filename');
      const textDisplay = document.getElementById('inline-payment-proof-text');

      // Browse button click
      browseBtn.onclick = (e) => {
        e.preventDefault();
        e.stopPropagation();
        fileInput.click();
      };

      // Click on dropzone to open file picker
      dropzone.onclick = (e) => {
        if (e.target !== browseBtn) {
          fileInput.click();
        }
      };

      // File input change
      fileInput.onchange = () => {
        if (fileInput.files.length > 0) {
          const file = fileInput.files[0];
          filenameDisplay.textContent = `Selected: ${file.name}`;
          filenameDisplay.style.display = 'block';
          textDisplay.style.display = 'none';
          browseBtn.textContent = 'Change file';
          dropzone.style.borderColor = 'var(--accent)';
          dropzone.style.background = 'rgba(61,220,151,0.05)';
        }
      };

      // Drag and drop events
      dropzone.ondragover = (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.style.borderColor = 'var(--accent)';
        dropzone.style.background = 'rgba(61,220,151,0.1)';
      };

      dropzone.ondragleave = (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.style.borderColor = 'rgba(255,255,255,0.2)';
        dropzone.style.background = 'rgba(255,255,255,0.02)';
      };

      dropzone.ondrop = (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.style.borderColor = 'rgba(255,255,255,0.2)';
        dropzone.style.background = 'rgba(255,255,255,0.02)';

        if (e.dataTransfer.files.length > 0) {
          fileInput.files = e.dataTransfer.files;
          const file = e.dataTransfer.files[0];
          filenameDisplay.textContent = `Selected: ${file.name}`;
          filenameDisplay.style.display = 'block';
          textDisplay.style.display = 'none';
          browseBtn.textContent = 'Change file';
          dropzone.style.borderColor = 'var(--accent)';
          dropzone.style.background = 'rgba(61,220,151,0.05)';
        }
      };
    }

    function setupPaymentMethodToggle(agreement, autoSelected) {
      const paymentMethodSelect = document.getElementById('inline-payment-method');
      const detailsSection = document.getElementById('inline-payment-method-details');

      // Render payment method details
      function renderMethodDetails(methodValue) {
        const methodInfo = getPaymentMethodInfo(methodValue);

        // Try to get details from payment_methods_json
        let methodDetails = null;

        if (agreement.payment_methods_json) {
          try {
            const paymentMethods = JSON.parse(agreement.payment_methods_json);
            const activeMethod = paymentMethods.find(pm => pm.method === methodValue && pm.status === 'active');
            if (activeMethod) {
              methodDetails = activeMethod.details;
            }
          } catch (e) {
            console.error('Error parsing payment methods JSON:', e);
          }
        }

        let html = `<div style="font-size:14px; line-height:1.8; color:var(--text)">`;
        html += `<p style="margin:0 0 12px 0; font-weight:600">${methodInfo.icon} ${methodInfo.label}</p>`;

        if (methodValue === 'cash') {
          html += `<p style="margin:0; color:var(--muted)">Pay in cash directly to the lender.</p>`;
        } else if (methodDetails) {
          html += `<div style="white-space:pre-wrap; font-family:monospace; background:rgba(0,0,0,0.2); padding:12px; border-radius:6px; margin:8px 0">${escapeHtml(methodDetails)}</div>`;
        } else {
          // Fallback to legacy fields
          if (methodValue === 'bank' && agreement.payment_bank_details) {
            html += `<div style="white-space:pre-wrap; font-family:monospace; background:rgba(0,0,0,0.2); padding:12px; border-radius:6px; margin:8px 0">${escapeHtml(agreement.payment_bank_details)}</div>`;
          } else if (methodValue === 'paypal' && agreement.payment_paypal_email) {
            html += `<p style="margin:0; color:var(--muted)">PayPal email: <strong>${escapeHtml(agreement.payment_paypal_email)}</strong></p>`;
          } else if (methodValue === 'crypto' && agreement.payment_crypto_address) {
            html += `<div style="white-space:pre-wrap; font-family:monospace; background:rgba(0,0,0,0.2); padding:12px; border-radius:6px; margin:8px 0">${escapeHtml(agreement.payment_crypto_address)}</div>`;
          } else if (methodValue === 'other' && agreement.payment_other_description) {
            html += `<div style="white-space:pre-wrap; background:rgba(0,0,0,0.2); padding:12px; border-radius:6px; margin:8px 0">${escapeHtml(agreement.payment_other_description)}</div>`;
          } else {
            html += `<p style="margin:0; color:var(--muted)">No additional details provided.</p>`;
          }
        }

        html += `</div>`;

        detailsSection.innerHTML = html;
      }

      // Function to update payment method details visibility
      function updateMethodDetails() {
        const selectedMethod = paymentMethodSelect.value;

        if (!selectedMethod) {
          // No method selected - hide details
          detailsSection.classList.add('hidden');
        } else {
          // Method selected - show details automatically
          renderMethodDetails(selectedMethod);
          detailsSection.classList.remove('hidden');
        }
      }

      // Function to update crypto tip visibility
      function updateCryptoTip() {
        const cryptoTip = document.getElementById('crypto-tx-tip');
        if (cryptoTip) {
          const selectedMethod = paymentMethodSelect.value;
          if (selectedMethod === 'crypto') {
            cryptoTip.classList.remove('hidden');
          } else {
            cryptoTip.classList.add('hidden');
          }
        }
      }

      // Set up event listeners
      paymentMethodSelect.addEventListener('change', () => {
        // Show/hide details based on selected method
        updateMethodDetails();

        // Update crypto tip visibility
        updateCryptoTip();
      });

      // Initial setup - if method is auto-selected, show details
      if (autoSelected) {
        updateMethodDetails();
      }

      // Initial crypto tip visibility update
      updateCryptoTip();
    }

    function updatePaymentHelpers(nextPaymentInfo) {
      const amountInput = document.getElementById('inline-payment-amount');
      const helperText = document.getElementById('amount-helper-text');
      const impactBox = document.getElementById('live-impact-box');

      const inputAmount = parseFloat(amountInput.value) || 0;
      const inputCents = Math.round(inputAmount * 100);
      const nextDueCents = nextPaymentInfo.amount_cents;
      const nextDueAmount = (nextDueCents / 100).toFixed(2);
      const nextDueDate = formatDate(nextPaymentInfo.due_date);

      // Get total outstanding amount (use today_total_due_cents if available, otherwise outstanding_cents)
      const totalOutstandingCents = agreement.today_total_due_cents
        ? (agreement.today_total_due_cents - (agreement.total_paid_cents || 0))
        : (agreement.outstanding_cents || nextDueCents);

      // Clear helper text and hide impact box initially
      helperText.textContent = '';
      impactBox.classList.add('hidden');

      if (inputCents === 0) {
        // No input yet
        return;
      }

      // Check for overpayment vs total outstanding first
      if (inputCents > totalOutstandingCents && totalOutstandingCents > 0) {
        // True overpayment - exceeds total outstanding
        const reportedFormatted = formatCurrency2(inputCents);
        const outstandingFormatted = formatCurrency2(totalOutstandingCents);
        const overpaidCents = inputCents - totalOutstandingCents;
        const overpaidFormatted = formatCurrency2(overpaidCents);

        helperText.innerHTML = `<strong>Note:</strong> You are reporting ${reportedFormatted} while you only owe ${outstandingFormatted}. The extra ${overpaidFormatted} will be recorded as an overpayment. Your loan will be marked as fully repaid.`;
        helperText.style.color = '#3ddc97';
        // Don't show impact box for true overpayment
        return;
      }

      if (inputCents === nextDueCents) {
        // Regular payment
        helperText.innerHTML = `You're reporting your scheduled payment.`;
        helperText.style.color = 'var(--muted)';
      } else if (inputCents < nextDueCents) {
        // Partial payment
        const remaining = ((nextDueCents - inputCents) / 100).toFixed(2);
        helperText.innerHTML = `You're reporting <strong>less</strong> than the next due amount. <strong>€${remaining}</strong> remains due on <strong>${nextDueDate}</strong>.`;
        helperText.style.color = 'var(--muted)';
      } else {
        // Paying more than next scheduled (but not more than total outstanding)
        helperText.innerHTML = 'Great — paying more than scheduled reduces your total interest.';
        const loanType = agreement.repayment_type;
        if (loanType === 'installments') {
          helperText.innerHTML += ' Your future <strong>repayment</strong> amounts will drop; interest will drop too.';
        }
        helperText.style.color = 'rgba(61,220,151,0.9)';

        // Show live impact box
        showLiveImpactBox(inputCents);
      }
    }

    function showLiveImpactBox(paymentCents) {
      const impactBox = document.getElementById('live-impact-box');
      const impactContent = document.getElementById('impact-content');
      const loanType = agreement.repayment_type;

      // Calculate impact
      const impact = calculatePaymentImpact(agreement, paymentCents);

      if (!impact) {
        impactBox.classList.add('hidden');
        return;
      }

      let html = '';

      if (loanType === 'installments') {
        html = `
          <div><strong>Interest saved:</strong> €${impact.interestSaved}</div>
          <div><strong>Remaining balance:</strong> €${impact.balanceBefore} → €${impact.balanceAfter}</div>
          <div><strong>Future repayment (excl. interest):</strong> €${impact.repaymentBefore} → €${impact.repaymentAfter}</div>
          <div><strong>New total due projection:</strong> €${impact.newTotalDue}</div>
        `;
      } else {
        // One-time loan
        html = `
          <div><strong>Remaining balance:</strong> €${impact.balanceBefore} → €${impact.balanceAfter}</div>
          <div><strong>Total if you repay now:</strong> €${impact.totalToday}</div>
          <div><strong>You save:</strong> €${impact.futureInterestSaved} in future interest</div>
        `;
      }

      impactContent.innerHTML = html;
      impactBox.classList.remove('hidden');
    }

    function calculatePaymentImpact(agreement, paymentCents) {
      const loanType = agreement.repayment_type;
      const principalCents = agreement.amount_cents || 0;
      const totalPaidCents = agreement.total_paid_cents || 0;
      const outstandingCents = principalCents - totalPaidCents;
      const annualRate = agreement.interest_rate || 0;

      if (annualRate === 0 || paymentCents <= 0) {
        // No interest, can't show meaningful impact
        return null;
      }

      const balanceBefore = (outstandingCents / 100).toFixed(2);
      const balanceAfter = Math.max(0, (outstandingCents - paymentCents) / 100).toFixed(2);

      if (loanType === 'installments') {
        // Installment loan calculation
        const installmentAmount = agreement.installment_amount || 0;
        const installmentCents = Math.round(installmentAmount * 100);
        const installmentCount = agreement.installment_count || 0;
        const paymentFrequency = agreement.payment_frequency || 'monthly';

        // Calculate periods per year
        const periodsPerYear = {
          'weekly': 52,
          'biweekly': 26,
          'every_4_weeks': 13,
          'monthly': 12,
          'quarterly': 4,
          'yearly': 1
        }[paymentFrequency] || 12;

        const periodRate = annualRate / 100 / periodsPerYear;

        // Current schedule (before overpayment)
        const numPaymentsMade = Math.floor(totalPaidCents / installmentCents);
        const remainingPeriods = Math.max(0, installmentCount - numPaymentsMade);

        // Simple interest calculation for current schedule
        const currentTotalInterest = outstandingCents * (annualRate / 100) * (remainingPeriods / periodsPerYear);
        const currentRepaymentPerPeriod = installmentAmount;

        // After overpayment
        const excessPayment = paymentCents - installmentCents;
        const newOutstanding = Math.max(0, outstandingCents - excessPayment);

        // Recalculate interest on reduced principal
        const newTotalInterest = newOutstanding * (annualRate / 100) * (remainingPeriods / periodsPerYear);
        const newRepaymentPerPeriod = remainingPeriods > 0 ? newOutstanding / remainingPeriods / 100 : 0;

        const interestSaved = ((currentTotalInterest - newTotalInterest) / 100).toFixed(2);
        const repaymentBefore = currentRepaymentPerPeriod.toFixed(2);
        const repaymentAfter = newRepaymentPerPeriod.toFixed(2);
        const newTotalDue = ((newOutstanding + newTotalInterest) / 100).toFixed(2);

        return {
          interestSaved,
          balanceBefore,
          balanceAfter,
          repaymentBefore,
          repaymentAfter,
          newTotalDue
        };

      } else {
        // One-time loan
        const dueDate = new Date(agreement.due_date);
        const today = new Date();

        // Calculate accrued interest to today
        const startDate = new Date(agreement.start_date || agreement.created_at);
        const daysElapsed = Math.max(0, Math.floor((today - startDate) / (1000 * 60 * 60 * 24)));
        const accruedInterest = (outstandingCents * (annualRate / 100) * (daysElapsed / 365));

        const totalToday = ((outstandingCents + accruedInterest) / 100).toFixed(2);

        // Calculate remaining interest if paid at due date
        const totalDays = Math.max(0, Math.floor((dueDate - startDate) / (1000 * 60 * 60 * 24)));
        const fullInterest = (outstandingCents * (annualRate / 100) * (totalDays / 365));

        // After this payment
        const newPrincipal = Math.max(0, outstandingCents - paymentCents);
        const remainingDays = Math.max(0, Math.floor((dueDate - today) / (1000 * 60 * 60 * 24)));
        const newInterest = (newPrincipal * (annualRate / 100) * (remainingDays / 365));

        const futureInterestSaved = ((fullInterest - newInterest) / 100).toFixed(2);

        return {
          balanceBefore,
          balanceAfter,
          totalToday,
          futureInterestSaved
        };
      }
    }

    /**
     * Generate payment impact annotation HTML for a completed payment
     * This calculates what the next payment was at the time of this payment
     * and generates an annotation showing the impact (partial, overpay, etc.)
     */
    function generatePaymentAnnotation(payment, agreementSnapshot) {
      // Only show annotations for approved payments
      if (payment.status !== 'approved') {
        return '';
      }

      const paymentCents = payment.amount_cents;
      const loanType = agreementSnapshot.repayment_type;

      // Calculate next payment info at the time of this payment
      const nextPaymentInfo = getNextPaymentInfo(agreementSnapshot);

      if (!nextPaymentInfo) {
        return '';
      }

      const nextDueCents = nextPaymentInfo.amount_cents;
      const nextDueAmount = (nextDueCents / 100).toFixed(2);
      const nextDueDate = formatDate(nextPaymentInfo.due_date);

      const tooltipText = "Change in repayment recalculated automatically. Both friends see updates instantly.";
      const tooltip = `<span class="payment-impact-tooltip" data-tooltip="${tooltipText}">ℹ️</span>`;

      // Partial payment
      if (paymentCents < nextDueCents) {
        const remaining = ((nextDueCents - paymentCents) / 100).toFixed(2);
        return `
          <div class="payment-impact-annotation">
            Partial payment — €${remaining} remains due on ${nextDueDate}.
          </div>
        `;
      }

      // Exact payment
      if (paymentCents === nextDueCents) {
        return ''; // No annotation needed for exact payments
      }

      // Overpayment - calculate impact
      const impact = calculatePaymentImpact(agreementSnapshot, paymentCents);
      if (!impact) {
        return ''; // No interest, can't show meaningful impact
      }

      const excess = ((paymentCents - nextDueCents) / 100).toFixed(2);
      const interestBadge = parseFloat(impact.interestSaved) > 0
        ? `<span class="payment-impact-badge">Interest saved</span>`
        : '';

      if (loanType === 'installments') {
        return `
          <div class="payment-impact-annotation">
            Overpaid by €${excess} → Interest −€${impact.interestSaved}; repayment (excl. interest) €${impact.repaymentBefore} → €${impact.repaymentAfter}.${interestBadge}${tooltip}
          </div>
        `;
      } else {
        // One-time loan
        const newTotal = impact.balanceAfter;
        return `
          <div class="payment-impact-annotation">
            Overpaid by €${excess} → Interest −€${impact.futureInterestSaved}. New total due: €${newTotal}.${interestBadge}${tooltip}
          </div>
        `;
      }
    }

    function cancelInlinePaymentForm() {
      const inlineFormCard = document.getElementById('inline-payment-form-card');
      const reportBtn = document.getElementById('borrower-record-payment-btn');

      // Hide the form card
      inlineFormCard.classList.add('hidden');

      // Show the "Report a payment" button again
      reportBtn.classList.remove('hidden');

      // Clear form
      document.getElementById('inline-payment-amount').value = '';
      document.getElementById('inline-payment-method').value = '';
      document.getElementById('inline-payment-note').value = '';
      document.getElementById('inline-payment-proof').value = '';
      document.getElementById('inline-payment-status').textContent = '';
      document.getElementById('amount-helper-text').textContent = '';
      document.getElementById('live-impact-box').classList.add('hidden');

      // Hide payment method details and toggle link
      document.getElementById('toggle-method-details-link').style.display = 'none';
      document.getElementById('inline-payment-method-details').classList.add('hidden');

      // Hide crypto tip
      const cryptoTip = document.getElementById('crypto-tx-tip');
      if (cryptoTip) {
        cryptoTip.classList.add('hidden');
      }

      // Reset dropzone state
      const dropzone = document.getElementById('inline-payment-proof-dropzone');
      const filenameDisplay = document.getElementById('inline-payment-proof-filename');
      const textDisplay = document.getElementById('inline-payment-proof-text');
      const browseBtn = document.getElementById('inline-payment-proof-browse-btn');
      if (dropzone && filenameDisplay && textDisplay && browseBtn) {
        filenameDisplay.style.display = 'none';
        textDisplay.style.display = 'block';
        browseBtn.textContent = 'Browse';
        dropzone.style.borderColor = 'rgba(255,255,255,0.2)';
        dropzone.style.background = 'rgba(255,255,255,0.02)';
      }
    }

    async function submitInlinePayment() {
      const status = document.getElementById('inline-payment-status');
      const amount = parseFloat(document.getElementById('inline-payment-amount').value);
      const method = document.getElementById('inline-payment-method').value || null;
      const note = document.getElementById('inline-payment-note').value.trim() || null;
      const proofInput = document.getElementById('inline-payment-proof');
      const proofFile = proofInput?.files[0];

      // Validate amount
      if (!amount || amount <= 0) {
        status.textContent = 'Please enter a valid amount';
        status.className = 'status error';
        return;
      }

      // Validate payment method
      if (!method) {
        status.textContent = 'Please select a payment method';
        status.className = 'status error';
        return;
      }

      // Validate proof of repayment if required
      if (agreement.proof_required && !proofFile) {
        status.textContent = 'This agreement requires proof of repayment. Please upload a screenshot, photo, or document.';
        status.className = 'status error';
        return;
      }

      // Validate file size if present
      if (proofFile && proofFile.size > 10 * 1024 * 1024) {
        status.textContent = 'File size must be less than 10MB';
        status.className = 'status error';
        return;
      }

      status.textContent = 'Reporting payment...';
      status.className = 'status';

      try {
        // Use FormData to support file upload
        const formData = new FormData();
        formData.append('amount', amount);
        if (method) formData.append('method', method);
        if (note) formData.append('note', note);
        if (proofFile) formData.append('proof', proofFile);

        const res = await fetch(`/api/agreements/${agreementId}/payments`, {
          method: 'POST',
          body: formData
        });

        const data = await res.json();

        if (!res.ok) {
          status.textContent = data.error || 'Failed to report payment';
          status.className = 'status error';
          return;
        }

        status.textContent = 'Payment reported successfully! Redirecting...';
        status.className = 'status success';

        // Update agreement data
        agreement = data.agreement;

        setTimeout(() => {
          if (agreement.status === 'settled') {
            window.location.href = '/app';
          } else {
            window.location.reload();
          }
        }, 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    async function populateDetails() {
      // Debug: Log the entire agreement object to see what fields are available
      console.log('=== POPULATE DETAILS DEBUG ===');
      console.log('Full agreement object:', agreement);
      console.log('Key fields:', {
        amount_cents: agreement.amount_cents,
        total_repay_amount: agreement.total_repay_amount,
        planned_total_due_cents: agreement.planned_total_due_cents,
        today_total_due_cents: agreement.today_total_due_cents,
        today_interest_cents: agreement.today_interest_cents,
        planned_interest_max_cents: agreement.planned_interest_max_cents,
        interest_rate: agreement.interest_rate,
        repayment_type: agreement.repayment_type
      });

      const amount = formatCurrency2(agreement.amount_cents);
      const lenderName = agreement.lender_full_name || agreement.lender_name || agreement.lender_email;
      const borrowerName = agreement.borrower_full_name || agreement.friend_first_name || agreement.borrower_email;

      const isLender = agreement.lender_user_id === currentUser.id;
      const isBorrower = agreement.borrower_user_id === currentUser.id;

      // Determine repayment details
      const repaymentType = agreement.repayment_type || 'one_time';
      const hasInterest = agreement.interest_rate && agreement.interest_rate > 0;
      const isInstallments = repaymentType === 'installments';

      // Generate human-readable summary line 1
      let summaryLine1 = '';
      if (isLender) {
        summaryLine1 = `You lent ${amount} to ${borrowerName}.`;
      } else if (isBorrower) {
        summaryLine1 = `${lenderName} lent you ${amount}.`;
      } else {
        summaryLine1 = `${lenderName} lent ${amount} to ${borrowerName}.`;
      }
      document.getElementById('agreement-summary-line1').textContent = summaryLine1;

      // Generate human-readable summary line 2 (payment schedule)
      // Use 'en-GB' locale for capitalized month names (e.g., "22 Feb 2026")
      let summaryLine2 = '';
      if (isInstallments && agreement.installment_count) {
        const firstDate = new Date(agreement.first_payment_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        const finalDate = new Date(agreement.final_due_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        summaryLine2 = `${agreement.installment_count} monthly payments, from ${firstDate} to ${finalDate}.`;
      } else {
        const dueDate = new Date(agreement.due_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        summaryLine2 = `Full repayment date is ${dueDate}.`;
      }
      document.getElementById('agreement-summary-line2').textContent = summaryLine2;

      // Generate human-readable summary line 3 (total repayment amount)
      // Use the EXACT SAME logic as the "Total to repay" row in the details table
      const totalRepayCents = agreement.total_repay_amount
        ? Math.round(agreement.total_repay_amount * 100)
        : agreement.amount_cents;

      console.log('Summary line 3 - Total to repay:', {
        total_repay_amount: agreement.total_repay_amount,
        totalRepayCents: totalRepayCents,
        formatted: formatCurrency2(totalRepayCents)
      });

      const totalRepay = formatCurrency2(totalRepayCents);
      const summaryLine3 = `Total repayment amount will be ${totalRepay} (incl. interest).`;

      document.getElementById('agreement-summary-line3').textContent = summaryLine3;

      // Create and insert both avatars (lender left, borrower right) with consistent order
      // Always show lender on left, borrower on right, regardless of who is viewing

      // Create lender avatar (always left)
      let lenderAvatarHtml = '';
      if (agreement.lender_profile_picture && agreement.lender_user_id) {
        lenderAvatarHtml = `<div class="user-avatar size-xl"><img src="/api/profile/picture/${agreement.lender_user_id}" class="user-avatar-image" /></div>`;
      } else {
        const lenderInitials = getInitials(lenderName);
        const lenderColorClass = getAvatarColor(lenderName);
        lenderAvatarHtml = `<div class="user-avatar size-xl"><div class="user-avatar-initials ${lenderColorClass}">${lenderInitials}</div></div>`;
      }
      document.getElementById('summary-avatar-lender').innerHTML = lenderAvatarHtml;

      // Create borrower avatar (always right)
      let borrowerAvatarHtml = '';
      if (agreement.borrower_profile_picture && agreement.borrower_user_id) {
        borrowerAvatarHtml = `<div class="user-avatar size-xl"><img src="/api/profile/picture/${agreement.borrower_user_id}" class="user-avatar-image" /></div>`;
      } else {
        const borrowerInitials = getInitials(borrowerName);
        const borrowerColorClass = getAvatarColor(borrowerName);
        borrowerAvatarHtml = `<div class="user-avatar size-xl"><div class="user-avatar-initials ${borrowerColorClass}">${borrowerInitials}</div></div>`;
      }
      document.getElementById('summary-avatar-borrower').innerHTML = borrowerAvatarHtml;

      // Show summary section
      document.getElementById('summary-section').classList.remove('hidden');

      // Populate details section in the order specified by the spec
      // 1. Lender name
      document.getElementById('lender-name').textContent = lenderName;

      // 2. Borrower name
      document.getElementById('borrower-name').textContent = borrowerName;

      // 2a. Borrower email (LENDER VIEW ONLY)
      if (isLender && agreement.borrower_email) {
        document.getElementById('borrower-email-display').textContent = agreement.borrower_email;
        document.getElementById('borrower-email-row').style.display = 'flex';
      } else {
        document.getElementById('borrower-email-row').style.display = 'none';
      }

      // 2b. Borrower phone (LENDER VIEW ONLY)
      if (isLender && agreement.borrower_phone) {
        document.getElementById('borrower-phone-display').textContent = agreement.borrower_phone;
        document.getElementById('borrower-phone-row').style.display = 'flex';
      } else {
        document.getElementById('borrower-phone-row').style.display = 'none';
      }

      // 3. Description (show if available)
      if (agreement.description) {
        document.getElementById('description-display').textContent = agreement.description;
        document.getElementById('description-row').style.display = 'flex';
      } else {
        document.getElementById('description-row').style.display = 'none';
      }

      // 4. Amount
      document.getElementById('amount-display').textContent = amount;

      // 5. Money transfer date (use backend-derived display value)
      document.getElementById('money-sent-display').textContent = agreement.loan_start_date_display || 'To be confirmed';
      document.getElementById('money-sent-row').style.display = 'flex';

      // 6. Loan duration (hide for one-time loans, show for installments)
      const isOneTimePayment = agreement.repayment_type === 'one_time';

      if (isOneTimePayment) {
        // Hide duration entirely for one-time payment loans
        document.getElementById('loan-duration-row').style.display = 'none';
      } else {
        // Show duration for installment loans
        const loanDurationLabel = getLoanDurationLabel(agreement);
        if (loanDurationLabel) {
          document.getElementById('loan-duration-display').textContent = loanDurationLabel;
          document.getElementById('loan-duration-row').style.display = 'flex';
        } else {
          document.getElementById('loan-duration-row').style.display = 'none';
        }
      }

      // Handle installment loans vs one-time payment differently
      if (isInstallments && agreement.installment_count) {
        // INSTALLMENTS PATH
        // 7. Repayment type
        document.getElementById('repayment-type-display').textContent = 'Installments';
        document.getElementById('repayment-type-row').style.display = 'flex';

        // 8. Installment plan
        const frequency = agreement.payment_frequency || 'monthly';
        const frequencyText = formatRepaymentFrequency(frequency);
        const installmentAmount = formatCurrency2(Math.round((agreement.installment_amount || 0) * 100));
        const firstDate = new Date(agreement.first_repayment_date || agreement.first_payment_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        const finalDate = new Date(agreement.final_due_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        const installmentPlan = `${agreement.installment_count} ${frequencyText.toLowerCase()} payments of ${installmentAmount} from ${firstDate} to ${finalDate}`;
        document.getElementById('installment-plan-display').textContent = installmentPlan;
        document.getElementById('installment-plan-row').style.display = 'flex';

        // 9. Interest rate (with total interest if > 0)
        if (hasInterest) {
          const interestRate = agreement.interest_rate;
          const totalInterestCents = Math.round((agreement.total_interest || 0) * 100);
          const totalInterest = formatCurrency2(totalInterestCents);
          document.getElementById('interest-rate-display').textContent = `${interestRate}% per year (total interest: ${totalInterest})`;
          document.getElementById('interest-rate-row').style.display = 'flex';
        } else {
          document.getElementById('interest-rate-row').style.display = 'none';
        }

        // 10. Total to repay
        if (hasInterest) {
          const totalRepayCents = agreement.total_repay_amount
            ? Math.round(agreement.total_repay_amount * 100)
            : agreement.amount_cents;
          const totalRepay = formatCurrency2(totalRepayCents);
          document.getElementById('total-repay-display').textContent = totalRepay;
          document.getElementById('total-repay-row').style.display = 'flex';
        } else {
          document.getElementById('total-repay-row').style.display = 'none';
        }

        // 11. Number of payment installments
        document.getElementById('installment-count-display').textContent = agreement.installment_count;
        document.getElementById('installment-count-row').style.display = 'flex';

        // 12. Payment frequency
        document.getElementById('payment-frequency-display').textContent = frequencyText;
        document.getElementById('payment-frequency-row').style.display = 'flex';

        // 13. First repayment date
        const firstPaymentDate = new Date(agreement.first_payment_date || agreement.first_repayment_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        document.getElementById('first-payment-display').textContent = firstPaymentDate;
        document.getElementById('first-payment-row').style.display = 'flex';

        // 14. Final due date
        const finalDueDate = new Date(agreement.final_due_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        document.getElementById('final-due-display').textContent = finalDueDate;
        document.getElementById('final-due-countdown').textContent = getDueDateCountdown(agreement.final_due_date);
        document.getElementById('final-due-row').style.display = 'flex';

        // Hide one-time specific fields
        document.getElementById('onetime-spacer-before').style.display = 'none';
        document.getElementById('repayment-type-onetime-row').style.display = 'none';
        document.getElementById('full-due-row').style.display = 'none';
        document.getElementById('onetime-spacer-after').style.display = 'none';
      } else {
        // ONE-TIME PAYMENT PATH
        // 6. Interest rate (with total interest if > 0)
        if (hasInterest) {
          const interestRate = agreement.interest_rate;
          const totalInterestCents = Math.round((agreement.total_interest || 0) * 100);
          const totalInterest = formatCurrency2(totalInterestCents);
          document.getElementById('interest-rate-display').textContent = `${interestRate}% per year (total interest: ${totalInterest})`;
          document.getElementById('interest-rate-row').style.display = 'flex';
        } else {
          document.getElementById('interest-rate-row').style.display = 'none';
        }

        // 7. Total to repay
        if (hasInterest) {
          const totalRepayCents = agreement.total_repay_amount
            ? Math.round(agreement.total_repay_amount * 100)
            : agreement.amount_cents;
          const totalRepay = formatCurrency2(totalRepayCents);
          document.getElementById('total-repay-display').textContent = totalRepay;
          document.getElementById('total-repay-row').style.display = 'flex';
        } else {
          document.getElementById('total-repay-row').style.display = 'none';
        }

        // Spacer before one-time section
        document.getElementById('onetime-spacer-before').style.display = 'block';

        // 8. Repayment type
        document.getElementById('repayment-type-onetime-display').textContent = 'One-time payment';
        document.getElementById('repayment-type-onetime-row').style.display = 'flex';

        // 9. Full repayment due date
        // Check if we should show relative or concrete date
        const isLoanStartUponAcceptance = agreement.money_sent_date === 'on-acceptance';
        const isRelativeDueDate = agreement.one_time_due_option && agreement.one_time_due_option !== 'pick_date';

        if (isLoanStartUponAcceptance && isRelativeDueDate) {
          // Show relative description
          document.getElementById('full-due-display').textContent = getRelativeDueDateText(agreement.one_time_due_option);
          document.getElementById('full-due-countdown').textContent = '';
        } else {
          // Show concrete date with countdown
          const dueDate = new Date(agreement.due_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
          document.getElementById('full-due-display').textContent = dueDate;
          document.getElementById('full-due-countdown').textContent = getDueDateCountdown(agreement.due_date);
        }
        document.getElementById('full-due-row').style.display = 'flex';

        // Spacer after one-time section
        document.getElementById('onetime-spacer-after').style.display = 'block';

        // Hide installment-specific fields
        document.getElementById('repayment-type-row').style.display = 'none';
        document.getElementById('installment-plan-row').style.display = 'none';
        document.getElementById('installment-count-row').style.display = 'none';
        document.getElementById('payment-frequency-row').style.display = 'none';
        document.getElementById('first-payment-row').style.display = 'none';
        document.getElementById('final-due-row').style.display = 'none';
      }

      // 15. Status badge with secondary badges - using helper functions
      const statusText = agreement.status || 'pending';

      // Import status label helper and generate status text
      let statusLabel;
      try {
        const { getStatusLabel } = await import('/js/status-labels.js');
        const borrowerFirstName = (agreement.borrower_full_name || agreement.friend_first_name || agreement.borrower_email).split(' ')[0];
        statusLabel = getStatusLabel(statusText, isLender && statusText === 'pending' ? borrowerFirstName : undefined);
      } catch (err) {
        console.error('Error loading status labels:', err);
        // Fallback to old logic
        let capitalizedStatus = statusText.charAt(0).toUpperCase() + statusText.slice(1);
        if (statusText === 'pending' && isLender) {
          const borrowerFirstName = (agreement.borrower_full_name || agreement.friend_first_name || agreement.borrower_email).split(' ')[0];
          capitalizedStatus = `Pending review by ${borrowerFirstName}`;
        }
        statusLabel = capitalizedStatus;
      }

      let statusHtml = `<span class="status-badge ${statusText}">${statusLabel}</span>`;

      // Check for pending payment confirmation (only for lenders on active agreements)
      if (isLender && agreement.status === 'active') {
        checkPendingPaymentConfirmation().then(hasPending => {
          if (hasPending) {
            const currentHtml = document.getElementById('status-display').innerHTML;
            if (!currentHtml.includes('Pending payment confirmation')) {
              document.getElementById('status-display').innerHTML = currentHtml + '<span class="secondary-status-badge pending-confirmation">Pending payment confirmation</span>';
            }
          }
        });
      }

      // Check for open difficulty (for both lenders and borrowers on active agreements)
      if (agreement.status === 'active') {
        checkHardshipRequests().then(hasHardship => {
          if (hasHardship) {
            const currentHtml = document.getElementById('status-display').innerHTML;
            if (!currentHtml.includes('Needs attention') && !currentHtml.includes('Pending resolution')) {
              document.getElementById('status-display').innerHTML = currentHtml + '<span class="secondary-status-badge pending-resolution">Needs attention</span>';
            }
          }
        });
      }

      document.getElementById('status-display').innerHTML = statusHtml;

      // Populate collapsible detail sections
      populateInterestCalcDetail();
      populatePaymentsAndRemindersDetail();
      populatePaymentMethodsDetail();
      populateShareDetail();
    }

    async function checkPendingPaymentConfirmation() {
      try {
        const res = await fetch(`/api/agreements/${agreementId}/payments`);
        if (res.ok) {
          const payments = await res.json();
          return payments.some(p => p.status === 'pending');
        }
      } catch (err) {
        console.error('Error checking pending payments:', err);
      }
      return false;
    }

    function showError(message) {
      // Hide loading card and clear loading text
      document.getElementById('loading-card').classList.add('hidden');
      document.getElementById('loading-text').textContent = '';
      document.getElementById('error-section').classList.remove('hidden');
      document.getElementById('error-message').textContent = message;
    }

    function retryLoad() {
      // Hide error section and show loading
      document.getElementById('error-section').classList.add('hidden');
      document.getElementById('loading-card').classList.remove('hidden');
      document.getElementById('loading-text').textContent = 'Loading...';
      // Retry loading the agreement
      loadAgreementData();
    }

    // Signature pad state
    let signaturePad = {
      canvas: null,
      ctx: null,
      isDrawing: false,
      hasContent: false,
      lastX: 0,
      lastY: 0
    };

    function initSignaturePad() {
      const canvas = document.getElementById('accept-signature-canvas');
      if (!canvas) return;

      signaturePad.canvas = canvas;
      signaturePad.ctx = canvas.getContext('2d');

      // Set canvas size to match display size
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * window.devicePixelRatio;
      canvas.height = rect.height * window.devicePixelRatio;
      signaturePad.ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

      // Configure drawing style
      signaturePad.ctx.strokeStyle = '#ffffff';
      signaturePad.ctx.lineWidth = 2;
      signaturePad.ctx.lineCap = 'round';
      signaturePad.ctx.lineJoin = 'round';

      // Reset state
      signaturePad.hasContent = false;
      signaturePad.isDrawing = false;

      // Mouse events
      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseleave', stopDrawing);

      // Touch events
      canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
      canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
      canvas.addEventListener('touchend', stopDrawing);
      canvas.addEventListener('touchcancel', stopDrawing);

      // Expose hasContent checker globally
      window.signaturePadHasContent = () => signaturePad.hasContent;
    }

    function getMousePos(canvas, evt) {
      const rect = canvas.getBoundingClientRect();
      return {
        x: evt.clientX - rect.left,
        y: evt.clientY - rect.top
      };
    }

    function getTouchPos(canvas, evt) {
      const rect = canvas.getBoundingClientRect();
      const touch = evt.touches[0];
      return {
        x: touch.clientX - rect.left,
        y: touch.clientY - rect.top
      };
    }

    function startDrawing(e) {
      signaturePad.isDrawing = true;
      const pos = getMousePos(signaturePad.canvas, e);
      signaturePad.lastX = pos.x;
      signaturePad.lastY = pos.y;
    }

    function draw(e) {
      if (!signaturePad.isDrawing) return;

      const pos = getMousePos(signaturePad.canvas, e);

      signaturePad.ctx.beginPath();
      signaturePad.ctx.moveTo(signaturePad.lastX, signaturePad.lastY);
      signaturePad.ctx.lineTo(pos.x, pos.y);
      signaturePad.ctx.stroke();

      signaturePad.lastX = pos.x;
      signaturePad.lastY = pos.y;
      signaturePad.hasContent = true;

      // Revalidate on draw
      validateAcceptModal();
    }

    function stopDrawing() {
      signaturePad.isDrawing = false;
    }

    function handleTouchStart(e) {
      e.preventDefault();
      signaturePad.isDrawing = true;
      const pos = getTouchPos(signaturePad.canvas, e);
      signaturePad.lastX = pos.x;
      signaturePad.lastY = pos.y;
    }

    function handleTouchMove(e) {
      if (!signaturePad.isDrawing) return;
      e.preventDefault();

      const pos = getTouchPos(signaturePad.canvas, e);

      signaturePad.ctx.beginPath();
      signaturePad.ctx.moveTo(signaturePad.lastX, signaturePad.lastY);
      signaturePad.ctx.lineTo(pos.x, pos.y);
      signaturePad.ctx.stroke();

      signaturePad.lastX = pos.x;
      signaturePad.lastY = pos.y;
      signaturePad.hasContent = true;

      // Revalidate on draw
      validateAcceptModal();
    }

    function clearSignature() {
      if (!signaturePad.canvas || !signaturePad.ctx) return;

      signaturePad.ctx.clearRect(0, 0, signaturePad.canvas.width, signaturePad.canvas.height);
      signaturePad.hasContent = false;
      signaturePad.isDrawing = false;

      // Revalidate after clearing
      validateAcceptModal();
    }

    function handleAccept() {
      openAcceptModal();
    }

    function openAcceptModal() {
      const modal = document.getElementById('accept-modal');
      const termsContainer = document.getElementById('accept-modal-terms');

      // Reset modal state
      document.getElementById('accept-confirm-terms').checked = false;
      document.getElementById('accept-modal-status').textContent = '';
      document.getElementById('accept-signature-error').classList.add('hidden');
      document.getElementById('accept-checkbox-error').classList.add('hidden');

      // Build key terms HTML
      let termsHTML = '';

      // Helper function to add a term row
      const addTerm = (label, value) => {
        termsHTML += `<div style="display:grid; grid-template-columns:140px 1fr; gap:12px; padding:6px 0;">
          <span style="color:var(--muted)">${label}:</span>
          <span style="color:var(--text); font-weight:500;">${value}</span>
        </div>`;
      };

      const lenderName = agreement.lender_full_name || agreement.lender_name || agreement.lender_email;
      const borrowerName = agreement.borrower_full_name || agreement.friend_first_name || agreement.borrower_email;
      const borrowerEmail = agreement.borrower_email || currentUser.email;
      const amount = formatCurrency2(agreement.amount_cents);
      const repaymentType = agreement.repayment_type === 'installments' ? 'Installments' : 'One-time payment';

      addTerm('Lender', lenderName);
      addTerm('Borrower', `${borrowerName} (${borrowerEmail})`);
      addTerm('Amount', amount);
      addTerm('Repayment type', repaymentType);

      // Installment plan (only for installments)
      if (agreement.repayment_type === 'installments' && agreement.installment_count) {
        const freqLabel = agreement.payment_frequency_label || 'monthly';
        const installmentAmt = formatCurrency2(Math.round((agreement.installment_amount || 0) * 100));
        const firstDate = new Date(agreement.first_repayment_date || agreement.first_payment_date).toLocaleDateString('nl-NL', { day: 'numeric', month: 'short', year: 'numeric' });
        const finalDate = new Date(agreement.final_due_date).toLocaleDateString('nl-NL', { day: 'numeric', month: 'short', year: 'numeric' });
        const planText = `${agreement.installment_count} ${freqLabel} payments of ${installmentAmt} from ${firstDate} to ${finalDate}`;
        addTerm('Installment plan', planText);
      }

      // Loan duration - using helper function
      const loanDurationLabelForModal = getLoanDurationLabel(agreement);
      if (loanDurationLabelForModal) {
        addTerm('Loan duration', loanDurationLabelForModal);
      }

      // Interest rate
      if (agreement.interest_rate && agreement.interest_rate > 0) {
        const totalInterest = formatCurrency2(Math.round((agreement.total_interest || 0) * 100));
        addTerm('Interest rate', `${agreement.interest_rate}% per year`);
        addTerm('Total interest', totalInterest);

        const totalRepayCents = agreement.total_repay_amount
          ? Math.round(agreement.total_repay_amount * 100)
          : agreement.amount_cents;
        addTerm('Total to repay', formatCurrency2(totalRepayCents));
      }

      // Due dates
      if (agreement.repayment_type === 'installments') {
        if (agreement.first_repayment_date || agreement.first_payment_date) {
          const firstDate = new Date(agreement.first_repayment_date || agreement.first_payment_date).toLocaleDateString('nl-NL', { day: 'numeric', month: 'short', year: 'numeric' });
          addTerm('First repayment date', firstDate);
        }
        if (agreement.final_due_date) {
          const finalDate = new Date(agreement.final_due_date).toLocaleDateString('nl-NL', { day: 'numeric', month: 'short', year: 'numeric' });
          addTerm('Final due date', finalDate);
        }
      } else {
        if (agreement.due_date) {
          // Check if we should show relative or concrete date
          const isLoanStartUponAcceptance = agreement.money_sent_date === 'on-acceptance';
          const isRelativeDueDate = agreement.one_time_due_option && agreement.one_time_due_option !== 'pick_date';

          let dueDateDisplay;
          if (isLoanStartUponAcceptance && isRelativeDueDate) {
            // Show relative description
            dueDateDisplay = getRelativeDueDateText(agreement.one_time_due_option);
          } else {
            // Show concrete date
            dueDateDisplay = new Date(agreement.due_date).toLocaleDateString('nl-NL', { day: 'numeric', month: 'short', year: 'numeric' });
          }

          addTerm('Full repayment due', dueDateDisplay);
        }
      }

      // Payment methods
      if (agreement.payment_preference_method) {
        const methods = agreement.payment_preference_method.split(',').map(m => {
          const trimmed = m.trim();
          if (trimmed === 'bank') return 'Bank transfer';
          if (trimmed === 'cash') return 'Cash';
          if (trimmed === 'paypal') return 'PayPal';
          if (trimmed === 'crypto') return 'Crypto';
          if (trimmed === 'any') return 'Any method';
          if (trimmed === 'other') return 'Other';
          return trimmed;
        });
        addTerm('Repayment method(s)', methods.join(', '));
      }

      // Proof required
      addTerm('Require proof of payment', agreement.proof_required ? 'Yes' : 'No');

      // Reminders - improved description
      let reminderDescription = 'Off';
      if (agreement.reminder_mode === 'auto') {
        reminderDescription = 'Automatic – reminders are sent before the due date, on the due date, and if payments are late.';
      } else if (agreement.reminder_mode === 'custom') {
        reminderDescription = 'Custom – uses the reminder schedule agreed in this plan.';
      }
      addTerm('Reminders', reminderDescription);

      // Worst case scenario (only if enabled)
      if (agreement.debt_collection_clause) {
        addTerm('Worst case scenario', 'If you do not repay in time and ignore reminders or cannot agree a new plan, PayFriends will hand the case to an independent debt collector.');
      }

      termsContainer.innerHTML = termsHTML;

      // Show modal first so canvas dimensions are correct
      modal.style.display = 'flex';

      // Initialize signature pad after modal is visible
      // Use requestAnimationFrame to ensure layout is complete
      requestAnimationFrame(() => {
        initSignaturePad();
        // Reset and disable confirm button
        validateAcceptModal();
      });
    }

    function closeAcceptModal() {
      const modal = document.getElementById('accept-modal');
      modal.style.display = 'none';
    }

    function validateAcceptModal() {
      const termsChecked = document.getElementById('accept-confirm-terms').checked;
      const confirmBtn = document.getElementById('accept-modal-confirm-btn');
      const signatureError = document.getElementById('accept-signature-error');
      const checkboxError = document.getElementById('accept-checkbox-error');

      // Check if signature pad has content
      const signatureValid = window.signaturePadHasContent && window.signaturePadHasContent();

      // Show/hide errors based on validation
      if (!termsChecked) {
        checkboxError.classList.remove('hidden');
      } else {
        checkboxError.classList.add('hidden');
      }

      if (!signatureValid && termsChecked) {
        // Only show signature error if checkbox is checked (progressive validation)
        signatureError.classList.remove('hidden');
      } else {
        signatureError.classList.add('hidden');
      }

      // Enable button only if both are valid
      if (termsChecked && signatureValid) {
        confirmBtn.disabled = false;
        confirmBtn.style.opacity = '1';
        confirmBtn.style.cursor = 'pointer';
      } else {
        confirmBtn.disabled = true;
        confirmBtn.style.opacity = '0.5';
        confirmBtn.style.cursor = 'not-allowed';
      }
    }

    async function confirmAccept() {
      const status = document.getElementById('accept-modal-status');
      const confirmBtn = document.getElementById('accept-modal-confirm-btn');

      status.textContent = 'Accepting agreement...';
      status.className = 'status';
      confirmBtn.disabled = true;
      confirmBtn.style.opacity = '0.5';

      try {
        const res = await fetch(`/api/agreements/${agreementId}/accept`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();

        if (!res.ok) {
          status.textContent = data.error || 'Failed to accept';
          status.className = 'status error';
          confirmBtn.disabled = false;
          confirmBtn.style.opacity = '1';
          return;
        }

        status.textContent = 'Agreement accepted!';
        status.className = 'status success';

        setTimeout(() => {
          window.location.reload();
        }, 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
        confirmBtn.disabled = false;
        confirmBtn.style.opacity = '1';
      }
    }

    async function handleDecline() {
      if (!confirm('Are you sure you want to decline this agreement?')) {
        return;
      }

      const status = document.getElementById('action-status');
      status.textContent = 'Declining...';
      status.className = 'status';

      try {
        const res = await fetch(`/api/agreements/${agreementId}/decline`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();

        if (!res.ok) {
          status.textContent = data.error || 'Failed to decline';
          status.className = 'status error';
          return;
        }

        status.textContent = 'Agreement declined. Redirecting...';
        status.className = 'status success';

        setTimeout(() => {
          window.location.href = '/app';
        }, 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    async function handleReviewLater() {
      const status = document.getElementById('action-status');
      status.textContent = 'Saving...';
      status.className = 'status';

      try {
        const res = await fetch(`/api/agreements/${agreementId}/review-later`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();

        if (!res.ok) {
          status.textContent = data.error || 'Failed to save';
          status.className = 'status error';
          return;
        }

        status.textContent = 'Saved! Redirecting to dashboard...';
        status.className = 'status success';

        setTimeout(() => {
          window.location.href = '/app';
        }, 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    // Store the element that opened the modal for focus restoration
    let cancelModalTrigger = null;

    function openCancelModal() {
      cancelModalTrigger = document.activeElement;
      const modal = document.getElementById('cancel-modal');
      modal.style.display = 'flex';

      // Focus on the confirm button
      setTimeout(() => {
        const confirmBtn = document.getElementById('confirm-cancel-btn');
        confirmBtn.focus();
      }, 100);

      // Add keyboard event listener for Esc key
      document.addEventListener('keydown', handleCancelModalKeydown);
    }

    function closeCancelModal() {
      const modal = document.getElementById('cancel-modal');
      modal.style.display = 'none';

      // Remove keyboard event listener
      document.removeEventListener('keydown', handleCancelModalKeydown);

      // Return focus to the trigger button
      if (cancelModalTrigger) {
        cancelModalTrigger.focus();
        cancelModalTrigger = null;
      }
    }

    function handleCancelModalKeydown(e) {
      const modal = document.getElementById('cancel-modal');
      if (modal.style.display === 'none') return;

      // Handle Esc key
      if (e.key === 'Escape') {
        e.preventDefault();
        closeCancelModal();
        return;
      }

      // Handle Tab key for focus trapping
      if (e.key === 'Tab') {
        const focusableElements = modal.querySelectorAll('button, [href], [tabindex]:not([tabindex="-1"])');
        const firstElement = focusableElements[0];
        const lastElement = focusableElements[focusableElements.length - 1];

        if (e.shiftKey) {
          // Shift+Tab
          if (document.activeElement === firstElement) {
            e.preventDefault();
            lastElement.focus();
          }
        } else {
          // Tab
          if (document.activeElement === lastElement) {
            e.preventDefault();
            firstElement.focus();
          }
        }
      }
    }

    async function confirmCancel() {
      // Close modal first
      closeCancelModal();

      const status = document.getElementById('action-status');
      status.textContent = 'Cancelling...';
      status.className = 'status';

      try {
        const res = await fetch(`/api/agreements/${agreementId}/cancel`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();

        if (!res.ok) {
          status.textContent = data.error || 'Failed to cancel';
          status.className = 'status error';
          return;
        }

        status.textContent = 'Agreement cancelled. Redirecting...';
        status.className = 'status success';

        setTimeout(() => {
          window.location.href = '/app';
        }, 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    // Hardship form functions
    function showHardshipForm() {
      document.getElementById('details-section').classList.add('hidden');
      document.getElementById('payment-action-section').classList.add('hidden');
      document.getElementById('payment-history').classList.add('hidden');
      document.getElementById('hardship-form').classList.remove('hidden');

      // Set lender's first name
      const lenderName = agreement.lender_full_name || agreement.lender_name;
      const lenderFirstName = lenderName ? lenderName.split(' ')[0] : lenderName;
      document.getElementById('lender-first-name-text').textContent = lenderFirstName || 'your friend';

      // Add event listeners for live summary updates
      document.querySelectorAll('input[name="reason"]').forEach(input => {
        input.addEventListener('change', updateSummary);
      });
      document.querySelectorAll('input[name="can-pay"]').forEach(input => {
        input.addEventListener('change', updateSummary);
      });
      document.getElementById('payment-amount').addEventListener('input', updateSummary);
      document.querySelectorAll('input[type="checkbox"]').forEach(input => {
        input.addEventListener('change', updateSummary);
      });
    }

    function cancelHardshipForm() {
      document.getElementById('hardship-form').classList.add('hidden');
      document.getElementById('details-section').classList.remove('hidden');
      document.getElementById('payment-action-section').classList.remove('hidden');
      document.getElementById('payment-history').classList.remove('hidden');
    }

    function togglePaymentAmount() {
      const canPayYes = document.getElementById('can-pay-yes').checked;
      const amountInput = document.getElementById('payment-amount-input');

      if (canPayYes) {
        amountInput.classList.remove('hidden');
      } else {
        amountInput.classList.add('hidden');
        document.getElementById('payment-amount').value = '';
      }
    }

    function updateSummary() {
      // Update reason
      const reasonInput = document.querySelector('input[name="reason"]:checked');
      const reasonText = reasonInput ? reasonInput.nextElementSibling.textContent : '-';
      document.getElementById('summary-reason').textContent = reasonText;

      // Update can pay now
      const canPayYes = document.getElementById('can-pay-yes').checked;
      const canPayNo = document.getElementById('can-pay-no').checked;
      const paymentAmount = document.getElementById('payment-amount').value;

      let payText = '-';
      if (canPayYes && paymentAmount) {
        payText = `€${paymentAmount}`;
      } else if (canPayYes) {
        payText = 'Yes (amount not specified)';
      } else if (canPayNo) {
        payText = 'Cannot pay right now';
      }
      document.getElementById('summary-pay').textContent = payText;

      // Update preferred adjustments
      const adjustments = [];
      document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
        adjustments.push(cb.nextElementSibling.textContent);
      });
      const adjustText = adjustments.length > 0 ? adjustments.join('; ') : '-';
      document.getElementById('summary-adjustments').textContent = adjustText;
    }

    async function submitHardshipRequest() {
      const status = document.getElementById('hardship-status');

      // Validate form
      const reasonInput = document.querySelector('input[name="reason"]:checked');
      if (!reasonInput) {
        status.textContent = 'Please select a reason';
        status.className = 'status error';
        return;
      }

      const adjustmentCheckboxes = document.querySelectorAll('input[type="checkbox"]:checked');
      if (adjustmentCheckboxes.length === 0) {
        status.textContent = 'Please select at least one preferred adjustment option';
        status.className = 'status error';
        return;
      }

      // Gather form data
      const reasonCategory = reasonInput.value;
      const reasonText = document.getElementById('reason-text').value.trim() || null;

      const canPayYes = document.getElementById('can-pay-yes').checked;
      let canPayNowCents = null;
      if (canPayYes) {
        const paymentAmount = parseFloat(document.getElementById('payment-amount').value);
        if (paymentAmount && paymentAmount > 0) {
          canPayNowCents = Math.round(paymentAmount * 100);
        }
      }

      const preferredAdjustments = Array.from(adjustmentCheckboxes).map(cb => cb.value);

      status.textContent = 'Sending request...';
      status.className = 'status';

      try {
        const res = await fetch(`/api/agreements/${agreementId}/hardship-request`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            reasonCategory,
            reasonText,
            canPayNowCents,
            preferredAdjustments
          })
        });

        const data = await res.json();

        if (!res.ok) {
          status.textContent = data.error || 'Failed to send request';
          status.className = 'status error';
          return;
        }

        status.textContent = 'Request sent! We\'ve shared your situation and preferences with your friend. Redirecting...';
        status.className = 'status success';

        setTimeout(() => {
          window.location.href = '/app';
        }, 2000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    async function checkHardshipRequests() {
      try {
        const res = await fetch(`/api/agreements/${agreementId}/hardship-requests`);
        if (res.ok) {
          const requests = await res.json();
          return requests.length > 0;
        }
      } catch (err) {
        console.error('Error checking hardship requests:', err);
      }
      return false;
    }

    // ===== Renegotiation Initiation (Step 0 & 1) =====

    function showRenegotiationInitiationForm() {
      // Hide other sections
      document.getElementById('payment-action-section').classList.add('hidden');
      document.getElementById('payment-history').classList.add('hidden');
      document.getElementById('record-payment-section').classList.add('hidden');
      document.getElementById('hardship-form').classList.add('hidden');

      // Show renegotiation initiation form
      const form = document.getElementById('renegotiation-initiation-form');
      form.classList.remove('hidden');

      // Get lender name for personalization
      const lenderName = (agreement.lender_full_name || agreement.lender_name || agreement.lender_email).split(' ')[0];

      // Populate expected payment context (what was supposed to be paid and when)
      const expectedPaymentEl = document.getElementById('expected-payment-context');
      if (agreement.repayment_type === 'installments' && agreement.next_payment_amount_cents && agreement.next_payment_date) {
        const amount = formatCurrency2(agreement.next_payment_amount_cents);
        const date = new Date(agreement.next_payment_date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        expectedPaymentEl.textContent = `Your next installment is ${amount}, due on ${date}.`;
      } else if (agreement.repayment_type !== 'installments' && agreement.amount_cents && agreement.due_date) {
        const amount = formatEuro0(agreement.amount_cents / 100);
        const date = new Date(agreement.due_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        expectedPaymentEl.textContent = `You are supposed to pay ${amount} on ${date}.`;
      } else {
        expectedPaymentEl.textContent = 'You are having difficulty making the scheduled payment.';
      }

      // Set microcopy for "How much can you pay now?" field
      const microcopyEl = document.getElementById('can-pay-now-microcopy');
      microcopyEl.textContent = `${lenderName} will appreciate receiving something rather than nothing. Anything paid now will help show commitment and will recalculate the remaining amounts fairly.`;

      // Important: One-time vs installment loans have different renegotiation options.
      // Do not unify these lists again, we want tailored solutions per loan type.
      // Installment loans get: lower installments, skip payment, pay part & adjust
      // One-time loans get: extend due date, split into parts, pay part & reschedule rest
      const loanType = agreement.repayment_type === 'installments' ? 'installment' : 'one_time';
      const solutionTypesContainer = document.getElementById('renegotiation-solution-types');

      if (!solutionTypesContainer) {
        console.error('renegotiation-solution-types container not found');
        return;
      }

      if (!window.RenegotiationModule) {
        console.error('RenegotiationModule not loaded');
        return;
      }

      solutionTypesContainer.innerHTML = window.RenegotiationModule.buildSolutionTypeOptions(loanType);

      // Verify options were rendered
      if (!solutionTypesContainer.innerHTML.trim()) {
        console.error('Failed to render renegotiation options for loan type:', loanType);
      }

      // Set button text with lender name
      const submitBtn = document.getElementById('renegotiation-submit-btn');
      submitBtn.textContent = `Send new plan proposal to ${lenderName}`;

      // Scroll to form
      form.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function cancelRenegotiationForm() {
      // Hide form
      document.getElementById('renegotiation-initiation-form').classList.add('hidden');

      // Show payment sections again
      document.getElementById('payment-action-section').classList.remove('hidden');
      document.getElementById('payment-history').classList.remove('hidden');
    }

    async function submitRenegotiationRequest() {
      const status = document.getElementById('renegotiation-initiation-status');
      status.textContent = '';
      status.className = 'status';

      // Collect form data
      const troubleReason = document.getElementById('renegotiation-trouble-reason').value;
      const troubleReasonOther = document.getElementById('renegotiation-reason-other').value;
      const selectedType = document.querySelector('input[name="solution-type"]:checked')?.value;
      const canPayNowInput = document.getElementById('renegotiation-can-pay-now').value;

      // Validate trouble reason (mandatory)
      if (!troubleReason) {
        status.textContent = 'Please select a reason for having trouble paying';
        status.className = 'status error';
        document.getElementById('renegotiation-trouble-reason').focus();
        return;
      }

      // Validate solution type
      if (!selectedType) {
        status.textContent = 'Please select a solution type';
        status.className = 'status error';
        return;
      }

      const canPayNowCents = canPayNowInput ? Math.round(parseFloat(canPayNowInput) * 100) : null;

      try {
        status.textContent = 'Sending renegotiation request...';
        await window.RenegotiationModule.initializeRenegotiation(
          agreementId,
          selectedType,
          canPayNowCents,
          null,
          troubleReason,
          troubleReasonOther
        );

        status.textContent = 'Request sent successfully! Reloading...';
        status.className = 'status success';

        setTimeout(() => {
          window.location.reload();
        }, 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    // ===== Renegotiation Functions =====

    // Load and display active renegotiation
    async function loadAndDisplayRenegotiation() {
      try {
        const renegotiation = await window.RenegotiationModule.loadRenegotiation(agreementId);

        if (!renegotiation) {
          // No active renegotiation
          document.getElementById('renegotiation-panel').classList.add('hidden');
          return;
        }

        // Display the renegotiation based on its stage and user role
        const isLender = agreement.lender_user_id === currentUser.id;
        const isBorrower = agreement.borrower_user_id === currentUser.id;

        displayRenegotiationPanel(renegotiation, isLender, isBorrower);
        document.getElementById('renegotiation-panel').classList.remove('hidden');
      } catch (err) {
        console.error('Error loading renegotiation:', err);
      }
    }

    // Display the renegotiation panel based on stage
    function displayRenegotiationPanel(renegotiation, isLender, isBorrower) {
      const panel = document.getElementById('renegotiation-panel');
      let html = '';

      const stage = renegotiation.stage;
      const lenderName = agreement.lender_full_name || agreement.lender_name || agreement.lender_email;
      const borrowerName = agreement.borrower_full_name || agreement.friend_first_name || agreement.borrower_email;

      // Status badge color
      let statusBadgeClass = 'open';
      if (renegotiation.status === 'accepted') statusBadgeClass = 'accepted';
      if (renegotiation.status === 'closed_declined') statusBadgeClass = 'declined';

      html += `<div class="renegotiation-card">`;
      html += `
        <div class="renegotiation-header">
          <h3 class="renegotiation-title">Renegotiation in progress</h3>
          <span class="renegotiation-status-badge ${statusBadgeClass}">${renegotiation.status.replace('_', ' ')}</span>
        </div>
      `;

      // Show history timeline
      html += window.RenegotiationModule.buildHistoryTimeline(renegotiation.history);

      // Stage-specific UI
      if (stage === 'type_pending_lender_response' && isLender) {
        html += buildLenderTypeResponseUI(renegotiation, borrowerName);
      } else if (stage === 'type_counter_proposed_to_borrower' && isBorrower) {
        html += buildBorrowerTypeCounterResponseUI(renegotiation, lenderName);
      } else if (stage === 'values_to_be_set' && isBorrower) {
        html += buildBorrowerValuesProposalUI(renegotiation);
      } else if (stage === 'values_pending_lender_response' && isLender) {
        html += buildLenderValuesResponseUI(renegotiation, borrowerName);
      } else if (stage === 'values_counter_proposed_to_borrower' && isBorrower) {
        html += buildBorrowerValuesCounterResponseUI(renegotiation, lenderName);
      } else if (stage === 'accepted') {
        html += `
          <div class="alert-box success">
            <strong>Renegotiation accepted!</strong> The new payment plan has been agreed upon.
          </div>
        `;
      } else {
        // Waiting for the other party
        html += `
          <div class="alert-box info">
            <p style="margin:0">Waiting for ${isLender ? borrowerName : lenderName} to respond.</p>
          </div>
        `;
      }

      html += `</div>`;
      panel.innerHTML = html;

      // Attach event listeners based on stage
      attachRenegotiationEventListeners(stage, isLender, isBorrower, renegotiation);
    }

    // Build UI for lender to respond to solution type
    function buildLenderTypeResponseUI(renegotiation, borrowerName) {
      const typeLabel = window.RenegotiationModule.getSolutionTypeLabel(renegotiation.selected_type);
      let html = `
        <div class="alert-box warning">
          <p style="margin:0"><strong>${borrowerName}</strong> proposed a solution: <strong>${typeLabel}</strong></p>
        </div>
      `;

      if (renegotiation.can_pay_now_cents) {
        html += `
          <div class="detail-row">
            <span class="detail-label">They can pay now</span>
            <span class="detail-value">${formatEuro0(renegotiation.can_pay_now_cents / 100)}</span>
          </div>
        `;
      }

      if (renegotiation.borrower_note) {
        html += `
          <div class="note" style="margin-top:12px">
            <strong>Note:</strong> ${renegotiation.borrower_note}
          </div>
        `;
      }

      html += `
        <div class="renegotiation-actions">
          <button id="renegotiation-approve-type-btn" class="primary">Approve this solution</button>
          <button id="renegotiation-suggest-type-btn" class="secondary">Suggest different solution</button>
          <button id="renegotiation-decline-btn" class="danger">Decline request</button>
        </div>
        <p class="status" id="renegotiation-status"></p>

        <div id="suggest-type-form" class="hidden" style="margin-top:20px">
          <h4 style="margin-bottom:12px">Suggest an alternative solution:</h4>
          <!-- Use the loan_type saved in renegotiation record (set correctly by backend) -->
          ${window.RenegotiationModule.buildSolutionTypeOptions(renegotiation.loan_type)}
          <div class="form-group">
            <label class="form-label">Optional note (explain why this might work better)</label>
            <textarea id="suggest-type-note" rows="3" placeholder="I think this option..."></textarea>
          </div>
          <div class="btn-group">
            <button id="submit-suggest-type-btn" class="primary">Send suggestion</button>
            <button id="cancel-suggest-type-btn" class="secondary">Cancel</button>
          </div>
        </div>

        <div id="decline-form" class="hidden" style="margin-top:20px">
          <div class="form-group">
            <label class="form-label">Reason for declining (optional)</label>
            <textarea id="decline-note" rows="3" placeholder="Sorry, but..."></textarea>
          </div>
          <div class="btn-group">
            <button id="submit-decline-btn" class="danger">Confirm decline</button>
            <button id="cancel-decline-btn" class="secondary">Cancel</button>
          </div>
        </div>
      `;

      return html;
    }

    // Build UI for borrower to respond to lender's suggested type
    function buildBorrowerTypeCounterResponseUI(renegotiation, lenderName) {
      const suggestedTypeLabel = window.RenegotiationModule.getSolutionTypeLabel(renegotiation.lender_suggested_type);
      let html = `
        <div class="alert-box warning">
          <p style="margin:0"><strong>${lenderName}</strong> suggested a different solution: <strong>${suggestedTypeLabel}</strong></p>
        </div>
      `;

      if (renegotiation.lender_response_note) {
        html += `
          <div class="note" style="margin-top:12px">
            <strong>Note:</strong> ${renegotiation.lender_response_note}
          </div>
        `;
      }

      html += `
        <p style="color:var(--muted); margin:16px 0">Do you agree with this approach?</p>
        <div class="renegotiation-actions">
          <button id="accept-suggested-type-btn" class="primary">Accept this solution</button>
          <button id="decline-suggested-type-btn" class="secondary">Cancel renegotiation</button>
        </div>
        <p class="status" id="renegotiation-status"></p>
      `;

      return html;
    }

    // Build UI for borrower to propose values
    function buildBorrowerValuesProposalUI(renegotiation) {
      const agreedTypeLabel = window.RenegotiationModule.getSolutionTypeLabel(renegotiation.agreed_type);
      let html = `
        <div class="alert-box success">
          <p style="margin:0">Both of you agreed on: <strong>${agreedTypeLabel}</strong></p>
        </div>
        <p style="color:var(--muted); margin:16px 0">Now propose the specific amounts and dates:</p>
      `;

      html += window.RenegotiationModule.buildValuesForm(
        renegotiation.agreed_type,
        renegotiation.loan_type,
        { canPayNowCents: renegotiation.can_pay_now_cents }
      );

      html += `
        <div class="btn-group">
          <button id="submit-values-btn" class="primary">Submit proposal</button>
        </div>
        <p class="status" id="renegotiation-status"></p>
      `;

      return html;
    }

    // Build UI for lender to respond to values
    function buildLenderValuesResponseUI(renegotiation, borrowerName) {
      const agreedTypeLabel = window.RenegotiationModule.getSolutionTypeLabel(renegotiation.agreed_type);
      let html = `
        <div class="alert-box warning">
          <p style="margin:0"><strong>${borrowerName}</strong> proposed new payment plan for: <strong>${agreedTypeLabel}</strong></p>
        </div>

        <h4 style="margin:16px 0 12px 0">Proposed values:</h4>
      `;

      html += window.RenegotiationModule.buildValuesDisplay(
        renegotiation.agreed_type,
        renegotiation.loan_type,
        renegotiation.borrower_values_proposal
      );

      html += `
        <div class="renegotiation-actions">
          <button id="approve-values-btn" class="primary">Approve plan</button>
          <button id="counter-values-btn" class="secondary">Suggest different values</button>
          <button id="decline-values-btn" class="danger">Decline</button>
        </div>
        <p class="status" id="renegotiation-status"></p>

        <div id="counter-values-form" class="hidden" style="margin-top:20px">
          <h4 style="margin-bottom:12px">Counter-propose different values:</h4>
          ${window.RenegotiationModule.buildValuesForm(
            renegotiation.agreed_type,
            renegotiation.loan_type,
            renegotiation.borrower_values_proposal
          )}
          <div class="form-group">
            <label class="form-label">Optional note</label>
            <textarea id="counter-values-note" rows="2" placeholder="I think these values would work better..."></textarea>
          </div>
          <div class="btn-group">
            <button id="submit-counter-values-btn" class="primary">Send counter-proposal</button>
            <button id="cancel-counter-values-btn" class="secondary">Cancel</button>
          </div>
        </div>
      `;

      return html;
    }

    // Build UI for borrower to respond to lender's counter values
    function buildBorrowerValuesCounterResponseUI(renegotiation, lenderName) {
      const agreedTypeLabel = window.RenegotiationModule.getSolutionTypeLabel(renegotiation.agreed_type);
      let html = `
        <div class="alert-box warning">
          <p style="margin:0"><strong>${lenderName}</strong> proposed different values</p>
        </div>

        <h4 style="margin:16px 0 8px 0">Comparison:</h4>
        <div class="comparison-table">
          <div class="comparison-row header">
            <div class="comparison-label"></div>
            <div class="comparison-label">Your proposal</div>
            <div class="comparison-label">Their proposal</div>
          </div>
      `;

      // Build comparison rows based on type
      const yourVals = renegotiation.borrower_values_proposal;
      const theirVals = renegotiation.lender_values_proposal;

      if (yourVals.canPayNowCents || theirVals.canPayNowCents) {
        html += `
          <div class="comparison-row">
            <div class="comparison-label">Pay now</div>
            <div class="comparison-value">${yourVals.canPayNowCents ? formatEuro0(yourVals.canPayNowCents / 100) : '—'}</div>
            <div class="comparison-value highlight">${theirVals.canPayNowCents ? formatEuro0(theirVals.canPayNowCents / 100) : '—'}</div>
          </div>
        `;
      }

      // Add other comparison rows based on agreed type
      // (simplified for now - you can expand this)

      html += `</div>`;

      if (renegotiation.lender_response_note) {
        html += `
          <div class="note" style="margin-top:12px">
            <strong>Note:</strong> ${renegotiation.lender_response_note}
          </div>
        `;
      }

      html += `
        <div class="renegotiation-actions">
          <button id="accept-counter-values-btn" class="primary">Accept their values</button>
          <button id="decline-counter-values-btn" class="secondary">Decline</button>
        </div>
        <p class="status" id="renegotiation-status"></p>
      `;

      return html;
    }

    // Attach event listeners for renegotiation actions
    function attachRenegotiationEventListeners(stage, isLender, isBorrower, renegotiation) {
      if (stage === 'type_pending_lender_response' && isLender) {
        document.getElementById('renegotiation-approve-type-btn')?.addEventListener('click', handleApproveType);
        document.getElementById('renegotiation-suggest-type-btn')?.addEventListener('click', showSuggestTypeForm);
        document.getElementById('renegotiation-decline-btn')?.addEventListener('click', showDeclineForm);
        document.getElementById('submit-suggest-type-btn')?.addEventListener('click', handleSubmitSuggestType);
        document.getElementById('cancel-suggest-type-btn')?.addEventListener('click', hideSuggestTypeForm);
        document.getElementById('submit-decline-btn')?.addEventListener('click', handleSubmitDecline);
        document.getElementById('cancel-decline-btn')?.addEventListener('click', hideDeclineForm);
      } else if (stage === 'type_counter_proposed_to_borrower' && isBorrower) {
        document.getElementById('accept-suggested-type-btn')?.addEventListener('click', handleAcceptSuggestedType);
        document.getElementById('decline-suggested-type-btn')?.addEventListener('click', handleDeclineSuggestedType);
      } else if (stage === 'values_to_be_set' && isBorrower) {
        document.getElementById('submit-values-btn')?.addEventListener('click', handleSubmitValues);

        // Handle skip method radio button visibility
        const skipSpreadRadio = document.getElementById('skip-spread');
        const skipExtraRadio = document.getElementById('skip-extra');
        if (skipSpreadRadio && skipExtraRadio) {
          skipSpreadRadio.addEventListener('change', () => {
            document.getElementById('skip-spread-amount').style.display = 'block';
            document.getElementById('skip-extra-amount').style.display = 'none';
          });
          skipExtraRadio.addEventListener('change', () => {
            document.getElementById('skip-spread-amount').style.display = 'none';
            document.getElementById('skip-extra-amount').style.display = 'block';
          });
          // Trigger initial state
          if (skipSpreadRadio.checked) skipSpreadRadio.dispatchEvent(new Event('change'));
          if (skipExtraRadio.checked) skipExtraRadio.dispatchEvent(new Event('change'));
        }
      } else if (stage === 'values_pending_lender_response' && isLender) {
        document.getElementById('approve-values-btn')?.addEventListener('click', handleApproveValues);
        document.getElementById('counter-values-btn')?.addEventListener('click', showCounterValuesForm);
        document.getElementById('decline-values-btn')?.addEventListener('click', handleDeclineValues);
        document.getElementById('submit-counter-values-btn')?.addEventListener('click', handleSubmitCounterValues);
        document.getElementById('cancel-counter-values-btn')?.addEventListener('click', hideCounterValuesForm);
      } else if (stage === 'values_counter_proposed_to_borrower' && isBorrower) {
        document.getElementById('accept-counter-values-btn')?.addEventListener('click', handleAcceptCounterValues);
        document.getElementById('decline-counter-values-btn')?.addEventListener('click', handleDeclineCounterValues);
      }
    }

    // Event handlers for type stage
    async function handleApproveType() {
      const status = document.getElementById('renegotiation-status');
      try {
        status.textContent = 'Approving...';
        status.className = 'status';
        await window.RenegotiationModule.respondToType(agreementId, 'approve');
        status.textContent = 'Approved! Reloading...';
        status.className = 'status success';
        setTimeout(() => window.location.reload(), 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    function showSuggestTypeForm() {
      document.getElementById('suggest-type-form').classList.remove('hidden');
      document.getElementById('renegotiation-approve-type-btn').disabled = true;
      document.getElementById('renegotiation-decline-btn').disabled = true;
    }

    function hideSuggestTypeForm() {
      document.getElementById('suggest-type-form').classList.add('hidden');
      document.getElementById('renegotiation-approve-type-btn').disabled = false;
      document.getElementById('renegotiation-decline-btn').disabled = false;
    }

    async function handleSubmitSuggestType() {
      const selectedType = document.querySelector('input[name="solution-type"]:checked')?.value;
      const note = document.getElementById('suggest-type-note').value;
      const status = document.getElementById('renegotiation-status');

      if (!selectedType) {
        status.textContent = 'Please select a solution type';
        status.className = 'status error';
        return;
      }

      try {
        status.textContent = 'Sending suggestion...';
        status.className = 'status';
        await window.RenegotiationModule.respondToType(agreementId, 'suggest', selectedType, note);
        status.textContent = 'Suggestion sent! Reloading...';
        status.className = 'status success';
        setTimeout(() => window.location.reload(), 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    function showDeclineForm() {
      document.getElementById('decline-form').classList.remove('hidden');
      document.getElementById('renegotiation-approve-type-btn').disabled = true;
      document.getElementById('renegotiation-suggest-type-btn').disabled = true;
    }

    function hideDeclineForm() {
      document.getElementById('decline-form').classList.add('hidden');
      document.getElementById('renegotiation-approve-type-btn').disabled = false;
      document.getElementById('renegotiation-suggest-type-btn').disabled = false;
    }

    async function handleSubmitDecline() {
      const note = document.getElementById('decline-note').value;
      const status = document.getElementById('renegotiation-status');

      try {
        status.textContent = 'Declining...';
        status.className = 'status';
        await window.RenegotiationModule.respondToType(agreementId, 'decline', null, note);
        status.textContent = 'Declined. Reloading...';
        status.className = 'status success';
        setTimeout(() => window.location.reload(), 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    async function handleAcceptSuggestedType() {
      const status = document.getElementById('renegotiation-status');
      try {
        status.textContent = 'Accepting...';
        status.className = 'status';
        await window.RenegotiationModule.respondToSuggestedType(agreementId, 'accept');
        status.textContent = 'Accepted! Reloading...';
        status.className = 'status success';
        setTimeout(() => window.location.reload(), 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    async function handleDeclineSuggestedType() {
      const status = document.getElementById('renegotiation-status');
      try {
        status.textContent = 'Declining...';
        status.className = 'status';
        await window.RenegotiationModule.respondToSuggestedType(agreementId, 'decline');
        status.textContent = 'Renegotiation cancelled. Reloading...';
        status.className = 'status success';
        setTimeout(() => window.location.reload(), 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    // Event handlers for values stage
    async function handleSubmitValues() {
      const status = document.getElementById('renegotiation-status');
      try {
        const renegotiation = await window.RenegotiationModule.loadRenegotiation(agreementId);
        const values = window.RenegotiationModule.collectValuesFromForm(renegotiation.agreed_type, renegotiation.loan_type);

        status.textContent = 'Submitting proposal...';
        status.className = 'status';
        await window.RenegotiationModule.proposeValues(agreementId, values);
        status.textContent = 'Proposal sent! Reloading...';
        status.className = 'status success';
        setTimeout(() => window.location.reload(), 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    async function handleApproveValues() {
      const status = document.getElementById('renegotiation-status');
      try {
        status.textContent = 'Approving...';
        status.className = 'status';
        await window.RenegotiationModule.respondToValues(agreementId, 'approve');
        status.textContent = 'Approved! Reloading...';
        status.className = 'status success';
        setTimeout(() => window.location.reload(), 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    function showCounterValuesForm() {
      document.getElementById('counter-values-form').classList.remove('hidden');
      document.getElementById('approve-values-btn').disabled = true;
      document.getElementById('decline-values-btn').disabled = true;
    }

    function hideCounterValuesForm() {
      document.getElementById('counter-values-form').classList.add('hidden');
      document.getElementById('approve-values-btn').disabled = false;
      document.getElementById('decline-values-btn').disabled = false;
    }

    async function handleSubmitCounterValues() {
      const status = document.getElementById('renegotiation-status');
      try {
        const renegotiation = await window.RenegotiationModule.loadRenegotiation(agreementId);
        const values = window.RenegotiationModule.collectValuesFromForm(renegotiation.agreed_type, renegotiation.loan_type);
        const note = document.getElementById('counter-values-note').value;

        status.textContent = 'Sending counter-proposal...';
        status.className = 'status';
        await window.RenegotiationModule.respondToValues(agreementId, 'counter', values, note);
        status.textContent = 'Counter-proposal sent! Reloading...';
        status.className = 'status success';
        setTimeout(() => window.location.reload(), 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    async function handleDeclineValues() {
      const status = document.getElementById('renegotiation-status');
      if (!confirm('Are you sure you want to decline this proposal?')) return;

      try {
        status.textContent = 'Declining...';
        status.className = 'status';
        await window.RenegotiationModule.respondToValues(agreementId, 'decline');
        status.textContent = 'Declined. Reloading...';
        status.className = 'status success';
        setTimeout(() => window.location.reload(), 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    async function handleAcceptCounterValues() {
      const status = document.getElementById('renegotiation-status');
      try {
        status.textContent = 'Accepting...';
        status.className = 'status';
        await window.RenegotiationModule.respondToCounterValues(agreementId, 'accept');
        status.textContent = 'Accepted! Reloading...';
        status.className = 'status success';
        setTimeout(() => window.location.reload(), 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    async function handleDeclineCounterValues() {
      const status = document.getElementById('renegotiation-status');
      if (!confirm('Are you sure you want to decline this counter-proposal?')) return;

      try {
        status.textContent = 'Declining...';
        status.className = 'status';
        await window.RenegotiationModule.respondToCounterValues(agreementId, 'decline');
        status.textContent = 'Renegotiation cancelled. Reloading...';
        status.className = 'status success';
        setTimeout(() => window.location.reload(), 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    // Payment functions
    async function loadPaymentData() {
      try {
        // Load payment history
        const res = await fetch(`/api/agreements/${agreementId}/payments`);
        if (res.ok) {
          const payments = await res.json();
          displayPayments(payments);
        }

        // Show "Record payment" button for active agreements
        if (agreement.status === 'active') {
          addRecordPaymentButton();
        }
      } catch (err) {
        console.error('Error loading payment data:', err);
      }
    }

    async function loadLoanTimeline() {
      try {
        const timelineContainer = document.getElementById('timeline-events');
        const timelineSection = document.getElementById('loan-timeline');

        // Collect all timeline events
        const events = [];

        // Event 1: Loan created
        events.push({
          type: 'created',
          date: agreement.created_at,
          title: 'Loan created',
          description: `${agreement.lender_full_name || agreement.lender_name} created this loan agreement`
        });

        // Event 2: Loan accepted (if status is active or settled)
        if (agreement.status === 'active' || agreement.status === 'settled') {
          events.push({
            type: 'accepted',
            date: agreement.created_at,
            title: 'Loan accepted',
            description: `${agreement.borrower_full_name || agreement.friend_first_name || agreement.borrower_email} accepted the loan agreement`
          });
        }

        // Event 3: Repayment issue resolved
        // (hardship requests - we only show resolved ones in timeline)

        // Event 4: Renegotiations accepted
        const renego = await window.RenegotiationModule.loadRenegotiation(agreementId);
        if (renego && renego.status === 'accepted') {
          events.push({
            type: 'negotiation_accepted',
            date: renego.updated_at,
            title: 'New terms accepted',
            description: 'Both parties agreed on new payment terms'
          });
        }

        // Event 5: Loan settled
        if (agreement.status === 'settled') {
          events.push({
            type: 'settled',
            date: agreement.updated_at,
            title: 'Loan fully repaid',
            description: 'The loan has been completely repaid and settled'
          });
        }

        // Sort events by date
        events.sort((a, b) => new Date(a.date) - new Date(b.date));

        // Render timeline
        if (events.length === 0) {
          timelineContainer.innerHTML = '<p style="color:var(--muted); font-size:14px">No timeline events yet.</p>';
        } else {
          timelineContainer.innerHTML = events.map((event, idx) => {
            const eventDate = new Date(event.date).toLocaleDateString('en-GB', {
              day: 'numeric', month: 'short', year: 'numeric'
            });
            const eventClass = event.type === 'issue' ? 'timeline-event--issue' :
                               event.type === 'resolved' ? 'timeline-event--resolved' :
                               event.type === 'settled' ? 'timeline-event--settled' : '';

            return `
              <div class="timeline-event ${eventClass}">
                <div class="timeline-event-header" onclick="toggleTimelineEvent(${idx})">
                  <div>
                    <div class="timeline-event-title">${event.title}</div>
                    <div class="timeline-event-date">${eventDate}</div>
                  </div>
                  <div style="color:var(--muted); font-size:12px">›</div>
                </div>
                <div class="timeline-event-details" id="timeline-event-${idx}">
                  <p style="margin:0; color:var(--muted); font-size:13px">${event.description}</p>
                </div>
              </div>
            `;
          }).join('');
        }

        // Show timeline section
        timelineSection.classList.remove('hidden');
      } catch (err) {
        console.error('Error loading loan timeline:', err);
      }
    }

    function toggleTimelineEvent(idx) {
      const details = document.getElementById(`timeline-event-${idx}`);
      if (details) {
        details.classList.toggle('expanded');
      }
    }

    function displayPayments(payments) {
      const paymentsList = document.getElementById('payments-list');
      const paymentHistory = document.getElementById('payment-history');

      paymentHistory.classList.remove('hidden');

      if (payments.length === 0) {
        paymentsList.innerHTML = '<p style="color:var(--muted); font-size:14px">No payments recorded yet.</p>';
        return;
      }

      const isLender = agreement.lender_user_id === currentUser.id;
      const isBorrower = agreement.borrower_user_id === currentUser.id;

      // Map method values to display names
      const methodNames = {
        'bank': 'Bank transfer',
        'cash': 'Cash',
        'paypal': 'PayPal',
        'crypto': 'Crypto',
        'other': 'Other',
        'any': 'Any method'
      };

      // Sort payments chronologically to calculate running state
      const sortedPayments = [...payments].sort((a, b) =>
        new Date(a.created_at) - new Date(b.created_at)
      );

      // Build agreement snapshots for each payment (state before payment)
      const paymentSnapshots = [];
      let runningPaidCents = 0;

      sortedPayments.forEach(payment => {
        // Create snapshot of agreement state before this payment
        const snapshot = {
          ...agreement,
          total_paid_cents: runningPaidCents,
          outstanding_cents: agreement.amount_cents - runningPaidCents
        };
        paymentSnapshots.push(snapshot);

        // Update running total (only for approved payments)
        if (payment.status === 'approved') {
          runningPaidCents += payment.amount_cents;
        }
      });

      // Now render payments in their original order (most recent first)
      paymentsList.innerHTML = payments.map(payment => {
        const amount = formatCurrency2(payment.amount_cents);
        const date = new Date(payment.created_at).toLocaleString();
        const methodDisplay = payment.method ? (methodNames[payment.method] || payment.method) : '';
        const method = methodDisplay ? `<div class="payment-method" style="color:var(--muted); margin-top:4px">Method: ${methodDisplay}</div>` : '';
        const note = payment.note ? `<div class="payment-note" style="color:var(--muted); margin-top:4px">Note: ${payment.note}</div>` : '';

        // Overpayment note (if applicable)
        let overpaymentNote = '';
        if (payment.overpaid_amount_cents && payment.overpaid_amount_cents > 0) {
          const overpaidFormatted = formatCurrency2(payment.overpaid_amount_cents);
          const recordedByBorrower = payment.recorded_by_user_id === agreement.borrower_user_id;

          if (recordedByBorrower || !currentUser || currentUser.id === agreement.borrower_user_id) {
            // Borrower view
            overpaymentNote = `<div style="background:rgba(61,220,151,0.1); border-left:2px solid var(--accent); padding:8px 12px; margin-top:8px; font-size:13px; line-height:1.6">Includes ${overpaidFormatted} overpayment. Any amount above what you owed is treated as extra, not as a new loan.</div>`;
          } else {
            // Lender view
            overpaymentNote = `<div style="background:rgba(61,220,151,0.1); border-left:2px solid var(--accent); padding:8px 12px; margin-top:8px; font-size:13px; line-height:1.6">Includes ${overpaidFormatted} overpayment. This amount is above what was needed to settle the loan.</div>`;
          }
        }

        // Determine who recorded the payment
        const recordedByBorrower = payment.recorded_by_user_id === agreement.borrower_user_id;
        const recordedByLender = payment.recorded_by_user_id === agreement.lender_user_id;
        const borrowerName = agreement.borrower_full_name || agreement.borrower_email;
        const lenderName = agreement.lender_full_name || agreement.lender_name;

        // Build status badge and meta text based on who recorded and payment status
        let statusBadge = '';
        let metaText = '';

        if (recordedByBorrower) {
          // Payment reported by borrower
          metaText = `<div class="payment-meta-line">Reported by ${borrowerName}</div>`;

          if (payment.status === 'pending') {
            statusBadge = '<span class="payment-status-badge pending">Pending confirmation</span>';
            metaText += `<div class="payment-meta-line" style="color:#ff9800">Waiting for confirmation from ${lenderName}</div>`;
          } else if (payment.status === 'approved') {
            statusBadge = '<span class="payment-status-badge approved">Approved</span>';
            metaText += `<div class="payment-meta-line" style="color:#3ddc97">Confirmed by ${lenderName}</div>`;
          } else if (payment.status === 'declined') {
            statusBadge = '<span class="payment-status-badge declined">Declined</span>';
            metaText += `<div class="payment-meta-line" style="color:#f44336">Not confirmed by ${lenderName}</div>`;
          }
        } else if (recordedByLender) {
          // Payment added by lender - auto-approved
          statusBadge = '<span class="payment-status-badge approved">Approved</span>';
          metaText = `<div class="payment-meta-line">Added by ${lenderName}</div>`;
        } else {
          // Fallback for other cases
          const recordedBy = payment.recorded_by_name || payment.recorded_by_email;
          metaText = `<div class="payment-meta-line">Recorded by ${recordedBy}</div>`;
        }

        // Proof of payment viewer (above action buttons)
        let proofButton = '';
        if (payment.proof_file_path) {
          proofButton = `
            <div style="margin-top:12px">
              <button onclick="viewProofOfPayment(${payment.id}, '${payment.proof_mime_type}', '${(payment.proof_original_name || 'Proof of payment').replace(/'/g, "\\'")}')" class="secondary" style="font-size:13px; padding:8px 12px; width:100%; text-align:left">
                📎 View proof of payment
              </button>
            </div>
          `;
        }

        // Generate payment impact annotation
        const paymentIndex = sortedPayments.findIndex(p => p.id === payment.id);
        const snapshot = paymentIndex >= 0 ? paymentSnapshots[paymentIndex] : null;
        const impactAnnotation = snapshot ? generatePaymentAnnotation(payment, snapshot) : '';

        // Approval buttons (lender only, for pending payments reported by borrower)
        let approvalButtons = '';
        if (isLender && payment.status === 'pending' && recordedByBorrower) {
          approvalButtons = `
            <div class="payment-approval-buttons" style="margin-top:12px">
              <button onclick="approvePayment(${payment.id})" style="background:#3ddc97">Confirm payment</button>
              <button onclick="declinePayment(${payment.id})" class="secondary">Decline</button>
            </div>
          `;
        }

        return `
          <div class="payment-item">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
              <div style="display:flex; align-items:center; gap:8px">
                <span class="payment-amount">${amount}</span>
                ${statusBadge}
              </div>
              <div class="payment-date">${date}</div>
            </div>
            ${method}
            ${note}
            ${overpaymentNote}
            <div style="margin-top:8px; color:var(--muted)">
              ${metaText}
            </div>
            ${impactAnnotation}
            ${proofButton}
            ${approvalButtons}
          </div>
        `;
      }).join('');
    }

    function showPaymentActionButton() {
      const paymentActionSection = document.getElementById('payment-action-section');
      const recordBtn = document.getElementById('record-payment-btn');

      // Set button text based on user role
      const isLender = agreement.lender_user_id === currentUser.id;
      const isBorrower = agreement.borrower_user_id === currentUser.id;

      if (isBorrower) {
        const lenderName = (agreement.lender_full_name || agreement.lender_name || agreement.lender_email).split(' ')[0];
        recordBtn.textContent = `Report a payment to ${lenderName}`;
      } else if (isLender) {
        const borrowerName = (agreement.borrower_full_name || agreement.friend_first_name || agreement.borrower_email).split(' ')[0];
        recordBtn.textContent = `Report a payment from ${borrowerName}`;
      } else {
        recordBtn.textContent = 'Report Payment';
      }

      recordBtn.onclick = showRecordPaymentForm;
      paymentActionSection.classList.remove('hidden');
    }

    function showRecordPaymentForm() {
      const isBorrower = agreement.borrower_user_id === currentUser.id;
      const isLender = agreement.lender_user_id === currentUser.id;

      // Update form header and button text based on user role
      const formHeader = document.getElementById('payment-form-header');
      const formSubtitle = document.getElementById('payment-form-subtitle');
      const submitBtn = document.getElementById('payment-submit-btn');
      const proofSection = document.getElementById('payment-proof-section');

      const lenderName = agreement.lender_full_name || agreement.lender_name || agreement.lender_email;
      const borrowerName = agreement.borrower_full_name || agreement.friend_first_name || agreement.borrower_email;

      const proofInput = document.getElementById('payment-proof');
      const proofLabel = document.getElementById('payment-proof-label');
      const proofHelper = document.getElementById('payment-proof-helper');

      if (isBorrower) {
        formHeader.textContent = 'Report a payment';
        formSubtitle.textContent = `Confirm your payment to ${lenderName}.`;
        submitBtn.textContent = 'Report Payment';
        // Show proof upload for borrowers
        proofSection.style.display = 'block';

        // Set proof requirement based on agreement
        if (agreement.proof_required) {
          proofLabel.textContent = 'Proof of repayment*';
          proofHelper.textContent = 'Upload a screenshot, photo or PDF that shows this repayment.';
          proofInput.required = true;
        } else {
          proofLabel.textContent = 'Proof of repayment (optional)';
          proofHelper.textContent = 'Upload a screenshot, photo or PDF of your repayment if you have it.';
          proofInput.required = false;
        }
      } else if (isLender) {
        formHeader.textContent = 'Add Received Payment';
        formSubtitle.textContent = `Confirm a payment from ${borrowerName}.`;
        submitBtn.textContent = 'Add Payment';
        // Hide proof upload for lenders
        proofSection.style.display = 'none';
        proofInput.required = false;
      } else {
        formHeader.textContent = 'Report a payment';
        formSubtitle.textContent = 'Record a payment that has been made for this agreement.';
        submitBtn.textContent = 'Report Payment';
        // Hide proof upload by default
        proofSection.style.display = 'none';
        proofInput.required = false;
      }

      // Populate payment method dropdown with only allowed methods
      const paymentMethodSelect = document.getElementById('payment-method');
      const allowedMethods = agreement.payment_preference_method
        ? agreement.payment_preference_method.split(',').map(m => m.trim())
        : [];

      // Clear existing options
      paymentMethodSelect.innerHTML = '';

      // Map method values to display names
      const methodNames = {
        'bank': 'Bank transfer',
        'cash': 'Cash',
        'paypal': 'PayPal',
        'crypto': 'Crypto',
        'other': 'Other',
        'any': 'Any method'
      };

      // If only one method allowed, auto-select it
      if (allowedMethods.length === 1) {
        const method = allowedMethods[0];
        const option = document.createElement('option');
        option.value = method;
        option.textContent = methodNames[method] || method;
        option.selected = true;
        paymentMethodSelect.appendChild(option);
      } else if (allowedMethods.length > 1) {
        // Multiple methods: add a placeholder and all allowed methods
        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'Select method...';
        paymentMethodSelect.appendChild(placeholder);

        allowedMethods.forEach(method => {
          const option = document.createElement('option');
          option.value = method;
          option.textContent = methodNames[method] || method;
          paymentMethodSelect.appendChild(option);
        });
      } else {
        // No methods specified, show all
        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'Select method...';
        paymentMethodSelect.appendChild(placeholder);

        ['cash', 'bank', 'paypal', 'crypto', 'other'].forEach(method => {
          const option = document.createElement('option');
          option.value = method;
          option.textContent = methodNames[method];
          paymentMethodSelect.appendChild(option);
        });
      }

      document.getElementById('details-section').classList.add('hidden');
      document.getElementById('payment-action-section').classList.add('hidden');
      document.getElementById('payment-history').classList.add('hidden');
      document.getElementById('record-payment-section').classList.remove('hidden');
    }

    function cancelPaymentForm() {
      document.getElementById('record-payment-section').classList.add('hidden');
      document.getElementById('details-section').classList.remove('hidden');
      document.getElementById('payment-action-section').classList.remove('hidden');
      document.getElementById('payment-history').classList.remove('hidden');

      // Clear form
      document.getElementById('payment-amount-field').value = '';
      document.getElementById('payment-method').value = '';
      document.getElementById('payment-note').value = '';
      document.getElementById('payment-proof').value = '';
      document.getElementById('payment-status').textContent = '';
    }

    async function submitPayment() {
      const status = document.getElementById('payment-status');
      const amount = parseFloat(document.getElementById('payment-amount-field').value);
      const method = document.getElementById('payment-method').value || null;
      const note = document.getElementById('payment-note').value.trim() || null;
      const proofInput = document.getElementById('payment-proof');
      const proofFile = proofInput?.files[0];

      // Validate amount
      if (!amount || amount <= 0) {
        status.textContent = 'Please enter a valid amount';
        status.className = 'status error';
        return;
      }

      // Validate payment method
      if (!method) {
        status.textContent = 'Please select a payment method';
        status.className = 'status error';
        return;
      }

      // Validate proof of repayment if required
      const isBorrower = agreement.borrower_user_id === currentUser.id;
      if (isBorrower && agreement.proof_required && !proofFile) {
        status.textContent = 'This agreement requires proof of repayment. Please upload a screenshot, photo or PDF of the repayment.';
        status.className = 'status error';
        return;
      }

      // Validate file size if present
      if (proofFile && proofFile.size > 10 * 1024 * 1024) {
        status.textContent = 'File size must be less than 10MB';
        status.className = 'status error';
        return;
      }

      status.textContent = 'Recording payment...';
      status.className = 'status';

      try {
        // Use FormData to support file upload
        const formData = new FormData();
        formData.append('amount', amount);
        if (method) formData.append('method', method);
        if (note) formData.append('note', note);
        if (proofFile) formData.append('proof', proofFile);

        const res = await fetch(`/api/agreements/${agreementId}/payments`, {
          method: 'POST',
          body: formData
          // Don't set Content-Type header - browser will set it with boundary
        });

        const data = await res.json();

        if (!res.ok) {
          status.textContent = data.error || 'Failed to record payment';
          status.className = 'status error';
          return;
        }

        status.textContent = 'Payment recorded successfully! Redirecting...';
        status.className = 'status success';

        // Update agreement data
        agreement = data.agreement;

        setTimeout(() => {
          // If agreement is now settled, redirect to dashboard
          if (agreement.status === 'settled') {
            window.location.href = '/app';
          } else {
            // Reload the page to show updated payment info
            window.location.reload();
          }
        }, 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    // Approve payment
    async function approvePayment(paymentId) {
      try {
        const res = await fetch(`/api/payments/${paymentId}/approve`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();

        if (!res.ok) {
          alert(data.error || 'Failed to approve payment');
          return;
        }

        // Reload payment data and agreement
        await loadAgreementData();
      } catch (err) {
        console.error('Error approving payment:', err);
        alert('Error approving payment');
      }
    }

    // Decline payment
    async function declinePayment(paymentId) {
      if (!confirm('Are you sure you want to decline this payment?')) {
        return;
      }

      try {
        const res = await fetch(`/api/payments/${paymentId}/decline`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();

        if (!res.ok) {
          alert(data.error || 'Failed to decline payment');
          return;
        }

        // Reload payment data and agreement
        await loadAgreementData();
      } catch (err) {
        console.error('Error declining payment:', err);
        alert('Error declining payment');
      }
    }

    // View proof of payment
    function viewProofOfPayment(paymentId, mimeType, fileName) {
      const isPdf = mimeType && mimeType === 'application/pdf';
      const secureUrl = `/api/payments/${paymentId}/proof`;

      const modal = document.getElementById('proof-modal');
      const modalContent = document.getElementById('proof-modal-content');
      const modalCaption = document.getElementById('proof-modal-caption');
      const modalDownload = document.getElementById('proof-modal-download');

      // Set caption and download link
      modalCaption.textContent = fileName || 'Proof of payment';
      modalDownload.href = secureUrl;
      modalDownload.download = fileName || 'proof-of-payment';

      if (isPdf) {
        // Show PDF in iframe/embed
        modalContent.innerHTML = `<iframe src="${secureUrl}" style="width:100%; height:80vh; border:none; background:#fff"></iframe>`;
      } else {
        // Show image
        modalContent.innerHTML = `<img src="${secureUrl}" style="max-width:100%; max-height:80vh; display:block; margin:auto">`;
      }

      modal.style.display = 'flex';
    }

    function closeProofModal() {
      const modal = document.getElementById('proof-modal');
      modal.style.display = 'none';
    }

    // Toggle collapsible sections in review
    function toggleReviewSection(sectionId) {
      const section = document.getElementById(sectionId);
      const toggle = document.getElementById(sectionId + '-toggle');

      if (section && section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        if (toggle) toggle.textContent = '▲';
      } else if (section) {
        section.classList.add('hidden');
        if (toggle) toggle.textContent = '▼';
      }
    }

    // Calculate amortization schedule for interest breakdown
    function calculateAmortizationSchedule() {
      if (!agreement.interest_rate || agreement.interest_rate === 0) {
        return [];
      }

      const n = agreement.repayment_type === 'installments' ? agreement.installment_count : 1;

      // Determine start date
      let startDate;
      if (agreement.money_sent_date && agreement.money_sent_date !== 'on-acceptance') {
        startDate = new Date(agreement.money_sent_date);
      } else {
        startDate = agreement.first_payment_date ? new Date(agreement.first_payment_date) : new Date();
      }

      // Build payment dates using frequency-based calculation
      let paymentDates = [];
      if (agreement.repayment_type === 'installments' && agreement.first_payment_date) {
        // Use frequency from agreement, fallback to 'monthly' if not set
        const frequency = agreement.payment_frequency || 'monthly';

        // Generate payment dates using frequency-based calculation with normalization
        const dateResult = generatePaymentDates({
          transferDate: startDate,
          firstDueDate: agreement.first_payment_date,
          frequency: frequency,
          count: n
        });
        paymentDates = dateResult.paymentDates;
      } else if (agreement.repayment_type === 'one_time' && agreement.due_date) {
        paymentDates.push(new Date(agreement.due_date));
      }

      // Use shared buildRepaymentSchedule function
      const schedule = buildRepaymentSchedule({
        principalCents: agreement.amount_cents,
        aprPercent: agreement.interest_rate,
        count: n,
        paymentDates: paymentDates,
        startDate: startDate
      });

      // Convert to old format for compatibility, preserving the correct dates
      return schedule.rows.map((row, index) => ({
        period: index + 1,
        dateISO: row.dateISO,  // Preserve the correct date from buildRepaymentSchedule
        payment: row.paymentCents / 100,
        principal: row.principalCents / 100,
        interest: row.interestCents / 100,
        remaining: row.remainingCents / 100
      }));
    }

    // Populate interest calculation detail for borrower review
    function populateInterestCalcDetail() {
      const card = document.getElementById('interest-calc-card');
      const content = document.getElementById('interest-calc-detail-content');

      if (!agreement.interest_rate || agreement.interest_rate === 0) {
        card.style.display = 'none';
        return;
      }

      card.classList.remove('hidden');

      const totalInterest = formatCurrency2(Math.round((agreement.total_interest || 0) * 100));
      const totalRepayCents = agreement.total_repay_amount
        ? Math.round(agreement.total_repay_amount * 100)
        : agreement.amount_cents;
      const totalRepay = formatCurrency2(totalRepayCents);
      const termText = agreement.repayment_type === 'installments' && agreement.installment_count
        ? `${agreement.installment_count} months`
        : 'one payment';

      let html = `<p style="margin:0 0 12px 0; font-size:14px">At ${agreement.interest_rate}% interest per year over ${termText}, total interest is about ${totalInterest} and total to repay is ${totalRepay}.</p>`;

      // Add detailed breakdown table for installments
      if (agreement.repayment_type === 'installments' && agreement.installment_count) {
        const schedule = calculateAmortizationSchedule();
        const firstDate = new Date(agreement.first_payment_date);
        const installmentCount = agreement.installment_count;
        const planUnit = agreement.plan_unit || 'months';

        if (schedule.length > 0) {
          // Determine current period based on total paid
          const totalPaid = agreement.total_paid_cents || 0;
          let currentPeriodIndex = -1;
          let cumulativePrincipal = 0;

          for (let i = 0; i < schedule.length; i++) {
            const row = schedule[i];
            cumulativePrincipal += row.principal * 100; // Convert to cents for comparison

            if (totalPaid < cumulativePrincipal) {
              currentPeriodIndex = i;
              break;
            }
          }

          // Container with max-height and scroll
          html += '<div style="margin:16px 0; max-height:400px; overflow-y:auto; border:1px solid rgba(55,65,81,0.5); border-radius:8px; background:rgba(12,16,21,1)">';

          // Grid container
          html += '<div style="display:grid; grid-template-columns:minmax(120px,1fr) minmax(120px,1fr) minmax(100px,1fr) minmax(120px,1fr) minmax(140px,1fr); font-size:13px">';

          // Header row (sticky)
          html += '<div style="display:contents; position:sticky; top:0; z-index:10">';
          html += '<div style="position:sticky; top:0; background:rgba(31,41,55,0.98); backdrop-filter:blur(8px); padding:10px 12px; font-weight:600; font-size:12px; text-transform:uppercase; color:rgba(156,163,175,1); border-bottom:1px solid rgba(55,65,81,0.5)">Due date</div>';
          html += '<div style="position:sticky; top:0; background:rgba(31,41,55,0.98); backdrop-filter:blur(8px); padding:10px 12px; font-weight:600; font-size:12px; text-transform:uppercase; color:rgba(156,163,175,1); border-bottom:1px solid rgba(55,65,81,0.5); text-align:right">Repayment (excl. interest)</div>';
          html += '<div style="position:sticky; top:0; background:rgba(31,41,55,0.98); backdrop-filter:blur(8px); padding:10px 12px; font-weight:600; font-size:12px; text-transform:uppercase; color:rgba(156,163,175,1); border-bottom:1px solid rgba(55,65,81,0.5); text-align:right">Interest</div>';
          html += '<div style="position:sticky; top:0; background:rgba(31,41,55,0.98); backdrop-filter:blur(8px); padding:10px 12px; font-weight:600; font-size:12px; text-transform:uppercase; color:rgba(156,163,175,1); border-bottom:1px solid rgba(55,65,81,0.5); text-align:right">Payment total</div>';
          html += '<div style="position:sticky; top:0; background:rgba(31,41,55,0.98); backdrop-filter:blur(8px); padding:10px 12px; font-weight:600; font-size:12px; text-transform:uppercase; color:rgba(156,163,175,1); border-bottom:1px solid rgba(55,65,81,0.5); text-align:right">Balance</div>';
          html += '</div>';

          // Data rows - use dates from the schedule (from buildRepaymentSchedule)
          for (let i = 0; i < installmentCount; i++) {
            const row = schedule[i];
            if (row) {
              // Use the correct date from buildRepaymentSchedule, not recalculated
              const dateStr = formatScheduleDate(row.dateISO);

              // Highlight current period
              const isCurrentPeriod = i === currentPeriodIndex;
              const rowBg = isCurrentPeriod ? 'rgba(61,124,220,0.15)' : (i % 2 === 0 ? 'rgba(12,16,21,1)' : 'rgba(10,13,17,1)');

              // Row wrapper
              html += '<div style="display:contents">';
              html += `<div style="padding:10px 12px; background:${rowBg}; border-bottom:1px solid rgba(255,255,255,0.04); white-space:nowrap; color:rgba(156,163,175,1)">${dateStr}</div>`;
              html += `<div style="padding:10px 12px; background:${rowBg}; border-bottom:1px solid rgba(255,255,255,0.04); text-align:right; font-variant-numeric:tabular-nums; white-space:nowrap">${formatEuro2(row.principal)}</div>`;
              html += `<div style="padding:10px 12px; background:${rowBg}; border-bottom:1px solid rgba(255,255,255,0.04); text-align:right; font-variant-numeric:tabular-nums; white-space:nowrap">${formatEuro2(row.interest)}</div>`;
              html += `<div style="padding:10px 12px; background:${rowBg}; border-bottom:1px solid rgba(255,255,255,0.04); text-align:right; font-variant-numeric:tabular-nums; white-space:nowrap; font-weight:600">${formatEuro2(row.payment)}</div>`;
              html += `<div style="padding:10px 12px; background:${rowBg}; border-bottom:1px solid rgba(255,255,255,0.04); text-align:right; font-variant-numeric:tabular-nums; white-space:nowrap">${formatEuro2(row.remaining)}</div>`;
              html += '</div>';
            }
          }

          html += '</div>'; // Close grid container
          html += '</div>'; // Close scroll container
        }
      }
      // For one-time loans, show the same 1-row table as in the wizard
      else if (agreement.repayment_type === 'one_time') {
        // Build the schedule using shared utility
        const startDate = agreement.money_sent_date ? new Date(agreement.money_sent_date) : new Date();
        const paymentDates = agreement.due_date ? [new Date(agreement.due_date)] : [];

        if (paymentDates.length > 0) {
          const schedule = buildRepaymentSchedule({
            principalCents: agreement.amount_cents,
            aprPercent: agreement.interest_rate,
            count: 1,
            paymentDates: paymentDates,
            startDate: startDate
          });

          if (schedule.rows && schedule.rows.length > 0) {
            html += `<div style="margin:16px 0; max-height:300px; overflow-y:auto">`;
            html += `<div style="overflow-x:auto; border:1px solid #374151; border-radius:8px">`;
            html += `<table style="width:100%; font-size:12px; border-collapse:collapse">`;
            html += `<thead><tr style="background:#1f2937; color:#9ca3af">`;
            html += `<th style="text-align:left; padding:8px; font-weight:600">Due date</th>`;
            html += `<th style="text-align:right; padding:8px; font-weight:600">Loan repayment</th>`;
            html += `<th style="text-align:right; padding:8px; font-weight:600">Interest</th>`;
            html += `<th style="text-align:right; padding:8px; font-weight:600">Payment total</th>`;
            html += `</tr></thead><tbody>`;

            const row = schedule.rows[0];
            html += `<tr style="background:#0c1015">`;
            html += `<td style="padding:8px">${formatScheduleDate(row.dateISO)}</td>`;
            html += `<td style="text-align:right; padding:8px">${formatCurrency2(row.principalCents)}</td>`;
            html += `<td style="text-align:right; padding:8px">${formatCurrency2(row.interestCents)}</td>`;
            html += `<td style="text-align:right; padding:8px; font-weight:600">${formatCurrency2(row.paymentCents)}</td>`;
            html += `</tr>`;

            html += `</tbody></table></div></div>`;
          }
        }
      }

      content.innerHTML = html;
    }

    // Populate payments and reminders detail for borrower review
    function populatePaymentsAndRemindersDetail() {
      const card = document.getElementById('payments-reminders-card');
      const content = document.getElementById('payments-reminders-detail-content');

      card.classList.remove('hidden');

      let html = '<div style="display:flex; flex-direction:column; gap:16px">';

      // Payment methods - Show list with expandable details
      html += renderPaymentMethodsInline();

      // Proof required
      const proofText = agreement.proof_required
        ? 'Yes — The borrower will be asked to upload proof for each repayment, such as a photo, screenshot or PDF of the transfer or receipt.'
        : 'No — The borrower can report repayments without uploading proof.';
      html += `<div>
        <div style="font-weight:600; margin-bottom:6px; font-size:14px">Require proof of repayment:</div>
        <div style="color:var(--muted); font-size:14px; line-height:1.5">${proofText}</div>
      </div>`;

      // Reminder mode
      const reminderMode = agreement.reminder_mode === 'auto' ? 'Auto (recommended)' : 'Custom schedule';
      html += `<div>
        <div style="font-weight:600; margin-bottom:6px; font-size:14px">Reminders:</div>
        <div style="color:var(--muted); font-size:14px; line-height:1.6">${reminderMode}</div>
      </div>`;

      // Reminder details
      if (agreement.reminder_mode === 'auto') {
        html += `<div style="color:var(--muted); font-size:13px; line-height:1.6; padding:12px; background:rgba(255,255,255,0.02); border-radius:6px">
          You'll receive reminders 7 days before, 1 day before, and on the due date. If no payment is reported, you'll get follow-up reminders 1 day after, then every 3 days.
        </div>`;
      }

      // Worst case scenario (debt collection clause) - only show if enabled
      if (agreement.debt_collection_clause) {
        html += `<div>
          <div style="font-weight:600; margin-bottom:6px; font-size:14px">Worst case scenario:</div>
          <div style="color:var(--muted); font-size:14px; line-height:1.5">If the borrower does not repay in time and ignores reminders or cannot agree a new plan with the lender, PayFriends will hand the case to an independent debt collector. Once this happens, the lender is no longer involved in collection — the third party handles it, and any collection fees are for the borrower's account.</div>
        </div>`;
      }

      html += '</div>';
      content.innerHTML = html;
    }

    // Render payment methods inline with always-visible details
    function renderPaymentMethodsInline() {
      const paymentMethodsJson = agreement.payment_methods_json;

      let html = '<div>';
      html += '<div style="font-weight:600; margin-bottom:8px; font-size:14px">Preferred payment methods:</div>';

      if (!paymentMethodsJson) {
        // Fallback to old format - just show text
        const methods = agreement.payment_preference_method
          ? agreement.payment_preference_method.split(',').map(m => m.trim())
          : [];
        const methodsText = methods.length > 0 ? methods.join(', ') : 'Not specified';
        html += `<div style="color:var(--muted); font-size:14px">${methodsText}</div>`;
        html += '</div>';
        return html;
      }

      let paymentMethods;
      try {
        paymentMethods = JSON.parse(paymentMethodsJson);
      } catch (e) {
        console.error('Error parsing payment methods JSON:', e);
        html += '<div style="color:var(--muted); font-size:14px">Error loading payment methods</div>';
        html += '</div>';
        return html;
      }

      // Filter active methods only
      const activeMethods = paymentMethods.filter(pm => pm.status === 'active');

      if (activeMethods.length === 0) {
        html += '<div style="color:var(--muted); font-size:14px">No payment methods available</div>';
        html += '</div>';
        return html;
      }

      // Check if current user is the lender
      const isLender = currentUser && agreement.lender_user_id === currentUser.id;

      // List each method with details always visible
      html += '<div style="display:flex; flex-direction:column; gap:16px; margin-left:8px">';

      activeMethods.forEach(method => {
        html += `
          <div style="display:flex; flex-direction:column; gap:8px">
            <div id="inline-details-${method.method}" style="padding:12px; background:rgba(255,255,255,0.02); border-left:2px solid var(--accent); border-radius:4px">
              <div id="inline-details-view-${method.method}">
                ${renderPaymentMethodDetailsWithEdit(method, isLender)}
              </div>
              <div id="inline-details-edit-${method.method}" class="hidden">
                ${renderPaymentMethodEditForm(method)}
              </div>
            </div>
          </div>
        `;
      });

      html += '</div>';
      html += '</div>';

      return html;
    }

    // Render payment method details with inline edit button for lenders
    function renderPaymentMethodDetailsWithEdit(method, isLender) {
      const methodInfo = getPaymentMethodInfo(method.method);

      let html = `<div style="font-size:14px; line-height:1.8; color:var(--text)">`;

      // Method header: icon+name on left, "(edit details)" action on right (for lenders)
      html += `<div style="display:flex; align-items:baseline; justify-content:space-between; margin-bottom:12px">`;
      html += `<p style="margin:0; font-weight:600">${methodInfo.icon} ${methodInfo.label}</p>`;

      // Add "(edit details)" action for lenders (except for cash which has no editable details)
      if (isLender && method.method !== 'cash') {
        html += `
          <button
            onclick="showPaymentMethodEditForm('${method.method}')"
            style="background:none; border:none; color:var(--muted); font-size:12px; cursor:pointer; padding:0; font-weight:400; transition:color 0.2s"
            onmouseover="this.style.color='var(--accent)'"
            onmouseout="this.style.color='var(--muted)'"
          >
            (edit details)
          </button>
        `;
      }

      html += `</div>`;

      // Payment method details
      if (method.method === 'cash') {
        html += `<p style="margin:0; color:var(--muted)">Pay in cash directly to the lender.</p>`;
      } else if (method.details) {
        html += `<div style="white-space:pre-wrap; font-family:monospace; background:rgba(0,0,0,0.2); padding:12px; border-radius:6px; margin:0">${escapeHtml(method.details)}</div>`;
      } else {
        html += `<p style="margin:0; color:var(--muted)">No additional details provided.</p>`;
      }

      html += `</div>`;

      return html;
    }

    // Render payment method edit form
    function renderPaymentMethodEditForm(method) {
      const methodInfo = getPaymentMethodInfo(method.method);
      let html = `<div style="font-size:14px; line-height:1.8; color:var(--text)">`;
      html += `<p style="margin:0 0 12px 0; font-weight:600">Editing ${methodInfo.label} details:</p>`;

      // Different form fields based on payment method type
      if (method.method === 'bank') {
        html += `
          <div style="margin-bottom:12px">
            <label style="display:block; margin-bottom:6px; font-weight:500; font-size:13px">Bank transfer instructions</label>
            <textarea
              id="edit-details-${method.method}"
              placeholder="Enter all information needed to receive a bank transfer, including the account holder name.&#10;&#10;Examples: IBAN, account number, routing number, sort code, BSB, SWIFT, or any regional format."
              style="width:100%; min-height:120px; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text); font-family:inherit; resize:vertical"
            >${escapeHtml(method.details || '')}</textarea>
            <p style="color:var(--muted); font-size:12px; margin:6px 0 0 0">Enter all information needed to receive a bank transfer, including the account holder name.</p>
          </div>
        `;
      } else if (method.method === 'paypal') {
        html += `
          <div style="margin-bottom:12px">
            <label style="display:block; margin-bottom:6px; font-weight:500; font-size:13px">PayPal email</label>
            <input
              id="edit-details-${method.method}"
              type="email"
              placeholder="your.email@example.com"
              value="${escapeHtml(method.details || '')}"
              style="width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text)"
            />
          </div>
        `;
      } else if (method.method === 'crypto') {
        html += `
          <div style="margin-bottom:12px">
            <label style="display:block; margin-bottom:6px; font-weight:500; font-size:13px">Crypto payment instructions</label>
            <textarea
              id="edit-details-${method.method}"
              placeholder="Include wallet address and the network.&#10;&#10;Example: 0xABC123… (ETH on ERC-20)"
              style="width:100%; min-height:100px; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text); font-family:inherit; resize:vertical"
            >${escapeHtml(method.details || '')}</textarea>
            <p style="color:var(--muted); font-size:12px; margin:6px 0 0 0">Include wallet address and the network.</p>
          </div>
        `;
      } else if (method.method === 'other') {
        html += `
          <div style="margin-bottom:12px">
            <label style="display:block; margin-bottom:6px; font-weight:500; font-size:13px">Description</label>
            <input
              id="edit-details-${method.method}"
              type="text"
              placeholder="Describe the other payment method"
              value="${escapeHtml(method.details || '')}"
              style="width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text)"
            />
          </div>
        `;
      }

      // Save and Cancel buttons
      html += `
        <div style="display:flex; gap:8px; margin-top:12px">
          <button
            onclick="savePaymentMethodDetails('${method.method}')"
            style="padding:8px 16px; background:var(--accent); color:#0d130f; border:none; border-radius:8px; font-weight:600; cursor:pointer; font-size:13px"
          >
            Save changes
          </button>
          <button
            onclick="cancelPaymentMethodEdit('${method.method}')"
            style="padding:8px 16px; background:none; border:none; color:var(--muted); cursor:pointer; text-decoration:underline; font-size:13px"
          >
            Cancel
          </button>
        </div>
      `;

      html += `</div>`;
      return html;
    }

    // Show payment method edit form
    function showPaymentMethodEditForm(methodName) {
      const viewEl = document.getElementById(`inline-details-view-${methodName}`);
      const editEl = document.getElementById(`inline-details-edit-${methodName}`);

      if (viewEl && editEl) {
        viewEl.classList.add('hidden');
        editEl.classList.remove('hidden');
      }
    }

    // Cancel payment method edit
    function cancelPaymentMethodEdit(methodName) {
      const viewEl = document.getElementById(`inline-details-view-${methodName}`);
      const editEl = document.getElementById(`inline-details-edit-${methodName}`);

      if (viewEl && editEl) {
        editEl.classList.add('hidden');
        viewEl.classList.remove('hidden');
      }
    }

    // Save payment method details
    async function savePaymentMethodDetails(methodName) {
      const detailsInput = document.getElementById(`edit-details-${methodName}`);

      if (!detailsInput) {
        console.error('Details input not found');
        return;
      }

      const newDetails = detailsInput.value.trim();

      // Validate required fields
      if (!newDetails && methodName !== 'cash') {
        alert('Please enter payment details.');
        return;
      }

      // Validate PayPal email
      if (methodName === 'paypal' && newDetails) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(newDetails)) {
          alert('Please enter a valid email address.');
          return;
        }
      }

      try {
        const response = await fetch(`/api/agreements/${agreementId}/payment-methods/${methodName}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ details: newDetails })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to update payment method details');
        }

        // Update the agreement object with new payment methods
        agreement.payment_methods_json = JSON.stringify(data.paymentMethods);

        // Reload the payment methods section
        populatePaymentsAndRemindersDetail();

        // Show success message
        showToast('Payment method details updated successfully', 'success');

        // Reload activity to show the new entry
        if (typeof loadActivity === 'function') {
          loadActivity();
        }

      } catch (error) {
        console.error('Error updating payment method details:', error);
        alert(error.message || 'Failed to update payment method details. Please try again.');
      }
    }

    // Show toast notification
    function showToast(message, type = 'info') {
      // Create toast element
      const toast = document.createElement('div');
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 20px;
        background: ${type === 'success' ? 'var(--accent)' : '#ef4444'};
        color: ${type === 'success' ? '#0d130f' : 'white'};
        border-radius: 8px;
        font-weight: 600;
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
      `;

      document.body.appendChild(toast);

      // Remove after 3 seconds
      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 300);
      }, 3000);
    }

    // Populate payment methods detail (only for active agreements)
    // REMOVED: Payment methods are now shown inline within "Repayment details & reminders"
    function populatePaymentMethodsDetail() {
      const card = document.getElementById('payment-methods-card');

      // Hide the separate payment methods section - now integrated into Repayment details & reminders
      card.classList.add('hidden');
    }

    // Populate share detail (lender only, for pending agreements)
    async function populateShareDetail() {
      const card = document.getElementById('share-card');
      const content = document.getElementById('share-detail-content');

      // Only show for lenders with pending agreements
      const isLender = agreement.lender_user_id === currentUser.id;
      if (!isLender) {
        card.style.display = 'none';
        return;
      }

      card.classList.remove('hidden');

      let html = '<div style="display:flex; flex-direction:column; gap:20px">';

      // Fetch invite token to construct URL
      try {
        const res = await fetch(`/api/agreements/${agreement.id}/invite`);
        if (res.ok) {
          const inviteData = await res.json();
          const inviteUrl = `${window.location.origin}/review?token=${inviteData.token}`;
          const borrowerName = agreement.borrower_full_name || agreement.friend_first_name || agreement.borrower_email;
          const borrowerEmail = agreement.borrower_email;
          const createdDate = new Date(inviteData.created_at).toLocaleDateString('nl-NL', {
            day: 'numeric',
            month: 'short',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });

          // Invite sent info
          const emailPart = borrowerEmail ? ` at <strong style="color:var(--text)">${borrowerEmail}</strong>` : '';
          html += `<div>
            <div style="color:var(--muted); font-size:14px">Invite sent to <strong style="color:var(--text)">${borrowerName}</strong>${emailPart} on ${createdDate}.</div>
          </div>`;

          // Share link
          html += `<div>
            <div style="font-weight:600; margin-bottom:8px; font-size:14px">Share link:</div>
            <div style="display:flex; gap:8px; align-items:center">
              <input type="text" readonly value="${inviteUrl}" id="manage-share-link" style="flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background:#0e1116; color:var(--text); font-family:monospace; font-size:13px" />
              <button onclick="copyManageShareLink()" style="width:auto; white-space:nowrap; padding:10px 16px; background:var(--accent); color:#0d130f; border:none; border-radius:10px; font-weight:600; cursor:pointer">Copy link</button>
            </div>
          </div>`;

          // QR code
          html += `<div>
            <div style="font-weight:600; margin-bottom:8px; font-size:14px">QR code:</div>
            <div id="manage-qr-code-container"></div>
          </div>`;

          html += '</div>';
          content.innerHTML = html;

          // Generate QR code
          setTimeout(() => {
            const qrContainer = document.getElementById('manage-qr-code-container');
            if (qrContainer && typeof QRCode !== 'undefined') {
              qrContainer.innerHTML = ''; // Clear any existing QR
              new QRCode(qrContainer, {
                text: inviteUrl,
                width: 200,
                height: 200,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
              });
            }
          }, 100);
        } else {
          html += '<div style="color:var(--muted); font-size:14px">Unable to load share information.</div></div>';
          content.innerHTML = html;
        }
      } catch (err) {
        console.error('Error loading invite:', err);
        html += '<div style="color:var(--muted); font-size:14px">Unable to load share information.</div></div>';
        content.innerHTML = html;
      }
    }

    // Copy share link from manage page
    function copyManageShareLink() {
      const input = document.getElementById('manage-share-link');
      input.select();
      input.setSelectionRange(0, 99999); // For mobile
      document.execCommand('copy');

      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = 'Copied!';
      setTimeout(() => {
        btn.textContent = originalText;
      }, 2000);
    }

    // Load all agreements
    async function loadAllAgreements() {
      try {
        const res = await fetch('/api/agreements');
        if (res.ok) {
          allAgreements = await res.json();
          renderAgreements();
        }
      } catch (err) {
        console.error('Error loading agreements:', err);
      }
    }

    // Filter agreements by status
    function filterByStatus(status) {
      currentFilter = status;

      // Update active tab
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.getAttribute('data-filter') === status) {
          tab.classList.add('active');
        }
      });

      renderAgreements();
    }

    // Render agreements table
    function renderAgreements() {
      // Use shared component - pass agreementId for highlighting current agreement
      renderAgreementsTable(allAgreements, currentUser, currentFilter, agreementId);
    }

    // Scroll to manage section
    function scrollToManage() {
      const manageHeader = document.getElementById('manage-header');
      if (manageHeader) {
        manageHeader.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    // Navigation functions for agreements table
    function reviewAgreement(id) {
      window.location.href = `/agreements/${id}/review`;
    }

    function viewAgreement(id) {
      window.location.href = `/agreements/${id}/manage`;
    }

    // Modal functions - redirect to manage page if not on current agreement
    function openConfirmPaymentModal(id) {
      if (id === parseInt(agreementId)) {
        // Open the modal if already on this agreement's page
        // For now, just scroll to manage section - modal implementation TBD
        scrollToManage();
      } else {
        window.location.href = `/agreements/${id}/manage`;
      }
    }

    function openDifficultyModal(id) {
      if (id === parseInt(agreementId)) {
        // Open the modal if already on this agreement's page
        // For now, just scroll to manage section - modal implementation TBD
        scrollToManage();
      } else {
        window.location.href = `/agreements/${id}/manage`;
      }
    }

    // Note: Header initialization, user info, logout, and activity count are now handled by shared header.js

    // Create initializePage wrapper for DOMContentLoaded
    function initializePage() {
      if (!agreementId) {
        // No agreement ID - show list section
        document.getElementById('list-section').classList.remove('hidden');
        document.getElementById('loading-card').classList.add('hidden');
        loadAllAgreements();
      } else {
        // Has agreement ID - hide list section immediately and show loading
        document.getElementById('list-section').classList.add('hidden');
        document.getElementById('loading-card').classList.remove('hidden');
        // Load the specific agreement
        loadAgreementData();
      }
    }
  </script>

  <!-- Shared Schedule Calculation Utility -->
  <script src="/js/schedule.js"></script>

  <!-- Shared Agreements Table Component -->
  <script src="/components/agreements-table.js"></script>

  <!-- Proof of payment modal -->
  <div id="proof-modal" onclick="closeProofModal()" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.9); align-items:center; justify-content:center;">
    <div onclick="event.stopPropagation()" style="max-width:90%; max-height:90%; width:90%; position:relative; background:#1a1f26; padding:20px; border-radius:8px; cursor:default">
      <!-- Close button -->
      <span onclick="closeProofModal()" style="position:absolute; top:10px; right:15px; color:#fff; font-size:35px; font-weight:bold; cursor:pointer; z-index:1001">&times;</span>

      <!-- Title -->
      <h3 style="color:#fff; margin:0 0 15px 0; padding-right:40px">Proof of payment</h3>

      <!-- Content container (will hold image or iframe) -->
      <div id="proof-modal-content" style="margin-bottom:15px; max-height:80vh; overflow:auto"></div>

      <!-- Caption -->
      <div id="proof-modal-caption" style="color:#ccc; font-size:14px; margin-bottom:15px"></div>

      <!-- Footer with download button -->
      <div style="display:flex; justify-content:flex-end; padding-top:12px; border-top:1px solid rgba(255,255,255,0.1)">
        <a id="proof-modal-download" href="#" download style="display:inline-block; padding:10px 20px; background:#2a2a2a; color:#fff; border:1px solid rgba(255,255,255,0.15); border-radius:8px; text-decoration:none; font-weight:500; font-size:14px; cursor:pointer; transition:all 0.2s ease">Download</a>
      </div>
    </div>
  </div>

  <!-- Accept Agreement Modal -->
  <div id="accept-modal" onclick="closeAcceptModal()" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.85); align-items:center; justify-content:center;" role="dialog" aria-modal="true" aria-labelledby="accept-modal-title">
    <div onclick="event.stopPropagation()" class="pf-review-modal" style="max-width:780px; width:100%; max-height:90vh; overflow-y:auto; position:relative; background:#1a1f26; padding:24px; border-radius:12px; cursor:default; border:1px solid rgba(255,255,255,0.1);">
      <!-- Close button -->
      <span onclick="closeAcceptModal()" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();closeAcceptModal();}" tabindex="0" role="button" style="position:absolute; top:10px; right:15px; color:#fff; font-size:28px; font-weight:bold; cursor:pointer; line-height:1;" aria-label="Close">&times;</span>

      <!-- Title -->
      <h3 id="accept-modal-title" style="color:#fff; margin:0 0 8px 0; padding-right:35px; font-size:20px; font-weight:600;">Accept this agreement?</h3>

      <!-- Lead -->
      <p style="color:var(--muted); margin:0 0 20px 0; font-size:14px; line-height:1.5;">Review the key terms below and confirm to proceed.</p>

      <!-- Key terms section -->
      <div style="background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.08); border-radius:8px; padding:16px; margin-bottom:20px; margin-top:20px;">
        <div style="font-weight:600; margin-bottom:16px; font-size:14px; color:var(--text);">Key terms</div>
        <div id="accept-modal-terms" style="display:flex; flex-direction:column; gap:10px; font-size:13px;"></div>
      </div>

      <!-- Profile name helper -->
      <p style="color:var(--muted); font-size:12px; margin-bottom:16px; line-height:1.5;">
        Make sure your name in My Profile is correct. It will appear on the signed agreement.
      </p>

      <!-- Confirmations section -->
      <div style="margin-bottom:20px; margin-top:20px;">
        <div style="font-weight:600; margin-bottom:12px; font-size:14px; color:var(--text);">Confirmations</div>
        <div style="display:flex; flex-direction:column; gap:12px;">
          <!-- Single required checkbox -->
          <label style="display:flex; align-items:start; gap:10px; cursor:pointer; padding:10px; border:1px solid rgba(255,255,255,0.1); border-radius:8px; transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.03)'" onmouseout="this.style.background='transparent'">
            <input type="checkbox" id="accept-confirm-terms" style="margin-top:2px; cursor:pointer;" onchange="validateAcceptModal()">
            <span style="color:var(--text); font-size:13px; line-height:1.5;">I confirm the above terms are correct and I agree to repay as stated.</span>
          </label>
          <p id="accept-checkbox-error" class="hidden" style="color:#ff6b6b; font-size:12px; margin:0;">Please tick this box to confirm you accept the terms.</p>
        </div>
      </div>

      <!-- Signature section -->
      <div style="margin-bottom:20px; margin-top:20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <label for="accept-signature-canvas" style="font-weight:600; font-size:14px; color:var(--text);">Sign to accept</label>
          <button type="button" id="clear-signature-btn" onclick="clearSignature()" style="background:none; border:none; color:#8691a1; font-size:12px; cursor:pointer; padding:4px 8px; text-decoration:underline;">Clear</button>
        </div>
        <div style="position:relative; width:100%; border:1px solid rgba(255,255,255,0.15); border-radius:8px; background:rgba(255,255,255,0.02);">
          <canvas id="accept-signature-canvas" style="width:100%; height:140px; display:block; cursor:crosshair; border-radius:8px; touch-action:none;"></canvas>
        </div>
        <p style="color:var(--muted); font-size:12px; margin-top:8px; line-height:1.5;">
          By signing here I confirm that I am the borrower named above and I accept this repayment agreement as legally binding.
        </p>
        <p id="accept-signature-error" class="hidden" style="color:#ff6b6b; font-size:12px; margin:6px 0 0 0;">Please add your signature to continue.</p>
      </div>

      <!-- Action buttons -->
      <div style="display:flex; gap:12px; flex-direction:row-reverse;">
        <button id="accept-modal-confirm-btn" class="btn-accept" onclick="confirmAccept()" style="width:auto; flex:1; margin-top:0; background:#22c55e; color:#0d130f; font-weight:700; border:none; padding:12px 20px; border-radius:10px; cursor:pointer; opacity:0.5;" disabled>Accept & Sign</button>
        <button class="secondary" onclick="closeAcceptModal()" style="width:auto; flex:1; margin-top:0;">Cancel</button>
      </div>

      <p class="status" id="accept-modal-status" style="text-align:center; margin-top:12px;"></p>
    </div>
  </div>

  <!-- Cancel Agreement Confirmation Modal -->
  <div id="cancel-modal" onclick="closeCancelModal()" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.85); align-items:center; justify-content:center;" role="dialog" aria-modal="true" aria-labelledby="cancel-modal-title">
    <div onclick="event.stopPropagation()" style="max-width:500px; width:90%; position:relative; background:#1a1f26; padding:24px; border-radius:12px; cursor:default; border:1px solid rgba(255,255,255,0.1);">
      <!-- Close button -->
      <span onclick="closeCancelModal()" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();closeCancelModal();}" tabindex="0" role="button" style="position:absolute; top:10px; right:15px; color:#fff; font-size:28px; font-weight:bold; cursor:pointer; line-height:1;" aria-label="Close">&times;</span>

      <!-- Title -->
      <h3 id="cancel-modal-title" style="color:#fff; margin:0 0 16px 0; padding-right:35px; font-size:20px; font-weight:600;">Cancel this request?</h3>

      <!-- Body text -->
      <p style="color:var(--text); line-height:1.6; margin:0 0 24px 0; font-size:15px;">Are you sure you want to cancel this agreement request? This will withdraw the agreement so your friend can no longer accept it.</p>

      <!-- Action buttons -->
      <div style="display:flex; gap:12px; flex-direction:row-reverse;">
        <button id="confirm-cancel-btn" class="btn-danger" onclick="confirmCancel()" style="width:auto; flex:1; margin-top:0;">Yes, cancel request</button>
        <button class="secondary" onclick="closeCancelModal()" style="width:auto; flex:1; margin-top:0;">Keep agreement</button>
      </div>
    </div>
  </div>

</body>
</html>
