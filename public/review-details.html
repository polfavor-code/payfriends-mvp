<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PayFriends — Agreement Details</title>
  <style>
    :root{
      --bg:#0e1116; --card:#151a21; --text:#e6eef6; --muted:#a7b0bd; --accent:#3ddc97;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif; background:var(--bg); color:var(--text); padding:32px 16px;}
    .container{max-width:600px; margin:0 auto;}
    .card{background:var(--card); border:1px solid rgba(255,255,255,0.06); border-radius:16px; padding:24px; margin:16px 0}
    h1{margin:0 0 8px 0; font-size:24px}
    h2{margin:0 0 16px 0; font-size:20px}
    p{color:var(--muted); line-height:1.6; margin:8px 0}
    .detail-row{display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.08)}
    .detail-row:last-child{border-bottom:none}
    .detail-label{color:var(--muted); font-weight:500}
    .detail-value{color:var(--text); font-weight:600}
    button{padding:12px 20px; border-radius:10px; border:0; background:var(--accent); color:#0d130f; font-weight:700; cursor:pointer; font-size:14px; width:100%}
    button:hover{filter:brightness(1.06)}
    button.secondary{background:transparent; border:1px solid rgba(255,255,255,0.15); color:var(--text); margin-top:8px}
    button.secondary:hover{background:rgba(255,255,255,0.05)}
    button.tertiary{background:transparent; border:1px solid rgba(255,255,255,0.10); color:var(--muted); margin-top:8px}
    button.tertiary:hover{background:rgba(255,255,255,0.03)}
    .status{color:var(--muted); margin-top:12px; min-height:1.2em; font-size:14px}
    .hidden{display:none}
    .error{color:#ff6b6b}
    .success{color:var(--accent)}
    .amount{font-size:32px; font-weight:700; color:var(--accent); text-align:center; margin:16px 0}
    .note{background:rgba(61,220,151,0.1); border:1px solid rgba(61,220,151,0.2); border-radius:8px; padding:12px; color:var(--text); font-size:14px; margin:16px 0}
    .back-link{display:inline-block; margin-bottom:16px; color:var(--accent); text-decoration:none; font-size:14px}
    .back-link:hover{text-decoration:underline}
    .status-badge{display:inline-block; padding:4px 10px; border-radius:6px; font-size:12px; font-weight:600}
    .status-badge.pending{background:#4a4a4a; color:#fff}
    .status-badge.active{background:#3d7bdc; color:#fff}
    .status-badge.settled{background:#3ddc97; color:#0d130f}
    .status-badge.declined{background:#ff6b6b; color:#fff}
    .status-badge.cancelled{background:#6c757d; color:#fff}
    .alert-box{background:rgba(255,165,0,0.1); border:1px solid rgba(255,165,0,0.3); border-radius:8px; padding:12px; color:var(--text); font-size:14px; margin:16px 0}
    .form-group{margin:20px 0}
    .form-label{display:block; color:var(--text); font-weight:600; margin-bottom:8px; font-size:14px}
    .form-radio{display:block; margin:8px 0; padding:10px; border:1px solid rgba(255,255,255,0.1); border-radius:8px; cursor:pointer; transition:background 0.2s}
    .form-radio:hover{background:rgba(255,255,255,0.03)}
    .form-radio input{margin-right:8px}
    .form-radio label{cursor:pointer; color:var(--text); font-size:14px}
    .form-checkbox{display:block; margin:8px 0; padding:10px; border:1px solid rgba(255,255,255,0.1); border-radius:8px; cursor:pointer; transition:background 0.2s}
    .form-checkbox:hover{background:rgba(255,255,255,0.03)}
    .form-checkbox input{margin-right:8px}
    .form-checkbox label{cursor:pointer; color:var(--text); font-size:14px}
    textarea{width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background:var(--bg); color:var(--text); font-family:inherit; font-size:14px; resize:vertical; min-height:80px}
    textarea::placeholder{color:var(--muted)}
    input[type="number"]{width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background:var(--bg); color:var(--text); font-family:inherit; font-size:14px}
    input[type="number"]::placeholder{color:var(--muted)}
    .summary-box{background:rgba(61,220,151,0.05); border:1px solid rgba(61,220,151,0.2); border-radius:8px; padding:16px; margin:16px 0}
    .summary-item{margin:8px 0; color:var(--text); font-size:14px}
    .summary-label{color:var(--muted); font-weight:600}
    button.warning{background:#ff9800; color:#0d130f}
    button.warning:hover{filter:brightness(1.1)}
    .payment-item{background:#10151d; border-radius:8px; padding:12px; margin:12px 0; border:1px solid rgba(255,255,255,0.08)}
    .payment-date{color:var(--muted); font-size:12px}
    .payment-amount{font-weight:700; color:var(--accent); font-size:16px}
    .payment-method{color:var(--muted); font-size:13px; font-style:italic}
    .payment-note{color:var(--text); font-size:13px; margin-top:4px}
    .payment-recorded-by{color:var(--muted); font-size:12px; margin-top:4px}
    .record-payment-btn{background:#3d7bdc; margin-top:16px}
    .record-payment-btn:hover{filter:brightness(1.1)}
    select{appearance:none; background-image:url('data:image/svg+xml;utf8,<svg fill="%23a7b0bd" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>'); background-repeat:no-repeat; background-position:right 8px center}
    .payment-status-badge{display:inline-block; padding:4px 10px; border-radius:6px; font-size:12px; font-weight:600; margin-left:8px}
    .payment-status-badge.approved{background:#3ddc97; color:#0d130f}
    .payment-status-badge.pending{background:#ff9800; color:#0d130f}
    .payment-status-badge.declined{background:#ff6b6b; color:#fff}
    .payment-approval-buttons{margin-top:8px; display:flex; gap:8px}
    .payment-approval-buttons button{width:auto; padding:8px 16px; font-size:13px}
    .hardship-button-spacing{margin-top:20px}
    .form-section{background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:20px; margin-bottom:24px}
    .form-section-title{font-size:16px; font-weight:600; color:var(--text); margin-bottom:12px}
  </style>
</head>
<body>
  <div class="container">
    <a href="/app" class="back-link">← Back to Dashboard</a>

    <div class="card">
      <h1 id="page-title">Agreement Details</h1>
      <p id="loading-text">Loading agreement details...</p>
    </div>

    <!-- Agreement details -->
    <div id="details-section" class="card hidden">
      <h2>Agreement Details</h2>

      <div class="amount" id="amount-display"></div>

      <div style="margin:16px 0">
        <div class="detail-row">
          <span class="detail-label">From (Lender)</span>
          <span class="detail-value" id="lender-name"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">To (Borrower)</span>
          <span class="detail-value" id="borrower-name"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Due date</span>
          <span class="detail-value" id="due-date"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Repayment type</span>
          <span class="detail-value" id="repayment-type"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Status</span>
          <span class="detail-value" id="status-display"></span>
        </div>
      </div>

      <!-- Borrower review actions (only for pending agreements) -->
      <div id="borrower-actions" class="hidden">
        <div class="note">
          By accepting this agreement, you confirm the terms and agree to repay the amount by the due date.
        </div>

        <button onclick="handleAccept()">Accept Agreement</button>
        <button class="secondary" onclick="handleDecline()">Decline</button>
        <button class="tertiary" onclick="handleReviewLater()">Review Later</button>
      </div>

      <!-- Lender actions (only for pending agreements) -->
      <div id="lender-actions" class="hidden">
        <button class="secondary" onclick="handleCancel()" style="width:100%">Cancel request</button>

        <div class="note" style="background:rgba(255,107,107,0.1); border:1px solid rgba(255,107,107,0.2); margin-top:8px">
          <p style="margin:0; font-size:14px">This will withdraw the agreement so your friend can no longer accept it.</p>
        </div>
      </div>

      <!-- View-only mode (no actions) -->
      <div id="view-only" class="hidden">
        <p style="text-align:center; color:var(--muted); font-size:14px; margin-top:16px">
          This agreement is currently <span id="status-text"></span>.
        </p>
      </div>

      <!-- Hardship indicator for lender -->
      <div id="hardship-indicator" class="hidden">
        <div class="alert-box">
          <strong>Needs attention:</strong> Borrower has requested help with this payment. Check Activity for details.
        </div>
      </div>

      <!-- Having trouble paying button for borrower -->
      <div id="hardship-button" class="hidden hardship-button-spacing">
        <button class="warning" onclick="showHardshipForm()">Having trouble paying?</button>
      </div>

      <p class="status" id="action-status"></p>
    </div>

    <!-- Payment summary (for active and settled agreements) -->
    <div id="payment-summary" class="card hidden">
      <h2>Payment Summary</h2>
      <div style="margin:16px 0">
        <div class="detail-row">
          <span class="detail-label">Original amount</span>
          <span class="detail-value" id="original-amount"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Total paid</span>
          <span class="detail-value" id="total-paid"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Outstanding</span>
          <span class="detail-value" id="outstanding-amount"></span>
        </div>
      </div>
    </div>

    <!-- Payment history (for active and settled agreements) -->
    <div id="payment-history" class="card hidden">
      <h2>Payment History</h2>
      <div id="payments-list">
        <p style="color:var(--muted); font-size:14px">No payments recorded yet.</p>
      </div>
    </div>

    <!-- Record payment form (for active agreements) -->
    <div id="record-payment-section" class="card hidden">
      <h2>Record a Payment</h2>
      <p style="color:var(--muted); font-size:14px; margin-bottom:16px">
        Record a payment that has been made for this agreement.
      </p>

      <div class="form-group">
        <label class="form-label" for="payment-amount-field">Amount (EUR)</label>
        <input type="number" id="payment-amount-field" placeholder="e.g. 50" min="0" step="0.01">
      </div>

      <div class="form-group">
        <label class="form-label" for="payment-method">Payment method (optional)</label>
        <select id="payment-method" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background:var(--bg); color:var(--text); font-family:inherit; font-size:14px">
          <option value="">Select method...</option>
          <option value="cash">Cash</option>
          <option value="bank">Bank transfer</option>
          <option value="crypto">Crypto</option>
          <option value="other">Other</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label" for="payment-note">Note (optional)</label>
        <textarea id="payment-note" placeholder="Add any details about this payment..."></textarea>
      </div>

      <button onclick="submitPayment()">Record Payment</button>
      <button class="secondary" onclick="cancelPaymentForm()">Cancel</button>

      <p class="status" id="payment-status"></p>
    </div>

    <!-- Hardship request form -->
    <div id="hardship-form" class="card hidden">
      <h2>Request Payment Assistance</h2>
      <p style="color:var(--muted); margin-bottom:20px">
        Let us know what's making this payment difficult. We'll share your situation with your friend to work out a new plan together.
      </p>

      <!-- Step 1: Reason -->
      <div class="form-section">
        <div class="form-section-title">What's making it hard to pay on time?</div>

        <div class="form-radio">
          <input type="radio" name="reason" id="reason-unexpected" value="unexpected_expense">
          <label for="reason-unexpected">Unexpected expense (medical, car, etc.)</label>
        </div>

        <div class="form-radio">
          <input type="radio" name="reason" id="reason-income" value="income_lower">
          <label for="reason-income">Income temporarily lower</label>
        </div>

        <div class="form-radio">
          <input type="radio" name="reason" id="reason-job" value="job_loss">
          <label for="reason-job">Lost my job / work changed</label>
        </div>

        <div class="form-radio">
          <input type="radio" name="reason" id="reason-miscalc" value="miscalculated">
          <label for="reason-miscalc">I miscalculated what I could afford</label>
        </div>

        <div class="form-radio">
          <input type="radio" name="reason" id="reason-other" value="other">
          <label for="reason-other">Something else</label>
        </div>
      </div>

      <div class="form-section">
        <div class="form-section-title">Explain in your own words (optional but recommended)</div>
        <textarea id="reason-text" placeholder="Tell your friend more about your situation..."></textarea>
      </div>

      <!-- Step 2: Can pay now -->
      <div class="form-section">
        <div class="form-section-title">Can you pay something now?</div>
        <p style="color:var(--muted); font-size:14px; margin-top:4px; margin-bottom:12px">
          Even a small payment will show your commitment to <span id="lender-first-name-text"></span>.
        </p>

        <div class="form-radio">
          <input type="radio" name="can-pay" id="can-pay-yes" value="yes" onchange="togglePaymentAmount()">
          <label for="can-pay-yes">Yes, I can pay some of it now</label>
        </div>

        <div class="form-radio">
          <input type="radio" name="can-pay" id="can-pay-no" value="no" onchange="togglePaymentAmount()">
          <label for="can-pay-no">No, I can't pay anything right now</label>
        </div>

        <div id="payment-amount-input" class="hidden" style="margin-top:16px">
          <label class="form-label" for="payment-amount">Amount I can pay now (EUR)</label>
          <input type="number" id="payment-amount" placeholder="e.g. 50" min="0" step="1">
        </div>
      </div>

      <!-- Step 3: Preferred adjustments -->
      <div class="form-section">
        <div class="form-section-title">What kind of new plan would feel most realistic for you? (Check all that apply)</div>

        <div class="form-checkbox">
          <input type="checkbox" id="adj-smaller" value="smaller_payments_longer_period">
          <label for="adj-smaller">Pay a smaller amount each month over a longer period</label>
        </div>

        <div class="form-checkbox">
          <input type="checkbox" id="adj-skip" value="skip_or_reduce_next">
          <label for="adj-skip">Skip or reduce this upcoming payment, and increase the later payments to catch up.</label>
        </div>

        <div class="form-checkbox">
          <input type="checkbox" id="adj-partial" value="partial_now_rest_later">
          <label for="adj-partial">Pay part now and move the rest to a later date</label>
        </div>

        <div class="form-checkbox">
          <input type="checkbox" id="adj-lower" value="lower_monthly_higher_interest">
          <label for="adj-lower">Lower the monthly amount, even if the total interest becomes higher and the loan runs longer.</label>
        </div>

        <div class="form-checkbox">
          <input type="checkbox" id="adj-unsure" value="not_sure_please_suggest">
          <label for="adj-unsure">I'm not sure – please suggest something for us</label>
        </div>
      </div>

      <!-- Step 4: Summary -->
      <div class="form-group">
        <label class="form-label">Summary</label>
        <div class="summary-box">
          <p style="margin:0 0 12px 0; color:var(--text)">This is what will be shared with your friend:</p>
          <div class="summary-item">
            <span class="summary-label">Reason:</span> <span id="summary-reason">-</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Can pay now:</span> <span id="summary-pay">-</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Preferred options:</span> <span id="summary-adjustments">-</span>
          </div>
        </div>
      </div>

      <button onclick="submitHardshipRequest()">Send request</button>
      <button class="secondary" onclick="cancelHardshipForm()">Cancel</button>

      <p class="status" id="hardship-status"></p>
    </div>

    <!-- Error state -->
    <div id="error-section" class="card hidden">
      <h2>Error</h2>
      <p id="error-message">Unable to load agreement details.</p>
      <a href="/app" style="display:inline-block; margin-top:16px; padding:10px 20px; background:var(--accent); color:#0d130f; border-radius:10px; text-decoration:none; font-weight:600">Go to Dashboard</a>
    </div>
  </div>

  <script>
    let agreement = null;
    let currentUser = null;
    let mode = 'view'; // 'review' or 'view'
    const pathParts = window.location.pathname.split('/');
    const agreementId = pathParts[2];
    const action = pathParts[3]; // 'review' or 'view'

    // Format amount in cents to euros with thousand separators, no decimals
    function formatAmount(cents) {
      const euros = Math.round(cents / 100);
      return new Intl.NumberFormat('de-DE').format(euros);
    }

    async function loadAgreementData() {
      try {
        // Fetch current user
        const userRes = await fetch('/api/user');
        if (!userRes.ok) {
          window.location.href = '/';
          return;
        }
        const userData = await userRes.json();
        currentUser = userData.user;

        // Fetch agreement
        const res = await fetch(`/api/agreements/${agreementId}`);
        if (!res.ok) {
          showError('Agreement not found or you do not have access to it.');
          return;
        }
        agreement = await res.json();

        // Determine mode based on URL and user role
        const isLender = agreement.lender_user_id === currentUser.id;
        const isBorrower = agreement.borrower_user_id === currentUser.id;

        if (action === 'review' && isBorrower && agreement.status === 'pending') {
          mode = 'review';
          showReviewSection();
        } else {
          mode = 'view';
          showViewSection();
        }
      } catch (err) {
        console.error('Error loading agreement:', err);
        showError('An error occurred while loading the agreement.');
      }
    }

    function showReviewSection() {
      document.getElementById('loading-text').parentElement.classList.add('hidden');
      document.getElementById('details-section').classList.remove('hidden');
      document.getElementById('page-title').textContent = 'Review Agreement';

      populateDetails();

      // Check if agreement is cancelled
      if (agreement.status === 'cancelled') {
        // Show cancelled message, hide all action buttons
        document.getElementById('borrower-actions').classList.add('hidden');
        document.getElementById('lender-actions').classList.add('hidden');
        document.getElementById('view-only').classList.remove('hidden');
        document.getElementById('status-text').textContent = 'no longer available. The lender cancelled the request';
      } else {
        // Show borrower actions
        document.getElementById('borrower-actions').classList.remove('hidden');
        document.getElementById('view-only').classList.add('hidden');
        document.getElementById('lender-actions').classList.add('hidden');
      }
    }

    async function showViewSection() {
      document.getElementById('loading-text').parentElement.classList.add('hidden');
      document.getElementById('details-section').classList.remove('hidden');
      document.getElementById('page-title').textContent = 'Agreement Details';

      populateDetails();

      // Hide borrower actions
      document.getElementById('borrower-actions').classList.add('hidden');

      const isLender = agreement.lender_user_id === currentUser.id;
      const isBorrower = agreement.borrower_user_id === currentUser.id;

      // Check if this is a lender viewing a pending agreement
      if (isLender && agreement.status === 'pending') {
        // Show lender actions (cancel button)
        document.getElementById('lender-actions').classList.remove('hidden');
        document.getElementById('view-only').classList.add('hidden');
      } else {
        // Show view-only mode
        document.getElementById('lender-actions').classList.add('hidden');
        document.getElementById('view-only').classList.remove('hidden');
        document.getElementById('status-text').textContent = agreement.status;
      }

      // Check for hardship requests
      const hasHardshipRequests = await checkHardshipRequests();

      // Show hardship indicator for lender if there are requests
      if (isLender && hasHardshipRequests && agreement.status === 'active') {
        document.getElementById('hardship-indicator').classList.remove('hidden');
      }

      // Show "Having trouble paying?" button for borrower on active agreements
      if (isBorrower && agreement.status === 'active') {
        document.getElementById('hardship-button').classList.remove('hidden');
      }

      // Show payment sections for active and settled agreements
      if (agreement.status === 'active' || agreement.status === 'settled') {
        await loadPaymentData();
      }
    }

    function populateDetails() {
      const amount = formatAmount(agreement.amount_cents);
      document.getElementById('amount-display').textContent = `€ ${amount}`;

      const lenderName = agreement.lender_full_name || agreement.lender_name || agreement.lender_email;
      document.getElementById('lender-name').textContent = lenderName;

      const borrowerName = agreement.borrower_full_name || agreement.friend_first_name || agreement.borrower_email;
      document.getElementById('borrower-name').textContent = borrowerName;

      document.getElementById('due-date').textContent = new Date(agreement.due_date).toLocaleDateString();

      const repaymentType = agreement.repayment_type === 'one_time' ? 'One-time payment' : agreement.repayment_type;
      document.getElementById('repayment-type').textContent = repaymentType;

      const statusText = agreement.status || 'pending';
      document.getElementById('status-display').innerHTML = `<span class="status-badge ${statusText}">${statusText}</span>`;
    }

    function showError(message) {
      document.getElementById('loading-text').parentElement.classList.add('hidden');
      document.getElementById('error-section').classList.remove('hidden');
      document.getElementById('error-message').textContent = message;
    }

    async function handleAccept() {
      const status = document.getElementById('action-status');
      status.textContent = 'Accepting...';
      status.className = 'status';

      try {
        const res = await fetch(`/api/agreements/${agreementId}/accept`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();

        if (!res.ok) {
          status.textContent = data.error || 'Failed to accept';
          status.className = 'status error';
          return;
        }

        status.textContent = 'Agreement accepted! Redirecting...';
        status.className = 'status success';

        setTimeout(() => {
          window.location.href = '/app';
        }, 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    async function handleDecline() {
      if (!confirm('Are you sure you want to decline this agreement?')) {
        return;
      }

      const status = document.getElementById('action-status');
      status.textContent = 'Declining...';
      status.className = 'status';

      try {
        const res = await fetch(`/api/agreements/${agreementId}/decline`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();

        if (!res.ok) {
          status.textContent = data.error || 'Failed to decline';
          status.className = 'status error';
          return;
        }

        status.textContent = 'Agreement declined. Redirecting...';
        status.className = 'status success';

        setTimeout(() => {
          window.location.href = '/app';
        }, 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    async function handleReviewLater() {
      const status = document.getElementById('action-status');
      status.textContent = 'Saving...';
      status.className = 'status';

      try {
        const res = await fetch(`/api/agreements/${agreementId}/review-later`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();

        if (!res.ok) {
          status.textContent = data.error || 'Failed to save';
          status.className = 'status error';
          return;
        }

        status.textContent = 'Saved! Redirecting to dashboard...';
        status.className = 'status success';

        setTimeout(() => {
          window.location.href = '/app';
        }, 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    async function handleCancel() {
      if (!confirm('Are you sure you want to cancel this agreement request? Your friend will no longer be able to accept it.')) {
        return;
      }

      const status = document.getElementById('action-status');
      status.textContent = 'Cancelling...';
      status.className = 'status';

      try {
        const res = await fetch(`/api/agreements/${agreementId}/cancel`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();

        if (!res.ok) {
          status.textContent = data.error || 'Failed to cancel';
          status.className = 'status error';
          return;
        }

        status.textContent = 'Agreement cancelled. Redirecting...';
        status.className = 'status success';

        setTimeout(() => {
          window.location.href = '/app';
        }, 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    // Hardship form functions
    function showHardshipForm() {
      document.getElementById('details-section').classList.add('hidden');
      document.getElementById('hardship-form').classList.remove('hidden');

      // Set lender's first name
      const lenderName = agreement.lender_full_name || agreement.lender_name;
      const lenderFirstName = lenderName ? lenderName.split(' ')[0] : lenderName;
      document.getElementById('lender-first-name-text').textContent = lenderFirstName || 'your friend';

      // Add event listeners for live summary updates
      document.querySelectorAll('input[name="reason"]').forEach(input => {
        input.addEventListener('change', updateSummary);
      });
      document.querySelectorAll('input[name="can-pay"]').forEach(input => {
        input.addEventListener('change', updateSummary);
      });
      document.getElementById('payment-amount').addEventListener('input', updateSummary);
      document.querySelectorAll('input[type="checkbox"]').forEach(input => {
        input.addEventListener('change', updateSummary);
      });
    }

    function cancelHardshipForm() {
      document.getElementById('hardship-form').classList.add('hidden');
      document.getElementById('details-section').classList.remove('hidden');
    }

    function togglePaymentAmount() {
      const canPayYes = document.getElementById('can-pay-yes').checked;
      const amountInput = document.getElementById('payment-amount-input');

      if (canPayYes) {
        amountInput.classList.remove('hidden');
      } else {
        amountInput.classList.add('hidden');
        document.getElementById('payment-amount').value = '';
      }
    }

    function updateSummary() {
      // Update reason
      const reasonInput = document.querySelector('input[name="reason"]:checked');
      const reasonText = reasonInput ? reasonInput.nextElementSibling.textContent : '-';
      document.getElementById('summary-reason').textContent = reasonText;

      // Update can pay now
      const canPayYes = document.getElementById('can-pay-yes').checked;
      const canPayNo = document.getElementById('can-pay-no').checked;
      const paymentAmount = document.getElementById('payment-amount').value;

      let payText = '-';
      if (canPayYes && paymentAmount) {
        payText = `€${paymentAmount}`;
      } else if (canPayYes) {
        payText = 'Yes (amount not specified)';
      } else if (canPayNo) {
        payText = 'Cannot pay right now';
      }
      document.getElementById('summary-pay').textContent = payText;

      // Update preferred adjustments
      const adjustments = [];
      document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
        adjustments.push(cb.nextElementSibling.textContent);
      });
      const adjustText = adjustments.length > 0 ? adjustments.join('; ') : '-';
      document.getElementById('summary-adjustments').textContent = adjustText;
    }

    async function submitHardshipRequest() {
      const status = document.getElementById('hardship-status');

      // Validate form
      const reasonInput = document.querySelector('input[name="reason"]:checked');
      if (!reasonInput) {
        status.textContent = 'Please select a reason';
        status.className = 'status error';
        return;
      }

      const adjustmentCheckboxes = document.querySelectorAll('input[type="checkbox"]:checked');
      if (adjustmentCheckboxes.length === 0) {
        status.textContent = 'Please select at least one preferred adjustment option';
        status.className = 'status error';
        return;
      }

      // Gather form data
      const reasonCategory = reasonInput.value;
      const reasonText = document.getElementById('reason-text').value.trim() || null;

      const canPayYes = document.getElementById('can-pay-yes').checked;
      let canPayNowCents = null;
      if (canPayYes) {
        const paymentAmount = parseFloat(document.getElementById('payment-amount').value);
        if (paymentAmount && paymentAmount > 0) {
          canPayNowCents = Math.round(paymentAmount * 100);
        }
      }

      const preferredAdjustments = Array.from(adjustmentCheckboxes).map(cb => cb.value);

      status.textContent = 'Sending request...';
      status.className = 'status';

      try {
        const res = await fetch(`/api/agreements/${agreementId}/hardship-request`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            reasonCategory,
            reasonText,
            canPayNowCents,
            preferredAdjustments
          })
        });

        const data = await res.json();

        if (!res.ok) {
          status.textContent = data.error || 'Failed to send request';
          status.className = 'status error';
          return;
        }

        status.textContent = 'Request sent! We\'ve shared your situation and preferences with your friend. Redirecting...';
        status.className = 'status success';

        setTimeout(() => {
          window.location.href = '/app';
        }, 2000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    async function checkHardshipRequests() {
      try {
        const res = await fetch(`/api/agreements/${agreementId}/hardship-requests`);
        if (res.ok) {
          const requests = await res.json();
          return requests.length > 0;
        }
      } catch (err) {
        console.error('Error checking hardship requests:', err);
      }
      return false;
    }

    // Payment functions
    async function loadPaymentData() {
      try {
        // Show payment summary
        document.getElementById('payment-summary').classList.remove('hidden');
        document.getElementById('original-amount').textContent = `€ ${formatAmount(agreement.amount_cents)}`;
        document.getElementById('total-paid').textContent = `€ ${formatAmount(agreement.total_paid_cents || 0)}`;
        document.getElementById('outstanding-amount').textContent = `€ ${formatAmount(agreement.outstanding_cents || agreement.amount_cents)}`;

        // Load payment history
        const res = await fetch(`/api/agreements/${agreementId}/payments`);
        if (res.ok) {
          const payments = await res.json();
          displayPayments(payments);
        }

        // Show "Record payment" button for active agreements
        if (agreement.status === 'active') {
          addRecordPaymentButton();
        }
      } catch (err) {
        console.error('Error loading payment data:', err);
      }
    }

    function displayPayments(payments) {
      const paymentsList = document.getElementById('payments-list');
      const paymentHistory = document.getElementById('payment-history');

      paymentHistory.classList.remove('hidden');

      if (payments.length === 0) {
        paymentsList.innerHTML = '<p style="color:var(--muted); font-size:14px">No payments recorded yet.</p>';
        return;
      }

      const isLender = agreement.lender_user_id === currentUser.id;
      const isBorrower = agreement.borrower_user_id === currentUser.id;

      paymentsList.innerHTML = payments.map(payment => {
        const amount = formatAmount(payment.amount_cents);
        const date = new Date(payment.created_at).toLocaleString();
        const recordedBy = payment.recorded_by_name || payment.recorded_by_email;
        const method = payment.method ? `<div class="payment-method">Method: ${payment.method}</div>` : '';
        const note = payment.note ? `<div class="payment-note">Note: ${payment.note}</div>` : '';

        // Status badge
        let statusBadge = '';
        let statusText = '';
        if (payment.status === 'pending') {
          if (isBorrower) {
            const lenderFirstName = agreement.lender_full_name ? agreement.lender_full_name.split(' ')[0] : agreement.lender_name;
            statusText = `<div class="payment-recorded-by" style="color:#ff9800">Pending approval by ${lenderFirstName}</div>`;
          } else {
            statusBadge = '<span class="payment-status-badge pending">Pending approval</span>';
          }
        } else if (payment.status === 'declined') {
          statusBadge = '<span class="payment-status-badge declined">Declined</span>';
        } else if (payment.status === 'approved') {
          // Only show approved badge if there are pending/declined payments in the list
          const hasPendingOrDeclined = payments.some(p => p.status === 'pending' || p.status === 'declined');
          if (hasPendingOrDeclined) {
            statusBadge = '<span class="payment-status-badge approved">Approved</span>';
          }
        }

        // Approval buttons (lender only, for pending payments reported by borrower)
        let approvalButtons = '';
        if (isLender && payment.status === 'pending' && payment.recorded_by_user_id === agreement.borrower_user_id) {
          approvalButtons = `
            <div class="payment-approval-buttons">
              <button onclick="approvePayment(${payment.id})" style="background:#3ddc97">Approve</button>
              <button onclick="declinePayment(${payment.id})" class="secondary">Decline</button>
            </div>
          `;
        }

        return `
          <div class="payment-item">
            <div style="display:flex; justify-content:space-between; align-items:center">
              <div>
                <span class="payment-amount">€ ${amount}</span>
                ${statusBadge}
              </div>
              <div class="payment-date">${date}</div>
            </div>
            ${method}
            ${note}
            ${statusText || `<div class="payment-recorded-by">Recorded by ${recordedBy}</div>`}
            ${approvalButtons}
          </div>
        `;
      }).join('');
    }

    function addRecordPaymentButton() {
      const viewOnly = document.getElementById('view-only');

      // Add "Record payment" button if it doesn't already exist
      if (!document.getElementById('record-payment-btn')) {
        const recordBtn = document.createElement('button');
        recordBtn.id = 'record-payment-btn';
        recordBtn.className = 'record-payment-btn';

        // Set button text based on user role
        const isBorrower = agreement.borrower_user_id === currentUser.id;
        const isLender = agreement.lender_user_id === currentUser.id;

        if (isBorrower) {
          recordBtn.textContent = 'I\'ve Made a Payment';
        } else if (isLender) {
          recordBtn.textContent = 'Add Received Payment';
        } else {
          recordBtn.textContent = 'Record a Payment';
        }

        recordBtn.onclick = showRecordPaymentForm;
        viewOnly.appendChild(recordBtn);
      }
    }

    function showRecordPaymentForm() {
      document.getElementById('details-section').classList.add('hidden');
      document.getElementById('payment-summary').classList.add('hidden');
      document.getElementById('payment-history').classList.add('hidden');
      document.getElementById('record-payment-section').classList.remove('hidden');
    }

    function cancelPaymentForm() {
      document.getElementById('record-payment-section').classList.add('hidden');
      document.getElementById('details-section').classList.remove('hidden');
      document.getElementById('payment-summary').classList.remove('hidden');
      document.getElementById('payment-history').classList.remove('hidden');

      // Clear form
      document.getElementById('payment-amount-field').value = '';
      document.getElementById('payment-method').value = '';
      document.getElementById('payment-note').value = '';
      document.getElementById('payment-status').textContent = '';
    }

    async function submitPayment() {
      const status = document.getElementById('payment-status');
      const amount = parseFloat(document.getElementById('payment-amount-field').value);
      const method = document.getElementById('payment-method').value || null;
      const note = document.getElementById('payment-note').value.trim() || null;

      // Validate amount
      if (!amount || amount <= 0) {
        status.textContent = 'Please enter a valid amount';
        status.className = 'status error';
        return;
      }

      status.textContent = 'Recording payment...';
      status.className = 'status';

      try {
        const res = await fetch(`/api/agreements/${agreementId}/payments`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount, method, note })
        });

        const data = await res.json();

        if (!res.ok) {
          status.textContent = data.error || 'Failed to record payment';
          status.className = 'status error';
          return;
        }

        status.textContent = 'Payment recorded successfully! Redirecting...';
        status.className = 'status success';

        // Update agreement data
        agreement = data.agreement;

        setTimeout(() => {
          // If agreement is now settled, redirect to dashboard
          if (agreement.status === 'settled') {
            window.location.href = '/app';
          } else {
            // Reload the page to show updated payment info
            window.location.reload();
          }
        }, 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    // Approve payment
    async function approvePayment(paymentId) {
      try {
        const res = await fetch(`/api/payments/${paymentId}/approve`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();

        if (!res.ok) {
          alert(data.error || 'Failed to approve payment');
          return;
        }

        // Reload payment data and agreement
        await loadAgreementData();
      } catch (err) {
        console.error('Error approving payment:', err);
        alert('Error approving payment');
      }
    }

    // Decline payment
    async function declinePayment(paymentId) {
      if (!confirm('Are you sure you want to decline this payment?')) {
        return;
      }

      try {
        const res = await fetch(`/api/payments/${paymentId}/decline`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();

        if (!res.ok) {
          alert(data.error || 'Failed to decline payment');
          return;
        }

        // Reload payment data and agreement
        await loadAgreementData();
      } catch (err) {
        console.error('Error declining payment:', err);
        alert('Error declining payment');
      }
    }

    // Initialize
    if (!agreementId) {
      showError('Invalid agreement ID.');
    } else {
      loadAgreementData();
    }
  </script>
</body>
</html>
