<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PayFriends — Review Agreement</title>
  <style>
    :root{
      --bg:#0e1116; --card:#151a21; --text:#e6eef6; --muted:#a7b0bd; --accent:#3ddc97;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif; background:var(--bg); color:var(--text); padding:32px 16px;}
    .container{max-width:1280px; margin:0 auto;}
    .container-narrow{max-width:600px; margin:0 auto;}
    .card{background:var(--card); border:1px solid rgba(255,255,255,0.06); border-radius:16px; padding:24px; margin:16px 0}
    h1{margin:0 0 8px 0; font-size:24px}
    h2{margin:0 0 16px 0; font-size:20px}
    p{color:var(--muted); line-height:1.6; margin:8px 0}
    .detail-row{display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.08)}
    .detail-row:last-child{border-bottom:none}
    .detail-label{color:var(--muted); font-weight:500}
    .detail-value{color:var(--text); font-weight:600}
    .row{display:flex; gap:12px; align-items:center; margin:12px 0}
    .row label{width:120px; color:var(--muted); font-size:14px}
    .row input{flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text)}
    button{padding:12px 20px; border-radius:10px; border:0; background:var(--accent); color:#0d130f; font-weight:700; cursor:pointer; font-size:14px; width:100%}
    button:hover{filter:brightness(1.06)}
    button.secondary{background:transparent; border:1px solid rgba(255,255,255,0.15); color:var(--text); margin-top:8px}
    button.secondary:hover{background:rgba(255,255,255,0.05)}
    button.tertiary{background:transparent; border:1px solid rgba(255,255,255,0.10); color:var(--muted); margin-top:8px}
    button.tertiary:hover{background:rgba(255,255,255,0.03)}
    .status{color:var(--muted); margin-top:12px; min-height:1.2em; font-size:14px}
    .hidden{display:none}
    .error{color:#ff6b6b}
    .success{color:var(--accent)}
    .amount{font-size:32px; font-weight:700; color:var(--accent); text-align:center; margin:16px 0}
    .note{background:rgba(61,220,151,0.1); border:1px solid rgba(61,220,151,0.2); border-radius:8px; padding:12px; color:var(--text); font-size:14px; margin:16px 0}
    .status-badge{display:inline-block; padding:4px 10px; border-radius:6px; font-size:12px; font-weight:600}
    .status-badge.pending{background:#f59e0b; color:#0d130f}
    .status-badge.active{background:#22c55e; color:#fff}
    .status-badge.settled{background:#9ca3af; color:#fff}
    .status-badge.declined{background:#ef4444; color:#fff}
    .top-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid rgba(255,255,255,0.08)}
    .top-header-left{display:flex; align-items:center; gap:12px}
    .top-header-right{display:flex; flex-direction:column; align-items:flex-end; gap:8px}
    .logo-coin{height:54px; width:auto}
    .top-header-text{display:flex; flex-direction:column; gap:2px}
    .app-name{font-size:24px; font-weight:600; line-height:1.2; margin:0}
    .user-meta{color:var(--muted); font-size:14px; line-height:1.2}
    .app-slogan{color:var(--muted); font-size:14px; line-height:1.2; margin-top:2px}
    .top-header-user-info{color:var(--text); font-size:14px; text-align:right}
    .top-header-actions{display:flex; gap:12px; align-items:center}
    .logout-btn{padding:8px 16px;border-radius:8px;border:1px solid rgba(255,255,255,0.15);background:transparent;color:var(--text);font-weight:500; cursor:pointer; font-size:14px}
    .logout-btn:hover{background:rgba(255,255,255,0.05)}
  </style>
</head>
<body>
  <!-- Header (shown only when logged in for review) -->
  <div id="logged-in-header" class="hidden">
    <div class="container">
      <header class="top-header">
        <div class="top-header-left">
          <a href="/app" style="text-decoration:none; display:flex; align-items:center; gap:12px">
            <img src="/images/payfriends-logov2.png" class="logo-coin" alt="PayFriends logo" />
            <div class="top-header-text">
              <div class="app-name" style="color:var(--text)">PayFriends.app</div>
              <div class="app-slogan">Pay friends, stay friends</div>
            </div>
          </a>
        </div>
        <div class="top-header-right">
          <div class="top-header-user-info" id="user-info-display">Loading...</div>
          <div class="top-header-actions">
            <a href="/app" style="color:var(--text); text-decoration:none; padding:8px 16px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background:transparent; font-weight:500; font-size:14px; display:inline-block">Activity</a>
            <a href="/profile" style="color:var(--text); text-decoration:none; padding:8px 16px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background:transparent; font-weight:500; font-size:14px; display:inline-block; white-space:nowrap">My Profile</a>
            <button class="logout-btn" onclick="logout()">Logout</button>
          </div>
        </div>
      </header>
    </div>
  </div>

  <!-- Loading state -->
  <div class="container-narrow">
    <div class="card">
      <h1>Agreement Review</h1>
      <p id="loading-text">Loading agreement details...</p>
    </div>
  </div>

  <!-- Not logged in: show signup/login flow -->
  <div id="auth-section" class="container-narrow hidden">
    <div class="card">
      <h2>Sign up to review this agreement</h2>
      <p id="invite-email-notice"></p>

      <div id="signup-form">
        <div class="row">
          <label>Full legal name (as on passport)</label>
          <input id="full-name" type="text" placeholder="Your full name" required />
        </div>
        <div class="row">
          <label>Email</label>
          <input id="email" type="email" readonly style="opacity:0.7" />
        </div>
        <div class="row">
          <label>Password</label>
          <input id="password" type="password" placeholder="At least 6 characters" required />
        </div>
        <button onclick="handleSignup()">Sign up & Continue</button>
        <p class="status" id="auth-status"></p>
      </div>

      <div style="text-align:center; margin-top:16px">
        <p style="font-size:14px">Already have an account?</p>
        <a href="/" style="color:var(--accent); text-decoration:none">Log in here</a>
      </div>
    </div>
  </div>

  <!-- Logged in: show agreement review -->
  <div id="review-section" class="container hidden">
    <div class="card">
      <h2>Agreement Details</h2>

      <!-- Details section -->
      <div style="margin:16px 0">
        <div class="detail-row">
          <span class="detail-label">Lender</span>
          <span class="detail-value" id="lender-name"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Borrower</span>
          <span class="detail-value" id="borrower-name"></span>
        </div>
        <div class="detail-row" id="description-row" style="display:none">
          <span class="detail-label">Description</span>
          <span class="detail-value" id="description-display"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Amount</span>
          <span class="detail-value" id="amount-display"></span>
        </div>
        <div class="detail-row" id="money-sent-row" style="display:none">
          <span class="detail-label">Money transfer date</span>
          <span class="detail-value" id="money-sent-display"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Payment type</span>
          <span class="detail-value" id="repayment-type"></span>
        </div>
        <div class="detail-row" id="installment-info-row" style="display:none">
          <span class="detail-label">Installment plan</span>
          <span class="detail-value" id="installment-info-display"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Due date</span>
          <span class="detail-value">
            <span id="due-date"></span>
            <span id="due-date-countdown" style="color:var(--muted); margin-left:8px"></span>
          </span>
        </div>
        <div class="detail-row" id="interest-row" style="display:none">
          <span class="detail-label">Interest</span>
          <span class="detail-value" id="interest-display"></span>
        </div>
        <div class="detail-row" id="total-repay-row" style="display:none">
          <span class="detail-label">Total to repay</span>
          <span class="detail-value" id="total-repay-display"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Status</span>
          <span class="detail-value" id="status-display">Pending review</span>
        </div>
      </div>

      <!-- Interest, payment calculation & installment schedule (collapsible) -->
      <div id="interest-calc-card" class="hidden" style="margin:16px 0">
        <button onclick="toggleReviewSection('interest-calc-detail')" class="secondary" style="width:100%; text-align:left; padding:12px 16px; font-size:14px; display:flex; justify-content:space-between; align-items:center">
          <span>Interest, payment calculation & installment schedule</span>
          <span id="interest-calc-detail-toggle">▼</span>
        </button>
        <div id="interest-calc-detail" class="hidden" style="background:#10151d; border:1px solid rgba(255,255,255,0.08); border-radius:0 0 8px 8px; padding:16px; margin-top:-1px">
          <div id="interest-calc-detail-content"></div>
        </div>
      </div>

      <!-- Payments & reminders (collapsible) -->
      <div id="payments-reminders-card" style="margin:16px 0">
        <button onclick="toggleReviewSection('payments-reminders-detail')" class="secondary" style="width:100%; text-align:left; padding:12px 16px; font-size:14px; display:flex; justify-content:space-between; align-items:center">
          <span>Payments & reminders</span>
          <span id="payments-reminders-detail-toggle">▼</span>
        </button>
        <div id="payments-reminders-detail" class="hidden" style="background:#10151d; border:1px solid rgba(255,255,255,0.08); border-radius:0 0 8px 8px; padding:16px; margin-top:-1px">
          <div id="payments-reminders-details"></div>
        </div>
      </div>

      <div class="note">
        By accepting this agreement, you confirm the terms and agree to repay the amount by the due date.
      </div>

      <button onclick="handleAccept()">Accept Agreement</button>
      <button class="secondary" onclick="handleDecline()">Decline</button>
      <button class="tertiary" onclick="handleReviewLater()">Review Later</button>
      <p class="status" id="review-status"></p>
    </div>
  </div>

  <!-- Already accepted/declined -->
  <div id="already-processed" class="container-narrow hidden">
    <div class="card">
      <h2>Agreement Already Processed</h2>
      <p>This agreement has already been accepted or declined.</p>
      <a href="/app" style="display:inline-block; margin-top:16px; padding:10px 20px; background:var(--accent); color:#0d130f; border-radius:10px; text-decoration:none; font-weight:600">Go to Dashboard</a>
    </div>
  </div>

  <!-- Agreement cancelled -->
  <div id="agreement-cancelled" class="container-narrow hidden">
    <div class="card">
      <h2>Agreement No Longer Available</h2>
      <p>This agreement is no longer available. The lender cancelled the request.</p>
      <a href="/app" style="display:inline-block; margin-top:16px; padding:10px 20px; background:var(--accent); color:#0d130f; border-radius:10px; text-decoration:none; font-weight:600">Go to Dashboard</a>
    </div>
  </div>

  <script>
    let inviteData = null;
    let currentUser = null;
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    // Format amount in cents to euros with thousand separators, no decimals
    function formatAmount(cents) {
      const euros = Math.round(cents / 100);
      return new Intl.NumberFormat('de-DE').format(euros);
    }

    async function loadInviteData() {
      try {
        const res = await fetch(`/api/invites/${token}`);
        if (!res.ok) {
          window.location.href = '/review-invalid.html';
          return;
        }
        inviteData = await res.json();

        // Check if cancelled
        if (inviteData.agreement.status === 'cancelled') {
          document.getElementById('loading-text').parentElement.classList.add('hidden');
          document.getElementById('agreement-cancelled').classList.remove('hidden');
          return;
        }

        // Check if already processed
        if (inviteData.invite.accepted_at || inviteData.agreement.status !== 'pending') {
          document.getElementById('loading-text').parentElement.classList.add('hidden');
          document.getElementById('already-processed').classList.remove('hidden');
          return;
        }

        // Check if user is logged in
        try {
          const userRes = await fetch('/api/user');
          if (userRes.ok) {
            const userData = await userRes.json();
            currentUser = userData.user;

            // Verify email matches
            if (currentUser.email === inviteData.invite.email) {
              showReviewSection();
            } else {
              // Logged in but wrong email
              document.getElementById('loading-text').textContent = 'This invite was sent to a different email address. Please log out and use the correct account.';
            }
          } else {
            // Not logged in, show signup
            showAuthSection();
          }
        } catch (err) {
          // Not logged in, show signup
          showAuthSection();
        }
      } catch (err) {
        console.error('Error loading invite:', err);
        window.location.href = '/review-invalid.html';
      }
    }

    function showAuthSection() {
      document.getElementById('loading-text').parentElement.classList.add('hidden');
      document.getElementById('auth-section').classList.remove('hidden');

      document.getElementById('invite-email-notice').textContent = `This agreement was sent to ${inviteData.invite.email}`;
      document.getElementById('email').value = inviteData.invite.email;

      // Pre-fill full name if friend_first_name is available
      if (inviteData.agreement.friend_first_name) {
        document.getElementById('full-name').value = inviteData.agreement.friend_first_name;
      }
    }

    function getDueDateCountdown(dueDate) {
      const due = new Date(dueDate);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      due.setHours(0, 0, 0, 0);
      const diffTime = due - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

      if (diffDays < 0) return `(${Math.abs(diffDays)} days overdue)`;
      if (diffDays === 0) return '(due today)';
      if (diffDays === 1) return '(in 1 day)';
      return `(in ${diffDays} days)`;
    }

    function toggleReviewSection(sectionId) {
      const section = document.getElementById(sectionId);
      const toggle = document.getElementById(sectionId + '-toggle');

      if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        toggle.textContent = '▲';
      } else {
        section.classList.add('hidden');
        toggle.textContent = '▼';
      }
    }

    function showReviewSection() {
      document.getElementById('loading-text').parentElement.classList.add('hidden');
      document.getElementById('review-section').classList.remove('hidden');

      // Show header and populate user info
      document.getElementById('logged-in-header').classList.remove('hidden');
      if (currentUser) {
        const userName = currentUser.full_name || currentUser.email;
        document.getElementById('user-info-display').textContent = `${userName} | ${currentUser.email}`;
      }

      const agreement = inviteData.agreement;
      const amount = formatAmount(agreement.amount_cents);

      // Use lender's full_name if available, fallback to lender_name
      const lenderName = (inviteData.lender && inviteData.lender.full_name) || agreement.lender_name;
      document.getElementById('lender-name').textContent = lenderName;

      const borrowerName = currentUser.full_name || agreement.friend_first_name || inviteData.invite.email;
      document.getElementById('borrower-name').textContent = borrowerName;

      // Description (show if available)
      if (agreement.description) {
        document.getElementById('description-display').textContent = agreement.description;
        document.getElementById('description-row').style.display = 'flex';
      }

      // Amount
      document.getElementById('amount-display').textContent = `€ ${amount}`;

      // Money transfer date (show if available)
      if (agreement.money_sent_date) {
        let moneySentDateText;
        if (agreement.money_sent_date === 'on-acceptance') {
          moneySentDateText = 'Upon agreement acceptance';
        } else {
          moneySentDateText = new Date(agreement.money_sent_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        }
        document.getElementById('money-sent-display').textContent = moneySentDateText;
        document.getElementById('money-sent-row').style.display = 'flex';
      }

      // Repayment type
      const repaymentType = agreement.repayment_type === 'one_time' ? 'One-time payment' : 'Installments';
      document.getElementById('repayment-type').textContent = repaymentType;

      // Installment info (show only if installments)
      if (agreement.repayment_type === 'installments' && agreement.installment_count) {
        const installmentAmount = formatAmount(Math.round((agreement.installment_amount || 0) * 100));
        const firstDate = new Date(agreement.first_payment_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        const finalDate = new Date(agreement.final_due_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        document.getElementById('installment-info-display').innerHTML =
          `<div style="text-align:right">${agreement.installment_count} monthly payments of €${installmentAmount}</div><div style="text-align:right">from ${firstDate} to ${finalDate}</div>`;
        document.getElementById('installment-info-row').style.display = 'flex';
      }

      // Due date
      const dueDate = agreement.repayment_type === 'installments' && agreement.final_due_date
        ? new Date(agreement.final_due_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })
        : new Date(agreement.due_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
      document.getElementById('due-date').textContent = dueDate;

      // Add due date countdown
      const dueDateForCountdown = agreement.repayment_type === 'installments' && agreement.final_due_date
        ? agreement.final_due_date
        : agreement.due_date;
      document.getElementById('due-date-countdown').textContent = getDueDateCountdown(dueDateForCountdown);

      // Interest info (show only if interest > 0)
      if (agreement.interest_rate && agreement.interest_rate > 0) {
        const totalInterest = formatAmount(Math.round((agreement.total_interest || 0) * 100));
        document.getElementById('interest-display').textContent = `${agreement.interest_rate}% per year (total interest: €${totalInterest})`;
        document.getElementById('interest-row').style.display = 'flex';

        // Total to repay
        const totalRepay = formatAmount(Math.round((agreement.total_repay_amount || agreement.amount_cents / 100) * 100));
        document.getElementById('total-repay-display').textContent = `€${totalRepay}`;
        document.getElementById('total-repay-row').style.display = 'flex';

        // Show interest calculation card
        populateInterestCalcDetail();
      }

      // Status
      const borrowerFirstName = borrowerName.split(' ')[0];
      document.getElementById('status-display').textContent = `Pending review by ${borrowerFirstName}`;

      // Populate payments & reminders section
      populatePaymentsReminders();
    }

    function populateInterestCalcDetail() {
      const agreement = inviteData.agreement;
      const card = document.getElementById('interest-calc-card');
      const content = document.getElementById('interest-calc-detail-content');

      if (!agreement.interest_rate || agreement.interest_rate === 0) {
        return;
      }

      card.classList.remove('hidden');

      const totalInterest = formatAmount(Math.round((agreement.total_interest || 0) * 100));
      const totalRepay = formatAmount(Math.round((agreement.total_repay_amount || agreement.amount_cents / 100) * 100));
      const termText = agreement.repayment_type === 'installments' && agreement.installment_count
        ? `${agreement.installment_count} months`
        : 'one payment';

      let html = '<div style="display:flex; flex-direction:column; gap:12px">';
      html += `<div style="display:flex; justify-content:space-between; padding:8px 0">
        <span style="color:var(--muted)">Loan amount</span>
        <span style="font-weight:600">€${formatAmount(agreement.amount_cents)}</span>
      </div>`;
      html += `<div style="display:flex; justify-content:space-between; padding:8px 0">
        <span style="color:var(--muted)">Term</span>
        <span style="font-weight:600">${termText}</span>
      </div>`;
      html += `<div style="display:flex; justify-content:space-between; padding:8px 0">
        <span style="color:var(--muted)">Interest rate</span>
        <span style="font-weight:600">${agreement.interest_rate}% per year</span>
      </div>`;
      html += `<div style="display:flex; justify-content:space-between; padding:8px 0; border-top:1px solid rgba(255,255,255,0.08); margin-top:8px; padding-top:12px">
        <span style="color:var(--muted)">Total interest</span>
        <span style="font-weight:600">€${totalInterest}</span>
      </div>`;
      html += `<div style="display:flex; justify-content:space-between; padding:8px 0">
        <span style="color:var(--muted); font-weight:600">Total to repay</span>
        <span style="font-weight:700; color:var(--accent)">€${totalRepay}</span>
      </div>`;
      html += '</div>';

      content.innerHTML = html;
    }

    function populatePaymentsReminders() {
      const agreement = inviteData.agreement;
      const detailsDiv = document.getElementById('payments-reminders-details');

      let html = '<div style="display:flex; flex-direction:column; gap:12px">';

      // Payment methods
      let methodsText = 'Not specified';
      if (agreement.payment_preference_method) {
        const methods = agreement.payment_preference_method.split(',').map(m => {
          if (m === 'bank') return 'Bank transfer';
          if (m === 'cash') return 'Cash in person';
          if (m === 'crypto') return 'Crypto';
          if (m === 'paypal') return 'PayPal';
          if (m === 'any') return 'Any method';
          if (m === 'other') return 'Other';
          return m;
        });
        methodsText = methods.join(', ');
      }
      html += `<div><div style="font-weight:600; margin-bottom:4px; font-size:14px">Preferred payment methods:</div>`;
      html += `<div style="color:var(--muted); font-size:13px">${methodsText}</div></div>`;

      // Proof of repayment
      html += `<div><div style="font-weight:600; margin-bottom:4px; font-size:14px">Require proof of repayment:</div>`;
      html += `<div style="color:var(--muted); font-size:13px">${agreement.proof_required ? 'Yes — The borrower will be asked to upload proof for each repayment.' : 'No — The borrower can report repayments without uploading proof.'}</div></div>`;

      // Reminder mode
      html += `<div><div style="font-weight:600; margin-bottom:4px; font-size:14px">Reminder mode:</div>`;
      html += `<div style="color:var(--muted); font-size:13px">${agreement.reminder_mode === 'auto' ? 'Auto (recommended)' : 'Custom schedule'}</div></div>`;

      // Worst case scenario (only show if enabled)
      if (agreement.debt_collection_clause) {
        html += `<div><div style="font-weight:600; margin-bottom:4px; font-size:14px">Worst case scenario:</div>`;
        html += `<div style="color:var(--muted); font-size:13px; line-height:1.6">If the borrower does not repay in time and ignores reminders or cannot agree a new plan with the lender, PayFriends will hand the case to an independent debt collector. Once this happens, the lender is no longer involved in collection — the third party handles it, and any collection fees are for the borrower's account.</div>`;
        html += `</div>`;
      }

      html += '</div>';
      detailsDiv.innerHTML = html;
    }

    async function handleSignup() {
      const fullName = document.getElementById('full-name').value.trim();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const status = document.getElementById('auth-status');

      if (!fullName) {
        status.textContent = 'Full name is required';
        status.className = 'status error';
        return;
      }

      // Validate full name has at least 2 words
      const nameParts = fullName.split(/\s+/);
      if (nameParts.length < 2) {
        status.textContent = 'Please enter your full name (first and last name), exactly as on your passport.';
        status.className = 'status error';
        return;
      }

      if (password.length < 6) {
        status.textContent = 'Password must be at least 6 characters';
        status.className = 'status error';
        return;
      }

      status.textContent = 'Creating account...';
      status.className = 'status';

      try {
        const res = await fetch('/auth/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password, fullName })
        });

        const data = await res.json();

        if (!res.ok) {
          status.textContent = data.error || 'Signup failed';
          status.className = 'status error';
          return;
        }

        currentUser = data.user;
        status.textContent = 'Account created! Loading agreement...';
        status.className = 'status success';

        // Reload to show review section
        setTimeout(() => {
          window.location.reload();
        }, 500);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    async function handleAccept() {
      const status = document.getElementById('review-status');
      status.textContent = 'Accepting...';
      status.className = 'status';

      try {
        const res = await fetch(`/api/invites/${token}/accept`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();

        if (!res.ok) {
          status.textContent = data.error || 'Failed to accept';
          status.className = 'status error';
          return;
        }

        status.textContent = 'Agreement accepted! Redirecting...';
        status.className = 'status success';

        setTimeout(() => {
          window.location.href = '/app';
        }, 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    async function handleDecline() {
      if (!confirm('Are you sure you want to decline this agreement?')) {
        return;
      }

      const status = document.getElementById('review-status');
      status.textContent = 'Declining...';
      status.className = 'status';

      try {
        const res = await fetch(`/api/invites/${token}/decline`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();

        if (!res.ok) {
          status.textContent = data.error || 'Failed to decline';
          status.className = 'status error';
          return;
        }

        status.textContent = 'Agreement declined. Redirecting...';
        status.className = 'status success';

        setTimeout(() => {
          window.location.href = '/app';
        }, 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    async function handleReviewLater() {
      const status = document.getElementById('review-status');
      status.textContent = 'Saving...';
      status.className = 'status';

      try {
        const res = await fetch(`/api/invites/${token}/review-later`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();

        if (!res.ok) {
          status.textContent = data.error || 'Failed to save';
          status.className = 'status error';
          return;
        }

        status.textContent = 'Saved! Redirecting to dashboard...';
        status.className = 'status success';

        setTimeout(() => {
          window.location.href = '/app';
        }, 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    // Logout
    async function logout() {
      try {
        await fetch('/auth/logout', { method: 'POST' });
        window.location.href = '/';
      } catch (err) {
        console.error('Logout error:', err);
        window.location.href = '/';
      }
    }

    // Initialize
    if (!token) {
      window.location.href = '/review-invalid.html';
    } else {
      loadInviteData();
    }
  </script>
</body>
</html>
