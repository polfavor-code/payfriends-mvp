<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PayFriends — Review Agreement</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <!-- Shared control styles -->
  <link rel="stylesheet" href="/css/shared-controls.css" />
  <!-- App-wide styles -->
  <link rel="stylesheet" href="/css/app.css" />
  <!-- Shared header component -->
  <script src="/js/header.js"></script>
  <!-- Centralized currency formatters -->
  <script src="/js/formatters.js"></script>
  <!-- Derived field utilities -->
  <script src="/js/derived-fields.js"></script>
  <!-- Fairness icon component -->
  <script src="/components/fairness-icon.js"></script>
  <style>
    :root{
      --bg:#0e1116; --card:#151a21; --text:#e6eef6; --muted:#a7b0bd; --accent:#3ddc97;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif; background:var(--bg); color:var(--text); padding:32px 16px;}
    .container{max-width:1200px; margin:0 auto;}
    .container-narrow{max-width:600px; margin:0 auto;}
    .card{background:var(--card); border:1px solid rgba(255,255,255,0.06); border-radius:16px; padding:24px; margin:16px 0}
    h1{margin:0 0 8px 0; font-size:24px}
    h2{margin:0 0 16px 0; font-size:20px}
    p{color:var(--muted); line-height:1.6; margin:8px 0}
    .detail-row{display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.08)}
    .detail-row:last-child{border-bottom:none}
    .detail-label{color:var(--muted); font-weight:500}
    .detail-value{color:var(--text); font-weight:600}
    .row{display:flex; gap:12px; align-items:center; margin:12px 0}
    .row label{width:120px; color:var(--muted); font-size:14px}
    .row input{flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background:#10151d; color:var(--text)}
    .row input:focus{outline:none; border-color:var(--accent); background:#10151d}
    .row input:hover{background:#10151d}
    .row input:-webkit-autofill,
    .row input:-webkit-autofill:hover,
    .row input:-webkit-autofill:focus,
    .row input:-webkit-autofill:active{
      -webkit-background-clip:text;
      -webkit-text-fill-color:var(--text);
      transition:background-color 5000s ease-in-out 0s;
      box-shadow:inset 0 0 20px 20px #10151d;
    }
    button{padding:12px 20px; border-radius:10px; border:0; background:var(--accent); color:#0d130f; font-weight:700; cursor:pointer; font-size:14px; width:100%}
    button:hover{filter:brightness(1.06)}
    button.secondary{background:transparent; border:1px solid rgba(255,255,255,0.15); color:var(--text); margin-top:8px}
    button.secondary:hover{background:rgba(255,255,255,0.05)}
    button.tertiary{background:transparent; border:1px solid rgba(255,255,255,0.10); color:var(--muted); margin-top:8px}
    button.tertiary:hover{background:rgba(255,255,255,0.03)}
    .status{color:var(--muted); margin-top:12px; min-height:1.2em; font-size:14px}
    .hidden{display:none}
    .error{color:#ff6b6b}
    .success{color:var(--accent)}
    .amount{font-size:32px; font-weight:700; color:var(--accent); text-align:center; margin:16px 0}
    .note{background:rgba(61,220,151,0.1); border:1px solid rgba(61,220,151,0.2); border-radius:8px; padding:12px; color:var(--text); font-size:14px; margin:16px 0}
    .status-badge{display:inline-block; padding:4px 10px; border-radius:6px; font-size:12px; font-weight:600}
    .status-badge.pending{background:#f59e0b; color:#0d130f}
    .status-badge.active{background:#22c55e; color:#fff}
    .status-badge.settled{background:#9ca3af; color:#fff}
    .status-badge.declined{background:#ef4444; color:#fff}
    .top-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid rgba(255,255,255,0.08)}
    .top-header-left{display:flex; align-items:center; gap:12px}
    .top-header-right{display:flex; gap:12px; align-items:center}
    .logo-coin{height:54px; width:auto}
    .top-header-text{display:flex; flex-direction:column; gap:2px}
    .app-name{font-size:24px; font-weight:600; line-height:1.2; margin:0}
    .user-meta{color:var(--muted); font-size:14px; line-height:1.2}
    .app-slogan{color:var(--muted); font-size:14px; line-height:1.2; margin-top:2px}
    .top-header-user-info{color:var(--text); font-size:14px; line-height:1; white-space:nowrap; display:inline-flex; align-items:center; height:40px}
    .top-header-actions{display:flex; gap:12px; align-items:center}
    .inbox-count{color:var(--accent);font-weight:700}
    @media (max-width: 768px) {
      .summary-grid-row{grid-template-columns:1fr !important}
    }
    .payment-schedule-table{width:100%; border-collapse:collapse; font-size:13px}
    .payment-schedule-table thead{background:rgba(255,255,255,0.03)}
    .payment-schedule-table th{padding:10px 8px; text-align:left; font-weight:600; color:var(--muted); border-bottom:1px solid rgba(255,255,255,0.08)}
    .payment-schedule-table td{padding:10px 8px; border-bottom:1px solid rgba(255,255,255,0.04)}
    .payment-schedule-table tbody tr:nth-child(odd){background:rgba(255,255,255,0.02)}
    .payment-schedule-table th.text-right,.payment-schedule-table td.text-right{text-align:right}
    @media (max-width: 768px) {
      .pf-review-modal{max-width:100% !important; width:100% !important; margin:0 !important; border-radius:0 !important; padding:16px !important}
    }
  </style>
</head>
<body>
  <!-- Header (shown only when logged in for review) -->
  <div id="logged-in-header" class="hidden">
    <div class="container" id="review-header-container">
      <!-- Header will be loaded dynamically by header.js when user is logged in -->
    </div>
  </div>

  <!-- Loading state -->
  <div class="container-narrow">
    <div class="card">
      <p id="loading-text" style="color:var(--muted); font-size:14px">Loading...</p>
    </div>
  </div>

  <!-- Not logged in: show signup/login flow -->
  <div id="auth-section" class="container-narrow hidden">
    <div class="card">
      <h2>Sign up to review this agreement</h2>
      <p id="invite-email-notice"></p>

      <div id="signup-form">
        <div class="row">
          <label>Full legal name (as on passport)</label>
          <input id="full-name" type="text" placeholder="Your full name" required />
        </div>
        <div class="row">
          <label>Email</label>
          <input id="email" type="email" readonly style="opacity:0.7" />
        </div>
        <div class="row">
          <label>Password</label>
          <input id="password" type="password" placeholder="At least 6 characters" required />
        </div>
        <button onclick="handleSignup()">Sign up & Continue</button>
        <p class="status" id="auth-status"></p>
      </div>

      <div style="text-align:center; margin-top:16px">
        <p style="font-size:14px">Already have an account?</p>
        <a href="/" style="color:var(--accent); text-decoration:none">Log in here</a>
      </div>
    </div>
  </div>

  <!-- Logged in: show agreement review -->
  <div id="review-section" class="container hidden">
    <!-- Page header with title and return button -->
    <div style="display:flex; align-items:center; justify-content:space-between; padding:0 0 16px 0; margin-bottom:8px">
      <div style="flex:1">
        <h1 style="margin:0; font-size:24px; font-weight:600; color:var(--text)">Review agreement</h1>
      </div>
      <div style="display:flex; align-items:center; gap:16px">
        <a href="/app" style="display:inline-flex; align-items:center; gap:8px; padding:0 16px; height:40px; border-radius:10px; background:var(--accent); color:#0d130f; font-weight:700; text-decoration:none; transition:filter 0.2s ease; border:none">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink:0">
            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
          </svg>
          <span>Return to My agreements</span>
        </a>
      </div>
    </div>

    <div class="card">
      <!-- Review summary section -->
      <section aria-labelledby="review-summary" style="margin:0 0 16px 0">
        <h3 id="review-summary" style="font-size:16px; font-weight:600; margin:0 0 12px 0; color:var(--text)">Review summary</h3>
        <div style="display:grid; grid-template-columns:1fr; gap:12px">
          <div class="summary-grid-row" style="display:grid; grid-template-columns:1fr 2fr; gap:12px; padding:8px 0">
            <span style="color:var(--muted)">Description</span>
            <span style="color:var(--text)" id="description-display">—</span>
          </div>
          <div class="summary-grid-row" style="display:grid; grid-template-columns:1fr 2fr; gap:12px; padding:8px 0">
            <span style="color:var(--muted)">Lender</span>
            <span style="color:var(--text)" id="lender-display">—</span>
          </div>
          <div class="summary-grid-row" style="display:grid; grid-template-columns:1fr 2fr; gap:12px; padding:8px 0">
            <span style="color:var(--muted)">Amount</span>
            <span style="color:var(--text)" id="amount-display">—</span>
          </div>
          <div class="summary-grid-row" style="display:grid; grid-template-columns:1fr 2fr; gap:12px; padding:8px 0">
            <span style="color:var(--muted)">Money transfer date (Loan start)</span>
            <span style="color:var(--text)" id="money-sent-display">—</span>
          </div>
          <div class="summary-grid-row" style="display:grid; grid-template-columns:1fr 2fr; gap:12px; padding:8px 0">
            <span style="color:var(--muted)">Loan duration</span>
            <span style="color:var(--text)" id="loan-duration-display">—</span>
          </div>
          <div class="summary-grid-row" style="display:grid; grid-template-columns:1fr 2fr; gap:12px; padding:8px 0">
            <span style="color:var(--muted)">Installment plan</span>
            <span style="color:var(--text)" id="installment-plan-display">—</span>
          </div>
          <div class="summary-grid-row" style="display:grid; grid-template-columns:1fr 2fr; gap:12px; padding:8px 0">
            <span style="color:var(--muted)">Interest</span>
            <span style="color:var(--text)" id="interest-display">—</span>
          </div>
          <div class="summary-grid-row" style="display:grid; grid-template-columns:1fr 2fr; gap:12px; padding:8px 0">
            <span style="color:var(--muted)">Total to repay</span>
            <span style="color:var(--text); font-weight:600" id="total-repay-display">—</span>
          </div>
        </div>
      </section>

      <!-- Interest, payment calculation & installment schedule (collapsible) -->
      <div id="interest-calc-card" class="hidden" style="margin:16px 0">
        <button onclick="toggleReviewSection('interest-calc-detail')" class="secondary" style="width:100%; text-align:left; padding:12px 16px; font-size:14px; display:flex; justify-content:space-between; align-items:center">
          <span>Interest, payment calculation & installment schedule</span>
          <span id="interest-calc-detail-toggle">▼</span>
        </button>
        <div id="interest-calc-detail" class="hidden" style="background:#10151d; border:1px solid rgba(255,255,255,0.08); border-radius:0 0 8px 8px; padding:16px; margin-top:-1px">
          <div id="interest-calc-detail-content"></div>
        </div>
      </div>

      <!-- Payments & reminders (collapsible) -->
      <div id="payments-reminders-card" style="margin:16px 0">
        <button onclick="toggleReviewSection('payments-reminders-detail')" class="secondary" style="width:100%; text-align:left; padding:12px 16px; font-size:14px; display:flex; justify-content:space-between; align-items:center">
          <span>Payments & reminders</span>
          <span id="payments-reminders-detail-toggle">▼</span>
        </button>
        <div id="payments-reminders-detail" class="hidden" style="background:#10151d; border:1px solid rgba(255,255,255,0.08); border-radius:0 0 8px 8px; padding:16px; margin-top:-1px">
          <div id="payments-reminders-details"></div>
        </div>
      </div>

      <!-- Fairness Between Friends (collapsible) -->
      <div id="fairness-card" style="margin:16px 0">
        <button onclick="toggleReviewSection('fairness-detail')" class="secondary" style="width:100%; text-align:left; padding:12px 16px; font-size:14px; display:flex; justify-content:space-between; align-items:center">
          <div style="display:flex; align-items:center; gap:8px; color:var(--accent)">
            <span style="display:inline-flex; align-items:center; width:18px; height:18px; flex-shrink:0;" title="Fairness Between Friends"></span>
            <span>Fairness Between Friends (How it Works)</span>
          </div>
          <span id="fairness-detail-toggle">▼</span>
        </button>
        <script>
          document.currentScript.previousElementSibling.querySelector('div > span:first-child').innerHTML = fairnessIconSVG('', {width:'18px', height:'18px', display:'block'});
        </script>
        <div id="fairness-detail" class="hidden" style="background:#10151d; border:1px solid rgba(255,255,255,0.08); border-radius:0 0 8px 8px; padding:16px; margin-top:-1px">
          <p style="margin:0 0 12px 0; font-size:14px; line-height:1.6">
            PayFriends operates on a fairness principle designed to keep lending between friends transparent and balanced.
            Interest is calculated dynamically on the outstanding balance and the time elapsed.
          </p>
          <ul style="margin:0 0 12px 0; padding-left:20px; font-size:14px; line-height:1.6">
            <li style="margin-bottom:8px"><strong>Early or higher payments</strong> reduce the total interest and, where applicable, lower future installment amounts.</li>
            <li style="margin-bottom:8px"><strong>Late or smaller payments</strong> increase the total interest for the period the amount remains outstanding.</li>
            <li style="margin-bottom:8px">These recalculations happen automatically and are reflected instantly in the agreement for both lender and borrower.</li>
          </ul>
          <p style="margin:0; font-size:14px; line-height:1.6">
            Each repayment entry in the payment history clearly notes when a payment caused a change in the total interest, outstanding balance, or future installments.
            This ensures both parties always see the current, fair value of the loan.
          </p>
        </div>
      </div>

      <button onclick="handleAccept()">Accept Agreement</button>
      <button class="secondary" onclick="handleDecline()">Decline</button>
      <button class="tertiary" onclick="handleReviewLater()">Review Later</button>
      <p class="status" id="review-status"></p>
    </div>
  </div>

  <!-- Accept Agreement Modal -->
  <div id="accept-modal" onclick="closeAcceptModal()" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.85); align-items:center; justify-content:center;" role="dialog" aria-modal="true" aria-labelledby="accept-modal-title">
    <div onclick="event.stopPropagation()" class="pf-review-modal" style="max-width:780px; width:100%; max-height:90vh; overflow-y:auto; position:relative; background:#1a1f26; padding:24px; border-radius:12px; cursor:default; border:1px solid rgba(255,255,255,0.1);">
      <!-- Close button -->
      <span onclick="closeAcceptModal()" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();closeAcceptModal();}" tabindex="0" role="button" style="position:absolute; top:10px; right:15px; color:#fff; font-size:28px; font-weight:bold; cursor:pointer; line-height:1;" aria-label="Close">&times;</span>

      <!-- Title -->
      <h3 id="accept-modal-title" style="color:#fff; margin:0 0 8px 0; padding-right:35px; font-size:20px; font-weight:600;">Accept this agreement?</h3>

      <!-- Lead -->
      <p style="color:var(--muted); margin:0 0 20px 0; font-size:14px; line-height:1.5;">Review the key terms below and confirm to proceed.</p>

      <!-- Key terms section -->
      <div style="background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.08); border-radius:8px; padding:16px; margin-bottom:20px; margin-top:20px;">
        <div style="font-weight:600; margin-bottom:16px; font-size:14px; color:var(--text);">Key terms</div>
        <div id="accept-modal-terms" style="display:flex; flex-direction:column; gap:10px; font-size:13px;"></div>
      </div>

      <!-- Profile name helper -->
      <p style="color:var(--muted); font-size:12px; margin-bottom:16px; line-height:1.5;">
        Make sure your name in My Profile is correct. It will appear on the signed agreement.
      </p>

      <!-- Confirmations section -->
      <div style="margin-bottom:20px; margin-top:20px;">
        <div style="font-weight:600; margin-bottom:12px; font-size:14px; color:var(--text);">Confirmations</div>
        <div style="display:flex; flex-direction:column; gap:12px;">
          <!-- Single required checkbox -->
          <label style="display:flex; align-items:start; gap:10px; cursor:pointer; padding:10px; border:1px solid rgba(255,255,255,0.1); border-radius:8px; transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.03)'" onmouseout="this.style.background='transparent'">
            <input type="checkbox" id="accept-confirm-terms" style="margin-top:2px; cursor:pointer;" onchange="validateAcceptModal()">
            <span style="color:var(--text); font-size:13px; line-height:1.5;">I confirm the above terms are correct and I agree to repay as stated.</span>
          </label>
          <p id="accept-checkbox-error" class="hidden" style="color:#ff6b6b; font-size:12px; margin:0;">Please tick this box to confirm you accept the terms.</p>
        </div>
      </div>

      <!-- Signature section -->
      <div style="margin-bottom:20px; margin-top:20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <label for="accept-signature-canvas" style="font-weight:600; font-size:14px; color:var(--text);">Sign to accept</label>
          <button type="button" id="clear-signature-btn" onclick="clearSignature()" style="background:none; border:none; color:#8691a1; font-size:12px; cursor:pointer; padding:4px 8px; text-decoration:underline;">Clear</button>
        </div>
        <div style="position:relative; width:100%; border:1px solid rgba(255,255,255,0.15); border-radius:8px; background:rgba(255,255,255,0.02);">
          <canvas id="accept-signature-canvas" style="width:100%; height:140px; display:block; cursor:crosshair; border-radius:8px; touch-action:none;"></canvas>
        </div>
        <p style="color:var(--muted); font-size:12px; margin-top:8px; line-height:1.5;">
          By signing here I confirm that I am the borrower named above and I accept this repayment agreement as legally binding.
        </p>
        <p id="accept-signature-error" class="hidden" style="color:#ff6b6b; font-size:12px; margin:6px 0 0 0;">Please add your signature to continue.</p>
      </div>

      <!-- Action buttons -->
      <div style="display:flex; gap:12px; flex-direction:row-reverse;">
        <button id="accept-modal-confirm-btn" onclick="confirmAccept()" style="width:auto; flex:1; margin-top:0; background:#22c55e; color:#0d130f; font-weight:700; border:none; padding:12px 20px; border-radius:10px; cursor:pointer; opacity:0.5;" disabled>Accept & Sign</button>
        <button class="secondary" onclick="closeAcceptModal()" style="width:auto; flex:1; margin-top:0;">Cancel</button>
      </div>

      <p class="status" id="accept-modal-status" style="text-align:center; margin-top:12px;"></p>
    </div>
  </div>

  <!-- Already accepted/declined -->
  <div id="already-processed" class="container-narrow hidden">
    <div class="card">
      <h2>Agreement Already Processed</h2>
      <p>This agreement has already been accepted or declined.</p>
      <a href="/app" style="display:inline-block; margin-top:16px; padding:10px 20px; background:var(--accent); color:#0d130f; border-radius:10px; text-decoration:none; font-weight:600">Go to Dashboard</a>
    </div>
  </div>

  <!-- Agreement cancelled -->
  <div id="agreement-cancelled" class="container-narrow hidden">
    <div class="card">
      <h2>Agreement No Longer Available</h2>
      <p>This agreement is no longer available. The lender cancelled the request.</p>
      <a href="/app" style="display:inline-block; margin-top:16px; padding:10px 20px; background:var(--accent); color:#0d130f; border-radius:10px; text-decoration:none; font-weight:600">Go to Dashboard</a>
    </div>
  </div>

  <script>
    let inviteData = null;
    let currentUser = null;
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    // Currency formatters are loaded from /js/formatters.js
    // - formatCurrency0(cents) - for compact displays (no decimals, nl-NL locale)
    // - formatCurrency2(cents) - for details and schedules (2 decimals, nl-NL locale)
    // - formatEuro0(euros), formatEuro2(euros) - for euro amounts (not cents)

    // Format ISO date to human-readable format (dd MMM yyyy)
    function formatISOToHuman(isoDate) {
      if (!isoDate) return '—';
      const date = new Date(isoDate);
      const day = date.getDate();
      const month = date.toLocaleDateString('en-GB', { month: 'short' });
      const year = date.getFullYear();
      return `${day} ${month} ${year}`;
    }

    // Helper to calculate days between two dates
    function daysBetween(date1, date2) {
      const d1 = new Date(date1);
      const d2 = new Date(date2);
      return Math.round((d2 - d1) / (1000 * 60 * 60 * 24));
    }

    async function loadInviteData() {
      try {
        const res = await fetch(`/api/invites/${token}`);
        if (!res.ok) {
          window.location.href = '/review-invalid.html';
          return;
        }
        inviteData = await res.json();

        // Check if cancelled
        if (inviteData.agreement.status === 'cancelled') {
          document.getElementById('loading-text').parentElement.classList.add('hidden');
          document.getElementById('agreement-cancelled').classList.remove('hidden');
          return;
        }

        // Check if already processed
        if (inviteData.invite.accepted_at || inviteData.agreement.status !== 'pending') {
          document.getElementById('loading-text').parentElement.classList.add('hidden');
          document.getElementById('already-processed').classList.remove('hidden');
          return;
        }

        // Check if user is logged in
        try {
          const userRes = await fetch('/api/user');
          if (userRes.ok) {
            const userData = await userRes.json();
            currentUser = userData.user;

            // Verify email matches
            if (currentUser.email === inviteData.invite.email) {
              showReviewSection();
            } else {
              // Logged in but wrong email
              document.getElementById('loading-text').textContent = 'This invite was sent to a different email address. Please log out and use the correct account.';
            }
          } else {
            // Not logged in, show signup
            showAuthSection();
          }
        } catch (err) {
          // Not logged in, show signup
          showAuthSection();
        }
      } catch (err) {
        console.error('Error loading invite:', err);
        window.location.href = '/review-invalid.html';
      }
    }

    function showAuthSection() {
      document.getElementById('loading-text').parentElement.classList.add('hidden');
      document.getElementById('auth-section').classList.remove('hidden');

      document.getElementById('invite-email-notice').textContent = `This agreement was sent to ${inviteData.invite.email}`;
      document.getElementById('email').value = inviteData.invite.email;

      // Pre-fill full name if friend_first_name is available
      if (inviteData.agreement.friend_first_name) {
        document.getElementById('full-name').value = inviteData.agreement.friend_first_name;
      }
    }

    function getDueDateCountdown(dueDate) {
      const due = new Date(dueDate);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      due.setHours(0, 0, 0, 0);
      const diffTime = due - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

      if (diffDays < 0) return `(${Math.abs(diffDays)} days overdue)`;
      if (diffDays === 0) return '(due today)';
      if (diffDays === 1) return '(in 1 day)';
      return `(in ${diffDays} days)`;
    }

    function toggleReviewSection(sectionId) {
      const section = document.getElementById(sectionId);
      const toggle = document.getElementById(sectionId + '-toggle');

      if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        toggle.textContent = '▲';
      } else {
        section.classList.add('hidden');
        toggle.textContent = '▼';
      }
    }

    async function showReviewSection() {
      document.getElementById('loading-text').parentElement.classList.add('hidden');
      document.getElementById('review-section').classList.remove('hidden');

      // Show header and load shared header component
      document.getElementById('logged-in-header').classList.remove('hidden');

      // Load the header HTML into the review container
      try {
        const response = await fetch('/components/header.html');
        const headerHTML = await response.text();
        document.getElementById('review-header-container').innerHTML = headerHTML;

        // Now load user info and activity count using the shared header functions
        if (window.PayFriendsHeader) {
          const userInfoEl = document.getElementById('user-info-display');
          if (currentUser && userInfoEl) {
            const displayText = currentUser.full_name
              ? `${currentUser.full_name} | ${currentUser.email}`
              : currentUser.email;
            userInfoEl.textContent = displayText;
          }

          // Load activity count
          await PayFriendsHeader.refreshActivityCount();

          // Set up event listeners
          const logoutBtn = document.getElementById('logout-btn');
          if (logoutBtn) {
            logoutBtn.addEventListener('click', logout);
          }

          const activityButton = document.getElementById('activity-button');
          if (activityButton) {
            activityButton.addEventListener('click', () => window.location.href = '/app');
          }
        }
      } catch (err) {
        console.error('Error loading header:', err);
      }

      const agreement = inviteData.agreement;
      const principalEuros = agreement.amount_cents / 100;

      // (1) Description
      document.getElementById('description-display').textContent = agreement.description || '—';

      // (2) Lender
      document.getElementById('lender-display').textContent = agreement.lender_full_name || '—';

      // (3) Amount
      document.getElementById('amount-display').textContent = formatEuro2(principalEuros);

      // (4) Money transfer date (use backend-derived display value)
      document.getElementById('money-sent-display').textContent = agreement.loan_start_date_display || 'To be confirmed';

      // (5) Loan duration - using helper function
      const loanDurationText = getLoanDurationLabel(agreement) || '—';
      document.getElementById('loan-duration-display').textContent = loanDurationText;

      // (6) Installment plan - human-readable summary
      let installmentPlanText = '—';
      if (agreement.repayment_type === 'installments' && agreement.installment_count) {
        const count = agreement.installment_count;
        const firstDate = formatISOToHuman(agreement.first_payment_date);
        const finalDate = formatISOToHuman(agreement.final_due_date);

        // Calculate interval for readable format
        const totalDays = daysBetween(agreement.first_payment_date, agreement.final_due_date);
        const intervalDays = totalDays / count;

        let intervalText;
        if (intervalDays < 14) {
          const days = Math.round(intervalDays);
          intervalText = `${days} day${days === 1 ? '' : 's'}`;
        } else if (intervalDays < 60) {
          const weeks = Math.round(intervalDays / 7);
          intervalText = `${weeks} week${weeks === 1 ? '' : 's'}`;
        } else if (intervalDays < 730) {
          const months = Math.round(intervalDays / 30);
          intervalText = `${months} month${months === 1 ? '' : 's'}`;
        } else {
          const years = Math.round(intervalDays / 365);
          intervalText = `${years} year${years === 1 ? '' : 's'}`;
        }

        installmentPlanText = `${count} payment${count > 1 ? 's' : ''}, every ${intervalText}, from ${firstDate} to ${finalDate}`;
      } else if (agreement.repayment_type === 'one_time') {
        const dueDate = formatISOToHuman(agreement.due_date);
        installmentPlanText = `One-time payment on ${dueDate}`;
      }
      document.getElementById('installment-plan-display').textContent = installmentPlanText;

      // (7) Interest - APR format
      let interestText = '—';
      if (agreement.interest_rate && agreement.interest_rate > 0) {
        interestText = `${agreement.interest_rate}% per year`;
      } else {
        interestText = '0% (no interest)';
      }
      document.getElementById('interest-display').textContent = interestText;

      // (8) Total to repay
      const totalToRepay = agreement.total_repay_amount || principalEuros;
      document.getElementById('total-repay-display').textContent = formatEuro2(totalToRepay);

      // Show interest calculation card with schedule if interest > 0
      if (agreement.interest_rate && agreement.interest_rate > 0) {
        populateInterestCalcDetail();
      }

      // Populate payments & reminders section
      populatePaymentsReminders();
    }

    function populateInterestCalcDetail() {
      const agreement = inviteData.agreement;
      const card = document.getElementById('interest-calc-card');
      const content = document.getElementById('interest-calc-detail-content');

      if (!agreement.interest_rate || agreement.interest_rate === 0) {
        return;
      }

      card.classList.remove('hidden');

      // Determine start date for interest calculation
      let startDate;
      if (agreement.money_sent_date && agreement.money_sent_date !== 'on-acceptance') {
        startDate = new Date(agreement.money_sent_date);
      } else {
        // Use first payment date or today as fallback
        startDate = agreement.first_payment_date ? new Date(agreement.first_payment_date) : new Date();
      }
      startDate.setHours(0, 0, 0, 0);

      // Build payment dates array using frequency-based calculation
      let n = 1;
      let paymentDates = [];

      if (agreement.repayment_type === 'installments' && agreement.installment_count) {
        n = agreement.installment_count;

        // Use frequency from agreement, fallback to 'monthly' if not set
        const frequency = agreement.payment_frequency || 'monthly';

        // Generate payment dates using frequency-based calculation with normalization
        const dateResult = generatePaymentDates({
          transferDate: startDate,
          firstDueDate: agreement.first_payment_date,
          frequency: frequency,
          count: n
        });
        paymentDates = dateResult.paymentDates;
      } else if (agreement.repayment_type === 'one_time' && agreement.due_date) {
        n = 1;
        paymentDates.push(new Date(agreement.due_date));
      }

      // Use shared buildRepaymentSchedule function
      const schedule = buildRepaymentSchedule({
        principalCents: agreement.amount_cents,
        aprPercent: agreement.interest_rate,
        count: n,
        paymentDates: paymentDates,
        startDate: startDate
      });

      // Format totals for display (no decimals for summary)
      const totalInterestDisplay = new Intl.NumberFormat('de-DE').format(Math.round(schedule.totalInterestCents / 100));
      const totalToRepayDisplay = new Intl.NumberFormat('de-DE').format(Math.round(schedule.totalToRepayCents / 100));

      // Lead-in sentence
      const countText = n === 1 ? '1 repayment' : `${n} repayments`;
      const leadInSentence = `At ${agreement.interest_rate}% interest per year over ${countText}, total interest is about €${totalInterestDisplay} and total to repay is €${totalToRepayDisplay}.`;

      // Build HTML
      let html = `<p style="margin-bottom:16px; font-size:14px; color:var(--muted); line-height:1.5">${leadInSentence}</p>`;

      const isOneTime = agreement.repayment_type === 'one_time';

      html += '<div style="overflow-x:auto; border:1px solid #374151; border-radius:8px">';
      html += '<table class="payment-schedule-table">';
      html += '<thead><tr>';
      html += '<th>Due date</th>';
      html += '<th class="text-right">Loan repayment</th>';
      html += '<th class="text-right">Interest</th>';
      html += '<th class="text-right">Payment total</th>';
      if (!isOneTime) {
        html += '<th class="text-right">Outstanding</th>';
      }
      html += '</tr></thead>';
      html += '<tbody>';

      schedule.rows.forEach((row, index) => {
        const rowClass = index % 2 === 0 ? '' : 'style="background:rgba(255,255,255,0.02)"';
        html += `<tr ${rowClass}>`;
        html += `<td>${formatScheduleDate(row.dateISO)}</td>`;
        html += `<td class="text-right">${formatCurrency2(row.principalCents)}</td>`;
        html += `<td class="text-right">${formatCurrency2(row.interestCents)}</td>`;
        html += `<td class="text-right" style="font-weight:600">${formatCurrency2(row.paymentCents)}</td>`;
        if (!isOneTime) {
          html += `<td class="text-right">${formatCurrency2(row.remainingCents)}</td>`;
        }
        html += '</tr>';
      });

      html += '</tbody>';
      html += '</table>';
      html += '</div>';

      content.innerHTML = html;
    }

    function populatePaymentsReminders() {
      const agreement = inviteData.agreement;
      const detailsDiv = document.getElementById('payments-reminders-details');

      let html = '<div style="display:flex; flex-direction:column; gap:12px">';

      // Payment methods
      let methodsText = 'Not specified';
      if (agreement.payment_preference_method) {
        const methods = agreement.payment_preference_method.split(',').map(m => {
          if (m === 'bank') return 'Bank transfer';
          if (m === 'cash') return 'Cash';
          if (m === 'paypal') return 'PayPal';
          if (m === 'crypto') return 'Crypto';
          if (m === 'any') return 'Any method';
          if (m === 'other') return 'Other';
          return m;
        });
        methodsText = methods.join(', ');
      }
      html += `<div><div style="font-weight:600; margin-bottom:4px; font-size:14px">Preferred payment methods:</div>`;
      html += `<div style="color:var(--muted); font-size:13px">${methodsText}</div></div>`;

      // Proof of repayment
      html += `<div><div style="font-weight:600; margin-bottom:4px; font-size:14px">Require proof of repayment:</div>`;
      html += `<div style="color:var(--muted); font-size:13px">${agreement.proof_required ? 'Yes — The borrower will be asked to upload proof for each repayment.' : 'No — The borrower can report repayments without uploading proof.'}</div></div>`;

      // Reminder mode
      html += `<div><div style="font-weight:600; margin-bottom:4px; font-size:14px">Reminder mode:</div>`;
      html += `<div style="color:var(--muted); font-size:13px">${agreement.reminder_mode === 'auto' ? 'Auto (recommended)' : 'Custom schedule'}</div></div>`;

      // Worst case scenario (only show if enabled)
      if (agreement.debt_collection_clause) {
        html += `<div><div style="font-weight:600; margin-bottom:4px; font-size:14px">Worst case scenario:</div>`;
        html += `<div style="color:var(--muted); font-size:13px; line-height:1.6">If the borrower does not repay in time and ignores reminders or cannot agree a new plan with the lender, PayFriends will hand the case to an independent debt collector. Once this happens, the lender is no longer involved in collection — the third party handles it, and any collection fees are for the borrower's account.</div>`;
        html += `</div>`;
      }

      html += '</div>';
      detailsDiv.innerHTML = html;
    }

    async function handleSignup() {
      const fullName = document.getElementById('full-name').value.trim();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const status = document.getElementById('auth-status');

      if (!fullName) {
        status.textContent = 'Full name is required';
        status.className = 'status error';
        return;
      }

      // Validate full name has at least 2 words
      const nameParts = fullName.split(/\s+/);
      if (nameParts.length < 2) {
        status.textContent = 'Please enter your full name (first and last name), exactly as on your passport.';
        status.className = 'status error';
        return;
      }

      if (password.length < 6) {
        status.textContent = 'Password must be at least 6 characters';
        status.className = 'status error';
        return;
      }

      status.textContent = 'Creating account...';
      status.className = 'status';

      try {
        const res = await fetch('/auth/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password, fullName })
        });

        const data = await res.json();

        if (!res.ok) {
          status.textContent = data.error || 'Signup failed';
          status.className = 'status error';
          return;
        }

        currentUser = data.user;
        status.textContent = 'Account created! Loading agreement...';
        status.className = 'status success';

        // Reload to show review section
        setTimeout(() => {
          window.location.reload();
        }, 500);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    // Signature pad state
    let signaturePad = {
      canvas: null,
      ctx: null,
      isDrawing: false,
      hasContent: false,
      lastX: 0,
      lastY: 0
    };

    function initSignaturePad() {
      const canvas = document.getElementById('accept-signature-canvas');
      if (!canvas) return;

      signaturePad.canvas = canvas;
      signaturePad.ctx = canvas.getContext('2d');

      // Set canvas size to match display size
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * window.devicePixelRatio;
      canvas.height = rect.height * window.devicePixelRatio;
      signaturePad.ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

      // Configure drawing style
      signaturePad.ctx.strokeStyle = '#ffffff';
      signaturePad.ctx.lineWidth = 2;
      signaturePad.ctx.lineCap = 'round';
      signaturePad.ctx.lineJoin = 'round';

      // Reset state
      signaturePad.hasContent = false;
      signaturePad.isDrawing = false;

      // Mouse events
      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseleave', stopDrawing);

      // Touch events
      canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
      canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
      canvas.addEventListener('touchend', stopDrawing);
      canvas.addEventListener('touchcancel', stopDrawing);

      // Expose hasContent checker globally
      window.signaturePadHasContent = () => signaturePad.hasContent;
    }

    function getMousePos(canvas, evt) {
      const rect = canvas.getBoundingClientRect();
      return {
        x: evt.clientX - rect.left,
        y: evt.clientY - rect.top
      };
    }

    function getTouchPos(canvas, evt) {
      const rect = canvas.getBoundingClientRect();
      const touch = evt.touches[0];
      return {
        x: touch.clientX - rect.left,
        y: touch.clientY - rect.top
      };
    }

    function startDrawing(e) {
      signaturePad.isDrawing = true;
      const pos = getMousePos(signaturePad.canvas, e);
      signaturePad.lastX = pos.x;
      signaturePad.lastY = pos.y;
    }

    function draw(e) {
      if (!signaturePad.isDrawing) return;

      const pos = getMousePos(signaturePad.canvas, e);

      signaturePad.ctx.beginPath();
      signaturePad.ctx.moveTo(signaturePad.lastX, signaturePad.lastY);
      signaturePad.ctx.lineTo(pos.x, pos.y);
      signaturePad.ctx.stroke();

      signaturePad.lastX = pos.x;
      signaturePad.lastY = pos.y;
      signaturePad.hasContent = true;

      // Revalidate on draw
      validateAcceptModal();
    }

    function stopDrawing() {
      signaturePad.isDrawing = false;
    }

    function handleTouchStart(e) {
      e.preventDefault();
      signaturePad.isDrawing = true;
      const pos = getTouchPos(signaturePad.canvas, e);
      signaturePad.lastX = pos.x;
      signaturePad.lastY = pos.y;
    }

    function handleTouchMove(e) {
      if (!signaturePad.isDrawing) return;
      e.preventDefault();

      const pos = getTouchPos(signaturePad.canvas, e);

      signaturePad.ctx.beginPath();
      signaturePad.ctx.moveTo(signaturePad.lastX, signaturePad.lastY);
      signaturePad.ctx.lineTo(pos.x, pos.y);
      signaturePad.ctx.stroke();

      signaturePad.lastX = pos.x;
      signaturePad.lastY = pos.y;
      signaturePad.hasContent = true;

      // Revalidate on draw
      validateAcceptModal();
    }

    function clearSignature() {
      if (!signaturePad.canvas || !signaturePad.ctx) return;

      signaturePad.ctx.clearRect(0, 0, signaturePad.canvas.width, signaturePad.canvas.height);
      signaturePad.hasContent = false;
      signaturePad.isDrawing = false;

      // Revalidate after clearing
      validateAcceptModal();
    }

    function handleAccept() {
      openAcceptModal();
    }

    function openAcceptModal() {
      const modal = document.getElementById('accept-modal');
      const termsContainer = document.getElementById('accept-modal-terms');
      const agreement = inviteData.agreement;

      // Reset modal state
      document.getElementById('accept-confirm-terms').checked = false;
      document.getElementById('accept-modal-status').textContent = '';
      document.getElementById('accept-signature-error').classList.add('hidden');
      document.getElementById('accept-checkbox-error').classList.add('hidden');

      // Build key terms HTML
      let termsHTML = '';

      // Helper function to add a term row
      const addTerm = (label, value) => {
        termsHTML += `<div style="display:grid; grid-template-columns:140px 1fr; gap:12px; padding:6px 0;">
          <span style="color:var(--muted)">${label}:</span>
          <span style="color:var(--text); font-weight:500;">${value}</span>
        </div>`;
      };

      const lenderName = agreement.lender_full_name || agreement.lender_name || agreement.lender_email;
      const borrowerName = agreement.borrower_full_name || agreement.friend_first_name || agreement.borrower_email;
      const borrowerEmail = inviteData.invite.email;
      const principalEuros = agreement.amount_cents / 100;
      const amount = formatEuro2(principalEuros);
      const repaymentType = agreement.repayment_type === 'installments' ? 'Installments' : 'One-time payment';

      addTerm('Lender', lenderName);
      addTerm('Borrower', `${borrowerName} (${borrowerEmail})`);
      addTerm('Amount', amount);
      addTerm('Repayment type', repaymentType);

      // Installment plan (only for installments)
      if (agreement.repayment_type === 'installments' && (agreement.number_of_installments || agreement.installment_count)) {
        const numInstallments = agreement.number_of_installments || agreement.installment_count;
        const freqLabel = formatRepaymentFrequency(agreement.payment_frequency || agreement.payment_frequency_label || 'monthly');
        const installmentAmt = formatEuro2(agreement.installment_amount || (principalEuros / numInstallments));
        const firstDate = formatISOToHuman(agreement.first_payment_date);
        const finalDate = formatISOToHuman(agreement.final_due_date);
        const planText = `${numInstallments} ${freqLabel} payments of ${installmentAmt} from ${firstDate} to ${finalDate}`;
        addTerm('Installment plan', planText);
      }

      // Loan duration - using helper function
      const loanDurationLabelForModal = getLoanDurationLabel(agreement);
      if (loanDurationLabelForModal) {
        addTerm('Loan duration', loanDurationLabelForModal);
      }

      // Interest rate
      if (agreement.interest_rate && agreement.interest_rate > 0) {
        const totalInterest = formatEuro2(agreement.total_interest || 0);
        addTerm('Interest rate', `${agreement.interest_rate}% per year`);
        addTerm('Total interest', totalInterest);

        const totalRepay = agreement.total_repay_amount || principalEuros;
        addTerm('Total to repay', formatEuro2(totalRepay));
      }

      // Due dates
      if (agreement.repayment_type === 'installments') {
        if (agreement.first_payment_date) {
          const firstDate = formatISOToHuman(agreement.first_payment_date);
          addTerm('First repayment date', firstDate);
        }
        if (agreement.final_due_date) {
          const finalDate = formatISOToHuman(agreement.final_due_date);
          addTerm('Final due date', finalDate);
        }
      } else {
        if (agreement.due_date) {
          // Check if we should show relative or concrete date
          const isLoanStartUponAcceptance = agreement.money_sent_date === 'on-acceptance';
          const isRelativeDueDate = agreement.one_time_due_option && agreement.one_time_due_option !== 'pick_date';

          let dueDateDisplay;
          if (isLoanStartUponAcceptance && isRelativeDueDate) {
            // Show relative description
            dueDateDisplay = getRelativeDueDateText(agreement.one_time_due_option);
          } else {
            // Show concrete date with countdown
            dueDateDisplay = formatDateWithCountdown(agreement.due_date);
          }

          addTerm('Full repayment due', dueDateDisplay);
        }
      }

      // Payment methods
      if (agreement.payment_preference_method) {
        const methods = agreement.payment_preference_method.split(',').map(m => {
          const trimmed = m.trim();
          if (trimmed === 'bank') return 'Bank transfer';
          if (trimmed === 'cash') return 'Cash in person';
          if (trimmed === 'crypto') return 'Crypto';
          if (trimmed === 'paypal') return 'PayPal';
          if (trimmed === 'any') return 'Any method';
          if (trimmed === 'other') return 'Other';
          return trimmed;
        });
        addTerm('Repayment method(s)', methods.join(', '));
      }

      // Fairness between friends
      addTerm('Fairness between friends', 'If payments are made earlier, later or in different amounts than planned, PayFriends will recalculate interest and instalments fairly so neither side pays or receives more than they should.');

      // Proof required
      addTerm('Require proof of payment', agreement.proof_required ? 'Yes' : 'No');

      // Reminders
      let reminderMode;
      if (agreement.reminder_mode === 'auto') {
        reminderMode = 'Automatic – sent before the due date, on the due date and if payments are late.';
      } else if (agreement.reminder_mode === 'custom') {
        reminderMode = 'Custom – uses the schedule agreed in this plan.';
      } else {
        reminderMode = 'Off';
      }
      addTerm('Reminders', reminderMode);

      // Worst case scenario (only if enabled)
      if (agreement.debt_collection_clause) {
        addTerm('Worst case scenario', 'If you do not repay in time and ignore reminders or cannot agree a new plan, PayFriends will hand the case to an independent debt collector.');
      }

      termsContainer.innerHTML = termsHTML;

      // Show modal first so canvas dimensions are correct
      modal.style.display = 'flex';

      // Initialize signature pad after modal is visible
      // Use requestAnimationFrame to ensure layout is complete
      requestAnimationFrame(() => {
        initSignaturePad();
        // Reset and disable confirm button
        validateAcceptModal();
      });
    }

    function closeAcceptModal() {
      const modal = document.getElementById('accept-modal');
      modal.style.display = 'none';
    }

    function validateAcceptModal() {
      const termsChecked = document.getElementById('accept-confirm-terms').checked;
      const confirmBtn = document.getElementById('accept-modal-confirm-btn');
      const signatureError = document.getElementById('accept-signature-error');
      const checkboxError = document.getElementById('accept-checkbox-error');

      // Check if signature pad has content
      const signatureValid = window.signaturePadHasContent && window.signaturePadHasContent();

      // Show/hide errors based on validation
      if (!termsChecked) {
        checkboxError.classList.remove('hidden');
      } else {
        checkboxError.classList.add('hidden');
      }

      if (!signatureValid && termsChecked) {
        // Only show signature error if checkbox is checked (progressive validation)
        signatureError.classList.remove('hidden');
      } else {
        signatureError.classList.add('hidden');
      }

      // Enable button only if both are valid
      if (termsChecked && signatureValid) {
        confirmBtn.disabled = false;
        confirmBtn.style.opacity = '1';
        confirmBtn.style.cursor = 'pointer';
      } else {
        confirmBtn.disabled = true;
        confirmBtn.style.opacity = '0.5';
        confirmBtn.style.cursor = 'not-allowed';
      }
    }

    async function confirmAccept() {
      const status = document.getElementById('accept-modal-status');
      const confirmBtn = document.getElementById('accept-modal-confirm-btn');

      status.textContent = 'Accepting agreement...';
      status.className = 'status';
      confirmBtn.disabled = true;
      confirmBtn.style.opacity = '0.5';

      try {
        const res = await fetch(`/api/invites/${token}/accept`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ fairnessAccepted: true })
        });

        const data = await res.json();

        if (!res.ok) {
          status.textContent = data.error || 'Failed to accept';
          status.className = 'status error';
          confirmBtn.disabled = false;
          confirmBtn.style.opacity = '1';
          return;
        }

        status.textContent = 'Agreement accepted!';
        status.className = 'status success';

        setTimeout(() => {
          window.location.href = '/app';
        }, 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
        confirmBtn.disabled = false;
        confirmBtn.style.opacity = '1';
      }
    }

    async function handleDecline() {
      if (!confirm('Are you sure you want to decline this agreement?')) {
        return;
      }

      const status = document.getElementById('review-status');
      status.textContent = 'Declining...';
      status.className = 'status';

      try {
        const res = await fetch(`/api/invites/${token}/decline`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();

        if (!res.ok) {
          status.textContent = data.error || 'Failed to decline';
          status.className = 'status error';
          return;
        }

        status.textContent = 'Agreement declined. Redirecting...';
        status.className = 'status success';

        setTimeout(() => {
          window.location.href = '/app';
        }, 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    async function handleReviewLater() {
      const status = document.getElementById('review-status');
      status.textContent = 'Saving...';
      status.className = 'status';

      try {
        const res = await fetch(`/api/invites/${token}/review-later`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();

        if (!res.ok) {
          status.textContent = data.error || 'Failed to save';
          status.className = 'status error';
          return;
        }

        status.textContent = 'Saved! Redirecting to dashboard...';
        status.className = 'status success';

        setTimeout(() => {
          window.location.href = '/app';
        }, 1000);
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        status.className = 'status error';
      }
    }

    // Logout
    async function logout() {
      try {
        await fetch('/auth/logout', { method: 'POST' });
        window.location.href = '/';
      } catch (err) {
        console.error('Logout error:', err);
        window.location.href = '/';
      }
    }

    // Initialize
    if (!token) {
      window.location.href = '/review-invalid.html';
    } else {
      loadInviteData();
    }
  </script>

  <!-- Shared Schedule Calculation Utility -->
  <script src="/js/schedule.js"></script>
</body>
</html>
